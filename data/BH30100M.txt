 /**********************************************************************
 * PROJEKT:     EVS FORSKUD 2021 / SLUT 2020                           *
 * PROGRAMNAVN: BH30100M                                               *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK NYESTE BENYTTEDE LØBENR. PR. EJENDOM PR.    *
 *              PERSON FRA EVS FORSKUD                                 *
 * PROGRAMMØR:  THOMAS FLINDT         THF, PUS/T&S BRØNDBY 30.07.2001. *
 ***********************************************************************
 ***********************************************************************
 * SLUT15       ESBEN BRODERSEN         QEB                 09.03.2016 *
 *              ÅRSTAL TAGES FRA BH65300M #01                          *
 ***********************************************************************
 * FORSKUD17    QEB                                         05.08.2016 *
 *              PARMKORT TIL BRUGTEST                                  *
 ***********************************************************************
 * FORSKUD20    EBD                                         05.04.2019 *
 *              OPRETTET SOM KOPI AF BH30100M TILRETTET                *
 *              TIL NYE TABELLER BS00500T OG BS00600T                  *
 *              BRUGES I  EVS FORSKUD 2021 / SLUT 2020                 *
 ***********************************************************************
 * FORSKUD22    PBR                                         28.01.2021 *
 *              Mellemperiode, nye felter                              *
 ***********************************************************************
 * SLUT 2021    Z6SEP                                       Marts 2021 *
 *              Rettet BH65300M til BH55300M                           *
 ***********************************************************************
 * FORSKUD22    PBR                                         12.08.2021 *
 *              KS46, nye felter                                       *
 ***********************************************************************
 * SLUT 2024    Jan Erik Jensen (Z6XJY)                     21.10.2024 *
 *              #1888922 Konvertering af udenlandske ejendomsnumre:    *
 *              Fjernet check for SQL fejl efter SQL DECLARE CURSOR    *
 **********************************************************************/
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF PERSONTABEL BS00600T             RUTINE */
 /*********************************************************************/
 DECLARE_PERSONEJENDOMSOPL: PROC;                                       
                                                                        
         EXEC SQL DECLARE PERSON_CURSOR CURSOR FOR                      
                                                                        
              SELECT T1.DINDKAAR                                        
                    ,T1.PERSONNUMMER                                    
                    ,T1.EKOMNR                                          
                    ,T1.EEJDNR                                          
                    ,T1.EENHEDLBNR                                      
                    ,T1.EPLBNR                                          
                    ,T1.DFRAGLD                                         
                    ,T1.DTILGLD                                         
                    ,T1.CEVSBENY                                        
                    ,T1.CEJBEVS                                         
                    ,T1.COPR_CEJBEVS                                    
                    ,T1.CEJDTYPE                                        
                    ,T1.BPROM1                                          
                    ,T1.CNEDSL1                                         
                    ,T1.DATO0107                                        
                    ,T1.DOVTG                                           
                    ,T1.DAFSTAA                                         
                    ,T1.DINDFLYT                                        
                    ,T1.DFRAFLYT                                        
                    ,T1.GPCTEJER                                        
                    ,T1.FDAGUDLE                                        
                    ,T1.GPCTUDLE                                        
                    ,T1.FDAGERHV                                        
                    ,T1.GPCTERHV                                        
                    ,T1.B100                                            
                    ,T1.BEJERAN                                         
                    ,T1.CFRED                                           
                    ,T1.BNYMAN                                          
                    ,T1.BBRUTTO                                         
                    ,T1.CENKE                                           
                    ,T1.FDAGEJ                                          
                    ,T1.CEKSEMP                          /* #0904 */    
                    ,T1.COPR_EKSEMP                      /* #0904 */    
                    ,T1.BBERGRL                          /* #0602 */    
                    ,T1.BBER2FAM                         /* #0602 */    
                    ,T2.EJDBELIG                                        
                    ,T2.LANDEKODE                                       
                    ,T1.BUDLSKC         /*FORSKUD 2013 DEFECT #521*/    
                    ,T1.CSLET           /*FORSKUD 2017 RET #01    */    
                    ,T2.EJD_VEJK        /*FORSKUD 2020*/                
                    ,T2.EJD_HUSNR       /*FORSKUD 2020*/                
                    ,T2.EJD_ETAGE       /*FORSKUD 2020*/                
                    ,T2.EJD_SDØR        /*FORSKUD 2020*/                
                    ,T2.ENHEDBELIG      /*FORSKUD 2020*/                
                    ,T2.ENHED_VEJK      /*FORSKUD 2020*/                
                    ,T2.ENHED_HUSNR     /*FORSKUD 2020*/                
                    ,T2.ENHED_ETAGE     /*FORSKUD 2020*/                
                    ,T2.ENHED_SDØR      /*FORSKUD 2020*/                
                    ,T1.VURMARK_AKT     /*FORSKUD 2021*/                
                    ,T1.VURMARK_02ANV   /*FORSKUD 2021*/                
                    ,T1.VURMARK_015ANV  /*FORSKUD 2021*/                
                    ,T1.VURMARK         /*FORSKUD 2021*/                
                    ,T2.VURMARK_AKT     /*FORSKUD 2021*/                
                    ,T2.VURMARK_OM      /*FORSKUD 2021*/                
                    ,T2.VURMARK_02      /*FORSKUD 2021*/                
                    ,T2.VURMARK_015PCT  /*FORSKUD 2021*/                
                    ,T2.VURMARK         /*FORSKUD 2021*/                
                    ,T1.CRTEKORNS          /*KS46*/                     
                    ,T1.COPR_CRTEKORNS     /*KS46*/                     
                    ,T2.BFENR              /*MP*/                       
                    ,T2.VUREJENDOMID       /*MP*/                       
                                                                        
         FROM BS00600T T1, BS00500T T2                                  
                                                                        
         WHERE T1.DINDKAAR    = :BH55300M.SLUTÅR   /*#01*/              
         AND   T1.DINDKAAR    = T2.DINDKAAR                             
         AND   T1.EKOMNR      = T2.EKOMNR                               
         AND   (:PARMKOMNR1 = 0  OR                                     
               (:PARMKOMNR1 <> 0 AND                                    
                T1.EKOMNR IN (:PARMKOMNR1, 999)) OR                     
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0 AND               
                T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2, 999)) OR         
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0                   
                 AND :PARMKOMNR3 <> 0 AND                               
                 T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2,                 
                               :PARMKOMNR3, 999)))                      
         AND   T1.EEJDNR      = T2.EEJDNR                               
         AND   T1.EENHEDLBNR  = T2.EENHEDLBNR                           
      /* AND   T1.CSLET   ^= '1' */  /* QEB F2017 KS30-01*/             
         AND   T1.DTILGLD IN (SELECT MAX(T3.DTILGLD)                    
                              FROM BS00600T T3                          
                              WHERE T1.PERSONNUMMER = T3.PERSONNUMMER   
                              AND   T1.DINDKAAR     = T3.DINDKAAR       
                              AND   T1.EKOMNR       = T3.EKOMNR         
                              AND   T1.EEJDNR       = T3.EEJDNR         
                              AND   T1.EENHEDLBNR   = T3.EENHEDLBNR     
                              AND   T1.EPLBNR       = T3.EPLBNR)        
                                                                        
         ORDER BY T1.PERSONNUMMER,                                      
                  T1.EKOMNR,                                            
                  T1.EEJDNR,                                            
                  T1.EENHEDLBNR,                                        
                  T1.EPLBNR                                             
         ;                                                              
                                                                        
 END DECLARE_PERSONEJENDOMSOPL;                                         
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF PERSONTABEL BS00600T                      */
 /*********************************************************************/
 FETCH_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL FETCH PERSON_CURSOR                                   
                                                                        
         INTO :PERSONEJENDOMSOPL.DINDKAAR                               
             ,:PERSONEJENDOMSOPL.PERSONNUMMER                           
             ,:PERSONEJENDOMSOPL.EKOMNR                                 
             ,:PERSONEJENDOMSOPL.EEJDNR                                 
             ,:PERSONEJENDOMSOPL.EENHEDLBNR                             
             ,:PERSONEJENDOMSOPL.EPLBNR                                 
             ,:PERSONEJENDOMSOPL.DFRAGLD                                
             ,:PERSONEJENDOMSOPL.DTILGLD                                
             ,:PERSONEJENDOMSOPL.CEVSBENY                               
             ,:PERSONEJENDOMSOPL.CEJBEVS                                
             ,:PERSONEJENDOMSOPL.COPR_CEJBEVS                           
             ,:PERSONEJENDOMSOPL.CEJDTYPE                               
             ,:PERSONEJENDOMSOPL.BPROM1                                 
             ,:PERSONEJENDOMSOPL.CNEDSL1                                
             ,:PERSONEJENDOMSOPL.DATO0107                               
             ,:PERSONEJENDOMSOPL.DOVTG                                  
             ,:PERSONEJENDOMSOPL.DAFSTAA                                
             ,:PERSONEJENDOMSOPL.DINDFLYT                               
             ,:PERSONEJENDOMSOPL.DFRAFLYT                               
             ,:PERSONEJENDOMSOPL.GPCTEJER                               
             ,:PERSONEJENDOMSOPL.FDAGUDLE                               
             ,:PERSONEJENDOMSOPL.GPCTUDLE                               
             ,:PERSONEJENDOMSOPL.FDAGERHV                               
             ,:PERSONEJENDOMSOPL.GPCTERHV                               
             ,:PERSONEJENDOMSOPL.B100                                   
             ,:PERSONEJENDOMSOPL.BEJERAN                                
             ,:PERSONEJENDOMSOPL.CFRED                                  
             ,:PERSONEJENDOMSOPL.BNYMAN:INDK_PERS.BNYMAN_I              
             ,:PERSONEJENDOMSOPL.BBRUTTO                                
             ,:PERSONEJENDOMSOPL.CENKE                                  
             ,:PERSONEJENDOMSOPL.FDAGEJ                                 
             ,:PERSONEJENDOMSOPL.CEKSEMP                 /* #0904 */    
             ,:PERSONEJENDOMSOPL.COPR_EKSEMP             /* #0904 */    
             ,:PERSONEJENDOMSOPL.BBERGRL                 /* #0602 */    
             ,:PERSONEJENDOMSOPL.BBER2FAM                /* #0602 */    
             ,:EJENDOMSOPL.EJDBELIG                                     
             ,:EJENDOMSOPL.LANDEKODE                                    
             ,:PERSONEJENDOMSOPL.BUDLSKC    /*FORSKUD 2013 DEFECT #521*/
             ,:PERSONEJENDOMSOPL.CSLET      /*FORSKUD 2017 RET #1 */    
             ,:EJENDOMSOPL.EJD_VEJK         /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.EJD_HUSNR        /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.EJD_ETAGE        /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.EJD_SDØR         /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.ENHEDBELIG       /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.ENHED_VEJK       /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.ENHED_HUSNR      /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.ENHED_ETAGE      /*FORSKUD 2020*/            
             ,:EJENDOMSOPL.ENHED_SDØR       /*FORSKUD 2020*/            
             ,:PERSONEJENDOMSOPL.VURMARK_AKT     /*FORSKUD 2021*/       
             ,:PERSONEJENDOMSOPL.VURMARK_02ANV   /*FORSKUD 2021*/       
             ,:PERSONEJENDOMSOPL.VURMARK_015ANV  /*FORSKUD 2021*/       
             ,:PERSONEJENDOMSOPL.VURMARK         /*FORSKUD 2021*/       
             ,:EJENDOMSOPL.VURMARK_AKT           /*FORSKUD 2021*/       
             ,:EJENDOMSOPL.VURMARK_OM            /*FORSKUD 2021*/       
             ,:EJENDOMSOPL.VURMARK_02            /*FORSKUD 2021*/       
             ,:EJENDOMSOPL.VURMARK_015PCT        /*FORSKUD 2021*/       
             ,:EJENDOMSOPL.VURMARK               /*FORSKUD 2021*/       
             ,:PERSONEJENDOMSOPL.CRTEKORNS          /*KS46*/            
             ,:PERSONEJENDOMSOPL.COPR_CRTEKORNS     /*KS46*/            
             ,:EJENDOMSOPL.BFENR              /*MP*/                    
             ,:EJENDOMSOPL.VUREJENDOMID       /*MP*/                    
         ;                                                              
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                       
                                                                        
               IF PERSONEJENDOMSOPL.EKOMNR = 999                        
                & EJENDOMSOPL.LANDEKODE ^= ' '                          
               THEN                                                     
                  CALL CHECK_CEKSEMP;                                   
             END;                                                       
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'FETCH PERSONCURSOR';                       
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 CHECK_CEKSEMP: PROC;                                                   
                                                                        
         EXEC SQL                                                       
              SELECT LEMPELSESKODE                                      
              INTO   :BN03300T.LEMPELSESKODE                            
              FROM   BN03300T                                           
              WHERE  YEAR(STARTDATO) <= :BH55300M.SLUTÅR   /*#01*/      
               AND   YEAR(SLUTDATO)  >= :BH55300M.SLUTÅR   /*#01*/      
               AND   LANDEKODE = :EJENDOMSOPL.LANDEKODE;                
                                                                        
          IF SQLCA.SQLCODE = 0                                          
          THEN                                                          
             DO;                                                        
               IF PERSONEJENDOMSOPL.CEKSEMP ^= BN03300T.LEMPELSESKODE   
               THEN                                                     
                  PERSONEJENDOMSOPL.CEKSEMP = BN03300T.LEMPELSESKODE;   
             END;                                                       
                                                                        
 END CHECK_CEKSEMP;                                                     
