  PROCESS OPT(TIME);                                                    
 BH67000: /* OPSÆT 1/7-98-DATO P.G.A. NYT BEREGNINGSBÅND */             
         PROC OPTIONS (MAIN) REORDER;                                   
         DCL COPYRIGHT CHAR (30) STATIC                                 
         INIT ('COPYRIGHT KOMMUNEDATA I/S 2001');                       
 /*********************************************************************/
 /*      FORMÅL       OPSÆT STATUS FOR 1/7-1998 EJERSKAB PR. INDIVID  */
 /*                   A.H.T. BEREGNING AF EJENDOMSVÆRDISKAT. SENERE   */
 /*                   OVERFØRES DENNE STATUS VED TILKØB/FRASALG OG    */
 /*                   'ENKE EFTER'-SITUATIONER SAMT MELLEM NUVÆRENDE  */
 /*                   ELLER FRASKILTE PERSONER. DER DANNES ET DATASÆT */
 /*                   MED SAMTLIGE INDIVIDER MED ET VALIDT PERSONNUM- */
 /*                   MER, DER DANNES DOG 2 INDIVIDER FOR PERSONER    */
 /*                   MED HENVISNINGSNUMMER: 1 MED SORTCPR LIG AKTUEL */
 /*                   PERSONNR. (DCPRCIR) OG 1 MED SORTCPR LIG NUVÆ-  */
 /*                   RENDE ELLER FRASKILTE ÆGTEFÆLLES PERSONNR.      */
 /*                   (DHENVN).                                       */
 /*                                                                   */
 /*      INDDATA      B.H90501D BEREGN.BÅND FRA EVS SUPPL.            */
 /*                                                                   */
 /*      UDDATA       B.H67000D ALLE INDIVIDER MED VALIDT PERSONNUMMER*/
 /*                   B.H67001Y KØRSELSKONTROLLISTE                   */
 /*                                                                   */
 /*      PROGRAMMØR   AAGE RASMUSSEN          LSU T&S     FEB. 2001   */
 /*                                                                   */
 /*      RETTET                                                       */
 /*********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /*********************************************************************/
 /*      FILE-DECLARE                                                 */
 /*********************************************************************/
 DCL     BH905I          FILE RECORD INPUT;                             
 DCL     BH670O          FILE RECORD OUTPUT;                            
 /*********************************************************************/
 /*      ENTRY-DECLARE                                                */
 /*********************************************************************/
 DCL     ZS61900         ENTRY OPTIONS (INTER ASM);   /* SSI-DATO     */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      STRUCTUR-DECLARE  INPUT/OUTPUT                               */
 /*********************************************************************/
 DCL     BH905_AR CHAR (4000) VAR;                                      
 DCL     1 BH905 BASED(ADDR(BH905_AR)),                                 
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH90000N;;                                          
 DCL     1 BH670,                                                       
           %INCLUDE BH66600N;                                           
 DCL     1 BH67099,                                                     
           %INCLUDE BH66699N;                                           
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL     1 LIN1,                                                        
          2 CTL          CHAR      (1),                                 
          2 TX1          CHAR      (37)      INIT                       
            ('PROGRAM: BH67000L'),                                      
          2 TX2          CHAR      (69)      INIT                       
            ('SKAF 1/7-98-STATUS M.V. FRA ESR/EVS SUPPL. 2000'),        
          2 TX3          CHAR      (14)      INIT                       
            ('UDSKREVET DEN '),                                         
          2 DATO         CHAR      (10),                                
          2 REST         CHAR      (02)      INIT      (' ');           
 DCL     1 LIN2,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (54)      INIT      ('  '),          
          2 TX1          CHAR      (20)      INIT                       
                         ('KØRSELSKONTROLLISTE'),                       
          2 REST         CHAR      (58)      INIT      (' ');           
 DCL     1 LIN3,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (2)       INIT      (' '),           
          2 TEKST        CHAR      (52),                                
          2 ANT          PIC       'ZZZ.ZZZ.ZZZ.ZZZ.ZZZ',               
          2 REST         CHAR      (59)      INIT      (' ');           
 DCL     1 LIN_BLANK,                                                   
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (132)     INIT      (' ');           
         %INCLUDE ZZ20301M;                                             
 /*********************************************************************/
 /*      DECLARE AF TÆLLEVÆRKER                                       */
 /*********************************************************************/
 DCL     TV_LÆS          FIXED     (7)       INIT      (0);             
 DCL     TV_LÆS_ESR      FIXED     (7)       INIT      (0);             
 DCL     TV_KOM          FIXED     (7)       INIT      (0);             
 DCL     TV_ØVR          FIXED     (7)       INIT      (0);             
 DCL     TV_NED50        FIXED     (7)       INIT      (0);             
 DCL     TV_SKRIV        FIXED     (7)       INIT      (0);             
 DCL     TV_DUBLET       FIXED     (7)       INIT      (0);             
 /*********************************************************************/
 /*      DECLARE AF BUILTIN                                           */
 /*********************************************************************/
 DCL     ADDR            BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 /*********************************************************************/
 /*      DECLARE AF DIVERSE FELTER                                    */
 /*********************************************************************/
 DCL     I               BIN FIXED (15);                                
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2                              BASED(ADDR(DATO1)),       
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF             PIC       '9'       INIT (0);                  
 /*********************************************************************/
 /*      HOUSE-KEEPING                                                */
 /*********************************************************************/
         ON ERROR CALL PLIDUMP('SNHOB');                                
         CALL ZS61900;                 /*   UDSKRIVNING AF SSI-DATO   */
         LIN_BLANK.CTL = ZZIK1;                                         
         LIN1.CTL = ZZWS2;                                              
         LIN2.CTL = ZZWS3;                                              
         LIN3.CTL = ZZWS2;                                              
         OPEN FILE (BH905I) TITLE ('BH90501I');                         
         OPEN FILE (BH670O) TITLE ('BH67000O');                         
         CALL ZZ20390 ('*OPEN','BH67001Y');                             
         ON ENDFILE (BH905I)                                            
         BEGIN;                                                         
            EOF = 1;                                                    
         END;                                                           
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         LIN1.DATO = UDDATO;                                            
 /*********************************************************************/
 /*      PROCES                                                       */
 /*********************************************************************/
                                                                        
         READ FILE (BH905I) INTO (BH905_AR);                            
                                                                        
         DO WHILE (EOF = 0 & BH905.SORT_CPR < 99999999999);             
            TV_LÆS = TV_LÆS + 1;                                        
            CALL BEHANDL;                                               
            CALL OPSÆT_SORT_KRIT;                                       
            READ FILE (BH905I) INTO (BH905_AR);                         
         END;                                                           
                                                                        
 /*********************************************************************/
 /*    AFSLUT PROGRAM                                                 */
 /*********************************************************************/
                                                                        
         CALL DAN_OPT_INDV;                                             
                                                                        
         CALL SKRIV_TOTALER;                                            
                                                                        
         CALL ZZ20300(LIN_BLANK,'99');                                  
                                                                        
         CLOSE FILE (BH905I),                                           
               FILE (BH670O);                                           
                                                                        
 /*********************************************************************/
 /*    OPSÆT STATUS VEDR. 1/7-98 EJERSKAB FOR EJENDOMME FRA ESR       */
 /*********************************************************************/
 BEHANDL:                                                               
 PROC;                                                                  
                                                                        
         TV_LÆS_ESR = TV_LÆS_ESR + 1;                                   
                                                                        
         BH670 = '';                                                    
                                                                        
         BH670.EKOMNR = BH905.ESR.EKOMNR;                               
         BH670.EEJDNR = BH905.ESR.EEJDNR;                               
         BH670.SORTCPR = BH905.ESR.DCPRCIR;                             
         BH670.DCPRCIR = BH905.ESR.DCPRCIR;                             
         BH670.EJER_NU.DOVTG = BH905.ESR.DOVTG;                         
         BH670.EJER_NU.DAFSTÅ = BH905.ESR.DAFSTÅ;                       
         BH670.EJER_NU.DSLUTS = BH905.ESR.DSLUTS;                       
         BH670.EJER_NU.DSKØDE = BH905.ESR.DSKØDE;                       
         BH670.EJER_NU.CEJEV = BH905.ESR.CEJEV;                         
         BH670.EJER_NU.DVURDÅR = BH905.ESR.DVURDÅR;                     
         BH670.EJER_NU.CBENYT = BH905.ESR.CBENYT;                       
         BH670.EJER_NU.GL_BEJDV = BH905.ESR.GL_BEJDV;                   
         BH670.EJER_NU.BBROPFØRT = BH905.ESR.BBROPFØRT;                 
         BH670.EJER_NU.DATO0107 = 0;                                    
         BH670.EJER_NU.CNEDSL1 = 0;                                     
         BH670.EJER_NU.CNEDSL1GL = 0;                                   
                                                                        
         IF BH670.EJER_NU.DAFSTÅ > 0                                    
         THEN                                                           
            BH670.EJER_NU.DEJETTIL = BH670.EJER_NU.DAFSTÅ;              
         ELSE                                                           
            BH670.EJER_NU.DEJETTIL = 99991231;                          
                                                                        
         BH670.CÆGTEJET = 0;                                            
                                                                        
         /* 'GAMLE' INDIVIDER SKAL BEVARES MAX. 2 ÅR.  */               
         /* D.V.S. DE DROPPES, HVIS DER IKKE FINDES EN */               
         /* MAKKER (ÆGTEFÆLLE,EFTERLEVENDE ELLER PER-  */               
         /* SONEN SELV) I FORBINDELSE MED OVERFØRSLEN  */               
         /* MELLEM ÆGTEFÆLLER M.V.                     */               
         BH670.EJER_NU.DANNETÅR = 2000;                                 
         BH670.SORTÅR = 2000;                                           
                                                                        
         BH670.EJER_NU.CPRNR = BH670.DCPRCIR;                           
         BH670.EJER_NU.DKØRT = UDDATO;                                  
         BH670.EJER_NU.CCIVS = BH905.MT.CCIVS;                          
         BH670.EJER_NU.DCIÆN = BH905.MT.HIST_OPL(2000).DCIÆN;           
                                                                        
         BH670.EJER_NU.CNEDSL1GL = BH670.EJER_NU.CNEDSL1;               
                                                                        
         BH670.DHENVN =                                                 
         BH905.MT.HIST_OPL(2000).DHENVN;                                
                                                                        
         IF (BH670.EJER_NU.DCIÆN >= 19990901 &                          
             BH670.EJER_NU.DCIÆN <= 20001231) &                         
            BH670.EJER_NU.DATO0107 <= BH670.EJER_NU.DCIÆN               
         THEN                                                           
            DO;                                                         
               IF BH905.MT.HIST_OPL(2000).DHENVN = 0 &                  
                  BH905.MT.HIST_OPL(1999).DHENVN > 0                    
               THEN                                                     
                  BH670.DHENVN =                                        
                  BH905.MT.HIST_OPL(1999).DHENVN;                       
               /* EJENDOMMEN VAR OGSÅ EJET AF PERSONEN FØR ELLER PÅ */  
               /* DEN SENESTE CIVILSTANDSÆNDRINGSDATO               */  
               BH670.CÆGTEJET = 1;                                      
            END;                                                        
                                                                        
         SELECT;                                                        
           WHEN (BH670.EJER_NU.CBENYT = '09' !                          
                 BH670.EJER_NU.CBENYT = '17' !                          
                 BH670.EJER_NU.CBENYT = '70' !                          
                 BH670.EJER_NU.CBENYT = '71')                           
             DO;                                                        
                BH670.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           WHEN (BH670.EJER_NU.CBENYT = '  ' &                          
                 BH670.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH670.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           WHEN (BH670.EJER_NU.DVURDÅR = '2001' &                       
                 BH670.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH670.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           OTHERWISE                                                    
             CALL OPSÆT_DATO_0107;                                      
         END;                                                           
                                                                        
 END BEHANDL;                                                           
 /*********************************************************************/
 /*    OPSÆT DATO_0107 P.G.A. SLUTSEDDEL-/OVERTAGELSES- ELLER         */
 /*    SKØDEDATO SAMT OPSÆT KODE FOR EVT. 2 PROMILLE NEDSLAG I EJEN-  */
 /*    DOMSVÆRDISKATTEN                                               */
 /*    HER BEHANDLES KUN EJENDOMME FRA ESR, DA EJENDOMME SOM KUN FIN- */
 /*    DES I EVS HAR FÅET OPSAT OPLYSNINGERNE VIA ONLINE-INDBERETNING */
 /*********************************************************************/
 OPSÆT_DATO_0107:                                                       
 PROC;                                                                  
                                                                        
         SELECT;                                                        
           WHEN (BH670.EJER_NU.DSLUTS > 19980701)                       
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DSLUTS;         
                 BH670.EJER_NU.CNEDSL1 = 30;                            
              END;                                                      
           WHEN (BH670.EJER_NU.DSLUTS > 0 &                             
                 BH670.EJER_NU.DSLUTS <= 19980701)                      
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DSLUTS;         
                 BH670.EJER_NU.CNEDSL1 = 10;                            
              END;                                                      
           WHEN (BH670.EJER_NU.DOVTG > 19980701)                        
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DOVTG;          
                 BH670.EJER_NU.CNEDSL1 = 31;                            
              END;                                                      
           WHEN (BH670.EJER_NU.DOVTG > 0 &                              
                 BH670.EJER_NU.DOVTG <= 19980701)                       
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DOVTG;          
                 BH670.EJER_NU.CNEDSL1 = 11;                            
              END;                                                      
           WHEN (BH670.EJER_NU.DSKØDE > 19980701)                       
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DSKØDE;         
                 BH670.EJER_NU.CNEDSL1 = 32;                            
              END;                                                      
           WHEN (BH670.EJER_NU.DSKØDE > 0 &                             
                 BH670.EJER_NU.DSKØDE <= 19980701)                      
              DO;                                                       
                 BH670.EJER_NU.DATO0107 = BH670.EJER_NU.DSKØDE;         
                 BH670.EJER_NU.CNEDSL1 = 12;                            
              END;                                                      
           OTHERWISE                                                    
              BH670.EJER_NU.CNEDSL1 = 13;                               
         END;                                                           
                                                                        
 END OPSÆT_DATO_0107;                                                   
 /*********************************************************************/
 /*    OPSÆT TYPE OG DATO TIL SORTERING AF OUTPUT-DATASÆT SÅ EVENTUEL */
 /*    OVERFØRSEL AF 'BEDSTE' DATO0107 M.V. KAN FORETAGES             */
 /*    VED TILKØB/FRASALG/TILBAGEKØB/ENKE EFTER SAMT EVT. MELLEM      */
 /*    ÆGTEFÆLLER.                                                    */
 /*********************************************************************/
 OPSÆT_SORT_KRIT:                                                       
 PROC;                                                                  
                                                                        
         BH670.SORTDATO = BH670.EJER_NU.DATO0107;                       
                                                                        
         SELECT;                                                        
           WHEN (BH670.EJER_NU.DAFSTÅ > 0)                              
              DO;                                                       
                 BH670.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           WHEN (BH670.EJER_NU.CCIVS = 'D')                             
              DO;                                                       
                 BH670.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                 BH670.SORTTYPE = 6;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
         END;                                                           
                                                                        
 END OPSÆT_SORT_KRIT;                                                   
 /*********************************************************************/
 /*    SKRIV DATASÆT                                                  */
 /*********************************************************************/
 SKRIV_DATASÆT:                                                         
 PROC;                                                                  
                                                                        
         /* FØRST SKRIVES AKTUEL PERSON */                              
         WRITE FILE (BH670O) FROM (BH670);                              
         TV_SKRIV = TV_SKRIV + 1;                                       
                                                                        
         /* SÅ SKRIVES EVT. ÆGTEFÆLLE SOM DUBLET */                     
         IF BH670.DHENVN > 0 &                                          
           (BH670.SORTTYPE = 4  !        /* DØDE OG/ELLER SÆLGERE   */  
            BH670.SORTTYPE = 6)          /* IKKE SÆLGERE ELLER DØDE */  
         THEN                                                           
            DO;                                                         
               BH670.SORTTYPE = 3;                       /*DUBLET AF? */
               BH670.SORTCPR = BH670.DHENVN;                            
               WRITE FILE (BH670O) FROM (BH670);                        
               TV_DUBLET = TV_DUBLET + 1;                               
               TV_SKRIV = TV_SKRIV + 1;                                 
            END;                                                        
                                                                        
 END SKRIV_DATASÆT;                                                     
                                                                        
 /*********************************************************************/
 /*      DER DANNES ET SLUTINDIVID TIL BRUG FOR MASKINEL AFSTEMNING   */
 /*********************************************************************/
 DAN_OPT_INDV:                                                          
 PROC;                                                                  
                                                                        
         BH67099.EKOMNR   = 999;                                        
         BH67099.EEJDNR   = 9999999;                                    
         BH67099.SORTCPR  = 99999999999;                                
         BH67099.SORTÅR   = 99999;                                      
         BH67099.SORTDATO = 999999999;                                  
         BH67099.SORTTYPE = 999;                                        
         BH67099.DCPRCIR  = 99999999999;                                
         BH67099.DHENVN   = 99999999999;                                
         BH67099.ANT_INDV = TV_SKRIV;                                   
                                                                        
         WRITE FILE (BH670O) FROM (BH67099);                            
                                                                        
 END DAN_OPT_INDV;                                                      
 /*********************************************************************/
 /*          UDSKRIVNING AF TOTALLISTE                                */
 /*********************************************************************/
 SKRIV_TOTALER:                                                         
 PROC;                                                                  
                                                                        
         CALL ZZ20300(LIN_BLANK,'01');                                  
         CALL ZZ20300(LIN1,'01');                                       
         CALL ZZ20300(LIN2,'01');                                       
         LIN3.TEKST ='ANTAL LÆSTE INDIVIDER PÅ BH90501D BEREGNINGSBÅND';
         LIN3.ANT = TV_LÆS;                                             
         CALL ZZ20300(LIN3,'01');                                       
         IF TV_KOM > 0                                                  
         THEN                                                           
            DO;                                                         
               LIN3.TEKST = 'ANTAL OVERLÆSTE KOMMUNEHEADERE';           
               LIN3.ANT = TV_KOM;                                       
               CALL ZZ20300(LIN3,'01');                                 
            END;                                                        
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = 'ANTAL SKREVNE INDIVIDER                        ';
         LIN3.ANT = TV_SKRIV;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = '      HERAF DUBLETTER                          ';
         LIN3.ANT = TV_DUBLET;                                          
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
 END SKRIV_TOTALER;                                                     
                                                                        
                                                                        
 END BH67000;                                                           
