 PROCESS OPT(TIME);                                                     
 BH96000:  /* BEREGN EVS TIL SLUT 2016 */                       /*RUL*/ 
         PROCEDURE (EXECPARM) OPTIONS (MAIN) REORDER;                   
 /********************************************************************/ 
         DCL COPYRIGHT CHAR (30) STATIC                                 
         INIT ('COPYRIGHT KOMMUNEDATA I/S 2013');                       
 /**********************************************************************
 *                                                                     *
 * FORMÅL : BEREGNING AF EVS TIL SLUT 2016                         RUL *
 *                                                                     *
 * INPUT  : B.H94500D BEREGNINGSBÅND INDEHOLDENDE DATA OPSAT VIA       *
 *          UDTRÆK FRA ESR, EVS SLUT 2012 OG EVS FORSKUD 2013 SAMT     *
 *          MINI MT-FIL FRA FORSKUD 2013 + 1/7-98-STATUS OPLYSNINGER   *
 *          + OPSAT STATUS VEDR. EVT. HELÅRSSOMMERHUSE + OPSATTE PER-  *
 *          TYPER M.V. TIL BRUG VED BEREGNING AF EVS.                  *
 *                                                                     *
 * OUTPUT : B.H96000D  BEREGNINGSBÅND - ALLE EJENDOMME                 *
 *          B.H96010D  TRANSER TIL ESR - LEJEVÆRDIKODE/PENS.KODE       *
 *          BH96001Y   KØRSELSKONTROLLISTE                             *
 *          BH96002Y   FEJLLISTE FRA MASKINEL AFSTEMNING               *
 *                                                                     *
 * PROGRAMMØR: AAGE RASMUSSEN  JANUAR    2001                          *
 * RETTET: EDWARD DAVID LARYEA, LSU/T&S, 11.01.2001                    *
 *         TILRETNING IFØLGE EVS SLUT 2000  AFSNIT 1-8                 *
 * ÅRSTILRET: AAGE RASMUSSEN  DEC. 2001                                *
 * ÅRSTILRET: AAGE RASMUSSEN  NOV. 2002                                *
 * ÅRSTILRET: AAGE RASMUSSEN  NOV. 2003                                *
 * ÅRSTILRET: AAGE RASMUSSEN  NOV. 2004                                *
 * SLUT05     SUSANNE KROGH VILLUMSEN                 09/11-2005       *
 *            ÅRSTILRETNING SLUT 2005                                  *
 * SLUT06     SUSANNE KROGH VILLUMSEN                 04/10-2006       *
 *            ÅRSTILRETNING SLUT 2006                                  *
 * SLUT07     INGRID FISCHER IFI                      14/11-2007       *
 *            ÅRSTILRETNING SLUT 2007                                  *
 * SLUT08     BO SCHMIDT                              14/11-2008       *
 *            ÅRSTILRETNING SLUT 2008                                  *
 * SLUT09     GERD HOLM-PEDERSEN                      08/10-2009       *
 *            ÅRSTILRETNING SLUT 2009  SAMT #0904 DBO FRA FORSKUD      *
 *            KRAVNR #18-03 AUTOMATISK NEDTAGNING AF FELT 158=8        *
 * #18-03-2   GERD HOLM-PEDERSEN                      03/12-2009       *
 *            FELT 747, FERHVFLER, SKAL OPSÆTTES SOM BLANK,            *
 *            NÅR FELT158=7 NEDTAGES.                                  *
 * SLUT10     GERD HOLM-PEDERSEN                      08/10-2010       *
 *            ÅRSTILRETNING SLUT 2010  SAMT           FRA FORSKUD      *
 *                                                                     *
 * SLUT10-2   GERD HOLM-PEDERSEN                      25/03-2011       *
 *            PGA. OMKØRSEL NULSTILLET BH945_ANT_INDV I STEDET FOR     *
 *            AT INITIERE DET MED BH94599.ANT_INDV. OG RETTET TILBAGE  *
 *                                                                     *
 * SLUT11     GERD HOLM-PEDERSEN                      20/10-2011       *
 *            ÅRSTILRETNING SLUT 2011                                  *
 *                                                                     *
 * #GEH       GERD HOLM-PEDERSEN                      APRIL 2012       *
 *            HAR BRUGT COPR_FELT759 SOM HJÆLPEFELT.                   *
 *            SAKL BRUGE DET TIL AT SPØRGE PÅ I BH97400L               *
 *                                                                     *
 * SLUT12     LARS KAAE HARRITSHØJ                      SEP 2012       *
 *            ÅRSTILRETNING SLUT 2012                                  *
 *            TILRETTET KRAV 18-01 BENYTTELSESKODE 25                  *
 *                                                                     *
 * SLUT13     JØRGEN SAUGMANN                           OKT 2013       *
 *            ÅRSTILRETNING SLUT 2013                                  *
 *            JØRGEN SAUGMANN                           OKT 2013       *
 *            DEFECT 261: NEGATIVT BELØB I EJVSKAFSKBLB / SØG #01      *
 *            JØRGEN SAUGMANN                           JAN 2014       *
 *            INDLÆGGELSE AF EU LOVGIVNING VEDR. BEGRÆNSET SKATTEPLIGT *
 *            OG DOBBELTDOMICILERING FOR PENSIONSTER    / SØG #02      *
 *                                                                     *
 * SLUT14     JØRGEN SAUGMANN                           OKT 2014       *
 *            ÅRSTILRETNING SLUT 2014                                  *
 * SLUT15     Z6JNK                                     OKT 2015       *
 *            ÅRSTILRETNING SLUT 2015                                  *
 * SLUT15     INDSAT FEJLRETTELSE FRA SUP BR93500 PROG  FEB 2016 #01   *
 * SLUT16     ÅRSTILRETNING SLUT 2016                                  *
 *            Defect 151 Forskud fra 2016 fejlnummer 5152              *
 *            skal ikke sættes op når ejerforholdet er slettet         *
 * SLUT16     FEJLRETTELSE FRA SUP ER TAGET UD IGEN     JUN 2016 #02   *
 *            DA KODENS FUNKTION SKAL VARETAGES AF BH94400L  QEB       *
 * SLUT17     ÅRSTILRETNING SLUT 2017                   OKT 2017       *
 *            INGEN RETTELSER                                          *
 **********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /*********************************************************************/
 /*      PARAMETER TIL ANGIVELSE AF OM DET ER PRODUKTION ELLER        */
 /*      TESTKØRSEL AF HENSYN TIL MASKINEL AFSTEMNING                 */
 /*********************************************************************/
 DCL     EXECPARM        CHAR      (6) VAR;                             
 DCL     EX_PARM         CHAR      (4);                                 
         EX_PARM = EXECPARM;                                            
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH945I  FILE RECORD INPUT;     /* FORELØBIGT BEREGN.BÅND    */ 
 DCL     BH960O  FILE RECORD OUTPUT;    /* BEREGN.BÅND EFTER BEREGN. */ 
 DCL     BH9601O FILE RECORD OUTPUT;    /* TRANSER TIL ESR           */ 
 /********************************************************************* 
 *       DECLARE AF INPUT                                             * 
 *********************************************************************/ 
 DCL     BH945_AR        CHAR      (6000) VAR;                          
 DCL     1 BH945         BASED     (ADDR(BH945_AR)),                    
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90000N;;                                          
 DCL     1 BH94599       BASED     (ADDR(BH945_AR)),                    
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90099N;                                           
 /********************************************************************* 
 *       DECLARE AF OUTPUT                                            * 
 *********************************************************************/ 
 DCL     1 BH96099,                         /* BEREGNINGSBÅND         */
           %INCLUDE BH90099N;               /* OPTÆLLINGSINDIVID      */
 DCL     1 BH96011N,                                                    
           %INCLUDE BH96011N;;                                          
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 DCL     1 TV,                   /* TÆLLEVÆRKER TIL TOTALLISTEN */      
           2 LÆS_BH945    FIXED DEC (7),                                
           2 OVERLÆS      FIXED DEC (7),                                
           2 BK16         FIXED DEC (7),                                
           2 ANV_INDFLYT  FIXED DEC (7),                                
           2 ANV_FRAFLYT  FIXED DEC (7),                                
           2 SKREVET      FIXED DEC (7),                                
           2 PENS_TR      FIXED DEC (7),                                
           2 F158_ER_7    FIXED DEC (7),                                
           2 F158_TIL_0   FIXED DEC (7),                                
           2 F158_1TIL3   FIXED DEC (7),                                
           2 F158_ANT_FL  FIXED DEC (7),                                
           2 FELT759_ANT  FIXED DEC (7),                      /*#GEH*/  
           2 FELT106_ANT4      FIXED DEC (7),                           
           2 FELT106_ANT4_FEJL FIXED DEC (7);                           
                                                                        
 DCL     1 SKR_FEJLNR(4000:6000),  /* TÆLLEVÆRKER TIL TOTALLISTEN */    
           2 ANTAL       FIXED DEC (7);                                 
 /********************************************************************* 
 *       DECLARE AF DIV. FÆLLESMACROER (SLUT/BOY/FORSKUD)             * 
 *********************************************************************/ 
 DCL     1 BH65300M      ALIGNED,                                       
           %INCLUDE BH65300M;                                           
 DCL     1 BH60101M      ALIGNED,                                       
           %INCLUDE BH60101M;                                           
 /********************************************************************* 
 *       DECLARE AF BUILTIN'S                                         * 
 *********************************************************************/ 
 DCL     MULTIPLY        BUILTIN;                                       
 DCL     DIVIDE          BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 /********************************************************************* 
 *       DECLARE AF ENTRY'S                                           * 
 *********************************************************************/ 
 DCL     BH96010         ENTRY;                                         
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH96000L'),                                        
           2 F1          CHAR      (25)      INIT      (' '),           
           2 TEKST2      CHAR      (57)      INIT      (' '),           
           2 F2          CHAR      (12)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN0,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (41),                                
           2 CPUÅR       PIC       '99',                                
           2 TEKST2      CHAR      (11),                                
           2 START       PIC       '999999',                            
           2 TEKST3      CHAR      (9),                                 
           2 SLUT        PIC       '999999',                            
           2 TEKST4      CHAR      (57);                                
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZZ',                       
           2 F2          CHAR      (61)      INIT      (' ');           
 DCL     1 DETLIN2,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (33),                                
           2 RCKOD       CHAR      (01)      INIT      (' '),           
           2 F1          CHAR      (19)      INIT      (' '),           
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZ9',                       
           2 F2          CHAR      (68)      INIT      (' ');           
 DCL     1 DETLIN3,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZ9',                       
           2 F2          CHAR      (10)      INIT      (' '),           
           2 TEKST2      CHAR      (07)      INIT      ('BELØB: '),     
           2 BELØB       PIC       'ZZZ.ZZZ.ZZZ.ZZZ.ZZ9',               
           2 F3          CHAR      (25)      INIT      (' ');           
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
 EXTERNAL INIT ('NOTEST(ALL,,;)');                                      
 DCL     EOF_BH945       BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
 DCL     (I,J,K,N)       BIN FIXED (15)    INIT      (0);               
 DCL     INDEXÅR         BIN FIXED (15);                                
 DCL     INDEX           BIN FIXED (31);                                
                                                                        
 DCL     GEM_CPR         FIXED     (11);                                
 DCL     GEM_KOMNR       FIXED     (3);                                 
 DCL     GEM_EJDNR       FIXED     (7);                                 
 DCL     HJUDSKRNR       FIXED     (5);                                 
                                                                        
 DCL     HJVÆRDI1        FIXED     (15,3);                              
 DCL     HJVÆRDI2        FIXED     (13,3);                              
 DCL     HJVÆRDI3        FIXED     (13,0);                              
 DCL     HJVÆRDI4        FIXED     (15,1);                              
 DCL     HJDAGE          FIXED     (3);                                 
 DCL     HJPCT           FIXED     (5,4);                               
                                                                        
 DCL     HJ_FEJLNR       PIC       '(4)9';                              
 DCL     HJ_FEJLNRC      CHAR      (4)     BASED(ADDR(HJ_FEJLNR));      
                                                                        
 DCL     FRADATO         PIC       '(8)9';                              
 DCL     1 FRA           BASED(ADDR(FRADATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     TILDATO         PIC       '(8)9';                              
 DCL     1 TIL           BASED(ADDR(TILDATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /* NYE HJÆLPEFELTER                SLUT09 #18-03 */                    
 DCL     HJDAGE_EJET     FIXED     (3);                                 
 DCL     HJPER_ANT       FIXED     (3);                                 
 DCL     HJPER_DAGE      FIXED     (3);                                 
 DCL     HJDAGE_PLUS     FIXED     (3);                                 
                                                                        
 DCL     HJ_EJET_FRA     PIC       '(8)9';                              
 DCL     HJ_EJET_TIL     PIC       '(8)9';                              
                                                                        
 /********************************************************************* 
 *       DECLARE AF HJÆLPEFELTER TIL MASKINEL AFSTEMNING              * 
 *********************************************************************/ 
 DCL     BH945_ANT_INDV  FIXED     (7)       INIT      (0);             
 DCL     SWFEJL          CHAR      (1)       INIT      (' ');           
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
         EOF_BH945 = NEJ;                                               
   /*    ON ERROR                                                       
            CALL PLIDUMP ('SNHOB'); */                                  
                                                                        
         ON FIXEDOVERFLOW                                               
            PUT SKIP LIST ('FIXEDOVERFLOW CPRNR: ',BH945.SORT_CPR);     
                                                                        
         OPEN FILE (BH945I)  TITLE ('BH94500I');                        
         OPEN FILE (BH960O)  TITLE ('BH96000O');                        
         OPEN FILE (BH9601O) TITLE ('BH96010O');                        
                                                                        
         ON ENDFILE (BH945I)                                            
            EOF_BH945 = JA;                                             
                                                                        
         CALL ZZ20390 ('*OPEN','BH96001Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
                                                                        
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS2;                                        
         OVERLIN2.CCA   = ZZWS3;                                        
                                                                        
         TV = 0;                                                        
         INDEXÅR = BH65300M.SLUTÅR;                                     
                                                                        
         DO INDEX = 4000 TO 6000;                                       
            SKR_FEJLNR(INDEX).ANTAL = 0;                                
         END;                                                           
                                                                        
         OVERLIN1.TEKST2 = 'BEREGNING AF EJENDOMSVÆRDISKAT ' !!         
                           'TIL SLUT ' !! BH65300M.INDKÅR1;             
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_BH945;                                                
                                                                        
         GEM_CPR   = BH945.SORT_CPR;                                    
         GEM_KOMNR = BH945.SORT_KOMNR;                                  
         GEM_EJDNR = BH945.SORT_EJDNR;                                  
         HJUDSKRNR = 0;                                                 
                                                                        
         DO WHILE ( EOF_BH945 = NEJ );                                  
                                                                        
            CALL BEHANDL;                                               
            CALL LÆS_BH945;                                             
                                                                        
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS UDTRÆK FRA ESR                                           * 
 *********************************************************************/ 
 LÆS_BH945:                                                             
         PROC;                                                          
                                                                        
         READ FILE (BH945I) INTO (BH945_AR);                            
                                                                        
         IF BH945.SORT_CPR = 99999999999     /* OPTÆLL.INDV. 1 */       
         THEN                                                           
            DO;                                                         
               BH945_ANT_INDV = BH94599.ANT_INDV;                       
                                                                        
               READ FILE (BH945I) INTO (BH945_AR);                      
               IF BH945.SORT_CPR = 99999999999  &  /* OPTÆLL.INDV. 2 */ 
                  EOF_BH945 = NEJ                  /* ESB SLUT 2012 */  
               THEN                                                     
                  DO;                                                   
                     BH945_ANT_INDV =                                   
                     BH945_ANT_INDV + BH94599.ANT_INDV;                 
                     READ FILE (BH945I) INTO (BH945_AR);                
                  END;                                                  
            END;                                                        
                                                                        
         IF EOF_BH945 = NEJ                                             
         THEN                                                           
            TV.LÆS_BH945 = TV.LÆS_BH945 + 1;                            
                                                                        
 END LÆS_BH945;                                                         
 /********************************************************************* 
 *       PERSONER SOM EVT. SKAL BEREGNES                              * 
 *********************************************************************/ 
 BEHANDL:                                                               
 PROC;                                                                  
                                                                        
         IF BH945.SORT_KOMNR < 999 &                                    
            BH945.ESR.SORTCPR = 0 &                                     
            BH945.EVS_FORSK_EJER.DCPRN = 0 &                            
           (BH945.EVS_SLUT_EJER.DCPRN = 0 !                             
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET = '1')                     
         THEN                                                           
            DO;                                                         
               TV.OVERLÆS = TV.OVERLÆS + 1;                             
               RETURN;                                                  
            END;                                                        
                                                                        
         IF BH945.AKT_VURD.CBENYT = '16'                                
         THEN                                                           
            DO;                                                         
               /* NYT FRA OG MED EVS SLUT 2004       */                 
               /* FOR AT UNDGÅ HANSTHOLM-SITUATIONER */                 
               /* D.V.S. VIDEREFØRSEL AF EJENDOMME   */                 
               /* HVOR BYGNINGEN/BEBOELSEN ER        */                 
               /* OVERFØRT TIL GRUNDENS EJENDOMSNR.  */                 
               TV.BK16 = TV.BK16 + 1;                                   
               RETURN;                                                  
            END;                                                        
                                                                        
         /* #01 FEJLRETTELSE OVERFØRT FRA BH93500 */                    
         /* DA BH96000SKAL AFVIKLES I SUPLEMENT   */                    
         /* DENNE FUNKTION UDFØRES I BH94400L FOR                       
            SLUT2016 #02                                                
                                                                        
         IF (BH945.CHELÅR >= '1' & BH945.CHELÅR <= '3') !               
            (BH945.CHELÅR >= '7' & BH945.CHELÅR <= '9')                 
         THEN                                                           
           DO;                                                          
             BH945.TIL_EVS.FELT759 = 1;                                 
             IF BH945.EJERSKAB.CEJDTYPE_AKT = '3'                       
             THEN                                                       
               BH945.EJERSKAB.CEJDTYPE_AKT = '1';                       
             ELSE                                                       
               BH945.EJERSKAB.CEJDTYPE_AKT = '7';                       
           END;                                                         
         /* #01 SLUT */                                                 
                                                                        
         BH945.TIL_EVS.BFORSKAT_SW = -1;                                
         BH945.TIL_EVS.BFORSKAT = 0;                                    
         BH945.FRA_EVS_BER = '';                                        
         BH945.FRA_EVS_BER.BGRPROM1_SW = -1;                            
         BH945.FRA_EVS_BER.BPROM1_SW = -1;                              
         BH945.FRA_EVS_BER.BGRPROM2_SW = -1;                            
         BH945.FRA_EVS_BER.BPROM2_SW = -1;                              
         BH945.FRA_EVS_BER.BNEDSL1_SW = -1;                             
         BH945.FRA_EVS_BER.BNEDSL2_SW = -1;                             
         BH945.FRA_EVS_BER.BPENSNED_SW = -1;                            
         BH945.FRA_EVS_BER.BPENSNÆ_SW = -1;                             
         BH945.FRA_EVS_BER.BSUM1_SW = -1;                               
         BH945.FRA_EVS_BER.BSUM2_SW = -1;                               
         BH945.FRA_EVS_BER.BSUM3_SW = -1;                               
         BH945.FRA_EVS_BER.BSTITIL_SW = -1;                             
         BH945.FRA_EVS_BER.BSTIBEGR_SW = -1;                            
         BH945.FRA_EVS_BER.BNETTO_SW = -1;                              
                                                                        
         IF (BH945.MT.HIST_OPL(SLUTÅR).DCIÆN >= BH945.MT.DRGNÅRFRA &    
             BH945.MT.HIST_OPL(SLUTÅR).DCIÆN <= BH945.MT.DRGNÅRTIL) &   
            (BH945.MT.CCIVS = 'F' !                                     
             BH945.MT.CCIVS = 'O' !                                     
             BH945.MT.CCIVS = 'S') &                                    
            (BH945.AKT_EJER.DOVTG_GL >= BH945.MT.DRGNÅRFRA &            
             BH945.AKT_EJER.DOVTG_GL <= BH945.MT.DRGNÅRTIL) &           
             BH945.AKT_ÆGTF.DAFSTÅ > 0 &                                
             BH945.AKT_EJER.DOVTG_GL >= BH945.AKT_ÆGTF.DAFSTÅ           
         THEN                                                           
            BH945.AKT_EJER.CTILKØB = 'J';                               
                                                                        
         IF (BH945.MT.HIST_OPL(SLUTÅR).DCIÆN >= BH945.MT.DRGNÅRFRA &    
             BH945.MT.HIST_OPL(SLUTÅR).DCIÆN <= BH945.MT.DRGNÅRTIL) &   
            (BH945.MT.CCIVS = 'F' !                                     
             BH945.MT.CCIVS = 'O' !                                     
             BH945.MT.CCIVS = 'S') &                                    
            (BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &              
             BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &             
             BH945.AKT_ÆGTF.DOVTG_GL > 0 &                              
             BH945.AKT_ÆGTF.DOVTG_GL >= BH945.AKT_EJER.DAFSTÅ           
         THEN                                                           
            BH945.AKT_EJER.CTILKØB = 'J';                               
                                                                        
         IF BH945.AKT_EJER.DOVTG > 0 &                                  
            BH945.AKT_EJER.DINDFLYT > 0 &                               
            BH945.AKT_EJER.CTILKØB ^= 'J' &                             
           (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                        
            BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                       
           (BH945.AKT_EJER.DOVTG >= BH945.MT.DRGNÅRFRA &                
            BH945.AKT_EJER.DOVTG <= BH945.MT.DRGNÅRTIL) &               
           (BH945.AKT_EJER.DINDFLYT >= BH945.MT.DRGNÅRFRA &             
            BH945.AKT_EJER.DINDFLYT <= BH945.MT.DRGNÅRTIL) &            
            BH945.AKT_EJER.DINDFLYT >= BH945.AKT_EJER.DOVTG &           
           (BH945.AKT_EJER.DAFSTÅ = 0 !                                 
           (BH945.AKT_EJER.DAFSTÅ > 0 &                                 
            BH945.AKT_EJER.DINDFLYT <= BH945.AKT_EJER.DAFSTÅ))          
         THEN                                                           
            DO;                                                         
              BH945.TIL_EVS.DINDFLYT = BH945.AKT_EJER.DINDFLYT;         
              TV.ANV_INDFLYT = TV.ANV_INDFLYT + 1;                      
            END;                                                        
                                                                        
         IF BH945.AKT_EJER.DOVTG > 0 &                                  
            BH945.AKT_EJER.DINDFLYT > 0 &                               
            BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRFRA &                 
           (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                        
            BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                       
           (BH945.AKT_EJER.DINDFLYT >= BH945.MT.DRGNÅRFRA &             
            BH945.AKT_EJER.DINDFLYT <= BH945.MT.DRGNÅRTIL) &            
            BH945.AKT_EJER.DINDFLYT >= BH945.AKT_EJER.DOVTG &           
           (BH945.EVS_SLUT_EJER.DCPRN > 0 &                             
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1' &                    
            BH945.EVS_SLUT_EJER.SIDSTE.CINDFLYT = '1') &                
           (BH945.AKT_EJER.DAFSTÅ = 0 !                                 
           (BH945.AKT_EJER.DAFSTÅ > 0 &                                 
            BH945.AKT_EJER.DINDFLYT <= BH945.AKT_EJER.DAFSTÅ))          
         THEN                                                           
            DO;                                                         
              BH945.TIL_EVS.DINDFLYT = BH945.AKT_EJER.DINDFLYT;         
              TV.ANV_INDFLYT = TV.ANV_INDFLYT + 1;                      
            END;                                                        
                                                                        
         IF BH945.AKT_EJER.DOVTG    > 0 &                               
            BH945.AKT_EJER.DFRAFLYT > 0 &                               
            BH945.AKT_EJER.CTILKØB ^= 'J' &                             
           (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                        
            BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                       
           (BH945.AKT_EJER.DFRAFLYT >= BH945.MT.DRGNÅRFRA &             
            BH945.AKT_EJER.DFRAFLYT <= BH945.MT.DRGNÅRTIL) &            
            BH945.AKT_EJER.DFRAFLYT >= BH945.AKT_EJER.DOVTG &           
           (BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &               
            BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &              
            BH945.AKT_EJER.DFRAFLYT <= BH945.AKT_EJER.DAFSTÅ            
         THEN                                                           
            DO;                                                         
              BH945.TIL_EVS.DFRAFLYT = BH945.AKT_EJER.DFRAFLYT;         
              TV.ANV_FRAFLYT = TV.ANV_FRAFLYT + 1;                      
            END;                                                        
                                                                        
        /* SLUT09 KS.#18-03 NEDTAG AF FELT 158=7 */                     
        /* DET SKAL VÆRE DEN OPSATTE CEJBEVS (I BH94100) DER     */     
        /* SKAL SPØRGES PÅ.   IKKE DEN FRA SIDSTE RÆKKE.         */     
         IF BH945.TIL_EVS.CEJBEVS = 7                                   
         THEN                                                           
            TV.F158_ER_7 = TV.F158_ER_7 + 1;                            
                                                                        
         IF BH945.EJERSKAB.FERHVPER_ANT > 0                             
         THEN                                                           
            DO;                                                         
              IF BH945.SORT_KOMNR                     = 999             
              !  BH945.EVS_SLUT_EJER.DCPRN            =  0              
              !  BH945.TIL_EVS.CEJBEVS               ^= '7'             
              !  BH945.EVS_SLUT_EJER.SIDSTE.CEJDTYPE  = '3'             
              !  BH945.EVS_SLUT_EJER.SIDSTE.CEJDTYPE  = '8'             
              THEN                                                      
                 DO;                                                    
                   BH945.EJERSKAB.DERHVPER_FRA1 = '';                   
                   BH945.EJERSKAB.DERHVPER_TIL1 = '';                   
                   BH945.EJERSKAB.DERHVPER_FRA2 = '';                   
                   BH945.EJERSKAB.DERHVPER_TIL2 = '';                   
                   BH945.EJERSKAB.DERHVPER_FRA3 = '';                   
                   BH945.EJERSKAB.DERHVPER_TIL3 = '';                   
                   BH945.EJERSKAB.DERHVPER_FRA4 = '';                   
                   BH945.EJERSKAB.DERHVPER_TIL4 = '';                   
                   BH945.EJERSKAB.DERHVPER_FRA5 = '';                   
                   BH945.EJERSKAB.DERHVPER_TIL5 = '';                   
                   BH945.EJERSKAB.FERHVPER_DAGE = 0;                    
                   BH945.EJERSKAB.FERHVPER_ANT  = 0;                    
                   BH945.EJERSKAB.CNEDTAG158    = '';                   
                 END;                                                   
              ELSE                                                      
                 CALL NEDTAG_CEJBEVS7;                                  
            END;                                                        
                                                                        
         IF BH945.TIL_EVS.CÆGTOPR ^= '3'  &                             
            BH945.ESR.EJER.DCPRCIR > 0                                  
         THEN                                                           
            CALL OPSÆT_CKØBSALG;                                        
                                                                        
         IF BH945.EVS_FORSK_EJER.GPCTEJER > 0                           
         THEN                                                           
            BH945.GPCTEJERFOR = BH945.EVS_FORSK_EJER.GPCTEJER / 100;    
         ELSE                                                           
           IF (BH945.EVS_FORSK_EJER.CEJBEVS = '0' !                     
               BH945.EVS_FORSK_EJER.CEJBEVS = '4')                      
           THEN                                                         
              BH945.GPCTEJERFOR = 100.00;                               
                                                                        
         IF BH945.EVS_FORSK_EJER.DOVTG_GL > 0                           
         THEN                                                           
            BH945.TIL_EVS.DOVTGFOR =                                    
            FIX09_TIL_DB2_DATO(BH945.EVS_FORSK_EJER.DOVTG_GL);          
                                                                        
         IF BH945.EVS_FORSK_EJER.DAFSTAA > 0                            
         THEN                                                           
            BH945.TIL_EVS.DAFSTAAFOR =                                  
            FIX09_TIL_DB2_DATO(BH945.EVS_FORSK_EJER.DAFSTAA);           
                                                                        
         IF BH945.EVS_SLUT_EJER.SIDSTE.BMANNEDSL > 0 &                  
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                      
         THEN                                                           
            BH945.TIL_EVS.CUDLMAN = '1';                                
                                                                        
         IF (BH945.EVS_SLUT_EJER.SIDSTE.GPCTERHV > 0 !                  
             BH945.EVS_SLUT_EJER.SIDSTE.FDAGERHV > 0) &                 
             BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                     
         THEN                                                           
            BH945.TIL_EVS.CERHV = '1';                                  
         ELSE                                                           
            IF BH945.EVS_FORSK_EJER.GPCTERHV > 0 !                      
               BH945.EVS_FORSK_EJER.FDAGERHV > 0                        
            THEN                                                        
               BH945.TIL_EVS.CERHV = '2';                               
                                                                        
         IF BH945.EVS_SLUT_EJER.SIDSTE.FUDL100 > 0 &                    
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                      
         THEN                                                           
            BH945.TIL_EVS.CUDLHEL = '1';                                
                                                                        
         IF (BH945.EVS_SLUT_EJER.SIDSTE.FDAGUDLE > 0 !                  
             BH945.EVS_SLUT_EJER.SIDSTE.GPCTUDLE > 0) &                 
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                      
         THEN                                                           
            BH945.TIL_EVS.CUDLDEL = '1';                                
         ELSE                                                           
            IF (BH945.EVS_FORSK_EJER.FDAGUDLE > 0 !                     
                BH945.EVS_FORSK_EJER.GPCTUDLE > 0)                      
            THEN                                                        
               BH945.TIL_EVS.CUDLDEL = '2';                             
                                                                        
         IF BH945.TIL_EVS.CEJBEVS = '7'     /* KS. 2007 18.02.02 */     
         THEN                                                           
            BH945.TIL_EVS.FERHVFLER = 360;                              
                                                                        
         IF BH945.SORT_KOMNR = 999 &                                    
            BH945.EVS_SLUT_EJER.DCPRN > 0 &                             
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                      
         THEN                                                           
            BH945.TIL_EVS.CEKSEMP = BH945.EVS_SLUT_EJER.SIDSTE.CEKSEMP; 
                                                                        
         SELECT;                                                        
                                                                        
           WHEN (BH945.EVS_FORSK_EJER.DCPRN > 0 &                       
                 BH945.EVS_FORSK_EJER.BFORSKAT_SW = 0)                  
              DO;                                                       
                 BH945.TIL_EVS.BFORSKAT =                               
                 BH945.EVS_FORSK_EJER.BFORSKAT;                         
                 BH945.TIL_EVS.BFORSKAT_SW = 0;                         
                 BH945.TIL_EVS.CFORSKAT = ' ';                          
              END;                                                      
                                                                        
           OTHERWISE                                                    
              DO;                                                       
                 BH945.TIL_EVS.BFORSKAT_SW = -1;                        
                 BH945.TIL_EVS.BFORSKAT = 0;                            
                 BH945.TIL_EVS.CFORSKAT = '2';                          
              END;                                                      
                                                                        
         END; /* SELECT */                                              
                                                                        
         IF BH945.TIL_EVS.CPTYPGL = '1' !                               
            BH945.TIL_EVS.CPTYPGL = '2'                                 
         THEN                                                           
            BH945.TIL_EVS.CSKPLOMFGL = ' ';                             
                                                                        
         IF BH945.TIL_EVS.CPTYPSLUT = '1' !                             
            BH945.TIL_EVS.CPTYPSLUT = '2'                               
         THEN                                                           
            BH945.TIL_EVS.CSKPLOMF = ' ';                               
                                                                        
         IF (BH945.TIL_EVS.CSKPLOMFGL = '1' !                           
             BH945.TIL_EVS.CSKPLOMFGL = '3' !                           
             BH945.TIL_EVS.CSKPLOMFGL = '8') &                          
             BH945.TIL_EVS.CPTYPGL = '3'                                
         THEN                                                           
            BH945.TIL_EVS.CPTYPGL = '2';                                
                                                                        
         IF BH945.TIL_EVS.CPTYPSLUT = '3'                               
         THEN                                                           
            DO;                                                         
               IF BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM >= '0'             
               THEN                                                     
                  BH945.TIL_EVS.CSKPLOMF =                              
                  BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM;                   
               ELSE                                                     
                  BH945.TIL_EVS.CSKPLOMF = '0';                         
            END;                                                        
                                                                        
         IF BH945.TIL_EVS.CPTYPSLUT = '4'  /* #02 *//* #03 */           
         THEN                                                           
            DO; /*FRA FORSKUD*/                                         
               IF BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '1' !            
                  BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '3' !            
                  BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '8'              
               THEN                                                     
                 DO;                                                    
                   BH945.TIL_EVS.CSKPLOMF =                             
                     BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM;                
                   FELT106_ANT4 = FELT106_ANT4 + 1;                     
                 END;                                                   
               ELSE                                                     
                 DO; /*FRA SLUT*/                                       
                   IF EVS_SLUT_EJER.SIDSTE.CSKPLOMF = '1' !             
                      EVS_SLUT_EJER.SIDSTE.CSKPLOMF = '3' !             
                      EVS_SLUT_EJER.SIDSTE.CSKPLOMF = '8'               
                   THEN                                                 
                     DO;                                                
                       BH945.TIL_EVS.CSKPLOMF =                         
                         EVS_SLUT_EJER.SIDSTE.CSKPLOMF;                 
                       FELT106_ANT4 = FELT106_ANT4 + 1;                 
                     END;                                               
                   ELSE /*BØR IKKE FORKOMME*/                           
                     DO;                                                
                       BH945.TIL_EVS.CSKPLOMF = '0';                    
                       FELT106_ANT4_FEJL = FELT106_ANT4_FEJL + 1;       
                     END;                                               
                  END;                                                  
            END;                                                        
                                                                        
         CALL OPSÆT_PENSNED_KODE;                                       
                                                                        
         IF BH945.SORT_KOMNR = 999 &                                    
           (BH945.TIL_EVS.CPTYPSLUT = '3' !                             
            BH945.TIL_EVS.CPTYPSLUT = '4') &   /* #02 */                
            BH945.EJENDOM.CEJDTYPE >= '1' &                             
            BH945.TIL_EVS.FELT759 = ' ' &                               
            BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1' &                    
            BH945.EVS_SLUT_EJER.SIDSTE.CEJBEVS < '9' &                  
          ((BH945.EVS_SLUT_EJER.SIDSTE.FELT759 = '1' &                  
            BH945.EJENDOM.CEJDTYPE ^= '3' &                             
            BH945.EJENDOM.CEJDTYPE ^= '8') !                            
            BH945.EVS_SLUT_EJER.SIDSTE.FELT759 = '2' &                  
           (BH945.EJENDOM.CEJDTYPE = '3' !                              
            BH945.EJENDOM.CEJDTYPE = '8'))                              
         THEN                                                           
            BH945.TIL_EVS.FELT759 =                                     
            BH945.EVS_SLUT_EJER.SIDSTE.FELT759;                         
                                                                        
         /* EFTERFØLGENDE ÆNDRES CPTYPSLUT FRA '3' TIL '4'   */         
         /* FOR BEGRÆNSET SKATTEPLIGTIGE PENSIONISTER A.H.T. */         
         /* OPSÆTNING AF CSTIBLB VED BEREGNINGEN AF NY EVS   */         
                                                                        
                                                                        
        /*TAGET UD SLUT 2016 OPSÆTNING AF CPTYPSLUT FOREGÅR */          
        /*I BH94300L                                        */          
                                                                        
        /*IF BH945.TIL_EVS.CPTYPSLUT = '3' &                            
           (BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '1' !                  
            BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '3' !                  
            BH945.MT.HIST_OPL(INDEXÅR).CSKPLOM = '8')                   
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.CPTYP_ÆND = '3';                           
               BH945.TIL_EVS.CPTYPSLUT = '4';   /* #02  */              
            /* IF BH945.TIL_EVS.FELT759 = '1' ! /* #02                  
                  BH945.TIL_EVS.FELT759 = '2'                           
               THEN                                                     
                  BH945.TIL_EVS.FELT759 = ' '; */                       
        /*  END;*/                                                      
                                                                        
         CALL BH96010 (BH945_AR);                                       
                                                                        
         BH945.FRA_EVS_BER.FELT760 = BH945.TIL_EVS.CFRED;               
                                                                        
         BH60101M = '';                                                 
                                                                        
         IF BH945.AKT_EJER.DCPRCIR > 0                                  
         THEN                                                           
            DO;                                                         
               BH945.CSKATBER = '1';                                    
                                                                        
               IF BH945.AKT_EJER.DCPRCIR = BH945.ESR.EJER.DCPRCIR       
               THEN                                                     
                  CALL OPBYG_ESR_TRANS;                                 
                                                                        
               /* UNDERSØG OM EJEREN HAR HANDLET I INDKOMSTÅRET */      
                                                                        
               BH945.TIL_EVS.FRADAG = BH945.TIL_EVS.DOVTG;              
               BH945.TIL_EVS.TILDAG = BH945.TIL_EVS.DAFSTAA;            
                                                                        
               CALL OPSÆT_KØB_SALG(BH945.TIL_EVS.FRADAG,                
                                   BH945.TIL_EVS.TILDAG);               
                                                                        
               BH945.TIL_EVS.FDAGE = TÆLLER;                            
               BH945.TIL_SLS.BFSKAT_ESR = BH945.ESR.BFSKAT;             
                                                                        
               CALL EJDSKAT;                                            
                                                                        
         IF BH945.TIL_EVS.BERHVAN < 0                                   
         THEN                                                           
           DO;                                                          
             BH945.TIL_EVS.BERHVAN = 0; /* MIDLERTIDIG RET? */          
             PUT SKIP LIST ('NULSTIL CPRNR  : ',BH945.SORT_CPR);        
             PUT SKIP LIST ('        KOMNR  : ',BH945.SORT_KOMNR);      
             PUT SKIP LIST ('        EJDNR  : ',BH945.SORT_EJDNR);      
             PUT SKIP LIST ('        BFSKAT : ',BH945.ESR.BFSKAT);      
             PUT SKIP LIST ('        BERHVAN: ',BH945.TIL_EVS.BERHVAN); 
             PUT SKIP LIST ('           ');                             
           END;                                                         
                                                                        
               /* BFSKAT OG BERHVAN SKAL ALTID VIDERE TIL SLS */        
               /* MED INDHOLD OPSAT/ÆNDRET VIA CALL EJDSKAT   */        
                                                                        
               BH945.TIL_SLS.BFSKAT_SLS = BH945.ESR.BFSKAT;             
               BH945.TIL_SLS.BERHVAN_SLS = BH945.TIL_EVS.BERHVAN;       
                                                                        
               IF BH945.TIL_EVS.CLIN10 = 1                              
               THEN                                                     
                  DO;                                                   
                     BH945.TIL_EVS.BFSKAT = BH945.ESR.BFSKAT;           
                     /* EFTERREDIGERING A.H.T. DANNELSE AF LOAD */      
                     /* SAMT REDIGERING AF LINIER TIL SLUT      */      
                     IF BH945.TIL_EVS.BERHVAN > 0                       
                     THEN                                               
                        DO;                                             
                           IF BH945.TIL_EVS.CREDIG10 = '2'              
                           THEN                                         
                              BH945.TIL_EVS.BPRIVAN = 0;                
                           ELSE                                         
                              BH945.TIL_EVS.BERHVAN = 0;                
                        END;                                            
                     ELSE                                               
                        BH945.TIL_EVS.BPRIVAN = 0;                      
                  END;                                                  
               ELSE                                                     
                  DO;                                                   
                     BH945.TIL_EVS.BFSKAT  = 0;                         
                     BH945.TIL_EVS.BERHVAN = 0;                         
                     BH945.TIL_EVS.BPRIVAN = 0;                         
                  END;                                                  
            END;                                                        
         ELSE                                                           
            DO;                                                         
               /* BEHANDL UDENLANDSKE EJENDOMME            */           
               /* ELLER TILGANGE ENDNU IKKE OPRETTET I ESR */           
                                                                        
               /* BH945.TIL_EVS = BH945.EVS_UDTRÆK, BY NAME;   */       
               /* HER SKAL MÅSKE VÆLGES FRA SLUT ELLER FORSKUD */       
                                                                        
               IF BH945.SORT_KOMNR = 999                                
               THEN                                                     
                  DO;                                                   
                     /* UDENLANDSK */                                   
                     BH945.CSKATBER = '2';                              
                     BH945.EJENDOM.CBERGRL = '9';                       
                                                                        
                     /*DEFECT 151 F2016 */                              
                     IF BH945.EVS_UDTRÆK.CUDLAND = '4' &                
                        BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'          
                     THEN                                               
                        BH945.FEJLNR = 5152;                            
                     ELSE                                               
                        BH945.FEJLNR = 5021;                            
                                                                        
                     BH945.EJENDOM.EJD_FEJLNR = BH945.FEJLNR;           
                  END;                                                  
               ELSE                                                     
                  DO;                                                   
                     SELECT;                                            
                       WHEN ((BH945.MT.CCIVS = 'E' !                    
                              BH945.MT.CCIVS = 'L') &                   
                             (BH945.EVS_FORSK_EJER.DCPRN > 0 &          
                             (BH945.MT.HIST_OPL(SLUTÅR).DCIÆN >=        
                              BH945.MT.DRGNÅRFRA &                      
                              BH945.MT.HIST_OPL(SLUTÅR).DCIÆN <=        
                              BH945.MT.DRGNÅRTIL)))                     
                         DO;                                            
                            BH945.FEJLNR = 5027;                        
                            BH945.TIL_EVS.CEJBEVS = '1';                
                         END;                                           
                       OTHERWISE                                        
                         DO;                                            
                            BH945.FEJLNR = 5060;                        
                            BH945.TIL_EVS.CEJBEVS = '1';                
                         END;                                           
                     END; /* SELECT */                                  
                                                                        
                     BH945.CSKATBER = '3';                              
                  END;                                                  
                                                                        
               IF BH945.MT.CCIVS = 'D' &                                
                 (BH945.MT.HIST_OPL(SLUTÅR).DCIÆN >=                    
                  BH945.MT.DRGNÅRFRA &                                  
                  BH945.MT.HIST_OPL(SLUTÅR).DCIÆN <=                    
                  BH945.MT.DRGNÅRTIL) &                                 
                  BH945.EVS_FORSK_EJER.DCPRN > 0/*RETTET EFTER GRUNDLEV.
                  BH945.FEJLNR ^= 5060 ***        TIL EVS SLUT 2003   */
               THEN                                                     
                  DO;                                                   
                     BH945.FEJLNR = 5027;                               
                     BH945.TIL_EVS.CEJBEVS = '1';                       
                  END;                                                  
                                                                        
               IF BH945.TIL_EVS.CEJBEVS = '1'                           
               THEN;                                                    
               ELSE                                                     
                  BH945.TIL_EVS.CEJBEVS = '2';                          
                                                                        
               IF BH945.ESR.EKOMNR = 0                                  
               THEN                                                     
                  DO;                                                   
                    BH945.EJENDOM.CBERGRL = '9';                        
                  END;                                                  
                                                                        
               IF BH945.EVS_SLUT_EJER.DCPRN > 0 &                       
                  BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1'                
               THEN                                                     
                  DO;                                                   
                    IF BH945.EVS_SLUT_EJER.SIDSTE.CDATAFRA = '1'        
                    THEN                                                
                       BH945.TIL_EVS.CDATAFRA = '5';                    
                    ELSE                                                
                       BH945.TIL_EVS.CDATAFRA = '1';                    
                  END;                                                  
               ELSE                                                     
                  BH945.TIL_EVS.CDATAFRA = '2';                         
                                                                        
            END; /* BEHANDL TILGANGE+UDENLANDSK */                      
                                                                        
         IF BH945.MT.CCIVS = 'D' &                                      
            BH945.FEJLNR ^= 5060                                        
         THEN                                                           
            CALL PERIODISER_DØDE;                                       
                                                                        
         IF BH945.MT.CCIVS ^= 'D'                                       
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = -1;                          
               BH945.TIL_EVS.CFORSKAT = '2';                            
            END;                                                        
                                                                        
         IF BH945.FRA_EVS_BER.BPENSNÆ_SW = 0 !                          
            BH945.EJERSKAB.BBERGRL_SW = -1 !                            
            BH945.EJENDOM.CEJDTYPE < '1'  !                             
            BH945.TIL_EVS.CINVPNR ^= '0'                                
         THEN;                                                          
         ELSE                                                           
            IF BH945.EJENDOM.CEJDTYPE = '3' !                           
               BH945.EJENDOM.CEJDTYPE = '8'                             
            THEN                                                        
               DO;                                                      
                  /* FRITIDSBOLIG */                                    
                  HJVÆRDI1 = (MULTIPLY                                  
                  (BH945.EJERSKAB.BBERGRL,0.004,13,3)) + 0.005;         
                  /* NEDSLAGET KAN MAX. VÆRE 2000,00 KR. */             
                  IF HJVÆRDI1 < 2000.000                                
                  THEN                                                  
                     BH945.FRA_EVS_BER.BPENSNÆ = HJVÆRDI1;              
                  ELSE                                                  
                     BH945.FRA_EVS_BER.BPENSNÆ = 2000.00;               
                  BH945.FRA_EVS_BER.BPENSNÆ_SW = 0;                     
               END;                                                     
            ELSE                                                        
               DO;                                                      
                  /* HELÅRSBOLIG */                                     
                  HJVÆRDI1 = (MULTIPLY                                  
                  (BH945.EJERSKAB.BBERGRL,0.004,13,3)) + 0.005;         
                  /* NEDSLAGET KAN MAX. VÆRE 6000,00 KR. */             
                  IF HJVÆRDI1 < 6000.000                                
                  THEN                                                  
                     BH945.FRA_EVS_BER.BPENSNÆ = HJVÆRDI1;              
                  ELSE                                                  
                     BH945.FRA_EVS_BER.BPENSNÆ = 6000.00;               
                  BH945.FRA_EVS_BER.BPENSNÆ_SW = 0;                     
               END;                                                     
                                                                        
         IF BH945.EJERSKAB.CNEDTAG158  = 'J'   /* #18-03 SLUT09 */      
         THEN                                                           
            CALL OPTÆL_CNEDTAG158;                                      
                                                                        
         CALL SKRIV_PERSON;                                             
                                                                        
 END BEHANDL;                                                           
                                                                        
 /*********************************************************************/
 /* NEDTAG CEJBEVS, FELT158=7                SLUT09 KS.#18-03         */
 /*                                                                   */
 /* VED BEREGNING AF BEBOEDE PERIODER SKAL DER TAGES HENSYN TIL       */
 /* FORSKUDTE REGNSKABSPERIODER                                       */
 /* BEREGNING AF ANTAL EJDEDE DAGE SKAL LIGGE INDENFOR KALENDERÅRET   */
 /*                                                                   */
 /*********************************************************************/
 NEDTAG_CEJBEVS7:                                                       
 PROC;                                                                  
                                                                        
      CALL FLYT_PER_FRA_MT_TIL_EJERSKAB;                                
      BH945.TIL_EVS.FERHVFLER   = 0;       /* #18-03-2 */               
      BH945.TIL_EVS.FUDL100     = 0;                                    
      BH945.EJERSKAB.CNEDTAG158 = 'J';                                  
      BH945.TIL_EVS.CEJBEVS     = '0';                                  
                                                                        
      HJPER_ANT   = 0;                                                  
      HJDAGE_EJET = 0;                                                  
      HJPER_DAGE  = 0;                                                  
      HJ_EJET_FRA = 0;                                                  
      HJ_EJET_TIL = 0;                                                  
                                                                        
      IF BH945.EJERSKAB.FERHVPER_ANT > 5                                
      THEN                                                              
         DO;                                                            
           BH945.EJERSKAB.DERHVPER_FRA1 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL1 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA2 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL2 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA3 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL3 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA4 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL4 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA5 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL5 = '';                           
           BH945.EJERSKAB.FERHVPER_DAGE = 0;                            
           TV.F158_ANT_FL = TV.F158_ANT_FL + 1;                         
           RETURN;                                                      
         END;                                                           
                                                                        
      /* ANTAL PERIODER KAN BLIVE REDUCERET, DERFOR GEMMES ANTALLET */  
      /* AF HENSYN TIL DE TILFÆLDE HVOR ANTALLET VAR STØRRE END 5   */  
      /* SÅ SKAL DET STADIG VÆRE SOM OM ANTAL ER STØRRE 5           */  
                                                                        
      /* CTILKØB SÆTTES TIL JA, NÅR DET ER ET PSEUDOSALG, DVS. DET  */  
      /* DER SÆLGES/KØBES KUN EN DEL AF EJENDOMMEN                  */  
      IF BH945.AKT_EJER.CTILKØB = 'J'                                   
      THEN                                                              
         CALL BEREGN_DAGE_EJET_TILKØB;                                  
      ELSE                                                              
         CALL BEREGN_DAGE_EJET;                                         
                                                                        
      CALL OPSÆT_DERHVPER;                                              
                                                                        
      IF BH945.EJERSKAB.FERHVPER_ANT = 0                                
      THEN                                                              
         DO;                                                            
           BH945.TIL_EVS.CEJBEVS        = '7';                          
           BH945.EJERSKAB.CNEDTAG158    = ' ';                          
           BH945.EJERSKAB.FERHVPER_DAGE = 0;                            
           RETURN;                                                      
         END;                                                           
                                                                        
      CALL BEHANDL_DERHVPER;                                            
                                                                        
      BH945.TIL_EVS.FUDL100 = HJDAGE_EJET - HJPER_DAGE;                 
                                                                        
      BH945.EJERSKAB.FERHVPER_DAGE = HJPER_DAGE;                        
                                                                        
      IF BH945.TIL_EVS.FUDL100 < 0                                      
      THEN                                                              
         BH945.TIL_EVS.FUDL100 = 0;                                     
                                                                        
 END NEDTAG_CEJBEVS7;                                                   
                                                                        
 /*********************************************************************/
 /*                                               SLUT10              */
 /*     FOR IKKE AT PILLE I KODEN FRA SIDSTE ÅR FLYTTES PERIODERNE    */
 /*     BLOT FRA MT-STRUKTUREN, SOM IKKE ÆNDRES                       */
 /*                                                                   */
 /*********************************************************************/
 FLYT_PER_FRA_MT_TIL_EJERSKAB:                                          
 PROC;                                                                  
                                                                        
      BH945.EJERSKAB.DERHVPER_FRA1 = BH945.MT.PER.DERHVPER_FRA1;        
      BH945.EJERSKAB.DERHVPER_TIL1 = BH945.MT.PER.DERHVPER_TIL1;        
      BH945.EJERSKAB.DERHVPER_FRA2 = BH945.MT.PER.DERHVPER_FRA2;        
      BH945.EJERSKAB.DERHVPER_TIL2 = BH945.MT.PER.DERHVPER_TIL2;        
      BH945.EJERSKAB.DERHVPER_FRA3 = BH945.MT.PER.DERHVPER_FRA3;        
      BH945.EJERSKAB.DERHVPER_TIL3 = BH945.MT.PER.DERHVPER_TIL3;        
      BH945.EJERSKAB.DERHVPER_FRA4 = BH945.MT.PER.DERHVPER_FRA4;        
      BH945.EJERSKAB.DERHVPER_TIL4 = BH945.MT.PER.DERHVPER_TIL4;        
      BH945.EJERSKAB.DERHVPER_FRA5 = BH945.MT.PER.DERHVPER_FRA5;        
      BH945.EJERSKAB.DERHVPER_TIL5 = BH945.MT.PER.DERHVPER_TIL5;        
                                                                        
 END FLYT_PER_FRA_MT_TIL_EJERSKAB;                                      
                                                                        
 /*********************************************************************/
 /*                                               SLUT09 KS.#18-03    */
 /*     OPSÆT BEBOEDE PERIODER SOM PASSER MED DAGE EJET PERIODE       */
 /*                                                                   */
 /*********************************************************************/
 OPSÆT_DERHVPER:                                                        
 PROC;                                                                  
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA1 ^= '')                           
      THEN                                                              
         CALL OPSÆT_AF_PERIODE(BH945.EJERSKAB.DERHVPER_FRA1,            
                               BH945.EJERSKAB.DERHVPER_TIL1);           
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA2 ^= '')                           
      THEN                                                              
         CALL OPSÆT_AF_PERIODE(BH945.EJERSKAB.DERHVPER_FRA2,            
                               BH945.EJERSKAB.DERHVPER_TIL2);           
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA3 ^= '')                           
      THEN                                                              
         CALL OPSÆT_AF_PERIODE(BH945.EJERSKAB.DERHVPER_FRA3,            
                               BH945.EJERSKAB.DERHVPER_TIL3);           
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA4 ^= '')                           
      THEN                                                              
         CALL OPSÆT_AF_PERIODE(BH945.EJERSKAB.DERHVPER_FRA4,            
                               BH945.EJERSKAB.DERHVPER_TIL4);           
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA5 ^= '')                           
      THEN                                                              
         CALL OPSÆT_AF_PERIODE(BH945.EJERSKAB.DERHVPER_FRA5,            
                               BH945.EJERSKAB.DERHVPER_TIL5);           
                                                                        
      BH945.EJERSKAB.FERHVPER_ANT = HJPER_ANT;                          
                                                                        
 END OPSÆT_DERHVPER;                                                    
                                                                        
 /*********************************************************************/
 /*      OPSÆTNING AF PERIODE                     SLUT09 KS.#18-03    */
 /*********************************************************************/
 OPSÆT_AF_PERIODE:                                                      
 PROC(HJ_PER_FRA,HJ_PER_TIL);                                           
                                                                        
 DCL     HJ_PER_FRA      CHAR  (10);                                    
 DCL     HJ_PER_TIL      CHAR  (10);                                    
                                                                        
 DCL     PER_FRA         PIC       '(8)9';                              
 DCL     1 FRA           BASED(ADDR(PER_FRA)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     PER_TIL         PIC       '(8)9';                              
 DCL     1 TIL           BASED(ADDR(PER_TIL)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
         FRA.ÅR   = SUBSTR(HJ_PER_FRA,1,4);                             
         FRA.MD   = SUBSTR(HJ_PER_FRA,6,2);                             
         FRA.DG   = SUBSTR(HJ_PER_FRA,9,2);                             
                                                                        
         TIL.ÅR   = SUBSTR(HJ_PER_TIL,1,4);                             
         TIL.MD   = SUBSTR(HJ_PER_TIL,6,2);                             
         TIL.DG   = SUBSTR(HJ_PER_TIL,9,2);                             
                                                                        
         IF PER_FRA >= HJ_EJET_TIL                                      
         THEN                                                           
            DO;                                                         
              HJ_PER_FRA = ' ';                                         
              HJ_PER_TIL = ' ';                                         
              RETURN;                                                   
            END;                                                        
                                                                        
         IF PER_TIL < HJ_EJET_FRA                                       
         THEN                                                           
            DO;                                                         
              HJ_PER_FRA = ' ';                                         
              HJ_PER_TIL = ' ';                                         
              RETURN;                                                   
            END;                                                        
                                                                        
         IF PER_FRA < HJ_EJET_FRA                                       
         THEN                                                           
            DO;                                                         
              PER_FRA = HJ_EJET_FRA;                                    
              SUBSTR(HJ_PER_FRA,1,4) = FRA.ÅR;                          
              SUBSTR(HJ_PER_FRA,6,2) = FRA.MD;                          
              SUBSTR(HJ_PER_FRA,9,2) = FRA.DG;                          
            END;                                                        
                                                                        
         IF PER_TIL > HJ_EJET_TIL                                       
         THEN                                                           
            DO;                                                         
              PER_TIL = HJ_EJET_TIL;                                    
              SUBSTR(HJ_PER_TIL,1,4) = TIL.ÅR;                          
              SUBSTR(HJ_PER_TIL,6,2) = TIL.MD;                          
              SUBSTR(HJ_PER_TIL,9,2) = TIL.DG;                          
            END;                                                        
                                                                        
         HJPER_ANT = HJPER_ANT + 1;                                     
                                                                        
 END OPSÆT_AF_PERIODE;                                                  
                                                                        
 /*********************************************************************/
 /*                                               SLUT09 KS.#18-03    */
 /*     VED BEREGNING AF ANTAL DAGE FOR BEBOEDE PERIODER SKAL DER     */
 /*     SKAL DISSE LIGGE INDEN FOR DEN FORSKUDTE REGNSKABSPERIODE     */
 /*                                                                   */
 /*********************************************************************/
 BEHANDL_DERHVPER:                                                      
 PROC;                                                                  
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA1 ^= '')                           
      THEN                                                              
         CALL BEREGN_DAGE_BEBOET(BH945.EJERSKAB.DERHVPER_FRA1,          
                                 BH945.EJERSKAB.DERHVPER_TIL1);         
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA2 ^= '')                           
      THEN                                                              
         CALL BEREGN_DAGE_BEBOET(BH945.EJERSKAB.DERHVPER_FRA2,          
                                 BH945.EJERSKAB.DERHVPER_TIL2);         
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA3 ^= '')                           
      THEN                                                              
         CALL BEREGN_DAGE_BEBOET(BH945.EJERSKAB.DERHVPER_FRA3,          
                                 BH945.EJERSKAB.DERHVPER_TIL3);         
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA4 ^= '')                           
      THEN                                                              
         CALL BEREGN_DAGE_BEBOET(BH945.EJERSKAB.DERHVPER_FRA4,          
                                 BH945.EJERSKAB.DERHVPER_TIL4);         
                                                                        
      IF (BH945.EJERSKAB.DERHVPER_FRA5 ^= '')                           
      THEN                                                              
         CALL BEREGN_DAGE_BEBOET(BH945.EJERSKAB.DERHVPER_FRA5,          
                                 BH945.EJERSKAB.DERHVPER_TIL5);         
                                                                        
      IF HJPER_DAGE > HJDAGE_EJET                                       
      THEN                                                              
         HJPER_DAGE = HJDAGE_EJET;                                      
                                                                        
      IF HJPER_DAGE < 0                                                 
      THEN                                                              
         HJPER_DAGE = 0;                                                
                                                                        
 END BEHANDL_DERHVPER;                                                  
                                                                        
 /*********************************************************************/
 /*      BEREGN ANTAL DAGE BEBOET I INDKOMSTÅRET     SLUT09 KS.#18-03 */
 /*      MÅNEDER BEREGNES SOM VÆRENDE PÅ 30 DAGE                      */
 /*      D.V.S. ET  H E L T  ÅR ER PÅ 360 DAGE                        */
 /*********************************************************************/
 BEREGN_DAGE_BEBOET:                                                    
 PROC(HJ_PER_FRA,HJ_PER_TIL);                                           
                                                                        
 DCL     HJ_PER_FRA      CHAR  (10);                                    
 DCL     HJ_PER_TIL      CHAR  (10);                                    
                                                                        
 DCL     PER_FRA         PIC       '(8)9';                              
 DCL     1 FRA           BASED(ADDR(PER_FRA)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     PER_TIL         PIC       '(8)9';                              
 DCL     1 TIL           BASED(ADDR(PER_TIL)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     ANT_DAGE        FIXED     (9);                                 
                                                                        
         ANT_DAGE    = 0;                                               
                                                                        
         FRA.ÅR   = SUBSTR(HJ_PER_FRA,1,4);                             
         FRA.MD   = SUBSTR(HJ_PER_FRA,6,2);                             
         FRA.DG   = SUBSTR(HJ_PER_FRA,9,2);                             
                                                                        
         TIL.ÅR   = SUBSTR(HJ_PER_TIL,1,4);                             
         TIL.MD   = SUBSTR(HJ_PER_TIL,6,2);                             
         TIL.DG   = SUBSTR(HJ_PER_TIL,9,2);                             
                                                                        
         IF PER_FRA = BH945.MT.DRGNÅRFRA                                
         THEN                                                           
            HJDAGE_PLUS = 1;                                            
         ELSE                                                           
            HJDAGE_PLUS = 0;                                            
                                                                        
         IF FRA.MD = 02                                                 
          & FRA.DG = 28                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF FRA.DG = 28                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF FRA.DG > 30                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF TIL.MD = 02                                                 
          & TIL.DG = 28                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF TIL.DG > 30                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF BH945.MT.CFRÅR = '02'                                       
          ! BH945.MT.CFRÅR > '02'                                       
         THEN                                                           
            ANT_DAGE = (((TIL.ÅR - FRA.ÅR) * 360) +                     
                         ((TIL.MD -1) * 30) + TIL.DG) -                 
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
         ELSE                                                           
            ANT_DAGE = (((TIL.MD -1) * 30) + TIL.DG) -                  
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
                                                                        
         IF ANT_DAGE < 0                                                
         THEN                                                           
            ANT_DAGE = 0;                                               
                                                                        
         HJPER_DAGE = HJPER_DAGE + ANT_DAGE;                            
                                                                        
 END BEREGN_DAGE_BEBOET;                                                
                                                                        
 /*********************************************************************/
 /*                                               SLUT09 KS.#18-03    */
 /*     DER TESTES KUN PÅ HANDELSDATOERNE                             */
 /*********************************************************************/
 BEREGN_DAGE_EJET_TILKØB:                                               
 PROC;                                                                  
                                                                        
 DCL     FRADATO         PIC       '(8)9'    STATIC;                    
 DCL     1 FRA           BASED(ADDR(FRADATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     TILDATO         PIC       '(8)9'    STATIC;                    
 DCL     1 TIL           BASED(ADDR(TILDATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
         IF BH945.AKT_EJER.DOVTG > 0                                    
         THEN                                                           
            HJ_EJET_FRA = BH945.AKT_EJER.DOVTG;                         
                                                                        
         IF BH945.AKT_EJER.DAFSTÅ > 0                                   
         THEN                                                           
            HJ_EJET_TIL = BH945.AKT_EJER.DAFSTÅ;                        
                                                                        
         IF HJ_EJET_FRA < BH945.MT.DRGNÅRFRA                            
         THEN                                                           
            HJDAGE_PLUS = 1;                                            
         ELSE                                                           
            HJDAGE_PLUS = 0;                                            
                                                                        
         IF HJ_EJET_FRA < BH945.MT.DRGNÅRFRA                            
         THEN                                                           
            HJ_EJET_FRA = BH945.MT.DRGNÅRFRA;                           
                                                                        
         IF HJ_EJET_TIL > BH945.MT.DRGNÅRTIL                            
          ! HJ_EJET_TIL = 0                                             
         THEN                                                           
            HJ_EJET_TIL = BH945.MT.DRGNÅRTIL;                           
                                                                        
         FRADATO = HJ_EJET_FRA;                                         
         TILDATO = HJ_EJET_TIL;                                         
                                                                        
         IF FRA.MD = 02                                                 
          & FRA.DG = 28                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF FRA.DG > 30                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF TIL.MD = 02                                                 
          & TIL.DG = 28                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF TIL.DG > 30                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF BH945.MT.CFRÅR = '02'                                       
          ! BH945.MT.CFRÅR > '02'                                       
         THEN                                                           
            HJDAGE_EJET = (((TIL.ÅR - FRA.ÅR) * 360) +                  
                           ((TIL.MD -1) * 30) + TIL.DG) -               
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
         ELSE                                                           
            HJDAGE_EJET = (((TIL.MD -1) * 30) + TIL.DG) -               
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
                                                                        
         IF HJDAGE_EJET < 0                                             
         THEN                                                           
            HJDAGE_EJET = 0;       /* KØB OG SALG SAMME DATO */         
                                                                        
 END BEREGN_DAGE_EJET_TILKØB;                                           
                                                                        
 /*********************************************************************/
 /*                                               SLUT09 KS.#18-03    */
 /*     DER TESTES BÅDE PÅ HANDELS- OG FLYTTEDATOER                   */
 /*********************************************************************/
 BEREGN_DAGE_EJET:                                                      
 PROC;                                                                  
                                                                        
 DCL     FRADATO         PIC       '(8)9'    STATIC;                    
 DCL     1 FRA           BASED(ADDR(FRADATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     TILDATO         PIC       '(8)9'    STATIC;                    
 DCL     1 TIL           BASED(ADDR(TILDATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
         IF BH945.AKT_EJER.DOVTG > 0                                    
         THEN                                                           
            DO;                                                         
               IF BH945.TIL_EVS.DINDFLYT > 0           /* FELT 766 */   
               THEN                                                     
                  HJ_EJET_FRA = BH945.TIL_EVS.DINDFLYT;                 
               ELSE                                                     
                  HJ_EJET_FRA = BH945.AKT_EJER.DOVTG;                   
            END;                                                        
                                                                        
         IF BH945.AKT_EJER.DAFSTÅ > 0                                   
         THEN                                                           
            DO;                                                         
               IF BH945.TIL_EVS.DFRAFLYT > 0           /* FELT 767 */   
               THEN                                                     
                  HJ_EJET_TIL = BH945.TIL_EVS.DFRAFLYT;                 
               ELSE                                                     
                  HJ_EJET_TIL = BH945.AKT_EJER.DAFSTÅ;                  
            END;                                                        
                                                                        
         IF HJ_EJET_FRA < BH945.MT.DRGNÅRFRA                            
         THEN                                                           
            HJDAGE_PLUS = 1;                                            
         ELSE                                                           
            HJDAGE_PLUS = 0;                                            
                                                                        
         IF HJ_EJET_FRA < BH945.MT.DRGNÅRFRA                            
         THEN                                                           
            HJ_EJET_FRA = BH945.MT.DRGNÅRFRA;                           
                                                                        
         IF HJ_EJET_TIL > BH945.MT.DRGNÅRTIL                            
          ! HJ_EJET_TIL = 0                                             
         THEN                                                           
            HJ_EJET_TIL = BH945.MT.DRGNÅRTIL;                           
                                                                        
         FRADATO = HJ_EJET_FRA;                                         
         TILDATO = HJ_EJET_TIL;                                         
                                                                        
         IF FRA.MD = 02                                                 
          & FRA.DG = 28                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF FRA.DG > 30                                                 
         THEN                                                           
            FRA.DG = 30;                                                
                                                                        
         IF TIL.MD = 02                                                 
          & TIL.DG = 28                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF TIL.DG > 30                                                 
         THEN                                                           
            TIL.DG = 30;                                                
                                                                        
         IF BH945.MT.CFRÅR = '02'                                       
          ! BH945.MT.CFRÅR > '02'                                       
         THEN                                                           
            HJDAGE_EJET = (((TIL.ÅR - FRA.ÅR) * 360) +                  
                           ((TIL.MD -1) * 30) + TIL.DG) -               
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
         ELSE                                                           
            HJDAGE_EJET = (((TIL.MD -1) * 30) + TIL.DG) -               
                          (((FRA.MD -1) * 30) + FRA.DG) +               
                            HJDAGE_PLUS;                                
                                                                        
         IF HJDAGE_EJET < 0                                             
         THEN                                                           
            HJDAGE_EJET = 0;       /* KØB OG SALG SAMME DATO */         
                                                                        
 END BEREGN_DAGE_EJET;                                                  
                                                                        
 /*********************************************************************/
 /* OPTÆL  CEJBEVS, FELT158=7                SLUT09 KS.18.03          */
 /* HVIS CEJBEVS 1,2 ELLER 3 NULSTILLES ALLE OPSATTE FELTER           */
 /*********************************************************************/
 OPTÆL_CNEDTAG158:                                                      
 PROC;                                                                  
                                                                        
     IF BH945.TIL_EVS.CEJBEVS  = '0'                                    
     THEN                                                               
        TV.F158_TIL_0 = TV.F158_TIL_0 + 1;                              
     ELSE                                                               
        DO;                                                             
           TV.F158_1TIL3 = TV.F158_1TIL3 + 1;                           
           BH945.EJERSKAB.DERHVPER_FRA1 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL1 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA2 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL2 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA3 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL3 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA4 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL4 = '';                           
           BH945.EJERSKAB.DERHVPER_FRA5 = '';                           
           BH945.EJERSKAB.DERHVPER_TIL5 = '';                           
           BH945.EJERSKAB.FERHVPER_DAGE = 0;                            
           BH945.EJERSKAB.FERHVPER_ANT  = 0;                            
           BH945.TIL_EVS.FUDL100        = 0;                            
           BH945.TIL_EVS.FERHVFLER      = 0; /* FOR F158 ER IKKE 7 */   
           BH945.EJERSKAB.CNEDTAG158    = '';                           
        END;                                                            
                                                                        
 END OPTÆL_CNEDTAG158;                                                  
                                                                        
 /*********************************************************************/
 /*      OPSÆT KODE FOR KØBT OG/ELLER SOLGT                           */
 /*      SAMT EVENTUELT IND- OG/ELLER FRAFLYTTET I INDKOMSTÅRET       */
 /*********************************************************************/
 OPSÆT_CKØBSALG:                                                        
 PROC;                                                                  
                                                                        
         SELECT;                                                        
                                                                        
           WHEN ((BH945.AKT_EJER.DOVTG >= BH945.MT.DRGNÅRFRA &          
                  BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRTIL) &          
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.AKT_EJER.DINDFLYT = 0)                          
             BH945.TIL_EVS.CKØBSALG = '1';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DOVTG >= BH945.MT.DRGNÅRFRA &          
                  BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRTIL) &          
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.AKT_EJER.DINDFLYT > BH945.MT.DRGNÅRTIL)         
             BH945.TIL_EVS.CKØBSALG = '1';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &         
                  BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &        
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.AKT_EJER.DFRAFLYT = 0)                          
             BH945.TIL_EVS.CKØBSALG = '1';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &         
                  BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &        
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.AKT_EJER.DFRAFLYT > BH945.MT.DRGNÅRTIL)         
             BH945.TIL_EVS.CKØBSALG = '1';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DOVTG >= BH945.MT.DRGNÅRFRA &          
                  BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRTIL) &          
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                  BH945.TIL_EVS.DINDFLYT > 0)                           
             BH945.TIL_EVS.CKØBSALG = '2';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &         
                  BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &        
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                  BH945.TIL_EVS.DFRAFLYT > 0)                           
             BH945.TIL_EVS.CKØBSALG = '2';                              
                                                                        
           WHEN ( BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRFRA &           
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.EVS_SLUT_EJER.DCPRN > 0 &                       
                  BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1' &              
                  BH945.EVS_SLUT_EJER.SIDSTE.CINDFLYT = '1' &           
                  BH945.TIL_EVS.DINDFLYT > 0)                           
             BH945.TIL_EVS.CKØBSALG = '2';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DOVTG >= BH945.MT.DRGNÅRFRA &          
                  BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRTIL) &          
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.AKT_EJER.DINDFLYT > 0)                          
             BH945.TIL_EVS.CKØBSALG = '2';                              
                                                                        
           WHEN ( BH945.AKT_EJER.DOVTG < BH945.MT.DRGNÅRFRA &           
                 (BH945.EJERSKAB.CEJDTYPE_AKT ^= '3' &                  
                  BH945.EJERSKAB.CEJDTYPE_AKT ^= '8') &                 
                  BH945.EVS_SLUT_EJER.DCPRN > 0 &                       
                  BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1' &              
                  BH945.EVS_SLUT_EJER.SIDSTE.CINDFLYT = '1' &           
                  BH945.TIL_EVS.DINDFLYT = 0)                           
             BH945.TIL_EVS.CKØBSALG = '3';                              
                                                                        
           WHEN ((BH945.AKT_EJER.DAFSTÅ >= BH945.MT.DRGNÅRFRA &         
                  BH945.AKT_EJER.DAFSTÅ <= BH945.MT.DRGNÅRTIL) &        
                  BH945.AKT_EJER.CTILKØB ^= 'J' &                       
                  BH945.EVS_SLUT_EJER.DCPRN > 0 &                       
                  BH945.EVS_SLUT_EJER.SIDSTE.CSLET < '1' &              
                  BH945.EVS_SLUT_EJER.SIDSTE.CEJBEVS < '9' &            
                 (BH945.EVS_SLUT_EJER.SIDSTE.DFRAFLYT > 0 &             
                  BH945.AKT_EJER.DOVTG <                                
                  BH945.EVS_SLUT_EJER.SIDSTE.DFRAFLYT))                 
              DO;                                                       
                 BH945.TIL_EVS.CKØBSALG = '4';                          
                 BH945.TIL_EVS.CEJBEVS  = '9'; /* KS #18-01-01 2003 */  
              END;                                                      
                                                                        
           OTHERWISE;                                                   
                                                                        
         END; /* SELECT */                                              
                                                                        
 END OPSÆT_CKØBSALG;                                                    
 /*********************************************************************/
 /*      OPSÆT CELØNCOR FOR FØRTIDSPENSIONISTER OG EFTERLØNNERE.      */
 /*                                                                   */
 /*      OPSÆT KODE FOR 4 PROMILLE NEDSLAG - 67 ÅRIGE M.V.            */
 /*      I FORBINDELSE MED BEREGNING AF EVS TIL SLUT.                 */
 /*********************************************************************/
 OPSÆT_PENSNED_KODE:                                                    
 PROC;                                                                  
                                                                        
         IF BH945.TIL_EVS.CPTYPSLUT = '2'                               
         THEN                                                           
            DO;                                                         
               SELECT;                                                  
                 WHEN (BH945.TIL_EVS.CENKE = '4')                       
                   BH945.CELØNCOR = '2';                                
                 WHEN (BH945.MT.CFØREFT(INDEXÅR) = 1 !                  
                       BH945.MT.CFØREFT(INDEXÅR) = 3)                   
                   BH945.CELØNCOR = '2';                                
                 OTHERWISE                                              
                   BH945.CELØNCOR = '1';                                
               END;                                                     
            END;                                                        
                                                                        
                                                                        
         IF (BH945.TIL_EVS.CPTYPSLUT = '3' !   /* #02 */                
             BH945.TIL_EVS.CPTYPSLUT = '4') &                           
            BH945.EJERSKAB.CEJDTYPE_AKT >= '1'                          
         THEN                                                           
            DO;                                                         
               IF BH945.EJERSKAB.CEJDTYPE_AKT = '3' !                   
                  BH945.EJERSKAB.CEJDTYPE_AKT = '8'                     
               THEN                                                     
                  BH945.TIL_EVS.FELT759 = '2';                          
               ELSE                                                     
                  BH945.TIL_EVS.FELT759 = '1';                          
            END;                                                        
                                                                        
         /*Ny i slut 2016 for at felt 759 skal følge */                 
         /*den rettelse af CEJDTYPE som kan ske i BH96131M */           
         IF BH945.TIL_EVS.FELT759 = ' ' &                               
           (BH945.TIL_EVS.CPTYPSLUT = '3' !                             
            BH945.TIL_EVS.CPTYPSLUT = '4') &                            
            BH945.EJENDOM.CEJDTYPE  > '0' &                             
            BH945.SORT_KOMNR = 999                                      
         THEN                                                           
            DO;                                                         
               IF BH945.EJENDOM.CEJDTYPE = '3' !                        
                  BH945.EJENDOM.CEJDTYPE = '8'                          
               THEN                                                     
                  BH945.TIL_EVS.FELT759 = '2';                          
               ELSE                                                     
                  BH945.TIL_EVS.FELT759 = '1';                          
            END;                                                        
                                                                        
 END OPSÆT_PENSNED_KODE;                                                
 /*********************************************************************/
 /*      OPSÆT DIVERSE OPLYSNINGER VEDR. KØB ELLER SALG NÅR           */
 /*      REGNSKABSÅRET SKAL VÆRE LIG AKTUELT INDKOMSTÅR.              */
 /*                                                                   */
 /*      BRUGES VED BEREGNING AF PERIODE VEDR. FORDELING AF           */
 /*      EJENDOMSSKATTER I PRIVAT OG ERHVERVSMÆSSIG ANDEL.            */
 /*********************************************************************/
 OPSÆT_KØB_SALG:                                                        
 PROC(HJ_FRADAG,HJ_TILDAG);                                             
                                                                        
 DCL     HJ_FRADAG       FIXED     (9);                                 
 DCL     HJ_TILDAG       FIXED     (9);                                 
                                                                        
 DCL     FRADATO         PIC       '(8)9'    STATIC;                    
 DCL     1 FRA           BASED(ADDR(FRADATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     TILDATO         PIC       '(8)9'    STATIC;                    
 DCL     1 TIL           BASED(ADDR(TILDATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
         /* UNDERSØG OM EJEREN HAR HANDLET I INDKOMSTÅRET */            
                                                                        
         KØBT_I_ÅR  = NEJ;                                              
         SOLGT_I_ÅR = NEJ;                                              
                                                                        
         IF HJ_FRADAG > ÅR0101 &                                        
            HJ_FRADAG <= ÅR1231                                         
         THEN                                                           
            KØBT_I_ÅR = JA;                                             
                                                                        
         IF HJ_TILDAG > ÅR0101 &                                        
            HJ_TILDAG <= ÅR1231                                         
         THEN                                                           
            SOLGT_I_ÅR = JA;                                            
                                                                        
         IF HJ_FRADAG < ÅR0101                                          
         THEN                                                           
            HJ_FRADAG = ÅR0101;                                         
                                                                        
         IF HJ_TILDAG > ÅR1231 !                                        
            HJ_TILDAG = 0                                               
         THEN                                                           
            HJ_TILDAG = ÅR1231;                                         
                                                                        
         FRADATO = HJ_FRADAG;                                           
         TILDATO = HJ_TILDAG;                                           
                                                                        
         IF (KØBT_I_ÅR  = NEJ &      /* PERSONEN HAR EJET EJENDOMMEN */ 
             SOLGT_I_ÅR = NEJ)       /*  H E L E  DETTE INDKOMSTÅR   */ 
         THEN                                                           
           DO;                       /* INGEN PERIODEBEREGNING       */ 
             TÆLLER = 360;                                              
             NÆVNER = 360;                                              
           END;                                                         
         ELSE                                                           
            DO;                                                         
               /* BEREGN BRØK TIL PERIODEBEREGNING. ALLE  H E L E  */   
               /* MÅNEDER BEREGNES SOM VÆRENDE PÅ 30 DAGE          */   
               /* D.V.S. ET  H E L T  ÅR ER PÅ 360 DAGE            */   
               NÆVNER = 360;                                            
  /* #01 */    TÆLLER = (((TIL.ÅR - FRA.ÅR) * 360)    +                 
                        (((TIL.MD - 1) * 30) + TIL.DG)) -               
                        (((FRA.MD - 1) * 30) + FRA.DG);                 
               IF TÆLLER = 0                                            
               THEN                                                     
                  TÆLLER = 1; /* KØB OG SALG SAMME DATO */              
            END;                                                        
                                                                        
 END OPSÆT_KØB_SALG;                                                    
                                                                        
 /*********************************************************************/
 /*      OPSÆT 'GUNSTIGSTE' EJERPERIODE I FORSKUDSÅRET OG             */
 /*      BEREGN 'ENDELIG FORSKUDSSKAT' FOR DØDE                       */
 /*********************************************************************/
 PERIODISER_DØDE:                                                       
 PROC;                                                                  
                                                                        
 DCL     HJ_TÆLLER   FIXED (5);                                         
 DCL     HJ_NÆVNER   FIXED (5);                                         
                                                                        
 DCL     HJ_FRADAG       FIXED     (9);                                 
 DCL     HJ_TILDAG       FIXED     (9);                                 
                                                                        
 DCL     FRADATO         PIC       '(8)9'    STATIC;                    
 DCL     1 FRA           BASED(ADDR(FRADATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
 DCL     TILDATO         PIC       '(8)9'    STATIC;                    
 DCL     1 TIL           BASED(ADDR(TILDATO)),                          
         2 ÅR            PIC       '9999',                              
         2 MD            PIC       '99',                                
         2 DG            PIC       '99';                                
                                                                        
         IF BH945.MT.HIST_OPL(INDEXÅR).DCIÆN >= BH945.MT.DRGNÅRFRA &    
            BH945.MT.HIST_OPL(INDEXÅR).DCIÆN <= BH945.MT.DRGNÅRTIL      
         THEN;                                                          
         ELSE                                                           
            DO;                                                         
               /*  K U N  DØDE I AKTUELT SLUTÅR */                      
               /* (REGNSKABSÅR?????)            */                      
               /* SKAL PERIODISERES.            */                      
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = -1;                          
               BH945.TIL_EVS.CFORSKAT = '2';                            
               RETURN;                                                  
            END;                                                        
                                                                        
         KØBT_I_ÅR  = NEJ;                                              
                                                                        
         HJ_NÆVNER = BH945.EVS_FORSK_EJER.FDAGIALT;                     
                                                                        
         HJ_FRADAG = BH945.MT.DRGNÅRFRA;                                
                                                                        
         IF BH945.AKT_EJER.DOVTG_GL > HJ_FRADAG                         
         THEN                                                           
            HJ_FRADAG = BH945.AKT_EJER.DOVTG_GL;                        
                                                                        
         IF BH945.EVS_FORSK_EJER.DOVTG_GL > HJ_FRADAG                   
         THEN                                                           
            HJ_FRADAG = BH945.EVS_FORSK_EJER.DOVTG_GL;                  
                                                                        
         BH945.DØDFRA = HJ_FRADAG;                                      
                                                                        
         HJ_TILDAG = BH945.MT.DRGNÅRTIL;                                
                                                                        
         IF HJ_TILDAG > BH945.MT.HIST_OPL(INDEXÅR).DCIÆN                
         THEN                                                           
            HJ_TILDAG = BH945.MT.HIST_OPL(INDEXÅR).DCIÆN;               
                                                                        
         IF BH945.AKT_EJER.DAFSTÅ > 0 &                                 
            BH945.AKT_EJER.DAFSTÅ < HJ_TILDAG                           
         THEN                                                           
            HJ_TILDAG = BH945.AKT_EJER.DAFSTÅ;                          
                                                                        
         IF BH945.EVS_FORSK_EJER.DAFSTAA > 0 &                          
            BH945.EVS_FORSK_EJER.DAFSTAA < HJ_TILDAG                    
         THEN                                                           
            HJ_TILDAG = BH945.EVS_FORSK_EJER.DAFSTAA;                   
                                                                        
         BH945.DØDTIL = HJ_TILDAG;                                      
                                                                        
         IF HJ_FRADAG >= BH945.MT.HIST_OPL(INDEXÅR).DCIÆN               
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = 0;                           
               BH945.TIL_EVS.CFORSKAT = ' ';                            
               RETURN;                                                  
            END;                                                        
                                                                        
         IF BH945.EVS_FORSK_EJER.DCPRN = 0 &                            
            BH945.AKT_EJER.DCPRCIR > 0 &                                
            HJ_FRADAG < BH945.MT.HIST_OPL(INDEXÅR).DCIÆN                
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = 0;                           
               BH945.TIL_EVS.CFORSKAT = ' ';                            
               RETURN;                                                  
            END;                                                        
                                                                        
         IF BH945.EVS_FORSK_EJER.CEVSSUM = '2' !                        
            HJ_NÆVNER = 0                                               
         THEN                                                           
            HJ_NÆVNER = 360;                                            
                                                                        
         IF BH945.AKT_EJER.DCPRCIR > 0 &                                
            BH945.AKT_EJER.DOVTG_GL <= BH945.MT.DRGNÅRFRA               
         THEN;                                                          
         ELSE                                                           
            IF HJ_FRADAG > BH945.MT.DRGNÅRFRA                           
            THEN                                                        
               KØBT_I_ÅR = JA;                                          
                                                                        
         FRADATO = HJ_FRADAG;                                           
         TILDATO = HJ_TILDAG;                                           
                                                                        
         IF FRADATO = TILDATO                                           
         THEN                                                           
            HJ_TÆLLER = 1;                                              
         ELSE                                                           
            DO;                                                         
               /* BEREGN BRØK TIL PERIODEBEREGNING. ALLE  H E L E  */   
               /* MÅNEDER BEREGNES SOM VÆRENDE PÅ 30 DAGE          */   
               /* D.V.S. ET  H E L T  ÅR ER PÅ 360 DAGE            */   
   /* #01 */   HJ_TÆLLER = (((TIL.ÅR - FRA.ÅR) * 360)    +              
                           (((TIL.MD - 1) * 30) + TIL.DG)) -            
                           (((FRA.MD - 1) * 30) + FRA.DG);              
               IF HJ_TÆLLER = 0                                         
               THEN                                                     
                  HJ_TÆLLER = 1;                                        
            END;                                                        
                                                                        
         IF HJ_TÆLLER = 1 &                                             
            FRADATO > BH945.MT.DRGNÅRFRA &                              
            KØBT_I_ÅR = JA                                              
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = 0;                           
               BH945.TIL_EVS.CFORSKAT = ' ';                            
               BH945.FDØDDAGE = HJ_TÆLLER;                              
               RETURN;                                                  
            END;                                                        
                                                                        
         IF HJ_TÆLLER > 1 &                                             
            KØBT_I_ÅR = JA                                              
         THEN                                                           
            HJ_TÆLLER = HJ_TÆLLER - 1;                                  
                                                                        
         BH945.FDØDDAGE = HJ_TÆLLER;                                    
                                                                        
         IF BH945.TIL_EVS.BFORSKAT_SW = 0 &                             
            BH945.TIL_EVS.BFORSKAT ^= 0                                 
         THEN                                                           
            DO;                                                         
               IF BH945.EVS_FORSK_EJER.CEVSSUM = '2' !                  
                  BH945.EVS_FORSK_EJER.FDAGIALT = 0                     
               THEN                                                     
                  BH945.TIL_EVS.CFORSKAT = '1';                         
               ELSE                                                     
                  BH945.TIL_EVS.CFORSKAT = ' ';                         
               HJVÆRDI3 = (MULTIPLY((DIVIDE(BH945.TIL_EVS.BFORSKAT,     
               HJ_NÆVNER,13,3)),HJ_TÆLLER,13,3) + 0.005);               
               BH945.TIL_EVS.BFORSKAT = HJVÆRDI3;                       
            END;                                                        
                                                                        
 END PERIODISER_DØDE;                                                   
                                                                        
 /********************************************************************* 
 *       HER SKRIVES PERSONEN                                         * 
 *********************************************************************/ 
 SKRIV_PERSON:                                                          
         PROC;                                                          
                                                                        
         IF GEM_CPR = BH945.SORT_CPR &                                  
            GEM_KOMNR = BH945.SORT_KOMNR &                              
            GEM_EJDNR = BH945.SORT_EJDNR                                
         THEN                                                           
            HJUDSKRNR = HJUDSKRNR + 1;                                  
         ELSE                                                           
            DO;                                                         
               GEM_CPR = BH945.SORT_CPR;                                
               GEM_KOMNR = BH945.SORT_KOMNR;                            
               GEM_EJDNR = BH945.SORT_EJDNR;                            
               HJUDSKRNR = 1;                                           
            END;                                                        
                                                                        
         BH945.UDSKRLBNR = HJUDSKRNR;                                   
                                                                        
         IF BH945.UDSKRLBNR > 1                                         
         THEN                                                           
            DO;                                                         
               BH945.TIL_EVS.BFORSKAT = 0;                              
               BH945.TIL_EVS.BFORSKAT_SW = -1;                          
               BH945.TIL_EVS.CFORSKAT = '2';                            
            END;                                                        
                                                                        
        IF BH945.FEJLNR > 0                                             
        THEN                                                            
           DO;                                                          
              INDEX = BH945.FEJLNR;                                     
              SKR_FEJLNR(INDEX).ANTAL = SKR_FEJLNR(INDEX).ANTAL + 1;    
           END;                                                         
                                                                        
         TV.SKREVET = TV.SKREVET + 1;                                   
                                                                        
 /*#0904 HERFRA */                                                      
 /*#     ØSTRIG(AT), MALAYSIA(MY)  SKAL ALTID HAVE SAT CEKSEMP TIL 2*/  
 /*      F2 ER FRANSKE EJENDOMME KØBT EFTER 28/11-2007              */  
 /*      NÅR CEKSEMP = '2' NEDSÆTTES DEN BEREGNEDE EJENDOMSVÆRDI-   */  
 /*      SKAT MED BELØBET I FELT 910 (BUDLSKC)                      */  
                                                                        
         IF BH945.SORT_KOMNR = 999                                      
         THEN                                                           
            DO;                                                         
               IF BH945.EJENDOM.CLANDEKODE = 'AT'                       
               !  BH945.EJENDOM.CLANDEKODE = 'MY'                       
               !  BH945.EJENDOM.CLANDEKODE = 'F2'                       
               THEN                                                     
                  BH945.TIL_EVS.CEKSEMP    = '2';                       
            END;                                                        
                                                                        
 /*#0904 HERTIL */                                                      
                                                                        
         WRITE FILE (BH960O) FROM (BH945_AR);                           
                                                                        
 END SKRIV_PERSON;                                                      
                                                                        
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
         PROC;                                                          
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.LÆS_BH945;                                  
         DETLIN1.TEKST = 'ANTAL LÆSTE PÅ UDTRÆK             B.H94500D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.OVERLÆS;                                    
         DETLIN1.TEKST = '      HERAF OVERLÆSTE EVSUDTRÆK UDEN ESR-OPL';
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.BK16;                                       
         DETLIN1.TEKST = '      HERAF OVERLÆSTE EVSUDTRÆK BK=16 I ESR'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.ANV_INDFLYT;                                
         DETLIN1.TEKST = 'ANTAL ANVENDTE INDFLYTNINGER               '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.ANV_FRAFLYT;                                
         DETLIN1.TEKST = 'ANTAL ANVENDTE FRAFLYTNINGER               '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.F158_ER_7;                                  
         DETLIN1.TEKST = 'ANTAL 158=7 FRA SIDSTE SLUT                '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.F158_TIL_0;                                 
         DETLIN1.TEKST = 'ANTAL HVOR FELT 158=7 ER ÆNDRET TIL 0     ';  
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.F158_1TIL3;                                 
         DETLIN1.TEKST = 'ANTAL HVOR FELT 158=7 ER ÆNDRET TIL 1/2/3 ';  
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         /*#GEH*/                                                       
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.FELT759_ANT;                                
         DETLIN1.TEKST = 'ANTAL HVOR FELT759 ER ÆNDRET FRA 2 TIL 1  ';  
         CALL ZZ20300 (DETLIN1,'01');                                   
         /*QEB*/                                                        
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.FELT106_ANT4;                               
         DETLIN1.TEKST = 'ANTAL HVOR FELT106 ER OPSAT PÅ PERSONER MED ' 
                       !!'FELT 756 = 4';                                
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.FELT106_ANT4_FEJL;                          
         DETLIN1.TEKST = 'ANTAL HVOR FELT106 ER OPSAT TIL 0' !!         
                         'PÅ PERSONER MED FELT 756 = 4';                
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         IF TV.F158_ANT_FL > 0                                          
         THEN                                                           
          DO;                                                           
           DETLIN1.CCA = ZZWS1;                                         
           DETLIN1.ANTAL = TV.F158_ANT_FL;                              
           DETLIN1.TEKST = 'ANTAL HVOR BEBOEDE PERIODER > 5         ';  
           CALL ZZ20300 (DETLIN1,'01');                                 
         END;                                                           
                                                                        
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.SKREVET;                                    
         DETLIN1.TEKST = 'ANTAL SKREVNE INDIVIDER           B.H96000D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DO INDEX = 4000 TO 6000;                                       
            IF SKR_FEJLNR(INDEX).ANTAL > 0                              
            THEN                                                        
               DO;                                                      
                  DETLIN1.CCA = ZZWS1;                                  
                  HJ_FEJLNR = INDEX;                                    
                  DETLIN1.TEKST =                                       
                  '      HERAF MED FEJLNR. ' !! HJ_FEJLNRC;             
                  DETLIN1.ANTAL = SKR_FEJLNR(INDEX).ANTAL;              
                  CALL ZZ20300 (DETLIN1,'01');                          
               END;                                                     
         END;                                                           
         DETLIN1.CCA = ZZIS1;                                           
         CALL ZZ20300 (DETLIN1,'01');                                   
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.PENS_TR;                                    
         DETLIN1.TEKST = 'ANTAL SKREVNE TRANS TIL ESR       B.H96010D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
  END TOTALLISTE;                                                       
 /********************************************************************* 
 *       SKRIVNING AF OPTÆLLINGSINDIVID                               * 
 *********************************************************************/ 
 SKRIV_OPTÆLLING:                                                       
         PROC;                                                          
                                                                        
         BH96099            = '';                                       
         BH96099.SORT_CPR   = 99999999999;                              
         BH96099.SORT_KOMNR = 999;                                      
         BH96099.SORT_EJDNR = 9999999;                                  
         BH96099.ANT_INDV   = TV.SKREVET;                               
         WRITE FILE (BH960O) FROM (BH96099);                            
                                                                        
 END SKRIV_OPTÆLLING;                                                   
 /********************************************************************* 
 *       MASKINEL AFSTEMNING                                          * 
 *********************************************************************/ 
 MASK_AFSTEMNING:                                                       
         PROC;                                                          
         IF BH94599.SORT_KOMNR ^= 999 &                                 
            EX_PARM ^= 'TEST'                                           
         THEN                                                           
            CALL FEJLLISTE('1');                                        
         IF BH945_ANT_INDV ^= TV.LÆS_BH945 &                            
            EX_PARM ^= 'TEST'                                           
         THEN                                                           
            CALL FEJLLISTE('2');                                        
 END MASK_AFSTEMNING;                                                   
 /*********************************************************************/
 /*      UDSKRIV FEJLLISTE VEDR. KONSTATERET AFSTEMNINGFEJL PÅ ???    */
 /*********************************************************************/
 FEJLLISTE:                                                             
         PROC(FEJL);                                                    
 DCL     FEJL            CHAR      (01);                                
         CALL ZZ20390 ('*OPEN','BH96002Y');                             
         CALL ZZ20300(SIDELIN,'02');                                    
         CALL ZZ20300(OVERLIN1,'02');                                   
         OVERLIN2.CCA = ZZWS3;                                          
         OVERLIN2.TEKST1 = 'FEJLLISTE VEDR. MASKINEL AFSTEMNING';       
         CALL ZZ20300(OVERLIN2,'02');                                   
         IF FEJL = '1'                                                  
         THEN                                                           
            DO;                                                         
               DETLIN1.CCA   = ZZWS3;                                   
               DETLIN1.TEKST  =                                         
               'AFSTEMNINGSINDIVID MANGLER PÅ B.H94500D';               
               DETLIN1.ANTAL = '';                                      
               CALL ZZ20300(DETLIN1,'02');                              
            END;                                                        
         IF FEJL = '2'                                                  
         THEN                                                           
            DO;                                                         
               DETLIN1.CCA   = ZZWS3;                                   
               DETLIN1.TEKST = 'ANTAL LÆSTE INDIVIDER PÅ B.H94500D';    
               DETLIN1.ANTAL = TV.LÆS_BH945;                            
               CALL ZZ20300(DETLIN1,'02');                              
               DETLIN1.TEKST =                                          
               'ANTAL IFØLGE AFSTEMNINGSINDIVID IALT  :';               
               DETLIN1.ANTAL = BH945_ANT_INDV;                          
               CALL ZZ20300(DETLIN1,'02');                              
            END;                                                        
            SWFEJL = '1';                                               
 END FEJLLISTE;                                                         
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 AFSLUT:                                                                
         PROC;                                                          
         CALL TOTALLISTE;                                               
         CALL SKRIV_OPTÆLLING;                                          
         CALL MASK_AFSTEMNING;                                          
         CALL ZZ20300((133)' ','99');                                   
         CLOSE FILE (BH945I),                                           
               FILE (BH960O),                                           
               FILE (BH9601O);                                          
         IF SWFEJL = '1'                                                
         THEN                                                           
            CALL ZS30101(4,'BH96000 ** 251 ' !!                         
                 'MASKINEL KONSTATERET AFSTEMNINGSFEJL',2);             
 END AFSLUT;                                                            
 %INCLUDE BH00003M; /* FIX09_TIL_DB2_DATO  */                           
 %INCLUDE BH96080M; /* BEREGN ERHVERSMÆSSIG ANDEL AF EJD.SKAT */        
 %INCLUDE BH96081M; /* DAN PENSIONISTKODETRANS TIL ESR */               
 END  BH96000;                                                          
