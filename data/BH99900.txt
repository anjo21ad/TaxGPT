 BH99900: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS SLUT 2002                                          *
 * PROGRAMNAVN: BH99900.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    PROGRAMMET PÅFØRER ALLE DE EJENDOMME PÅ ET DATASÆT FRA *
 *              ESR PERSONNUMMER OG FEJLNUMMER                         *
 *                                                                     *
 * INDDATA:     BH99900T - DATA FRA ESR                                *
 *              BQ30000T - EVS EJENDOMSTABEL.                          *
 *              BQ31000T - EVS EJENDOMSFELTTABEL.                      *
 * UDDATA:      BH99900O - BH99900N UDTRÆK TIL ESR                     *
 *              BH99989Y - KONTROLLISTE.                               *
 * KONSTRUKTØR: HANS ERIK KJELDSEN    HKS, PUS/T&S BALLERUP 07.04.2003 *
 **********************************************************************/
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KMD A/S 2003');            
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE BQ30000T;     /* EVS EJERSKABSTABELLEN 2002 */
         EXEC SQL INCLUDE BQ31000T;     /* EVS EJERSKABSFELTTAB  2002 */
         EXEC SQL INCLUDE SQLCA;        /* SQL KOMMUNIKATIONSAREAL   */ 
                                                                        
 /**********************************************************************
 * DECLARE AF ABEND RUTINE                                             *
 **********************************************************************/
                                                                        
 DCL     ZS30101        ENTRY;                                          
 DCL     ZS67000        ENTRY;                                          
 DCL     ZS61900        ENTRY;                        /* KST/SSI INFO */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
                                                                        
 DCL     EOF_BH9990I    BIT(1)           INIT('0'B);                    
 DCL     HJ_DCPRN_PIC   PIC  '(10)9';                                   
 DCL     HJ_EKOMNR_PIC  PIC  '999';                                     
 DCL     HJ_EEJDNR_PIC  PIC  '(7)9';                                    
 DCL     HJ_EKOMNR_BIN  BIN FIXED (15);                                 
 DCL     HJ_EEJDNR_BIN  BIN FIXED (31);                                 
 DCL     EKOMEEJD_NR    CHAR (09);                                      
 DCL     OK             CHAR (01)        INIT('J');                     
 DCL     FEJLTEKST      CHAR (20)        INIT(' ');                     
 DCL     ABENDMEDD      CHAR (56)        INIT(' ');                     
 DCL     FLAG           CHAR (6)         INIT('FØRSTE');                
 DCL     FLAG_EN_RÆKKE  BIT(1)           INIT('0'B);                    
 DCL     FETCH_SQLKODE  FIXED BIN(15)    INIT(0);                       
 DCL     DT             CHAR (6);                                       
 DCL     1 DAT          BASED(ADDR(DT)),                                
         2 ÅR           PIC   '99',                                     
         2 MD           PIC   '99',                                     
         2 DAG          PIC   '99';                                     
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     SYSPRINT FILE STREAM PRINT;                                    
 DCL     BH9990I FILE INPUT  RECORD; /* INDPUT RECORD FRA ESR         */
 DCL     BH9990O FILE OUTPUT RECORD; /* OUTPUT RECORD TIL ESR         */
 /*********************************************************************/
 /* DECLARE STRUKTURER                                                */
 /*********************************************************************/
                                                                        
 DCL     1 UDTRÆK_ESR,                                                  
         %INCLUDE BH99900N;                                             
                                                                        
 DCL     1 UDTRÆK_CSC,                                                  
         %INCLUDE BH99901N;                                             
                                                                        
 DCL     1 EVS_ESK,                     /* EVS EJERSKABSTABEL         */
         %INCLUDE BQ30000N;;                                            
 DCL     1 EVS_ESK_FELT,                /* EVS EJERSKABSFELTTABEL     */
         %INCLUDE BQ31000N;;                                            
 DCL     1 PERSONTAB,                  /* EVS EJERSKABSSTRUKTUR       */
         %INCLUDE BQ02200N;;                                            
 DCL     1 INDK_EJERSK,                 /* INDIKATOR EJERSKANSOPLYSN. */
         %INCLUDE BQ02006N;;                                            
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     (ADDR,DATE,VERIFY,NULL,MOD,SUBSTR,PLIDUMP) BUILTIN;            
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL   ANTAL_LÆS         BIN FIXED (31) INIT(0);/* LÆSTE INPUT        */
 DCL   ANTAL_SKRIV       BIN FIXED (31) INIT(0);/* SKREVET UDTRÆKSFIL */
 DCL   ANTAL_OVERSP      BIN FIXED (31) INIT(0);/* IKKE SKREVET       */
 /*********************************************************************/
 /* PRINTLINIER TIL SPOOL                                             */
 /*********************************************************************/
                                                                        
 DCL     LINIE           CHAR (133);                                    
 DCL     1 LIN           BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 FIL1        CHAR (21),                                     
           2 TEKST       CHAR (56),                                     
           2 ANT         PIC  '---------9',                             
           2 FIL2        CHAR (45);                                     
         %INCLUDE ZZ20301M;                                             
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SBHO','MODUL BH99900');                 
            END;                                                        
                                                                        
         ON ENDFILE (BH9990I)                                           
            EOF_BH9990I = ('1'B);                                       
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
         UDTRÆK_ESR        = '';                                        
         DT = DATE;                                                     
                                                                        
                                                                        
                                                                        
         OPEN FILE (BH9990I) TITLE ('BH99900I');                        
         OPEN FILE (BH9990O) TITLE ('BH99900O');                        
                                                                        
         CALL ZZ20390('*OPEN','BH99989Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         LINIE = ZZWS3 !! ' KONTROL- & AFSTEMNINGSTOTAL FOR'            
                       !! ' UDTRÆK FRA ESR FEJL 5058    ' !! 'DATO: '   
                       !!   DAT.DAG !! '.' !! DAT.MD !! '.' !! DAT.ÅR;  
                                                                        
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LINIE = ZZWS3 !! ' PROGRAMID: BH99900 ';                       
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         CALL ZS61900;                              /* KST/SSI INFO   */
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
         READ FILE(BH9990I) INTO (UDTRÆK_ESR);                          
         HJ_EKOMNR_PIC = UDTRÆK_ESR.EKOMNR;                             
         HJ_EEJDNR_PIC = UDTRÆK_ESR.EEJDNR;                             
         HJ_EKOMNR_BIN = HJ_EKOMNR_PIC;                                 
         HJ_EEJDNR_BIN = HJ_EEJDNR_PIC;                                 
         ANTAL_LÆS = 0;                                                 
                                                                        
         DO WHILE (^EOF_BH9990I);                                       
                                                                        
            CALL DECLARE_EJD_OVS_CUR;                                   
                                                                        
            EXEC SQL OPEN EJD_OVS_CUR;                                  
                                                                        
            IF SQLCA.SQLCODE ^= 0                                       
            THEN                                                        
              DO;                                                       
                FEJLTEKST = 'SQLFEJL: OPEN EJD_OVS_CUR';                
                CALL SQL_FEJL;                                          
              END;                                                      
                                                                        
            PERSONTAB = '';                                             
                                                                        
            CALL FETCH_EJD_OVS_CUR;                                     
                                                                        
            DO WHILE(SQLCODE = 0);                                      
               CALL LÆS_EJERSKABS_FELTTABEL;                            
               CALL SKRIV_UDTRÆK;                                       
               PERSONTAB = '';                                          
               CALL FETCH_EJD_OVS_CUR;                                  
            END; /*DO WHILE SQLCODE*/                                   
                                                                        
            EXEC SQL CLOSE EJD_OVS_CUR;                                 
                                                                        
            IF SQLCA.SQLCODE ^= 0                                       
            THEN                                                        
              DO;                                                       
                FEJLTEKST = 'SQLFEJL: CLOSE EJD_OVS_CUR';               
                CALL SQL_FEJL;                                          
              END;                                                      
                                                                        
                                                                        
            READ FILE(BH9990I) INTO (UDTRÆK_ESR);                       
            IF ^EOF_BH9990I                                             
            THEN                                                        
               DO;                                                      
                  HJ_EKOMNR_PIC = UDTRÆK_ESR.EKOMNR;                    
                  HJ_EEJDNR_PIC = UDTRÆK_ESR.EEJDNR;                    
                  HJ_EKOMNR_BIN = HJ_EKOMNR_PIC;                        
                  HJ_EEJDNR_BIN = HJ_EEJDNR_PIC;                        
                  ANTAL_LÆS = ANTAL_LÆS + 1;                            
               END;                                                     
         END;/*DO WHILE EOF_IND*/                                       
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* SKRIV UDTRÆKSFILEN                                                */
 /*********************************************************************/
 SKRIV_UDTRÆK: PROC;                                                    
                  HJ_DCPRN_PIC = PERSONTAB.DCPRN;                       
                  UDTRÆK_CSC.EKOMNR = HJ_EKOMNR_PIC;                    
                  UDTRÆK_CSC.EEJDNR = HJ_EEJDNR_PIC;                    
                  UDTRÆK_CSC.DCPRNR = HJ_DCPRN_PIC;                     
                  UDTRÆK_CSC.FEJLNR = PERSONTAB.FEJLNR;                 
                  WRITE FILE(BH9990O) FROM(UDTRÆK_CSC);                 
                  ANTAL_SKRIV = ANTAL_SKRIV + 1;                        
 END SKRIV_UDTRÆK;                                                      
 /*********************************************************************/
 /* DECLARE CURSOR TIL EVS EJERSKABSTABELEN                           */
 /*********************************************************************/
 DECLARE_EJD_OVS_CUR: PROC;                                             
                                                                        
         EXEC SQL                                                       
                                                                        
              DECLARE EJD_OVS_CUR CURSOR FOR                            
                                                                        
              SELECT T1.DCPRN,                                          
                     T1.DINDKAAR,                                       
                     T1.EKOMNR,                                         
                     T1.EEJDNR,                                         
                     T1.ELBNR,                                          
                     T1.EGENNR                                          
                                                                        
              FROM   BQ30000T T1                                        
                                                                        
              WHERE  T1.DINDKAAR = 2002                                 
              AND    T1.EKOMNR   = :HJ_EKOMNR_BIN                       
              AND    T1.EEJDNR   = :HJ_EEJDNR_BIN                       
              AND    T1.EGENNR   = 1                                    
                                                                        
              ORDER BY T1.DCPRN                                         
                                                                        
              FOR FETCH ONLY                                            
         ;                                                              
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'SQLFEJL: DECLARE EJD_OVS_CUR';                
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END DECLARE_EJD_OVS_CUR;                                               
 /*********************************************************************/
 /* FETCH CURSOR TIL EVS OVERSIGT FOR EN PERSON                       */
 /* FUNKTION 8                                                        */
 /*********************************************************************/
 FETCH_EJD_OVS_CUR: PROC;                                               
                                                                        
         EVS_ESK = '';                                                  
                                                                        
         EXEC SQL                                                       
                                                                        
              FETCH EJD_OVS_CUR                                         
                                                                        
              INTO  :PERSONTAB.DCPRN,                                   
                    :PERSONTAB.DINDKAAR,                                
                    :PERSONTAB.EKOMNR,                                  
                    :PERSONTAB.EEJDNR,                                  
                    :PERSONTAB.ELBNR,                                   
                    :PERSONTAB.EGENNR;                                  
                                                                        
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST = 'SQLFEJL: FETCH EJD_OVS_CUR';                
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* END-SELECT */                                          
                                                                        
 END FETCH_EJD_OVS_CUR;                                                 
 /*********************************************************************/
 /* LÆS EJERSKABSFELTTABEL OG FLYT DATA TIL PERSONTAB                 */
 /*********************************************************************/
 LÆS_EJERSKABS_FELTTABEL: PROC;                                         
                                                                        
            CALL DECLARE_ESK_FEL_CUR;                                   
                                                                        
            EXEC SQL OPEN ESK_FEL_CUR;                                  
                                                                        
            IF SQLCA.SQLCODE ^= 0                                       
            THEN                                                        
              DO;                                                       
                FEJLTEKST = 'SQLFEJL: OPEN ESK_FEL_CUR';                
                CALL SQL_FEJL;                                          
              END;                                                      
                                                                        
            CALL FETCH_ESK_FEL_CUR;                                     
                                                                        
            DO WHILE(SQLCODE = 0);                                      
               CALL FLYT_ESK_FEL;                                       
               CALL FETCH_ESK_FEL_CUR;                                  
            END;                                                        
                                                                        
            EXEC SQL CLOSE ESK_FEL_CUR;                                 
                                                                        
            IF SQLCA.SQLCODE ^= 0                                       
            THEN                                                        
              DO;                                                       
                FEJLTEKST = 'SQLFEJL: CLOSE ESK_FEL_CUR';               
                CALL SQL_FEJL;                                          
              END;                                                      
                                                                        
 END LÆS_EJERSKABS_FELTTABEL;                                           
 /*********************************************************************/
 /* DECLARE CURSOR TIL EVS_ESK_FELT                                   */
 /*********************************************************************/
 DECLARE_ESK_FEL_CUR: PROC;                                             
                                                                        
         EXEC SQL                                                       
                                                                        
              DECLARE ESK_FEL_CUR CURSOR FOR                            
                                                                        
              SELECT T1.DCPRN,                                          
                     T1.DINDKAAR,                                       
                     T1.EKOMNR,                                         
                     T1.EEJDNR,                                         
                     T1.ELBNR,                                          
                     T1.EGENNR,                                         
                     T1.FELTKODE,                                       
                     T1.INDHOLD_C,                                      
                     T1.INDHOLD_D                                       
                                                                        
              FROM   BQ31000T T1                                        
                                                                        
              WHERE  T1.DCPRN    = :PERSONTAB.DCPRN                     
              AND    T1.DINDKAAR = :PERSONTAB.DINDKAAR                  
              AND    T1.EKOMNR   = :PERSONTAB.EKOMNR                    
              AND    T1.EEJDNR   = :PERSONTAB.EEJDNR                    
              AND    T1.ELBNR    = :PERSONTAB.ELBNR                     
              AND    T1.EGENNR   = :PERSONTAB.EGENNR                    
              AND    T1.FELTKODE = 108                                  
                                                                        
              ORDER BY T1.FELTKODE                                      
              FOR FETCH ONLY                                            
         ;                                                              
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'SQLFEJL: DECLARE ESK_FEL_CUR';                
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END DECLARE_ESK_FEL_CUR;                                               
 /*********************************************************************/
 /* FETCH CURSOR TIL EVS_ESK_FELT                                     */
 /*********************************************************************/
 FETCH_ESK_FEL_CUR: PROC;                                               
                                                                        
         EXEC SQL                                                       
                                                                        
              FETCH ESK_FEL_CUR                                         
                                                                        
              INTO  :EVS_ESK_FELT.DCPRN,                                
                    :EVS_ESK_FELT.DINDKAAR,                             
                    :EVS_ESK_FELT.EKOMNR,                               
                    :EVS_ESK_FELT.EEJDNR,                               
                    :EVS_ESK_FELT.ELBNR,                                
                    :EVS_ESK_FELT.EGENNR,                               
                    :EVS_ESK_FELT.FELTKODE,                             
                    :EVS_ESK_FELT.INDHOLD_C,                            
                    :EVS_ESK_FELT.INDHOLD_D;                            
                                                                        
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                   /* SKRIV TS_KØ, SKER I PROCEDURE SKRIV_TS_EVS_OVS */ 
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST = 'SQLFEJL: FETCH ESK_FEL_CUR';                
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* END-SELECT */                                          
                                                                        
 END FETCH_ESK_FEL_CUR;                                                 
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         CLOSE FILE(BH9990I);                                           
         CLOSE FILE(BH9990O);                                           
         CALL ZS67000(SQLCA);                                           
                                                                        
         ABENDMEDD = 'BH99900 ** 250 ' !! FEJLTEKST;                    
                                                                        
         CALL ZS30101 (5, ABENDMEDD, 2);                                
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
         CLOSE FILE(BH9990I);                                           
         CLOSE FILE(BH9990O);                                           
                                                                        
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LIN.TEKST = 'ANTAL LÆSTE FRA UDTRÆKKET FRA ESR..............'; 
         LIN.ANT   = ANTAL_LÆS;                                         
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LIN.TEKST = 'ANTAL SKREVNR TIL ESR..........................'; 
         LIN.ANT   = ANTAL_SKRIV;                                       
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LIN.TEKST = 'ANTAL OVERSPRUNGET FRA ESR.....................'; 
         LIN.ANT   = ANTAL_OVERSP;                                      
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         CALL ZZ20300(' ','99');                      /* LUK KMDSPOOL */
                                                                        
 END AFSLUT;                                                            
 /*********************************************************************/
 /* HER STARTER APPLIKATIONENS EGNE INCLUDES                          */
 /*********************************************************************/
         %INCLUDE BQ02020M;              /* FLYT_ESK_FEL              */
                                                                        
 END BH99900;                                                           
