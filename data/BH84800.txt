 PROCESS OPT(TIME);                                                     
 BH84800:/* Opdatering af samtlige ejendomme for personer             */
         /* med CENKE 5                                               */
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /*********************************************************************/
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA A/S 2004');       
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : personer med CENKE 5 gennemløbes, og samtlige af          * 
 *          personens ejendomme, opdateret med 5. Dog opdateres       * 
 *          kun hvis ejerskabet IKKE er slettet (COPR_CENKE)          * 
 *          Samtidig sættes oprindelseskode til 'S'                   * 
 *          Alle øvrige records røres ikke                            * 
 *          Oprettet som en del af KS30-01 til Forskud 2017           * 
 *          Programmet skal anvendes både til Slut og Forskuds        * 
 *          oprettelsen af EVS.                                       * 
 ********************************************************************** 
 *                                                                    * 
 * INPUT  : BQ77000T og BQ78000T                                      * 
 *                                                                    * 
 * OUTPUT : BQ78000T                                                  * 
 *                                                                    * 
 ********************************************************************** 
 *                                                                    * 
 * NYT PROGRAM : Lene Maj Jensen QLE                      29.06.2016  * 
 *                                                                    * 
 ********************************************************************** 
 *                                                                    * 
 * RETTELSESLOG:                                                      * 
 * Esben Brodersen      QEB                               06.07.2016  * 
 * CPTYPSLUT og CPTYPFOR skal rettes når CENKE ændres, så de er       * 
 * hænger sammen. Der opdeles i sommerhuse og øvrige ejendomme ved    * 
 * ved skrivning. Ændret BH944 -> BH943 da programmet er flyttet      * 
 * indsat optællings individ da det er forventet i BH94200L           * 
 * indsat print liste                                                 * 
 *                                                                    * 
 * Lene Maj Jensen      QLE                               21.09.2016  * 
 * Struktur BN90100N ændret til BN90000N til SLUT16                   * 
 * Søg efter 'RUL' da rettelsen ligger flere steder                   * 
 *                                                                    * 
 * Lene Maj Jensen      QLE                               07.03.2017  * 
 * Omlægning til db2.                                                 * 
 * BH94700 og BH94800 er sammenlagt i dette modul                     * 
 * BH94201M Taget ud QEB.                                             * 
 *                                                                    * 
 * SLUT18        Esben Brodersen EBD                       SEP        * 
 *               2-Familie KS02-23                                    * 
 *               Feltet EENHEDLBNR er tilføjet som en del af nøgle    * 
 *               efter ejendomnummeret. Der er tilføjet et teknisk    * 
 *               fejlnummer for ESR data til 2 familie huse           * 
 * Navn:                Init:                             Dato:       * 
 * xxxxxxxxxxxxxx       xxx                               99.99.9999  * 
 **********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH848I FILE RECORD INPUT;     /* PARAMETERINPUT */             
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
                                                                        
 /*********************************************************************/
 /*      DECLARE AF INPUT                                             */
 /*********************************************************************/
 DCL     1 BH848_PARM,                                                  
           %INCLUDE BH54900N;                                           
 /********************************************************************* 
 *               DECLARE AF DIV. FÆLLESMACROER                        * 
 *********************************************************************/ 
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 /*********************************************************************/
 /*     DECLARE AF DB2-variabler                                      */
 /*********************************************************************/
  EXEC SQL INCLUDE SQLCA;                                               
 DCL    SQLKODE         FIXED     (5);                                  
 DCL    SQLCODE_CH      CHAR      (5);                                  
 DCL    SQLCODE_PIC     PIC       'SSSS9' DEF SQLCODE_CH;               
                                                                        
 /***************************************************************       
 /*      DECLARE AF ABEND-RUTINE                                        
 /**************************************************************/       
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH84800'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
 /*********************************************************************/
 /*      DECLARE TIL LISTE PRINT                                      */
 /*********************************************************************/
         % INCLUDE ZZ20301M;                                            
                                                                        
 DCL    1 LINIE,                                                        
          2 CCA          CHAR      (01),                                
          2 INDHOLD      CHAR      (132)     INIT      (' ');           
                                                                        
 DCL    HJ_PIC9          PIC       '(8)Z9';                             
 DCL    UDDATO          CHAR       (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (4),                                 
           2 F1          CHAR      (1),                                 
           2 MD          CHAR      (2),                                 
           2 F2          CHAR      (1),                                 
           2 DG          CHAR      (2);                                 
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     PUTSKIP                BIT(1)   INIT ('0'B);                   
                                                                        
 DCL     WS_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                    
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
                                                                        
 DCL     WS_TIL_EVS_AAR_GL              BIN FIXED (15);                 
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_PROGRAMNAVN         CHAR(8)  INIT ('BH84800');              
                                                                        
 DCL     EOF_BH848             BIT       (1)     INIT ('0'B);           
 DCL     ESR_FUNDET       BIT       (1);                                
                                                                        
 DCL     SPEC_PUTSKIP        BIT       (1)     INIT('0'B);              
 DCL     ANTAL_LÆST_BH943    BIN FIXED (31)    INIT(0);                 
 DCL     ANTAL_LÆST_BH947    BIN FIXED (31)    INIT(0);                 
 DCL     ANT_SKR       BIN FIXED (31)    INIT(0);                       
 DCL     ANT_UPD     BIN FIXED (31)    INIT(0);                         
 DCL     ANTAL_EJ_OPDATERET  BIN FIXED (31)    INIT(0);                 
 DCL     ANTAL_SOMMERHUSE    BIN FIXED (31)    INIT(0);                 
 DCL     ANTAL_ØVRIGE        BIN FIXED (31)    INIT(0);                 
 DCL     WS_DCPRN            FIXED     (11);   /* Personnr */           
 DCL     JA                  BIT       (1)     INIT ('1'B);             
 DCL     NEJ                 BIT       (1)     INIT ('0'B);             
 DCL     HJBEGRÆNSET_TP      CHAR      (1);                             
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /*TIMESTAMP    */ 
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
 /*********************************************************************/
 /* M A C R O E R der SKAL ligge før koden grundet declare af cursors */
 /*********************************************************************/
 %INCLUDE BH54999M; /* CHECK OM OMKØRSEL, OG UDFØR EVT OPRYDNING */     
                                                                        
 /*********************************************************************/
 /* Declare af CURSORS                                                */
 /*********************************************************************/
                                                                        
         /* finder alle cprnr med cenke 5 og mindst 1 levende ejendom */
         EXEC SQL DECLARE CENKECURS CURSOR WITH HOLD FOR                
                                                                        
             SELECT DISTINCT (T78.DCPRN)                                
                                                                        
          FROM BQ78000T T78                                             
          WHERE T78.TIL_EVS_AAR = :WS_TIL_EVS_AAR                       
          AND   T78.AFVIKLINGS_ID = :WS_FORSKUD_SLUT_TXT                
          AND   T78.TILEVS_CENKE = '5'                                  
          AND   '1' > (SELECT (T77.EVSSEJ_SID_CSLET)                    
                       FROM BQ77000T T77                                
                       WHERE T77.TIL_EVS_AAR = T78.TIL_EVS_AAR          
                       AND   T77.AFVIKLINGS_ID = T78.AFVIKLINGS_ID      
                       AND   T77.EKOMNR = T78.EKOMNR                    
                       AND   T77.EEJDNR = T78.EEJDNR                    
                       AND   T77.EENHEDLBNR = T78.EENHEDLBNR            
                       AND   T77.EGENNR = T78.EGENNR                    
                       AND   T77.DCPRN  = T78.DCPRN)                    
          ORDER BY T78.DCPRN;                                           
                                                                        
          /* finder oplysninger for personer fundet via CENKECURS */    
          EXEC SQL DECLARE DETAILCURS CURSOR WITH HOLD FOR              
                                                                        
              SELECT T76.HIST_OPD_DETTE_CSKPLOM,                        
                     T77.EVSSEJ_SID_CSKPLOMF,                           
                     T77.EVSSEJ_SID_CSLET,                              
                     T78.DCPRN,                                         
                     T78.TILEVS_CENKE,                                  
                     T78.TILFORSK_COPR_CENKE,                           
                     T78.EKOMNR,                                        
                     T78.EEJDNR,                                        
                     T78.EENHEDLBNR,                                    
                     T78.EGENNR,                                        
                     T78.TILEVS_CPTYPSLUT,                              
                     T78.TILEVS_CPTYPFOR                                
          FROM BQ78000T T78, BQ77000T T77, BQ76000T T76                 
          WHERE T78.TIL_EVS_AAR = :WS_TIL_EVS_AAR                       
          AND   T78.AFVIKLINGS_ID = :WS_FORSKUD_SLUT_TXT                
          AND   T78.DCPRN = :WS_DCPRN                                   
          AND   T77.TIL_EVS_AAR = T78.TIL_EVS_AAR                       
          AND   T77.AFVIKLINGS_ID = T78.AFVIKLINGS_ID                   
          AND   T77.DCPRN  = T78.DCPRN                                  
          AND   T77.EKOMNR = T78.EKOMNR                                 
          AND   T77.EEJDNR = T78.EEJDNR                                 
          AND   T77.EENHEDLBNR = T78.EENHEDLBNR                         
          AND   T77.EGENNR = T78.EGENNR                                 
          AND   T76.TIL_EVS_AAR = T78.TIL_EVS_AAR                       
          AND   T76.AFVIKLINGS_ID = T78.AFVIKLINGS_ID                   
          AND   T76.DCPRN  = T78.DCPRN                                  
          AND   T76.EKOMNR = T78.EKOMNR                                 
          AND   T76.EEJDNR = T78.EEJDNR                                 
          AND   T76.EENHEDLBNR = T78.EENHEDLBNR                         
          AND   T76.EGENNR = T78.EGENNR                                 
                                                                        
          ORDER BY T78.DCPRN;                                           
 /********************************************************************* 
 *       ON CONDITIONS                                                * 
 *********************************************************************/ 
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH84800L');             
            END;                                                        
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BH848 = NEJ;                                               
         OPEN FILE (BH848I) TITLE ('BH84800P');                         
                                                                        
         ON ENDFILE (BH848I)                                            
         BEGIN;                                                         
            EOF_BH848 = JA;                                             
         END;                                                           
                                                                        
         CALL ZZ20390 ('*OPEN','BH84801Y');                             
                                                                        
         CALL ZS38100(DATO1);                 /* Skaf timestamp */      
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
         READ FILE (BH848I) INTO (BH848_PARM);                          
                                                                        
         IF EOF_BH848 = NEJ                                             
         THEN DO;                                                       
            SELECT (BH848_PARM.FS_MRK);                                 
               WHEN ('F')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH848_PARM.FORSKUD_TXT;      
                     WS_TIL_EVS_AAR = BH65300M.FORSKÅR;                 
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH848_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('S')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH848_PARM.SLUT_TXT;         
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH848_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('U')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH848_PARM.SUPPL_TXT;        
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH848_PARM.SLUT_TXT;       
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
                                                                        
         END;                                                           
                                                                        
         /********************************************************/     
         /*  CHECK OM FORGÆNGERE ER KØRT                         */     
         /********************************************************/     
         /* QEB QEB 2018-03-07 HACK*/                                   
         /*CALL CHECK_SEKVENS (BH848_PARM.FS_MRK); /* BH54997M */       
                                                                        
         /********************************************************/     
         /*  NU STARTER CHECK AF OMKØRSEL                        */     
         /********************************************************/     
         /* QEB QEB 2018-03-07 HACK*/                                   
         /*CALL CHECK_OM_OMKØRSEL; /* kode ligger i macro BH54999M */   
         DER_SKAL_KØRES_OM = NEJ;                                       
                                                                        
         IF DER_SKAL_KØRES_OM                                           
         THEN DO;                                                       
            PUT SKIP LIST ('Omkørsel af ' !! WS_PROGRAMNAVN);           
            CALL RYD_OP_FØR_OMKØRSEL;                                   
         END;                                                           
         ELSE DO;                                                       
            PUT SKIP LIST ('Normal kørsel af ' !! WS_PROGRAMNAVN);      
         END;                                                           
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL ('START',BH848_PARM.FS_MRK);         
                                                                        
         CALL OPEN_CENKECURS;                                           
         CALL FETCH_CENKECURS;                                          
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               DO WHILE (SQLCA.SQLCODE = 0); /* cenke 5 cpr fundet */   
                  DCLBQ76000T = '';                                     
                  DCLBQ77000T = '';                                     
                  DCLBQ78000T = '';                                     
                  CALL CLOSE_DETAILCURS;                                
                  CALL OPEN_DETAILCURS;                                 
                  CALL FETCH_DETAILCURS;                                
                                                                        
                  SELECT (SQLCA.SQLCODE);                               
                                                                        
                    WHEN (0)                                            
                      DO;                                               
                        DO WHILE (SQLCA.SQLCODE = 0); /* detailopl */   
                           CALL BEHANDL;                                
                           CALL FETCH_DETAILCURS;                       
                        END;                                            
                      END;                                              
                                                                        
                    WHEN (100)                                          
                      DO;                                               
                      END;                                              
                    OTHERWISE                                           
                      DO;                                               
                        ABENDTXT = '101 FETCH DETAILCURS';              
                        CALL SQL_FEJL;                                  
                      END;                                              
                                                                        
                  END; /* SELECT*/                                      
                  CALL FETCH_CENKECURS;                                 
               END;                                                     
             END;                                                       
                                                                        
           WHEN (100)                                                   
             DO;                                                        
             END;                                                       
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH CENKECURS';                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         IF ANT_SKR < 0                                                 
         THEN DO;                                                       
             EXEC SQL COMMIT;                                           
             Put skip list ('Commit efter ' !! ANT_SKR !!               
                            ' opdateringer.  Ialt ' !! ANT_UPD !!       
                            ' opdateringer');                           
         END;                                                           
                                                                        
         CALL CLOSE_CENKECURS;                                          
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       Behandling af Personer med cenke 5 på mindst en ejendom      * 
 *********************************************************************/ 
 BEHANDL: PROC;                                                         
                                                                        
         IF DCLBQ77000T.EVSSEJ_SID_CSLET < '1' &                        
            DCLBQ78000T.TILEVS_CENKE ^= '5'                             
            /* ejendom/ejerskab er IKKE slettet      */                 
            /* og CENKE er ikke allerede opsat til 5 */                 
         THEN DO;                                                       
            /* opdater og skriv, læs næste 944 */                       
            DCLBQ78000T.TILEVS_CENKE = '5';                             
            IF BH848_PARM.FS_MRK = 'S'                                  
            THEN DO;                                                    
               DCLBQ78000T.TILFORSK_COPR_CENKE = 'S';                   
            END;                                                        
            ELSE DO;                                                    
               DCLBQ78000T.TILFORSK_COPR_CENKE = 'F';                   
            END;                                                        
            /* Justering af persontype felt 756/758  */                 
            /* Svarer til ALDERSRET_SLUT=JA i BH94300L*/                
            IF ER_BEGRÆNSET_SKATTEPLIGTIG                               
            THEN DO;                                                    
               IF DCLBQ78000T.EKOMNR = 999                              
               THEN DO;                                                 
                  IF HJBEGRÆNSET_TP = '1' !                             
                     HJBEGRÆNSET_TP = '3'                               
                  THEN DO;                                              
                      DCLBQ78000T.TILEVS_CPTYPSLUT = '1';               
                      DCLBQ78000T.TILEVS_CPTYPFOR = '1';                
                  END;                                                  
                  ELSE DO;  /* type 8 - domicileret */                  
                     DCLBQ78000T.TILEVS_CPTYPSLUT = '4';                
                     DCLBQ78000T.TILEVS_CPTYPFOR = '4';                 
                  END;                                                  
               END;                                                     
               ELSE DO;                                                 
                  DCLBQ78000T.TILEVS_CPTYPSLUT = '4';                   
                  DCLBQ78000T.TILEVS_CPTYPFOR  = '4';                   
               END;                                                     
            END;                                                        
            ELSE DO;                                                    
               DCLBQ78000T.TILEVS_CPTYPSLUT = '3';                      
               DCLBQ78000T.TILEVS_CPTYPFOR  = '3';                      
            END;                                                        
            CALL UPDATE_RESULT;                                         
         END;                                                           
         ELSE DO;                                                       
            /* ejendommen er slettet, så der overføres */               
            /* uden opdatering eller CENKE er allerede */               
            /* sat til 5 */                                             
            ANTAL_EJ_OPDATERET = ANTAL_EJ_OPDATERET + 1;                
            /* CALL UPDATE_RESULT; QEB */                               
         END;                                                           
                                                                        
 END BEHANDL;                                                           
                                                                        
 /********************************************************************/ 
 /* UNDERSØG OM EN BORGER ER BEGRÆNSET SKATTEPLIGTIG. FINDES MT DATA */ 
 /* ANVENDES DE ELLERS UNDERSØGES SIDSTE EVS SLUT ÅR                 */ 
 /********************************************************************/ 
 ER_BEGRÆNSET_SKATTEPLIGTIG:PROC RETURNS(BIT(1));                       
                                                                        
   DCL HJBEGRÆNSET_BIT BIT(1);                                          
                                                                        
   HJBEGRÆNSET_BIT = NEJ;                                               
   HJBEGRÆNSET_TP = '0';                                                
                                                                        
   IF DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM >= '0'                         
   THEN                                                                 
     DO;                                                                
       IF DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM = '1' !                    
          DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM = '3' !                    
          DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM = '8'                      
       THEN                                                             
         DO;                                                            
           HJBEGRÆNSET_BIT = JA;                                        
           HJBEGRÆNSET_TP = DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM;         
         END;                                                           
     END;                                                               
   ELSE                                                                 
     DO;                                                                
       IF DCLBQ77000T.EVSSEJ_SID_CSKPLOMF = '1' !                       
          DCLBQ77000T.EVSSEJ_SID_CSKPLOMF = '3' !                       
          DCLBQ77000T.EVSSEJ_SID_CSKPLOMF = '8'                         
       THEN                                                             
         DO;                                                            
           HJBEGRÆNSET_BIT = JA;                                        
           HJBEGRÆNSET_TP =                                             
                DCLBQ77000T.EVSSEJ_SID_CSKPLOMF;                        
         END;                                                           
     END;                                                               
                                                                        
   RETURN(HJBEGRÆNSET_BIT);                                             
                                                                        
 END ER_BEGRÆNSET_SKATTEPLIGTIG;                                        
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF CENKE5 personer                     RUTINE */
 /*********************************************************************/
 OPEN_CENKECURS: PROC;                                                  
                                                                        
         EXEC SQL OPEN CENKECURS;                                       
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              ABENDTXT = '101 OPEN CENKECURS';                          
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_CENKECURS;                                                    
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF COR-TABEL BG40400T                 RUTINE */
 /*********************************************************************/
 FETCH_CENKECURS: PROC;                                                 
                                                                        
         EXEC SQL FETCH CENKECURS                                       
                                                                        
         INTO :WS_DCPRN                                                 
         ;                                                              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
                ANTAL_LÆST_BH947 = ANTAL_LÆST_BH947 + 1;                
             END;                                                       
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH CENKECURS';                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         /* PUT SKIP LIST('FETCH CENKECURS WS_DCPRN=', WS_DCPRN); */    
                                                                        
 END FETCH_CENKECURS;                                                   
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF cenke5 personer                    RUTINE */
 /*********************************************************************/
 CLOSE_CENKECURS: PROC;                                                 
                                                                        
         EXEC SQL CLOSE CENKECURS;                                      
                                                                        
 END CLOSE_CENKECURS;                                                   
 /*********************************************************************/
 /* UPDATE CENKE = 5 samt oprindelseskode                      RUTINE */
 /*********************************************************************/
 UPDATE_RESULT: PROC;                                                   
                                                                        
         DCLBQ78000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ78000T.DB2FUNKTION    = 'U';                              
                                                                        
         EXEC SQL                                                       
            UPDATE BQ78000T                                             
            SET                                                         
             PROGRAMNAVN          = :WS_PROGRAMNAVN,                    
             DB2FUNKTION          = 'U',                                
             TILEVS_CENKE         = :DCLBQ78000T.TILEVS_CENKE,          
             TILFORSK_COPR_CENKE  = :DCLBQ78000T.TILFORSK_COPR_CENKE,   
             TILEVS_CPTYPSLUT     = :DCLBQ78000T.TILEVS_CPTYPSLUT,      
             TILEVS_CPTYPFOR      = :DCLBQ78000T.TILEVS_CPTYPFOR        
                                                                        
            WHERE TIL_EVS_AAR   = :WS_TIL_EVS_AAR                       
            AND   AFVIKLINGS_ID = :WS_FORSKUD_SLUT_TXT                  
            AND   DCPRN         = :WS_DCPRN                             
            AND   EKOMNR        = :DCLBQ78000T.EKOMNR                   
            AND   EEJDNR        = :DCLBQ78000T.EEJDNR                   
            AND   EENHEDLBNR    = :DCLBQ78000T.EENHEDLBNR               
            AND   EGENNR        = :DCLBQ78000T.EGENNR;                  
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_UPD = ANT_UPD + 1;                                   
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 UPDATE RESULT';                          
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END UPDATE_RESULT;                                                     
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF OPLYSNINGER FRA MT, SLUT OG RESULTAT       */
 /*********************************************************************/
 OPEN_DETAILCURS: PROC;                                                 
                                                                        
         EXEC SQL OPEN DETAILCURS;                                      
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              ABENDTXT = '101 OPEN DETAILCURS';                         
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_DETAILCURS;                                                   
                                                                        
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF OPLYSNINGER FRA MT, SLUT OG RESULTAT      */
 /*********************************************************************/
 FETCH_DETAILCURS: PROC;                                                
                                                                        
         /* nulstil areal ?*/                                           
                                                                        
         EXEC SQL FETCH DETAILCURS                                      
                                                                        
         INTO :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM,                      
              :DCLBQ77000T.EVSSEJ_SID_CSKPLOMF,                         
              :DCLBQ77000T.EVSSEJ_SID_CSLET,                            
              :DCLBQ78000T.DCPRN,                                       
              :DCLBQ78000T.TILEVS_CENKE,                                
              :DCLBQ78000T.TILFORSK_COPR_CENKE,                         
              :DCLBQ78000T.EKOMNR,                                      
              :DCLBQ78000T.EEJDNR,                                      
              :DCLBQ78000T.EENHEDLBNR,                                  
              :DCLBQ78000T.EGENNR,                                      
              :DCLBQ78000T.TILEVS_CPTYPSLUT,                            
              :DCLBQ78000T.TILEVS_CPTYPFOR                              
         ;                                                              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH DETAILCURS';                       
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_DETAILCURS;                                                  
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF OPLYSNINGER FRA MT, SLUT OG RESULTAT      */
 /*********************************************************************/
 CLOSE_DETAILCURS: PROC;                                                
                                                                        
         EXEC SQL CLOSE DETAILCURS;                                     
                                                                        
 END CLOSE_DETAILCURS;                                                  
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 AFSLUT:PROC;                                                           
                                                                        
      /*sideskift*/                                                     
      LINIE.CCA     = ZZIK1;                                            
      LINIE.INDHOLD = '';                                               
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      /*overskrift*/                                                    
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'KØRSELS TOTALER FOR BH84800 AFVIKLET DEN ' !!    
                      UDDATO;                                           
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      /*mellemrum*/                                                     
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = '';                                               
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANTAL_LÆST_BH947;                                 
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL LÆSTE RECORDS CENKE5 BQ78000T: ' !!        
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANT_UPD;                                          
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL OPDATERET RECORDS BQ78000T: ' !!           
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANTAL_EJ_OPDATERET;                               
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL EJ OPDATERET BQ78000T: ' !!                
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      /*mellemrum*/                                                     
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = '';                                               
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANT_SKR;                                          
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL OPDATERET IALT(UDEN OPTÆLLINGS INDIVID): ' 
                      !! '             '  !!                            
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      CALL ZZ20300(' ','99'); /*luk print datasæt*/                     
                                                                        
      CLOSE FILE (BH848I);                                              
                                                                        
      CALL OPDATER_KØRSELSTABEL ('SLUT',BH848_PARM.FS_MRK);             
                                                                        
 END AFSLUT;                                                            
 /* %INCLUDE BH54997M; */     /* ER FORGÆNGERE KØRT. STOP HVIS IKKE */  
 %INCLUDE BH54998M;     /* OPDATER KØRSELSTABEL */                      
 END  BH84800;                                                          
