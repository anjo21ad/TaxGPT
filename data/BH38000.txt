 BH38000: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS SLUT 2013                                         **
 * PROGRAMNAVN: BH38000.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    FELT 756 ER FEJLAGTIGT BLEVET RETTET FRA 4 TIL 1       *
 *              DETTE PROGRAM RETTER DET FEJLAGTIGE 1 TILBAGE TIL 4    *
 * INDDATA:     BQ30000T/BQ31000T - EVS PERSONTABEL.                   *
 *              BQ40000T/BQ41000T - EVS RESULTATTABEL.                 *
 * UDDATA:      BQ30000T/BQ31000T - EVS PERSONTABEL.                   *
 *              BH35001Y          - KONTROLLISTE.                      *
 * KONSTRUKTØR: JØRGEN SAUGMANN  SAU,         PKF BALLERUP 13.11.2014. *
 **********************************************************************/
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KMD A/S 2006');            
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
 EXEC SQL INCLUDE SQLCA;        /* SQL KOMMUNIKATIONSAREAL    */        
 EXEC SQL INCLUDE BQ31000T;     /* EVS SLUT EJERSKABSFELTTABEL*/        
 DCL  AARSTAL                FIXED BIN(15)    INIT(0);                  
 DCL 1 BQ31000N,                                                        
 %INCLUDE BQ31000N;;                                                    
                                                                        
 /*Alle eksisterende feltkode = 85 rækker med forkert indhold_c findes*/
 EXEC SQL DECLARE CUR4 CURSOR FOR                                       
                                                                        
 select distinct a.dindkaar, a.dcprn , a.ekomnr, a.eejdnr, a.elbnr      
   from  bq31000t a                                                     
   where a.dindkaar = 2014                                              
     and a.feltkode  = 85                                               
     and a.egennr    =                                                  
     (                                                                  
     select max(a1.egennr)                                              
       from  bq30000t a1                                                
       where a1.dindkaar = a.dindkaar                                   
       and a1.dcprn = a.dcprn                                           
       and a1.ekomnr = a.ekomnr                                         
       and a1.eejdnr = a.eejdnr                                         
       and a1.elbnr = a.elbnr                                           
     )                                                                  
     and a.indhold_c <> '4'                                             
     and exists (select  1                                              
                     from  bq31000t f                                   
                     where f.dindkaar  = 2013                           
                       and f.dcprn = a.dcprn                            
                       and f.ekomnr = a.ekomnr                          
                           and f.eejdnr = a.eejdnr                      
                       and f.elbnr = a.elbnr                            
                       and f.feltkode  = 86                             
                       and f.egennr    =                                
                       (                                                
                          select max(f1.egennr)                         
                          from  bq30000t f1                             
                          where f1.dindkaar = f.dindkaar                
                          and f1.dcprn = f.dcprn                        
                          and f1.ekomnr = f.ekomnr                      
                          and f1.eejdnr = f.eejdnr                      
                          and f1.elbnr = f.elbnr                        
                       )                                                
                       and f.indhold_c = '4')                           
 with ur;                                                               
                                                                        
                                                                        
 /* Manglende rækker med feltkode = 85 i 2014 identificeres           */
 EXEC SQL DECLARE CUR5 CURSOR FOR                                       
                                                                        
 select distinct a.dindkaar, a.dcprn , a.ekomnr, a.eejdnr, a.elbnr      
   from  bq31000t a                                                     
   where a.dindkaar = 2013                                              
     and a.feltkode  = 86                                               
     and a.egennr    =                                                  
     (                                                                  
     select max(a1.egennr)                                              
       from  bq30000t a1                                                
       where a1.dindkaar = a.dindkaar                                   
       and a1.dcprn = a.dcprn                                           
       and a1.ekomnr = a.ekomnr                                         
       and a1.eejdnr = a.eejdnr                                         
       and a1.elbnr = a.elbnr                                           
    )                                                                   
     and a.indhold_c = '4'                                              
     and not exists (select  1                                          
                     from  bq31000t f                                   
                     where f.dindkaar  = 2014                           
                       and f.dcprn = a.dcprn                            
                       and f.ekomnr = a.ekomnr                          
                           and f.eejdnr = a.eejdnr                      
                       and f.elbnr = a.elbnr                            
                       and f.feltkode  = 85                             
                       and f.egennr    =                                
                       (                                                
                          select max(f1.egennr)                         
                          from  bq30000t f1                             
                          where f1.dindkaar = f.dindkaar                
                          and f1.dcprn = f.dcprn                        
                          and f1.ekomnr = f.ekomnr                      
                          and f1.eejdnr = f.eejdnr                      
                          and f1.elbnr = f.elbnr                        
                       )                                                
                   )                                                    
 with ur;                                                               
                                                                        
                                                                        
                                                                        
 /**********************************************************************
 * DECLARE AF ABEND RUTINE                                             *
 **********************************************************************/
                                                                        
 DCL ZS30101        ENTRY;                                              
 DCL ZS67000        ENTRY;                                              
 DCL ZS61900        ENTRY;                        /* KST/SSI INFO */    
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
 DCL JA             BIT(1)           INIT('1'B);                        
 DCL NEJ            BIT(1)           INIT('0'B);                        
 DCL CUR_EOF        BIT(1)           INIT('0'B);                        
 DCL FORTSÆT        BIT(1)           INIT('1'B);                        
 DCL PULS_COUNT     FIXED DEC(11,0)  INIT(0);                           
 DCL PARM_EOF       BIT(1)           INIT('0'B);                        
 DCL OPDAT_SW       BIT(1)           INIT('0'B);                        
 DCL KONTROL_SW     BIT(1)           INIT('0'B);                        
                                                                        
 DCL FEJLTEKST      CHAR (20)        INIT(' ');                         
 DCL ABENDMEDD      CHAR (56)        INIT(' ');                         
                                                                        
 DCL DINDKAAR_UD    PIC '(4)9'       INIT(0);                           
 DCL EKOMNR_UD      PIC 'ZZZ9'       INIT(0);                           
 DCL EEJDNR_UD      PIC 'ZZZZZZ9'    INIT(0);                           
 DCL DCPRN_UD       PIC '(10)9'      INIT(0);                           
 DCL ELBNR_UD       PIC 'ZZ9'        INIT(0);                           
 DCL TEXT_MEDD      CHAR(88) VAR     INIT(' ');                         
 DCL TALLER         FIXED BIN(15,0)  INIT(0);                           
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PARAMETER                                         */
 /*********************************************************************/
 DCL     IPARM    FILE  RECORD  INPUT;                                  
 DCL     1 PARMI,                                                       
          2 KØRSW    CHAR(1),                                           
          2 ÅRSTAL   PIC '9999',                                        
          2 FILLER   CHAR(75);                                          
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
 DCL     SYSPRINT FILE STREAM PRINT;                                    
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
 DCL     (ADDR,DATETIME,VERIFY,NULL,MOD,SUBSTR,PLIDUMP) BUILTIN;        
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
 DCL   ANTLÆS            BIN FIXED (31) INIT(0);/* LÆSTE RÆKKER       */
 DCL   ANTOPDAT          BIN FIXED (31) INIT(0);/* OPDATEREDE RÆKKER  */
 DCL   ANTINSERT         BIN FIXED (31) INIT(0);/* INSERTEDE RÆKKER   */
 /*********************************************************************/
 /* PRINTLINIER TIL SPOOL                                             */
 /*********************************************************************/
 DCL     LINIE           CHAR (133);                                    
 DCL     1 LIN1          BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 TEKST       CHAR (56),                                     
           2 ANT         PIC  '---------9',                             
           2 FIL1        CHAR (66);                                     
 DCL     1 LIN2          BASED(ADDR(LINIE)),                            
           2 CC          CHAR(1),                                       
           2 CPRNR       CHAR(10),                                      
           2 FIL1        CHAR(5),                                       
           2 KOMNR       CHAR(4),                                       
           2 FIL2        CHAR(5),                                       
           2 EEJDNR      CHAR(7),                                       
           2 FIL3        CHAR(5),                                       
           2 ELBNR       CHAR(3),                                       
           2 FIL4        CHAR(5),                                       
           2 TEXT        CHAR(88);                                      
                                                                        
 %INCLUDE ZZ20301M;                          /* PRINT STYREKARAKTERER */
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
    ON ENDFILE (IPARM)                                                  
       PARM_EOF = '1'B;                                                 
    ON ERROR                                                            
       BEGIN;                                                           
          ON ERROR SYSTEM;                                              
          PUT SKIP LIST ('PROGRAMFEJL');                                
          CALL PLIDUMP  ('SBHO','MODUL BH38000');                       
       END;                                                             
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
    CALL SKAF_PARM();                                                   
    CALL ZZ20390('*OPEN','BH38001Y');       /* ÅBEN KONTROLLISTE */     
    LINIE = ZZWS3 !! ' KONTROL- & AFSTEMNINGSTOTAL FOR'                 
                  !! ' OPDATERING AF BQ31000T    ' !! 'DATO: '          
                  !!   DATETIME('YYYY-MM-DD');                          
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = ZZWS3 !! ' PROGRAMID: BH38000 ';                            
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = ZZWS2;                                                      
    CALL ZZ20300(LINIE,'01');                                           
    CALL ZS61900;                              /* KST/SSI INFO   */     
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
    TEXT_MEDD = 'OPDATERET';                                            
    CALL OPEN_CURSOR(4);                                                
    CALL FETCH_CURSOR(4);                                               
    DO WHILE(FORTSÆT & ^CUR_EOF);                                       
       CALL SKRIV_KONTROL;                                              
       IF OPDAT_SW THEN                                                 
          CALL OPDATER_RÆKKE;                                           
       CALL FETCH_CURSOR(4);                                            
    END;                                                                
    CUR_EOF = NEJ;                                                      
    TEXT_MEDD = 'OPRETTET';                                             
    CALL OPEN_CURSOR(5);                                                
    CALL FETCH_CURSOR(5);                                               
    DO WHILE(FORTSÆT & ^CUR_EOF);                                       
       CALL KONTROL_2014();                                             
       IF KONTROL_SW THEN DO;                                           
          CALL SKRIV_KONTROL;                                           
          IF OPDAT_SW THEN                                              
             CALL INSERT_RÆKKE;                                         
       END;                                                             
       CALL FETCH_CURSOR(5);                                            
    END;                                                                
    CALL AFSLUT;                                                        
                                                                        
                                                                        
 /*********************************************************************/
 /* BEHANDL                                                    RUTINE */
 /*********************************************************************/
 KONTROL_2014: PROC;                                                    
                                                                        
    EXEC SQL                                                            
       SELECT COUNT(*)                                                  
          INTO :TALLER                                                  
          FROM BQ30000T                                                 
          where dindkaar = 2014                                         
            and dcprn    = :BQ31000N.dcprn                              
            and ekomnr   = :BQ31000N.ekomnr                             
            and eejdnr   = :BQ31000N.eejdnr                             
            and elbnr    = :BQ31000N.elbnr                              
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0)   DO;                                                    
          IF TALLER > 0 THEN                                            
             KONTROL_SW = JA;                                           
          ELSE                                                          
             KONTROL_SW = NEJ;                                          
       END;                                                             
       WHEN(100);                                                       
       OTHERWISE                                                        
          CALL SQL_FEJL();                                              
    END;                                                                
                                                                        
 END KONTROL_2014;                                                      
                                                                        
 /*********************************************************************/
 /* BEHANDL                                                    RUTINE */
 /*********************************************************************/
 OPDATER_RÆKKE: PROC;                                                   
                                                                        
    EXEC SQL                                                            
       UPDATE   BQ31000T A                                              
          SET   INDHOLD_C = '4'                                         
          WHERE A.DINDKAAR  = :BQ31000N.DINDKAAR                        
            AND A.EKOMNR    = :BQ31000N.EKOMNR                          
            AND A.EEJDNR    = :BQ31000N.EEJDNR                          
            AND A.DCPRN     = :BQ31000N.DCPRN                           
            AND A.ELBNR     = :BQ31000N.ELBNR                           
            AND A.FELTKODE  = 85                                        
            AND A.INDHOLD_C ^= '4'                                      
            AND A.EGENNR    = (SELECT  MAX(B.EGENNR)                    
                                 FROM  BQ31000T B                       
                                 WHERE B.DINDKAAR = A.DINDKAAR          
                                   AND B.EKOMNR   = A.EKOMNR            
                                   AND B.EEJDNR   = A.EEJDNR            
                                   AND B.DCPRN    = A.DCPRN             
                                   AND B.ELBNR    = A.ELBNR             
                                   AND B.FELTKODE = A.FELTKODE)         
    ;                                                                   
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0)                                                          
          ANTOPDAT = ANTOPDAT + 1;                                      
       OTHERWISE                                                        
          CALL SQL_FEJL;                                                
    END;                                                                
                                                                        
 END OPDATER_RÆKKE;                                                     
                                                                        
 INSERT_RÆKKE: PROC;                                                    
                                                                        
    EXEC SQL                                                            
       INSERT INTO BQ31000T                                             
          VALUES(2014                                                   
                ,:BQ31000N.EKOMNR                                       
                ,:BQ31000N.EEJDNR                                       
                ,:BQ31000N.DCPRN                                        
                ,:BQ31000N.ELBNR                                        
                ,(SELECT  MAX(B.EGENNR)                                 
                    FROM  BQ31000T B                                    
                    WHERE B.DINDKAAR = 2014                             
                      AND B.EKOMNR   = :BQ31000N.EKOMNR                 
                      AND B.EEJDNR   = :BQ31000N.EEJDNR                 
                      AND B.DCPRN    = :BQ31000N.DCPRN                  
                      AND B.ELBNR    = :BQ31000N.ELBNR)                 
                ,85                                                     
                ,3                                                      
                ,'4'                                                    
                ,0)                                                     
    ;                                                                   
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0)                                                          
          ANTINSERT = ANTINSERT + 1;                                    
       OTHERWISE                                                        
          CALL SQL_FEJL;                                                
    END;                                                                
                                                                        
 END INSERT_RÆKKE;                                                      
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR                                                RUTINE */
 /*********************************************************************/
 OPEN_CURSOR: PROC(OC_FUNC);                                            
 DCL OC_FUNC        FIXED DEC(1,0);                                     
                                                                        
    SELECT(OC_FUNC);                                                    
       WHEN(4) DO;                                                      
          EXEC SQL OPEN CUR4;                                           
          IF SQLCA.SQLCODE ^= 0 THEN                                    
             CALL SQL_FEJL;                                             
       END;                                                             
       WHEN(5) DO;                                                      
          EXEC SQL OPEN CUR5;                                           
          IF SQLCA.SQLCODE ^= 0 THEN                                    
             CALL SQL_FEJL;                                             
       END;                                                             
       OTHER;                                                           
    END;                                                                
                                                                        
 END OPEN_CURSOR;                                                       
                                                                        
 /*********************************************************************/
 /* FETCH CURSOR                                               RUTINE */
 /*********************************************************************/
 FETCH_CURSOR: PROC(FC_FUNC);                                           
 DCL  FC_FUNC         FIXED DEC(1,0);                                   
 DCL  OK_RK           BIT(1)           INIT('0'B);                      
                                                                        
    SELECT(FC_FUNC);                                                    
       WHEN(4) DO;                                                      
          OK_RK = NEJ;                                                  
          DO WHILE(^OK_RK & ^CUR_EOF);                                  
             EXEC SQL FETCH CUR4                                        
                       INTO :BQ31000N.dindkaar                          
                           ,:BQ31000N.dcprn                             
                           ,:BQ31000N.ekomnr                            
                           ,:BQ31000N.eejdnr                            
                           ,:BQ31000N.elbnr                             
             ;                                                          
             SELECT(SQLCA.SQLCODE);                                     
                WHEN(0) DO;                                             
                   IF PULS_COUNT > 9999 THEN DO;                        
                      PUT SKIP LIST('PULS: LÆST = '!!ANTLÆS!!           
                                '    OPDATERET = '!!ANTOPDAT);          
                      PULS_COUNT = 1;                                   
                   END;                                                 
                   ELSE                                                 
                      PULS_COUNT = PULS_COUNT + 1;                      
                   ANTLÆS = ANTLÆS + 1;                                 
                   IF DINDKAAR_UD = BQ31000N.dindkaar                   
                    & EKOMNR_UD   = BQ31000N.ekomnr                     
                    & EEJDNR_UD   = BQ31000N.eejdnr                     
                    & DCPRN_UD    = BQ31000N.dcprn                      
                    & ELBNR_UD    = BQ31000N.elbnr THEN DO;             
                      OK_RK = NEJ;                                      
                   END;                                                 
                   ELSE DO;                                             
                      DINDKAAR_UD = BQ31000N.dindkaar;                  
                      EKOMNR_UD   = BQ31000N.ekomnr;                    
                      EEJDNR_UD   = BQ31000N.eejdnr;                    
                      DCPRN_UD    = BQ31000N.dcprn;                     
                      ELBNR_UD    = BQ31000N.elbnr;                     
                      OK_RK       = JA;                                 
                   END;                                                 
                END;                                                    
                WHEN(100)                                               
                   CUR_EOF = JA;                                        
                OTHERWISE                                               
                   CALL SQL_FEJL;                                       
             END;                                                       
          END;                                                          
       END;                                                             
       WHEN(5) DO;                                                      
          BQ31000N = '';                                                
          EXEC SQL FETCH CUR5                                           
                    INTO :BQ31000N.dindkaar                             
                        ,:BQ31000N.dcprn                                
                        ,:BQ31000N.ekomnr                               
                        ,:BQ31000N.eejdnr                               
                        ,:BQ31000N.elbnr                                
          ;                                                             
          SELECT(SQLCA.SQLCODE);                                        
             WHEN(0) DO;                                                
                IF PULS_COUNT > 9999 THEN DO;                           
                   PUT SKIP LIST('PULS: LÆST = '!!ANTLÆS!!              
                             '    INSERTET = '!!ANTINSERT);             
                   PULS_COUNT = 1;                                      
                END;                                                    
                ELSE                                                    
                   PULS_COUNT = PULS_COUNT + 1;                         
                ANTLÆS = ANTLÆS + 1;                                    
                DINDKAAR_UD = BQ31000N.dindkaar;                        
                EKOMNR_UD   = BQ31000N.ekomnr;                          
                EEJDNR_UD   = BQ31000N.eejdnr;                          
                DCPRN_UD    = BQ31000N.dcprn;                           
                ELBNR_UD    = BQ31000N.elbnr;                           
             END;                                                       
             WHEN(100)                                                  
                CUR_EOF = JA;                                           
             OTHERWISE                                                  
                CALL SQL_FEJL;                                          
          END;                                                          
       END;                                                             
       OTHER;                                                           
    END;                                                                
                                                                        
 END FETCH_CURSOR;                                                      
                                                                        
 /*********************************************************************/
 /*      SKAF PARM                                                    */
 /*********************************************************************/
 SKAF_PARM: PROC;                                                       
                                                                        
    OPEN FILE(IPARM) TITLE('BH38000I');                                 
    READ FILE(IPARM) INTO(PARMI);                                       
    IF ^PARM_EOF THEN DO;                                               
       IF PARMI.KØRSW ^= ' ' THEN                                       
          OPDAT_SW = JA;                                                
       ELSE                                                             
          OPDAT_SW = NEJ;                                               
       IF VERIFY(PARMI.ÅRSTAL,'0123456789') = 0 THEN                    
          AARSTAL = PARMI.ÅRSTAL;                                       
       ELSE                                                             
          AARSTAL = 2014;                                               
    END;                                                                
    ELSE DO;                                                            
       OPDAT_SW = NEJ;                                                  
       AARSTAL  = 2014;                                                 
    END;                                                                
                                                                        
    PUT SKIP LIST('Der er eksekveret med årstal: '!!AARSTAL);           
    IF OPDAT_SW THEN                                                    
       PUT SKIP LIST('Der sker opdatering af BQ31000T');                
    ELSE                                                                
       PUT SKIP LIST('Ingen opdatering af BQ31000T');                   
                                                                        
 END SKAF_PARM;                                                         
                                                                        
 /*********************************************************************/
 /*      SKRIV KONTROL                                                */
 /*********************************************************************/
 SKRIV_KONTROL: PROC;                                                   
                                                                        
    LINIE       = ZZWS2;                                                
    LIN2.CPRNR  = DCPRN_UD;                                             
    LIN2.KOMNR  = EKOMNR_UD;                                            
    LIN2.EEJDNR = EEJDNR_UD;                                            
    LIN2.ELBNR  = ELBNR_UD;                                             
    LIN2.TEXT   = TEXT_MEDD;                                            
    CALL ZZ20300(LINIE,'01');                                           
                                                                        
 END SKRIV_KONTROL;                                                     
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
    PUT SKIP LIST('SQL_FEJL.....');                                     
    PUT SKIP LIST('SQLCA',SQLCA);                                       
    CALL ZS67000(SQLCA);                                                
    ABENDMEDD =  FEJLTEKST;                                             
    CALL ZS30101 (5, ABENDMEDD, 2);                                     
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
    CALL CLOSE_CURSOR;                                                  
    LINIE = ZZWS2;                                                      
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = ZZWS2;                                                      
    CALL ZZ20300(LINIE,'01');                                           
    LIN1.TEKST = 'ANTAL LÆSTE ...................................';     
    LIN1.ANT   = ANTLÆS;                                                
    CALL ZZ20300(LINIE,'01');                                           
    LIN1.TEKST = 'ANTAL OPDATEREDE ..............................';     
    LIN1.ANT   = ANTOPDAT;                                              
    CALL ZZ20300(LINIE,'01');                                           
    LIN1.TEKST = 'ANTAL INSERTEDE ...............................';     
    LIN1.ANT   = ANTINSERT;                                             
    CALL ZZ20300(LINIE,'01');                                           
    CALL ZZ20300(' ','99');                      /* LUK KMDSPOOL */     
                                                                        
 END AFSLUT;                                                            
                                                                        
 /*********************************************************************/
 /* CLOSE CURSOR                                               RUTINE */
 /*********************************************************************/
 CLOSE_CURSOR: PROC;                                                    
                                                                        
    EXEC SQL CLOSE CUR4;                                                
                                                                        
 END CLOSE_CURSOR;                                                      
                                                                        
 END BH38000;                                                           
