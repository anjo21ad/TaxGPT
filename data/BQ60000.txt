 BQ60000: PROC(COMPTR)  OPTIONS(MAIN,REENTRANT) REORDER;                
 /**********************************************************************
 *                                                                     *
 *     SKELETPROGRAM GENERERET AF ZSRØR                                *
 *                                                                     *
 *       EXTERN MODUL-BESKRIVELSE                                      *
 *                                                                     *
 *       NAVN          - BQ60000                                       *
 *                                                                     *
 *       FUNKTION      - INTERFACE TIL  EVS-PROCESMODUL BQ00250        *
 *                                                                     *
 *       TRANSKODE     - B2Q6                                          *
 *                                                                     *
 *       INDDATA       - COMMAREA FRA ZSRØR                            *
 *                                                                     *
 *       UDDATA        - COMMAREA TIL ZSRØR                            *
 *                                                                     *
 *       EXTERNE REF.  -                                               *
 *                                                                     *
 *       GENERERET AF  - TOMMY DESTING        18.01.01                 *
 *                                                                     *
 *       RETTET        -                                               *
 *                                                                     *
 **********************************************************************/
         %INCLUDE BX530TPM;                  /* TEST PRINT MAKRO      */
         %ÆMOD='BQ60000';                    /* MOD.NAVN I TEST PRINT */
         %ÆPRINT='NO';                       /* YES/NO = TÆND/SLUK    */
 /**********************************************************************
 *    COMMAREA.                                                        *
 **********************************************************************/
 %INCLUDE ZX23000M;                                                     
                                                                        
 /**********************************************************************
 *    ZSRØR INCLUDES.                                                  *
 **********************************************************************/
 %INCLUDE BQ60000M; /*GENERERET AF ZSRØR */                             
 %INCLUDE BQ60001M; /*EGNE PROCEDURER */                                
 %INCLUDE BQ60002M; /*EGNE TS-KØER    */                                
                                                                        
 /**********************************************************************
 *    LOG-/ABEND RUTINE.                                               *
 **********************************************************************/
 %INCLUDE ZS37800M;                                                     
                                                                        
 /**********************************************************************
 *    RUTINE TIL UNIQ NAVNGIVNING AF TSKØER                            *
 **********************************************************************/
 DCL 1 ZS62002,                                                         
 %INCLUDE ZS62002N;                                                     
                                                                        
 /**********************************************************************
 *    ØVRIGE DECLARES                                                  *
 **********************************************************************/
 DCL  TSKØNAVN             CHAR(8);                                     
 DCL  FLERE_ELEMENTER        BIT(1) INIT('1'B);                         
 DCL  FLERE_ELEMENTER_GRUND  BIT(1) INIT('1'B);                         
 DCL  FLERE_ELEMENTER_BEREGN BIT(1) INIT('1'B);                         
 DCL  FLERE_ELEMENTER_OPLYS_GRND BIT(1) INIT('1'B);                     
 DCL  FLERE_ELEMENTER_FEJL   BIT(1) INIT('1'B);                         
 DCL  ANTALELEMENTER       BIN FIXED(15,0)  INIT(0);                    
 DCL (I,H)                 BIN FIXED(15,0);                             
 DCL  CICSRC               BIN FIXED(31,0);                             
 DCL (ADDR,CSTG,NULL,STG,SUBSTR)   BUILTIN;                             
                                                                        
 /**********************************************************************
 *    HOUSE-KEEPING                                                    *
 **********************************************************************/
 EXEC CICS HANDLE CONDITION ERROR(ABEND);                               
                                                                        
 /**********************************************************************
 *    HOVEDSTYRING                                                     *
 **********************************************************************/
   TSKØNAVN = TILDEL_TSKØNAVN;                                          
   CALL SLET_TSKØ;                                                      
   CALL GETMAIN(HJPTR_OUTPUT,STG(OUTPUTELEM));                          
                                                                        
   CALL SKAF_DATA_OG_OPBYG_TSKØ;                                        
   CALL OVERFØR_TIL_ELEMENT;                                            
                                                                        
     /*****************************************                         
     * HER BØR DER INDLÆGGES FEJLBEHANDLING   *                         
     *****************************************/                         
                                                                        
   EXEC CICS RETURN;                                                    
 ABEND:                                                                 
   CALL ABEND_PROCEDURE;                                                
   EXEC CICS RETURN;                                                    
                                                                        
 /**********************************************************************
 *    FREMSKAF DATA OG OPBYG TSKØ.                                   *  
 **********************************************************************/
 SKAF_DATA_OG_OPBYG_TSKØ:  PROC;                                        
                                                                        
                                                                        
                                                                        
   /* DO WHILE(FLERE_ELEMENTER);  FLYTTER TIL EVS_STYRING               
                                                                        
         OUTPUTELEM = '';      */                                       
                                                                        
        /*****************************************                      
        * FREMFIND RELEVANTE DATA F.EKS. FRA DB2 *                      
        * ELLER API.                          *                         
        * UDFYLD ELEMENT MED DE FREMFUNDNE DATA *                       
        * OG LAD DEM SKRIVE TIL TSKØ.         *                         
        *****************************************/                      
                                                                        
   CALL EVS_STYRING; /*BQQ60001M Z6TMD */                               
    /*   IF FLERE_ELEMENTER = JA THEN     /FLYTTET TIL EVS_STYRING/     
            CALL SKRIV_TSKØ;   */                                       
   /* END; */                                                           
   CALL EVS_AFSLUTNING;    /*Z6TMD*/                                    
                                                                        
 END SKAF_DATA_OG_OPBYG_TSKØ;                                           
                                                                        
 /**********************************************************************
 *    OVERFØR FREMFUNDNE DATA TIL ELEMENTSTRUKTUREN.                 *  
 **********************************************************************/
 OVERFØR_TIL_ELEMENT:  PROC;                                            
   CALL FREEMAIN(HJPTR_OUTPUT);                                         
   CAREA.ANTALELEM_UD = 0;                                              
   CAREA.LÆNGDE_UD = STG(OUTPUT) +                                      
          (ANTALELEMENTER * STG(OUTPUTELEM));                           
   CALL GETMAIN(CAREA.OUTPUTPTR,CAREA.LÆNGDE_UD);                       
   OUTPUT = '';                                                         
     /*****************************************                         
     * UDFYLD OUTPUT MED DE FREMFUNDNE DATA   *                         
     * OG F.EKS. RETURKODER ELLER LIGN.       *                         
     *****************************************/                         
   CALL EVS_SKAF_HEADER_DATA; /* BQ60001M  Z6TMD */                     
                                                                        
   HJPTR_OUTPUT = ADDR(OUTPUT.ELEMENTDATA);                             
   DO I = 1 TO ANTALELEMENTER;                                          
      CALL LÆS_TSKØ(I);                                                 
      SELECT(CICSRC);                                                   
       WHEN(DFHRESP(NORMAL)) DO;                                        
         CAREA.ANTALELEM_UD = ANTALELEM_UD + 1;                         
         HJOUT_ADDR = HJOUT_ADDR + STG(OUTPUTELEM);                     
       END;                                                             
       OTHER;  /* INDSÆT FEJLKODE HER */                                
      END;                                                              
   END;                                                                 
   CALL SLET_TSKØ;                                                      
 END OVERFØR_TIL_ELEMENT;                                               
                                                                        
 /**********************************************************************
 *    SKRIV FUNDNE OPLYSNINGER PÅ TSKØ.                              *  
 **********************************************************************/
 SKRIV_TSKØ:  PROC;                                                     
   EXEC CICS WRITEQ TS QUEUE(TSKØNAVN)                                  
                       FROM(OUTPUTELEM)                                 
                       RESP(CICSRC);                                    
   ANTALELEMENTER = ANTALELEMENTER + 1;                                 
 END SKRIV_TSKØ;                                                        
                                                                        
 /**********************************************************************
 *    LÆS FUNDNE OPLYSNINGER FRA TSKØ.                               *  
 **********************************************************************/
 LÆS_TSKØ:  PROC(ITEMNO);                                               
 DCL  ITEMNO               BIN FIXED(15,0);                             
                                                                        
   EXEC CICS READQ TS QUEUE(TSKØNAVN)                                   
                      ITEM(ITEMNO)                                      
                      INTO(OUTPUTELEM)                                  
                      RESP(CICSRC);                                     
 END LÆS_TSKØ;                                                          
                                                                        
 /**********************************************************************
 *    SLET TSKØ MED DE FUNDNE OPLYSNINGER.                           *  
 **********************************************************************/
 SLET_TSKØ:  PROC;                                                      
   EXEC CICS DELETEQ TS QUEUE(TSKØNAVN)                                 
                        NOHANDLE;                                       
 END SLET_TSKØ;                                                         
                                                                        
 /**********************************************************************
 *    TILDEL TSKØNAVN - RETURNERE KØNAVN.                              *
 **********************************************************************/
 TILDEL_TSKØNAVN:   PROC          RETURNS(CHAR(8));                     
   ZS62002                = '';                                         
   ZS62002.FUNKTION       = '0';                                        
   ZS62002.IDENTIFIKATION = 'BQ60000' !! '1' !! EIBTRNID;               
   EXEC CICS LINK PROGRAM('ZS62002')                                    
                  COMMAREA(ZS62002)                                     
                  RESP(CICSRC);                                         
                                                                        
   RETURN(ZS62002.TSQNAVN);                                             
 END TILDEL_TSKØNAVN;                                                   
                                                                        
 /**********************************************************************
 *    ABEND PÅ EN PÆN MÅDE                                             *
 **********************************************************************/
 ABEND_PROCEDURE:  PROC;                                                
   ZS378FUNK  = '04';         /* AFSLUT, COMMAREA SLETTES     */        
   ZS378TYPE  = 'CICS';                                                 
   ZS378MODUL = 'BQ60000';                                              
   %INCLUDE ZS37802M;                                                   
 END ABEND_PROCEDURE;                                                   
                                                                        
 %INCLUDE ZX23000G         /* GETMAIN RUTINE     */;                    
 %INCLUDE ZX23000F         /* FREEMAIN RUTINE     */;                   
 END BQ60000;                                                           
