  PROCESS OPT(TIME);                                                    
 BH99700: /* UDTRÆK PERSONER MED 2 EL. FLERE UDENLANDSKE EJENDOMME */   
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /*********************************************************************/
         DCL COPYRIGHT   CHAR      (30) STATIC                          
         INIT ('COPYRIGHT KOMMUNEDATA I/S 2007');                       
 /**********************************************************************
 *                                                                     *
 * FORMÅL : UDTRÆKKE PERSONER MED 2 EL. FLERE UDENLANDSKE EJENDOMME    *
 *          I.F.M. OPERTTELSEN.                                        *
 *                                                                     *
 * INPUT  : B.H96000D  BEREGNINGSBÅND TIL SLUT 2007                    *
 *          BQ30000T   EVS EJERSKABSTABEL.                             *
 *                                                                     *
 * OUTPUT : B.H99700D  UDTRÆK - LISTE MED PERSONER MED MIN 2 UDL. EJD. *
 *          BH99701Y   KØRSELSKONTROLLISTE                             *
 *                                                                     *
 * PROGRAMMØR: BO SCHMIDT      JANUAR    2008                          *
 *                                                                     *
 **********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
         EXEC SQL INCLUDE SQLCA;        /* SQL KOMMUNIKATIONSAREAL    */
         EXEC SQL INCLUDE BQ30000T;     /* EVS SLUT EJERSKABSTABEL    */
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH960I  FILE RECORD INPUT;     /* BEREGN.BÅND EFTER BEREGN. */ 
 DCL     BH997O  FILE RECORD OUTPUT;    /* UDTRÆK TIL LISTE          */ 
 /********************************************************************* 
 *       DECLARE AF UDTRÆK                                            * 
 *********************************************************************/ 
 DCL     BH960_AR        CHAR (23472) VAR;                              
 DCL     1 BH960         BASED     (ADDR(BH960_AR)),                    
           2 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90000N;;                                          
                                                                        
 DCL     1 UDT,                                                         
           2 SORT_CPR    DEC FIXED (11);                                
                                                                        
 /********************************************************************* 
 *       DECLARE AF UDTRÆK TIL LISTE                                  * 
 *********************************************************************/ 
 DCL     1 BH997,                                                       
           3 DCPRN          PIC '(10)9',                                
           3 FYLD1          CHAR (1),                                   
           3 EKOMNR         PIC '999',                                  
           3 EEJDNR         PIC '(6)9',                                 
           3 FYLD2          CHAR (1),                                   
           3 EJDBELIG       CHAR (32),                                  
           3 FYLD3          CHAR (1),                                   
           3 DOVTG          CHAR (10),                                  
           3 FYLD4          CHAR (1),                                   
           3 GPCTEJER       PIC  '999V,99',                             
           3 FYLD5          CHAR (1),                                   
           3 CLANDEKODE     CHAR (2);                                   
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 DCL     1 TV,                   /* TÆLLEVÆRKER TIL TOTALLISTEN */      
           2 LÆS_BH960    FIXED DEC (11),                               
           2 LÆS_UDT      FIXED DEC (11),                               
           2 BH997_SKRIV  FIXED DEC (11);                               
                                                                        
 /********************************************************************* 
 *       DECLARE AF BUILTIN'S                                         * 
 *********************************************************************/ 
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 /********************************************************************* 
 *       DECLARE AF ENTRY'S                                           * 
 *********************************************************************/ 
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    LIN_DEB          CHAR      (133);                               
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH96100L'),                                        
           2 F1          CHAR      (25)      INIT      (' '),           
           2 TEKST2      CHAR      (57)      INIT      (                
           'LISTE OVER PERSONER MED MIN. 2 UDENLANDSKE EJD. '),         
           2 F2          CHAR      (12)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'ZZ.ZZZ.ZZZ.ZZZ',                    
           2 F2          CHAR      (58)      INIT      (' ');           
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
 EXTERNAL INIT ('NOTEST(ALL,,;)');                                      
 DCL     EOF_BH960       BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     ABENDMEDD       CHAR      (56)    INIT(' ');                   
                                                                        
 DCL     SQLKODE         PIC       '9999';                              
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BH960 = NEJ;                                               
                                                                        
         ON ERROR                                                       
            CALL PLIDUMP ('SNHOB');                                     
                                                                        
         OPEN FILE (BH960I)  TITLE ('BH96000I');                        
         OPEN FILE (BH997O)  TITLE ('BH99700O');                        
                                                                        
         ON ENDFILE (BH960I)                                            
            EOF_BH960 = JA;                                             
                                                                        
         CALL ZZ20390 ('*OPEN','BH99701Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
                                                                        
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS1;                                        
         OVERLIN2.CCA   = ZZWS2;                                        
                                                                        
         TV = 0;                                                        
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
         CALL DECLARE_CURSOR;                                           
         CALL OPEN_CURSOR;                                              
                                                                        
         CALL FETCH_CURSOR;                                             
         CALL LÆS_BH960;                                                
                                                                        
         DO WHILE (EOF_BH960 = NEJ);                                    
                                                                        
            DO WHILE (UDT.SORT_CPR < BH960.SORT_CPR);                   
              CALL FETCH_CURSOR;                                        
            END;                                                        
                                                                        
            IF UDT.SORT_CPR = BH960.SORT_CPR                            
            THEN                                                        
               CALL BEHANDEL;                                           
                                                                        
            CALL LÆS_BH960;                                             
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS UDTRÆK FRA ESR                                           * 
 *********************************************************************/ 
 LÆS_BH960: PROC;                                                       
                                                                        
         READ FILE (BH960I) INTO (BH960_AR);                            
                                                                        
         IF BH960.SORT_CPR = 99999999999     /* OPTÆLL.INDV. 1 */       
         THEN                                                           
            READ FILE (BH960I) INTO (BH960_AR);                         
                                                                        
         IF EOF_BH960 = NEJ                                             
         THEN                                                           
            TV.LÆS_BH960 = TV.LÆS_BH960 + 1;                            
                                                                        
 END LÆS_BH960;                                                         
 /********************************************************************* 
 *       PERSONER SOM EVT. SKAL BEREGNES                              * 
 *********************************************************************/ 
 BEHANDEL: PROC;                                                        
                                                                        
         IF BH960.SORT_KOMNR ^= 999                                     
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF (BH960.TIL_EVS.DAFSTAA > 0 &                                
             BH960.TIL_EVS.DAFSTAA < BH960.MT.DRGNÅRFRA)                
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF BH960.FEJLNR = 5001 !                                       
           (BH960.TIL_EVS.CEJBEVS = '1' & BH960.FEJLNR = 5008) !        
            BH960.FEJLNR = 5020 !                                       
            BH960.FEJLNR = 5060                                         
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF BH960.MT.CCIVS = 'D' &                                      
            BH960.MT.HIST_OPL(2007).DCIÆN > 0 &   /* EJER ER DØD   */   
           (BH960.MT.HIST_OPL(2007).DCIÆN <       /* FØR INDK.ÅRET */   
            BH960.MT.DRGNÅRFRA)                                         
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF BH960.CINVPNR > '0'                                         
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF BH960.CKUN_SLS = '1'                                        
         THEN                                                           
            RETURN;                                                     
                                                                        
         CALL SKRIV_BH997;                                              
                                                                        
 END BEHANDEL;                                                          
 /*********************************************************************/
 /*    SKRIV PÅ FLAT SEKV DATASÆT DER OVERFØRES VIA EXCL              */
 /*********************************************************************/
 SKRIV_BH997: PROC;                                                     
                                                                        
      BH997.FYLD1 = ';';                                                
      BH997.FYLD2 = ';';                                                
      BH997.FYLD3 = ';';                                                
      BH997.FYLD4 = ';';                                                
      BH997.FYLD5 = ';';                                                
                                                                        
      BH997.DCPRN      = BH960.SORT_CPR;                                
      BH997.EKOMNR     = BH960.SORT_KOMNR;                              
      BH997.EEJDNR     = BH960.SORT_EJDNR;                              
      BH997.EJDBELIG   = BH960.EJENDOM.EJDBELIG;                        
      BH997.CLANDEKODE = BH960.EJENDOM.CLANDEKODE;                      
                                                                        
      IF BH960.TIL_EVS.DOVTG > 0                                        
      THEN                                                              
         BH997.DOVTG = FIX09_TIL_DB2_DATO(BH960.TIL_EVS.DOVTG);         
      ELSE                                                              
         BH997.DOVTG = (10)' ';                                         
                                                                        
      IF BH960.TIL_EVS.GPCTEJER_SW = 0                                  
      THEN                                                              
         BH997.GPCTEJER = BH960.TIL_EVS.GPCTEJER;                       
      ELSE                                                              
         BH997.GPCTEJER = 0;                                            
                                                                        
      WRITE FILE(BH997O) FROM(BH997);                                   
                                                                        
      TV.BH997_SKRIV = TV.BH997_SKRIV + 1;                              
                                                                        
 END SKRIV_BH997;                                                       
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
         SQLKODE = SQLCA.SQLCODE;                                       
         CLOSE FILE (BH960I),                                           
               FILE (BH997O);                                           
         CALL CLOSE_CURSOR;                                             
         CALL ZS67000(SQLCA);                                           
                                                                        
         ABENDMEDD = 'BH99700 ** 250 SQL FEJL ' !! SQLKODE;             
                                                                        
         CALL ZS30101 (5, ABENDMEDD, 2);                                
                                                                        
 END SQL_FEJL;                                                          
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE: PROC;                                                      
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_BH960;                                  
         DETLIN1.TEKST = 'ANTAL LÆSTE PÅ UDTRÆK             B.H96000D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_UDT;                                    
         DETLIN1.TEKST = 'ANTAL LÆSTE PÅ UDTRÆK              BQ30000T'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.BH997_SKRIV;                                
         DETLIN1.TEKST = 'ANTAL SKREVNE INDIVIDER           B.H99700D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
 END TOTALLISTE;                                                        
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 AFSLUT: PROC;                                                          
                                                                        
         CALL TOTALLISTE;                                               
         CALL ZZ20300((133)' ','99');                                   
         CLOSE FILE (BH960I),                                           
               FILE (BH997O);                                           
         CALL CLOSE_CURSOR;                                             
                                                                        
 END AFSLUT;                                                            
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                 */
 /*********************************************************************/
 DECLARE_CURSOR: PROC;                                                  
                                                                        
         EXEC SQL DECLARE UDT_CURSOR CURSOR FOR                         
                                                                        
         SELECT DISTINCT(T1.DCPRN)                                      
         FROM  BQ30000T T1,                                             
               BQ30000T T2                                              
         WHERE T1.DINDKAAR = 2007                                       
          AND  T1.EKOMNR   = 999                                        
          AND  T1.DTILGLD  = '9999-12-31-23.59.59.999999'               
          AND  T1.DINDKAAR = T2.DINDKAAR                                
          AND  T1.DCPRN    = T2.DCPRN                                   
          AND  T1.EKOMNR   = T2.EKOMNR                                  
          AND  T1.EEJDNR  ^= T2.EEJDNR                                  
          AND  T1.ELBNR    = T2.ELBNR                                   
          AND  T1.EGENNR   = T2.EGENNR                                  
          AND  T1.DTILGLD  = T2.DTILGLD                                 
                                                                        
         FOR READ ONLY;                                                 
                                                                        
 END DECLARE_CURSOR;                                                    
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                   */
 /*********************************************************************/
 FETCH_CURSOR: PROC;                                                    
                                                                        
         EXEC SQL FETCH UDT_CURSOR                                      
                                                                        
         INTO :UDT.SORT_CPR;                                            
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0)                                                     
             DO;                                                        
               TV.LÆS_UDT = TV.LÆS_UDT + 1;                             
             END;                                                       
           WHEN (100)                                                   
             DO;                                                        
               UDT.SORT_CPR = 9999999999;                               
             END;                                                       
           OTHERWISE                                                    
             DO;                                                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END;                                                           
                                                                        
 END FETCH_CURSOR;                                                      
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BQ30000T                      RUTINE */
 /*********************************************************************/
 OPEN_CURSOR: PROC;                                                     
                                                                        
         EXEC SQL OPEN UDT_CURSOR;                                      
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_CURSOR;                                                       
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BQ30000T                     RUTINE */
 /*********************************************************************/
 CLOSE_CURSOR: PROC;                                                    
                                                                        
         EXEC SQL CLOSE UDT_CURSOR;                                     
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_CURSOR;                                                      
                                                                        
 /********************************************************************* 
 *       DIVERSE INCLUDES                                             * 
 *********************************************************************/ 
                                                                        
         %INCLUDE BH00003M;                    /* FIX09_TIL_DB2_DATO  */
                                                                        
      ; /* UNDGÅ PROBLEMER MED LABEL */                                 
 DCL 1 ZM,                                                              
       2  DUMMY           CHAR (01);                                    
 END  BH99700;                                                          
