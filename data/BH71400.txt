 PROCESS OPT(TIME);                                                     
 BH71400:   /* OPDEL ESR-UDTRÆK I EJENDOMME MED 2 EJERE OG ØVR. EJD. */ 
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /********************************************************************/ 
  DCL COPYRIGHT   CHAR (30) STATIC    INIT ('COPYRIGHT KMD A/S 2013');  
 /********************************************************************* 
 /*                                                                   */
 /* FORMÅL: LÆSER ET DATASÆT OG UD FRA PARAMETER OPDATERER DEN VUDERIN*/
 /*          GSÅR NY OG GAMMEL. OPRETTET SOM KOPI AF BH71400L FOR     */
 /*          AT KUNNE GENBRUGE DATASÆT FRA SLUT 2017 SUP              */
 /*                                                                   */
 /*Parameterfil udfyldes således:                                     */
 /*>>BH71400202520241                                                 */
 /**********-----------------------programnavn                        */
 /*         ****-----------------------nyt_aar                        */
 /*             ****-----------------------GL_aar                     */
 /*                 *------------------------kode forskud = 1, slut= 2*/
 /*                  **----------------------trace kode 00 - 12       */
 /*  JCL ligger på BZTSO: UDV.BEVS.F25.JCL.T2(BH71400T)               */
 /*                                                                   */
 /*  EBD: Version til BF flytter altid  + 2 år                        */
 /*                                                                   */
 /*SLUT2024    :Per Jensen, PEN                        17-10-2023     */
 /*             Implementering af vurderinger for 2022                */
 /*SLUT2024    :Jan Jensen, JJJ                        12-02-2024     */
 /*             Rulning af årstal fra 2024 datasæt til 2023           */
 /********************************************************************/ 
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
  /*       DEFAULT RANGE (*) STATIC;   */                               
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL  PARMFIL      FILE RECORD INPUT;                                   
 DCL  BH714I       FILE RECORD INPUT;                                   
 DCL  BH714O       FILE RECORD OUTPUT;                                  
 DCL  SYSPRINT     FILE OUTPUT;                                         
                                                                        
 DCL  1 PARM,                                                           
         03 IDENT          CHAR (09)   init (''),                       
         03 NY_AAR         PIC '(04)9' init (0),                        
         03 GL_AAR         PIC '(04)9' init (0),                        
         03 EVS_KODE       PIC '(01)9' init (0), /*1=forskud,2=slut*/   
         03 TRACE_KD       PIC '(02)9' init (0),                        
         03 FILLER         CHAR(60);                                    
                                                                        
 /********************************************************************* 
 *       DECLARE AF                                   *                 
 *********************************************************************/ 
 DCL     BH714_AR        CHAR      (2000) VAR;                          
 DCL     1 BH714         BASED     (ADDR(BH714_AR)),                    
           4 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH31824N;      /* GL ESR STRUKTUR*/                 
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     EOF_BH714       BIT       (1);                                 
 DCL     EOF_PARMFIL               CHAR      (01)  INIT(' ');           
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
 DCL     1 TV,                                                          
           2 LÆS_BH714   FIXED DEC (31)    INIT(0),                     
           2 SKRIV_BH714 FIXED DEC (31)    INIT(0);                     
                                                                        
 DCL PROGRAM_ID          CHAR (08)  INIT('BH71400');                    
 DCL MODUL_NAVN          CHAR (08)  INIT('BH71400');                    
 DCL HJ_MAX              FIXED DEC(9) INIT(0);                          
 DCL HJ_MIN              FIXED DEC(9) INIT(0);                          
 DCL HJ_AAR              FIXED DEC(9) INIT(0);                          
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     MOD             BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
                                                                        
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BH714 = NEJ;                                               
                                                                        
         ON ENDFILE (PARMFIL)                                           
         BEGIN;                                                         
          EOF_PARMFIL = '1';                                            
         END;                                                           
                                                                        
         OPEN FILE (PARMFIL) TITLE ('BH71400C') INPUT;                  
         READ FILE (PARMFIL) INTO (PARM);                               
         CLOSE FILE (PARMFIL);                                          
         PUT SKIP LIST('PARMFIL ' !! PARM);                             
                                                                        
         OPEN FILE (BH714I)  TITLE ('BH71400I');                        
         OPEN FILE (BH714O)  TITLE ('BH71400O');                        
                                                                        
         ON ENDFILE(BH714I)                                             
         BEGIN;                                                         
            EOF_BH714 = JA;                                             
         END;                                                           
                                                                        
         IF PARM.TRACE_KD = ''                                          
          THEN                                                          
           PARM.TRACE_KD = 0;                                           
                                                                        
        %INCLUDE GN9TRC0N;             /*******************************/
        INPUT_TRC = PARM.TRACE_KD;     /* OPSÆTNING AF TRACEPARAMETER */
        %INCLUDE GN9TRC0M;             /*******************************/
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
    IF PROC_TRC THEN CALL STRT_PROC('START PROGRAM BH71400');           
                                                                        
         /* DATOER SKAL VÆRE INDENFOR TO ÅR */                          
         IF PARM.EVS_KODE = 2 & /*EVS SLUT ruller tilbage*/             
            PARM.NY_AAR < PARM.GL_AAR THEN                              
           DO;                                                          
             HJ_AAR = PARM.GL_AAR;                                      
             HJ_MAX = HJ_AAR * 10000 + 1231;                            
             HJ_MIN = HJ_AAR * 10000 + 0101;                            
           END;                                                         
         ELSE                                                           
           DO;                  /*Ruller frem*/                         
             HJ_AAR = PARM.GL_AAR;                                      
             HJ_MAX = (HJ_AAR -1) * 10000 + 1231;                       
             HJ_MIN = (HJ_AAR -2) * 10000 + 0101;                       
           END;                                                         
                                                                        
         PUT SKIP LIST('HJ_AAR :',HJ_AAR);                              
         PUT SKIP LIST('MAX DATO:',HJ_MAX);                             
         PUT SKIP LIST('MIN DATO:',HJ_MIN);                             
                                                                        
                                                                        
         CALL LÆS_BH714;                                                
         DO WHILE (EOF_BH714 = NEJ);                                    
           /* Tilføjet 7/2-2022 EBD  */                                 
           IF BH714.DCPRCIR < 9999999999 THEN                           
             DO;                                                        
               IF PARM.EVS_KODE = 2 & /*EVS SLUT*/                      
                  PARM.NY_AAR < PARM.GL_AAR THEN                        
                 DO;                                                    
                   IF BH714.DOVTG >= HJ_MIN &                           
                      BH714.DOVTG <= HJ_MAX THEN                        
                     BH714.DOVTG = BH714.DOVTG - 10000;                 
                                                                        
                   IF BH714.DAFSTÅ >= HJ_MIN &                          
                      BH714.DAFSTÅ <= HJ_MAX THEN                       
                     BH714.DAFSTÅ = BH714.DAFSTÅ - 10000;               
                                                                        
                   IF BH714.DAFGDAT >= HJ_MIN &                         
                      BH714.DAFGDAT <= HJ_MAX THEN                      
                         BH714.DAFGDAT = BH714.DAFGDAT - 10000;         
                                                                        
                   IF BH714.DSKØDE >= HJ_MIN &                          
                      BH714.DSKØDE <= HJ_MAX THEN                       
                         BH714.DSKØDE = BH714.DSKØDE - 10000;           
                                                                        
                   IF BH714.DSLUTS  >= HJ_MIN &                         
                      BH714.DSLUTS  <= HJ_MAX THEN                      
                         BH714.DSLUTS = BH714.DSLUTS - 10000;           
                                                                        
                   SELECT(BH714.SKATSTOP.DSTOPÅR);                      
                     WHEN('2022')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2021';                 
                     WHEN('2023')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2022';                 
                     WHEN('2024')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2023';                 
                     OTHER;                                             
                   END; /*SELECT*/                                      
                                                                        
                   SELECT(BH714.VURDOPLNY.DVURDÅR);                     
                     WHEN('2020')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2019';                
                     WHEN('2021')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2020';                
                     WHEN('2022')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2021';                
                     WHEN('2023')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2022';                
                     WHEN('2024')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2023';                
                     OTHER;                                             
                   END;                                                 
                                                                        
                   SELECT(BH714.VURDOPLGL.DVURDÅR);                     
                     WHEN('2020')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2019';                
                     WHEN('2021')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2020';                
                     WHEN('2022')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2021';                
                     WHEN('2023')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2022';                
                     WHEN('2024')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2023';                
                     OTHER;                                             
                   END;                                                 
                                                                        
                   SELECT(BH714.SKATSTOP.DSTOPÅR);                      
                     WHEN('2022')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2021';                 
                     WHEN('2023')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2022';                 
                     WHEN('2024')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2023';                 
                     OTHER;                                             
                   END; /*SELECT*/                                      
                 END;                                                   
                                                                        
               ELSE                                                     
                                                                        
                 DO;                                                    
                   /*                                                   
                   IF BH714.DOVTG >= HJ_MIN &                           
                      BH714.DOVTG <= HJ_MAX                             
                   THEN                                                 
                     DO;                                                
                       BH714.DOVTG = BH714.DOVTG + 10000;               
                     END;                                               
                   */                                                   
                                                                        
                                                                        
                   IF BH714.DAFSTÅ >= HJ_MIN &                          
                      BH714.DAFSTÅ <= HJ_MAX                            
                   THEN                                                 
                     DO;                                                
                      IF PARM.EVS_KODE = 2 /*EVS SLUT*/                 
                        THEN                                            
                         BH714.DAFSTÅ = BH714.DAFSTÅ + 20000;           
                      ELSE                                              
                         BH714.DAFSTÅ = BH714.DAFSTÅ + 10000;           
                     END;                                               
                                                                        
                   IF BH714.DAFGDAT >= HJ_MIN &                         
                      BH714.DAFGDAT <= HJ_MAX                           
                   THEN                                                 
                     DO;                                                
                      IF PARM.EVS_KODE = 2 /*EVS SLUT*/                 
                        THEN                                            
                         BH714.DAFGDAT = BH714.DAFGDAT + 20000;         
                      ELSE                                              
                         BH714.DAFGDAT = BH714.DAFGDAT + 10000;         
                     END;                                               
                                                                        
                   IF BH714.DSKØDE >= HJ_MIN &                          
                      BH714.DSKØDE <= HJ_MAX                            
                   THEN                                                 
                     DO;                                                
                      IF PARM.EVS_KODE = 2 /*EVS SLUT*/                 
                        THEN                                            
                         BH714.DSKØDE = BH714.DSKØDE + 20000;           
                      ELSE                                              
                         BH714.DSKØDE = BH714.DSKØDE + 10000;           
                     END;                                               
                                                                        
                   IF BH714.DSLUTS  >= HJ_MIN &                         
                      BH714.DSLUTS  <= HJ_MAX                           
                   THEN                                                 
                     DO;                                                
                      IF PARM.EVS_KODE = 2 /*EVS SLUT*/                 
                        THEN                                            
                         BH714.DSLUTS = BH714.DSLUTS + 20000;           
                      ELSE                                              
                         BH714.DSLUTS = BH714.DSLUTS + 10000;           
                     END;                                               
                                                                        
                   SELECT(BH714.SKATSTOP.DSTOPÅR);                      
                     WHEN('2022')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2023';                 
                     WHEN('2023')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2024';                 
                     WHEN('2024')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2025';                 
                     OTHER;                                             
                   END; /*SELECT*/                                      
                 END;                                                   
                                                                        
               IF PARM.EVS_KODE = 2 /*EVS SLUT*/                        
               THEN                                                     
                 DO;                                                    
                   SELECT(BH714.VURDOPLNY.DVURDÅR);                     
                     WHEN('2020')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2022';                
                     WHEN('2021')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2023';                
                     WHEN('2022')                                       
                       BH714.VURDOPLNY.DVURDÅR = '2024';                
                     OTHER;                                             
                   END;                                                 
                                                                        
                   SELECT(BH714.VURDOPLGL.DVURDÅR);                     
                     WHEN('2020')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2022';                
                     WHEN('2021')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2023';                
                     WHEN('2022')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2024';                
                     OTHER;                                             
                   END;                                                 
                   SELECT(BH714.SKATSTOP.DSTOPÅR);                      
                     WHEN('2022')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2024';                 
                     WHEN('2023')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2025';                 
                     WHEN('2024')                                       
                       BH714.SKATSTOP.DSTOPÅR = '2026';                 
                     OTHER;                                             
                   END; /*SELECT*/                                      
                 END;                                                   
               ELSE /*Kun gl. år rettese for EVS Forskud*/              
                 DO;                                                    
                   SELECT(BH714.VURDOPLGL.DVURDÅR);                     
                     WHEN('2022')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2023';                
                     WHEN('2023')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2024';                
                     WHEN('2024')                                       
                       BH714.VURDOPLGL.DVURDÅR = '2025';                
                     OTHER;                                             
                   END;                                                 
                 END;                                                   
             END;                                                       
                                                                        
          CALL SKRIV_BH714;                                             
          CALL LÆS_BH714;                                               
         END;  /*END DO*/                                               
                                                                        
         CALL AFSLUT;                                                   
                                                                        
                                                                        
 /********************************************************************* 
 *       LÆS ESR UDTRÆK                                               * 
 *********************************************************************/ 
 LÆS_BH714: PROC;                                                       
                                                                        
   IF PROC_TRC THEN CALL STRT_PROC('LÆS_BH714');                        
                                                                        
         READ FILE (BH714I) INTO (BH714_AR);                            
                                                                        
         IF EOF_BH714 = NEJ                                             
         THEN                                                           
            TV.LÆS_BH714 = TV.LÆS_BH714 + 1;                            
                                                                        
   IF PROC_TRC THEN CALL SLUT_PROC;                                     
                                                                        
 END LÆS_BH714;                                                         
 /********************************************************************* 
 *       SKRIV FIL                                                    * 
 *********************************************************************/ 
 SKRIV_BH714: PROC;                                                     
                                                                        
         IF PROC_TRC THEN CALL STRT_PROC('SKRIV_BH714');                
                                                                        
         WRITE FILE (BH714O) FROM (BH714_AR);                           
                                                                        
         TV.SKRIV_BH714 = TV.SKRIV_BH714 + 1;                           
                                                                        
          IF PROC_TRC THEN CALL SLUT_PROC;                              
                                                                        
 END SKRIV_BH714;                                                       
 /********************************************************************/ 
 AFSLUT: PROC;                                                          
         IF PROC_TRC THEN CALL STRT_PROC('AFSLUT');                     
                                                                        
         CLOSE FILE (BH714I),                                           
               FILE (BH714O);                                           
                                                                        
         PUT SKIP LIST ('ANTAL LÆSTE   ' !! TV.LÆS_BH714);              
         PUT SKIP LIST ('ANTAL SKREVNE ' !! TV.SKRIV_BH714);            
                                                                        
                                                                        
         IF PROC_TRC THEN CALL SLUT_PROC;                               
 END AFSLUT;                                                            
                                                                        
 END  BH71400;                                                          
