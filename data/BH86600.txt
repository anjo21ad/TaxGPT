 BH86600: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS FORSKUD / EVS SLUT                                 *
 * PROGRAMNAVN: BH86600.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    Konvertering af MT til DB2-tabeller                    *
 *              til ønsket år ifølge parameterfil                      *
 * PGMFORLØB:   1. Slet data i tabeller for ønsket år/afv.id           *
 *              2. Læs Mandtal seq dataset                             *
 *              3. Check hvilken type input og vælg korrekt struktur   *
 *              4. SKRIV RÆKKER PÅ DB2-TABELLER                        *
 *              5. SKRIV KONTROLLISTE.                                 *
 * INDDATA:     Mandtal dataset (type iflg. BH86PI)                    *
 *                  MT1 - BR84250N                                     *
 *                  MT2 - BH65300N                                     *
 *                                                                     *
 * UDDATA:      BH86601Y - KONTROLLISTE.                               *
 *              BQ66000T - MT-OPLYSNINGER                              *
 ***********************************************************************
 * OPRETTET   : Lene Maj Jensen   QLE             BALLERUP 26.02.2018  *
 * RETTET     : Esben Brodersen   EBD             BALLERUP 26.09.2018  *
 * RULLET BR84250N -> BR84250N                                         *
 **********************************************************************/
 /* Slut 2020 : Elena Flygenring EFL                       marts 2021 */
 /*              - struktur BH65300M erstattes med BH55300M           */
 /*              - struktur BH65300N erstattes med BH65321N           */
 /*              - Brug af FILE BH866I og BH866_PARM fjernes          */
 /*              - BH866_PARM.FS_MRK fjernes                          */
 /*              - BH866_PARM.FORSKUD_TXT, SLUT_TXT, SUPPL_TXT fjernes*/
 /*                erstattes med brug af BH55300M.AFVIKLINGS_ID       */
 /*              - BH866_PARM.AAR fjernes                             */
 /*                erstattes med brug af BH55300M.TIL_EVS_AAR         */
 /*              - BQ66000T: nyt felt DATA_ID tilføjet                */
 /* FORSKUD2023: Per Brunk                                 08.06.2022 */
 /*              Årsrul                                               */
 /*********************************************************************/
 /* RETTET     : Jan Jensen   JJJ                BALLERUP 01.03.2024  */
 /* RULLET BH65324N -> BH65325N                                       */
 /* Slut 2024 : Jan Jensen JJJ                              Juni 2024 */
 /*              - BH55600M erstatter BH55300M                        */
 /*********************************************************************/
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KOMMUNEDATA A/S 2006');    
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     BH86PI FILE RECORD INPUT;     /* Styring af inputtype   */     
 DCL     BHMT0I FILE RECORD INPUT;     /* MT-fil                 */     
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
 /*********************************************************************/
 /* DECLARE AF Øvrige filer                                           */
 /*********************************************************************/
                                                                        
 DCL     1 KOER_PARM,  /* styrer hvilket input der benyttes */          
         3 KØRSELS_ID        CHAR(5),  /* MT1, MT2, ESR1, ESR2 osv */   
         3 REST              CHAR(75);                                  
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
         EXEC SQL INCLUDE BQ66000T;  /* MANDTAL              */         
                                                                        
 DCL     1 MT,                                                          
         %INCLUDE BQ6600TN;                                             
                                                                        
 /*********************************************************************/
 /*      DECLARE AF includes til mt-filer                             */
 /* hvilken struktur der benyttes er parameterstyret                  */
 /*********************************************************************/
                                                                        
             /* MT BR84250N */                                          
 DCL     BR842_AR        CHAR      (2000) VAR;   /*RUL*/                
                                                                        
 DCL     1 BR842         BASED(ADDR(BR842_AR)), /*RUL*/                 
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BR84250N;                   /*RUL*/                 
                                                                        
 DCL     1 BR84259       BASED(ADDR(BR842_AR)), /*RUL*/                 
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BR84259N;                   /*RUL*/                 
                                                                        
         /* MT BH65300N */                                              
 DCL     BH653_AR        CHAR      (2000) VAR;   /*RUL*/                
 DCL     1 BH653        BASED(ADDR(BH653_AR)), /*RUL*/                  
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH65325N;;                 /* RUL */                
                                                                        
 DCL     1 BH65399       BASED(ADDR(BH653_AR)), /*RUL*/                 
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH65399N;                   /*RUL*/                 
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
 DCL     WS_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                    
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
                                                                        
 DCL     WS_KØRSELS_ID                 CHAR(5);                         
                                                                        
 DCL     WS_GLSLUTÅR                    BIN FIXED (15);                 
                                                                        
 DCL     WS_TIL_EVS_AAR_GL              BIN FIXED (15);                 
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_Z_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                  
                                                                        
 DCL     WS_Z_TIL_EVS_AAR                 BIN FIXED (15);               
                                                                        
 DCL     WS_PROGRAMNAVN         CHAR(8)  INIT ('BH86600');              
                                                                        
 DCL     1 BH866_PARM,                                                  
           %INCLUDE BH86600N;                                           
                                                                        
 DCL     1 BH88Z_PARM,                                                  
           %INCLUDE BH86600N;                                           
                                                                        
 DCL     1 BH55600M,                                                    
           %INCLUDE BH55600M;                                           
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF_BH88P       BIT       (01)      INIT      ('0'B);          
 DCL     EOF_BHMT       BIT       (01)      INIT      ('0'B);           
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
 DCL     MATCH_FUNDET    BIT       (1)     INIT ('0'B);                 
 DCL     TEST_PUT        BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     AAR_SIDSTE   pic '9999';  /* benyttes i sidste_ */             
 DCL     AAR_DETTE    pic '9999';  /* benyttes i dette_ */              
 DCL     AAR_NAESTE   pic '9999';  /* benyttes i naeste_ */             
                                                                        
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF ABEND STRUKTUR m.v.                               */
 /*                                                                   */
 /*********************************************************************/
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH86600'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER TIL KONTROLLISTEN                     */
 /*********************************************************************/
                                                                        
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (1),                                 
          2 FILLER       CHAR      (132)     INIT      (' ');           
                                                                        
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (1),                                 
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH86600L'),                                        
           2 F1          CHAR      (23)      INIT      (' '),           
           2 TEKST2      CHAR      (43)      INIT      (                
           'MT INPUT TIL BEREGNING '),                                  
           2 ÅR          PIC       '9999',                              
           2 F2          CHAR      (21)      INIT      ((21)' '),       
           2 TEKST4      CHAR      (14)      INIT      (                
           'UDSKREVET DEN '),                                           
           2 DATO        CHAR      (10);                                
                                                                        
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (1),                                 
           2 F1          CHAR      (53)      INIT      (' '),           
           2 TEKST1      CHAR      (79)      INIT                       
           ('KØRSELSKONTROLLISTE');                                     
                                                                        
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (1),                                 
           2 TEKST       CHAR      (53),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZ9',                       
           2 F1          CHAR      (68)      INIT      (' ');           
                                                                        
         % INCLUDE ZZ20301M;                                            
                                                                        
 /*********************************************************************/
 /*      DECLARE AF ENTRIES                                           */
 /*********************************************************************/
                                                                        
 DCL     ZS61900         ENTRY;              /* UDSKRIV SSI-DATO      */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     ADDR            BUILTIN;                                       
 DCL     NULL            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANT_INS_MT BIN FIXED (31) INIT(0);  /* HERAF INSERTED */       
 DCL     ANT_LÆS BIN FIXED (31) INIT(0);      /* LÆST PÅ MT-dataset  */ 
 /*********************************************************************/
 /* Declare af Cursors                                                */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BHMT = NEJ;                                                
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH86600L');             
            END;                                                        
                                                                        
         ON ENDFILE (BHMT0I)                                            
         BEGIN;                                                         
            EOF_BHMT = JA;                                              
            BR842.DCPRN = 9999999999;                                   
            BH653.DCPRN = 9999999999;                                   
         END;                                                           
                                                                        
         ON ENDFILE (BH86PI)                                            
         BEGIN;                                                         
            EOF_BH88P = JA;                                             
         END;                                                           
                                                                        
         OPEN FILE (BH86PI) TITLE ('BH8660PZ');                         
         OPEN FILE (BHMT0I) TITLE ('BHMT000I');                         
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
            SELECT (BH55600M.AFVIKLINGS_ID);                            
               WHEN ('OPRET_EVS_FORSK')                                 
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.TIL_EVS_AAR;        
                     OVERLIN1.TEKST2 = 'MT data FORSKUD';               
                     AAR_SIDSTE = WS_TIL_EVS_AAR - 2;                   
                     AAR_DETTE  = WS_TIL_EVS_AAR - 1;                   
                     AAR_NAESTE = WS_TIL_EVS_AAR;                       
                  END;                                                  
               WHEN ('OPRET_EVS_SLUT')                                  
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.TIL_EVS_AAR;        
                     OVERLIN1.TEKST2 = 'MT data SLUT';                  
                     AAR_SIDSTE = WS_TIL_EVS_AAR - 1;                   
                     AAR_DETTE = WS_TIL_EVS_AAR;                        
                     AAR_NAESTE = WS_TIL_EVS_AAR + 1;                   
                  END;                                                  
               WHEN ('SUPPL_EVS_SLUT')                                  
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.TIL_EVS_AAR;        
                     OVERLIN1.TEKST2 = 'MT data SUPPLEMENT';            
                     AAR_SIDSTE = WS_TIL_EVS_AAR - 1;                   
                     AAR_DETTE = WS_TIL_EVS_AAR;                        
                     AAR_NAESTE = WS_TIL_EVS_AAR + 1;                   
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
                                                                        
         READ FILE (BH86PI) INTO (KOER_PARM);                           
                                                                        
         IF EOF_BH88P = NEJ                                             
         THEN DO;                                                       
            SELECT (KOER_PARM.KØRSELS_ID);                              
               WHEN ('MT1')                                             
                  DO;                                                   
                     WS_KØRSELS_ID = KOER_PARM.KØRSELS_ID;              
                  END;                                                  
               WHEN ('MT2')                                             
                  DO;                                                   
                     WS_KØRSELS_ID = KOER_PARM.KØRSELS_ID;              
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERKFEJL';                   
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
         END;                                                           
                                                                        
         CALL ZZ20390('*OPEN','BH86601Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
         OVERLIN1.ÅR   = GLSLUTÅR - 1;                                  
         OVERLIN1.DATO = UDDATO;                                        
         SIDELIN.CCA   = ZZIK1;                                         
         OVERLIN1.CCA  = ZZWS2;                                         
         OVERLIN2.CCA  = ZZWS3;                                         
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         CALL RYD_DB2_TABELLER; /* for:                               */
                   /* til_evs_aar   = BH55600M.TIL_EVS_AAR            */
                   /* afviklings_id = BH55600M.BH55600M.AFVIKLINGS_ID */
                   /* kørsels_id    = koer_parm.kØRSELS_ID            */
                                                                        
         IF WS_KØRSELS_ID = 'MT1'                                       
         then do;                                                       
            CALL BEHANDL_MT1;                                           
         end;                                                           
                                                                        
         IF WS_KØRSELS_ID = 'MT2'                                       
         then do;                                                       
            CALL BEHANDL_MT2;                                           
         end;                                                           
                                                                        
         exec sql commit;                                               
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* Behandl MT med struktur BH31800N                                  */
 /*********************************************************************/
 BEHANDL_MT1: PROC;                                                     
                                                                        
         CALL LÆS_MT1_DATASET;                                          
                                                                        
         DO WHILE (^EOF_BHMT);                                          
                                                                        
            /* Start med at nulstille output struktur */                
            DCLBQ66000T = '';                                           
                                                                        
            /* flyt data fra MT-dataset til db2-struktur */             
            CALL FLYT_FELTER_BR842;                                     
                                                                        
            CALL INSERT_MTOPL;                                          
                                                                        
            CALL LÆS_MT1_DATASET;                                       
         END;                                                           
                                                                        
 END BEHANDL_MT1;                                                       
                                                                        
 /*********************************************************************/
 /* Behandl MT med struktur BH6532xN                                  */
 /*********************************************************************/
 BEHANDL_MT2: PROC;                                                     
                                                                        
         CALL LÆS_MT2_DATASET;                                          
                                                                        
         DO WHILE (^EOF_BHMT);                                          
                                                                        
            /* Start med at nulstille output struktur */                
            DCLBQ66000T = '';                                           
                                                                        
            /* flyt data fra MT-dataset til db2-struktur */             
            CALL FLYT_FELTER_BH653;                                     
                                                                        
            CALL INSERT_MTOPL;                                          
                                                                        
            CALL LÆS_MT2_DATASET;                                       
         END;                                                           
                                                                        
 END BEHANDL_MT2;                                                       
 /*********************************************************************/
 /* Læs MT dataset med BH31800N struktur                              */
 /*********************************************************************/
 LÆS_MT1_DATASET: PROC;                                                 
                                                                        
       EOF_BHMT = '0'B;                                                 
                                                                        
       READ FILE (BHMT0I) INTO (BR842_AR);                              
                                                                        
       ANT_LÆS = ANT_LÆS + 1;                                           
                                                                        
       IF BR842.DCPRN >= 9999999999                                     
       THEN DO;                                                         
          EOF_BHMT = '1'B;                                              
       END;                                                             
                                                                        
 END LÆS_MT1_DATASET;                                                   
                                                                        
 /*********************************************************************/
 /* Læs MT dataset med BH6532xN struktur                              */
 /*********************************************************************/
 LÆS_MT2_DATASET: PROC;                                                 
                                                                        
       EOF_BHMT = '0'B;                                                 
                                                                        
       READ FILE (BHMT0I) INTO (BH653_AR);                              
                                                                        
       ANT_LÆS = ANT_LÆS + 1;                                           
                                                                        
       IF BH653.DCPRN >= 9999999999                                     
       THEN DO;                                                         
          EOF_BHMT = '1'B;                                              
       END;                                                             
                                                                        
 END LÆS_MT2_DATASET;                                                   
                                                                        
 /*********************************************************************/
 /* FLYT FELTER FRA MT1-struktur TIL DB2-STRUKTURER  FRA FORSKUD      */
 /*********************************************************************/
 FLYT_FELTER_BR842: PROC;                                               
                                                                        
    MT = '';                                                            
    MT.TIL_EVS_AAR = WS_TIL_EVS_AAR;                                    
    MT.AFVIKLINGS_ID = WS_FORSKUD_SLUT_TXT;                             
    MT.DATA_ID       = BH55600M.DATA_ID;                                
    MT.KØRSELS_ID = 'MT1';                                              
                                                                        
    MT.DCPRN = BR842.DCPRN;                                             
    MT.PROGRAMNAVN = WS_PROGRAMNAVN;                                    
    MT.DB2FUNKTION = 'I';                                               
    MT.CCIVS = BR842.CCIVS;                                             
    MT.CRGN = BR842.CRGN;                                               
    MT.DSORP = BR842.DSORP;                                             
    MT.CPART = BR842.CPART;                                             
    MT.BPENSIND = BR842.BPENSIND;                                       
    MT.BPENSGR = BR842.BPENSGR;                                         
    MT.CSTATUS = BR842.CSTATUS;                                         
    MT.HIST_OPD_DETTE_DHENVN = BR842.DHENVN;                            
    MT.HIST_OPD_DETTE_CSBSK = BR842.CSBSK;                              
    MT.HIST_OPD_DETTE_CFØREFT = BR842.CFØREFT;                          
    MT.HIST_OPD_DETTE_CSKPLOM = BR842.CSKPLOM;                          
    MT.HIST_OPD_DETTE_DCIÆN = BR842.DCIÆN;                              
                                                                        
 END FLYT_FELTER_BR842;                                                 
 /*********************************************************************/
 /* FLYT FELTER FRA MT2-struktur TIL DB2-STRUKTURER  FRA FORSKUD      */
 /*********************************************************************/
 FLYT_FELTER_BH653: PROC;                                               
                                                                        
    MT = '';                                                            
    MT.TIL_EVS_AAR = WS_TIL_EVS_AAR;                                    
    MT.AFVIKLINGS_ID = WS_FORSKUD_SLUT_TXT;                             
    MT.DATA_ID       = BH55600M.DATA_ID;                                
    MT.KØRSELS_ID = 'MT2';                                              
                                                                        
    MT.PROGRAMNAVN = WS_PROGRAMNAVN;                                    
    MT.DB2FUNKTION = 'I';                                               
                                                                        
    MT.DCPRN = BH653.DCPRN;                                             
    MT.PROGRAMNAVN = WS_PROGRAMNAVN;                                    
    MT.CCIVS = BH653.CCIVS;                                             
    MT.CPENS = BH653.CPENS;                                             
    MT.CRGN = BH653.CRGN;                                               
    MT.DSORP = BH653.DSORP;                                             
    MT.CPART = BH653.CPART;                                             
    MT.CFRÅR = BH653.CFRÅR;                                             
    MT.CFRÅROPR = BH653.CFRÅROPR;                                       
    MT.DRGNÅRFRA = BH653.DRGNÅRFRA;                                     
    MT.DRGNÅRTIL = BH653.DRGNÅRTIL;                                     
    MT.BPENSIND = BH653.BPENSIND;                                       
    MT.BPENSGR = BH653.BPENSGR;                                         
    MT.CSTATUS = BH653.CSTATUS;                                         
    MT.CDØDÆGTF = BH653.CDØDÆGTF;                                       
    MT.CDUBLET = BH653.CDUBLET;                                         
    MT.CÆGTF_OK = BH653.CÆGTF_OK;                                       
    MT.CFØRFORS = BH653.CFØRFORS;                                       
    MT.CFØRCOR = BH653.CFØRCOR;                                         
    MT.CFØRPENS = BH653.CFØRPENS;                                       
    MT.COVF_DHE = BH653.COVF_DHE;                                       
    MT.FØROPL_DCIÆN_GL = BH653.FØROPL.DCIÆN_GL;                         
    MT.FØROPL_CCIVS_GL = BH653.FØROPL.CCIVS_GL;                         
    /*QEB RET TAGET FRA BK86600L*/                                      
    MT.HIST_OPD_SIDSTE_DHENVN = BH653.HIST_OPL(AAR_SIDSTE).DHENVN;      
    MT.HIST_OPD_SIDSTE_CSBSK = BH653.HIST_OPL(AAR_SIDSTE).CSBSK;        
    MT.HIST_OPD_SIDSTE_CFØREFT = BH653.HIST_OPL(AAR_SIDSTE).CFØREFT;    
    MT.HIST_OPD_SIDSTE_CSKPLOM = BH653.HIST_OPL(AAR_SIDSTE).CSKPLOM;    
    MT.HIST_OPD_SIDSTE_DCIÆN = BH653.HIST_OPL(AAR_SIDSTE).DCIÆN;        
    MT.HIST_OPD_DETTE_DHENVN = BH653.HIST_OPL(AAR_DETTE).DHENVN;        
    MT.HIST_OPD_DETTE_CSBSK = BH653.HIST_OPL(AAR_DETTE).CSBSK;          
    MT.HIST_OPD_DETTE_CFØREFT = BH653.HIST_OPL(AAR_DETTE).CFØREFT;      
    MT.HIST_OPD_DETTE_CSKPLOM = BH653.HIST_OPL(AAR_DETTE).CSKPLOM;      
    MT.HIST_OPD_DETTE_DCIÆN = BH653.HIST_OPL(AAR_DETTE).DCIÆN;          
    MT.HIST_OPD_NAESTE_DHENVN = BH653.HIST_OPL(AAR_NAESTE).DHENVN;      
    MT.HIST_OPD_NAESTE_CSBSK = BH653.HIST_OPL(AAR_NAESTE).CSBSK;        
    MT.HIST_OPD_NAESTE_CFØREFT = BH653.HIST_OPL(AAR_NAESTE).CFØREFT;    
    MT.HIST_OPD_NAESTE_CSKPLOM = BH653.HIST_OPL(AAR_NAESTE).CSKPLOM;    
    MT.HIST_OPD_NAESTE_DCIÆN = BH653.HIST_OPL(AAR_NAESTE).DCIÆN;        
    MT.PER_DERHVPER_FRA1 = BH653.PER.DERHVPER_FRA1;                     
    MT.PER_DERHVPER_TIL1 = BH653.PER.DERHVPER_TIL1;                     
    MT.PER_DERHVPER_FRA2 = BH653.PER.DERHVPER_FRA2;                     
    MT.PER_DERHVPER_TIL2 = BH653.PER.DERHVPER_TIL2;                     
    MT.PER_DERHVPER_FRA3 = BH653.PER.DERHVPER_FRA3;                     
    MT.PER_DERHVPER_TIL3 = BH653.PER.DERHVPER_TIL3;                     
    MT.PER_DERHVPER_FRA4 = BH653.PER.DERHVPER_FRA4;                     
    MT.PER_DERHVPER_TIL4 = BH653.PER.DERHVPER_TIL4;                     
    MT.PER_DERHVPER_FRA5 = BH653.PER.DERHVPER_FRA5;                     
    MT.PER_DERHVPER_TIL5 = BH653.PER.DERHVPER_TIL5;                     
                                                                        
 END FLYT_FELTER_BH653;                                                 
 /*********************************************************************/
 /* INSERT række på DB2-tabel til MT                           RUTINE */
 /*********************************************************************/
 INSERT_MTOPL: PROC;                                                    
                                                                        
         EXEC SQL                                                       
            INSERT INTO BQ66000T                                        
            (                                                           
         TIL_EVS_AAR,                                                   
         AFVIKLINGS_ID,                                                 
         DATA_ID,                                                       
         KØRSELS_ID,                                                    
         DCPRN,                                                         
         PROGRAMNAVN,                                                   
         DB2FUNKTION,                                                   
         OPRET_TS,                                                      
         CCIVS,                                                         
         CPENS,                                                         
         CRGN,                                                          
         DSORP,                                                         
         CPART,                                                         
         CFRÅR,                                                         
         CFRÅROPR,                                                      
         DRGNÅRFRA,                                                     
         DRGNÅRTIL,                                                     
         BPENSIND,                                                      
         BPENSGR,                                                       
         CSTATUS,                                                       
         CDØDÆGTF,                                                      
         CDUBLET,                                                       
         CÆGTF_OK,                                                      
         CFØRFORS,                                                      
         CFØRCOR,                                                       
         CFØRPENS,                                                      
         COVF_DHE,                                                      
         FØROPL_DCIÆN_GL,                                               
         FØROPL_CCIVS_GL,                                               
         HIST_OPD_SIDSTE_DHENVN,                                        
         HIST_OPD_SIDSTE_CSBSK,                                         
         HIST_OPD_SIDSTE_CFØREFT,                                       
         HIST_OPD_SIDSTE_CSKPLOM,                                       
         HIST_OPD_SIDSTE_DCIÆN,                                         
         HIST_OPD_DETTE_DHENVN,                                         
         HIST_OPD_DETTE_CSBSK,                                          
         HIST_OPD_DETTE_CFØREFT,                                        
         HIST_OPD_DETTE_CSKPLOM,                                        
         HIST_OPD_DETTE_DCIÆN,                                          
         HIST_OPD_NAESTE_DHENVN,                                        
         HIST_OPD_NAESTE_CSBSK,                                         
         HIST_OPD_NAESTE_CFØREFT,                                       
         HIST_OPD_NAESTE_CSKPLOM,                                       
         HIST_OPD_NAESTE_DCIÆN,                                         
         PER_DERHVPER_FRA1,                                             
         PER_DERHVPER_TIL1,                                             
         PER_DERHVPER_FRA2,                                             
         PER_DERHVPER_TIL2,                                             
         PER_DERHVPER_FRA3,                                             
         PER_DERHVPER_TIL3,                                             
         PER_DERHVPER_FRA4,                                             
         PER_DERHVPER_TIL4,                                             
         PER_DERHVPER_FRA5,                                             
         PER_DERHVPER_TIL5                                              
            )                                                           
            values                                                      
            (                                                           
            :MT.TIL_EVS_AAR,                                            
            :MT.AFVIKLINGS_ID,                                          
            :MT.DATA_ID,                                                
            :MT.KØRSELS_ID,                                             
            :MT.DCPRN,                                                  
            :MT.PROGRAMNAVN,                                            
            :MT.DB2FUNKTION,                                            
            current timestamp,                                          
            :MT.CCIVS,                                                  
            :MT.CPENS,                                                  
            :MT.CRGN,                                                   
            :MT.DSORP,                                                  
            :MT.CPART,                                                  
            :MT.CFRÅR,                                                  
            :MT.CFRÅROPR,                                               
            :MT.DRGNÅRFRA,                                              
            :MT.DRGNÅRTIL,                                              
            :MT.BPENSIND,                                               
            :MT.BPENSGR,                                                
            :MT.CSTATUS,                                                
            :MT.CDØDÆGTF,                                               
            :MT.CDUBLET,                                                
            :MT.CÆGTF_OK,                                               
            :MT.CFØRFORS,                                               
            :MT.CFØRCOR,                                                
            :MT.CFØRPENS,                                               
            :MT.COVF_DHE,                                               
            :MT.FØROPL_DCIÆN_GL,                                        
            :MT.FØROPL_CCIVS_GL,                                        
            :MT.HIST_OPD_SIDSTE_DHENVN,                                 
            :MT.HIST_OPD_SIDSTE_CSBSK,                                  
            :MT.HIST_OPD_SIDSTE_CFØREFT,                                
            :MT.HIST_OPD_SIDSTE_CSKPLOM,                                
            :MT.HIST_OPD_SIDSTE_DCIÆN,                                  
            :MT.HIST_OPD_DETTE_DHENVN,                                  
            :MT.HIST_OPD_DETTE_CSBSK,                                   
            :MT.HIST_OPD_DETTE_CFØREFT,                                 
            :MT.HIST_OPD_DETTE_CSKPLOM,                                 
            :MT.HIST_OPD_DETTE_DCIÆN,                                   
            :MT.HIST_OPD_NAESTE_DHENVN,                                 
            :MT.HIST_OPD_NAESTE_CSBSK,                                  
            :MT.HIST_OPD_NAESTE_CFØREFT,                                
            :MT.HIST_OPD_NAESTE_CSKPLOM,                                
            :MT.HIST_OPD_NAESTE_DCIÆN,                                  
            :MT.PER_DERHVPER_FRA1,                                      
            :MT.PER_DERHVPER_TIL1,                                      
            :MT.PER_DERHVPER_FRA2,                                      
            :MT.PER_DERHVPER_TIL2,                                      
            :MT.PER_DERHVPER_FRA3,                                      
            :MT.PER_DERHVPER_TIL3,                                      
            :MT.PER_DERHVPER_FRA4,                                      
            :MT.PER_DERHVPER_TIL4,                                      
            :MT.PER_DERHVPER_FRA5,                                      
            :MT.PER_DERHVPER_TIL5                                       
            );                                                          
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_INS_MT = ANT_INS_MT + 1;                             
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT  = '101 INSERT BQ66000T';                       
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END INSERT_MTOPL;                                                      
                                                                        
 /*********************************************************************/
 /* Ryd db2-tabeller før start                                 RUTINE */
 /*********************************************************************/
 RYD_DB2_TABELLER: PROC;                                                
                                                                        
         EXEC SQL                                                       
            Delete from BQ66000T                                        
            where til_evs_aar = :WS_TIL_EVS_AAR                         
            and   afviklings_id = :WS_FORSKUD_SLUT_TXT                  
            AND   DATA_ID       = :BH55600M.DATA_ID                     
            and   kØrsels_id = :WS_KØRSELS_ID;                          
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
            END;                                                        
            WHEN(100) DO;                                               
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 DELETE BQ66000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END RYD_DB2_TABELLER;                                                  
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /*********************************************************************/
 /*      UDSKRIV KØRSELSKONTROLLISTE                                  */
 /*********************************************************************/
 KONTROLLISTE:                                                          
 PROC;                                                                  
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
                                                                        
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA   = ZZWS1;                                         
         DETLIN1.TEKST =                                                
         'ANTAL LÆSTE RECORDS PÅ MT DATASET';                           
         DETLIN1.ANTAL = ANT_LÆS;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'ANTAL SKREVNE RÆKKER PÅ BQ66000T MT     ';                    
         DETLIN1.ANTAL = ANT_INS_MT;                                    
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
 END KONTROLLISTE;                                                      
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL KONTROLLISTE;                                             
         CLOSE FILE (BH86PI);                                           
         CLOSE FILE (BHMT0I);                                           
         CALL ZZ20300(' ','99');                                        
                                                                        
 END AFSLUT;                                                            
 END BH86600;                                                           
