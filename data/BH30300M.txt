 /**********************************************************************
 * PROJEKT:     UDTRÆK UDENLANDSKE EJD I EVS FORSKUD 2013 TIL SLUT 2012*
 * PROGRAMNAVN: BH30300M                                               *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK NYESTE BENYTTEDE LØBENR. PR. UDL. EJD. PR.  *
 *              PERSON FRA EVS FORSKUD 2014                            *
 * PROGRAMMØR:  GERD HOLM-PEDERSEN    GEH, PR              15.11.2011. *
 ***********************************************************************
 * ÆNDRINGSLOG: EVS SLUT 2012 LARS KAAE HARRITSHØJ, PR      SEP. 2012  *
 * ÆNDRINGSLOG: EVS SLUT 2013 JØRGEN SAUGMANN, QQS          OKT. 2013  *
 * ÆNDRINGSLOG: EVS SLUT-15 JNK.   Ingen rettelserK         OKT. 2015  *
 **********************************************************************/
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF PERSONTABEL BN00600T             RUTINE */
 /*********************************************************************/
 DECLARE_PERSONEJENDOMSOPL: PROC;                                       
                                                                        
         EXEC SQL DECLARE PERSON_CURSOR CURSOR FOR                      
                                                                        
              SELECT T1.DINDKAAR                                        
                    ,T1.PERSONNUMMER                                    
                    ,T1.EKOMNR                                          
                    ,T1.EEJDNR                                          
                    ,T1.ELBNR                                           
                    ,T1.DFRAGLD                                         
                    ,T1.DTILGLD                                         
                    ,T1.CEVSBENY                                        
                    ,T1.CEJBEVS                                         
                    ,T1.COPR_CEJBEVS                                    
                    ,T1.CEJDTYPE                                        
                    ,T1.BPROM1                                          
                    ,T1.CNEDSL1                                         
                    ,T1.DATO0107                                        
                    ,T1.DOVTG                                           
                    ,T1.DAFSTAA                                         
                    ,T1.DINDFLYT                                        
                    ,T1.DFRAFLYT                                        
                    ,T1.GPCTEJER                                        
                    ,T1.FDAGUDLE                                        
                    ,T1.GPCTUDLE                                        
                    ,T1.FDAGERHV                                        
                    ,T1.GPCTERHV                                        
                    ,T1.B100                                            
                    ,T1.BEJERAN                                         
                    ,T1.CFRED                                           
                    ,T1.BNYMAN                                          
                    ,T1.BBRUTTO                                         
                    ,T1.CENKE                                           
                    ,T1.FDAGEJ                                          
                    ,T1.CEKSEMP                                         
                    ,T1.COPR_EKSEMP                                     
                    ,T1.BBERGRL                                         
                    ,T1.BBER2FAM                                        
                    ,T2.EJDBELIG                                        
                    ,T2.LANDEKODE                                       
                                                                        
         FROM BN00600T T1, BN00500T T2                                  
                                                                        
         WHERE T1.DINDKAAR    = :HJ_DINDKAAR                            
         AND   T1.EKOMNR      = 999                                     
         AND   T1.DOVTG      >= :HJ_DOVTG_ST                            
         AND   T1.DOVTG      <= :HJ_DOVTG_SL                            
         AND   T1.CEJBEVS    ^= '1'                                     
         AND   T1.CSLET      ^= '1'                                     
         AND   T1.DINDKAAR    = T2.DINDKAAR                             
         AND   T1.EKOMNR      = T2.EKOMNR                               
         AND   T1.EEJDNR      = T2.EEJDNR                               
         AND   T1.DTILGLD IN (SELECT MAX(DTILGLD)                       
                              FROM BN00600T T3                          
                              WHERE T1.PERSONNUMMER = T3.PERSONNUMMER   
                              AND   T1.DINDKAAR     = T3.DINDKAAR       
                              AND   T1.EKOMNR       = T3.EKOMNR         
                              AND   T1.EEJDNR       = T3.EEJDNR         
                              AND   T1.ELBNR        = T3.ELBNR)         
                                                                        
         AND   T1.EEJDNR NOT IN (SELECT EEJDNR                          
                             FROM  BN00600T T4                          
                             WHERE T4.PERSONNUMMER = T1.PERSONNUMMER    
                             AND   T4.DINDKAAR     = :HJ_SLUTAAR        
                             AND   T4.EKOMNR       = T1.EKOMNR          
                             AND   T4.EEJDNR       = T1.EEJDNR)         
                                                                        
         ORDER BY T1.PERSONNUMMER,                                      
                  T1.EKOMNR,                                            
                  T1.EEJDNR,                                            
                  T1.ELBNR                                              
         ;                                                              
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'DECLARE PERSONCURSOR';                        
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END DECLARE_PERSONEJENDOMSOPL;                                         
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF PERSONTABEL BN00600T               RUTINE */
 /*********************************************************************/
 FETCH_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL FETCH PERSON_CURSOR                                   
                                                                        
         INTO :PERSONEJENDOMSOPL.DINDKAAR                               
             ,:PERSONEJENDOMSOPL.PERSONNUMMER                           
             ,:PERSONEJENDOMSOPL.EKOMNR                                 
             ,:PERSONEJENDOMSOPL.EEJDNR                                 
             ,:PERSONEJENDOMSOPL.ELBNR                                  
             ,:PERSONEJENDOMSOPL.DFRAGLD                                
             ,:PERSONEJENDOMSOPL.DTILGLD                                
             ,:PERSONEJENDOMSOPL.CEVSBENY                               
             ,:PERSONEJENDOMSOPL.CEJBEVS                                
             ,:PERSONEJENDOMSOPL.COPR_CEJBEVS                           
             ,:PERSONEJENDOMSOPL.CEJDTYPE                               
             ,:PERSONEJENDOMSOPL.BPROM1                                 
             ,:PERSONEJENDOMSOPL.CNEDSL1                                
             ,:PERSONEJENDOMSOPL.DATO0107                               
             ,:PERSONEJENDOMSOPL.DOVTG                                  
             ,:PERSONEJENDOMSOPL.DAFSTAA                                
             ,:PERSONEJENDOMSOPL.DINDFLYT                               
             ,:PERSONEJENDOMSOPL.DFRAFLYT                               
             ,:PERSONEJENDOMSOPL.GPCTEJER                               
             ,:PERSONEJENDOMSOPL.FDAGUDLE                               
             ,:PERSONEJENDOMSOPL.GPCTUDLE                               
             ,:PERSONEJENDOMSOPL.FDAGERHV                               
             ,:PERSONEJENDOMSOPL.GPCTERHV                               
             ,:PERSONEJENDOMSOPL.B100                                   
             ,:PERSONEJENDOMSOPL.BEJERAN                                
             ,:PERSONEJENDOMSOPL.CFRED                                  
             ,:PERSONEJENDOMSOPL.BNYMAN:INDK_PERS.BNYMAN_I              
             ,:PERSONEJENDOMSOPL.BBRUTTO                                
             ,:PERSONEJENDOMSOPL.CENKE                                  
             ,:PERSONEJENDOMSOPL.FDAGEJ                                 
             ,:PERSONEJENDOMSOPL.CEKSEMP                                
             ,:PERSONEJENDOMSOPL.COPR_EKSEMP                            
             ,:PERSONEJENDOMSOPL.BBERGRL                                
             ,:PERSONEJENDOMSOPL.BBER2FAM                               
             ,:EJENDOMSOPL.EJDBELIG                                     
             ,:EJENDOMSOPL.LANDEKODE                                    
         ;                                                              
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                       
                                                                        
               IF PERSONEJENDOMSOPL.EKOMNR = 999                        
                & EJENDOMSOPL.LANDEKODE ^= ' '                          
               THEN                                                     
                  CALL CHECK_CEKSEMP;                                   
             END;                                                       
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'FETCH PERSONCURSOR';                       
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 CHECK_CEKSEMP: PROC;                                                   
                                                                        
         EXEC SQL                                                       
              SELECT LEMPELSESKODE                                      
              INTO   :BN03300T.LEMPELSESKODE                            
              FROM   BN03300T                                           
              WHERE  YEAR(STARTDATO) <= :HJ_DINDKAAR                    
               AND   YEAR(SLUTDATO)  >= :HJ_DINDKAAR                    
               AND   LANDEKODE = :EJENDOMSOPL.LANDEKODE;                
                                                                        
          IF SQLCA.SQLCODE = 0                                          
          THEN                                                          
             DO;                                                        
               IF PERSONEJENDOMSOPL.CEKSEMP ^= BN03300T.LEMPELSESKODE   
               THEN                                                     
                  PERSONEJENDOMSOPL.CEKSEMP = BN03300T.LEMPELSESKODE;   
             END;                                                       
                                                                        
 END CHECK_CEKSEMP;                                                     
