 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                 */
 /*********************************************************************/
 DECLARE_CURSOR: PROC;                                                  
                                                                        
         EXEC SQL DECLARE PERSON_CURSOR CURSOR FOR                      
                                                                        
              SELECT T1.DINDKAAR,                                       
                     T1.DCPRN,                                          
                     T1.EKOMNR,                                         
                     T1.EEJDNR,                                         
                     MAX(T1.ELBNR)                                      
                                                                        
         FROM BQ30000T T1                                               
         WHERE  T1.DINDKAAR = 2005                                      
         AND    T1.DTILGLD  = '9999-12-31-23.59.59.999999'              
                                                                        
         GROUP BY T1.DINDKAAR,                                          
                  T1.DCPRN,                                             
                  T1.EKOMNR,                                            
                  T1.EEJDNR                                             
                                                                        
         ORDER BY T1.DINDKAAR,                                          
                  T1.DCPRN,                                             
                  T1.EKOMNR,                                            
                  T1.EEJDNR                                             
                                                                        
         FOR READ ONLY                                                  
            ;                                                           
         CALL KONTROL('259',' DECLARE PERSON_CURSOR');                  
                                                                        
      /***************************/                                     
         EXEC SQL                                                       
         DECLARE ESK_FEL_CUR CURSOR FOR                                 
                                                                        
         SELECT T5.INDHOLD_C,                                           
                T5.INDHOLD_D,                                           
                T5.FELTKODE                                             
                                                                        
         FROM   BQ31000T T5                                             
                                                                        
         WHERE  T5.DINDKAAR = :EVS_ESK.DINDKAAR                         
         AND    T5.EKOMNR   = :EVS_ESK.EKOMNR                           
         AND    T5.EEJDNR   = :EVS_ESK.EEJDNR                           
         AND    T5.DCPRN    = :EVS_ESK.DCPRN                            
         AND    T5.ELBNR    = :EVS_ESK.ELBNR                            
         AND    T5.EGENNR   = :EVS_ESK.EGENNR                           
         ORDER BY T5.FELTKODE                                           
         FOR READ ONLY;                                                 
                                                                        
         CALL KONTROL('260',' DECLARE ESK_FEL_CUR');                    
                                                                        
 END DECLARE_CURSOR;                                                    
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                   */
 /*********************************************************************/
 FETCH_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL FETCH PERSON_CURSOR                                   
                                                                        
         INTO :EVS_ESK.DINDKAAR,                                        
              :EVS_ESK.DCPRN,                                           
              :EVS_ESK.EKOMNR,                                          
              :EVS_ESK.EEJDNR,                                          
              :EVS_ESK.ELBNR;                                           
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0)                                                     
               ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                       
           WHEN (100);                                                  
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  =  'BH30000 ** 262  FETCH PERSON_CURSOR';     
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
 END FETCH_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 /* SELECT FØRSTE GENERATION AF PERSON-EJENDOMSOPLYSN.                */
 /*********************************************************************/
 FØRSTE_PERSONEJENDOMSOPL: PROC;                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.EGENNR,                                         
                     T2.DFRAGLD,                                        
                     T2.DTILGLD,                                        
                     T2.CDATAFRA,                                       
                     T2.CAJOUR,                                         
                     T2.CSUPPL,                                         
                     T2.COMPLA,                                         
                     T2.DOMPLACPR                                       
                                                                        
              INTO :EVS_ESK.EGENNR,                                     
                   :EVS_ESK.DFRAGLD,                                    
                   :EVS_ESK.DTILGLD,                                    
                   :EVS_ESK.CDATAFRA,                                   
                   :EVS_ESK.CAJOUR,                                     
                   :EVS_ESK.CSUPPL,                                     
                   :EVS_ESK.COMPLA,                                     
                   :EVS_ESK.DOMPLACPR                                   
                                                                        
              FROM BQ30000T T2                                          
                                                                        
              WHERE  T2.DINDKAAR = :EVS_ESK.DINDKAAR                    
               AND   T2.EKOMNR   = :EVS_ESK.EKOMNR                      
               AND   T2.EEJDNR   = :EVS_ESK.EEJDNR                      
               AND   T2.DCPRN    = :EVS_ESK.DCPRN                       
               AND   T2.ELBNR    = :EVS_ESK.ELBNR                       
               AND   T2.EGENNR   = 1;                                   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  =  'BH30000 ** 263  FØRSTE PERSONEJENDOM';    
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         IF SQLCA.SQLCODE = 0                                           
         THEN                                                           
           DO;                                                          
                                                                        
             EXEC SQL OPEN ESK_FEL_CUR;                                 
             CALL KONTROL('264',' OPEN ESK_FEL_CUR');                   
                                                                        
             DO WHILE (SQLCA.SQLCODE = 0);                              
                                                                        
               EXEC SQL                                                 
                                                                        
               FETCH ESK_FEL_CUR                                        
                                                                        
               INTO :EVS_ESK_FELT.INDHOLD_C,                            
                    :EVS_ESK_FELT.INDHOLD_D,                            
                    :EVS_ESK_FELT.FELTKODE;                             
                                                                        
                                                                        
               IF SQLCA.SQLCODE = 0                                     
               THEN                                                     
                 DO;                                                    
                   CALL FLYT_ESK_FEL;                                   
                 END;                                                   
                                                                        
               IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)           
               THEN                                                     
                 DO;                                                    
                   FEJLTEKST = 'ESK_FEL_CUR';                           
                   CALL SQL_FEJL;                                       
                 END;                                                   
                                                                        
             END;                                                       
                                                                        
             EXEC SQL CLOSE ESK_FEL_CUR;                                
             CALL KONTROL('269',' CLOSE EJD_FEL_CUR');                  
           END;                                                         
                                                                        
         IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)                 
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'FØRSTE_PERSONEJENDOMSOPL';                    
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END FØRSTE_PERSONEJENDOMSOPL;                                          
 /*********************************************************************/
 /* SELECT SIDSTE GENERATION AF PERSON-EJENDOMSOPLYSN.                */
 /*********************************************************************/
 SIDSTE_PERSONEJENDOMSOPL: PROC;                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.EGENNR,                                         
                     T2.DFRAGLD,                                        
                     T2.DTILGLD,                                        
                     T2.CDATAFRA,                                       
                     T2.CAJOUR,                                         
                     T2.CSUPPL,                                         
                     T2.COMPLA,                                         
                     T2.DOMPLACPR                                       
                                                                        
              INTO :EVS_ESK.EGENNR,                                     
                   :EVS_ESK.DFRAGLD,                                    
                   :EVS_ESK.DTILGLD,                                    
                   :EVS_ESK.CDATAFRA,                                   
                   :EVS_ESK.CAJOUR,                                     
                   :EVS_ESK.CSUPPL,                                     
                   :EVS_ESK.COMPLA,                                     
                   :EVS_ESK.DOMPLACPR                                   
                                                                        
              FROM BQ30000T T2                                          
                                                                        
              WHERE  T2.DINDKAAR = :EVS_ESK.DINDKAAR                    
               AND   T2.EKOMNR   = :EVS_ESK.EKOMNR                      
               AND   T2.EEJDNR   = :EVS_ESK.EEJDNR                      
               AND   T2.DCPRN    = :EVS_ESK.DCPRN                       
               AND   T2.ELBNR    = :EVS_ESK.ELBNR                       
               AND   T2.DTILGLD  = '9999-12-31-23.59.59.999999';        
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'SELECT PERSONEJDOPL';                      
               PUT SKIP LIST('SQLKODE',SQLCODE);                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         IF SQLCA.SQLCODE = 0                                           
         THEN                                                           
           DO;                                                          
                                                                        
             EXEC SQL OPEN ESK_FEL_CUR;                                 
             CALL KONTROL('266',' OPEN ESK_FEL_CUR');                   
                                                                        
             DO WHILE (SQLCA.SQLCODE = 0);                              
                                                                        
               EXEC SQL                                                 
                                                                        
               FETCH ESK_FEL_CUR                                        
                                                                        
               INTO :EVS_ESK_FELT.INDHOLD_C,                            
                    :EVS_ESK_FELT.INDHOLD_D,                            
                    :EVS_ESK_FELT.FELTKODE;                             
                                                                        
                                                                        
               IF SQLCA.SQLCODE = 0                                     
               THEN                                                     
                 DO;                                                    
                   CALL FLYT_ESK_FEL;                                   
                 END;                                                   
                                                                        
               IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)           
               THEN                                                     
                 DO;                                                    
                   FEJLTEKST = 'ESK_FEL_CUR';                           
                   CALL SQL_FEJL;                                       
                 END;                                                   
                                                                        
             END;                                                       
                                                                        
             EXEC SQL CLOSE ESK_FEL_CUR;                                
             CALL KONTROL('269',' CLOSE ESK_FEL_CUR');                  
           END;                                                         
         IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)                 
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'SIDSTE_PERSONEJENDOMSOPL';                    
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END SIDSTE_PERSONEJENDOMSOPL;                                          
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BQ30000T/BQ31000T             RUTINE */
 /*********************************************************************/
 OPEN_PERSONEJENDOMSOPL: PROC;                                          
                                                                        
         EXEC SQL OPEN PERSON_CURSOR;                                   
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN PERSON_CURSOR';                         
              FEJLTEKST  = 'BH30000 ** 253 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_PERSONEJENDOMSOPL;                                            
 /*********************************************************************/
 SKAF_BFASTSTIG_2004: PROC;                                             
                                                                        
         DCPRN_NGL = EVS_ESK.DCPRN;                                     
         KOM_NGL   = EVS_ESK.EKOMNR;                                    
         EJD_NGL   = EVS_ESK.EEJDNR;                                    
                                                                        
         IF KOM_NGL = 492                                               
          & PERSON.EKOMNR_GL > 0                                        
         THEN                                                           
            DO;                                                         
              KOM_NGL = PERSON.EKOMNR_GL;                               
              EJD_NGL = PERSON.EEJDNR_GL;                               
            END;                                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.INDHOLD_D                                       
              INTO  :PERSON_2004.BFASTSTIGBGR                           
              FROM  BQ30000T T1, BQ31000T T2                            
              WHERE T1.DINDKAAR = 2004                                  
               AND  T1.DCPRN    = :DCPRN_NGL                            
               AND  T1.EKOMNR   = :KOM_NGL                              
               AND  T1.EEJDNR   = :EJD_NGL                              
               AND  T1.DTILGLD  = '9999-12-31-23.59.59.999999'          
               AND  T1.ELBNR   IN (SELECT MAX(ELBNR)                    
                               FROM  BQ30000T T3                        
                               WHERE T1.DINDKAAR = T3.DINDKAAR          
                                AND  T1.DCPRN    = T3.DCPRN             
                                AND  T1.EEJDNR   = T3.EEJDNR            
                                AND  T1.EKOMNR   = T3.EKOMNR            
                                AND  T1.EEJDNR   = T3.EEJDNR            
                                AND  T1.DTILGLD  = T3.DTILGLD)          
               AND  T2.DINDKAAR = T1.DINDKAAR                           
               AND  T2.DCPRN    = T1.DCPRN                              
               AND  T2.EKOMNR   = T1.EKOMNR                             
               AND  T2.EEJDNR   = T1.EEJDNR                             
               AND  T2.ELBNR    = T1.ELBNR                              
               AND  T2.EGENNR   = T1.EGENNR                             
               AND  T2.FELTKODE = 179;             /* BFASTSTIGBGR */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
              DO;                                                       
                PERSON_2004.BFASTSTIGBGR_SW = 0;                        
              END;                                                      
           WHEN (100)                                                   
              DO;                                                       
                PERSON_2004.BFASTSTIGBGR    =  0;                       
                PERSON_2004.BFASTSTIGBGR_SW = -1;                       
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                FEJLTEKST = 'SELECT BFASTSTIGBR 2004';                  
                FEJLTEKST  = 'BH30000 ** 254 ' !! FEJLTEKST;            
                CALL SQL_FEJL;                                          
              END;                                                      
         END; /* SELECT */                                              
                                                                        
 END SKAF_BFASTSTIG_2004;                                               
 /*********************************************************************/
 SKAF_ÆGT_BFASTSTIG_2004: PROC;                                         
                                                                        
         DCPRN_NGL = PERSON.DHENVN;                                     
         KOM_NGL   = EVS_ESK.EKOMNR;                                    
         EJD_NGL   = EVS_ESK.EEJDNR;                                    
                                                                        
         IF KOM_NGL = 492                                               
          & PERSON.EKOMNR_GL > 0                                        
         THEN                                                           
            DO;                                                         
              KOM_NGL = PERSON.EKOMNR_GL;                               
              EJD_NGL = PERSON.EEJDNR_GL;                               
            END;                                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.INDHOLD_D                                       
              INTO  :PERSON_2004.BFASTSTIGBGR                           
              FROM  BQ30000T T1, BQ31000T T2                            
              WHERE T1.DINDKAAR = 2004                                  
               AND  T1.DCPRN    = :DCPRN_NGL                            
               AND  T1.EKOMNR   = :KOM_NGL                              
               AND  T1.EEJDNR   = :EJD_NGL                              
               AND  T1.DTILGLD  = '9999-12-31-23.59.59.999999'          
               AND  T1.ELBNR   IN (SELECT MAX(ELBNR)                    
                               FROM  BQ30000T T3                        
                               WHERE T1.DINDKAAR = T3.DINDKAAR          
                                AND  T1.DCPRN    = T3.DCPRN             
                                AND  T1.EEJDNR   = T3.EEJDNR            
                                AND  T1.EKOMNR   = T3.EKOMNR            
                                AND  T1.EEJDNR   = T3.EEJDNR            
                                AND  T1.DTILGLD  = T3.DTILGLD)          
               AND  T2.DINDKAAR = T1.DINDKAAR                           
               AND  T2.DCPRN    = T1.DCPRN                              
               AND  T2.EKOMNR   = T1.EKOMNR                             
               AND  T2.EEJDNR   = T1.EEJDNR                             
               AND  T2.ELBNR    = T1.ELBNR                              
               AND  T2.EGENNR   = T1.EGENNR                             
               AND  T2.FELTKODE = 179;             /* BFASTSTIGBGR */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
              DO;                                                       
                PERSON_2004.BFASTSTIGBGR_SW = 0;                        
              END;                                                      
           WHEN (100)                                                   
              DO;                                                       
                PERSON_2004.BFASTSTIGBGR    =  0;                       
                PERSON_2004.BFASTSTIGBGR_SW = -1;                       
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                FEJLTEKST = 'SELECT BFASTSTIGBR 2004';                  
                FEJLTEKST  = 'BH30000 ** 254 ' !! FEJLTEKST;            
                CALL SQL_FEJL;                                          
              END;                                                      
         END; /* SELECT */                                              
                                                                        
 END SKAF_ÆGT_BFASTSTIG_2004;                                           
 /*********************************************************************/
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BQ01200T/BQ01100T            RUTINE */
 /*********************************************************************/
 CLOSE_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL CLOSE PERSON_CURSOR;                                  
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE PERSON_CURSOR';                        
              FEJLTEKST  = 'BH30000 ** 256 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_PERSONEJENDOMSOPL;                                           
 /***********************************************************/          
 KONTROL:PROC(TAL,TEKST);                                               
 DCL TAL   CHAR (3);                                                    
 DCL TEKST CHAR (80) VARYING;                                           
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0);                                                    
           OTHER                                                        
             DO;                                                        
               FEJLTEKST  = 'BH30000 ** '!!TAL!! TEKST;                 
               CALL SQL_FEJL;                                           
             END;                                                       
         END; /* SELECT*/                                               
 END KONTROL;                                                           
