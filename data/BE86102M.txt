 /*********************************************************************/
 /*      DANNE DATA TIL SLUT HOS DXC                                  */
 /*********************************************************************/
 /* SLUT 24                                                           */
 /*   Ny struktur   Jan Jensen JJJ                          Okt. 2023 */
 /*                                                                   */
 /* SLUT 24    Jan Erik Jensen (XJY) ÆA73              25.10.2024     */
 /*            #1892264 Konvertering af udenlandske ejendomsnumre:    */
 /*            Rettet så beskatningsgrundlag (felterne BBERGRL_AKT    */
 /*            og BBER2FAM_AKT) også sendes videre for udenlandske    */
 /*            ejendomme, så de kan leveres via individ 810.          */
 /*                                                                   */
 /* SLUT 24    Jan Erik Jensen (XJY) ÆA73              05.11.2024     */
 /*            #1892264 Konvertering af udenlandske ejendomsnumre:    */
 /*            Rettet så udenlandsk betalt skat (felt BUDLSKC)        */
 /*            sendes videre som nul i stedet for "null" for          */
 /*            udenlandske ejendomme.                                 */
 /*********************************************************************/
 DAN_DATA_TIL_SLUT: PROC;                                               
                                                                        
   DCL PIC15 PIC '(14)z9';                                              
   DCL CHAR15 CHAR(15);                                                 
   DCL PIC11 PIC '(10)z9';                                              
   DCL CHAR11 CHAR(11);                                                 
   DCL PIC9 PIC '(8)z9';                                                
   DCL CHAR10 CHAR(10);                                                 
   DCL HJ_VURD_A_VURMARK_AKT   DEC (3,0);                               
   DCL HJ_VURD_A_FORSIGT_EVS       CHAR(1);                             
   DCL HJ_VURD_A_BESKAT_EVS        CHAR(1);                             
                                                                        
      BE861_DATA            =  '';                                      
      BE861_DATA.INDVNR     = 810;                                      
      BE861_DATA.INDVLGD    = 386;                                      
      BE861_DATA.FELTLGD    = 386;                                      
      BE861_DATA.HEADER     = 'EVSGRUND';                               
      BE861_DATA.DINDKAAR   = BE55600M.INDKÅR1;                         
      BE861_DATA.DCPRN      = DCLBE78000T.DCPRN;                        
      BE861_DATA.EKOMNR     = DCLBE78000T.EKOMNR;                       
      BE861_DATA.EEJDNR     = DCLBE78000T.EEJDNR;                       
      BE861_DATA.EENHEDLBNR = DCLBE78000T.EENHEDLBNR;                   
      BE861_DATA.ELBNR      = DCLBE78000T.UDSKRLBNR;                    
      BE861_DATA.CSLET        = '';                                     
      BE861_DATA.DAFSTAAFOR     = DCLBE78000T.TILEVS_DAFSTAAFOR;        
      BE861_DATA.EJDBLIGEKMNR  = DCLBE78000T.EKOMNR;                    
                                                                        
      IF DCLBE78000T.EENHEDLBNR = 0                                     
      THEN                                                              
        DO;                                                             
          BE861_DATA.EJDBELIG     = DCLBE78000T.EJENDOM_EJDBELIG;       
          BE861_DATA.VEJKOD       = DCLBE78000T.EJENDOM_VEJK_EJD;       
          BE861_DATA.HUSNR        =                                     
                SUBSTR(DCLBE78000T.EJENDOM_HUSNR_EJD,1,3);              
          BE861_DATA.HUSBOSTAADR  =                                     
                SUBSTR(DCLBE78000T.EJENDOM_HUSNR_EJD,4,1);              
          BE861_DATA.ETAGENR      = DCLBE78000T.EJENDOM_ETAGE_EJD;      
          BE861_DATA.SIDEDOERNR   = DCLBE78000T.EJENDOM_SDØR_EJD;       
        END;                                                            
      ELSE                                                              
        DO;                                                             
          BE861_DATA.EJDBELIG     = DCLBE78000T.EJENDOM_ENHEDBELIG;     
          BE861_DATA.VEJKOD       = DCLBE78000T.EJENDOM_VEJK_ENHED;     
          BE861_DATA.HUSNR        =                                     
                SUBSTR(DCLBE78000T.EJENDOM_HUSNR_ENHED,1,3);            
          BE861_DATA.HUSBOSTAADR  =                                     
                SUBSTR(DCLBE78000T.EJENDOM_HUSNR_ENHED,4,1);            
          BE861_DATA.ETAGENR      = DCLBE78000T.EJENDOM_ETAGE_ENHED;    
          BE861_DATA.SIDEDOERNR   = DCLBE78000T.EJENDOM_SDØR_ENHED;     
        END;                                                            
                                                                        
      BE861_DATA.CLANDEKODE   = DCLBE78000T.EJENDOM_CLANDEKODE;         
      BE861_DATA.CEJBEVS      = DCLBE78000T.TILEVS_CEJBEVS;             
      BE861_DATA.EJET20240101 = DCLBE78000T.EJET20240101;               
      BE861_DATA.MANPENSSTI_I = -1;                                     
      BE861_DATA.MANPENSSTI   = 0;                                      
                                                                        
      IF BE861_DATA.EKOMNR = 999                                        
      THEN                                                              
        DO;                                                             
         BE861_DATA.BBERGRL_AKT_I     = DCLBE78000T.EJERSKAB_UDL_616_SW;
         BE861_DATA.BBERGRL_AKT       = DCLBE78000T.EJERSKAB_UDL_616;   
         BE861_DATA.BBER2FAM_AKT_I    = DCLBE78000T.EJERSKAB_UDL_626_SW;
         BE861_DATA.BBER2FAM_AKT      = DCLBE78000T.EJERSKAB_UDL_626;   
        END;                                                            
      ELSE                                                              
        DO;                                                             
         BE861_DATA.BBERGRL_AKT_I    = DCLBE78000T.VURD_A_BBERGRL_A_SW; 
         BE861_DATA.BBERGRL_AKT      = DCLBE78000T.VURD_A_BBERGRL_AKT;  
         BE861_DATA.BBER2FAM_AKT_I   = DCLBE78000T.VURD_A_BBER2FAM_A_SW;
         BE861_DATA.BBER2FAM_AKT     = DCLBE78000T.VURD_A_BBER2FAM_AKT; 
        END;                                                            
                                                                        
      BE861_DATA.CRTEKORNS = DCLBE78000T.EJERSKAB_CRTEKORNS;            
                                                                        
      IF DCLBE78000T.EJERSKAB_CEJDTYPE_AKT > '0' THEN                   
        BE861_DATA.CEJDTYPE = DCLBE78000T.EJERSKAB_CEJDTYPE_AKT;        
      ELSE                                                              
        BE861_DATA.CEJDTYPE = DCLBE78000T.EJENDOM_CEJDTYPE;             
                                                                        
      IF DCLBE78000T.EENHEDLBNR = 0     &                               
         DCLBE78000T.EKOMNR     ^= 999  &                               
        (BE861_DATA.CEJDTYPE = '4' !                                    
         BE861_DATA.CEJDTYPE = '5')                                     
      THEN                                                              
        DO;                                                             
          PUT SKIP LIST('2FAMILIHUSE UDEN EENHEDLBNR');                 
          PUT SKIP LIST('DCLBE78000T.DCPRN     ',DCLBE78000T.DCPRN );   
          PUT SKIP LIST('DCLBE78000T.EKOMNR    ',DCLBE78000T.EKOMNR);   
          PUT SKIP LIST('DCLBE78000T.EEJDNR    ',DCLBE78000T.EEJDNR);   
          PUT SKIP LIST('DCLBE78000T.UDSKRLBNR ',DCLBE78000T.UDSKRLBNR);
          PUT SKIP LIST('BE861_DATA.CEJDTYPE   ',BE861_DATA.CEJDTYPE);  
          TV.EJ_EENHEDLBNR = TV.EJ_EENHEDLBNR + 1;                      
        END;                                                            
                                                                        
      IF DCLBE78000T.TILEVS_DOVTG > 0 THEN                              
        BE861_DATA.DOVTG = FIX09_TIL_DB2_DATO(DCLBE78000T.TILEVS_DOVTG);
      ELSE                                                              
        BE861_DATA.DOVTG = (10)' ';                                     
                                                                        
      IF DCLBE78000T.TILEVS_DAFSTAA > DCLBE76000T.DRGNÅRTIL THEN        
         BE861_DATA.DAFSTAA = '';                                       
      ELSE                                                              
         IF DCLBE78000T.TILEVS_DAFSTAA > 0 THEN                         
            BE861_DATA.DAFSTAA =                                        
                        FIX09_TIL_DB2_DATO(DCLBE78000T.TILEVS_DAFSTAA); 
         ELSE                                                           
            BE861_DATA.DAFSTAA = (10)' ';                               
                                                                        
      BE861_DATA.GPCTEJER_I = DCLBE78000T.TILEVS_GPCTEJER_SW;           
                                                                        
      IF DCLBE78000T.TILEVS_GPCTEJER_SW = 0 THEN                        
         BE861_DATA.GPCTEJER = DCLBE78000T.TILEVS_GPCTEJER;             
                                                                        
      BE861_DATA.FDAGUDLE  = 0;                                         
      BE861_DATA.GPCTUDLE  = 0;                                         
      BE861_DATA.FUDL100 = DCLBE78000T.TILEVS_FUDL100;                  
      BE861_DATA.GPCTERHV  = 0;                                         
      BE861_DATA.FDAGERHV  = 0;                                         
      BE861_DATA.FERHVFLER = DCLBE78000T.TILEVS_FERHVFLER;              
      BE861_DATA.CENKE     = DCLBE78000T.TILEVS_CENKE;                  
      BE861_DATA.CPTYPSLUT = DCLBE78000T.TILEVS_CPTYPSLUT;              
      BE861_DATA.FELT759   = DCLBE78000T.TILEVS_FELT759;                
      BE861_DATA.FELT760   = DCLBE78000T.TILEVS_CFRED;                  
      BE861_DATA.BEJDVPUSKTP_I = -1;                                    
      BE861_DATA.BEJDVPUSKTP   = 0;                                     
                                                                        
      IF DCLBE78000T.TILEVS_DINDFLYT > 0 THEN                           
         BE861_DATA.DINDFLYT =                                          
                       FIX09_TIL_DB2_DATO(DCLBE78000T.TILEVS_DINDFLYT); 
                                                                        
      IF DCLBE78000T.TILEVS_DFRAFLYT > 0 THEN                           
         BE861_DATA.DFRAFLYT =                                          
                       FIX09_TIL_DB2_DATO(DCLBE78000T.TILEVS_DFRAFLYT); 
                                                                        
      BE861_DATA.FUBEBOELIG = 0;                                        
      BE861_DATA.BEJDVÆPUSKP_I = -1;                                    
      BE861_DATA.BEJDVÆPUSKP   = 0;                                     
      BE861_DATA.CINDFLYT       = '';                                   
      BE861_DATA.BEVSMAN_I      = -1;                                   
      BE861_DATA.BEVSMAN        = 0;;                                   
      BE861_DATA.BMANNEDSL_I    = -1;                                   
      BE861_DATA.BMANNEDSL      = 0;;                                   
      BE861_DATA.CEKSEMP        = DCLBE78000T.TILEVS_CEKSEMP;           
                                                                        
      /*                                                                
      XJY 05.11.2024 #1892264:                                          
      Sæt den udenlandsk betalte skat til 0 i                           
      stedet for NULL. Skal kun ske for SLUT 2024                       
                                                                        
      BE861_DATA.BUDLSKC_I      = -1;                                   
      BE861_DATA.BUDLSKC        = 0;                                    
      */                                                                
      IF WS_TIL_EVS_AAR = 2024 & BE861_DATA.EKOMNR = 999 THEN           
      DO;                                                               
         BE861_DATA.BUDLSKC_I      = 0;                                 
         BE861_DATA.BUDLSKC        = 0;                                 
      END;                                                              
      ELSE                                                              
      DO;                                                               
         BE861_DATA.BUDLSKC_I      = -1;                                
         BE861_DATA.BUDLSKC        = 0;                                 
      END;                                                              
                                                                        
      BE861_DATA.BEJBOL1_AKT_I  = DCLBE78000T.VURD_A_BEJBOL1_A_SW;      
      BE861_DATA.BEJBOL1_AKT    = DCLBE78000T.VURD_A_BEJBOL1_AKT;       
      BE861_DATA.BEJBOL2_AKT_I  = DCLBE78000T.VURD_A_BEJBOL2_A_SW;      
      BE861_DATA.BEJBOL2_AKT    = DCLBE78000T.VURD_A_BEJBOL2_AKT;       
      BE861_DATA.CBENYT      = DCLBE78000T.EJENDOM_CBENYT;              
      BE861_DATA.COMBYG      = DCLBE78000T.EJENDOM_COMBYG;              
      BE861_DATA.CBERGRL     = DCLBE78000T.EJENDOM_CBERGRL;             
                                                                        
      hj_VURD_A_BESKAT_EVS = DCLBE78000T.VURD_A_BESKAT_EVS;             
      if DCLBE78000T.VURD_A_BESKAT_EVS= '' then                         
       hj_VURD_A_BESKAT_EVS= 'N';                                       
      BE861_DATA.VURD_A_BESKAT_EVS      =                               
           TJEK(hj_VURD_A_BESKAT_EVS);                                  
                                                                        
      BE861_DATA.GPCTEJERFOR = DCLBE78000T.TILEVS_GPCTEJERFOR;          
      BE861_DATA.CERHV       = DCLBE78000T.TILEVS_CERHV;                
                                                                        
      IF BE861_DATA.CEJDTYPE = '9' &                                    
         BE861_DATA.EKOMNR ^= 999 THEN                                  
        DO;                                                             
          BE861_DATA.BLANDVÆR_AKT_I  = DCLBE78000T.VURD_A_BEJDVÆR_A_SW; 
          BE861_DATA.BLANDVÆR_AKT    = DCLBE78000T.VURD_A_BEJDVÆR_AKT;  
        END;                                                            
      ELSE                                                              
        DO;                                                             
          BE861_DATA.BLANDVÆR_AKT_I    = -1;                            
          BE861_DATA.BLANDVÆR_AKT      = 0;                             
        END;                                                            
                                                                        
      BE861_DATA.CBERGROP   = DCLBE78000T.EJERSKAB_CBERGROP;            
      BE861_DATA.BFORSKAT_I = DCLBE78000T.TILEVS_BFORSKAT_SW;           
      BE861_DATA.BFORSKAT   = DCLBE78000T.TILEVS_BFORSKAT;              
      BE861_DATA.CFORSKAT   = DCLBE78000T.TILEVS_CFORSKAT;              
      BE861_DATA.CUDLMAN    = DCLBE78000T.TILEVS_CUDLMAN;               
                                                                        
      IF DCLBE78000T.FEJLNR > 0 THEN                                    
         DO;                                                            
            HJ_FEJLNR = DCLBE78000T.FEJLNR;                             
            BE861_DATA.FEJLNR = HJ_FEJLNR;                              
         END;                                                           
      ELSE                                                              
         BE861_DATA.FEJLNR = ' ';                                       
                                                                        
      hj_VURD_A_FORSIGT_EVS = DCLBE78000T.VURD_A_FORSIGT_EVS;           
      if DCLBE78000T.VURD_A_FORSIGT_EVS = '' THEN                       
        do;                                                             
          if DCLBE78000T.VURD_A_VURMARK_AKT = 3                         
           ! DCLBE78000T.VURD_A_VURMARK_AKT = 5 THEN                    
            hj_VURD_A_FORSIGT_EVS = 'J';                                
        else                                                            
            hj_VURD_A_FORSIGT_EVS = 'N';                                
       end;                                                             
      BE861_DATA.VURD_A_FORSIGT_EVS      =                              
           TJEK(hj_VURD_A_FORSIGT_EVS);                                 
                                                                        
      BE861_DATA.VURD_A_JUR_KATEGO  = DCLBE78000T.VURD_A_JUR_KATEGO;    
      BE861_DATA.VURD_A_JUR_UKATEGO = DCLBE78000T.VURD_A_JUR_UKATEGO;   
      BE861_DATA.DFRAGLD    = DATO2.ÅR !! '-' !! DATO2.MD !! '-' !!     
                         DATO2.DG !! '-01.01.01.000001';                
      BE861_DATA.CNEDSL1  = DCLBE78000T.TILEVS_CNEDSL1;                 
      BE861_DATA.FLEJL    = DCLBE78000T.VURD_A_FLEJL_AKT;               
      BE861_DATA.DOVTGFOR = DCLBE78000T.TILEVS_DOVTGFOR;                
      BE861_DATA.CDATAFRA = DCLBE78000T.TILEVS_CDATAFRA;                
      BE861_DATA.CUDLHEL  = DCLBE78000T.TILEVS_CUDLHEL;                 
      BE861_DATA.CUDLDEL  = DCLBE78000T.TILEVS_CUDLDEL;                 
                                                                        
      PIC11 = DCLBE78000T.EJENDOM_VUREJENDOMID;                         
      CHAR11 = PIC11;                                                   
      BE861_DATA.VUREJENDOMID = SUBSTR(CHAR11,2);                       
      BE861_DATA.DVURDÅR = DCLBE78000T.VURD_A_DVURDÅR;                  
                                                                        
      HJ_VURD_A_VURMARK_AKT  = DCLBE78000T.VURD_A_VURMARK_AKT;          
      if DCLBE78000T.EKOMNR = 999                                       
       then                                                             
         do;                                                            
           if DCLBE78000T.VURD_A_VURMARK_AKT  = 0 then                  
             do;                                                        
             /* MBS VURMARK sættes til 299 i stedet for 99 */           
      /* Her testet ikke på årstal da det altid er efter 2023 herfra */ 
                HJ_VURD_A_VURMARK_AKT  = 299;                           
             end;                                                       
         end;                                                           
       else                                                             
         do;                                                            
           if (DCLBE78000T.TILEVS_CDATAFRA = '1' !                      
               DCLBE78000T.TILEVS_CDATAFRA = '2' !                      
               DCLBE78000T.TILEVS_CDATAFRA = '4' !                      
               DCLBE78000T.TILEVS_CDATAFRA = '5' !                      
               DCLBE78000T.TILEVS_CDATAFRA = '6' !                      
               DCLBE78000T.TILEVS_CDATAFRA = '7')  &                    
               DCLBE78000T.VURD_A_VURMARK_AKT  = 0                      
           then                                                         
             do;                                                        
             /* MBS VURMARK sættes til 299 i stedet for 99 */           
      /* Her testet ikke på årstal da det altid er efter 2023 herfra */ 
                HJ_VURD_A_VURMARK_AKT  = 299;                           
             end;                                                       
           if DCLBE78000T.VURD_A_BBERGRL_A_SW   = -1                    
              & DCLBE78000T.VURD_A_VURMARK_AKT > 0                      
              & DCLBE78000T.VURD_A_VURMARK_AKT  <> 299                  
              /* MBS VURMARK sættes til 299 i stedet for 99 */          
      /* Her testet ikke på årstal da det altid er efter 2023 herfra */ 
           then                                                         
             do;                                                        
                HJ_VURD_A_VURMARK_AKT= 299;                             
             end;                                                       
         end;                                                           
                                                                        
      BE861_DATA.VURD_A_VURMARK_AKT  = HJ_VURD_A_VURMARK_AKT;           
                                                                        
      IF DCLBE78000T.VURD_A_VURDATO = 0 THEN                            
        BE861_DATA.VURD_A_VURDATO = '';                                 
      ELSE                                                              
        DO;                                                             
          PIC9 = DCLBE78000T.VURD_A_VURDATO;                            
                                                                        
          CHAR10 = RIGHT(PIC9,10);                                      
          BE861_DATA.VURD_A_VURDATO =                                   
                  REPATTERN(CHAR10,'YYYY-MM-DD','YYYYMMDD', 1950);      
        END;                                                            
                                                                        
      TV.SKREVET = TV.SKREVET + 1;                                      
                                                                        
      WRITE FILE (BE861O) FROM (BE861_DATA);                            
                                                                        
 END DAN_DATA_TIL_SLUT;                                                 
 /*********************************************************************/
 /* Udfyld truktur til header og skriv denne                          */
 /*********************************************************************/
 DAN_BE861_HEAD: PROC;                                                  
                                                                        
   BE861_HEAD = '';                                                     
   BE861_HEAD.INDVNR  = 0001;                                           
   BE861_HEAD.INDKAAR = WS_TIL_EVS_AAR;                                 
   BE861_HEAD.KOERNR  = BE55650N.KOERNR;                                
   BE861_HEAD.KOERDTO = BE55650N.KOERDTO;                               
                                                                        
   WRITE FILE (BE861O) FROM (BE861_HEAD);                               
                                                                        
 END DAN_BE861_HEAD;                                                    
 /*********************************************************************/
 /* Udfyld truktur til trailer og skriv denne                         */
 /*********************************************************************/
 DAN_BE861_TRAIL: PROC;                                                 
                                                                        
    BE861_TRAIL = '';                                                   
    BE861_TRAIL.INDVNR = 0999;                                          
    BE861_TRAIL.PNR    = HJ_CHAR_10;                                    
    BE861_TRAIL.FINDV  = TV.SKREVET;                                    
                                                                        
    WRITE FILE (BE861O) FROM (BE861_TRAIL);                             
                                                                        
 END DAN_BE861_TRAIL;                                                   
 /*********************************************************************/
 /* Test om input felt er J eller N(eller noget andet)                */
 /* Hvis felt er = J så returneres '1', eller returneres 1  blank.    */
 /*********************************************************************/
 TJEK: PROC(FELT) RETURNS(CHAR(1));                                     
                                                                        
   DCL FELT CHAR(1);                                                    
                                                                        
   IF FELT = 'J' THEN                                                   
     RETURN('1');                                                       
   ELSE                                                                 
     RETURN(' ');                                                       
                                                                        
 END TJEK;                                                              
                                                                        
                                                                        
