 /**********************************************************************
 * PROJEKT:     EVS FORSKUD 2016 / SLUT 2014                           *
 * PROGRAMNAVN: BH30100M                                               *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK NYESTE BENYTTEDE LØBENR. PR. EJENDOM PR.    *
 *              PERSON FRA EVS FORSKUD 2014                            *
 * PROGRAMMØR:  THOMAS FLINDT         THF, PUS/T&S BRØNDBY 30.07.2001. *
 ***********************************************************************
 * ÆNDRINGSLOG: HANS E KJELDSEN       HKS, PUS/T&S BRØNDBY 01.11.2001. *
 ***********************************************************************
 *              OLUF MØRK             OMO, LSU/T&S BRØNDBY 24.06.2002. *
 *              ÅRSRULNING.                                            *
 ***********************************************************************
 *              ESBEN BRODERSEN       ESB, LSU/T&S BRØNDBY 02.12.2002. *
 *              EVS SLUT 2002.                                         *
 ***********************************************************************
 *              ESBEN BRODERSEN       ESB, LSU/T&S BALLERUP 11.08.2003.*
 *              EVS FORSKUD 2004                                       *
 ***********************************************************************
 *              BO SCHMIDT            BOB, LSU/T&S BALLERUP 09.06.2004.*
 *              EVS FORSKUD 2005                                       *
 ***********************************************************************
 *  FORSKUD06   SUSANNE KROGH VILLUMSEN SKV    T&S BALLERUP 25.05.2005.*
 *              EVS FORSKUD 2006                                       *
 ***********************************************************************
 *  FORSKUD07   BO SCHMIDT              BOB,   T&S BALLERUP 11.05.2006.*
 *              EVS FORSKUD 2007                                       *
 ***********************************************************************
 *  FORSKUD08   BO SCHMIDT              BOB,   T&S BALLERUP 22.05.2007.*
 *              EVS FORSKUD 2008                                       *
 ***********************************************************************
 *  FORSKUD09   BO SCHMIDT              BOB,   T&S BALLERUP 24.04.2008.*
 *              EVS FORSKUD 2009                                       *
 ********************************************************************** 
 *  FORSKUD10   GERD HOLM-PEDERSEN      GEH,   PKF/PKA      07.04.2009.*
 *              EVS FORSKUD 2010                                       *
 *KRAV.#0602    NYE FELTER: BBERGRL OG BBER2FAM                        *
 *KRAV.#0904    NYT FELT:   CEKSEMP                         23.06.2009 *
 ********************************************************************** 
 *  FORSKUD11   GERD HOLM-PEDERSEN      GEH,   PKF/PKA      28.05.2010.*
 *              EVS FORSKUD 2011                                       *
 ********************************************************************** 
 *  FORSKUD12   GERD HOLM-PEDERSEN      GEH,   PR           12.05.2011.*
 *              EVS FORSKUD 2012                                       *
 ********************************************************************** 
 *  FORSKUD13   ESBEN BRODERSEN         ESB,   PR           15.05.2012.*
 *              EVS FORSKUD 2013                                       *
 *              DEFECT #521 BUDLSKC FELT 910 HENTES FRA TABEL BN00600T *
 ********************************************************************** 
 *  FORSKUD14   ESBEN BRODERSEN         ESB,   PR           21.05.2012.*
 *              EVS FORSKUD 2014                                       *
 ***********************************************************************
 *  FORSKUD15   JØRGEN SAUGMANN         QQS,   PR           30.06.2014.*
 *              EVS FORSKUD 2015                                       *
 ***********************************************************************
 *  FORSKUD16   Z6JNK. Årsrullet                            08.06.2015.*
 ***********************************************************************
 * SLUT15       ESBEN BRODERSEN         QEB                 09.03.2016 *
 *              ÅRSTAL TAGES FRA BH65300M #01                          *
 ***********************************************************************
 * FORSKUD17    QEB                                         05.08.2016 *
 *              PARMKORT TIL BRUGTEST                                  *
 **********************************************************************/
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF PERSONTABEL BN00600T             RUTINE */
 /*********************************************************************/
 DECLARE_PERSONEJENDOMSOPL: PROC;                                       
                                                                        
         EXEC SQL DECLARE PERSON_CURSOR CURSOR WITH HOLD FOR            
                                                                        
              SELECT T1.DINDKAAR                                        
                    ,T1.PERSONNUMMER                                    
                    ,T1.EKOMNR                                          
                    ,T1.EEJDNR                                          
                    ,T1.ELBNR                                           
                    ,T1.DFRAGLD                                         
                    ,T1.DTILGLD                                         
                    ,T1.CEVSBENY                                        
                    ,T1.CEJBEVS                                         
                    ,T1.COPR_CEJBEVS                                    
                    ,T1.CEJDTYPE                                        
                    ,T1.BPROM1                                          
                    ,T1.CNEDSL1                                         
                    ,T1.DATO0107                                        
                    ,T1.DOVTG                                           
                    ,T1.DAFSTAA                                         
                    ,T1.DINDFLYT                                        
                    ,T1.DFRAFLYT                                        
                    ,T1.GPCTEJER                                        
                    ,T1.FDAGUDLE                                        
                    ,T1.GPCTUDLE                                        
                    ,T1.FDAGERHV                                        
                    ,T1.GPCTERHV                                        
                    ,T1.B100                                            
                    ,T1.BEJERAN                                         
                    ,T1.CFRED                                           
                    ,T1.BNYMAN                                          
                    ,T1.BBRUTTO                                         
                    ,T1.CENKE                                           
                    ,T1.FDAGEJ                                          
                    ,T1.CEKSEMP                          /* #0904 */    
                    ,T1.COPR_EKSEMP                      /* #0904 */    
                    ,T1.BBERGRL                          /* #0602 */    
                    ,T1.BBER2FAM                         /* #0602 */    
                    ,T2.EJDBELIG                                        
                    ,T2.LANDEKODE                                       
                    ,T1.BUDLSKC         /*FORSKUD 2013 DEFECT #521*/    
                    ,T1.CSLET           /*FORSKUD 2017 RET #01    */    
                                                                        
         FROM BN00600T T1, BN00500T T2                                  
                                                                        
         WHERE T1.DINDKAAR = :BH65300M.SLUTÅR   /*#01*/                 
         AND   T1.DINDKAAR = T2.DINDKAAR                                
         AND   T1.EKOMNR   = T2.EKOMNR                                  
         AND   (:PARMKOMNR1 = 0  OR                                     
               (:PARMKOMNR1 <> 0 AND                                    
                T1.EKOMNR IN (:PARMKOMNR1, 999)) OR                     
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0 AND               
                T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2, 999)) OR         
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0                   
                 AND :PARMKOMNR3 <> 0 AND                               
                 T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2,                 
                               :PARMKOMNR3, 999)))                      
         AND   T1.EEJDNR   = T2.EEJDNR                                  
      /* AND   T1.CSLET   ^= '1' */  /* QEB F2017 KS30-01*/             
         AND   T1.DTILGLD IN (SELECT MAX(T3.DTILGLD)                    
                              FROM BN00600T T3                          
                              WHERE T1.PERSONNUMMER = T3.PERSONNUMMER   
                              AND   T1.DINDKAAR     = T3.DINDKAAR       
                              AND   T1.EKOMNR       = T3.EKOMNR         
                              AND   T1.EEJDNR       = T3.EEJDNR         
                              AND   T1.ELBNR        = T3.ELBNR)         
                                                                        
         ORDER BY T1.PERSONNUMMER,                                      
                  T1.EKOMNR,                                            
                  T1.EEJDNR,                                            
                  T1.ELBNR                                              
         ;                                                              
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'DECLARE PERSONCURSOR';                        
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END DECLARE_PERSONEJENDOMSOPL;                                         
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF PERSONTABEL BN00600T                      */
 /*********************************************************************/
 FETCH_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL FETCH PERSON_CURSOR                                   
                                                                        
         INTO :PERSONEJENDOMSOPL.DINDKAAR                               
             ,:PERSONEJENDOMSOPL.PERSONNUMMER                           
             ,:PERSONEJENDOMSOPL.EKOMNR                                 
             ,:PERSONEJENDOMSOPL.EEJDNR                                 
             ,:PERSONEJENDOMSOPL.ELBNR                                  
             ,:PERSONEJENDOMSOPL.DFRAGLD                                
             ,:PERSONEJENDOMSOPL.DTILGLD                                
             ,:PERSONEJENDOMSOPL.CEVSBENY                               
             ,:PERSONEJENDOMSOPL.CEJBEVS                                
             ,:PERSONEJENDOMSOPL.COPR_CEJBEVS                           
             ,:PERSONEJENDOMSOPL.CEJDTYPE                               
             ,:PERSONEJENDOMSOPL.BPROM1                                 
             ,:PERSONEJENDOMSOPL.CNEDSL1                                
             ,:PERSONEJENDOMSOPL.DATO0107                               
             ,:PERSONEJENDOMSOPL.DOVTG                                  
             ,:PERSONEJENDOMSOPL.DAFSTAA                                
             ,:PERSONEJENDOMSOPL.DINDFLYT                               
             ,:PERSONEJENDOMSOPL.DFRAFLYT                               
             ,:PERSONEJENDOMSOPL.GPCTEJER                               
             ,:PERSONEJENDOMSOPL.FDAGUDLE                               
             ,:PERSONEJENDOMSOPL.GPCTUDLE                               
             ,:PERSONEJENDOMSOPL.FDAGERHV                               
             ,:PERSONEJENDOMSOPL.GPCTERHV                               
             ,:PERSONEJENDOMSOPL.B100                                   
             ,:PERSONEJENDOMSOPL.BEJERAN                                
             ,:PERSONEJENDOMSOPL.CFRED                                  
             ,:PERSONEJENDOMSOPL.BNYMAN:INDK_PERS.BNYMAN_I              
             ,:PERSONEJENDOMSOPL.BBRUTTO                                
             ,:PERSONEJENDOMSOPL.CENKE                                  
             ,:PERSONEJENDOMSOPL.FDAGEJ                                 
             ,:PERSONEJENDOMSOPL.CEKSEMP                 /* #0904 */    
             ,:PERSONEJENDOMSOPL.COPR_EKSEMP             /* #0904 */    
             ,:PERSONEJENDOMSOPL.BBERGRL                 /* #0602 */    
             ,:PERSONEJENDOMSOPL.BBER2FAM                /* #0602 */    
             ,:EJENDOMSOPL.EJDBELIG                                     
             ,:EJENDOMSOPL.LANDEKODE                                    
             ,:PERSONEJENDOMSOPL.BUDLSKC    /*FORSKUD 2013 DEFECT #521*/
             ,:PERSONEJENDOMSOPL.CSLET      /*FORSKUD 2017 RET #1 */    
                                                                        
         ;                                                              
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                       
                                                                        
               IF PERSONEJENDOMSOPL.EKOMNR = 999                        
                & EJENDOMSOPL.LANDEKODE ^= ' '                          
               THEN                                                     
                  CALL CHECK_CEKSEMP;                                   
                                                                        
           /*  IF PERSONEJENDOMSOPL.PERSONNUMMER = 0101060055           
               THEN                                                     
                  TFLAG = '1'B;                                         
               ELSE                                                     
                  TFLAG = '0'B;*/                                       
             END;                                                       
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'FETCH PERSONCURSOR';                       
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 CHECK_CEKSEMP: PROC;                                                   
                                                                        
         EXEC SQL                                                       
              SELECT LEMPELSESKODE                                      
              INTO   :BN03300T.LEMPELSESKODE                            
              FROM   BN03300T                                           
              WHERE  YEAR(STARTDATO) <= :BH65300M.SLUTÅR   /*#01*/      
               AND   YEAR(SLUTDATO)  >= :BH65300M.SLUTÅR   /*#01*/      
               AND   LANDEKODE = :EJENDOMSOPL.LANDEKODE;                
                                                                        
          IF SQLCA.SQLCODE = 0                                          
          THEN                                                          
             DO;                                                        
               IF PERSONEJENDOMSOPL.CEKSEMP ^= BN03300T.LEMPELSESKODE   
               THEN                                                     
                  PERSONEJENDOMSOPL.CEKSEMP = BN03300T.LEMPELSESKODE;   
             END;                                                       
                                                                        
 END CHECK_CEKSEMP;                                                     
