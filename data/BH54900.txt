 BH54900: PROCEDURE OPTIONS (MAIN);                                     
 /*********************************************************************/
 /*********************************************************************/
 /* OBS : DETTE PROGRAM KAN IKKE PROMOTES LÆNGERE END TIL TEST, DA    */
 /*       TABELLERNE KUN LIGGER HER. INAKTIVER PROGRAMMET INDEN DER   */
 /* FULL  PROMOTES TIL SYST OG BRUGTEST.                              */
 /* OBS.: ÅRSRULNING ER IKKE NØDVENDIG MED MINDRE DER ER ÆNDRINGER    */
 /*       TIL SQL'LET (F.EKS. TABELNAVN) DER LAVER UDTRÆKKET FRA COR. */
 /*       M E N  PROGRAMMET SKAL KOMPILERES NÅR MAKRO BH65300M ER     */
 /*       ÅRSRULLET (D.V.S. ÅRSTAL OG DATOER ER RETTET TIL NYT ÅR)    */
 /*       HVILKET SKER I FORBINDELSE MED ÅRSRULNING TIL EVS FORSKUD.  */
 /*********************************************************************/
 /**********************************************************************
 * PROJEKT:     EVS FORSKUD / EVS SLUT                                 *
 * PROGRAMNAVN: BH54900.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    PROGRAMMET UDTRÆKKER EFTERLØNSMODTAGERE FRA COR VEDR.  *
 *              'GAMMELT' SLUTÅR.                                      *
 *              PROGRAMMET AFVIKLES KUN I BALLERUP.                    *
 * PGMFORLØB:   1. ÅBEN COR-REGISTER.                                  *
 *              2. DECLARE CORCURSOR.                               *   
 *              3. OPEN CORCURSOR.                                  *   
 *              4. LÆS/FETCH RÆKKE PÅ COR-TABEL.                       *
 *              5. BEHANDL DATA TIL FILSTRUKTUR.                       *
 *              6. LÆS RÆKKE PÅ UDTRÆKSREGISTER BQ64000T               *
 *              7. Hvis række findes, Update BQ64000T, ellers Insert   *
 *              8. LUK CORCURSOR.                                   *   
 *              9. LUK COR UDTRÆKSFIL.                                 *
 *             10. SKRIV KONTROLLISTE.                                 *
 * INDDATA:     BG40400T - COR TABEL. OBS.: FRA OG MED COR 2006 ER     *
 *                                          NAVNET ÆNDRET FRA BC51500T *
 *                                          TIL BG40400T.              *
 * UDDATA:      BQ64000T - COR UDTRÆK                                  *
 *              BH54901Y - KONTROLLISTE.                               *
 * KONSTRUKTØR: AAGE RASMUSSEN        AAR, LSU/T&S BRØNDBY 23.05.2001. *
 ***********************************************************************
 * ÆNDRINGSLOG: OLUF MØRK             OMO, LSU/T&S BRØNDBY 21.06.2002. *
 *              ÅRSTILRETNING F2003.                                   *
 * ÆNDRINGSLOG: BO SCHMIDT            BOB, LSU/T&S         02.07.2003. *
 *              ÅRSTILRETNING F2004.                                   *
 * ÆNDRINGSLOG: BO SCHMIDT            BOB, LSU/T&S         13.05.2004. *
 *              ÅRSTILRETNING F2005.                                   *
 * ÆNDRINGSLOG: AAGE RASMUSSEN        AAR, LSU/T&S         14.10.2004. *
 *              BH65300M INDLAGT SÅ ÅRSRULNING ER OVERFLØDIGGJORT      *
 *              JVF. BEMÆRKNING HEROM OVENFOR MEN HUSK KOMPILERING!    *
 * ÆNDRINGSLOG: Lene Maj Jensen       QLE                  09.01.2017  *
 *              Omlægning af cor udtræk til DB2                        *
 *              samt tilføjelse af oprydningsdel ved omkørsel          *
 **********************************************************************/
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KOMMUNEDATA A/S 2004');    
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE BG40400T;        /* COR TABELLEN            */
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
         EXEC SQL INCLUDE BQ64000T;  /* COR UDTRÆK                    */
         EXEC SQL INCLUDE BQ6400HT;  /* COR UDTRÆK historik           */
                                                                        
         EXEC SQL INCLUDE BQ69000T;  /* Kørselstabel                  */
         EXEC SQL INCLUDE BQ6900HT;  /* Kørselstabel hist             */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
                                                                        
 DCL     WS_FORSKUD_SLUT_TXT            CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
 DCL     WS_GLSLUTÅR                    BIN FIXED (15);                 
                                                                        
 DCL     WS_TIL_EVS_AAR_GL              BIN FIXED (15);                 
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_PROGRAMNAVN                 CHAR(8)  INIT ('BH54900');      
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 DCL     1 BH549_PARM,                                                  
           %INCLUDE BH54900N;                                           
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF_BH549          BIT       (1);                              
 DCL     JA                 BIT       (1)     INIT ('1'B);              
 DCL     NEJ                BIT       (1)     INIT ('0'B);              
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF ABEND STRUKTUR m.v.                               */
 /*                                                                   */
 /*********************************************************************/
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH54900'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER TIL KONTROLLISTEN                     */
 /*********************************************************************/
                                                                        
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (1),                                 
          2 FILLER       CHAR      (132)     INIT      (' ');           
                                                                        
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (1),                                 
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH54900L'),                                        
           2 F1          CHAR      (23)      INIT      (' '),           
           2 TEKST2      CHAR      (43)      INIT      (                
           'UDTRÆK EFTERLØNSMODTAGERE FRA COR-REGISTER '),              
           2 ÅR          PIC       '9999',                              
           2 F2          CHAR      (21)      INIT      ((21)' '),       
           2 TEKST4      CHAR      (14)      INIT      (                
           'UDSKREVET DEN '),                                           
           2 DATO        CHAR      (10);                                
                                                                        
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (1),                                 
           2 F1          CHAR      (53)      INIT      (' '),           
           2 TEKST1      CHAR      (79)      INIT                       
           ('KØRSELSKONTROLLISTE');                                     
                                                                        
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (1),                                 
           2 TEKST       CHAR      (53),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZ9',                       
           2 F1          CHAR      (68)      INIT      (' ');           
                                                                        
         % INCLUDE ZZ20301M;                                            
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
 DCL     BH549I FILE RECORD INPUT;     /* Parameter Forskud-Slut */     
                                                                        
 /*********************************************************************/
 /* DECLARE STRUKTURER                                                */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /*      DECLARE AF ENTRIES                                           */
 /*********************************************************************/
                                                                        
 DCL     ZS61900         ENTRY;              /* UDSKRIV SSI-DATO      */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     ADDR            BUILTIN;                                       
 DCL     NULL            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANT_SKR BIN FIXED (31) INIT(0);   /* ANTAL SKREVET PÅ UDTRÆK */
 DCL     ANT_INS BIN FIXED (31) INIT(0);   /* heraf insert            */
 DCL     ANT_UPD BIN FIXED (31) INIT(0);   /* heraf updates           */
 DCL     ANT_COMM BIN FIXED (31) INIT(0);  /* COMMIT TÆLLER           */
 /*********************************************************************/
 /* DECLARE AF CURSORS                                                */
 /*********************************************************************/
         EXEC SQL DECLARE CORCURSOR CURSOR WITH HOLD FOR                
                                                                        
              SELECT T1.PERSONNUMMER                                    
                    ,T1.BEFTLOEN                                        
                    ,T1.INDKOMSTAAR                                     
                                                                        
              FROM BG40400T T1                                          
                                                                        
              WHERE T1.INDKOMSTAAR = :WS_GLSLUTÅR                       
              AND   T1.BEFTLOEN > 0                                     
              ORDER BY T1.PERSONNUMMER;                                 
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BH549 = NEJ;                                               
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH54900L');             
            END;                                                        
                                                                        
         OPEN FILE (BH549I) TITLE ('BH54900P');                         
                                                                        
         ON ENDFILE (BH549I)                                            
         BEGIN;                                                         
            EOF_BH549 = JA;                                             
         END;                                                           
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
         READ FILE (BH549I) INTO (BH549_PARM);                          
                                                                        
         IF EOF_BH549 = NEJ                                             
         THEN DO;                                                       
            SELECT (BH549_PARM.FS_MRK);                                 
               WHEN ('F')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH549_PARM.FORSKUD_TXT;      
                     WS_TIL_EVS_AAR = BH65300M.FORSKÅR;                 
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH549_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('S')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH549_PARM.SLUT_TXT;         
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH549_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('U')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH549_PARM.SUPPL_TXT;        
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH549_PARM.SLUT_TXT;       
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
         END;                                                           
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL('START',BH549_PARM.FS_MRK);          
                                                                        
         DCLBG40400T = '';                                              
         DCLBQ64000T = '';                                              
         DCLBQ69000T = '';                                              
                                                                        
         WS_GLSLUTÅR = BH65300M.GLSLUTÅR;                               
                                                                        
         CALL ZZ20390('*OPEN','BH54901Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.ÅR   = WS_GLSLUTÅR;                                   
         OVERLIN1.DATO = UDDATO;                                        
         SIDELIN.CCA   = ZZIK1;                                         
         OVERLIN1.CCA  = ZZWS2;                                         
         OVERLIN2.CCA  = ZZWS3;                                         
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         CALL CLOSE_CORCURSOR;                                          
         CALL OPEN_CORCURSOR;                                           
         CALL FETCH_CORCURSOR;                                          
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               DO WHILE (SQLCA.SQLCODE = 0);                            
                  /* check om der findes en række, og  */               
                  /* insert eller update efterfølgende */               
                  CALL INSERT_UPDATE_COR_OPL;                           
                  CALL FETCH_CORCURSOR;                                 
               END;                                                     
             END;                                                       
                                                                        
           WHEN (100)                                                   
             DO;                                                        
             END;                                                       
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH CORCURSOR';                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         IF ANT_COMM > 0                                                
         THEN DO;                                                       
            EXEC SQL COMMIT;                                            
            Put skip list ('Commit efter ' !! ANT_COMM !!               
                           ' opdateringer.  Ialt ' !! ANT_SKR !!        
                           ' opdateringer');                            
            ANT_COMM = 0;                                               
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF COR-TABEL BG40400T                  RUTINE */
 /*********************************************************************/
 OPEN_CORCURSOR: PROC;                                                  
                                                                        
         EXEC SQL OPEN CORCURSOR;                                       
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              ABENDTXT = '101 OPEN CORCURSOR';                          
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_CORCURSOR;                                                    
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF COR-TABEL BG40400T                 RUTINE */
 /*********************************************************************/
 FETCH_CORCURSOR: PROC;                                                 
                                                                        
         EXEC SQL FETCH CORCURSOR                                       
                                                                        
         INTO :DCLBG40400T.PERSONNUMMER                                 
             ,:DCLBG40400T.BEFTLOEN                                     
             ,:DCLBG40400T.INDKOMSTAAR                                  
         ;                                                              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0);                                                    
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH CORCURSOR';                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_CORCURSOR;                                                   
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF COR-TABEL BG40400T                 RUTINE */
 /*********************************************************************/
 CLOSE_CORCURSOR: PROC;                                                 
                                                                        
         EXEC SQL CLOSE CORCURSOR;                                      
                                                                        
 END CLOSE_CORCURSOR;                                                   
                                                                        
 /*********************************************************************/
 /* LÆS COR OPLYSNINGER, CHECK OM række findes                 RUTINE */
 /*********************************************************************/
 INSERT_UPDATE_COR_OPL: PROC;                                           
         DCLBQ64000T = '';                                              
         DCLBQ64000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ64000T.INDKOMSTAAR    = DCLBG40400T.INDKOMSTAAR;          
         DCLBQ64000T.DCPRN          = DCLBG40400T.PERSONNUMMER;         
         DCLBQ64000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ64000T.DB2FUNKTION    = 'I';                              
         DCLBQ64000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ64000T.BEFTLØN        = DCLBG40400T.BEFTLOEN;             
                                                                        
         EXEC SQL                                                       
            SELECT TIL_EVS_AAR,INDKOMSTAAR,DCPRN,PROGRAMNAVN,DB2FUNKTION
                  ,AFVIKLINGS_ID,BEFTLØN                                
            INTO   :DCLBQ64000T.TIL_EVS_AAR,                            
                   :DCLBQ64000T.INDKOMSTAAR,                            
                   :DCLBQ64000T.DCPRN,                                  
                   :DCLBQ64000T.PROGRAMNAVN,                            
                   :DCLBQ64000T.DB2FUNKTION,                            
                   :DCLBQ64000T.AFVIKLINGS_ID,                          
                   :DCLBQ64000T.BEFTLØN                                 
            FROM BQ64000T                                               
            WHERE TIL_EVS_AAR   = :DCLBQ64000T.TIL_EVS_AAR              
            AND   DCPRN         = :DCLBQ64000T.DCPRN                    
            AND   AFVIKLINGS_ID = :DCLBQ64000T.AFVIKLINGS_ID;           
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               CALL UPDATE_EVS_COROPL;                                  
            END;                                                        
            WHEN(100) DO;                                               
               CALL INSERT_EVS_COROPL;                                  
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 INSERT_UPDATE_COR_OPL';                  
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
         IF ANT_COMM > 9999                                             
         THEN DO;                                                       
            EXEC SQL COMMIT;                                            
            Put skip list ('Commit efter ' !! ANT_COMM !!               
                           ' opdateringer.  Ialt ' !! ANT_SKR !!        
                           ' opdateringer');                            
            ANT_COMM = 0;                                               
         END;                                                           
                                                                        
 END INSERT_UPDATE_COR_OPL;                                             
                                                                        
 /*********************************************************************/
 /* BEHANDL OG SKRIV EVS OPLYSNINGER                           RUTINE */
 /*********************************************************************/
 INSERT_EVS_COROPL: PROC;                                               
                                                                        
         DCLBQ64000T = '';                                              
         DCLBQ64000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ64000T.DCPRN          = DCLBG40400T.PERSONNUMMER;         
         DCLBQ64000T.BEFTLØN        = DCLBG40400T.BEFTLOEN;             
         DCLBQ64000T.INDKOMSTAAR    = DCLBG40400T.INDKOMSTAAR;          
         DCLBQ64000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ64000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ64000T.DB2FUNKTION    = 'I';                              
                                                                        
         EXEC SQL                                                       
            INSERT INTO BQ64000T                                        
            (                                                           
            TIL_EVS_AAR,INDKOMSTAAR,DCPRN,PROGRAMNAVN,DB2FUNKTION       
            ,AFVIKLINGS_ID,BEFTLØN                                      
            )                                                           
            values                                                      
            (                                                           
             :DCLBQ64000T.TIL_EVS_AAR,                                  
             :DCLBQ64000T.INDKOMSTAAR,                                  
             :DCLBQ64000T.DCPRN,                                        
             :DCLBQ64000T.PROGRAMNAVN,                                  
             :DCLBQ64000T.DB2FUNKTION,                                  
             :DCLBQ64000T.AFVIKLINGS_ID,                                
             :DCLBQ64000T.BEFTLØN                                       
            );                                                          
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_INS = ANT_INS + 1;                                   
               ANT_COMM = ANT_COMM + 1;                                 
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 INSERT_EVS_COROPL';                      
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
                                                                        
 END INSERT_EVS_COROPL;                                                 
 /*********************************************************************/
 /* UPDATE række på COR OPLYSNINGER                            RUTINE */
 /*********************************************************************/
 UPDATE_EVS_COROPL: PROC;                                               
                                                                        
         DCLBQ64000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ64000T.DB2FUNKTION    = 'U';                              
         DCLBQ64000T.INDKOMSTAAR    = DCLBG40400T.INDKOMSTAAR;          
         DCLBQ64000T.BEFTLØN        = DCLBG40400T.BEFTLOEN;             
                                                                        
         EXEC SQL                                                       
            UPDATE BQ64000T                                             
            SET PROGRAMNAVN     = :DCLBQ64000T.PROGRAMNAVN,             
                DB2FUNKTION     = :DCLBQ64000T.DB2FUNKTION,             
                INDKOMSTAAR     = :DCLBQ64000T.INDKOMSTAAR,             
                BEFTLØN         = :DCLBQ64000T.BEFTLØN                  
            WHERE TIL_EVS_AAR   = :DCLBQ64000T.TIL_EVS_AAR              
            AND   DCPRN         = :DCLBQ64000T.DCPRN                    
            AND   AFVIKLINGS_ID = :DCLBQ64000T.AFVIKLINGS_ID;           
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_UPD = ANT_UPD + 1;                                   
               ANT_COMM = ANT_COMM + 1;                                 
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 UPDATE_EVS_COROPL';                      
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END UPDATE_EVS_COROPL;                                                 
                                                                        
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /*********************************************************************/
 /*      UDSKRIV KØRSELSKONTROLLISTE                                  */
 /*********************************************************************/
 KONTROLLISTE:                                                          
 PROC;                                                                  
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
                                                                        
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA   = ZZWS1;                                         
         DETLIN1.TEKST =                                                
         'ANTAL UDTRUKNE EFTERLØNSMODTAGERE PÅ B.H64900D';              
         DETLIN1.ANTAL = ANT_SKR;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
         DETLIN1.TEKST =                                                
         '   HERAF NYE RÆKKER (INSERT)';                                
         DETLIN1.ANTAL = ANT_INS;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
         DETLIN1.TEKST =                                                
         '   HERAF OPDATEREDE RÆKKER (UPDATES)';                        
         DETLIN1.ANTAL = ANT_UPD;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
 END KONTROLLISTE;                                                      
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL KONTROLLISTE;                                             
                                                                        
         CALL CLOSE_CORCURSOR;                                          
         CLOSE FILE (BH549I);                                           
                                                                        
         CALL ZZ20300(' ','99');                                        
                                                                        
         CALL OPDATER_KØRSELSTABEL('SLUT',BH549_PARM.FS_MRK);           
                                                                        
 END AFSLUT;                                                            
 %INCLUDE BH54998M; /* OPDATER KØRSELSTABEL */                          
 END BH54900;                                                           
