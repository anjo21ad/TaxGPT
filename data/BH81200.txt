  PROCESS OPT(TIME);                                                    
 BH81200: /* SKAF EVS SLUT-AKTUELT-ÅR-BELØB TIL BOT-NÆSTE-ÅR-PROD.   */ 
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /********************************************************************/ 
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KMD A/S 2004');               
 /********************************************************************  
 *                                                                    * 
 * FORMÅL : AT SKAFFE EJENDOMSVÆRDISKATTEN FOR AKTUELT ÅR TIL BRUG    * 
 *          VED BEREGNING AF BOLIGYDELSE FOR KOMMENDE ÅR.             * 
 *          (PRODUKTIONSBEREGNING). EJENDOMSVÆRDISKATTEN HENTES FRA   * 
 *          FORSKUD-"KOMMENDE ÅR"-EVS-BEREGNINGSBÅND FOR DE AF BOT    * 
 *          ØNSKEDE PERSONER/EJENDOMME. IDENTER FOR DISSE ER ANGIVET  * 
 *          I UDTRÆKKET FRA ESR.                                      * 
 *                                                                    * 
 * INPUT  : B.H95000D.FOR BEREGNINGSBÅND MED EVS TIL FORSKUDS ÅRET    * 
 *          C.N57131D  UDTRÆK FRA ESR - SORTERET                      * 
 *                                                                    * 
 * OUTPUT : B.H81200D  UDTRÆK MED ØNSKEDE PERSONER/EJENDOMME TIL BOT  * 
 *          BH81201Y   KØRSELSKONTROLLISTE                            * 
 *                                                                    * 
 * PROGRAMMØR: AAGE RASMUSSEN   PUS T&S FORSKUD     OKTOBER 2000      * 
 *--------------------------------------------------------------------* 
 * ÅRSRUL:     SUSANNE VILLUMSEN  *FORSKUD06*       AUGUST  2005      * 
 * ÅRSRUL:     BO SCHMIDT         *FORSKUD07*       AUGUST  2006      * 
 * ÅRSRUL:     BO SCHMIDT         *FORSKUD08*       AUGUST  2007      * 
 * ÅRSRUL:     BO SCHMIDT         *FORSKUD09*       JUN     2008      * 
 * ÅRSRUL:     GERD HOLM-PEDERSEN *FORSKUD10*       APRIL   2009      * 
 * ÅRSRUL:     GERD HOLM-PEDERSEN *FORSKUD11*       JUNI    2010      * 
 * ÅRSRUL:     GERD HOLM-PEDERSEN *FORSKUD12*       JUNI    2011      * 
 * ÅRSRUL:     LARS KAAE HARRITSHØJ *FORSKUD13*     JUNI    2012      * 
 * ÅRSRUL:     LARS KAAE HARRITSHØJ *FORSKUD14*     MAJ     2013      * 
 * ÅRSRUL:     JØRGEN SAUGMANN      *FORSKUD15*     OKT     2014      * 
 * ÅRSRUL:     JNK                  *FORSKUD16*     NOV     2015      * 
 * ÅRSRUL:     QEB OMLAGT TIL       *FORSKUD17*     JUN     2016      * 
 *             ÅRSTALS MACRO BH65300M                                 * 
 *********************************************************************/ 
                                                                        
 /********************************************************************/ 
 /*    ÅRSRULNING OMFATTER 'NORMALT' KUN FREMSKRIVNING AF ÅRSTAL     */ 
 /*    D.V.S. TIL GL. VÆRDI + 1 OGSÅ I EVT. KOMMENTARER.             */ 
 /*    DEREFTER SKAL DER KUN KOMPILERES M.V. DA STRUKTUREN BH90100N  */ 
 /*    ÆNDRES HVERT ÅR.                                              */ 
 /********************************************************************/ 
                                                                        
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     CN571I  FILE RECORD INPUT;          /* ESR UDTRÆK           */ 
 DCL     BH950I  FILE RECORD INPUT;          /* EVS BEREGNINGSBÅND   */ 
 DCL     BH812O  FILE RECORD OUTPUT;         /* BOY UDTRÆK           */ 
 DCL     SYSPRINT FILE OUTPUT;                                          
 /********************************************************************* 
 *       DECLARE AF UDTRÆK FRA ESR                                    * 
 *********************************************************************/ 
 DCL     1 CN571,                                                       
           %INCLUDE CN57100N;                                           
 DCL     1 CN571_ID1,                                                   
           2 DCPRCIR     FIXED     (11),                                
           2 EKOMNR      FIXED     (3),                                 
           2 EEJDNR      FIXED     (7);                                 
 DCL     CN571_ID        CHAR      (12)   BASED(ADDR(CN571_ID1));       
 /********************************************************************* 
 *       DECLARE AF EVS UDTRÆK                                        * 
 *********************************************************************/ 
 DCL     BH950_AR        CHAR      (6000) VAR;                          
 DCL     1 BH950         BASED     (ADDR(BH950_AR)),                    
           2 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90100N;;                                          
 DCL     1 BH95099       BASED     (ADDR(BH950_AR)),                    
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90099N;                                           
 DCL     1 BH950_ID1,                                                   
           2 DCPRN       FIXED     (11),                                
           2 EKOMNR      FIXED     (3),                                 
           2 EEJDNR      FIXED     (7);                                 
 DCL     BH950_ID        CHAR      (12)   BASED(ADDR(BH950_ID1));       
 /********************************************************************* 
 *       DECLARE AF UDTRÆK TIL BOY                                    * 
 *********************************************************************/ 
 DCL     1 BH812,                                                       
           %INCLUDE BH81100N;                                           
                                                                        
 /********************************************************************* 
 *       DECLARE AF ÅRSTALS INCLUDE                                   * 
 *********************************************************************/ 
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 DCL     1 TV,                        /* TÆLLEVÆRKER TIL TOTALLISTEN */ 
           2 LÆS_CN571   FIXED DEC (7),                                 
           2 LÆS_BH950   FIXED DEC (7),                                 
           2 SKREVET     FIXED DEC (7),                                 
           2 EJFUNDET    FIXED DEC (7),                                 
           2 FUNDET      FIXED DEC (7),                                 
           2 BEREGNET    FIXED DEC (7),                                 
           2 EVS         FIXED DEC (15,2),                              
           2 EJBEREGN    FIXED DEC (7);                                 
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
                                                                        
 DCL     GLBNETTO        FIXED     (11,2);                              
 DCL     EOF_CN571       BIT       (1);                                 
 DCL     EOF_BH950       BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     HJVÆRDI3        FIXED     (13,0);                              
 DCL     HJVÆRDI4        FIXED     (15,1);                              
 DCL     HJPCT           FIXED     (5,4);                               
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     MULTIPLY        BUILTIN;                                       
 DCL     DIVIDE          BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH81200L'),                                        
           2 F1          CHAR      (25)      INIT      (' '),           
           2 TEKST2      CHAR      (55)      INIT      (' '),           
           2 F2          CHAR      (14)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'Z.ZZZ.ZZ9',                         
           2 F2          CHAR      (63)      INIT      ((63)' ');       
 DCL     1 DETLIN3,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'Z.ZZZ.ZZ9',                         
           2 F2          CHAR      (10)      INIT      (' '),           
           2 TEKST2      CHAR      (07)      INIT      ('BELØB: '),     
           2 BELØB       PIC       'Z.ZZZ.ZZZ.ZZZ.ZZ9,V99',             
           2 F3          CHAR      (26)      INIT      ((26)' ');       
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
                                                                        
 OVERLIN1.TEKST2 =  'SKAF EVS ' !! BH65300M.INDKÅR1 !! ' TIL ' !!       
                    'BEREGNING AF BOLIGYDELSE ' !! BH65300M.INDKÅR2;    
                                                                        
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
         EOF_CN571 = NEJ;                                               
         EOF_BH950 = NEJ;                                               
         ON ERROR CALL PLIDUMP ('SNHOB');                               
         OPEN FILE (CN571I)   TITLE ('CN57131I');                       
         OPEN FILE (BH950I)   TITLE ('BH95000I');                       
         OPEN FILE (BH812O)   TITLE ('BH81200O');                       
         ON ENDFILE (CN571I)                                            
         BEGIN;                                                         
            EOF_CN571 = JA;                                             
            CN571_ID1.DCPRCIR = 99999999999;                            
            CN571_ID1.EKOMNR  = 999;                                    
            CN571_ID1.EEJDNR  = 9999999;                                
         END;                                                           
         ON ENDFILE (BH950I)                                            
         BEGIN;                                                         
            EOF_BH950 = JA;                                             
            BH950_ID1.DCPRN  = 99999999999;                             
            BH950_ID1.EKOMNR = 999;                                     
            BH950_ID1.EEJDNR = 9999999;                                 
         END;                                                           
                                                                        
         CALL ZZ20390 ('*OPEN','BH81201Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
                                                                        
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS2;                                        
         OVERLIN2.CCA   = ZZWS3;                                        
                                                                        
         TV = '';                                                       
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_CN571;                                                
         CALL LÆS_BH950;                                                
                                                                        
         DO WHILE (EOF_CN571 = NEJ ! EOF_BH950 = NEJ);                  
            SELECT;                                                     
               WHEN (BH950.CINVPNR ^= '0')                              
                  CALL LÆS_BH950;                                       
               WHEN (BH950.AKT_EJER.DCPRCIR = 0)                        
                  CALL LÆS_BH950;                                       
               WHEN (BH950.TIL_EVS.DAFSTAA > 0)                         
                  CALL LÆS_BH950;                                       
               WHEN (BH950.TIL_EVS.DFRAFLYT > 0)                        
                  CALL LÆS_BH950;                                       
               WHEN (BH950_ID < CN571_ID)                               
                  CALL LÆS_BH950;                                       
               OTHERWISE                                                
                  DO;                                                   
                     CALL BEHANDL;                                      
                     CALL LÆS_CN571;                                    
                  END;                                                  
            END;                                                        
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS EVS BEREGNINGSBÅND                                       * 
 *********************************************************************/ 
 LÆS_BH950: PROC;                                                       
                                                                        
         READ FILE (BH950I) INTO (BH950_AR);                            
                                                                        
         IF BH950.SORT_CPR = 99999999999                                
         THEN                                                           
            READ FILE (BH950I) INTO (BH950_AR);                         
         ELSE                                                           
            IF EOF_BH950 = NEJ                                          
            THEN                                                        
               DO;                                                      
                  BH950_ID1.DCPRN  = BH950.SORT_CPR;                    
                  BH950_ID1.EKOMNR = BH950.SORT_KOMNR;                  
                  BH950_ID1.EEJDNR = BH950.SORT_EJDNR;                  
                  TV.LÆS_BH950 = TV.LÆS_BH950 + 1;                      
               END;                                                     
                                                                        
 END LÆS_BH950;                                                         
 /********************************************************************* 
 *       LÆS UDTRÆK FRA ESR                                           * 
 *********************************************************************/ 
 LÆS_CN571: PROC;                                                       
                                                                        
         READ FILE (CN571I) INTO (CN571);                               
                                                                        
         IF EOF_CN571 = NEJ                                             
         THEN                                                           
            DO;                                                         
               CN571_ID1.DCPRCIR = CN571.DCPRCIR;                       
               CN571_ID1.EKOMNR  = CN571.EKOMNR;                        
               CN571_ID1.EEJDNR  = CN571.EEJDNR;                        
               TV.LÆS_CN571 = TV.LÆS_CN571 + 1;                         
            END;                                                        
                                                                        
 END LÆS_CN571;                                                         
 /********************************************************************* 
 *       PERSONER SOM SKAL BEHANDLES                                  * 
 *********************************************************************/ 
 BEHANDL: PROC;                                                         
                                                                        
         BH812.DCPRCIR = CN571.DCPRCIR;                                 
         BH812.EKOMNR  = CN571.EKOMNR;                                  
         BH812.EEJDNR  = CN571.EEJDNR;                                  
                                                                        
         IF BH950_ID = CN571_ID                                         
         THEN                                                           
            DO;                                                         
               TV.FUNDET = TV.FUNDET + 1;                               
               IF BH950.TIL_EVS.CEJBEVS = '0' &                         
                  BH950.TIL_EVS.DOVTG < BH65300M.FORSKÅR0101            
               THEN                                                     
                  DO;                                                   
                     /* PERSONEN ER BEREGNET IFLG. BEREGN.BÅND */       
                     TV.BEREGNET = TV.BEREGNET + 1;                     
                     IF BH950.FRA_EVS_BOY.BEJERAN > 0                   
                     THEN                                               
                        /* SÅ EJER HAN MINDRE END 100% */               
                        BH812.BEVSBOY = BH950.FRA_EVS_BOY.BEJERAN;      
                     ELSE                                               
                        BH812.BEVSBOY = BH950.FRA_EVS_BOY.BBRUTTO;      
                     TV.EVS = TV.EVS + BH812.BEVSBOY;                   
                     BH812.CBOYBER = '1';                               
                  END;                                                  
               ELSE                                                     
                  DO;                                                   
                     /* PERSONEN ER IKKE BEREGNET IFLG. BEREGN.BÅND */  
                     TV.EJBEREGN = TV.EJBEREGN + 1;                     
                     BH812.BEVSBOY = 0;                                 
                     BH812.CBOYBER = '2';                               
                  END;                                                  
            END;                                                        
         ELSE                                                           
            DO;                                                         
               /* PERSONEN IKKE FUNDET PÅ BEREGN.BÅND */                
               TV.EJFUNDET = TV.EJFUNDET + 1;                           
               BH812.BEVSBOY = 0;                                       
               BH812.CBOYBER = '3';                                     
            END;                                                        
                                                                        
         TV.SKREVET = TV.SKREVET + 1;                                   
         WRITE FILE (BH812O) FROM (BH812);                              
                                                                        
 END BEHANDL;                                                           
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE: PROC;                                                      
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.LÆS_CN571;                                  
         DETLIN1.TEKST = 'ANTAL LÆSTE PÅ UDTRÆK FRA ESR     C.N57131D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_BH950;                                  
         DETLIN1.TEKST = 'ANTAL LÆSTE PÅ EVS BEREGNINGSBÅND B.H95000D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.SKREVET;                                    
         DETLIN1.TEKST = 'ANTAL SKREVNE PERSONER TIL BOT    B.H81200D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.EJFUNDET;                                   
         DETLIN1.TEKST = 'HERAF IKKE FUNDET PÅ EVS-BEREGNINGSBÅND    '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.FUNDET;                                     
         DETLIN1.TEKST = 'HERAF FUNDET PÅ EVS-BEREGNINGSBÅND         '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN3.CCA = ZZWS1;                                           
         DETLIN3.ANTAL = TV.BEREGNET;                                   
         DETLIN3.TEKST = '      HERAF MED BEREGNET EVS         ANTAL:'; 
         DETLIN3.BELØB = TV.EVS;                                        
         CALL ZZ20300 (DETLIN3,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS1;                                           
         DETLIN1.ANTAL = TV.EJBEREGN;                                   
         DETLIN1.TEKST = '      HERAF UDEN EVS BEREGNING       ANTAL:'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
  END TOTALLISTE;                                                       
 /*********************************************************************/
 /*      CLOSE AF FILER OG SPOOL                                      */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL TOTALLISTE;                                               
                                                                        
         CLOSE FILE (BH950I),                                           
               FILE (CN571I),                                           
               FILE (BH812O);                                           
                                                                        
         CALL ZZ20300((133)' ','99');                                   
                                                                        
 END AFSLUT;                                                            
                                                                        
 END  BH81200;                                                          
