 BH88400: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS FORSKUD / EVS SLUT                                 *
 * PROGRAMNAVN: BH88400.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    Indlæs dataset med cprnumre og ejendomme der skal      *
 *              udtrækkes. Dannet i BH88300.                           *
 *              Skriv hver funden record videre til en samlet fil      *
 *              dog med en kendingsnøgle sat foran strukturen.         *
 *                                                                     *
 *              MANY - Mandtal forskud 2017                            *
 *              MAGL - Mandtal slut    2016                            *
 *              PENS - Pensionsudtræk                                  *
 *              ESR  - ESR cprorden                                    *
 *              ESE  - ESR ejdorden                                    *
 *                                                                     *
 * INDDATA:     Dataset med cpr og ejd til udtræk                      *
 *              Mandtal F17, Mandtal S16, Pension, ESR                 *
 *                                                                     *
 * UDDATA:      BH88401Y - KONTROLLISTE.                               *
 *              TOTLIST  - Samlet dataset med alle filer               *
 ***********************************************************************
 * OPRETTET   : Lene Maj Jensen   QLE             BALLERUP 04.04.2017  *
 **********************************************************************/
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KOMMUNEDATA A/S 2006');    
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
 DCL     BH884PRM FILE RECORD INPUT;     /* Parm data  */               
 DCL     CPRLIST  FILE RECORD INPUT;    /* Samtlige cpr der ønskes */   
 DCL     EJDLIST  FILE RECORD INPUT;    /* Samtlige ejd der ønskes */   
 DCL     TOTLIST  FILE RECORD OUTPUT;   /* Samtlige udtrukne */         
                                                                        
 DCL     MANYFIL  FILE RECORD INPUT;    /* Mandtal forskud 2017 srtcpr*/
 DCL     MAGLFIL  FILE RECORD INPUT;    /* Mandtal slut 2016 sort cpr */
 DCL     PENSFIL  FILE RECORD INPUT;    /* Pensionsudtræk sort cpr */   
 DCL     ESRFIL   FILE RECORD INPUT;    /* ESR  sort cpr        */      
 DCL     ESEFIL   FILE RECORD INPUT;    /* ESR  sort ekom ejdnr */      
                                                                        
 DCL     1 TOT_AR         CHAR      (2000) VAR;                         
                                                                        
      /*    MANDTAL forskud 2017    */                                  
                                                                        
 DCL     1 TOT_MANY   BASED     (ADDR(TOT_AR)),                         
           2 NOEGLE   CHAR (4),                                         
           2 TOT_DET_MANY,                                              
             3 LÆNGDE BIN FIXED (15),                                   
             %INCLUDE BR74250N;                                         
                                                                        
 DCL     MANY_AR          CHAR      (2000) VAR;                         
                                                                        
 DCL     1 MANY_DET   BASED     (ADDR(MANY_AR)),                        
           3 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BR74250N;                                           
                                                                        
 DCL     1 MANY_SUM   BASED     (ADDR(MANY_AR)),                        
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BR74259N;                                           
                                                                        
      /*    MANDTAL slut 2016    */                                     
                                                                        
 DCL     1 TOT_MAGL   BASED     (ADDR(TOT_AR)),                         
           2 NOEGLE   CHAR (4),                                         
           2 TOT_DET_MAGL,                                              
             3 LÆNGDE BIN FIXED (15),                                   
             %INCLUDE BH65501N;;                                        
                                                                        
 DCL     MAGL_AR          CHAR      (2000) VAR;                         
 DCL     1 MAGL_DET   BASED     (ADDR(MAGL_AR)),                        
           3 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH65501N;;                                          
 DCL     1 MAGL_SUM   BASED     (ADDR(MAGL_AR)),                        
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH65599N;                                           
                                                                        
      /*    PENSION    */                                               
                                                                        
 DCL     1 TOT_PENS   BASED     (ADDR(TOT_AR)),                         
           3 NOEGLE   CHAR(4),                                          
           3 TOT_DET_PENS,                                              
             4 CITYP           CHAR      (3),                           
             4 DCPRN           PIC       '(10)9';                       
             /* %INCLUDE BH65200N; */                                   
                                                                        
 DCL     1 PENS_DET,                                                    
             4 CITYP           CHAR      (3),                           
             4 DCPRN           PIC       '(10)9';                       
             /* %INCLUDE BH65200N; */                                   
                                                                        
      /*    ESR    */                                                   
                                                                        
 DCL     1 TOT_ESR   BASED     (ADDR(TOT_AR)),                          
           3 NOEGLE   CHAR(4),                                          
           3 TOT_DET_ESR,                                               
             4 LÆNGDE BIN FIXED (15),                                   
             %INCLUDE BH31800N;                                         
                                                                        
 DCL     ESR_AR          CHAR      (2000) VAR;                          
 DCL     1 ESR_DET   BASED     (ADDR(ESR_AR)),                          
           4 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH31800N;                                           
                                                                        
 DCL     1 TOT_ESE   BASED     (ADDR(TOT_AR)),                          
           3 NOEGLE   CHAR(4),                                          
           3 TOT_DET_ESE,                                               
             4 LÆNGDE BIN FIXED (15),                                   
             %INCLUDE BH31800N;                                         
                                                                        
 DCL     ESE_AR          CHAR      (2000) VAR;                          
 DCL     1 ESE_DET   BASED     (ADDR(ESE_AR)),                          
           4 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH31800N;                                           
                                                                        
 DCL     1 CPRLIST_DET,                                                 
         3 DCPRN          pic '99999999999999';                         
                                                                        
 DCL     1 EJDLIST_DET,                                                 
         3 EKOMNR         pic '999999999',                              
         3 EEJDNR         pic '99999999999999';                         
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2 strukturer                                         */
 /*********************************************************************/
                                                                        
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
 DCL     WS_PROGRAMNAVN         CHAR(8)  INIT ('BH88400');              
                                                                        
 DCL     WS_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                    
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
                                                                        
 DCL     1 BH884_PARM,                                                  
           %INCLUDE BH88400N;                                           
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF_TOTLIST       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_CPRLIST       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_EJDLIST       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_MANYFIL       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_MAGLFIL       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_PENSFIL       BIT       (01)      INIT      ('0'B);        
 DCL     EOF_ESRFIL        BIT       (01)      INIT      ('0'B);        
 DCL     EOF_ESEFIL        BIT       (01)      INIT      ('0'B);        
 DCL     EOF_BH884PRM      BIT       (01)      INIT      ('0'B);        
                                                                        
 DCL     JA                 BIT       (1)     INIT ('1'B);              
 DCL     NEJ                BIT       (1)     INIT ('0'B);              
                                                                        
 DCL  ws_genn_loeb          char (4) init (' ');                        
                                                                        
 DCL  WS_CHK_CPR            dec fixed (11) init (0);                    
 DCL  WS_CHK_EKOMNR         bin fixed (15) init (0);                    
 DCL  WS_CHK_EEJDNR         bin fixed (31) init (0);                    
                                                                        
 DCL  GEM_CHK_CPR            dec fixed (11) init (0);                   
 DCL  GEM_CHK_EKOMNR         bin fixed (15) init (0);                   
 DCL  GEM_CHK_EEJDNR         bin fixed (31) init (0);                   
                                                                        
 DCL     MAX_CPR_IX      pic '999999' init (32000);                     
 DCL     MAX_EJD_IX      pic '999999' init (32000);                     
                                                                        
 DCL     1 CPR_TAB(32000),                                              
           3 dcprn       DEC FIXED(11,0),                               
           3 cprbeh      char (1),                                      
           3 ejdbeh      char (1);                                      
                                                                        
 DCL     1 EJD_TAB(32000),                                              
           3 ekomnr      bin FIXED(15),                                 
           3 eejdnr      bin FIXED(31),                                 
           3 ejdbeh      char (1);                                      
                                                                        
 DCL  record_skal_udtraekkes BIT       (01)      INIT      ('0'B);      
 DCL  fortsaet_loop          BIT       (01)      INIT      ('0'B);      
                                                                        
 DCL  ix                    pic '999999' init (0);                      
 DCL  pa_ix                 pic '999999' init (0);                      
 DCL  ea_ix                 pic '999999' init (0);                      
 DCL  gem_cpr_ix            pic '999999' init (0);                      
 DCL  gem_ejd_ix            pic '999999' init (0);                      
                                                                        
 DCL  ANT_LÆS_CPR            dec fixed (11) init (0);                   
 DCL  ANT_LÆS_EJD            dec fixed (11) init (0);                   
 DCL  ANT_LÆS_MANY           dec fixed (11) init (0);                   
 DCL  ANT_LÆS_MAGL           dec fixed (11) init (0);                   
 DCL  ANT_LÆS_PENS           dec fixed (11) init (0);                   
 DCL  ANT_LÆS_ESR            dec fixed (11) init (0);                   
 DCL  ANT_LÆS_ESE            dec fixed (11) init (0);                   
                                                                        
 DCL  ANT_SKRIV_MANY         dec fixed (11) init (0);                   
 DCL  ANT_SKRIV_MAGL         dec fixed (11) init (0);                   
 DCL  ANT_SKRIV_PENS         dec fixed (11) init (0);                   
 DCL  ANT_SKRIV_ESR          dec fixed (11) init (0);                   
 DCL  ANT_SKRIV_ESE          dec fixed (11) init (0);                   
                                                                        
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF ABEND STRUKTUR m.v.                               */
 /*                                                                   */
 /*********************************************************************/
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH88400'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER TIL KONTROLLISTEN                     */
 /*********************************************************************/
                                                                        
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (1),                                 
          2 FILLER       CHAR      (132)     INIT      (' ');           
                                                                        
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (1),                                 
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH88400L'),                                        
           2 F1          CHAR      (23)      INIT      (' '),           
           2 TEKST2      CHAR      (43)      INIT      (                
           'TESTUDTRÆK '),                                              
           2 ÅR          PIC       '9999',                              
           2 F2          CHAR      (21)      INIT      ((21)' '),       
           2 TEKST4      CHAR      (14)      INIT      (                
           'UDSKREVET DEN '),                                           
           2 DATO        CHAR      (10);                                
                                                                        
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (1),                                 
           2 F1          CHAR      (53)      INIT      (' '),           
           2 TEKST1      CHAR      (79)      INIT                       
           ('KØRSELSKONTROLLISTE');                                     
                                                                        
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (1),                                 
           2 TEKST       CHAR      (65),                                
           2 ANTAL       PIC       'Z.ZZZ.ZZZ.ZZ9',                     
           2 F1          CHAR      (54)      INIT      (' ');           
                                                                        
 DCL     1 DETLIN3,                                                     
           2 CCA         CHAR      (1),                                 
           2 TXT1       CHAR      (30),                                 
           2 TXT2       CHAR      (102);                                
                                                                        
 DCL     1 PCTLIN1,                                                     
           2 CCA         CHAR      (1),                                 
           2 TEKST       CHAR      (66),                                
           2 ANTAL       PIC       'Z9V,999999999',                     
           2 F1          CHAR      (50)      INIT      (' ');           
                                                                        
         % INCLUDE ZZ20301M;                                            
                                                                        
 /*********************************************************************/
 /*      DECLARE AF ENTRIES                                           */
 /*********************************************************************/
                                                                        
 DCL     ZS61900         ENTRY;              /* UDSKRIV SSI-DATO      */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     ADDR            BUILTIN;                                       
 DCL     NULL            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
                                                                        
 /*********************************************************************/
 /* Declare af CURSORS                                                */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         OPEN FILE (TOTLIST) TITLE ('BH884TOT');                        
         OPEN FILE (CPRLIST) TITLE ('BH884CPR');                        
         OPEN FILE (EJDLIST) TITLE ('BH884EJD');                        
         OPEN FILE (MANYFIL) TITLE ('BH884MAY');                        
         OPEN FILE (MAGLFIL) TITLE ('BH884MAG');                        
         OPEN FILE (PENSFIL) TITLE ('BH884PEN');                        
         OPEN FILE (ESRFIL)  TITLE ('BH884ESR');                        
         OPEN FILE (ESEFIL)  TITLE ('BH884ESE');                        
         OPEN FILE (BH884PRM) TITLE ('BH884NYP');                       
                                                                        
         EOF_TOTLIST = NEJ;                                             
         EOF_CPRLIST = NEJ;                                             
         EOF_EJDLIST = NEJ;                                             
         EOF_MANYFIL = NEJ;                                             
         EOF_MAGLFIL = NEJ;                                             
         EOF_PENSFIL = NEJ;                                             
         EOF_ESRFIL  = NEJ;                                             
         EOF_ESEFIL  = NEJ;                                             
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH88400L');             
            END;                                                        
                                                                        
         ON ENDFILE (TOTLIST)                                           
         BEGIN;                                                         
            EOF_TOTLIST = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (CPRLIST)                                           
         BEGIN;                                                         
            EOF_CPRLIST = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (EJDLIST)                                           
         BEGIN;                                                         
            EOF_EJDLIST = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (MANYFIL)                                           
         BEGIN;                                                         
            EOF_MANYFIL = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (MAGLFIL)                                           
         BEGIN;                                                         
            EOF_MAGLFIL = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (PENSFIL)                                           
         BEGIN;                                                         
            EOF_PENSFIL = JA;                                           
         END;                                                           
                                                                        
         ON ENDFILE (ESRFIL)                                            
         BEGIN;                                                         
            EOF_ESRFIL = JA;                                            
         END;                                                           
                                                                        
         ON ENDFILE (ESEFIL)                                            
         BEGIN;                                                         
            EOF_ESEFIL = JA;                                            
         END;                                                           
                                                                        
         ON ENDFILE (BH884PRM)                                          
         BEGIN;                                                         
            EOF_BH884PRM = JA;                                          
         END;                                                           
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
         CALL ZZ20390('*OPEN','BH88401Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
         OVERLIN1.ÅR   = GLSLUTÅR - 1;                                  
         OVERLIN1.DATO = UDDATO;                                        
         SIDELIN.CCA   = ZZIK1;                                         
         OVERLIN1.CCA  = ZZWS2;                                         
         OVERLIN2.CCA  = ZZWS3;                                         
                                                                        
         READ FILE (BH884PRM) INTO (BH884_PARM);                        
                                                                        
         IF EOF_BH884PRM = NEJ                                          
         THEN DO;                                                       
            SELECT (BH884_PARM.FS_MRK);                                 
               WHEN ('F')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH884_PARM.FORSKUD_TXT;      
                     WS_TIL_EVS_AAR = BH884_PARM.AAR;                   
                     OVERLIN1.TEKST2 = 'TESTUDTRÆK FORSKUD';            
                  END;                                                  
               WHEN ('S')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH884_PARM.SLUT_TXT;         
                     WS_TIL_EVS_AAR = BH884_PARM.AAR;                   
                     OVERLIN1.TEKST2 = 'TESTUDTRÆK SLUT';               
                  END;                                                  
               WHEN ('U')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH884_PARM.SUPPL_TXT;        
                     WS_TIL_EVS_AAR = BH884_PARM.AAR;                   
                     OVERLIN1.TEKST2 = 'TESTUDTRÆK SUPPLEMENT';         
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
         END;                                                           
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         /* OPBYG INTERN TABEL MED ØNSKEDE UDTRÆKSKRITERIER */          
                                                                        
         pa_ix = 0;                                                     
         ea_ix = 0;                                                     
         cpr_tab(*) = '';                                               
         ejd_tab(*) = '';                                               
                                                                        
         READ FILE (CPRLIST) INTO (CPRLIST_DET);                        
                                                                        
         do while (^EOF_CPRLIST);                                       
            pa_ix = pa_ix + 1;                                          
            cpr_tab.dcprn(pa_ix) = cprlist_det.dcprn;                   
            READ FILE (CPRLIST) INTO (CPRLIST_DET);                     
         end;                                                           
         ANT_LÆS_CPR = pa_ix;                                           
                                                                        
         READ FILE (EJDLIST) INTO (EJDLIST_DET);                        
                                                                        
         do while (^EOF_EJDLIST);                                       
            ea_ix = ea_ix + 1;                                          
            ejd_tab.ekomnr(ea_ix) = ejdlist_det.ekomnr;                 
            ejd_tab.eejdnr(ea_ix) = ejdlist_det.eejdnr;                 
            READ FILE (EJDLIST) INTO (EJDLIST_DET);                     
         end;                                                           
         ANT_LÆS_EJD = ea_ix;                                           
                                                                        
         /* G E N N E M L Ø B  MANDTAL FORSKUD 2017 */                  
                                                                        
         WS_GENN_LOEB = 'MANY';                                         
                                                                        
         GEM_CHK_CPR = 0;                                               
         GEM_CHK_EKOMNR = 0;                                            
         GEM_CHK_EEJDNR = 0;                                            
         ix = 0;                                                        
         gem_cpr_ix = 0;                                                
         gem_ejd_ix = 0;                                                
                                                                        
         READ FILE (MANYFIL) INTO (MANY_AR);                            
                                                                        
         do while (^EOF_MANYFIL);                                       
            ANT_LÆS_MANY = ANT_LÆS_MANY + 1;                            
            WS_CHK_CPR = MANY_DET.DCPRN;                                
            WS_CHK_EKOMNR = 0;                                          
            WS_CHK_EEJDNR = 0;                                          
            Call Check_om_record_skal_bruges;                           
            if RECORD_SKAL_UDTRAEKKES                                   
            then do;                                                    
               TOT_MANY.NOEGLE = 'MANY';                                
               TOT_DET_MANY = MANY_DET, by name;                        
               write file (TOTLIST) from (TOT_MANY);                    
               ANT_SKRIV_MANY = ANT_SKRIV_MANY + 1;                     
            end;                                                        
            READ FILE (MANYFIL) INTO (MANY_AR);                         
         end;                                                           
                                                                        
         /* G E N N E M L Ø B  MANDTAL SLUT 2016 */                     
                                                                        
         WS_GENN_LOEB = 'MAGL';                                         
                                                                        
         GEM_CHK_CPR = 0;                                               
         GEM_CHK_EKOMNR = 0;                                            
         GEM_CHK_EEJDNR = 0;                                            
         ix = 0;                                                        
         gem_cpr_ix = 0;                                                
         gem_ejd_ix = 0;                                                
                                                                        
         READ FILE (MAGLFIL) INTO (MAGL_AR);                            
                                                                        
         do while (^EOF_MAGLFIL);                                       
            ANT_LÆS_MAGL = ANT_LÆS_MAGL + 1;                            
            WS_CHK_CPR = MAGL_DET.DCPRN;                                
            WS_CHK_EKOMNR = 0;                                          
            WS_CHK_EEJDNR = 0;                                          
            Call Check_om_record_skal_bruges;                           
            if RECORD_SKAL_UDTRAEKKES                                   
            then do;                                                    
               TOT_MAGL.NOEGLE = 'MAGL';                                
               TOT_DET_MAGL = MAGL_DET, by name;                        
               write file (TOTLIST) from (TOT_MAGL);                    
               ANT_SKRIV_MAGL = ANT_SKRIV_MAGL + 1;                     
            end;                                                        
            READ FILE (MAGLFIL) INTO (MAGL_AR);                         
         end;                                                           
                                                                        
         /* G E N N E M L Ø B  PENSION */                               
                                                                        
         WS_GENN_LOEB = 'PENS';                                         
                                                                        
         GEM_CHK_CPR = 0;                                               
         GEM_CHK_EKOMNR = 0;                                            
         GEM_CHK_EEJDNR = 0;                                            
         ix = 0;                                                        
         gem_cpr_ix = 0;                                                
         gem_ejd_ix = 0;                                                
                                                                        
         READ FILE (PENSFIL) INTO (PENS_DET);                           
                                                                        
         do while (^EOF_PENSFIL);                                       
            ANT_LÆS_PENS = ANT_LÆS_PENS + 1;                            
            WS_CHK_CPR = PENS_DET.DCPRN;                                
            WS_CHK_EKOMNR = 0;                                          
            WS_CHK_EEJDNR = 0;                                          
            Call Check_om_record_skal_bruges;                           
            if RECORD_SKAL_UDTRAEKKES                                   
            then do;                                                    
               TOT_PENS.NOEGLE = 'PENS';                                
               TOT_DET_PENS = PENS_DET, by name;                        
               write file (TOTLIST) from (TOT_PENS);                    
               ANT_SKRIV_PENS = ANT_SKRIV_PENS + 1;                     
            end;                                                        
            READ FILE (PENSFIL) INTO (PENS_DET);                        
         end;                                                           
                                                                        
         /* G E N N E M L Ø B  ESR  CPR */                              
                                                                        
         WS_GENN_LOEB = 'ESR';                                          
                                                                        
         GEM_CHK_CPR = 0;                                               
         GEM_CHK_EKOMNR = 0;                                            
         GEM_CHK_EEJDNR = 0;                                            
         ix = 0;                                                        
         gem_cpr_ix = 0;                                                
         gem_ejd_ix = 0;                                                
                                                                        
         READ FILE (ESRFIL) INTO (ESR_AR);                              
                                                                        
         do while (^EOF_ESRFIL);                                        
            ANT_LÆS_ESR = ANT_LÆS_ESR + 1;                              
            IF ESR_DET.DCPRCIR < 9999999999                             
            THEN DO;                                                    
               WS_CHK_CPR = ESR_DET.DCPRCIR;                            
               WS_CHK_EKOMNR = 0;                                       
               WS_CHK_EEJDNR = 0;                                       
               Call Check_om_record_skal_bruges;                        
               if RECORD_SKAL_UDTRAEKKES                                
               then do;                                                 
                  TOT_ESR.NOEGLE = 'ESR ';                              
                  TOT_DET_ESR = ESR_DET, by name;                       
                  write file (TOTLIST) from (TOT_ESR);                  
                  ANT_SKRIV_ESR = ANT_SKRIV_ESR + 1;                    
               END;                                                     
            end;                                                        
            READ FILE (ESRFIL) INTO (ESR_AR);                           
         end;                                                           
                                                                        
         /* G E N N E M L Ø B  ESR  EKOMNR EEJDNR */                    
                                                                        
         WS_GENN_LOEB = 'ESE';                                          
                                                                        
         GEM_CHK_CPR = 0;                                               
         GEM_CHK_EKOMNR = 0;                                            
         GEM_CHK_EEJDNR = 0;                                            
         ix = 0;                                                        
         gem_cpr_ix = 0;                                                
         gem_ejd_ix = 0;                                                
                                                                        
         READ FILE (ESEFIL) INTO (ESE_AR);                              
                                                                        
         do while (^EOF_ESEFIL);                                        
            ANT_LÆS_ESE = ANT_LÆS_ESE + 1;                              
            IF ESE_DET.DCPRCIR < 9999999999                             
            THEN DO;                                                    
               WS_CHK_CPR = 0;                                          
               WS_CHK_EKOMNR = ESE_DET.EKOMNR;                          
               WS_CHK_EEJDNR = ESE_DET.EEJDNR;                          
               Call Check_om_record_skal_bruges;                        
               if RECORD_SKAL_UDTRAEKKES                                
               then do;                                                 
                  TOT_ESE.NOEGLE = 'ESR ';                              
                  TOT_DET_ESE = ESE_DET, by name;                       
                  write file (TOTLIST) from (TOT_ESE);                  
                  ANT_SKRIV_ESE = ANT_SKRIV_ESE + 1;                    
               END;                                                     
            end;                                                        
            READ FILE (ESEFIL) INTO (ESE_AR);                           
         end;                                                           
                                                                        
         CALL AFSLUT;                                                   
 /*********************************************************************/
 /* Indeholder læst record cpr der skal udtrækkes                     */
 /*********************************************************************/
 CHECK_OM_RECORD_SKAL_BRUGES: PROC;                                     
                                                                        
        record_skal_udtraekkes = NEJ;                                   
        fortsaet_loop = JA;                                             
                                                                        
        if WS_CHK_CPR > 0  /* START CPR CHECK */                        
        then do;                                                        
           /* IF WS_GENN_LOEB = 'MANY'                                  
           then do;                                                     
              put skip list ('MANY cprnr indlæst: ' !!                  
                             WS_CHK_CPR !! ' GEM cprnr: ' !!            
                             GEM_CHK_CPR);                              
           end; */                                                      
                                                                        
           /* der skal startes fra og med gem_cpr_ix */                 
           /* medmindre det er 1.gennemløb           */                 
           if gem_cpr_ix > 0                                            
           then                                                         
              ix = gem_cpr_ix - 1;                                      
           else                                                         
              ix = 0;                                                   
                                                                        
           /* gennemløb cprlisten */                                    
           if GEM_CHK_CPR ^= WS_CHK_CPR                                 
           then do;                                                     
              do while (ix < MAX_CPR_IX &                               
                        WS_CHK_CPR > 0 &                                
                        FORTSAET_LOOP);                                 
                 ix = ix + 1;                                           
                 gem_cpr_ix = ix;                                       
                 if cpr_tab.dcprn(ix) > 0                               
                 then do;                                               
                    if cpr_tab.DCPRN(ix) = WS_CHK_CPR                   
                    then do;                                            
                       /* if ws_genn_loeb = 'MANY'                      
                       then do;                                         
                          put skip list ('cprnr fundet i tabel ' !!     
                                          WS_CHK_CPR);                  
                       end; */                                          
                       FORTSAET_LOOP = NEJ;                             
                       record_skal_udtraekkes = JA;                     
                    end;                                                
                    else do;                                            
                       if cpr_tab.dcprn(ix) > WS_CHK_CPR                
                       then do;                                         
                          /* if ws_genn_loeb = 'MANY'                   
                          then do;                                      
                             put skip list ('vi er for langt i tabel '  
                                            !!                          
                                            'element ' !! ix !! ' ' !!  
                                            cpr_tab.dcprn(ix));         
                          end; */                                       
                          FORTSAET_LOOP = NEJ;                          
                       end;                                             
                       else do;                                         
                          /* if ws_genn_loeb = 'MANY'                   
                          then do;                                      
                             put skip list ('vi fortsætter forbi ' !!   
                                            'element ' !! ix !! ' ' !!  
                                            cpr_tab.dcprn(ix));         
                          end; */                                       
                       end;                                             
                    end;                                                
                 end;                                                   
              end;                                                      
           end;                                                         
        end; /* slut cpr check */                                       
                                                                        
        if WS_CHK_EKOMNR > 0 ! /* START EJENDOM CHECK */                
           WS_CHK_EEJDNR > 0                                            
        then do;                                                        
           /* IF WS_GENN_LOEB = 'ESE'                                   
           then do;                                                     
              put skip list ('ESE ejendom indlæst: ' !!                 
                             WS_CHK_EKOMNR !! ' ' !! WS_CHK_EEJDNR !!   
                             ' GEM ejendom: ' !!                        
                             GEM_CHK_EKOMNR !! ' ' !! GEM_CHK_EEJDNR);  
           end; */                                                      
           /* der skal startes fra og med gem_ejd_ix */                 
           /* medmindre det er 1.gennemløb           */                 
           if gem_ejd_ix > 0                                            
           then                                                         
              ix = gem_ejd_ix - 1;                                      
           else                                                         
              ix = 0;                                                   
                                                                        
                                                                        
           if GEM_CHK_EKOMNR ^= WS_CHK_EKOMNR !                         
              GEM_CHK_EEJDNR ^= WS_CHK_EEJDNR                           
           then do;                                                     
              do while (ix < MAX_EJD_IX &                               
                        WS_CHK_EKOMNR > 0 &                             
                        WS_CHK_EEJDNR > 0 &                             
                        FORTSAET_LOOP);                                 
                 ix = ix + 1;                                           
                 gem_ejd_ix = ix;                                       
                 if ejd_tab.ekomnr(ix) > 0 !                            
                    ejd_tab.eejdnr(ix) > 0                              
                 then do;                                               
                    if (ejd_tab.EKOMNR(ix) = WS_CHK_EKOMNR &            
                        ejd_tab.EEJDNR(ix) = WS_CHK_EEJDNR)             
                    then do;                                            
                       FORTSAET_LOOP = NEJ;                             
                       record_skal_udtraekkes = JA;                     
                       /* if ws_genn_loeb = 'ESE'                       
                       then do;                                         
                          put skip list ('ejendom fundet '              
                                         !!                             
                                         ejd_tab.ekomnr(ix) !!          
                                         ' ' !! ejd_tab.eejdnr(ix));    
                       end; */                                          
                    end;                                                
                    else do;                                            
                       if ejd_tab.EKOMNR(ix) > WS_CHK_EKOMNR !          
                          (ejd_tab.EKOMNR(IX) = WS_CHK_EKOMNR &         
                           ejd_tab.EEJDNR(ix) > WS_CHK_EEJDNR)          
                       then do;                                         
                          FORTSAET_LOOP = NEJ;                          
                          /* if ws_genn_loeb = 'ESE'                    
                          then do;                                      
                             put skip list ('vi er for langt i tabel '  
                                            !!                          
                                            'element ' !! ix !! ' ' !!  
                                            ejd_tab.ekomnr(ix) !!       
                                            ' ' !! ejd_tab.eejdnr(ix)); 
                          end; */                                       
                       end;                                             
                       else do;                                         
                          /* if ws_genn_loeb = 'ESE'                    
                          then do;                                      
                             put skip list ('vi fortsætter forbi '  !!  
                                            'element ' !! ix !! ' ' !!  
                                            ejd_tab.ekomnr(ix) !!       
                                            ' ' !! ejd_tab.eejdnr(ix)); 
                          end; */                                       
                       end;                                             
                    end;                                                
                 end;                                                   
              end;                                                      
           end;                                                         
                                                                        
        end; /* SLUT EJENDOM CHECK */                                   
                                                                        
        GEM_CHK_CPR    = WS_CHK_CPR;                                    
        GEM_CHK_EKOMNR = WS_CHK_EKOMNR;                                 
        GEM_CHK_EEJDNR = WS_CHK_EEJDNR;                                 
                                                                        
 END CHECK_OM_RECORD_SKAL_BRUGES;                                       
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
                                                                        
 /*********************************************************************/
 /*      UDSKRIV KØRSELSKONTROLLISTE                                  */
 /*********************************************************************/
 KONTROLLISTE:                                                          
 PROC;                                                                  
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
                                                                        
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA   = ZZWS1;                                         
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ CPRLISTE ';                                          
         DETLIN1.ANTAL = ANT_LÆS_CPR;                                   
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ EJENDOMSLISTE ';                                     
         DETLIN1.ANTAL = ANT_LÆS_EJD;                                   
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ MANDTAL Forskud 2017 ';                              
         DETLIN1.ANTAL = ANT_LÆS_MANY;                                  
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ MANDTAL Slut 2016 ';                                 
         DETLIN1.ANTAL = ANT_LÆS_MAGL;                                  
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ Pension ';                                           
         DETLIN1.ANTAL = ANT_LÆS_PENS;                                  
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ ESR ';                                               
         DETLIN1.ANTAL = ANT_LÆS_ESR;                                   
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'LÆSTE PÅ ESE ';                                               
         DETLIN1.ANTAL = ANT_LÆS_ESE;                                   
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'UDTRUKKET PÅ MANDTAL Forskud 2017 ';                          
         DETLIN1.ANTAL = ANT_SKRIV_MANY;                                
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'UDTRUKKET PÅ MANDTAL Slut 2016 ';                             
         DETLIN1.ANTAL = ANT_SKRIV_MAGL;                                
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'UDTRUKKET PÅ Pension ';                                       
         DETLIN1.ANTAL = ANT_SKRIV_PENS;                                
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'UDTRUKKET PÅ ESR ';                                           
         DETLIN1.ANTAL = ANT_SKRIV_ESR;                                 
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
         DETLIN1.TEKST =                                                
         'UDTRUKKET PÅ ESE ';                                           
         DETLIN1.ANTAL = ANT_SKRIV_ESE;                                 
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
 END KONTROLLISTE;                                                      
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL KONTROLLISTE;                                             
         CLOSE FILE (CPRLIST);                                          
         CLOSE FILE (EJDLIST);                                          
         CLOSE FILE (TOTLIST);                                          
         CLOSE FILE (BH884PRM);                                         
         CLOSE FILE (MANYFIL);                                          
         CLOSE FILE (MAGLFIL);                                          
         CLOSE FILE (PENSFIL);                                          
         CLOSE FILE (ESRFIL);                                           
         CLOSE FILE (ESEFIL);                                           
                                                                        
         CALL ZZ20300(' ','99');                                        
                                                                        
         PUT SKIP LIST ('Programmet afsluttet');                        
                                                                        
 END AFSLUT;                                                            
 END BH88400;                                                           
