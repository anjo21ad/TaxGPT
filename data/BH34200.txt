 BH34200: /* FJERN PERSONER FRA BEREGNINGSBÅND            */            
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /*********************************************************************/
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA I/S 2000');       
 /**********************************************************************
 *                                                                     *
 * FORMÅL :  AT FJERNE PERSONER DER ER PÅ TABELEN I FORVEJEN           *
 *                                                                     *
 * INDDATA:     BQ01200T - EVS TESTPERSONTABEL.                        *
 *              B.H96000D - BEREGNINGSBÅND ENDELIGT.                   *
 *                                                                     *
 * OUTPUT : B.H96000D  BEREGNINGSBÅND - DE PERSONER DER ER PÅ TABELEN  *
 *                     I FORVEJEN.                                     *
 *          B.H34202D  DE PERSONER DER LIGGER I TABELEN IFORVEJEN      *
 *          BH34289Y   KØRSELSKONTROLLISTE                             *
 *                                                                     *
 * PROGRAMMØR: HANS ERIK KJELDSEN  NOVEMBER 2001                       *
 * RETTET:                                                             *
 *                                                                     *
 **********************************************************************/
         DFT RANGE (*) STATIC;                                          
     /*  DEFAULT RANGE (*) STATIC UNALIGNED CONN;  */                   
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE BQ01200T;           /* EVS PERSONTABELLEN   */
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
 DCL     1 PERSON,                                                      
         %INCLUDE BQ01200N;;                                            
                                                                        
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH3420I FILE RECORD INPUT;    /* LOAD-GRUNDLAG PERSONTABEL */  
 DCL     BH3420O FILE RECORD OUTPUT;    /* EVS DATA TIL SLUT PÅ CSC  */ 
 DCL     BH3421O FILE RECORD OUTPUT;    /* EVS DATA TIL SLUT PÅ CSC  */ 
 /********************************************************************* 
 *       DECLARE AF BEREGNINGSBÅND                                    * 
 *********************************************************************/ 
 DCL     BH960        CHAR      (4000) VAR;                             
 DCL     1 BH960I        BASED     (ADDR(BH960)),                       
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90000N;;                                          
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 /********************************************************************* 
 *       DECLARE AF BUILTIN'S                                         * 
 *********************************************************************/ 
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     NULL            BUILTIN;                                       
 /********************************************************************* 
 *       DECLARE AF ENTRY'S                                           * 
 *********************************************************************/ 
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    LIN_DEB          CHAR      (133);                               
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH34200L'),                                        
           2 F1          CHAR      (25)      INIT      (' '),           
           2 TEKST2      CHAR      (57)      INIT      (                
           'FJERN PERSONER FRA BEREGNINGS BÅND           '),            
           2 F2          CHAR      (12)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZZ',                       
           2 F2          CHAR      (61)      INIT      (' ');           
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     INDEX           BIN FIXED (31);                                
 DCL     EOF_IND        BIT (1) INIT ('0'B);                            
 DCL     HJ_CHAR4        CHAR      (4);                                 
 DCL     HJ_PIC4         PIC       '(4)9'  BASED(ADDR(HJ_CHAR4));       
 DCL     HJ_FEJLNR       PIC       '(4)9';                              
 DCL     HJ_FEJLNRC      CHAR      (4)     BASED(ADDR(HJ_FEJLNR));      
 DCL     HJ_CHAR1        CHAR      (1);                                 
 DCL     HJ_PIC1         PIC       '9'     BASED(ADDR(HJ_CHAR1));       
 DCL     GLPNR           FIXED     (11)      INIT      (0);             
 DCL     FANTINDV    BIN FIXED     (31)      INIT      (0);             
 DCL     FEJLTABBIT (70)    BIT       (1);                              
 DCL     FEJLTEKST      CHAR (20)        INIT(' ');                     
 DCL     ABENDMEDD      CHAR (56)        INIT(' ');                     
 DCL     UDDATO          CHAR      (10);                                
 DCL     SQLKODE         PIC '9999';                                    
 DCL     DATO1           CHAR      (26);                                
 DCL     RETURKODE       BIN FIXED (31) INIT(0);                        
 DCL     HJ_RETURKODE    BIN FIXED (31) INIT(0);                        
 DCL     HJ_DCPRN        DEC FIXED (11,0) INIT(0);                      
 DCL     HJ_EKOMNR       BIN FIXED (15)   INIT(0);                      
 DCL     HJ_EEJDNR       BIN FIXED (31)   INIT(0);                      
 DCL     ANTAL_LÆS       BIN FIXED (31) INIT(0);                        
 DCL     ANTAL_AFVISTE   BIN FIXED (31) INIT(0);                        
 DCL     ANTAL_SKRIV     BIN FIXED (31) INIT(0);                        
 DCL     PIC_FEJLNR      PIC '9999';                                    
 DCL     BEREGNES         CHAR (1) INIT(' ');                           
 DCL     MAX_TIMESTAMP   CHAR(26) INIT('9999-12-31-23.59.59.999999');   
 DCL     AKT_TIMESTAMP   CHAR(26);                                      
 DCL     AKT_DATO        CHAR(10) BASED(ADDR(AKT_TIMESTAMP));           
 DCL     SUPPL_KØR_DATO  CHAR(10) INIT('2001-02-22');                   
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       DECLARE AF HJÆLPEFELTER TIL MASKINEL AFSTEMNING              * 
 *********************************************************************/ 
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
         ON ERROR                                                       
            CALL PLIDUMP ('SNHOB');                                     
                                                                        
         ON ENDFILE (BH3420I) EOF_IND = '1'B;                           
                                                                        
         OPEN FILE (BH3420I) TITLE ('BH34200I');                        
         OPEN FILE (BH3420O) TITLE ('BH34200O');                        
         OPEN FILE (BH3421O) TITLE ('BH34201O');                        
                                                                        
         CALL ZZ20390 ('*OPEN','BH34289Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
                                                                        
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS2;                                        
         OVERLIN2.CCA   = ZZWS3;                                        
         DETLIN1 = '';                                                  
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         READ FILE(BH3420I) INTO (BH960);                               
         DO WHILE (^EOF_IND);                                           
            IF ^TEST_PERSON_TABEL                                       
            THEN                                                        
               DO;                                                      
                  WRITE FILE (BH3420O) FROM (BH960);                    
                  ANTAL_SKRIV = ANTAL_SKRIV +1;                         
               END;                                                     
            ELSE                                                        
              DO;                                                       
                 WRITE FILE (BH3421O) FROM (BH960);                     
                 ANTAL_AFVISTE = ANTAL_AFVISTE +1;                      
              END;                                                      
            READ FILE(BH3420I) INTO (BH960);                            
            ANTAL_LÆS = ANTAL_LÆS +1;                                   
         END;                                                           
         CALL LUK_PROG;                                                 
 /*********************************************************************/
 /* TEST OM PERSON FINDES PÅ EJENDOMSTABELLEN BQ01200T         RUTINE */
 /*********************************************************************/
 TEST_PERSON_TABEL: PROC RETURNS(BIT(1));                               
 DCL  ANT         BIN FIXED (15) INIT(0);                               
                                                                        
         HJ_DCPRN  = BH960I.SORT_CPR;                                   
         HJ_EKOMNR = BH960I.SORT_KOMNR;                                 
         HJ_EEJDNR = BH960I.SORT_EJDNR;                                 
                                                                        
         EXEC SQL                                                       
            SELECT COUNT(*)                                             
              INTO :ANT                                                 
              FROM BQ01200T T2                                          
              WHERE T2.DCPRN    = :HJ_DCPRN                             
               AND  T2.DINDKAAR = 2001                                  
               AND  T2.EKOMNR   = :HJ_EKOMNR                            
               AND  T2.EEJDNR   = :HJ_EEJDNR                            
               AND  T2.ELBNR    = 1                                     
               AND  T2.EGENNR   = 1                                     
          ;                                                             
                                                                        
         SELECT (SQLCODE);                                              
          WHEN (0)                                                      
            DO;                                                         
              IF ANT > 0                                                
              THEN                                                      
                RETURN('1'B);                                           
              ELSE                                                      
                RETURN('0'B);                                           
            END;                                                        
          WHEN (100)                                                    
            DO;                                                         
              RETURN('0'B);                                             
            END;                                                        
          OTHER                                                         
            DO;                                                         
                SQLKODE    = SQLCODE;                                   
                FEJLTEKST = 'SELECT PERSON - SQLCODE=';                 
                CALL SQL_FEJL;                                          
            END;                                                        
         END;                                                           
                                                                        
 END TEST_PERSON_TABEL;                                                 
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
         PROC;                                                          
         CALL ZZ20300(SIDELIN,'89');                                    
         CALL ZZ20300(OVERLIN1,'89');                                   
         CALL ZZ20300(OVERLIN2,'89');                                   
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = ANTAL_LÆS;                                     
         DETLIN1.TEKST = 'ANTAL LÆSTE INDIVIDER PÅ B.H96000D IND....:'; 
         CALL ZZ20300 (DETLIN1,'89');                                   
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = ANTAL_AFVISTE;                                 
         DETLIN1.TEKST = 'ANTAL AFVISTE PERSONER FRA B.H96000D IND..:'; 
         CALL ZZ20300 (DETLIN1,'89');                                   
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = ANTAL_SKRIV;                                   
         DETLIN1.TEKST = 'ANTAL SKREVNE INDIVIDER PÅ B.H96000D UD...:'; 
         CALL ZZ20300 (DETLIN1,'89');                                   
                                                                        
  END TOTALLISTE;                                                       
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
         SQLKODE = SQLCA.SQLCODE;                                       
         CLOSE FILE (BH3420I);                                          
         CLOSE FILE (BH3420O);                                          
         CLOSE FILE (BH3421O);                                          
         CALL ZS67000(SQLCA);                                           
                                                                        
         ABENDMEDD = 'BH34200 ** 250 ' !! FEJLTEKST !! SQLKODE;         
                                                                        
         CALL ZS30101 (5, ABENDMEDD, 2);                                
                                                                        
 END SQL_FEJL;                                                          
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 LUK_PROG: PROC;                                                        
         CALL TOTALLISTE;                                               
         CALL ZZ20300((133)' ','99');                                   
         CLOSE FILE (BH3420I),                                          
               FILE (BH3420O),                                          
               FILE (BH3421O);                                          
 END LUK_PROG;                                                          
 END  BH34200;                                                          
