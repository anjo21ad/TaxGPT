 /*********************************************************************/
 /* BE83000M                                                          */
 /*                                                                   */
 /* Denne makro indeholder procedurer brugt i forbindelse med         */
 /* ændringsanmodning 73 (ÆA73), som omhandler omsætning af gamle     */
 /* til nye ejendomsnumre.                                            */
 /*                                                                   */
 /* Makroen forudsætter SQL include af BE83000T og BE83100T samt      */
 /* at SQL_ERROR proceduren fra eksempelvis include BE99900M          */
 /* implementeres.                                                    */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /* Tjek om der findes en defineret mapning for et udenlandsk         */
 /* ejendomsnummer til et nyt ejendomsnummer.                         */
 /*********************************************************************/
 FINDES_UDENL_EJD_MAPNING: PROC (P_TIL_EVS_AAR                          
                                ,P_AFVIKLINGS_ID                        
                                ,P_DATA_ID                              
                                ,P_EKOMNR                               
                                ,P_EEJDNR_FRA                           
                                ,P_EEJDNR_TIL                           
                                ,P_SLET_MARK) RETURNS(BIT(1));          
                                                                        
 DCL P_TIL_EVS_AAR                  FIXED BIN (15);                     
 DCL P_AFVIKLINGS_ID                CHAR (16);                          
 DCL P_DATA_ID                      FIXED BIN (15);                     
 DCL P_EKOMNR                       BIN FIXED (15);                     
 DCL P_EEJDNR_FRA                   BIN FIXED (31);                     
                                                                        
 DCL P_EEJDNR_TIL                   BIN FIXED (31);                     
 DCL P_SLET_MARK                    CHAR (01);                          
                                                                        
    DCLBE83000T.TIL_EVS_AAR   = P_TIL_EVS_AAR;                          
    DCLBE83000T.AFVIKLINGS_ID = P_AFVIKLINGS_ID;                        
    DCLBE83000T.DATA_ID       = P_DATA_ID;                              
    DCLBE83000T.EKOMNR        = P_EKOMNR;                               
    DCLBE83000T.EEJDNR_FRA    = P_EEJDNR_FRA;                           
                                                                        
    EXEC SQL SELECT   EEJDNR_TIL                                        
                     ,SLET_MARK                                         
             INTO     :DCLBE83000T.EEJDNR_TIL                           
                     ,:DCLBE83000T.SLET_MARK                            
             FROM     BE83000T                                          
             WHERE    TIL_EVS_AAR   =                                   
                      :DCLBE83000T.TIL_EVS_AAR                          
               AND    AFVIKLINGS_ID =                                   
                      :DCLBE83000T.AFVIKLINGS_ID                        
               AND    DATA_ID       =                                   
                      :DCLBE83000T.DATA_ID                              
               AND    EKOMNR        =                                   
                      :DCLBE83000T.EKOMNR                               
               AND    EEJDNR_FRA    =                                   
                      :DCLBE83000T.EEJDNR_FRA                           
             ;                                                          
                                                                        
    SELECT (SQLCA.SQLCODE);                                             
       WHEN (+000)                                                      
       DO;                                                              
          P_EEJDNR_TIL = DCLBE83000T.EEJDNR_TIL;                        
          P_SLET_MARK  = DCLBE83000T.SLET_MARK;                         
                                                                        
          RETURN ('1'B);                                                
       END;                                                             
       WHEN (+100)                                                      
       DO;                                                              
       END;                                                             
       OTHERWISE                                                        
       DO;                                                              
          CALL SQL_ERROR (PROCNAME(), 830 ,'SELECT BE83000T');          
       END;                                                             
    END;                                                                
                                                                        
    P_EEJDNR_TIL = '';                                                  
    P_SLET_MARK  = '';                                                  
                                                                        
    RETURN ('0'B);                                                      
                                                                        
 END FINDES_UDENL_EJD_MAPNING;                                          
                                                                        
 /*********************************************************************/
 /* Tjek om der findes en allerede anvendt mapning til et nyt         */
 /* ejendomsnummer, men fra et andet gammelt ejendomsnummer i forhold */
 /* til det, som der aktuelt forsøges mappet for. Dermed kontrolleres */
 /* der for, at der kun mappes fra et gammelt ejendomsnummer til et   */
 /* nyt ejendomsnummer for et givent personnummer.                    */
 /*********************************************************************/
 FINDES_ANDEN_GÆLD_UDENL_EJD_LOGNING: PROC (P_TIL_EVS_AAR               
                                           ,P_AFVIKLINGS_ID             
                                           ,P_DATA_ID                   
                                           ,P_EKOMNR                    
                                           ,P_EEJDNR_FRA                
                                           ,P_EEJDNR_TIL                
                                           ,P_PROGRAMNAVN               
                                           ,P_JOBNAVN                   
                                           ,P_DCPRN)                    
                                      RETURNS(BIT(1));                  
                                                                        
 DCL P_TIL_EVS_AAR                  FIXED BIN (15);                     
 DCL P_AFVIKLINGS_ID                CHAR (16);                          
 DCL P_DATA_ID                      FIXED BIN (15);                     
 DCL P_EKOMNR                       BIN FIXED (15);                     
 DCL P_EEJDNR_FRA                   BIN FIXED (31);                     
 DCL P_EEJDNR_TIL                   BIN FIXED (31);                     
 DCL P_PROGRAMNAVN                  CHAR (08);                          
 DCL P_JOBNAVN                      CHAR (08);                          
 DCL P_DCPRN                        DEC FIXED (11);                     
                                                                        
    DCLBE83100T.TIL_EVS_AAR   = P_TIL_EVS_AAR;                          
    DCLBE83100T.AFVIKLINGS_ID = P_AFVIKLINGS_ID;                        
    DCLBE83100T.DATA_ID       = P_DATA_ID;                              
    DCLBE83100T.EKOMNR        = P_EKOMNR;                               
    DCLBE83100T.EEJDNR_FRA    = P_EEJDNR_FRA;                           
    DCLBE83100T.EEJDNR_TIL    = P_EEJDNR_TIL;                           
    DCLBE83100T.PROGRAMNAVN   = P_PROGRAMNAVN;                          
    DCLBE83100T.JOBNAVN       = P_JOBNAVN;                              
    DCLBE83100T.EJER_DCPRN    = P_DCPRN;                                
                                                                        
    EXEC SQL SELECT   EEJDNR_FRA                                        
             INTO     :DCLBE83100T.EEJDNR_FRA                           
             FROM     BE83100T                                          
             WHERE    TIL_EVS_AAR   =                                   
                      :DCLBE83100T.TIL_EVS_AAR                          
               AND    AFVIKLINGS_ID =                                   
                      :DCLBE83100T.AFVIKLINGS_ID                        
               AND    DATA_ID       =                                   
                      :DCLBE83100T.DATA_ID                              
               AND    EKOMNR        =                                   
                      :DCLBE83100T.EKOMNR                               
               AND    EEJDNR_TIL    =                                   
                      :DCLBE83100T.EEJDNR_TIL                           
               AND    PROGRAMNAVN   =                                   
                      :DCLBE83100T.PROGRAMNAVN                          
               AND    JOBNAVN       =                                   
                      :DCLBE83100T.JOBNAVN                              
               AND    EJER_DCPRN    =                                   
                      :DCLBE83100T.EJER_DCPRN                           
               AND    EEJDNR_FRA    <>                                  
                      :DCLBE83100T.EEJDNR_FRA                           
               AND    GÆLDENDE_MARK = 'J'                               
             FETCH FIRST ROW ONLY                                       
             ;                                                          
                                                                        
    SELECT (SQLCA.SQLCODE);                                             
       WHEN (+000)                                                      
       DO;                                                              
          RETURN ('1'B);                                                
       END;                                                             
       WHEN (+100)                                                      
       DO;                                                              
       END;                                                             
       OTHERWISE                                                        
       DO;                                                              
          CALL SQL_ERROR (PROCNAME(), 831 ,'SELECT BE83100T');          
       END;                                                             
    END;                                                                
                                                                        
    RETURN ('0'B);                                                      
                                                                        
 END FINDES_ANDEN_GÆLD_UDENL_EJD_LOGNING;                               
                                                                        
 /*********************************************************************/
 /* Tjek om der findes en allerede anvendt mapning til et nyt         */
 /* ejendomsnummer, men fra et andet gammelt ejendomsnummer i forhold */
 /* til det, som der aktuelt forsøges mappet for. Dermed kontrolleres */
 /* der for, at der kun mappes fra et gammelt ejendomsnummer til et   */
 /* nyt ejendomsnummer for et givent personnummer.                    */
 /*********************************************************************/
 OPRET_UDENL_EJD_LOGNING: PROC (P_TIL_EVS_AAR                           
                               ,P_AFVIKLINGS_ID                         
                               ,P_DATA_ID                               
                               ,P_EKOMNR                                
                               ,P_EEJDNR_FRA                            
                               ,P_EEJDNR_TIL                            
                               ,P_PROGRAMNAVN                           
                               ,P_JOBNAVN                               
                               ,P_EJER_DCPRN                            
                               ,P_ÆGTE_DCPRN                            
                               ,P_GÆLDENDE_MARK);                       
                                                                        
 DCL P_TIL_EVS_AAR                  FIXED BIN (15);                     
 DCL P_AFVIKLINGS_ID                CHAR (16);                          
 DCL P_DATA_ID                      FIXED BIN (15);                     
 DCL P_EKOMNR                       BIN FIXED (15);                     
 DCL P_EEJDNR_FRA                   BIN FIXED (31);                     
 DCL P_EEJDNR_TIL                   BIN FIXED (31);                     
 DCL P_PROGRAMNAVN                  CHAR (08);                          
 DCL P_JOBNAVN                      CHAR (08);                          
 DCL P_EJER_DCPRN                   DEC FIXED (11);                     
 DCL P_ÆGTE_DCPRN                   DEC FIXED (11);                     
 DCL P_GÆLDENDE_MARK                CHAR (01);                          
                                                                        
                                                                        
    DCLBE83100T.TIL_EVS_AAR   = P_TIL_EVS_AAR;                          
    DCLBE83100T.AFVIKLINGS_ID = P_AFVIKLINGS_ID;                        
    DCLBE83100T.DATA_ID       = P_DATA_ID;                              
    DCLBE83100T.EKOMNR        = P_EKOMNR;                               
    DCLBE83100T.EEJDNR_FRA    = P_EEJDNR_FRA;                           
    DCLBE83100T.EEJDNR_TIL    = P_EEJDNR_TIL;                           
    DCLBE83100T.PROGRAMNAVN   = P_PROGRAMNAVN;                          
    DCLBE83100T.JOBNAVN       = P_JOBNAVN;                              
    DCLBE83100T.EJER_DCPRN    = P_EJER_DCPRN;                           
    DCLBE83100T.ÆGTE_DCPRN    = P_ÆGTE_DCPRN;                           
    DCLBE83100T.GÆLDENDE_MARK = P_GÆLDENDE_MARK;                        
    DCLBE83100T.GLNY_LOV      = SÆT_GLNY_LOV_UD_FRA_JOBNAVN (P_JOBNAVN);
                                                                        
    EXEC SQL INSERT   INTO BE83100T (                                   
                      TIL_EVS_AAR                                       
                     ,AFVIKLINGS_ID                                     
                     ,DATA_ID                                           
                     ,EKOMNR                                            
                     ,EEJDNR_FRA                                        
                     ,EEJDNR_TIL                                        
                     ,PROGRAMNAVN                                       
                     ,JOBNAVN                                           
                     ,EJER_DCPRN                                        
                     ,ÆGTE_DCPRN                                        
                     ,GÆLDENDE_MARK                                     
                     ,GLNY_LOV                                          
                     ,OPRET_TS                                          
             ) VALUES (                                                 
                      :DCLBE83100T.TIL_EVS_AAR                          
                     ,:DCLBE83100T.AFVIKLINGS_ID                        
                     ,:DCLBE83100T.DATA_ID                              
                     ,:DCLBE83100T.EKOMNR                               
                     ,:DCLBE83100T.EEJDNR_FRA                           
                     ,:DCLBE83100T.EEJDNR_TIL                           
                     ,:DCLBE83100T.PROGRAMNAVN                          
                     ,:DCLBE83100T.JOBNAVN                              
                     ,:DCLBE83100T.EJER_DCPRN                           
                     ,:DCLBE83100T.ÆGTE_DCPRN                           
                     ,:DCLBE83100T.GÆLDENDE_MARK                        
                     ,:DCLBE83100T.GLNY_LOV                             
                     ,CURRENT TIMESTAMP                                 
             );                                                         
                                                                        
    SELECT (SQLCA.SQLCODE);                                             
       WHEN (+000)                                                      
       DO;                                                              
       END;                                                             
       WHEN (-803)                                                      
       DO;                                                              
          /* Accepter at rækken allerede findes med samme    */         
          /* nøgleværdi, da der blot er tale om dublet       */         
          /* anvendelse af referencen til et ejendomsnummer. */         
       END;                                                             
       OTHERWISE                                                        
       DO;                                                              
          PUT SKIP LIST ('Data til BE83100T tabellen:');                
          PUT SKIP LIST ('   DCLBE83100T.TIL_EVS_AAR .: ' !!            
                   TRIM(CHAR(DCLBE83100T.TIL_EVS_AAR  )));              
          PUT SKIP LIST ('   DCLBE83100T.AFVIKLINGS_ID: ' !!            
                   TRIM(CHAR(DCLBE83100T.AFVIKLINGS_ID)));              
          PUT SKIP LIST ('   DCLBE83100T.DATA_ID .....: ' !!            
                   TRIM(CHAR(DCLBE83100T.DATA_ID      )));              
          PUT SKIP LIST ('   DCLBE83100T.EKOMNR ......: ' !!            
                   TRIM(CHAR(DCLBE83100T.EKOMNR       )));              
          PUT SKIP LIST ('   DCLBE83100T.EEJDNR_FRA ..: ' !!            
                   TRIM(CHAR(DCLBE83100T.EEJDNR_FRA   )));              
          PUT SKIP LIST ('   DCLBE83100T.EEJDNR_TIL ..: ' !!            
                   TRIM(CHAR(DCLBE83100T.EEJDNR_TIL   )));              
          PUT SKIP LIST ('   DCLBE83100T.PROGRAMNAVN .: ' !!            
                   TRIM(CHAR(DCLBE83100T.PROGRAMNAVN  )));              
          PUT SKIP LIST ('   DCLBE83100T.JOBNAVN .....: ' !!            
                   TRIM(CHAR(DCLBE83100T.JOBNAVN      )));              
          PUT SKIP LIST ('   DCLBE83100T.EJER_DCPRN ..: ' !!            
                   TRIM(CHAR(DCLBE83100T.EJER_DCPRN   )));              
          PUT SKIP LIST ('   DCLBE83100T.ÆGTE_DCPRN ..: ' !!            
                   TRIM(CHAR(DCLBE83100T.ÆGTE_DCPRN   )));              
          PUT SKIP LIST ('   DCLBE83100T.GÆLDENDE_MARK: ' !!            
                   TRIM(CHAR(DCLBE83100T.GÆLDENDE_MARK)));              
          PUT SKIP LIST ('   DCLBE83100T.GLNY_LOV ....: ' !!            
                   TRIM(CHAR(DCLBE83100T.GLNY_LOV     )));              
                                                                        
          CALL SQL_ERROR (PROCNAME(), 832 ,'INSERT BE83100T');          
       END;                                                             
    END;                                                                
                                                                        
 END OPRET_UDENL_EJD_LOGNING;                                           
                                                                        
 /*********************************************************************/
 /* Sæt GLNY_LOV feltet ud fra jobnavn, men først ud fra det          */
 /* kaldende programs navn, da de viste sig kun at blive benyttet     */
 /* enten fra SLUT 2024 Gl. lov eller SLUT 2024 Ny lov driftsflowet.  */
 /*********************************************************************/
 SÆT_GLNY_LOV_UD_FRA_JOBNAVN: PROC (P_JOBNAVN) RETURNS(CHAR(2));        
                                                                        
 DCL P_JOBNAVN                      CHAR(8);                            
                                                                        
    SELECT;                                                             
       WHEN (PACKAGENAME() = 'BH30000')    RETURN ('GL');               
       WHEN (PACKAGENAME() = 'BH30100')    RETURN ('GL');               
       WHEN (PACKAGENAME() = 'BH30024')    RETURN ('NY');               
       WHEN (PACKAGENAME() = 'BE30100')    RETURN ('NY');               
       WHEN (PACKAGENAME() = 'BE40300')    RETURN ('NY');               
       WHEN (SUBSTR(P_JOBNAVN,1,2) = 'BQ') RETURN ('GL');               
       WHEN (SUBSTR(P_JOBNAVN,1,2) = 'BH') RETURN ('GL');               
       WHEN (SUBSTR(P_JOBNAVN,1,2) = 'BE') RETURN ('NY');               
       OTHERWISE                                                        
       DO;                                                              
       END;                                                             
    END;                                                                
                                                                        
    RETURN ('??');                                                      
                                                                        
 END SÆT_GLNY_LOV_UD_FRA_JOBNAVN;                                       
                                                                        
