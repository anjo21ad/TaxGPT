 BH62800:/* FIND USA-PERSONER MED OVER 24 LINIER TIL CSC. ESKEMA 1997 */
         PROC OPTIONS (MAIN);                                           
                                                                        
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA 1997');           
                                                                        
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : PÅ GRUNDLAG AF BEREGNINGSBÅND DANNES BÅND TIL DC MED PER- * 
 *          SONER SOM HAR FLERE END 24 LINIER MED EJENDOMSOPLYSNINGER * 
 *          AF HENSYN TIL UDSKRIVNING AF SERVICEBREVE TIL USA-SKATTE- * 
 *          YDERE HVORTIL DER UDSKRIVES S20-EJENDOMSSKEMAER.          * 
 *                                                                    * 
 * INPUT  : B.H61000D      BEREGNINGSBÅND MED  A L L E  SKATTEYDERE.  * 
 *                                                                    * 
 * OUTPUT : D0311197.A181  UDTRÆK TIL DC (AKTUELT ÅR FORAN .A181)     * 
 *          B.H62801Y      TOTALLISTE.                                * 
 *                                                                    * 
 * PROGRAMMØR: AAGE RASMUSSEN, PUS, JANUAR 1993                       * 
 * RETTET    : AAGE RASMUSSEN, PUS, DEC    1994                       * 
 *           : AAGE RASMUSSEN, PUS, DEC    1995                       * 
 *           : AAGE RASMUSSEN, PFB, JAN    1996                       * 
 *           : AAGE RASMUSSEN, PFB, JAN    1997                       * 
 *           : AAGE RASMUSSEN, PFB, JAN    1998                       * 
 *                                                                    * 
 **********************************************************************/
                                                                        
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
                                                                        
 /********************************************************************* 
 *                                                                    * 
 *       Å R S T I L R E T N I N G S B E S K R I V E L S E :          * 
 *                                                                    * 
 *       MAX_LIN 'INIT' RETTES TIL EVT. NY VÆRDI D.V.S. HVOR MANGE    * 
 *       LINIER (EJENDOMSOPLYSNINGER) DER ER PLADS TIL PÅ DEN         * 
 *       UDVIDEDE SELVANGIVELSE (USA).                                * 
 *                                                                    * 
 *       INDK_ÅR 'INIT' RETTES TIL AKTUELT INDKOMSTÅR.                * 
 *                                                                    * 
 *       DIVERSE FELTER UNDER GEM TILRETTES JVF. BH62000.             * 
 *                                                                    * 
 *       NB. HUSK ALTID AT REKOMPILERE AF HENSYN TIL EVT. NYE         * 
 *           STRUKTURER.                                              * 
 *                                                                    * 
 *********************************************************************/ 
                                                                        
 DCL     MAX_LIN PIC '99'   INIT (24);                                  
 DCL     INDK_ÅR PIC '9999' INIT (1997);                                
                                                                        
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
                                                                        
 DCL     BH610I  FILE RECORD INPUT;          /*  BEREGNINGSBÅND      */ 
 DCL     BH628O  FILE RECORD OUTPUT;         /*  UDTRÆK TIL DC       */ 
                                                                        
 /********************************************************************* 
 *             DECLARE AF BEREGNINGSBÅND                              * 
 *********************************************************************/ 
                                                                        
 DCL     BH610_AR   CHAR      (7000) VAR;                               
                                                                        
 DCL     1 BH610                     BASED(ADDR(BH610_AR)),             
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH60100N;                                           
                                                                        
 DCL     1 BH61099                   BASED(ADDR(BH610_AR)),             
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH60199N;                                           
                                                                        
 /********************************************************************* 
 *       DECLARE AF UDTRÆK TIL DC                                     * 
 *********************************************************************/ 
                                                                        
 DCL     1 BH628_1,                              /* STARTINDIVID     */ 
           %INCLUDE BH62801N;                                           
                                                                        
 DCL     1 BH628_2,                              /* PERSONINDIVID    */ 
           %INCLUDE BH62802N;                                           
                                                                        
 DCL     1 BH628_3,                              /* SLUTINDIVID      */ 
           %INCLUDE BH62803N;                                           
                                                                        
 /********************************************************************* 
 *       DECLARE AF TÆLLEVÆRKER TIL TOTALLISTE                        * 
 *********************************************************************/ 
                                                                        
 DCL     ANT_LÆS             FIXED (07)  INIT (0);                      
 DCL     ANT_HENVIS          FIXED (07)  INIT (0);                      
 DCL     OPT_LINIER(30)      FIXED (07);                                
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     EOF_BH610       BIT       (1);                                 
 DCL     JA              BIT       (1)  INIT ('1'B);                    
 DCL     NEJ             BIT       (1)  INIT ('0'B);                    
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         BASED(ADDR(DATO1)),                            
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
 DCL     1 GEM,                                                         
           2 DCPRCIR     FIXED     (10),                                
           2 FEJD        FIXED     (5),                                 
           2 FLIN        FIXED     (5),                                 
           2 CINVPNR     CHAR      (1),                                 
           2 CLIN01      PIC       '9',                                 
           2 CLIN02      PIC       '9',                                 
           2 CLIN03      PIC       '9',                                 
           2 CLIN04      PIC       '9',                                 
           2 CLIN05      PIC       '9',                                 
           2 CLIN06      PIC       '9',                                 
           2 CLIN07      PIC       '9',                                 
           2 CLIN08      PIC       '9',                                 
           2 CLIN09      PIC       '9',                                 
           2 CLIN10      PIC       '9',                                 
           2 CLIN11      PIC       '9',                                 
           2 CLIN12      PIC       '9',                                 
           2 CLIN13      PIC       '9',                                 
           2 CLIN14      PIC       '9',                                 
           2 CLIN15      PIC       '9',                                 
           2 CLIN16      PIC       '9';                                 
                                                                        
 DCL     HJ_CLIN(16)     PIC       '9'    BASED(ADDR(GEM.CLIN01));      
                                                                        
 DCL     I               BIN FIXED (15);                                
                                                                        
 /*********************************************************************/
 /*          DECLARE AF ENTRY OG BUILTIN                              */
 /*********************************************************************/
                                                                        
 DCL     ZS34900         ENTRY OPTIONS (INTER ASM);   /* DEBITERING   */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY OPTIONS (INTER ASM);   /* UDSKRIV SSI  */
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     LOW             BUILTIN;                                       
 DCL     HIGH            BUILTIN;                                       
                                                                        
 /*********************************************************************/
 /*      LINIER TIL DIVERSE KØRSELSKONTROLLISTER                      */
 /*********************************************************************/
                                                                        
 DCL     1 OVERLIN1,                                                    
           2 CTL         CHAR      (1),                                 
           2 TX1         CHAR      (24) INIT ('PROGRAM BH62800L'),      
           2 TX2         CHAR      (63) INIT                            
             ('EJENDOMSSKEMA - DAN BÅND TIL DC INDEHOLDENDE PERSONER MED
  OVER '),                                                              
           2 TX3         PIC       '99',                                
           2 TX4         CHAR      (19) INIT (' LINIER PÅ USA'),        
           2 TX5         CHAR      (14) INIT ('UDSKREVET DEN '),        
           2 DATO        CHAR      (10);                                
                                                                        
 DCL     1 OVERLIN2,                                                    
           2 CTL         CHAR      (1),                                 
           2 TX1         CHAR      (25) INIT ((25)' '),                 
           2 TX2         CHAR      (107)INIT ('KØRSELSKONTROLLISTE');   
                                                                        
 DCL     1 LIN1,                                                        
          2 CTL          CHAR (1),                                      
          2 TEKST        CHAR (80),                                     
          2 ANT          PIC  'ZZZ.ZZZ.ZZZ',                            
          2 REST         CHAR (41) INIT (' ');                          
                                                                        
 DCL     1 LIN2,                                                        
          2 CTL          CHAR (1),                                      
          2 TEKST1       CHAR (22)      INIT ('ANTAL SKATTEYDERE MED '),
          2 ANTLIN       PIC  'ZZ',                                     
          2 TEKST2       CHAR (26)      INIT (' LINIER '),              
          2 ANT1         PIC  'ZZZ.ZZZ.ZZZ',                            
          2 F1           CHAR (5),                                      
          2 ANT2         PIC  'ZZZ.ZZZ.ZZZ',                            
          2 F2           CHAR (5),                                      
          2 ANT3         PIC  'ZZZ.ZZZ.ZZZ',                            
          2 F3           CHAR (5),                                      
          2 ANT4         PIC  'ZZZ.ZZZ.ZZZ',                            
          2 REST         CHAR (23);                                     
                                                                        
 DCL     1 LIN_BLANK,                                                   
          2 CTL          CHAR (1),                                      
          2 F1           CHAR (132)  INIT (' ');                        
                                                                        
  %INCLUDE ZZ20301M;                                                    
                                                                        
 /********************************************************************* 
 *                       HOUSEKEEPING.                                * 
 *********************************************************************/ 
                                                                        
         CALL ZS61900;                                                  
                                                                        
         ON ERROR CALL PLIDUMP ('SNHOB');                               
                                                                        
         OPEN FILE (BH610I)  TITLE ('BH61000I');                        
         OPEN FILE (BH628O)  TITLE ('BH62800O');                        
                                                                        
         ON ENDFILE (BH610I)                                            
         BEGIN;                                                         
            EOF_BH610 = JA;                                             
            BH610.DCPRCIR = 99999999999;                                
         END;                                                           
                                                                        
         CALL ZZ20390 ('*OPEN','BH62801Y');                             
                                                                        
         CALL SKRIV_START;                                              
                                                                        
         OPT_LINIER(*) = 0;                                             
         EOF_BH610 = NEJ;                                               
                                                                        
 /********************************************************************* 
 *                  PROCES                                            * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_BH610;                                                
                                                                        
         GEM = BH610, BY NAME;                                          
                                                                        
         DO WHILE (EOF_BH610 = NEJ);                                    
                                                                        
            IF GEM.DCPRCIR ^= BH610.DCPRCIR                             
            THEN                                                        
               DO;                                                      
                                                                        
                  /* SKIFT PÅ PERSONNR. */                              
                                                                        
                  CALL REGULER_ANT_LIN;                                 
                  CALL OPTÆL_LINIER;                                    
                  CALL SKRIV_PERSON;                                    
                                                                        
               END;                                                     
                                                                        
            GEM = BH610, BY NAME;                                       
                                                                        
            CALL LÆS_BH610;                                             
                                                                        
         END;               /* DO WHILE */                              
                                                                        
 /********************************************************************* 
 *       AFSLUTNING                                                   * 
 *********************************************************************/ 
                                                                        
         CALL REGULER_ANT_LIN;         /* SIDSTE PERSON */              
         CALL OPTÆL_LINIER;                                             
         CALL SKRIV_PERSON;                                             
                                                                        
         CALL SKRIV_SLUT;                                               
                                                                        
         CALL TOTALLISTE;                                               
                                                                        
         CALL FAKTURER_TS;                                              
                                                                        
         CALL ZZ20300 (LIN_BLANK,'99');                                 
                                                                        
         CLOSE FILE (BH610I),                                           
               FILE (BH628O);                                           
                                                                        
 /********************************************************************* 
 *    BEREGNINGSBÅND INDLÆSES                                         * 
 *********************************************************************/ 
 LÆS_BH610:                                                             
         PROC;                                                          
                                                                        
         DO UNTIL ( EOF_BH610 = JA ! BH610.FLIN > 0 );                  
                                                                        
            READ FILE (BH610I) INTO (BH610_AR);                         
                                                                        
            IF EOF_BH610 = NEJ                                          
            THEN                                                        
               DO;                                                      
                  /* IKKE OPTÆLLINGSINDIVID */                          
                  IF BH610.EKOMNR ^= 999                                
                  THEN                                                  
                     ANT_LÆS = ANT_LÆS + 1;                             
                  ELSE                                                  
                     EOF_BH610 = JA;                                    
               END;                                                     
                                                                        
         END;                                                           
                                                                        
 END LÆS_BH610;                                                         
 /********************************************************************* 
 *    REGULER ANTAL LINIER MED EVENTUELLE SLUTLINIER + BLANKE LINIER  * 
 *********************************************************************/ 
 REGULER_ANT_LIN:                                                       
         PROC;                                                          
                                                                        
         IF GEM.CINVPNR ^= '0'                /* HVIS EJ ET PERSONNR.*/ 
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF GEM.CLIN16 = 1                     /* SLUTLINIE MEDTÆLLES */
         THEN                                                           
            GEM.FLIN = GEM.FLIN + 1;                                    
                                                                        
         GEM.FLIN = GEM.FLIN + GEM.FEJD;      /* BLK LINIE MELLEM EJD */
                                                                        
         IF GEM.CLIN16 = 0            /* INGEN BLK LINIE EFTER SIDSTE */
         THEN                         /* EJD HVIS INGEN SLUTLINIE     */
            GEM.FLIN = GEM.FLIN - 1;                                    
                                                                        
 END REGULER_ANT_LIN;                                                   
 /********************************************************************* 
 *    DER OPTÆLLES LINIER PR.SKATTEYDER TIL BRUG FOR TOTALLISTEN      * 
 *********************************************************************/ 
 OPTÆL_LINIER:                                                          
         PROC;                                                          
                                                                        
         IF GEM.CINVPNR ^= '0'                /* HVIS EJ ET PERSONNR.*/ 
         THEN                                                           
            RETURN;                                                     
                                                                        
         IF GEM.FLIN > 30                                               
         THEN                                                           
            I = 30;                                                     
         ELSE                                                           
            I = GEM.FLIN;                                               
                                                                        
         OPT_LINIER(I) = OPT_LINIER(I) + 1;                             
                                                                        
 END OPTÆL_LINIER;                                                      
 /********************************************************************* 
 *    HVIS EN USA-PERSONS EJENDOMME UDSKRIVES PÅ S20 (EJD.SKEMA)      * 
 *    SKRIVES EN RECORD TIL DC (MEN KUN HVIS VALIDT PERSONNR.)        * 
 *********************************************************************/ 
 SKRIV_PERSON:                                                          
         PROC;                                                          
                                                                        
         IF GEM.CINVPNR ^= '0' !              /* HVIS EJ ET PERSONNR.*/ 
            GEM.FLIN <= MAX_LIN               /* DER ER PLADS PÅ USA */ 
         THEN                                                           
            RETURN;                                                     
                                                                        
         BH628_2.INDVNR  = 4005;                                        
         BH628_2.FELTLG  = 20;                                          
         BH628_2.INDVLG  = 20;                                          
         BH628_2.INDKÅR  = INDK_ÅR;                                     
         BH628_2.DCPRCIR = GEM.DCPRCIR;                                 
                                                                        
         WRITE FILE(BH628O) FROM (BH628_2);                             
                                                                        
         ANT_HENVIS = ANT_HENVIS + 1;                                   
                                                                        
 END SKRIV_PERSON;                                                      
 /********************************************************************* 
 *    SKRIV STARTRECORD TIL DC                                        * 
 *********************************************************************/ 
 SKRIV_START:                                                           
         PROC;                                                          
                                                                        
         BH628_1          = '';                                         
         BH628_1.FASTLG   = 48;                                         
         BH628_1.INDVLG   = 48;                                         
         BH628_1.SORTFELT = LOW(8);                                     
         BH628_1.INDVTYP  = '1';                                        
         BH628_1.FILNR    = 'D0311197A181';                             
                                                                        
         WRITE FILE(BH628O) FROM (BH628_1);                             
                                                                        
 END SKRIV_START;                                                       
 /********************************************************************* 
 *    SKRIV SLUTRECORD TIL DC                                         * 
 *********************************************************************/ 
 SKRIV_SLUT:                                                            
         PROC;                                                          
                                                                        
         BH628_3          = '';                                         
         BH628_3.FASTLG   = 48;                                         
         BH628_3.INDVLG   = 48;                                         
         BH628_3.SORTFELT = HIGH(8);                                    
         BH628_3.INDVTYP  = '3';                                        
         BH628_3.INDVANT  = ANT_HENVIS + 2;                             
                                                                        
         WRITE FILE(BH628O) FROM (BH628_3);                             
                                                                        
 END SKRIV_SLUT;                                                        
 /********************************************************************* 
 *       TOTALER UDSKRIVES.                                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
         PROC;                                                          
                                                                        
         LIN_BLANK = ZZIK1;                                             
         CALL ZZ20300 (LIN_BLANK,'01');                                 
         OVERLIN1.CTL = ZZWS2;                                          
         OVERLIN1.TX3 = MAX_LIN;                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
         CALL ZZ20300 (OVERLIN1,'01');                                  
         OVERLIN2.CTL = ZZWS2;                                          
         CALL ZZ20300 (OVERLIN2,'01');                                  
                                                                        
         LIN1.CTL = ZZWS2;                                              
         LIN1.ANT = ANT_LÆS;                                            
         LIN1.TEKST = 'ANTAL LÆSTE PÅ B.H61000D';                       
         CALL ZZ20300 (LIN1,'01');                                      
                                                                        
         LIN1.CTL = ZZWK1;                                              
         LIN1.ANT = ANT_HENVIS;                                         
         LIN1.TEKST = 'ANTAL PERSONER SOM HAR OVER ' !! MAX_LIN !!      
                      ' LINIER MED EJENDOMSOPLYSNINGER';                
         CALL ZZ20300 (LIN1,'01');                                      
                                                                        
         CALL ZZ20300 (OVERLIN1,'01');                                  
         OVERLIN2.TX2 = 'OPTÆLLINGER VEDR. ANTAL LINIER PR. SKATTEYDER';
         CALL ZZ20300 (OVERLIN2,'01');                                  
                                                                        
         LIN2.CTL = ZZWS1;                                              
         DO I = 1 TO 30;                                                
            LIN2.ANTLIN = I;                                            
            IF I = 30                                                   
            THEN                                                        
               LIN2.TEKST2 = ' ELLER FLERE LINIER';                     
            LIN2.ANT1 = OPT_LINIER (I);                                 
            LIN2.REST = ' ';                                            
            CALL ZZ20300 (LIN2,'01');                                   
         END;                                                           
                                                                        
 END TOTALLISTE;                                                        
 /*********************************************************************/
 /*      HALVAUTOMATISK FAKTURERING AF EJENDOMSOPLYSNINGER PÅ USA,    */
 /*      BSA ELLER PSA. BETALES  K U N  AF TOLD & SKAT PR. RC.        */
 /*********************************************************************/
 FAKTURER_TS:  PROC;                                                    
                                                                        
 DCL   1 SMF,                                                           
         2 RETURKODE     BIT       (8),                                 
         2 EKOMNR        PIC       '9999',                              
         2 EINST         CHAR      (3),                                 
         2 ANTENH        PIC       '(7)9',                              
         2 CENHED        CHAR      (3),                                 
         2 AENHED        CHAR      (20);                                
                                                                        
         RETURN; /* OPGAVEN SKAL IKKE FAKTURERES FRA OG MED 1995 */     
                                                                        
         LIN_BLANK.CTL =  ZZWS2;                                        
         LIN_BLANK.F1  = (43)'*'  !!  '  KOMMUNENR '!! SMF.EKOMNR !!    
                       '  FEJL I HALVAUTO. FAKTURERING EJD.OPLYSN.   '  
                       !!  (28)'*';                                     
                                                                        
         SMF.EKOMNR = 6989; /*T&S*/                                     
         SMF.EINST  = '000';                                            
         SMF.ANTENH = 1;                                                
         SMF.CENHED = '901';                                            
         SMF.AENHED = 'USA EJD OPL PÅ S20  ';                           
         CALL ZS34900 (SMF);                                            
                                                                        
         IF SMF.RETURKODE ^= '00000000'B                                
         THEN                                                           
            CALL ZZ20300 (LIN_BLANK,'01');                              
                                                                        
 END FAKTURER_TS;                                                       
 END  BH62800;                                                          
