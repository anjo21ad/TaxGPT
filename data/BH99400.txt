  PROCESS OPT(TIME);                                                    
 BH99400: /* SKAF INDIVIDER TIL FEJLRETNING */                          
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /*********************************************************************/
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA A/S 2001');       
 /**********************************************************************
 *                                                                     *
 * PROGRAMMØR: AAGE RASMUSSEN  FEB 2002                                *
 *                                                                     *
 **********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONNECTED;                  
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH960I FILE RECORD INPUT;                                      
 DCL     BH994O FILE RECORD OUTPUT;                                     
 /********************************************************************* 
 *       DECLARE AF UDTRÆK                                            * 
 *********************************************************************/ 
 DCL     BH960_AR        CHAR      (4000) VAR;                          
 DCL     1 BH960         BASED     (ADDR(BH960_AR)),                    
           2 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH90000N;;                                          
 DCL     1 BH90099,                                                     
           %INCLUDE BH90099N;                                           
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 DCL     1 TV,                   /* TÆLLEVÆRKER TIL TOTALLISTEN */      
           2 LÆS         FIXED DEC (7),                                 
           2 SKR         FIXED DEC (7),                                 
           2 F5154       FIXED DEC (7),                                 
           2 NULDATO_FØR FIXED DEC (7),                                 
           2 NULDATO_EFT FIXED DEC (7),                                 
           2 NY_PENS     FIXED DEC (7),                                 
           2 NY_COR      FIXED DEC (7);                                 
 /********************************************************************* 
 *       DECLARE AF BUILTIN'S                                         * 
 *********************************************************************/ 
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 /********************************************************************* 
 *       DECLARE AF ENTRY'S                                           * 
 *********************************************************************/ 
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH99400L'),                                        
           2 F1          CHAR      (25)      INIT      (' '),           
           2 TEKST2      CHAR      (57)      INIT      (                
           'UDTRÆK TIL RET F5154 OG CELØNCOR OPSÆTNING'),               
           2 F2          CHAR      (12)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZZ',                       
           2 F2          CHAR      (61)      INIT      (' ');           
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
 EXTERNAL INIT ('NOTEST(ALL,,;)');                                      
 DCL     EOF_BH960       BIT       (1);                                 
 DCL     SKR_CFØREFT     BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     HJCPR           PIC       '(10)9';                             
                                                                        
 DCL     1 HJCPR1        BASED(ADDR(HJCPR)),                            
           2 F1          CHAR      (4),                                 
           2 FØDÅR       PIC       '99';                                
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL ZS61900;                         /* UDSKRIVNING AF SSI */ 
                                                                        
         EOF_BH960 = NEJ;                                               
                                                                        
         ON ERROR                                                       
            CALL PLIDUMP ('SNHOB');                                     
                                                                        
         OPEN FILE (BH960I) TITLE ('BH96000I');                         
         OPEN FILE (BH994O) TITLE ('BH99400O');                         
                                                                        
         ON ENDFILE (BH960I)                                            
            EOF_BH960 = JA;                                             
                                                                        
         TV = '';                                                       
                                                                        
         CALL ZZ20390 ('*OPEN','BH99401Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
                                                                        
         SIDELIN.CCA  = ZZIK1;                                          
         OVERLIN1.CCA = ZZWS2;                                          
         OVERLIN2.CCA = ZZWS3;                                          
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         READ FILE (BH960I) INTO (BH960_AR);                            
                                                                        
         DO WHILE ( EOF_BH960 = NEJ );                                  
                                                                        
            CALL BEHANDL;                                               
                                                                        
            READ FILE (BH960I) INTO (BH960_AR);                         
                                                                        
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
 /********************************************************************* 
 *       PERSONER SOM EVT. SKAL UDTRÆKKES                             * 
 *********************************************************************/ 
 BEHANDL:                                                               
 PROC;                                                                  
                                                                        
         IF BH960.SORT_CPR >= 9999999999     /* OPTÆLL.INDV. */         
         THEN                                                           
            RETURN;                                                     
                                                                        
         TV.LÆS = TV.LÆS + 1;                                           
                                                                        
         IF BH960.TIL_EVS.DATO0107 = 0                                  
         THEN                                                           
            DO;                                                         
              TV.NULDATO_FØR = TV.NULDATO_FØR + 1;                      
              CALL ENDELIG_1_7_98_DATO(BH960.TIL_EVS.DATO0107);         
              IF BH960.TIL_EVS.DATO0107 = 0                             
              THEN                                                      
                 TV.NULDATO_EFT = TV.NULDATO_EFT + 1;                   
            END;                                                        
                                                                        
         SKR_CFØREFT = NEJ;                                             
                                                                        
         IF BH960.TIL_EVS.CPTYPSLUT = '2' &                             
            BH960.TIL_EVS.CPTYP_ÆND = ' '                               
         THEN                                                           
            CALL RET_CFØREFT;                                           
                                                                        
         IF BH960.FEJLNR = 5154 !                                       
            SKR_CFØREFT = JA                                            
         THEN                                                           
            DO;                                                         
              TV.SKR = TV.SKR + 1;                                      
              IF BH960.FEJLNR = 5154                                    
              THEN                                                      
                 TV.F5154 = TV.F5154 + 1;                               
              BH960.FEJLNR = 0;                                         
              WRITE FILE (BH994O) FROM (BH960_AR);                      
            END;                                                        
                                                                        
 END BEHANDL;                                                           
 /********************************************************************* 
 *       PERSONER MED FORKERT CFØREFT (CELØNCOR)                      * 
 *********************************************************************/ 
 RET_CFØREFT:                                                           
 PROC;                                                                  
                                                                        
         IF  BH960.MT.HIST_OPL.CFØREFT(2001) > 0 &                      
             BH960.MT.CFØRFORS               = 0 &                      
             BH960.MT.CFØRCOR                = 0 &                      
             BH960.MT.CFØRPENS               = 0                        
         THEN                                                           
           DO;                                                          
             BH960.MT.HIST_OPL.CFØREFT(2001) =                          
             BH960.MT.HIST_OPL.CFØREFT(2001) + 1;                       
             IF BH960.MT.HIST_OPL.CFØREFT(2001) = 3                     
             THEN                                                       
                TV.NY_PENS = TV.NY_PENS + 1;                            
             ELSE                                                       
                TV.NY_COR = TV.NY_COR + 1;                              
             SKR_CFØREFT = JA;                                          
             RETURN;                                                    
           END;                                                         
                                                                        
         IF BH960.MT.HIST_OPL.CFØREFT(2001) = 2 &                       
            BH960.MT.CFØRPENS               = 1                         
         THEN                                                           
           DO;                                                          
             BH960.MT.HIST_OPL.CFØREFT(2001) = 3;                       
             TV.NY_PENS = TV.NY_PENS + 1;                               
             SKR_CFØREFT = JA;                                          
             RETURN;                                                    
           END;                                                         
                                                                        
         IF BH960.MT.HIST_OPL.CFØREFT(2001) = 3  &                      
            (BH960.MT.CFØRFORS              = 1  !                      
             BH960.MT.CFØRCOR               = 1)                        
         THEN                                                           
           DO;                                                          
             BH960.MT.HIST_OPL.CFØREFT(2001) = 4;                       
             TV.NY_COR = TV.NY_COR + 1;                                 
             SKR_CFØREFT = JA;                                          
             RETURN;                                                    
           END;                                                         
                                                                        
 END RET_CFØREFT;                                                       
 /*********************************************************************/
 /* BH94131M:                                                         */
 /* OPSÆT EJERSTATUS PR. 1/7-1998 JVF. EJER-OPLYSNINGERNE FRA         */
 /* EVS GL. SLUTÅR, FORSKUD ELLER ESR I NÆVNTE PRIORITETSRÆKKEFØLGE   */
 /*********************************************************************/
 ENDELIG_1_7_98_DATO:                                                   
 PROC(DATO0107);                                                        
                                                                        
         DCL DATO0107 FIXED (9);                                        
         DCL HJ_DATO0107 FIXED (9);                                     
                                                                        
         HJ_DATO0107 = 0;                                               
                                                                        
         IF BH960.EVS_SLUT_EJER.DCPRN > 0 &                             
            BH960.EVS_SLUT_EJER.SIDSTE.CSLET = ' ' &                    
            BH960.EVS_SLUT_EJER.SIDSTE.DATO0107 > 0                     
         THEN                                                           
            HJ_DATO0107 = BH960.EVS_SLUT_EJER.SIDSTE.DATO0107;          
                                                                        
         IF BH960.EVS_SLUT_ÆGTF.DCPRN > 0 &                             
            BH960.EVS_SLUT_ÆGTF.SIDSTE.CSLET = ' ' &                    
           (BH960.EVS_SLUT_ÆGTF.SIDSTE.DATO0107 > 0 &                   
           (BH960.EVS_SLUT_ÆGTF.SIDSTE.DATO0107 < HJ_DATO0107 !         
            HJ_DATO0107 = 0))                                           
         THEN                                                           
            HJ_DATO0107 = BH960.EVS_SLUT_ÆGTF.SIDSTE.DATO0107;          
                                                                        
         IF BH960.EVS_FORSKUD.DCPRN > 0 &                               
           (BH960.EVS_FORSKUD.DATO0107 > 0 &                            
           (BH960.EVS_FORSKUD.DATO0107 < HJ_DATO0107 !                  
            HJ_DATO0107 = 0))                                           
         THEN                                                           
            HJ_DATO0107 = BH960.EVS_FORSKUD.DATO0107;                   
                                                                        
         IF BH960.NEDSLAG.EJER.DATO0107 > 0 &                           
           (BH960.NEDSLAG.EJER.DATO0107 < HJ_DATO0107 !                 
            HJ_DATO0107 = 0)                                            
         THEN                                                           
            HJ_DATO0107 = BH960.NEDSLAG.EJER.DATO0107;                  
                                                                        
         IF BH960.NEDSLAG.ÆGTF.DATO0107 > 0 &                           
           (BH960.NEDSLAG.ÆGTF.DATO0107 < HJ_DATO0107 !                 
            HJ_DATO0107 = 0)                                            
         THEN                                                           
            HJ_DATO0107 = BH960.NEDSLAG.ÆGTF.DATO0107;                  
                                                                        
         DATO0107 = HJ_DATO0107;                                        
                                                                        
 END ENDELIG_1_7_98_DATO;                                               
 /********************************************************************* 
 *       SKRIVNING AF OPTÆLLINGSINDIVID                               * 
 *********************************************************************/ 
 SKRIV_OPTÆLLING:                                                       
         PROC;                                                          
                                                                        
         BH90099            = '';                                       
         BH90099.SORT_CPR   = 99999999999;                              
         BH90099.SORT_KOMNR = 999;                                      
         BH90099.SORT_EJDNR = 9999999;                                  
         BH90099.ANT_INDV   = TV.SKR;                                   
         WRITE FILE (BH994O) FROM (BH90099);                            
                                                                        
 END SKRIV_OPTÆLLING;                                                   
 /********************************************************************* 
 *       TOTALER UDSKRIVES.                                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
 PROC;                                                                  
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS;                                        
         DETLIN1.TEKST = 'ANTAL LÆST                        B.H96000D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.NULDATO_FØR;                                
         DETLIN1.TEKST = '      HERAF UDEN DATO0107 FØR              '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.NULDATO_EFT;                                
         DETLIN1.TEKST = '      HERAF UDEN DATO0107 EFTER            '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.SKR;                                        
         DETLIN1.TEKST = 'ANTAL SKREVET                     B.H99400D'; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.F5154;                                      
         DETLIN1.TEKST = '      HERAF MED FEJLNR 5154                '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.NY_PENS;                                    
         DETLIN1.TEKST = '      HERAF RETTET TIL FØRTIDSPENSIONIST   '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.NY_COR;                                     
         DETLIN1.TEKST = '      HERAF RETTET TIL EFTERLØNNER         '; 
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
  END TOTALLISTE;                                                       
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 AFSLUT:                                                                
 PROC;                                                                  
                                                                        
         CALL TOTALLISTE;                                               
         CALL SKRIV_OPTÆLLING;                                          
                                                                        
         CALL ZZ20300((133)' ','99');                                   
                                                                        
         CLOSE FILE (BH960I),                                           
               FILE (BH994O);                                           
                                                                        
 END AFSLUT;                                                            
                                                                        
 END  BH99400;                                                          
