 /**********************************************************************
 * PROJEKT:     EVS FORSKUD/SLUT                                       *
 * PROGRAMNAVN: BH30000M.                                              *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK ALLE AKTIVE OG VALIDE EJENDOMME FRA         *
 *              EVS SLUT 2011 PR. PERSON.                              *
 * PROGRAMMØR:  THOMAS FLINDT       THF,  PUS/T&S BRØNDBY  11.07.2001. *
 * ÆNDRINGSLOG: ESBEN BRODERSEN     ESB,  LSU/T&S BRØNDBY  30.07.2002. *
 *              ÅRSRULLET TIL FORSKUD 2003                             *
 *              ESBEN BRODERSEN     ESB,  LSU/T&S BALLERUP 17.07.2003. *
 *              ÅRSRULLET TIL FORSKUD 2004, NYE EVS TABELLER           *
 *              BO SCHMIDT          BOB,  LSU/T&S BALLERUP 07.06.2004. *
 *              ÅRSRULLET TIL FORSKUD 2005 / SLUT 2004                 *
 *  FORSKUD06   SUSANNE KROGH VILLUMSEN  SKV  T&S BALLERUP 07.06.2005. *
 *              ÅRSRULLET TIL FORSKUD 2006 / SLUT 2005                 *
 *  FORSKUD07   BO SCHMIDT          BOB,  LSU/T&S BALLERUP 11.05.2006. *
 *              ÅRSRULLET TIL FORSKUD 2007 / SLUT 2006                 *
 *  FORSKUD08   BO SCHMIDT          BOB,  LSU/T&S BALLERUP 22.05.2007. *
 *              ÅRSRULLET TIL FORSKUD 2008 / SLUT 2007                 *
 *  FORSKUD09   BO SCHMIDT          BOB,  LSU/T&S BALLERUP 24.04.2008. *
 *              ÅRSRULLET TIL FORSKUD 2009 / SLUT 2008                 *
 *  FORSKUD10   GERD HOLM-PEDERSEN  GEH,  PKF/PKA BALLERUP 07.04.2009. *
 *              ÅRSRULLET TIL FORSKUD 2010 / SLUT 2009                 *
 *  FORSKUD11   GERD HOLM-PEDERSEN  GEH,  PKF/PKA BALLERUP 28.05.2010. *
 *              ÅRSRULLET TIL FORSKUD 2011 / SLUT 2010                 *
 *  FORSKUD12   GERD HOLM-PEDERSEN  GEH,  PKF/PKA BALLERUP 12.05.2011. *
 *              ÅRSRULLET TIL FORSKUD 2012 / SLUT 2011                 *
 *  FORSKUD13   ESBEN BRODERSEN     ESB,  PR      BALLERUP 15.05.2012. *
 *              ÅRSRULLET TIL FORSKUD 2013 / SLUT 2012                 *
 *  FORSKUD14   ESBEN BRODERSEN     ESB,  PR      BALLERUP 21.05.2013. *
 *              ÅRSRULLET TIL FORSKUD 2014 / SLUT 2013                 *
 *  FORSKUD15   JØRGEN SAUGMANN     QQS,  PR      BALLERUP 27.06.2014. *
 *              ÅRSRULLET TIL FORSKUD 2015                             *
 *  FORSKUD16   Z6JNK.  ÅRSRULLET TIL FORSKUD 2016         08.06.2015. *
 *              Søg efter "RUL".                                       *
 *  SLUT 2015   Z8QEB                                      08.03.2016  *
 *              ÅRSTAL TAGES FRA MACRO BH65300M #01                    *
 *  FORSKUD17   Z8QEB ÅRSRULLET TIL FORSKUD 2017           12.06.2016  *
 *              BQ14->BQ15 FILNAVN                                     *
 *              BEGRÆNSNING PÅ EKOMNR TIL BRUGTEST                     *
 *  FORSKUD18   Z8QEB ÅRSRULLET TIL FORSKUD 2018           12.06.2017  *
 *              BQ15->BQ16 FILNAVN                                     *
 *  FORSKUD19   Z8QEB ÅRSRULLET TIL FORSKUD 2019           30.05.2018  *
 *              BQ16->BQ17 FILNAVN                                     *
 *              DEFECT #101 UDTRÆK FEJLNUMMER                          *
 *  SLUT18      Z6EBD 2FAMILIE BOLIGER                     14.09.2018  *
 *              Udtræk udviddet med EENHEDLBNR                         *
 *  FORSKUD20   Z6EBD ÅRSRULLET TIL FORSKUD 2020           21.03.2019  *
 *              BQ17->BQ18 FILNAVN                                     *
 *  FORSKUD21   Z6PBR ÅRSRULLET TIL FORSKUD 2021           23.03.2020  *
 *              BQ18->BQ19 FILNAVN                                     *
 *  FORSKUD2021 z6pbr D14                                  juni 2020   *
 *              Aktive periodeløbenumre skal videreføres selv om der   *
 *              er slettet højere periodeløbenumre på samme ejendom    *
 * FORSKUD22 Edward Laryea                        07/10-2020           *
 *            TILRETTET FOR FORSKUD2022/SLUT2021                       *
 *            Mellemperioden - 2020                                    *
 *  Slut 2021   Z6SEP                                      Marts 2021  *
 *              BH65300M rettet til BH55300M                           *
 *  FORSKUD21   Z6TIC ÅRSRULLET TIL FORSKUD 2024           21.02.2023  *
 *              BQ21->BQ22 FILNAVN                                     *
 *  Slut 2024   Z6PBR ÅRSRULLET TIL SLUT 2024              10.01.2024  *
 *              BQ22->BQ23 FILNAVN                                     *
 **********************************************************************/
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                 */
 /*********************************************************************/
 DECLARE_CURSOR: PROC;                                                  
                                                                        
         EXEC SQL DECLARE PERSON_CURSOR CURSOR FOR                      
                                                                        
              SELECT Distinct                                           
                     T1.DINDKAAR,                                       
                     T1.DCPRN,                                          
                     T1.EKOMNR,                                         
                     T1.EEJDNR,                                         
                     T1.EENHEDLBNR                                      
                                                                        
         FROM BQ30000T T1                                               
         WHERE  T1.DINDKAAR = :BH55600M.GLSLUTÅR /*#01*/                
         AND    T1.DTILGLD  = '9999-12-31-23.59.59.999999'              
         AND   (:PARMKOMNR1 = 0  OR                                     
               (:PARMKOMNR1 <> 0 AND                                    
                T1.EKOMNR IN (:PARMKOMNR1, 999)) OR                     
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0 AND               
                T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2, 999)) OR         
               (:PARMKOMNR1 <> 0 AND :PARMKOMNR2 <> 0                   
                 AND :PARMKOMNR3 <> 0 AND                               
                 T1.EKOMNR IN (:PARMKOMNR1,:PARMKOMNR2,                 
                               :PARMKOMNR3, 999)))                      
                                                                        
         ORDER BY T1.DINDKAAR,                                          
                  T1.DCPRN,                                             
                  T1.EKOMNR,                                            
                  T1.EEJDNR,                                            
                  T1.EENHEDLBNR                                         
                                                                        
         FOR READ ONLY;                                                 
                                                                        
      /***************************/                                     
                                                                        
         EXEC SQL DECLARE PERSON_EJD_CURSOR CURSOR FOR                  
                                                                        
              SELECT t1.elbnr,                                          
                     COALESCE(T4.INDHOLD_C, ' ') AS CSLET               
         FROM BQ30000T T1                                               
                  LEFT JOIN BQ31000T T4                                 
                     ON T4.DINDKAAR     = T1.DINDKAAR                   
                    AND T4.EKOMNR       = T1.EKOMNR                     
                    AND T4.EEJDNR       = T1.EEJDNR                     
                    AND T4.DCPRN        = T1.DCPRN                      
                    AND T4.EENHEDLBNR   = T1.EENHEDLBNR                 
                    AND T4.ELBNR        = T1.ELBNR                      
                    AND T4.EGENNR       = T1.EGENNR                     
                    AND T4.FELTKODE     = 89                            
                    AND T4.FELTKODETYPE = 3                             
         WHERE  T1.DINDKAAR   = :EVS_ESK.DINDKAAR                       
          AND   T1.EKOMNR     = :EVS_ESK.EKOMNR                         
          AND   T1.EEJDNR     = :EVS_ESK.EEJDNR                         
          AND   T1.DCPRN      = :EVS_ESK.DCPRN                          
          AND   T1.EENHEDLBNR = :EVS_ESK.EENHEDLBNR                     
          AND   T1.DTILGLD    = '9999-12-31-23.59.59.999999'            
                                                                        
         order by T1.elbnr desc                                         
                                                                        
         FOR READ ONLY;                                                 
                                                                        
      /***************************/                                     
         EXEC SQL                                                       
         DECLARE ESK_FEL_CUR CURSOR FOR                                 
                                                                        
         SELECT T5.INDHOLD_C,                                           
                T5.INDHOLD_D,                                           
                T5.FELTKODE                                             
                                                                        
         FROM   BQ31000T T5                                             
                                                                        
         WHERE  T5.DINDKAAR   = :EVS_ESK.DINDKAAR                       
         AND    T5.EKOMNR     = :EVS_ESK.EKOMNR                         
         AND    T5.EEJDNR     = :EVS_ESK.EEJDNR                         
         AND    T5.EENHEDLBNR = :EVS_ESK.EENHEDLBNR                     
         AND    T5.DCPRN      = :EVS_ESK.DCPRN                          
         AND    T5.ELBNR      = :EVS_ESK.ELBNR                          
         AND    T5.EGENNR     = :EVS_ESK.EGENNR                         
         ORDER BY T5.FELTKODE                                           
         FOR READ ONLY;                                                 
                                                                        
      /***************************/                                     
         EXEC SQL DECLARE RESULTAT_CURSOR CURSOR FOR                    
                                                                        
         SELECT T9.INDHOLD_D  /* DER HENTES KUN BEJERAN */              
                                                                        
         FROM BQ40000T T8,                                              
              BQ41000T T9                                               
         WHERE T8.DINDKAAR    = :BH55600M.GLSLUTÅR /*#01*/              
           AND T8.DCPRN       = :DCPRN_NGL                              
           AND T8.EKOMNR      = :KOM_NGL                                
           AND T8.EEJDNR      = :EJD_NGL                                
           AND T8.EENHEDLBNR  = :EENHEDLBNR_NGL   /* ?? */              
           AND T8.ELBNR    =:SIDSTE.ELBNR                               
           AND T8.DFRAGLD  =:SIDSTE.DFRAGLD                             
           AND T8.EGENNR   = (SELECT MAX(M.EGENNR)                      
                              FROM BQ40000T M                           
                              WHERE M.DINDKAAR    = T8.DINDKAAR         
                                AND M.DCPRN       = T8.DCPRN            
                                AND M.EKOMNR      = T8.EKOMNR           
                                AND M.EEJDNR      = T8.EEJDNR           
                                AND M.EENHEDLBNR  = T8.EENHEDLBNR       
                                AND M.ELBNR       = T8.ELBNR            
                                AND M.DFRAGLD     = T8.DFRAGLD          
                                AND M.CKOERSEL    = T8.CKOERSEL)        
           AND T8.CKOERSEL = 'B'                                        
           AND T8.DINDKAAR   = T9.DINDKAAR                              
           AND T8.DCPRN      = T9.DCPRN                                 
           AND T8.EKOMNR     = T9.EKOMNR                                
           AND T8.EEJDNR     = T9.EEJDNR                                
           AND T8.EENHEDLBNR = T9.EENHEDLBNR                            
           AND T8.ELBNR      = T9.ELBNR                                 
           AND T8.EGENNR     = T9.EGENNR                                
           AND T9.FELTKODE   = 26; /* BEJERAN */                        
                                                                        
      /***************************/                                     
         EXEC SQL DECLARE RESULTAT_DCUR CURSOR FOR                      
                                                                        
         SELECT T9.INDHOLD_D  /* DER HENTES KUN BEJERAN */              
                                                                        
         FROM BQ40000T T8,                                              
              BQ41000T T9                                               
         WHERE T8.DINDKAAR =:BH55600M.GLSLUTÅR /*#01*/                  
           AND T8.DCPRN    =:DCPRN_NGL                                  
           AND T8.EKOMNR   =:KOM_NGL                                    
           AND T8.EEJDNR   =:EJD_NGL                                    
           AND T8.EENHEDLBNR  = :EENHEDLBNR_NGL   /* ?? */              
           AND T8.ELBNR    =:SIDSTE.ELBNR                               
           AND DATE(T8.DFRAGLD) = :HJ_DFRAGLD_DTO                       
           AND T8.EGENNR   = (SELECT MAX(M.EGENNR)                      
                              FROM BQ40000T M                           
                              WHERE M.DINDKAAR      = T8.DINDKAAR       
                                AND M.DCPRN         = T8.DCPRN          
                                AND M.EKOMNR        = T8.EKOMNR         
                                AND M.EEJDNR        = T8.EEJDNR         
                                AND M.EENHEDLBNR    = T8.EENHEDLBNR     
                                AND M.ELBNR         = T8.ELBNR          
                                AND DATE(M.DFRAGLD) = DATE(T8.DFRAGLD)  
                                AND M.CKOERSEL      = T8.CKOERSEL)      
           AND T8.CKOERSEL = 'B'                                        
           AND T8.DINDKAAR = T9.DINDKAAR                                
           AND T8.DCPRN    = T9.DCPRN                                   
           AND T8.EKOMNR   = T9.EKOMNR                                  
           AND T8.EEJDNR   = T9.EEJDNR                                  
           AND T8.EENHEDLBNR = T9.EENHEDLBNR                            
           AND T8.ELBNR    = T9.ELBNR                                   
           AND T8.EGENNR   = T9.EGENNR                                  
           AND T9.FELTKODE = 26; /* BEJERAN */                          
                                                                        
 END DECLARE_CURSOR;                                                    
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF EJERSKABSTABEL BQ30000T                   */
 /*********************************************************************/
 FETCH_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL FETCH PERSON_CURSOR                                   
                                                                        
         INTO :EVS_ESK.DINDKAAR,                                        
              :EVS_ESK.DCPRN,                                           
              :EVS_ESK.EKOMNR,                                          
              :EVS_ESK.EEJDNR,                                          
              :EVS_ESK.EENHEDLBNR,                                      
              :EVS_ESK.ELBNR;                                           
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0) DO;                                                 
               ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                       
           END;                                                         
           WHEN (100);                                                  
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  =  'BH30000 ** 262  FETCH PERSON_CURSOR';     
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
 END FETCH_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 /* Skaf ELBNR - PBR Juni 2020                                        */
 /*********************************************************************/
 SKAF_ELBNR: PROC;                                                      
                                                                        
             GEM_ELBNR      = 0;                                        
             GEM_ELBNR_SLET = 0;                                        
                                                                        
             EXEC SQL OPEN PERSON_EJD_CURSOR;                           
             CALL KONTROL('264',' OPEN PERSON_EJD_CURSOR');             
                                                                        
             DO WHILE (SQLCA.SQLCODE = 0);                              
                                                                        
               EXEC SQL FETCH PERSON_EJD_CURSOR                         
               INTO :HJ_ELBNR,                                          
                    :HJ_CSLET;                                          
                                                                        
               IF SQLCA.SQLCODE = 0                                     
               THEN                                                     
                 DO;                                                    
                   IF HJ_CSLET = '1' &                                  
                      GEM_ELBNR = 0  &                                  
                      GEM_ELBNR_SLET = 0                                
                   then do;                                             
                      GEM_ELBNR_SLET = HJ_ELBNR;                        
                      end;                                              
                   IF HJ_CSLET = ' ' &                                  
                      GEM_ELBNR = 0                                     
                   then do;                                             
                      GEM_ELBNR = HJ_ELBNR;                             
                      end;                                              
                 END;                                                   
                                                                        
               IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)           
               THEN                                                     
                 DO;                                                    
                   FEJLTEKST = 'PERSON_EJD_CURSOR';                     
                   CALL SQL_FEJL;                                       
                 END;                                                   
                                                                        
             END;                                                       
                                                                        
             IF GEM_ELBNR > 0                                           
             then                                                       
                EVS_ESK.ELBNR = GEM_ELBNR;                              
             Else                                                       
                EVS_ESK.ELBNR = GEM_ELBNR_SLET;                         
                                                                        
             EXEC SQL CLOSE PERSON_EJD_CURSOR;                          
             CALL KONTROL('269',' CLOSE PERSON_EJD_CURSOR');            
                                                                        
                                                                        
 END SKAF_ELBNR;                                                        
 /*********************************************************************/
 /* SELECT FØRSTE GENERATION AF PERSON-EJENDOMSOPLYSN.                */
 /*********************************************************************/
 FØRSTE_PERSONEJENDOMSOPL: PROC;                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.EGENNR,                                         
                     T2.DFRAGLD,                                        
                     T2.DTILGLD,                                        
                     T2.CDATAFRA,                                       
                     T2.CAJOUR,                                         
                     T2.CSUPPL,                                         
                     T2.COMPLA,                                         
                     T2.DOMPLACPR,                                      
                     T2.FEJLNR    /*#101*/                              
                                                                        
              INTO :EVS_ESK.EGENNR,                                     
                   :EVS_ESK.DFRAGLD,                                    
                   :EVS_ESK.DTILGLD,                                    
                   :EVS_ESK.CDATAFRA,                                   
                   :EVS_ESK.CAJOUR,                                     
                   :EVS_ESK.CSUPPL,                                     
                   :EVS_ESK.COMPLA,                                     
                   :EVS_ESK.DOMPLACPR,                                  
                   :EVS_ESK.FEJLNR   /*#101*/                           
                                                                        
              FROM BQ30000T T2                                          
                                                                        
              WHERE  T2.DINDKAAR   = :EVS_ESK.DINDKAAR                  
               AND   T2.EKOMNR     = :EVS_ESK.EKOMNR                    
               AND   T2.EEJDNR     = :EVS_ESK.EEJDNR                    
               AND   T2.EEJDNR     = :EVS_ESK.EEJDNR                    
               AND   T2.DCPRN      = :EVS_ESK.DCPRN                     
               AND   T2.EENHEDLBNR = :EVS_ESK.EENHEDLBNR                
               AND   T2.ELBNR      = :EVS_ESK.ELBNR                     
               AND   T2.EGENNR   = 1;                                   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
             END;                                                       
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  =  'BH30000 ** 263  FØRSTE PERSONEJENDOM';    
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         FETCH_SQLKODE = SQLCA.SQLCODE;   /* GEMMES TIL SENERE BRUG  */ 
                                                                        
         IF SQLCA.SQLCODE = 0                                           
         THEN                                                           
           DO;                                                          
                                                                        
             EXEC SQL OPEN ESK_FEL_CUR;                                 
             CALL KONTROL('264',' OPEN ESK_FEL_CUR');                   
                                                                        
             DO WHILE (SQLCA.SQLCODE = 0);                              
                                                                        
               EXEC SQL                                                 
                                                                        
               FETCH ESK_FEL_CUR                                        
                                                                        
               INTO :EVS_ESK_FELT.INDHOLD_C,                            
                    :EVS_ESK_FELT.INDHOLD_D,                            
                    :EVS_ESK_FELT.FELTKODE;                             
                                                                        
                                                                        
               IF SQLCA.SQLCODE = 0                                     
               THEN                                                     
                 DO;                                                    
                   CALL FLYT_ESK_FEL;                                   
                 END;                                                   
                                                                        
               IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)           
               THEN                                                     
                 DO;                                                    
                   FEJLTEKST = 'ESK_FEL_CUR';                           
                   CALL SQL_FEJL;                                       
                 END;                                                   
                                                                        
             END;                                                       
                                                                        
             EXEC SQL CLOSE ESK_FEL_CUR;                                
             CALL KONTROL('269',' CLOSE EJD_FEL_CUR');                  
                                                                        
             CALL SKAF_EJENDOM;                                         
           END;                                                         
                                                                        
         IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)                 
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'FØRSTE_PERSONEJENDOMSOPL';                    
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
                                                                        
         HJ_DATOEN = ZM_OMSÆT_DATO_FRA_DB2 (PERSON.DOVTG);              
                                                                        
         IF HJ_DATOEN = ' '                                             
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-01-01';                       
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-01';         
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-31';         
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-30';         
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-29';         
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            PERSON.DOVTG = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-28';         
                                                                        
                                                                        
         HJ_DATOEN = ZM_OMSÆT_DATO_FRA_DB2 (PERSON.DAFSTAA);            
                                                                        
         IF HJ_DATOEN = ' '                                             
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-12-31';                     
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-01';       
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-31';       
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-30';       
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-29';       
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            PERSON.DAFSTAA = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-28';       
                                                                        
                                                                        
         HJ_DATOEN = ZM_OMSÆT_DATO_FRA_DB2 (PERSON.DATO0107);           
                                                                        
         IF HJ_DATOEN = ' '                                             
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-01-01';                    
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-01';      
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-31';      
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-30';      
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-29';      
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            PERSON.DATO0107 = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-28';      
                                                                        
                                                                        
         HJ_DATOEN = ZM_OMSÆT_DATO_FRA_DB2 (PERSON.DFRAFLYT);           
                                                                        
         IF HJ_DATOEN = ' '                                             
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-12-31';                    
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-01';      
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-31';      
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-30';      
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-29';      
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            PERSON.DFRAFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-28';      
                                                                        
                                                                        
         HJ_DATOEN = ZM_OMSÆT_DATO_FRA_DB2 (PERSON.DINDFLYT);           
                                                                        
         IF HJ_DATOEN = ' '                                             
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-01-01';                    
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-01';      
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-31';      
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-30';      
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-29';      
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            PERSON.DINDFLYT = HJ_DATO.AAR!!'-'!!HJ_DATO.MD!!'-28';      
                                                                        
 END FØRSTE_PERSONEJENDOMSOPL;                                          
 /*********************************************************************/
 /* SELECT SIDSTE GENERATION AF PERSON-EJENDOMSOPLYSN.                */
 /*********************************************************************/
 SIDSTE_PERSONEJENDOMSOPL: PROC;                                        
                                                                        
         EXEC SQL                                                       
              SELECT T2.EGENNR,                                         
                     T2.DFRAGLD,                                        
                     T2.DTILGLD,                                        
                     T2.CDATAFRA,                                       
                     T2.CAJOUR,                                         
                     T2.CSUPPL,                                         
                     T2.COMPLA,                                         
                     T2.DOMPLACPR,                                      
                     T2.FEJLNR    /*#101*/                              
                                                                        
              INTO :EVS_ESK.EGENNR,                                     
                   :EVS_ESK.DFRAGLD,                                    
                   :EVS_ESK.DTILGLD,                                    
                   :EVS_ESK.CDATAFRA,                                   
                   :EVS_ESK.CAJOUR,                                     
                   :EVS_ESK.CSUPPL,                                     
                   :EVS_ESK.COMPLA,                                     
                   :EVS_ESK.DOMPLACPR,                                  
                   :EVS_ESK.FEJLNR /*#101*/                             
                                                                        
              FROM BQ30000T T2                                          
                                                                        
              WHERE  T2.DINDKAAR   = :EVS_ESK.DINDKAAR                  
               AND   T2.EKOMNR     = :EVS_ESK.EKOMNR                    
               AND   T2.EEJDNR     = :EVS_ESK.EEJDNR                    
               AND   T2.EENHEDLBNR = :EVS_ESK.EENHEDLBNR                
               AND   T2.DCPRN      = :EVS_ESK.DCPRN                     
               AND   T2.ELBNR      = :EVS_ESK.ELBNR                     
               AND   T2.EGENNR   = (SELECT MAX(TA.EGENNR)               
                                      FROM BQ30000T TA                  
                                      WHERE  TA.DINDKAAR = T2.DINDKAAR  
                                        AND  TA.EKOMNR   = T2.EKOMNR    
                                        AND  TA.EEJDNR   = T2.EEJDNR    
                                        AND  TA.EENHEDLBNR =            
                                                       T2.EENHEDLBNR    
                                        AND  TA.DCPRN    = T2.DCPRN     
                                        AND  TA.ELBNR    = T2.ELBNR     
                                        AND  TA.DTILGLD  =              
                                        '9999-12-31-23.59.59.999999')   
         ;                                                              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
             END;                                                       
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'SELECT PERSONEJDOPL';                      
               PUT SKIP LIST('SQLKODE',SQLCODE);                        
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         IF SQLCA.SQLCODE = 0                                           
         THEN                                                           
           DO;                                                          
                                                                        
             EXEC SQL OPEN ESK_FEL_CUR;                                 
             CALL KONTROL('266',' OPEN ESK_FEL_CUR');                   
                                                                        
             DO WHILE (SQLCA.SQLCODE = 0);                              
                                                                        
               EXEC SQL                                                 
                                                                        
               FETCH ESK_FEL_CUR                                        
                                                                        
               INTO :EVS_ESK_FELT.INDHOLD_C,                            
                    :EVS_ESK_FELT.INDHOLD_D,                            
                    :EVS_ESK_FELT.FELTKODE;                             
                                                                        
                                                                        
               IF SQLCA.SQLCODE = 0                                     
               THEN                                                     
                 DO;                                                    
                   CALL FLYT_ESK_FEL;                                   
                 END;                                                   
                                                                        
               IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)           
               THEN                                                     
                 DO;                                                    
                   FEJLTEKST = 'ESK_FEL_CUR';                           
                   CALL SQL_FEJL;                                       
                 END;                                                   
                                                                        
             END;                                                       
                                                                        
             EXEC SQL CLOSE ESK_FEL_CUR;                                
             CALL KONTROL('269',' CLOSE ESK_FEL_CUR');                  
                                                                        
             CALL SKAF_EJENDOM;                                         
           END;                                                         
         IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)                 
         THEN                                                           
           DO;                                                          
             FEJLTEKST = 'SIDSTE_PERSONEJENDOMSOPL';                    
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END SIDSTE_PERSONEJENDOMSOPL;                                          
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BQ30000T                             */
 /*********************************************************************/
 OPEN_PERSONEJENDOMSOPL: PROC;                                          
                                                                        
         EXEC SQL OPEN PERSON_CURSOR;                                   
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN PERSON_CURSOR';                         
              FEJLTEKST  = 'BH30000 ** 253 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_PERSONEJENDOMSOPL;                                            
 /*********************************************************************/
 SKAF_BEJERAN: PROC;                                                    
                                                                        
         CALL OPEN_RESULTAT;                                            
         EXEC SQL FETCH RESULTAT_CURSOR                                 
                                                                        
         INTO :RESULTAT.BEJERAN;                                        
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
           WHEN(0)                                                      
              DO;                                                       
                INDK_RES.BEJERAN_SW = 0;                                
              END;                                                      
           WHEN(100)                                                    
              DO;                                                       
                HJ_DFRAGLD_DTO = SUBSTR(SIDSTE.DFRAGLD,1,10);           
                CALL SKAF_BEJERAN_D;                                    
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                FEJLTEKST = 'FETCH RESULTAT';                           
                FEJLTEKST  = 'BH30000 ** 254 ' !! FEJLTEKST;            
                CALL SQL_FEJL;                                          
              END;                                                      
         END; /* SELECT */                                              
                                                                        
         CALL CLOSE_RESULTAT;                                           
                                                                        
 END SKAF_BEJERAN;                                                      
 /*********************************************************************/
 SKAF_BEJERAN_D: PROC;                                                  
                                                                        
         CALL OPEN_RESULTAT_D;                                          
         EXEC SQL FETCH RESULTAT_DCUR                                   
                                                                        
         INTO :RESULTAT.BEJERAN;                                        
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
           WHEN(0)                                                      
              DO;                                                       
                INDK_RES.BEJERAN_SW = 0;                                
              END;                                                      
           WHEN(100)                                                    
              DO;                                                       
                RESULTAT.BEJERAN    =  0;                               
                INDK_RES.BEJERAN_SW = -1;                               
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                FEJLTEKST = 'FETCH RESULTAT_D';                         
                FEJLTEKST  = 'BH30000 ** 254 ' !! FEJLTEKST;            
                CALL SQL_FEJL;                                          
              END;                                                      
         END; /* SELECT */                                              
                                                                        
         CALL CLOSE_RESULTAT_D;                                         
                                                                        
 END SKAF_BEJERAN_D;                                                    
 /*********************************************************************/
 SKAF_EJENDOM: PROC;                                                    
                                                                        
         EJD_NØGLE.DINDKAAR   = EVS_ESK.DINDKAAR;                       
         EJD_NØGLE.EKOMNR     = EVS_ESK.EKOMNR;                         
         EJD_NØGLE.EEJDNR     = EVS_ESK.EEJDNR;                         
         EJD_NØGLE.EENHEDLBNR = EVS_ESK.EENHEDLBNR;                     
                                                                        
              /* RUL HERUNDER */                                        
         READ FILE (BQ235I) INTO (EJENDOM) KEY (EJD_NØGLEN);            
                                                                        
 END SKAF_EJENDOM;                                                      
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BQ40000T                             */
 /*********************************************************************/
 OPEN_RESULTAT: PROC;                                                   
                                                                        
         EXEC SQL OPEN RESULTAT_CURSOR;                                 
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN RESULTAT_CURSOR';                       
              FEJLTEKST  = 'BH30000 ** 255 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_RESULTAT;                                                     
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BQ40000T/BQ41000T                    */
 /*********************************************************************/
 OPEN_RESULTAT_D: PROC;                                                 
                                                                        
         EXEC SQL OPEN RESULTAT_DCUR;                                   
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN RESULTAT_DUR';                          
              FEJLTEKST  = 'BH30000 ** 255 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_RESULTAT_D;                                                   
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BQ30000T                            */
 /*********************************************************************/
 CLOSE_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL CLOSE PERSON_CURSOR;                                  
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE PERSON_CURSOR';                        
              FEJLTEKST  = 'BH30000 ** 256 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BQ01200T/BQ01100T                   */
 /*********************************************************************/
 CLOSE_RESULTAT: PROC;                                                  
                                                                        
         EXEC SQL CLOSE RESULTAT_CURSOR;                                
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE RESULTAT_CURSOR';                      
              FEJLTEKST  = 'BH30000 ** 257 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_RESULTAT;                                                    
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BQ01200T/BQ01100T                   */
 /*********************************************************************/
 CLOSE_RESULTAT_D: PROC;                                                
                                                                        
         EXEC SQL CLOSE RESULTAT_DCUR;                                  
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE RESULTAT_DCUR';                        
              FEJLTEKST  = 'BH30000 ** 257 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_RESULTAT_D;                                                  
 /***********************************************************/          
 KONTROL:PROC(TAL,TEKST);                                               
 DCL TAL   CHAR (3);                                                    
 DCL TEKST CHAR (80) VARYING;                                           
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0);                                                    
           OTHER                                                        
             DO;                                                        
               FEJLTEKST  = 'BH30000 ** '!!TAL!! TEKST;                 
               CALL SQL_FEJL;                                           
             END;                                                       
         END; /* SELECT*/                                               
 END KONTROL;                                                           
