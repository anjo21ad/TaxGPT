 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF IND- OG FRAFLYTNING I P-DATA            */
 /* slut05    Susanne Krogh Villumsen                   09-11-2005    */
 /*           Hvis der hverken er en tilflytterdato eller en          */
 /*           fraflytterdato på personen, hentes tilflytterdatoen     */
 /*           ved at bruge 1/1-0000 til 31/12-9999 som datoer         */
 /*********************************************************************/
 /* EVS SLUT-15.  JNK :  Ingen ændringer                             */ 
 /*********************************************************************/
 /* OMLAGT TIL CSRP-DATA                                              */
 /*********************************************************************/
 DECLARE_CURSOR: PROC;                                                  
                                                                        
         EXEC SQL DECLARE EJD_INDFLYT CURSOR FOR                        
              SELECT T1.ADRFRADTO                                       
              FROM BQ71000T T1                                          
              WHERE T1.PNR            = :SØG_DCPR                       
               AND  T1.BOPAEKMNR      = :SØG_EKOMNR                     
               AND  T1.VEJKOD         = :SØG_VEJK_EJD                   
               AND (T1.HUSNR          = :SØG_HUSNR_EJD1                 
                OR  T1.HUSNR          = :SØG_HUSNR_EJD2)                
               AND (T1.HUSBOGSTAADR   = :SØG_HUSBOGSTAV1                
                OR  T1.HUSBOGSTAADR   = :SØG_HUSBOGSTAV2)               
               AND  T1.ADRFRADTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY ADRFRADTO                                        
              FOR READ ONLY;                                            
                                                                        
         EXEC SQL DECLARE INDFLYT CURSOR FOR                            
              SELECT T1.ADRFRADTO                                       
              FROM BQ71000T T1                                          
              WHERE T1.PNR         = :SØG_DCPR                          
               AND  T1.BOPAEKMNR   = :SØG_EKOMNR                        
               AND  T1.VEJKOD      = :SØG_VEJK_EJD                      
               AND (T1.HUSNR         = :SØG_HUSNR_EJD1                  
                OR  T1.HUSNR         = :SØG_HUSNR_EJD2)                 
               AND (T1.HUSBOGSTAADR  = :SØG_HUSBOGSTAV1                 
                OR  T1.HUSBOGSTAADR  = :SØG_HUSBOGSTAV2)                
               AND (T1.ETAGENR     = :SØG_ETAGE1                        
                 OR T1.ETAGENR     = :SØG_ETAGE2                        
                 OR T1.ETAGENR     = :SØG_ETAGE3)                       
               AND  (T1.SIDEDOERNR = :SØG_SIDE_DØRNR1                   
                 OR  T1.SIDEDOERNR = :SØG_SIDE_DØRNR2                   
                 OR  T1.SIDEDOERNR = :SØG_SIDE_DØRNR3)                  
               AND  T1.ADRFRADTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY T1.ADRFRADTO                                     
              FOR READ ONLY;                                            
                                                                        
 /*********************************************************************/
                                                                        
         /*FIND PÅ BQ70000T KUN AKTUEL*/                                
         EXEC SQL DECLARE AKT_EJD_INDFLYT CURSOR FOR                    
              SELECT T1.ADRFRADTO                                       
              FROM BQ70000T T1                                          
              WHERE T1.PNR            =:SØG_DCPR                        
               AND  T1.BOPAEKMNR      =:SØG_EKOMNR                      
               AND  T1.VEJKOD         =:SØG_VEJK_EJD                    
               AND (T1.HUSNR          =:SØG_HUSNR_EJD1                  
                OR  T1.HUSNR          =:SØG_HUSNR_EJD2)                 
               AND (T1.HUSBOGSTAADR   =:SØG_HUSBOGSTAV1                 
                OR  T1.HUSBOGSTAADR   =:SØG_HUSBOGSTAV2)                
               AND  T1.ADRFRADTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY T1.ADRFRADTO                                     
              FOR READ ONLY;                                            
                                                                        
         EXEC SQL DECLARE AKT_INDFLYT CURSOR FOR                        
              SELECT T1.ADRFRADTO                                       
              FROM BQ70000T  T1                                         
              WHERE T1.PNR            = :SØG_DCPR                       
               AND  T1.BOPAEKMNR      = :SØG_EKOMNR                     
               AND  T1.VEJKOD         = :SØG_VEJK_EJD                   
               AND (T1.HUSNR       = :SØG_HUSNR_EJD1                    
                OR  T1.HUSNR       = :SØG_HUSNR_EJD2)                   
               AND (T1.HUSBOGSTAADR = :SØG_HUSBOGSTAV1                  
                OR  T1.HUSBOGSTAADR = :SØG_HUSBOGSTAV2)                 
               AND  (T1.ETAGENR       = :SØG_ETAGE1                     
                 OR  T1.ETAGENR       = :SØG_ETAGE2                     
                 OR  T1.ETAGENR       = :SØG_ETAGE3)                    
               AND  (T1.SIDEDOERNR    = :SØG_SIDE_DØRNR1                
                 OR  T1.SIDEDOERNR    = :SØG_SIDE_DØRNR2                
                 OR  T1.SIDEDOERNR    = :SØG_SIDE_DØRNR3)               
               AND  T1.ADRFRADTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY T1.ADRFRADTO                                     
              FOR READ ONLY;                                            
                                                                        
 /*********************************************************************/
                                                                        
         EXEC SQL DECLARE EJD_FRAFLYT CURSOR FOR                        
              SELECT T1.ADRTILDTO                                       
              FROM BQ71000T T1                                          
              WHERE T1.PNR          =:SØG_DCPR                          
               AND  T1.BOPAEKMNR    =:SØG_EKOMNR                        
               AND  T1.VEJKOD       =:SØG_VEJK_EJD                      
               AND (T1.HUSNR        =:SØG_HUSNR_EJD1                    
                OR  T1.HUSNR        =:SØG_HUSNR_EJD2)                   
               AND (T1.HUSBOGSTAADR =:SØG_HUSBOGSTAV1                   
                OR  T1.HUSBOGSTAADR =:SØG_HUSBOGSTAV2)                  
               AND  T1.ADRTILDTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY T1.ADRTILDTO DESC                                
              FOR READ ONLY;                                            
                                                                        
         EXEC SQL DECLARE FRAFLYT CURSOR FOR                            
              SELECT T1.ADRTILDTO                                       
              FROM BQ71000T T1                                          
              WHERE T1.PNR            = :SØG_DCPR                       
               AND  T1.BOPAEKMNR      = :SØG_EKOMNR                     
               AND  T1.VEJKOD         = :SØG_VEJK_EJD                   
               AND (T1.HUSNR       = :SØG_HUSNR_EJD1                    
                OR  T1.HUSNR       = :SØG_HUSNR_EJD2)                   
               AND (T1.HUSBOGSTAADR =:SØG_HUSBOGSTAV1                   
                OR  T1.HUSBOGSTAADR =:SØG_HUSBOGSTAV2)                  
               AND  (T1.ETAGENR       = :SØG_ETAGE1                     
                OR   T1.ETAGENR       = :SØG_ETAGE2                     
                OR   T1.ETAGENR       = :SØG_ETAGE3)                    
               AND  (T1.SIDEDOERNR    = :SØG_SIDE_DØRNR1                
                OR   T1.SIDEDOERNR    = :SØG_SIDE_DØRNR2                
                OR   T1.SIDEDOERNR    = :SØG_SIDE_DØRNR3)               
               AND  T1.ADRTILDTO BETWEEN :TMP_START AND :TMP_SLUT       
              ORDER BY T1.ADRTILDTO DESC                                
              FOR READ ONLY;                                            
                                                                        
 END DECLARE_CURSOR;                                                    
 /*********************************************************************/
 /*      BH94101M                                                     */
 /*      OPSÆTNING AF IND- OG UDFLYTNINGSDATO                         */
 /*********************************************************************/
 OPSÆT_IND_FRAFLYT: PROC;                                               
                                                                        
         INDFLYTDATO_SAT = '0'B;                                        
         FRAFLYTDATO_SAT = '0'B;                                        
                                                                        
         CALL UDFYLD_SØG;                                               
                                                                        
         PIC_ÅR    = BH65300M.GLSLUTÅR;                                 
         TMP_START = CHAR_ÅR !! '0101';                                 
         TMP_SLUT  = '99991231';                                        
                                                                        
                                                                        
     /*  PUT SKIP LIST('*** OPSÆT_IND_FRAFLYT :',BH946.SORT_CPR); */    
                                                                        
         /*NÅR DER SØGES STIGENE SKAL DER SØGES I HISTORIKER FØRST*/    
         /*SÅ DEN LAVEST/ÆLDSTE VÆRDI TAGES*/                           
         /*FRAFLYT ER STIGENE INDFLYT ER FALDENE */                     
         EXEC SQL OPEN INDFLYT;                                         
         IF SQLCODE ^= 0                                                
         THEN                                                           
           CALL SQL_FEJL;                                               
                                                                        
         EXEC SQL FETCH INDFLYT                                         
           INTO :DCLBQ71000T.ADRFRADTO;                                 
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
         WHEN (0)                                                       
           DO;                                                          
             CHAR_DATO = DCLBQ71000T.ADRFRADTO;                         
             IF CHAR_DATO ^= ' '                                        
             THEN                                                       
               DO;                                                      
                 INDFLYTDATO_SAT = '1'B;                                
                 BH946.AKT_EJER.DINDFLYT = PIC_DATO;                    
                 TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;                   
               END;                                                     
           END;                                                         
         WHEN (100);                                                    
         OTHERWISE                                                      
         PUT SKIP LIST                                                  
         ('*INDFLYT FEJL VED SØG I CSRP SQLKODE = ',SQLCA.SQLCODE);     
         END; /*SELECT*/                                                
         EXEC SQL CLOSE INDFLYT;                                        
         IF SQLCODE ^= 0                                                
         THEN                                                           
           CALL SQL_FEJL;                                               
                                                                        
         IF INDFLYTDATO_SAT = NEJ                                       
         THEN                                                           
           DO;                                                          
             EXEC SQL OPEN AKT_INDFLYT;   /* SØG I AKTUEL TABEL*/       
             IF SQLCODE ^= 0                                            
             THEN                                                       
                CALL SQL_FEJL;                                          
             EXEC SQL FETCH AKT_INDFLYT                                 
                INTO :DCLBQ70000T.ADRFRADTO;                            
             SELECT(SQLCODE);                                           
             WHEN(0)                                                    
                DO;                                                     
                  CHAR_DATO = DCLBQ70000T.ADRFRADTO;                    
                  IF CHAR_DATO ^= ' '                                   
                  THEN                                                  
                     DO;                                                
                       BH946.AKT_EJER.DINDFLYT = PIC_DATO;              
                       TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;             
                     END;                                               
                  INDFLYTDATO_SAT = '1'B;                               
                END;                                                    
             WHEN(100)                                                  
                DO;                                                     
              /*  CHAR_DATO = '99991231';                               
                  IF CHAR_DATO ^= ' '                                   
                  THEN                                                  
                    DO;                                                 
                      BH946.AKT_EJER.DINDFLYT = PIC_DATO;               
                      TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;              
                    END;                                                
                  INDFLYTDATO_SAT = '1'B; */                            
                END;                                                    
             OTHER;                                                     
             END; /*SELECT*/                                            
             EXEC SQL CLOSE AKT_INDFLYT;                                
             IF SQLCODE ^= 0                                            
             THEN                                                       
                CALL SQL_FEJL;                                          
                                                                        
           END;                                                         
                                                                        
     /*  IF INDFLYTDATO_SAT = NEJ                                       
         THEN                                                           
           PUT SKIP LIST('INDFLYTDATO MANGLER !!');  */                 
                                                                        
         /* FIND FRAFLYT */                                             
         EXEC SQL OPEN FRAFLYT;                                         
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
         EXEC SQL FETCH FRAFLYT                                         
            INTO :DCLBQ71000T.ADRTILDTO;                                
         SELECT (SQLCA.SQLCODE);                                        
            WHEN (0)                                                    
              DO;                                                       
                CHAR_DATO = DCLBQ71000T.ADRTILDTO;                      
                IF CHAR_DATO ^= ' '                                     
                THEN                                                    
                  DO;                                                   
                    BH946.AKT_EJER.DFRAFLYT = PIC_DATO;                 
                    TV.CPR_FRAFLYT = TV.CPR_FRAFLYT + 1;                
                  END;                                                  
                FRAFLYTDATO_SAT = '1'B;                                 
              END;                                                      
            WHEN (100)                                                  
               DO;                                                      
            /*   CHAR_DATO = '99991231';                                
                 IF CHAR_DATO ^= ' '                                    
                 THEN                                                   
                   DO;                                                  
                     BH946.AKT_EJER.DFRAFLYT = PIC_DATO;                
                     TV.CPR_FRAFLYT = TV.CPR_FRAFLYT + 1;               
                   END;                                                 
                 FRAFLYTDATO_SAT = '1'B; */                             
               END;                                                     
            OTHERWISE                                                   
              PUT SKIP LIST                                             
         ('**FRAFLYT FEJL VED SØG I CSRP SQLKODE = ',SQLCA.SQLCODE);    
         END; /*SELECT*/                                                
                                                                        
         EXEC SQL CLOSE FRAFLYT;                                        
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
     /*  IF FRAFLYTDATO_SAT = NEJ                                       
         THEN                                                           
           PUT SKIP LIST('FRAFLYTDATO MANGLER !!'); */                  
                                                                        
     /*  PUT SKIP LIST('BH946.AKT_EJER.DINDFLYT =',                     
                        BH946.AKT_EJER.DINDFLYT);                       
         PUT SKIP LIST('BH946.AKT_EJER.DFRAFLYT =',                     
                        BH946.AKT_EJER.DFRAFLYT);  */                   
                                                                        
         IF BH946.AKT_EJER.DINDFLYT = 0                                 
          & BH946.AKT_EJER.DFRAFLYT = 0                                 
         THEN                                                           
            CALL FIND_FØRSTE_TILFLYT;                                   
                                                                        
 END OPSÆT_IND_FRAFLYT;                                                 
 /*********************************************************************/
 /*      BH94101M                                                     */
 /*      OPSÆTNING AF IND- OG UDFLYTNINGSDATO I EJD. MED EJERBOLIG    */
 /*********************************************************************/
 OPSÆT_EJD_IND_FRAFLYT: PROC;                                           
                                                                        
     /*PUT SKIP LIST('*** OPSÆT_EJD_IND_FRAFLYT :',BH946.SORT_CPR);*/   
                                                                        
         INDFLYTDATO_SAT = '0'B;                                        
         FRAFLYTDATO_SAT = '0'B;                                        
                                                                        
         CALL UDFYLD_SØG;                                               
                                                                        
         PIC_ÅR    = BH65300M.GLSLUTÅR;                                 
         TMP_START = CHAR_ÅR !! '0101';                                 
         TMP_SLUT  = '99991231';                                        
                                                                        
         EXEC SQL OPEN EJD_INDFLYT;                                     
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
         EXEC SQL FETCH EJD_INDFLYT                                     
            INTO :DCLBQ71000T.ADRFRADTO;                                
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
            WHEN (0)                                                    
              DO;                                                       
                CHAR_DATO = DCLBQ71000T.ADRFRADTO;                      
                IF CHAR_DATO ^= ' '                                     
                THEN                                                    
                  DO;                                                   
                    INDFLYTDATO_SAT = '1'B;                             
                    BH946.AKT_EJER.DINDFLYT = PIC_DATO;                 
                    TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;                
                  END;                                                  
              END;                                                      
            WHEN (100);                                                 
           OTHERWISE                                                    
            PUT SKIP LIST                                               
             ('1 INDFLYT FEJL VED SØG I CSRP SQLKODE = ',SQLCA.SQLCODE);
         END;                                                           
         EXEC SQL CLOSE EJD_INDFLYT;                                    
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
         IF INDFLYTDATO_SAT = NEJ                                       
         THEN                                                           
           DO;                                                          
             EXEC SQL OPEN AKT_EJD_INDFLYT;                             
             IF SQLCODE ^= 0                                            
             THEN                                                       
                CALL SQL_FEJL;                                          
             EXEC SQL FETCH AKT_EJD_INDFLYT                             
                INTO :DCLBQ70000T.ADRFRADTO;                            
             SELECT(SQLCODE);                                           
             WHEN(0)                                                    
                DO;                                                     
                  CHAR_DATO = DCLBQ70000T.ADRFRADTO;                    
                  IF CHAR_DATO ^= ' '                                   
                  THEN                                                  
                     DO;                                                
                       BH946.AKT_EJER.DINDFLYT = PIC_DATO;              
                       TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;             
                     END;                                               
                  INDFLYTDATO_SAT = '1'B;                               
                END;                                                    
             WHEN(100)                                                  
                DO;                                                     
                END;                                                    
             OTHER;                                                     
             END; /*SELECT*/                                            
             EXEC SQL CLOSE AKT_EJD_INDFLYT;                            
             IF SQLCODE ^= 0                                            
             THEN                                                       
                CALL SQL_FEJL;                                          
                                                                        
             /*SLUT PÅ SØGNING I AKTUEL*/                               
           END;                                                         
                                                                        
                                                                        
         EXEC SQL OPEN EJD_FRAFLYT;                                     
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
         EXEC SQL FETCH EJD_FRAFLYT                                     
            INTO :DCLBQ71000T.ADRTILDTO;                                
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
            WHEN (0)                                                    
              DO;                                                       
                CHAR_DATO = DCLBQ71000T.ADRTILDTO;                      
                IF CHAR_DATO ^= ' '                                     
                THEN                                                    
                  DO;                                                   
                    BH946.AKT_EJER.DFRAFLYT = PIC_DATO;                 
                    TV.CPR_FRAFLYT = TV.CPR_FRAFLYT + 1;                
                  END;                                                  
                FRAFLYTDATO_SAT = '1'B;                                 
              END;                                                      
            WHEN (100)                                                  
              DO;                                                       
              /*CHAR_DATO = '99991231';*/                               
              /*IF CHAR_DATO ^= ' '                                     
                THEN                                                    
                  DO;                                                   
                    BH946.AKT_EJER.DFRAFLYT = PIC_DATO;                 
                    TV.CPR_FRAFLYT = TV.CPR_FRAFLYT + 1;                
                  END;                                                  
                FRAFLYTDATO_SAT = '1'B;*/                               
              END;                                                      
           OTHERWISE                                                    
            PUT SKIP LIST                                               
             ('FRAFLYT FEJL VED SØG I CSRP SQLKODE = ',SQLCA.SQLCODE);  
         END;                                                           
                                                                        
         EXEC SQL CLOSE EJD_FRAFLYT;                                    
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
         IF BH946.AKT_EJER.DINDFLYT = 0 &                               
            BH946.AKT_EJER.DFRAFLYT = 0                                 
         THEN                                                           
            CALL FIND_FØRSTE_EJD_TILFLYT;                               
                                                                        
 END OPSÆT_EJD_IND_FRAFLYT;                                             
 /*********************************************************************/
 /*      BH94301M                                  *SLUT05*           */
 /*      HER FINDES FØRSTE TILFLYTTEDATO  1/1-0001 - 31/12-9999       */
 /*********************************************************************/
 FIND_FØRSTE_TILFLYT: PROC;                                             
                                                                        
    /*   PUT SKIP LIST('FIND_FØRSTE_TILFLYT'); */                       
         TMP_START = '00010101';                                        
         TMP_SLUT  = '99991231';                                        
                                                                        
         CALL UDFYLD_SØG;                                               
                                                                        
         EXEC SQL OPEN AKT_INDFLYT;                                     
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
         EXEC SQL FETCH AKT_INDFLYT                                     
            INTO :DCLBQ70000T.ADRFRADTO;                                
                                                                        
     /*  PUT SKIP LIST('FIND_FØRSTE_TILFLYT SQLCODE =',SQLCODE); */     
                                                                        
         SELECT(SQLCODE);                                               
         WHEN(0)                                                        
            DO;                                                         
              CHAR_DATO = DCLBQ70000T.ADRFRADTO;                        
              IF CHAR_DATO ^= ' '                                       
              THEN                                                      
                 DO;                                                    
                   BH946.AKT_EJER.DINDFLYT = PIC_DATO;                  
                   TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;                 
                 END;                                                   
            END;                                                        
         WHEN(100)                                                      
            DO;                                                         
            END;                                                        
         OTHER;                                                         
         END; /*SELECT*/                                                
         EXEC SQL CLOSE AKT_INDFLYT;                                    
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
 END FIND_FØRSTE_TILFLYT;                                               
 /*********************************************************************/
 FIND_FØRSTE_EJD_TILFLYT: PROC;                                         
                                                                        
      /* PUT SKIP LIST('FIND_FØRSTE_EJD_TILFLYT'); */                   
         TMP_START = '00010101';                                        
         TMP_SLUT  = '99991231';                                        
                                                                        
         CALL UDFYLD_SØG;                                               
                                                                        
         EXEC SQL OPEN AKT_EJD_INDFLYT;                                 
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
         EXEC SQL FETCH AKT_EJD_INDFLYT                                 
            INTO :DCLBQ70000T.ADRFRADTO;                                
                                                                        
     /*  PUT SKIP LIST('FIND_FØRSTE_EJD_TILFLYT SQLCODE =',SQLCODE);*/  
                                                                        
         SELECT(SQLCODE);                                               
         WHEN(0)                                                        
            DO;                                                         
              CHAR_DATO = DCLBQ70000T.ADRFRADTO;                        
              IF CHAR_DATO ^= ' '                                       
              THEN                                                      
                 DO;                                                    
                   BH946.AKT_EJER.DINDFLYT = PIC_DATO;                  
                   TV.CPR_INDFLYT = TV.CPR_INDFLYT + 1;                 
                 END;                                                   
            END;                                                        
         WHEN(100)                                                      
            DO;                                                         
            END;                                                        
         OTHER;                                                         
         END; /*SELECT*/                                                
         EXEC SQL CLOSE AKT_EJD_INDFLYT;                                
         IF SQLCODE ^= 0                                                
         THEN                                                           
            CALL SQL_FEJL;                                              
                                                                        
                                                                        
 END FIND_FØRSTE_EJD_TILFLYT;                                           
