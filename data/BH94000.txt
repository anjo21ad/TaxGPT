 BH94000: PROC OPTIONS (MAIN) REORDER;                                  
 /**********************************************************************
 **                                                                   **
 ** PROJEKT:     EVS SLUT 2018.                                       **
 ** PROGRAMNAVN: BH94000.                                             **
 ** PROGRAMTYPE: BATCH.                                               **
 ** FUNKTION:    SLET EVS OPDATERINGER TIL SLUT 2018                  **
 ** PGMFORLØB:   1. DECLARE CURSOR                                    **
 **              2. ÅBEN CURSOR                                       **
 **              3. LÆS CURSOR                                        **
 **              4. SLET PÅ BQ41000T                                  **
 **              5. SLET PÅ BQ40000T                                  **
 **              6. SLET PÅ BQ31000T                                  **
 **              7. SLET PÅ BQ30000T                                  **
 **              8. OPDATERE DTILGLD PÅ BQ30000T                      **
 **                                                                   **
 ** KONSTRUKTØR: Esben Brodersen     EBD,                 13.05.2019. **
 **              Hyppigere commit    EBD                  11.06.2019  **
 **********************************************************************/
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT       CHAR  (30) INIT ('(C) KMD A/S 2019');          
 /**********************************************************************
 * DECLARE AF STRUKTURER                                               *
 **********************************************************************/
 DCL 1 DCLBQ30000T,                                                     
     5 DINDKAAR BIN FIXED(15),                                          
     5 EKOMNR   BIN FIXED(15),                                          
     5 EEJDNR   BIN FIXED(31),                                          
     5 EENHEDLBNR  BIN FIXED(15),                                       
     5 DCPRN    DEC FIXED(11,0),                                        
     5 ELBNR    BIN FIXED(15),                                          
     5 EGENNR   BIN FIXED(15);                                          
                                                                        
 /*DCL 1 DCLBQ31000T,                                                   
     5 DINDKAAR BIN FIXED(15),                                          
     5 EKOMNR   BIN FIXED(15),                                          
     5 EEJDNR   BIN FIXED(31),                                          
     5 EENHEDLBNR  BIN FIXED(15),                                       
     5 DCPRN    DEC FIXED(11,0),                                        
     5 ELBNR    BIN FIXED(15),                                          
     5 EGENNR   BIN FIXED(15),                                          
     5 FELTKODE BIN FIXED(15),                                          
     5 FELTKODETYPE  BIN FIXED(15);                                     
                                                                        
 DCL 1 DCLBQ40000T,                                                     
     5 DINDKAAR BIN FIXED(15),                                          
     5 EKOMNR   BIN FIXED(15),                                          
     5 EEJDNR   BIN FIXED(31),                                          
     5 EENHEDLBNR  BIN FIXED(15),                                       
     5 DCPRN    DEC FIXED(11,0),                                        
     5 ELBNR    BIN FIXED(15),                                          
     5 EGENNR   BIN FIXED(15);                                          
                                                                        
 DCL 1 DCLBQ41000T,                                                     
     5 DINDKAAR BIN FIXED(15),                                          
     5 EKOMNR   BIN FIXED(15),                                          
     5 EEJDNR   BIN FIXED(31),                                          
     5 EENHEDLBNR  BIN FIXED(15),                                       
     5 DCPRN    DEC FIXED(11,0),                                        
     5 ELBNR    BIN FIXED(15),                                          
     5 EGENNR   BIN FIXED(15),                                          
     5 FELTKODE BIN FIXED(15); */                                       
                                                                        
                                                                        
 /**********************************************************************
 * DECLARE AF DB2 TABELLER                                             *
 **********************************************************************/
                                                                        
         EXEC SQL INCLUDE SQLCA;        /* SQL KOMMUNIKATIONSAREAL    */
         EXEC SQL INCLUDE BQ30000T;     /* EVS PERSONTABEL            */
         EXEC SQL INCLUDE BQ31000T;     /* EVS PERSONTFELTTABEL       */
         EXEC SQL INCLUDE BQ40000T;     /* EVS RESULTATTABEL          */
         EXEC SQL INCLUDE BQ41000T;     /* EVS RESULTATFELTTABEL      */
                                                                        
 /**********************************************************************
 * DECLARE AF BUILTIN                                                  *
 **********************************************************************/
                                                                        
 DCL     (ADDR, PLIDUMP, DATE, NULL,TRANSLATE,SUBSTR) BUILTIN;          
 /**********************************************************************
 * DECLARE AF DIVERSE FELTER                                           *
 **********************************************************************/
                                                                        
 DCL     UDSKRDT         CHAR      (10);                                
                                                                        
 DCL     EJER_FUNDET          BIT (1);                                  
 DCL     ANTAL_COMMIT         BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_FETCH_SLET     BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_SLET_BQ41000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_SLET_BQ40000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_SLET_BQ31000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_SLET_BQ30000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_FETCH_OPDAT    BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_OPDAT_BQ30000T BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_FELT_BQ31000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_FELT_BQ41000T  BIN FIXED(31) INIT(0);                    
 DCL     ANTAL_PUT            BIN FIXED(31) INIT(0);                    
                                                                        
                                                                        
 DCL     DATO            CHAR      (6);                                 
 DCL     PDATO           PIC       '999999' BASED(ADDR(DATO));          
                                                                        
 DCL     1 DT DEF DATO,                                                 
           2 AA          CHAR      (2),                                 
           2 MM          CHAR      (2),                                 
           2 DD          CHAR      (2);                                 
                                                                        
 DCL     LINIE           CHAR      (133);                               
 DCL     1 LIN           DEF LINIE,                                     
           2 CC1         CHAR           (1),                            
           2 TEKST       CHAR           (132);                          
                                                                        
         % INCLUDE ZZ20301M;                                            
                                                                        
 DCL     1 ABENDMEDD,                                                   
           2 ABENDMODUL CHAR      (7),                                  
           2 ABENDFILL1 CHAR      (1),                                  
           2 ABENDMEDNR CHAR      (2),                                  
           2 ABENDFILL2 CHAR      (1),                                  
           2 ABENDTXT   CHAR      (45);                                 
                                                                        
 DCL     ABENDRTKODE    FIXED     (2);                                  
 DCL     SQLCODE_CH     CHAR      (5);                                  
 DCL     SQLCODE_PIC    PIC       'SSSS9' DEF SQLCODE_CH;               
                                                                        
 /*********************************************************************/
 /*         EXTERNAL ENTRIES                                          */
 /*********************************************************************/
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
                                                                        
 DCL     MEDDEL         CHAR (56);                                      
 DCL     ABEND_STR               CHAR (56) BASED(ADDR(ABEND_STRUK));    
 DCL     1 ABEND_STRUK,                                                 
          2 MODULNAVN            CHAR (07) INIT ('BH94000'),            
          2 HFILL1               CHAR (01) INIT (' '),                  
          2 MEDDELNR             CHAR (02) INIT ('**'),                 
          2 HFILL2               CHAR (01) INIT (' '),                  
          2 MEDDELTXT            CHAR (45) INIT ('');                   
                                                                        
 /**********************************************************************
 * ON CONDITIONS                                                       *
 **********************************************************************/
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
               ON ERROR SYSTEM;                                         
               CALL PLIDUMP  ('SNHOB','MODUL BH94000');                 
            END;                                                        
                                                                        
 /**********************************************************************
 * HOUSE-KEEPING                                                       *
 **********************************************************************/
         CALL ZS61900;                           /* SSI */              
         CALL ZZ20390 ('*OPEN','BH94001Y','RECF','FBA');                
         /**********************************/                           
         /* OPSÆT DAGS DATO                */                           
         /**********************************/                           
         DATO = DATE;                                                   
         UDSKRDT = DT.DD !! '/' !! DT.MM !! '-' !! DT.AA;               
                                                                        
 /**********************************************************************
 * PROCES                                                              *
 **********************************************************************/
                                                                        
         CALL OPEN_SLET_CUR;                                            
         CALL FETCH_SLET_CUR;                                           
                                                                        
         DO WHILE (EJER_FUNDET);                                        
                                                                        
           CALL SLET_BQ41000T;                                          
           IF SQLCA.SQLCODE = 0 ! SQLCA.SQLCODE = 100                   
           THEN                                                         
             DO;                                                        
               CALL SLET_BQ40000T;                                      
               IF SQLCA.SQLCODE = 0 ! SQLCA.SQLCODE = 100               
               THEN                                                     
                 DO;                                                    
                   CALL SLET_BQ31000T;                                  
                   IF SQLCA.SQLCODE = 0 ! SQLCA.SQLCODE = 100           
                   THEN                                                 
                     DO;                                                
                       CALL SLET_BQ30000T;                              
                     END;                                               
                 END;                                                   
             END;                                                       
                                                                        
           ANTAL_COMMIT = ANTAL_COMMIT + 1;                             
                                                                        
           IF ANTAL_COMMIT > 2000                                       
           THEN                                                         
             DO;                                                        
               EXEC SQL COMMIT;                                         
               ANTAL_COMMIT = 0;                                        
                                                                        
               IF ANTAL_PUT < 500000                                    
               THEN                                                     
                 DO;                                                    
                   PUT SKIP LIST('COMMIT EFTER ANTAL_FETCH_SLET ',      
                                 ANTAL_FETCH_SLET);                     
                                                                        
                   ANTAL_PUT = ANTAL_PUT + 1;                           
                 END;                                                   
             END;                                                       
                                                                        
                                                                        
           CALL FETCH_SLET_CUR;                                         
                                                                        
         END;                                                           
                                                                        
         CALL CLOSE_SLET_CUR;                                           
                                                                        
         IF ANTAL_COMMIT > 0                                            
         THEN                                                           
           DO;                                                          
               EXEC SQL COMMIT;                                         
               PUT SKIP LIST('COMMIT EFTER ANTAL_FETCH_SLET',           
                              ANTAL_FETCH_SLET);                        
               ANTAL_COMMIT = 0;                                        
           END;                                                         
                                                                        
         /* FIND RÆKKER SOM SKAL OPDATERES*/                            
                                                                        
         CALL OPEN_OPDAT_CUR;                                           
         CALL FETCH_OPDAT_CUR;                                          
                                                                        
         DO WHILE (EJER_FUNDET);                                        
                                                                        
           CALL OPDAT_BQ30000T;                                         
                                                                        
           ANTAL_COMMIT = ANTAL_COMMIT + 1;                             
                                                                        
           IF ANTAL_COMMIT > 5000                                       
           THEN                                                         
             DO;                                                        
               EXEC SQL COMMIT;                                         
               ANTAL_COMMIT = 0;                                        
                                                                        
               IF ANTAL_PUT < 500000                                    
               THEN                                                     
                 DO;                                                    
                    PUT SKIP LIST('COMMIT EFTER ANTAL_FETCH_OPDAT ',    
                                  ANTAL_FETCH_OPDAT);                   
                 END;                                                   
             END;                                                       
                                                                        
           CALL FETCH_OPDAT_CUR;                                        
                                                                        
         END;                                                           
                                                                        
         CALL CLOSE_OPDAT_CUR;                                          
                                                                        
         IF ANTAL_COMMIT > 0                                            
         THEN                                                           
           DO;                                                          
               EXEC SQL COMMIT;                                         
               PUT SKIP LIST('COMMIT EFTER ANTAL_FETCH_OPDAT',          
                              ANTAL_FETCH_OPDAT);                       
               ANTAL_COMMIT = 0;                                        
           END;                                                         
                                                                        
         CALL UDSKRIV_KONTROLLISTE;                                     
                                                                        
 /*********************************************************************/
 /*      DECLARE CURSOR TIL UDTRÆK                                    */
 /*********************************************************************/
 DECLARE_SLET_CUR: PROC;                                                
                                                                        
        EXEC SQL DECLARE SLET_CUR CURSOR WITH HOLD FOR                  
                                                                        
        SELECT DINDKAAR,                                                
               EKOMNR,                                                  
               EEJDNR,                                                  
               EENHEDLBNR,                                              
               DCPRN,                                                   
               ELBNR,                                                   
               EGENNR                                                   
                                                                        
        FROM BQ30000T                                                   
        WHERE  DINDKAAR  = 2018                                         
          AND  CAJOUR = '4'                                             
          AND  CSUPPL = '4'                                             
        ORDER BY DINDKAAR, EKOMNR, EEJDNR, EENHEDLBNR,                  
                 DCPRN, ELBNR, EGENNR;                                  
                                                                        
 END DECLARE_SLET_CUR;                                                  
 /*********************************************************************/
 /*      ÅBEN CURSOR TIL UDTRÆK                                       */
 /*********************************************************************/
 OPEN_SLET_CUR: PROC;                                                   
                                                                        
        EXEC SQL OPEN SLET_CUR;                                         
                                                                        
        IF SQLCODE ^= 0                                                 
        THEN                                                            
           DO;                                                          
             SQLCODE_PIC = SQLCODE;                                     
             ABENDTXT   =  '261 OPEN SLET_CUR ,SQLCODE= '               
                           !! SQLCODE_CH;                               
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END OPEN_SLET_CUR;                                                     
 /*********************************************************************/
 /*      LÆS EJER FORHOLD SOM SKAL SLETTES                            */
 /*********************************************************************/
 FETCH_SLET_CUR: PROC;                                                  
                                                                        
        DCLBQ30000T = '';                                               
                                                                        
        EXEC SQL                                                        
             FETCH SLET_CUR                                             
                                                                        
             INTO  :DCLBQ30000T.DINDKAAR,                               
                   :DCLBQ30000T.EKOMNR,                                 
                   :DCLBQ30000T.EEJDNR,                                 
                   :DCLBQ30000T.EENHEDLBNR,                             
                   :DCLBQ30000T.DCPRN,                                  
                   :DCLBQ30000T.ELBNR,                                  
                   :DCLBQ30000T.EGENNR;                                 
                                                                        
        SELECT(SQLCODE);                                                
          WHEN(0)                                                       
            DO;                                                         
              EJER_FUNDET = '1'B;                                       
              ANTAL_FETCH_SLET    = ANTAL_FETCH_SLET + 1;               
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
              EJER_FUNDET = '0'B;                                       
            END;                                                        
          OTHER                                                         
            DO;                                                         
              SQLCODE_PIC = SQLCODE;                                    
              ABENDTXT   =  '262 FETCH UDTRAEK_CURSOR,SQLCODE= '        
                            !! SQLCODE_CH;                              
              CALL SQL_FEJL;                                            
            END;                                                        
        END; /*SELECT*/                                                 
                                                                        
 END FETCH_SLET_CUR;                                                    
 /*********************************************************************/
 /*       LUK CURSOR TIL UDTRÆK                                       */
 /*********************************************************************/
 CLOSE_SLET_CUR: PROC;                                                  
                                                                        
        EXEC SQL CLOSE SLET_CUR;                                        
                                                                        
        IF SQLCODE ^= 0                                                 
        THEN                                                            
           DO;                                                          
             SQLCODE_PIC = SQLCODE;                                     
             ABENDTXT   =  '263 CLOSE SLET_CUR,SQLCODE= '               
                           !! SQLCODE_CH;                               
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END CLOSE_SLET_CUR;                                                    
 /*********************************************************************/
 /* SLET FELTER FOR EJERFORHOLD PÅ BQ41000T                           */
 /*********************************************************************/
 SLET_BQ41000T: PROC;                                                   
                                                                        
    EXEC SQL                                                            
       DELETE FROM BQ41000T                                             
                                                                        
    WHERE DINDKAAR    = :DCLBQ30000T.DINDKAAR                           
      AND EKOMNR      = :DCLBQ30000T.EKOMNR                             
      AND EEJDNR      = :DCLBQ30000T.EEJDNR                             
      AND EENHEDLBNR  = :DCLBQ30000T.EENHEDLBNR                         
      AND DCPRN       = :DCLBQ30000T.DCPRN                              
      AND ELBNR       = :DCLBQ30000T.ELBNR                              
      AND EGENNR      = :DCLBQ30000T.EGENNR;                            
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
          WHEN(0)                                                       
            DO;                                                         
              ANTAL_SLET_BQ41000T = ANTAL_SLET_BQ41000T + 1;            
              ANTAL_FELT_BQ41000T =                                     
                      ANTAL_FELT_BQ41000T + SQLCA.SQLERRD(3);           
              ANTAL_COMMIT = ANTAL_COMMIT + 1;                          
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
            END;                                                        
          OTHER                                                         
            DO;                                                         
              SQLCODE_PIC = SQLCODE;                                    
              ABENDTXT   =  '262 DELETE BQ41000T, SQLCODE= '            
                              !! SQLCODE_CH;                            
              CALL SQL_FEJL;                                            
            END;                                                        
    END; /*SELECT*/                                                     
                                                                        
                                                                        
                                                                        
 END SLET_BQ41000T;                                                     
 /*********************************************************************/
 /* SLET EJERFORHOLD PÅ BQ40000T                                      */
 /*********************************************************************/
 SLET_BQ40000T: PROC;                                                   
                                                                        
    EXEC SQL                                                            
       DELETE FROM BQ40000T                                             
                                                                        
    WHERE DINDKAAR    = :DCLBQ30000T.DINDKAAR                           
      AND EKOMNR      = :DCLBQ30000T.EKOMNR                             
      AND EEJDNR      = :DCLBQ30000T.EEJDNR                             
      AND EENHEDLBNR  = :DCLBQ30000T.EENHEDLBNR                         
      AND DCPRN       = :DCLBQ30000T.DCPRN                              
      AND ELBNR       = :DCLBQ30000T.ELBNR                              
      AND EGENNR      = :DCLBQ30000T.EGENNR;                            
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
          WHEN(0)                                                       
            DO;                                                         
              ANTAL_SLET_BQ40000T = ANTAL_SLET_BQ40000T + 1;            
              ANTAL_COMMIT = ANTAL_COMMIT + 1;                          
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
            END;                                                        
          OTHER                                                         
            DO;                                                         
               SQLCODE_PIC = SQLCODE;                                   
                ABENDTXT   =  '262 DELETE BQ40000T, SQLCODE= '          
                              !! SQLCODE_CH;                            
                CALL SQL_FEJL;                                          
            END;                                                        
    END; /*SELECT*/                                                     
                                                                        
 END SLET_BQ40000T;                                                     
 /*********************************************************************/
 /* SLET FELTER FOR EJERFORHOLD PÅ BQ41000T                           */
 /*********************************************************************/
 SLET_BQ31000T: PROC;                                                   
                                                                        
    EXEC SQL                                                            
       DELETE FROM BQ31000T                                             
                                                                        
    WHERE DINDKAAR    = :DCLBQ30000T.DINDKAAR                           
      AND EKOMNR      = :DCLBQ30000T.EKOMNR                             
      AND EEJDNR      = :DCLBQ30000T.EEJDNR                             
      AND EENHEDLBNR  = :DCLBQ30000T.EENHEDLBNR                         
      AND DCPRN       = :DCLBQ30000T.DCPRN                              
      AND ELBNR       = :DCLBQ30000T.ELBNR                              
      AND EGENNR      = :DCLBQ30000T.EGENNR;                            
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
          WHEN(0)                                                       
            DO;                                                         
              ANTAL_SLET_BQ31000T = ANTAL_SLET_BQ31000T + 1;            
              ANTAL_FELT_BQ31000T =                                     
                      ANTAL_FELT_BQ31000T + SQLCA.SQLERRD(3);           
              ANTAL_COMMIT = ANTAL_COMMIT + 1;                          
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
            END;                                                        
          OTHER                                                         
            DO;                                                         
               SQLCODE_PIC = SQLCODE;                                   
               ABENDTXT   =  '262 DELETE BQ31000T, SQLCODE= '           
                              !! SQLCODE_CH;                            
               CALL SQL_FEJL;                                           
            END;                                                        
    END; /*SELECT*/                                                     
                                                                        
 END SLET_BQ31000T;                                                     
 /*********************************************************************/
 /* SLET EJERFORHOLD PÅ BQ30000T                                      */
 /*********************************************************************/
 SLET_BQ30000T: PROC;                                                   
                                                                        
    EXEC SQL                                                            
       DELETE FROM BQ30000T                                             
                                                                        
    WHERE DINDKAAR    = :DCLBQ30000T.DINDKAAR                           
      AND EKOMNR      = :DCLBQ30000T.EKOMNR                             
      AND EEJDNR      = :DCLBQ30000T.EEJDNR                             
      AND EENHEDLBNR  = :DCLBQ30000T.EENHEDLBNR                         
      AND DCPRN       = :DCLBQ30000T.DCPRN                              
      AND ELBNR       = :DCLBQ30000T.ELBNR                              
      AND EGENNR      = :DCLBQ30000T.EGENNR;                            
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
          WHEN(0)                                                       
            DO;                                                         
              ANTAL_SLET_BQ30000T = ANTAL_SLET_BQ30000T + 1;            
              ANTAL_COMMIT = ANTAL_COMMIT + 1;                          
            END;                                                        
          OTHER                                                         
            DO;                                                         
              SQLCODE_PIC = SQLCODE;                                    
              ABENDTXT   =  '262 DELETE BQ30000T, SQLCODE= '            
                              !! SQLCODE_CH;                            
              CALL SQL_FEJL;                                            
            END;                                                        
    END; /*SELECT*/                                                     
                                                                        
 END SLET_BQ30000T;                                                     
 /*********************************************************************/
 /*      DECLARE CURSOR TIL OPDATERING AF DTILGLD                     */
 /*********************************************************************/
 DECLARE_OPDAT_CUR: PROC;                                               
                                                                        
        EXEC SQL DECLARE OPDAT_CUR CURSOR WITH HOLD FOR                 
                                                                        
        SELECT T1.DINDKAAR,                                             
               T1.EKOMNR,                                               
               T1.EEJDNR,                                               
               T1.EENHEDLBNR,                                           
               T1.DCPRN,                                                
               T1.ELBNR,                                                
               T1.EGENNR                                                
        FROM BQ30000T T1                                                
        WHERE T1.DINDKAAR    = 2018                                     
          AND T1.EGENNR =                                               
               (SELECT MAX(EGENNR) FROM BQ30000T T2                     
                WHERE T1.DINDKAAR    = T2.DINDKAAR                      
                  AND T1.EKOMNR      = T2.EKOMNR                        
                  AND T1.EEJDNR      = T2.EEJDNR                        
                  AND T1.EENHEDLBNR  = T2.EENHEDLBNR                    
                  AND T1.DCPRN       = T2.DCPRN                         
                  AND T1.ELBNR       = T2.ELBNR)                        
          AND  T1.DTILGLD < '9999-12-31-23.59.59.999999'                
          ORDER BY T1.DINDKAAR, T1.EKOMNR, T1.EEJDNR, T1.EENHEDLBNR,    
                   T1.DCPRN, T1.ELBNR, T1.EGENNR;                       
                                                                        
 END DECLARE_OPDAT_CUR;                                                 
 /*********************************************************************/
 OPEN_OPDAT_CUR: PROC;                                                  
                                                                        
        EXEC SQL OPEN OPDAT_CUR;                                        
                                                                        
        IF SQLCODE ^= 0                                                 
        THEN                                                            
           DO;                                                          
             SQLCODE_PIC = SQLCODE;                                     
             ABENDTXT   =  '261 OPEN OPDAT_CUR ,SQLCODE= '              
                           !! SQLCODE_CH;                               
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END OPEN_OPDAT_CUR;                                                    
 /*********************************************************************/
 FETCH_OPDAT_CUR: PROC;                                                 
                                                                        
        DCLBQ30000T = '';                                               
                                                                        
        EXEC SQL                                                        
             FETCH OPDAT_CUR                                            
                                                                        
             INTO  :DCLBQ30000T.DINDKAAR,                               
                   :DCLBQ30000T.EKOMNR,                                 
                   :DCLBQ30000T.EEJDNR,                                 
                   :DCLBQ30000T.EENHEDLBNR,                             
                   :DCLBQ30000T.DCPRN,                                  
                   :DCLBQ30000T.ELBNR,                                  
                   :DCLBQ30000T.EGENNR;                                 
                                                                        
        SELECT(SQLCODE);                                                
          WHEN(0)                                                       
            DO;                                                         
              EJER_FUNDET = '1'B;                                       
              ANTAL_FETCH_OPDAT  = ANTAL_FETCH_OPDAT + 1;               
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
              EJER_FUNDET = '0'B;                                       
            END;                                                        
          OTHER                                                         
            DO;                                                         
              SQLCODE_PIC = SQLCODE;                                    
              ABENDTXT   =  '262 FETCH UDTRAEK_CURSOR,SQLCODE= '        
                              !! SQLCODE_CH;                            
              CALL SQL_FEJL;                                            
            END;                                                        
        END; /*SELECT*/                                                 
                                                                        
 END FETCH_OPDAT_CUR;                                                   
 /*********************************************************************/
 /*       LUK CURSOR TIL UDTRÆK                                       */
 /*********************************************************************/
 CLOSE_OPDAT_CUR: PROC;                                                 
                                                                        
        EXEC SQL CLOSE OPDAT_CUR;                                       
                                                                        
        IF SQLCODE ^= 0                                                 
        THEN                                                            
           DO;                                                          
             SQLCODE_PIC = SQLCODE;                                     
             ABENDTXT   =  '263 CLOSE OPDAT_CUR,SQLCODE= '              
                           !! SQLCODE_CH;                               
             CALL SQL_FEJL;                                             
           END;                                                         
                                                                        
 END CLOSE_OPDAT_CUR;                                                   
 /*********************************************************************/
 OPDAT_BQ30000T: PROC;                                                  
                                                                        
    EXEC SQL                                                            
      UPDATE BQ30000T T1                                                
          SET T1.DTILGLD   = '9999-12-31-23.59.59.999999'               
      WHERE T1.DINDKAAR    = :DCLBQ30000T.DINDKAAR                      
        AND T1.EKOMNR      = :DCLBQ30000T.EKOMNR                        
        AND T1.EEJDNR      = :DCLBQ30000T.EEJDNR                        
        AND T1.EENHEDLBNR  = :DCLBQ30000T.EENHEDLBNR                    
        AND T1.DCPRN       = :DCLBQ30000T.DCPRN                         
        AND T1.ELBNR       = :DCLBQ30000T.ELBNR                         
        AND T1.EGENNR      = :DCLBQ30000T.EGENNR;                       
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
          WHEN(0)                                                       
            DO;                                                         
              ANTAL_OPDAT_BQ30000T = ANTAL_OPDAT_BQ30000T + 1;          
            END;                                                        
          WHEN(100)                                                     
            DO;                                                         
            END;                                                        
          OTHER                                                         
            DO;                                                         
               SQLCODE_PIC = SQLCODE;                                   
                ABENDTXT   =  '262 OPDATE BQ30000T, SQLCODE= '          
                              !! SQLCODE_CH;                            
                CALL SQL_FEJL;                                          
            END;                                                        
    END; /*SELECT*/                                                     
                                                                        
 END OPDAT_BQ30000T;                                                    
 /*********************************************************************/
 /*      UDSKRIV KONTROLLISTE                                         */
 /*********************************************************************/
 UDSKRIV_KONTROLLISTE: PROC;                                            
                                                                        
         LINIE      = ASAK1 !! ' ';                                     
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' BH94000L            ' !!                         
                      'LISTE OVER OPTÆLLINGSTOTALER   ' !!              
                      'UDSKREVET DEN ' !! UDSKRDT;                      
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FUNDET TIL SLETNING ';                     
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FETCH -  BQ30000T:.....: ' !!              
                     ANTAL_FETCH_SLET;                                  
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL SLET -  BQ41000T.......: ' !!              
                     ANTAL_SLET_BQ41000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FELTER -  BQ41000T.....: ' !!              
                     ANTAL_FELT_BQ41000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL SLET -  BQ40000T.......: ' !!              
                     ANTAL_SLET_BQ40000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL SLET -  BQ31000T.......: ' !!              
                     ANTAL_SLET_BQ31000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FELTER -  BQ31000T.....: ' !!              
                     ANTAL_FELT_BQ31000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL SLET -  BQ30000T.......: ' !!              
                     ANTAL_SLET_BQ30000T;                               
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FUNDET TIL OPDATERING ';                   
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL FETCH -  BQ30000T......: ' !!              
                     ANTAL_FETCH_OPDAT;                                 
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE     = '';                                                
         LIN.CC1   = ASAS2;                                             
         LIN.TEKST = ' ANTAL OPDATERET -  BQ30000T..: ' !!              
                     ANTAL_OPDAT_BQ30000T;                              
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         CALL ZZ20300(LINIE,'99');                                      
                                                                        
 END UDSKRIV_KONTROLLISTE;                                              
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
        CALL ZS67000(SQLCA);                                            
        ABENDFILL1  = ' ';                                              
        ABENDFILL2  = ' ';                                              
        ABENDMODUL   = 'BH94000';                                       
        ABENDMEDNR   = '**';                                            
        CALL ZS30101(5,ABENDMEDD,2);                                    
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 END BH94000;                                                           
