  PROCESS OPT(TIME);                                                    
 BH95006: /* BEREGN EJENDOMSVÆRDISKAT FOR ÅR 2013 TIL BOY 2014        */
 PROCEDURE (BH950_AR);                                                  
 /*********************************************************************/
                                                                        
 DCL COPYRIGHT CHAR (30) STATIC INIT ('COPYRIGHT KOMMUNEDATA I/S 2013');
                                                                        
 /**********************************************************************
 * PROGRAMMET UDFØRER BEREGNING AF EJENDOMSVÆRDISKAT P.G.A. OPLYS-     *
 * NINGERNE VEDR. DEN AKTUELLE EJENDOM/PERSON.                         *
 *                                                                     *
 * NB.: PROGRAMMET BRUGES I.F.M. EVS-BEREGNING TIL FORSKUD VED         *
 *      BEREGNING AF 'ENDELIGT' EVS-SLUT-2009 TIL BOY 2010             *
 *                                                                     *
 *  PROGRAMMERET AF AAGE RASMUSSEN   PUS T&S    AUG    2000            *
 *  ÅRSRULLET    AF AAGE RASMUSSEN   LSU T&S    AUG    2001            *
 *  ÅRSRULLET    AF AAGE RASMUSSEN   LSU T&S    AUG    2002            *
 *  ÅRSRULLET    AF AAGE RASMUSSEN   LSU T&S    AUG    2003            *
 *  ÅRSRULLET    AF BO SCHMIDT       LSU T&S    AUG    2004            *
 *  ÅRSRULLET    AF SUSANNE VILLUMSEN           JUL    2005            *
 *  ÅRSRULLET    AF BO SCHMIDT                  JUL    2006            *
 *  ÅRSRULLET    AF BO SCHMIDT                  JUL    2007            *
 *  ÅRSRULLET    AF BO SCHMIDT                  JUL    2008            *
 *  ÅRSRULLET    AF GERD HOLM-PEDERSEN          APR    2009  *RUL*     *
 *  ÅRSRULLET    AF GERD HOLM-PEDERSEN          JUN    2010  *RUL*     *
 *  ÅRSRULLET    AF GERD HOLM-PEDERSEN          MAJ    2011  *RUL*     *
 *  ÅRSRULLET    AF ESBEN BRODERSEN             JUNI   2012  *RUL*     *
 *  ÅRSRULLET    AF ESBEN BRODERSEN             MAJ    2013  *RUL*     *
 *  ÅRSRULLET    AF JØRGEN SAUGMANN             JUN    2014  *RUL*     *
 *  ÅRSRULLET    AF JØRGEN SAUGMANN             JUN    2015  *RUL*     *
 *                  ESBEN BRODERSEN             MAR    2016            *
 *                  BH65300M DATO MACRO LAGT IND             #01       *
 *  Kompileret til Forskud 2017 Esben Brodersen  JUN  2016             *
 *  Kompileret til Forskud 2018 Esben Brodersen  JUN  2017             *
 **********************************************************************/
          DEFAULT RANGE (*) STATIC;                                     
                                                                        
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
 /*********************************************************************/
 /*      DECLARE AF DIVERSE PARAMETRE TIL DETTE MODUL                 */
 /*********************************************************************/
                                                                        
 DCL     1 BH950_AR,                                                    
           %INCLUDE BH95006N;                                           
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;        /*#01*/                            
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
                                                                        
 DCL     MULTIPLY        BUILTIN;                                       
 /********************************************************************* 
 *       DECLARE AF DIV. HJÆLPEFELTER                                 * 
 *********************************************************************/ 
                                                                        
 DCL     I               BIN FIXED (15);                                
                                                                        
 DCL     HJVÆRDI1        FIXED     (13,3);                              
 DCL     HJVÆRDI2        FIXED     (13,3);                              
 DCL     HJPCT           FIXED     (5,4);                               
                                                                        
 /*********************************************************************/
 /*      PROCESS                                                      */
 /*********************************************************************/
                                                                        
         /* INITIER DIVERSE FELTER INDEN BEREGNING */                   
                                                                        
         DO I = 1 TO 7;                                                 
            BH950_AR.FEJLTAB(I) = 0;                                    
         END;                                                           
                                                                        
         BH950_AR.BGRPROM1 = 0;                                         
         BH950_AR.BGRPROM2 = 0;                                         
         BH950_AR.BSTITIL = 0;                                          
         BH950_AR.CSTIBLB = '0';                                        
         BH950_AR.BPROM1 = 0;                                           
         BH950_AR.BPROM2 = 0;                                           
         BH950_AR.BNEDSL1 = 0;                                          
         BH950_AR.BNEDSL2 = 0;                                          
         BH950_AR.BPENSNED = 0;                                         
         BH950_AR.BSUM1 = 0;                                            
         BH950_AR.BSUM2 = 0;                                            
         BH950_AR.BSTIBGR = 0;                                          
         BH950_AR.BNETTO = 0;                                           
         BH950_AR.BPENSRED = 0;                                         
         BH950_AR.BBRUTTO = 0;                                          
         BH950_AR.B100  = 0;                                            
         BH950_AR.BEJERAN = 0;                                          
                                                                        
         /* KONTROLLER DIVERSE FELTER INDEN BEREGNING */                
                                                                        
         CALL UDFØR_KONTROLLER;                                         
                                                                        
 /*********************************************************************/
 /* RETURKODE SÆTTES LIG 0 HVIS INGEN FEJL FOREKOMMER (BEREGNING OK)  */
 /* RETURKODE SÆTTES LIG FEJLNR FOR FØRSTE FEJLTAB(I) > 0             */
 /*********************************************************************/
                                                                        
         BH950_AR.RETURKODE = 0; /* BEREGNING OK */                     
                                                                        
         DO I = 1 TO 7;                                                 
            IF BH950_AR.FEJLTAB(I) > 0                                  
            THEN                                                        
               DO;                                                      
                  /* DATA TIL BEREGNING ER IKKE OK   */                 
                  /* SÆT RETURKODE LIG FØRSTE FEJL */                   
                  BH950_AR.RETURKODE = BH950_AR.FEJLTAB(I);             
                  I = 7;                                                
               END;                                                     
         END;                                                           
                                                                        
         IF BH950_AR.RETURKODE = 0                                      
         THEN                                                           
            CALL BEREGN_EVS;                                            
                                                                        
 /*********************************************************************/
 /* FØLGENDE KONTROLLER UDFØRES VED HVERT KALD AF PROGRAMMET          */
 /* FOR AT SIKRE KORREKT BEREGNING AF EJENDOMSVÆRDISKATTEN            */
 /*                                                                   */
 /*TAB FEJL FEJL                                                      */
 /* NR   NR TEKST                                                     */
 /* ----------------------------------------------------------------- */
 /*  1 5032 KODE FOR EJENDOMSTYPE FORKERT                             */
 /*  2 5033 BEREGNINGSGRUNDLAG MANGLER                                */
 /*  3 5055 BEREGNINGSGRUNDLAG FOR 2-FAM-HUS MANGLER                  */
 /*  4 5035 KODE FOR 2 PROMILLE NEDSLAG FORKERT                       */
 /*  5 5036 EJENDOMMEN OVERTAGET EFTER 31/12-2009                     */
 /*  6 5037 EJENDOMMEN SOLGT FØR 1/1-2009 ELLER FØR OVERTAGELSESDAG   */
 /*  7 5041 KODE FOR STIGNINGSBEGRÆNSNING FORKERT                     */
 /*                                                                   */
 /* FEJLTAB(NR) OPSÆTTES LIG SAMTLIGE FUNDNE FEJLNUMRE                */
 /* RETURKODE SÆTTES LIG FØRST FUNDNE FEJLNUMMER                      */
 /*                                                                   */
 /*********************************************************************/
 UDFØR_KONTROLLER:                                                      
 PROC;                                                                  
                                                                        
         IF BH950_AR.CEJDTYPE = '1' !                                   
            BH950_AR.CEJDTYPE = '3' !                                   
            BH950_AR.CEJDTYPE = '4' !                                   
            BH950_AR.CEJDTYPE = '5' !                                   
            BH950_AR.CEJDTYPE = '7' !                                   
            BH950_AR.CEJDTYPE = '8' !                                   
            BH950_AR.CEJDTYPE = '9'                                     
         THEN;                                                          
         ELSE                                                           
            DO;                                                         
               BH950_AR.FEJLTAB(1) = 5032;                              
            END;                                                        
                                                                        
         IF BH950_AR.BBERGRL_SW = -1                                    
         THEN                                                           
            DO;                                                         
               BH950_AR.FEJLTAB(2) = 5033;                              
            END;                                                        
                                                                        
         IF (BH950_AR.CEJDTYPE = '4' !                                  
             BH950_AR.CEJDTYPE = '5') &                                 
             BH950_AR.BBER2FAM_SW = -1                                  
         THEN                                                           
            BH950_AR.FEJLTAB(3) = 5055;                                 
                                                                        
         IF BH950_AR.CNEDSL1 < '10' ! BH950_AR.CNEDSL1 > '50'           
         THEN                                                           
            DO;                                                         
               BH950_AR.FEJLTAB(4) = 5035;                              
            END;                                                        
                                                                        
         IF BH950_AR.DOVTG > BH65300M.ÅR1231               /*#01*/      
         THEN                                                           
            DO;                                                         
               BH950_AR.FEJLTAB(5) = 5036;                              
            END;                                                        
                                                                        
         IF BH950_AR.DAFSTÅ ^= 0 &                                      
           (BH950_AR.DAFSTÅ < BH65300M.ÅR0101 !           /*#01*/       
            BH950_AR.DAFSTÅ < BH950_AR.DOVTG)                           
         THEN                                                           
            DO;                                                         
               BH950_AR.FEJLTAB(6) = 5037;                              
            END;                                                        
                                                                        
         IF BH950_AR.GPCTEJER ^= 0                                      
         THEN;                                                          
         ELSE                                                           
            BH950_AR.GPCTEJER = 100.00;                                 
                                                                        
 END UDFØR_KONTROLLER;                                                  
 /*********************************************************************/
 /*      BEREGNING AF EJENDOMSVÆRDISKAT                               */
 /*********************************************************************/
 BEREGN_EVS:                                                            
 PROC;                                                                  
                                                                        
         IF BH950_AR.BBERGRL > 3040000    /* SKAL EVT. RETTES NÅR    */ 
         THEN                             /* DEN RIGTIGE GRÆNSEVÆRDI */ 
            DO;                           /* KENDES FOR ÅR 2009      */ 
               BH950_AR.BGRPROM1 = 3040000;                             
               BH950_AR.BGRPROM2 = BH950_AR.BBERGRL - 3040000;          
            END;                                                        
         ELSE                                                           
            BH950_AR.BGRPROM1 = BH950_AR.BBERGRL;                       
                                                                        
         IF BH950_AR.CGLSLUTEVS > '0'                                   
         THEN                                                           
            DO;                                                         
               /* BEREGN HVOR MEGET EJENDOMSVÆRDISKATTEN */             
               /* MAKSIMALT MÅ STIGE TIL                 */             
               SELECT (BH950_AR.CPTYPSLUT);                             
                 WHEN ('1')                                             
                   DO;                                                  
                      /* BEHANDLING AF ALMINDELIGE SKATTEYDERE */       
                      CALL BEREGN_MAX_STIGNING_2400;                    
                   END;                                                 
                 WHEN ('2','3','4')                                     
                   DO;                                                  
                      /* BEHANDLING AF EFTERLØN/FØRTIDSPENS */          
                      /* ELLER PENSIONISTER                 */          
                      CALL BEREGN_MAX_STIGNING_500;                     
                   END;                                                 
                 OTHERWISE;                                             
               END; /* SELECT */                                        
               IF BH950_AR.BSTITIL < 0                                  
               THEN                                                     
                  BH950_AR.BSTITIL = 0;                                 
            END;                                                        
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT 10 PROMILLE */                     
         BH950_AR.BPROM1 = MULTIPLY(BH950_AR.BGRPROM1,0.010,11,2);      
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT 30 PROMILLE */                     
         IF BH950_AR.BGRPROM2 > 0                                       
         THEN                                                           
            BH950_AR.BPROM2 = MULTIPLY(BH950_AR.BGRPROM2,0.030,11,2);   
                                                                        
         IF BH950_AR.CNEDSL1 >= '10' & BH950_AR.CNEDSL1 <= '29'         
         THEN                                                           
            DO;                                                         
               /* BEREGN 2 PROMILLE NEDSLAG - EJENDOM EJET 1/7-98 */    
               HJVÆRDI1 =                                               
               (MULTIPLY(BH950_AR.BBERGRL,0.002,11,3)) + 0.005;         
               BH950_AR.BNEDSL1 = HJVÆRDI1;                             
               /* BEREGN 4 PROMILLE NEDSLAG - EJENDOM EJET 1/7-98 */    
               SELECT (BH950_AR.CNEDSL2);                               
                 WHEN ('1')                                             
                   DO;                                                  
                      /* BEREGN 4 PROMILLE NEDSLAG - 1-FAM-HUS */       
                      /* SAMT 2-FAM-HUS MED 2 EJERBOLIGVÆRDIER */       
                      HJVÆRDI1 =                                        
                      (MULTIPLY(BH950_AR.BBERGRL,0.004,11,3)) + 0.005;  
                      /* NEDSLAGET KAN MAX. VÆRE 1200,00 KR. */         
                      IF HJVÆRDI1 < 1200.000                            
                      THEN                                              
                         BH950_AR.BNEDSL2 = HJVÆRDI1;                   
                      ELSE                                              
                         BH950_AR.BNEDSL2 = 1200.00;                    
                   END;                                                 
                 WHEN ('4')                                             
                   DO;                                                  
                      /* BEREGN 4 PROMILLE NEDSLAG - 2-FAM-HUS */       
                      /* MED  K U N  1 EJERBOLIGVÆRDI          */       
                      HJVÆRDI1 = (MULTIPLY                              
                      (BH950_AR.BBER2FAM,0.004,11,3)) + 0.005;          
                      /* NEDSLAGET KAN MAX. VÆRE 1200,00 KR. */         
                      IF HJVÆRDI1 < 2400.000                            
                      THEN                                              
                         BH950_AR.BNEDSL2 = HJVÆRDI1;                   
                      ELSE                                              
                         BH950_AR.BNEDSL2 = 2400.00;                    
                   END;                                                 
                 WHEN ('5')                                             
                   DO;                                                  
                      /* BEREGN 4 PROMILLE NEDSLAG - 2-FAM-HUS */       
                      /* MED 2 EJERBOLIGVÆRDIER                */       
                      HJVÆRDI1 = (MULTIPLY                              
                      (BH950_AR.BBER2FAM,0.004,11,3)) + 0.005;          
                      /* NEDSLAGET KAN MAX. VÆRE 1200,00 KR. */         
                      IF HJVÆRDI1 < 1200.000                            
                      THEN                                              
                         BH950_AR.BNEDSL2 = HJVÆRDI1;                   
                      ELSE                                              
                         BH950_AR.BNEDSL2 = 1200.00;                    
                   END;                                                 
                 OTHERWISE; /* INTET NEDSLAG */                         
               END;                                                     
            END;                                                        
                                                                        
         /* BEREGN 4 PROMILLE NEDSLAG FOR PERSONER MED */               
         /* STATUS SOM 67-ÅRIGE M.V.                   */               
                                                                        
         SELECT (BH950_AR.CPENSNED1);                                   
                                                                        
           WHEN ('1')                                                   
            DO;                                                         
               /* HELÅRSBOLIG */                                        
               HJVÆRDI1 =                                               
               (MULTIPLY(BH950_AR.BBERGRL,0.004,11,3)) + 0.005;         
               /* NEDSLAGET KAN MAX. VÆRE 6000,00 KR. */                
               IF HJVÆRDI1 < 6000.000                                   
               THEN                                                     
                  BH950_AR.BPENSNED = HJVÆRDI1;                         
               ELSE                                                     
                  BH950_AR.BPENSNED = 6000.00;                          
            END;                                                        
                                                                        
           WHEN ('2')                                                   
            DO;                                                         
               /* FRITIDSBOLIG */                                       
               HJVÆRDI1 =                                               
               (MULTIPLY(BH950_AR.BBERGRL,0.004,11,3)) + 0.005;         
               /* NEDSLAGET KAN MAX. VÆRE 2000,00 KR. */                
               IF HJVÆRDI1 < 2000.000                                   
               THEN                                                     
                  BH950_AR.BPENSNED = HJVÆRDI1;                         
               ELSE                                                     
                  BH950_AR.BPENSNED = 2000.00;                          
            END;                                                        
                                                                        
           OTHERWISE;                                                   
                                                                        
         END; /* SELECT */                                              
                                                                        
         /* BEREGN SUM AF EJENDOMSVÆRDISKAT */                          
         /* I N D E N  STIGNINGSBEGRÆNSNING */                          
                                                                        
         BH950_AR.BSUM2 = (BH950_AR.BPROM1 + BH950_AR.BPROM2) -         
                          (BH950_AR.BNEDSL1 + BH950_AR.BNEDSL2);        
                                                                        
         /* REGULER EVT. BNEDSL2 HVIS SUM2 BLIVER NEGATIV */            
                                                                        
         IF BH950_AR.BSUM2 < 0 &                                        
            BH950_AR.BNEDSL2 > 0                                        
         THEN                                                           
            DO;                                                         
               BH950_AR.BNEDSL2 = BH950_AR.BNEDSL2 + BH950_AR.BSUM2;    
               BH950_AR.BSUM2 = 0;                                      
            END;                                                        
                                                                        
         /* REGULER EVT. BPENSNED SÅ BSUM1 IKKE BLIVER NEGATIV */       
                                                                        
         IF BH950_AR.BPENSNED > BH950_AR.BSUM2                          
         THEN                                                           
            BH950_AR.BPENSNED = BH950_AR.BSUM2;                         
                                                                        
         BH950_AR.BSUM1 = (BH950_AR.BPROM1 + BH950_AR.BPROM2) -         
                          (BH950_AR.BNEDSL1 +                           
                           BH950_AR.BNEDSL2 +                           
                           BH950_AR.BPENSNED);                          
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT                    */              
         /* E F T E R  FASTFROSSEN STIGNINGSBEGRÆNSNING */              
         /* JVF. BEREGNINGSREGLER FOR SLUTÅR 2003!!!    */              
                                                                        
         IF BH950_AR.BFASTSTIGBGR_SW = 0                                
         THEN                                                           
            BH950_AR.BSUM1 = BH950_AR.BSUM1 - BH950_AR.BFASTSTIGBGR;    
                                                                        
         IF BH950_AR.BSUM1 < 0                                          
         THEN                                                           
            BH950_AR.BSUM1 = 0;                                         
                                                                        
         /* BEREGN FRADRAGSBELØB VEDR. STIGNINGSBEGRÆNSNING    */       
         /* JVF. BEREGNINGSREGLER FOR SLUTÅR 2004 OG SENERE!!! */       
                                                                        
         IF BH950_AR.CSTIBLB = '0'                                      
          ! BH950_AR.BSTITIL >= BH950_AR.BSUM1                          
         THEN                                                           
            DO;                                                         
              BH950_AR.BSTITIL = BH950_AR.BSUM1;                        
              BH950_AR.CSTIBLB = '0';                                   
            END;                                                        
                                                                        
          BH950_AR.BSTIBGR = BH950_AR.BSUM1 - BH950_AR.BSTITIL;         
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT                           */       
         /*  E F T E R  STIGNINGSBEGRÆNSNING                   */       
         /* JVF. BEREGNINGSREGLER FOR SLUTÅR 2004 OG SENERE!!! */       
                                                                        
         BH950_AR.BNETTO = BH950_AR.BSUM1 - BH950_AR.BSTIBGR;           
                                                                        
         IF BH950_AR.BNETTO < 0                                         
         THEN                                                           
            BH950_AR.BNETTO = 0;                                        
                                                                        
         IF BH950_AR.BPENSNED > 0                                       
         THEN                                                           
            DO;                                                         
               /* BEREGN EVT. REDUKTION AF 67-ÅRS NEDSLAG */            
               /* JVF. SOCIALINDKOMST                     */            
               HJVÆRDI2 = BH950_AR.BPENSIND - BH950_AR.BPENSGR;         
               HJVÆRDI1 =                                               
               (MULTIPLY(HJVÆRDI2,0.05,11,3)) + 0.005;                  
               IF HJVÆRDI1 < 0.000                                      
               THEN                                                     
                  BH950_AR.BPENSRED = 0.000;                            
               ELSE                                                     
                  DO;                                                   
                     IF HJVÆRDI1 <= BH950_AR.BPENSNED                   
                     THEN                                               
                        BH950_AR.BPENSRED = HJVÆRDI1;                   
                     ELSE                                               
                        BH950_AR.BPENSRED = BH950_AR.BPENSNED;          
                  END;                                                  
            END;                                                        
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT   E F T E R  */                    
         /* EVT. REDUKTION AF 67-ÅRS NEDSLAG      */                    
                                                                        
         BH950_AR.BBRUTTO = BH950_AR.BNETTO + BH950_AR.BPENSRED;        
                                                                        
         IF BH950_AR.BBRUTTO < 0                                        
         THEN                                                           
            BH950_AR.BBRUTTO = 0;                                       
                                                                        
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT TIL BETALING - 100% */             
                                                                        
         BH950_AR.B100 = BH950_AR.BBRUTTO;                              
                                                                        
         /* BEREGN EJENDOMSVÆRDISKAT - EJERANDEL */                     
                                                                        
         IF BH950_AR.GPCTEJER < 100.00                                  
         THEN                                                           
            DO;                                                         
               HJPCT = BH950_AR.GPCTEJER / 100;                         
               BH950_AR.BEJERAN = MULTIPLY(BH950_AR.B100,HJPCT,11,4);   
            END;                                                        
                                                                        
 /*********************************************************************/
 /* BEREGN HVOR MEGET EJENDOMSVÆRDISKATTEN MÅ STIGE TIL FOR           */
 /* PERSONER MED STATUS SOM PENSIONISTER ELLER FØRTIDSPENSIONISTER    */
 /* ELLER EFTERLØNSMODTAGERE                                          */
 /*********************************************************************/
 BEREGN_MAX_STIGNING_500:                                               
 PROC;                                                                  
                                                                        
         IF BH950_AR.BGLSLUTSTI <= 7000.00                              
         THEN                                                           
            DO;                                                         
               BH950_AR.BSTITIL = BH950_AR.BGLSLUTSTI + 500.00;         
               BH950_AR.CSTIBLB = '1';                                  
            END;                                                        
         ELSE                                                           
            DO;                                                         
               BH950_AR.BSTITIL = BH950_AR.BGLSLUTSTI +                 
               (MULTIPLY(BH950_AR.BGLSLUTSTI,0.2,11,2) - 900);          
               BH950_AR.CSTIBLB = '2';                                  
            END;                                                        
                                                                        
 END BEREGN_MAX_STIGNING_500;                                           
                                                                        
 /*********************************************************************/
 /* BEREGN HVOR MEGET EJENDOMSVÆRDISKATTEN MÅ STIGE TIL FOR           */
 /* ALMINDELIGE PERSONER                                              */
 /*********************************************************************/
 BEREGN_MAX_STIGNING_2400:                                              
 PROC;                                                                  
                                                                        
         IF BH950_AR.BGLSLUTSTI <= 12000.00                             
         THEN                                                           
            DO;                                                         
               BH950_AR.BSTITIL = BH950_AR.BGLSLUTSTI + 2400.00;        
               BH950_AR.CSTIBLB = '3';                                  
            END;                                                        
         ELSE                                                           
            DO;                                                         
               BH950_AR.BSTITIL = BH950_AR.BGLSLUTSTI +                 
               (MULTIPLY(BH950_AR.BGLSLUTSTI,0.2,11,2));                
               BH950_AR.CSTIBLB = '4';                                  
            END;                                                        
                                                                        
 END BEREGN_MAX_STIGNING_2400;                                          
 /*********************************************************************/
                                                                        
 END BEREGN_EVS;                                                        
 /*********************************************************************/
                                                                        
 END BH95006;                                                           
