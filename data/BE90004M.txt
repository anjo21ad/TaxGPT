 /*------------------------------------------------------------------*/ 
 /*                                                                  */ 
 /*   Makro     :  BE90004M - Select og insert                       */ 
 /*                Bruges af BE24400 OF BE24600                      */ 
 /*                                                                  */ 
 /*                                                                  */ 
 /*   Tabeller:    BE90000T - Driftsstyringstabel                    */ 
 /*                                                                  */ 
 /*   Programmør:  EDL, SKAT, dec. 2019                              */ 
 /*                                                                  */ 
 /*   Ændringer :  LTJ 02.11.2023                                    */ 
 /*                Ny macro BE90004M ifm. EVS ny lov, som kopi af    */ 
 /*                BQ90004M                                          */ 
 /*------------------------------------------------------------------*/ 
 DCL INK               BINARY FIXED(15);                                
 DCL MAX_KØRSELSNR     BINARY FIXED(15);                                
 DCL INDLÆS_STATUS_EJ_KØRT   BINARY FIXED(15) INIT(0);                  
 DCL INDLÆS_STATUS_KØRT      BINARY FIXED(15) INIT(1);                  
 DCL INDLÆS_STATUS_GENKØRT   BINARY FIXED(15) INIT(2);                  
 DCL OVERFØR_STATUS_EJ_KØRT  BINARY FIXED(15) INIT(0);                  
 DCL OVERFØR_STATUS_KØRT     BINARY FIXED(15) INIT(1);                  
 DCL OVERFØR_STATUS_GENKØRT  BINARY FIXED(15) INIT(2);                  
 DCL SQLKODE                 PIC '9999';                                
                                                                        
 DRIFTSTYR_KONTROL: PROC(WK_INDIVIDNR);                                 
 DCL WK_INDIVIDNR BIN FIXED (15);                                       
                                                                        
     DCLBE90000T.INDKAAR    = KONV_CH4_BF15(INDV_HEAD.INDKAAR);         
     DCLBE90000T.INDIVIDNR  = WK_INDIVIDNR;                             
     DCLBE90000T.KOERNR     = KONV_CH3_BF15(INDV_HEAD.KOERNR);          
                                                                        
     PUT SKIP LIST ('BE90004M. INDKAAR:     ',INDV_HEAD.INDKAAR);       
     PUT SKIP LIST ('          INDVNR :     ',WK_INDIVIDNR);            
     PUT SKIP LIST ('          KOERNR :     ',INDV_HEAD.KOERNR);        
     PUT SKIP LIST ('------------------------------------' );           
     PUT SKIP LIST ('   ' );                                            
                                                                        
     MAX_KØRSELSNR = 0;                                                 
                                                                        
     EXEC SQL SELECT                                                    
               max(KOERNR)                                              
         INTO :MAX_KØRSELSNR:INK                                        
         FROM  BE90000T                                                 
         WHERE INDKAAR    = :DCLBE90000T.INDKAAR                        
         AND   INDIVIDNR  = :WK_INDIVIDNR                               
     ;                                                                  
                                                                        
     SQLKODE = SQLCODE;                                                 
     SELECT (SQLCODE);                                                  
       WHEN (0)                                                         
          DO;                                                           
             if INK = -1                                                
             THEN                                                       
                MAX_KØRSELSNR = 0;                                      
            /*                                                          
             IF (MAX_KØRSELSNR = DCLBE90000T.KOERNR)                    
             THEN                                                       
               DO;                                                      
                  FEJLTEKST =                                           
                     ' 264 KØRSELSNR. '!! INDV_HEAD.KOERNR !!' ER KØRT' 
                     !! SQLCODE;                                        
                  CALL SQL_FEJL;                                        
               END;                                                     
            */                                                          
                                                                        
          END;                                                          
       WHEN (100)                                                       
          MAX_KØRSELSNR = 0;                                            
       OTHER                                                            
         DO;                                                            
           FEJLTEKST = '260 FEJL I SELECT MAX PÅ DRIFTSTYR. SQLCODE: '  
                     !! SQLCODE;                                        
           CALL sql_fejl;                                               
         END;                                                           
     END;                                                               
                                                                        
 END DRIFTSTYR_KONTROL;                                                 
                                                                        
 /*******************************************************************/  
 /* INSERT EN RÆKKE I BE90000T                                      */  
 /*******************************************************************/  
 OPRET_BE90000T: PROC (WK_INDIVIDNR);                                   
 DCL WK_INDIVIDNR BIN FIXED (15);                                       
                                                                        
      DCLBE90000T = '';                                                 
      DCLBE90000T.INDKAAR    = KONV_CH4_BF15(INDV_HEAD.INDKAAR);        
      DCLBE90000T.INDIVIDNR  = WK_INDIVIDNR;                            
      DCLBE90000T.KOERNR     = KONV_CH3_BF15(INDV_HEAD.KOERNR);         
      DCLBE90000T.INDLÆS_NAVN   = PROGRAM_1;                            
      DCLBE90000T.INDLÆS_STATUS = INDLÆS_STATUS_KØRT;                   
      DCLBE90000T.OVERFØR_NAVN  = PROGRAM_2;                            
      DCLBE90000T.OVERFØR_STATUS = OVERFØR_STATUS_EJ_KØRT;              
                                                                        
      EXEC SQL                                                          
        INSERT INTO BE90000T                                            
         (INDKAAR                                                       
         ,INDIVIDNR                                                     
         ,KOERNR                                                        
         ,INDLÆS_NAVN                                                   
         ,INDLÆS_OPRET_TS                                               
         ,INDLÆS_OPDATER_TS                                             
         ,INDLÆS_STATUS                                                 
         ,OVERFØR_NAVN                                                  
         ,OVERFØR_OPRET_TS                                              
         ,OVERFØR_OPDATER_TS                                            
         ,OVERFØR_STATUS)                                               
        VALUES                                                          
         (:DCLBE90000T.INDKAAR                                          
         ,:DCLBE90000T.INDIVIDNR                                        
         ,:DCLBE90000T.KOERNR                                           
         ,:DCLBE90000T.INDLÆS_NAVN                                      
         ,CURRENT TIMESTAMP                                             
         ,CURRENT TIMESTAMP                                             
         ,:DCLBE90000T.INDLÆS_STATUS                                    
         ,:DCLBE90000T.OVERFØR_NAVN                                     
         ,CURRENT TIMESTAMP                                             
         ,CURRENT TIMESTAMP                                             
         ,:DCLBE90000T.OVERFØR_STATUS)                                  
         ;                                                              
                                                                        
       SELECT (SQLCA.SQLCODE);                                          
           WHEN (0)                                                     
            DO;                                                         
            END;                                                        
           OTHERWISE                                                    
             DO;                                                        
               fejltekst = '305 INSERT BE90000T';                       
               CALL SQL_FEJL;                                           
             END;                                                       
       END; /* SELECT*/                                                 
                                                                        
 END OPRET_BE90000T;                                                    
 /*********************************************************************/
 /* OPDAT EN RÆKKE I BE90000T                                         */
 /********************************************************************/ 
 OPDAT_BE90000T: PROC (T_INDKAAR,T_KOERNR,T_INDIVIDNR);                 
 DCL T_INDKAAR   BIN FIXED (15);                                        
 DCL T_KOERNR    BIN FIXED (15);                                        
 DCL T_INDIVIDNR BIN FIXED (15);                                        
                                                                        
      EXEC SQL UPDATE BE90000T                                          
         SET INDLÆS_OPDATER_TS = CURRENT TIMESTAMP                      
            ,INDLÆS_STATUS = :INDLÆS_STATUS_GENKØRT                     
            ,OVERFØR_OPDATER_TS = CURRENT TIMESTAMP                     
            ,OVERFØR_STATUS = :OVERFØR_STATUS_EJ_KØRT                   
         WHERE INDKAAR    = :T_INDKAAR                                  
         AND   INDIVIDNR  = :T_INDIVIDNR                                
         AND   KOERNR     = :T_KOERNR                                   
     ;                                                                  
                                                                        
      SELECT (SQLCA.SQLCODE);                                           
        WHEN (0)                                                        
            DO;                                                         
            END;                                                        
        OTHERWISE                                                       
            DO;                                                         
               fejltekst = '307 UPDATE BE90000T ' !! SQLCODE;           
               CALL SQL_FEJL;                                           
            END;                                                        
      END; /* SELECT*/                                                  
 END OPDAT_BE90000T;                                                    
