  BE55600: PROCEDURE OPTIONS(MAIN) REORDER;                             
         DFT RANGE (*) STATIC;                                          
 /*-------------------------------------------------------------------* 
  *                                                                   * 
  *  Danne liste over ejendomme med manuelt rettede enhedsløbenumre   * 
  *  rettet af KMD og sende mail om dem til sagsbehandler ??          * 
  *  PLIRETC = ! fjernet da listen også ønskes uden data              * 
  *                                                                   * 
  *  PROGRAMMØR: LAC   Juni 2023                                      * 
  *                                                                   * 
  *  Rettet af :                                                      * 
  *  JJJ BE55600M erstatter BE55300M                       18.06.2024 * 
  *-------------------------------------------------------------------*/
 /*-------------------------------------------------------------------* 
  *              ENTRIES                                            *   
  *-------------------------------------------------------------------*/
   DCL     ZS30101         ENTRY;                                       
   DCL     ZS67000         ENTRY;                                       
   DCL     ZS61900         ENTRY OPTIONS (ASM,INTER); /* SSI-ENTRY */   
 /*-------------------------------------------------------------------* 
  *       INCLUDE SQL COMMUNICATION AREA                              * 
  *-------------------------------------------------------------------*/
   EXEC SQL INCLUDE SQLCA;                                              
   %INCLUDE BE80200T;      // Ejendomstabel                             
 /*------------------------------------------------------------------*/ 
 /*   Cursor BE80200T                                                */ 
 /*------------------------------------------------------------------*/ 
                                                                        
      exec sql declare BE80200T_cur cursor with hold for select         
           T3.EKOMNR, T3.EEJDNR, T3.EENHEDLBNR, T3.VEJK_ENH,            
           T3.HUSNR_ENH, T3.ETAGE_ENH,                                  
           T3.DØRNR_ENH, T3.ADRSNAVN_ENH, T3.DVURDÅR                    
      FROM                                                              
         (SELECT T1.EKOMNR, T1.EEJDNR                                   
          FROM BE80200T T1                                              
          WHERE T1.EENHEDLBNR > 2                                       
          GROUP BY T1.EKOMNR, T1.EEJDNR                                 
          ) T2,                                                         
       BE80200T T3                                                      
       WHERE T3.EKOMNR = T2.EKOMNR                                      
         AND T3.EEJDNR = T2.EEJDNR                                      
       ORDER BY T3.EKOMNR, T3.EEJDNR, T3.EENHEDLBNR                     
      ;                                                                 
                                                                        
        SELECT (SQLCODE);                                               
        WHEN (0,100);                                                   
        OTHER                                                           
            DO;                                                         
               CALL SQLFEJL('FEJL v/cursor BE80200T')  ;                
            END;                                                        
         END; /* SELECT*/                                               
                                                                        
                                                                        
 /*-------------------------------------------------------------------* 
  *       TIL PRINT                                                   * 
  *-------------------------------------------------------------------*/
   % INCLUDE ZZ20301M;                             /* TIL PRINT */      
                                                                        
 /*-------------------------------------------------------------------* 
  *       DECLARES AF BUILTINS                                        * 
  *-------------------------------------------------------------------*/
   DCL    (DATE,PLIDUMP,ONCODE,ADDR,NULL,SUBSTR, PLIRETC, STG) BUILTIN; 
                                                                        
 /*-------------------------------------------------------------------* 
  *      DIVERSE VARIABLER                                            * 
  *-------------------------------------------------------------------*/
  DCL 1 LIN_OV1,                                                        
      5 CTL                 CHAR    (1),                                
      5 OVERSKRIFT          CHAR    (132) INIT (                        
 '          LISTE OVER EJENDOMME DER SKAL HAVE RETTET LØBENUMMER   ');  
                                                                        
  DCL 1 LIN_TID,                                                        
      5 CTL                 CHAR    (1),                                
      5 FIL1                CHAR   (3)  INIT(' '),                      
      5 AFVKL               CHAR   (11) INIT ('LISTE KØRT: '),          
      5 DATO                CHAR   (10) INIT(' '),                      
      5 FIL3                CHAR   (3)  INIT(' '),                      
      5 EVS_ÅR              CHAR   (7)  INIT('EVS ÅR: '),               
      5 TIL_EVS_AAR         PIC    'ZZZZ',                              
      5 FIL4                CHAR   (3)  INIT(' '),                      
      5 EVS_TYPE            CHAR   (15) INIT('EVS AFVIKLING: '),        
      5 AFVIKLINGS_ID       CHAR   (7)  INIT (' '),                     
      5 FIL5                CHAR   (3)  INIT(' '),                      
      5 EVS_ID              CHAR   (8) INIT('EVS ID: '),                
      5 DATA_ID             PIC    'ZZZZZZ',                            
      5 FIL6                CHAR   (70)  INIT(' ');                     
                                                                        
  DCL 1 LIN_BL,                                                         
      5 CTL                 CHAR    (1),                                
      5 Blank               CHAR    (132) INIT ('');                    
                                                                        
  DCL 1 LIN_OV2,                                                        
      5 CTL                 CHAR   (1),                                 
      5 EKOMNR              CHAR   (7)  INIT ('KOMMUNE'),               
      5 FIL1                CHAR   (3)  INIT(' '),                      
      5 EEJDNR              CHAR   (11) INIT('EJENDOMSNR'),             
      5 FIL2                CHAR   (3)  INIT(' '),                      
      5 EENHEDLBNR          CHAR   (10) INIT('LØBENUMMER'),             
      5 FIL3                CHAR   (3)  INIT(' '),                      
      5 VEJK_ENH            CHAR   (7)  INIT('VEJKODE'),                
      5 FIL4                CHAR   (3)  INIT(' '),                      
      5 HUSNR_ENH           CHAR   (9) INIT('HUSNUMMER'),               
      5 FIL5                CHAR   (3)  INIT(' '),                      
      5 ETAGE_ENH           CHAR   (5) INIT('ETAGE'),                   
      5 FIL6                CHAR   (3) INIT(' '),                       
      5 DØRNR_ENH           CHAR   (9)  INIT ('DØRNUMMER'),             
      5 FIL7                CHAR   (3) INIT(' '),                       
      5 ADRSNAVN_ENH        CHAR   (7)  INIT ('ADRESSE'),               
      5 FIL8                CHAR   (13) INIT(' '),                      
      5 DVURDÅR             CHAR   (12) INIT('VURDERINGSÅR'),           
      5 FIL9                CHAR   (18) INIT(' ')                       
      ;                                                                 
                                                                        
  DCL 1 LIN,                                                            
      5 CTL                 CHAR    (1),                                
      5 EKOMNR              PIC   'ZZZZZZZ',                            
      5 FIL1                CHAR   (5)  INIT(' '),                      
      5 EEJDNR              PIC   'ZZZZZZZZ',                           
      5 FIL2                CHAR   (12)  INIT(' '),                     
      5 EENHEDLBNR          PIC   'ZZ',                                 
      5 FIL3                CHAR   (5)  INIT(' '),                      
      5 VEJK_ENH            Pic   'ZZZZZ',                              
      5 FIL4                CHAR   (8)  INIT('  '),                     
      5 HUSNR_ENH           CHAR   (4),                                 
      5 FIL5                CHAR   (6)  INIT('  '),                     
      5 ETAGE_ENH           CHAR   (2),                                 
      5 FIL6                CHAR   (8)  INIT('  '),                     
      5 DØRNR_ENH           CHAR   (4),                                 
      5 FIL7                CHAR   (3) INIT(' '),                       
      5 ADRSNAVN_ENH        CHAR   (20),                                
      5 FIL8                CHAR   (8)  INIT('  '),                     
      5 DVURDÅR             Pic 'ZZZZ',                                 
      5 FIL9                CHAR   (30)  INIT('  ')                     
       ;                                                                
                                                                        
  DCL    CURRENT_TIME       CHAR(26);                                   
  DCL    CURRENT_YEAR       CHAR(4);                                    
  DCL    CURRENT_MONTH      CHAR(2);                                    
                                                                        
 DCL     DATO_TID           CHAR(10)        INIT('');                   
 DCL     PGM_NAVN           CHAR(08)  INIT('BE55600');                  
 DCL     GEM_EEJDNR         PIC   '(10)9';                              
 DCL     GEM_KOMNR          PIC   '(7)9';                               
                                                                        
 DCL     HJ_AFVIKLET        Char(26);                                   
 DCL     HJ_ÅR              PIC   '(9)9';                               
 DCL     HJ_INDKÅR          PIC   '(9)9';                               
 DCL     INDKOMSTÅR         bin fixed  (15) init (0);                   
                                                                        
  DCL    DATA_FUNDET        CHAR(1) INIT ('N');                         
                                                                        
  DCL    BE80200T_FUNDET    CHAR(1) INIT ('N');                         
                                                                        
  DCL     1 BE55600M,                                                   
           %INCLUDE BE55600M; /* OPSÆT AKTUELT INDKOMSTÅR M.V. */       
                                                                        
 /*********************************************************************/
 /*     Tællere                                                       */
 /*********************************************************************/
 DCL    BE80200T_LÆS          bin fixed (31) init (0);                  
 DCL    ANTAL_SKREVNE         bin fixed (31) init (0);                  
                                                                        
 /*-------------------------------------------------------------------* 
  *       INITIERING                                                  * 
  *-------------------------------------------------------------------*/
   ON ERROR CALL PLIDUMP('SHOB');                                       
 /*-------------------------------------------------------------------* 
  *       HOUSEKEEPING....                                            * 
  *-------------------------------------------------------------------*/
     CALL ZS61900;       /* SSI-DATO */                                 
                                                                        
     CALL ZZ20390 ('*OPEN','BE55601Y');  /* OPEN-KALD TIL papir   */    
                                                                        
     CALL GET_CURRENT_TIME;                                             
                                                                        
     CALL STYRING;                                                      
                                                                        
     CALL ZZ20300 (LIN,'99');              /* CLOSE-KALD PÅ SPOOL */    
                                                                        
   /*  IF  DATA_FUNDET     = 'J' THEN                                   
         CALL PLIRETC(1);  */                                           
                                                                        
 /*-------------------------------------------------------------------* 
  *                                                                   * 
  *-------------------------------------------------------------------*/
 STYRING: PROC;                                                         
                                                                        
    CALL OVERSKRIFT;                                                    
                                                                        
    CALL OPEN_CUR_BE80200T;                                             
                                                                        
    CALL SKAF_BE80200T;                                                 
                                                                        
    DO WHILE (SQLCA.SQLCODE = 0                                         
           &  BE80200T_FUNDET = 'J');                                   
       CALL SKRIV_DATA;                                                 
       CALL SKAF_BE80200T;                                              
    END;                                                                
                                                                        
    CALL CLOSE_CUR_BE80200T;                                            
                                                                        
    CAll AFSLUT;                                                        
                                                                        
 END STYRING;                                                           
                                                                        
 /*-------------------------------------------------------------------* 
  * FETCH person fra GS tabel BE80200T                                * 
  *-------------------------------------------------------------------*/
 SKAF_BE80200T: PROC;                                                   
                                                                        
     EXEC SQL FETCH BE80200T_cur                                        
       INTO                                                             
        :DCLBE80200T.EKOMNR,                                            
        :DCLBE80200T.EEJDNR,                                            
        :DCLBE80200T.EENHEDLBNR,                                        
        :DCLBE80200T.VEJK_ENH,                                          
        :DCLBE80200T.HUSNR_ENH,                                         
        :DCLBE80200T.ETAGE_ENH,                                         
        :DCLBE80200T.DØRNR_ENH,                                         
        :DCLBE80200T.ADRSNAVN_ENH,                                      
        :DCLBE80200T.DVURDÅR                                            
        ;                                                               
            SELECT (SQLCODE);                                           
         WHEN (0)                                                       
         DO;                                                            
            BE80200T_LÆS  = BE80200T_LÆS + 1;                           
            BE80200T_FUNDET = 'J';                                      
            DATA_FUNDET     = 'J';                                      
         END;                                                           
         WHEN (100)                                                     
           BE80200T_FUNDET = 'N';                                       
         OTHER                                                          
              CALL SQLFEJL('Fetch BE80200T');                           
         END; /* SELECT*/                                               
                                                                        
 END SKAF_BE80200T;                                                     
                                                                        
  /*-------------------------------------------------------------------*
  *    Skriv detaillinier                                             * 
  *-------------------------------------------------------------------*/
 SKRIV_DATA: PROC;                                                      
                                                                        
      IF GEM_KOMNR      ^=  DCLBE80200T.EKOMNR                          
      THEN DO;                                                          
           GEM_KOMNR     = DCLBE80200T.EKOMNR;                          
           LIN.EKOMNR    = DCLBE80200T.EKOMNR;                          
           /* blank linie */                                            
           LIN_BL.CTL = ZZWS2;                                          
           CALL ZZ20300(LIN_BL,'01');                                   
           END;                                                         
      ELSE DO;                                                          
           LIN.EKOMNR    = '';                                          
           END;                                                         
                                                                        
      IF GEM_EEJDNR     ^=  DCLBE80200T.EEJDNR                          
      THEN DO;                                                          
           GEM_EEJDNR    = DCLBE80200T.EEJDNR;                          
           IF ANTAL_SKREVNE >= 1                                        
           THEN DO;   /* blank linie */                                 
                 LIN_BL.CTL = ZZWS2;                                    
                 CALL ZZ20300(LIN_BL,'01');                             
               END;                                                     
           ANTAL_SKREVNE = ANTAL_SKREVNE + 1;                           
         END;                                                           
                                                                        
     LIN.CTL                 = ZZWS1;                                   
     LIN.EEJDNR              = DCLBE80200T.EEJDNR;                      
     LIN.EENHEDLBNR          = DCLBE80200T.EENHEDLBNR;                  
     LIN.VEJK_ENH            = DCLBE80200T.VEJK_ENH;                    
     LIN.HUSNR_ENH           = DCLBE80200T.HUSNR_ENH;                   
     LIN.ETAGE_ENH           = DCLBE80200T.ETAGE_ENH;                   
     LIN.DØRNR_ENH           = DCLBE80200T.DØRNR_ENH;                   
     LIN.ADRSNAVN_ENH        = DCLBE80200T.ADRSNAVN_ENH;                
     LIN.DVURDÅR             = DCLBE80200T.DVURDÅR;                     
                                                                        
     CALL ZZ20300(LIN,'01');                                            
                                                                        
 END SKRIV_DATA;                                                        
 /*-------------------------------------------------------------------* 
  *        Overskrift                                                   
  *-------------------------------------------------------------------*/
 OVERSKRIFT: PROC;                                                      
                                                                        
   LIN_OV1.CTL = ZZWS2;                                                 
   CALL ZZ20300(LIN_OV1,'01');                                          
                                                                        
   LIN_BL.CTL = ZZWS2;                                                  
   CALL ZZ20300(LIN_BL,'01');                                           
                                                                        
   LIN_TID.DATO          = DATO_TID;                                    
   LIN_TID.CTL           = ZZWS2;                                       
   LIN_TID.TIL_EVS_AAR   =  BE55600M.TIL_EVS_AAR;                       
                                                                        
   SELECT (BE55600M.AFVIKLINGS_ID);                                     
      WHEN ('OPRET_EVS_FORSK') DO;                                      
        LIN_TID.AFVIKLINGS_ID =  'FORSKUD';                             
      END;                                                              
                                                                        
      WHEN ('OPRET_EVS_SLUT') DO;                                       
         LIN_TID.AFVIKLINGS_ID =  'SLUT  ';                             
      END;                                                              
                                                                        
       WHEN ('SUPPL_EVS_SLUT') DO;                                      
         LIN_TID.AFVIKLINGS_ID =  'SUPPL  ';                            
      END;                                                              
  END;                                                                  
                                                                        
   LIN_TID.DATA_ID      =  BE55600M.DATA_ID;                            
   CALL ZZ20300(LIN_TID,'01');                                          
                                                                        
   LIN_BL.CTL = ZZWS2;                                                  
   CALL ZZ20300(LIN_BL,'01');                                           
                                                                        
   LIN_OV2.CTL = ZZWS1;                                                 
   CALL ZZ20300(LIN_OV2,'01');                                          
                                                                        
 END OVERSKRIFT;                                                        
 /*-------------------------------------------------------------------* 
  * Denne bruges egentlig ikke ;-)                                    * 
  *-------------------------------------------------------------------*/
 GET_CURRENT_TIME: PROC;                                                
     EXEC SQL SET                                                       
        :CURRENT_TIME = CURRENT TIMESTAMP;                              
                                                                        
     IF SQLCA.SQLCODE ^= 0 THEN                                         
     DO;                                                                
        CALL SQLFEJL('FEJL: CURRENT_YEAR');                             
     END;                                                               
                                                                        
     CURRENT_YEAR  = SUBSTR(CURRENT_TIME,1,4);                          
     CURRENT_MONTH = SUBSTR(CURRENT_TIME,6,2);                          
     HJ_ÅR         = CURRENT_YEAR;                                      
     INDKOMSTÅR    = HJ_ÅR;                                             
                                                                        
     exec sql set :DATO_TID = CURRENT DATE;                             
                                                                        
  END GET_CURRENT_TIME;                                                 
                                                                        
                                                                        
  /*-------------------------------------------------------------------*
  *   OPEN CURSOR                                                     * 
  *-------------------------------------------------------------------*/
  OPEN_CUR_BE80200T: PROC;                                              
                                                                        
    EXEC sql open BE80200T_cur;                                         
                                                                        
    IF SQLCA.SQLCODE ^= 0                                               
     THEN                                                               
       CALL SQLFEJL('OPEN BE80200T_cur');                               
                                                                        
 END OPEN_CUR_BE80200T;                                                 
                                                                        
  /*-------------------------------------------------------------------*
  *   CLOSE CURSOR                                                     *
  *-------------------------------------------------------------------*/
  CLOSE_CUR_BE80200T: PROC;                                             
                                                                        
    EXEC sql CLOSE BE80200T_cur;                                        
                                                                        
    IF SQLCA.SQLCODE ^= 0                                               
     THEN                                                               
       CALL SQLFEJL('CLOSE BE80200T_cur');                              
                                                                        
 END CLOSE_CUR_BE80200T;                                                
                                                                        
 /*********************************************************************/
 /* UDSKRIV AFSTEMNINGS- OG KONTROLLISTE                              */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
    PUT SKIP LIST('. . AFSTEMNINGS- OG KONTROLLISTE . . .   ');         
    PUT SKIP LIST('. . . . . . . . . . . . . . . . . . . .  ');         
                                                                        
    PUT SKIP LIST('INDLÆST FRA EJD. REGISTER . . . . . .  : ' ,         
                     BE80200T_LÆS );                                    
                                                                        
    PUT SKIP LIST('ANTAL EJD. SKREVET PÅ LISTEN . . . . . : ' ,         
                     ANTAL_SKREVNE);                                    
 END AFSLUT;                                                            
  /*------------------------------------------------------------------- 
  *     SQL FEJL                                                      * 
  *-------------------------------------------------------------------*/
 SQLFEJL: PROC(PROCEDURENAVN);                                          
 DCL     PROCEDURENAVN   CHAR (25);                                     
 DCL     MEDD            CHAR (56);                                     
                                                                        
 DCL     SQLFEJL         PIC 'S999';                                    
         SQLFEJL = 0;                                                   
         SQLFEJL = SQLCA.SQLCODE;                                       
                                                                        
     MEDD =  'BE55600 ** 550 SQLFEJL: ' !! SQLFEJL !!                   
             ' I PROC. ' !! PROCEDURENAVN;                              
                                                                        
     CALL ZS67000 (SQLCA);     /* VISER DETALJER VEDR. DB2-FEJL     */  
     EXEC SQL ROLLBACK;                                                 
     CALL ZS30101(5,MEDD,2);   /* ABEND  */                             
                                                                        
 END SQLFEJL;                                                           
 END BE55600;                                                           
