 BH55200: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS FORSKUD / EVS SLUT                                 *
 * PROGRAMNAVN: BH55200.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    Konvertering af MTfil til DB2-tabel for gammelt år     *
 * PGMFORLØB:   1. ÅBEN MT-fil                                         *
 *              2. LÆS MT-fil                                          *
 *              3. SKRIV RÆKKE PÅ DB2-TABEL BQ76000T                   *
 *              5. SKRIV KONTROLLISTE.                                 *
 * INDDATA:     MT-fil gammelt år                                      *
 *                                                                     *
 * UDDATA:      BH55201Y - KONTROLLISTE.                               *
 *              BQ76000T - MANDTALSOPLYSNINGER                         *
 ***********************************************************************
 * OPRETTET   : Lene Maj Jensen   QLE             BALLERUP 07.02.2017  *
 **********************************************************************/
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KOMMUNEDATA A/S 2006');    
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     BH552I FILE RECORD INPUT;     /* Parameter Forskud-Slut */     
 DCL     BH655I FILE RECORD INPUT;     /* MT-fil                 */     
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
 /*********************************************************************/
 /*      DECLARE AF MT-fil                                            */
 /*********************************************************************/
 DCL     BH655_AR CHAR (200) VAR;                                       
 DCL     1 BH655         BASED     (ADDR(BH655_AR)),                    
         3 LÆNGDE BIN FIXED (15),                                       
         %INCLUDE BH65501N;;                                            
                                                                        
 DCL     1 BH65599       BASED     (ADDR(BH655_AR)),                    
         2 LÆNGDE BIN FIXED (15),                                       
         %INCLUDE BH65599N;                                             
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
 DCL     WS_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                    
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
                                                                        
 DCL     WS_TIL_EVS_AAR_GL              BIN FIXED (15);                 
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_PROGRAMNAVN         CHAR(8)  INIT ('BH55200');              
                                                                        
 DCL     1 BH552_PARM,                                                  
           %INCLUDE BH54900N;                                           
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF_BH552       BIT       (01)      INIT      ('0'B);          
 DCL     EOF_BH655       BIT       (01)      INIT      ('0'B);          
 DCL     JA                 BIT       (1)     INIT ('1'B);              
 DCL     NEJ                BIT       (1)     INIT ('0'B);              
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF ABEND STRUKTUR m.v.                               */
 /*                                                                   */
 /*********************************************************************/
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH55200'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER TIL KONTROLLISTEN                     */
 /*********************************************************************/
                                                                        
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (1),                                 
          2 FILLER       CHAR      (132)     INIT      (' ');           
                                                                        
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (1),                                 
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH55200L'),                                        
           2 F1          CHAR      (23)      INIT      (' '),           
           2 TEKST2      CHAR      (43)      INIT      (                
           'MANDTALSOPLYSNINGER '),                                     
           2 ÅR          PIC       '9999',                              
           2 F2          CHAR      (21)      INIT      ((21)' '),       
           2 TEKST4      CHAR      (14)      INIT      (                
           'UDSKREVET DEN '),                                           
           2 DATO        CHAR      (10);                                
                                                                        
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (1),                                 
           2 F1          CHAR      (53)      INIT      (' '),           
           2 TEKST1      CHAR      (79)      INIT                       
           ('KØRSELSKONTROLLISTE');                                     
                                                                        
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (1),                                 
           2 TEKST       CHAR      (53),                                
           2 ANTAL       PIC       'ZZZ.ZZZ.ZZ9',                       
           2 F1          CHAR      (68)      INIT      (' ');           
                                                                        
         % INCLUDE ZZ20301M;                                            
                                                                        
 /*********************************************************************/
 /*      DECLARE AF ENTRIES                                           */
 /*********************************************************************/
                                                                        
 DCL     ZS61900         ENTRY;              /* UDSKRIV SSI-DATO      */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     ADDR            BUILTIN;                                       
 DCL     NULL            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANT_SKR BIN FIXED (31) INIT(0);   /* ANTAL SKREVET PÅ UDTRÆK */
 DCL     ANT_INS BIN FIXED (31) INIT(0);   /* HERAF INSERTED */         
 DCL     ANT_UPD BIN FIXED (31) INIT(0);   /* HERAF UPDATED  */         
 DCL     ANT_LÆS BIN FIXED (31) INIT(0);   /* LÆST PÅ MT-fil  */        
 DCL     ANT_COMM BIN FIXED (31) INIT (0); /* COMMIT TÆLLER  */         
                                                                        
 /*********************************************************************/
 /* Declare af Cursors                                                */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /* M A C R O E R der SKAL ligge før koden grundet declare af cursors */
 /*********************************************************************/
 %INCLUDE BH54999M; /* CHECK OM OMKØRSEL, OG UDFØR EVT OPRYDNING */     
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BH552 = NEJ;                                               
         EOF_BH655 = NEJ;                                               
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH55200L');             
            END;                                                        
                                                                        
         ON ENDFILE (BH655I)                                            
         BEGIN;                                                         
            EOF_BH655 = JA;                                             
            BH655.DCPRN = 9999999999;                                   
         END;                                                           
                                                                        
         ON ENDFILE (BH552I)                                            
         BEGIN;                                                         
            EOF_BH552 = JA;                                             
         END;                                                           
                                                                        
         OPEN FILE (BH552I) TITLE ('BH55200P');                         
         OPEN FILE (BH655I) TITLE ('BH65501I');                         
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
         READ FILE (BH552I) INTO (BH552_PARM);                          
                                                                        
         IF EOF_BH552 = NEJ                                             
         THEN DO;                                                       
            SELECT (BH552_PARM.FS_MRK);                                 
               WHEN ('F')                                               
                  DO;                                                   
                     ABENDTXT = '101 KØRES KUN FOR SLUT';               
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
               WHEN ('S')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH552_PARM.SLUT_TXT;         
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR - 1;              
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 2;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH552_PARM.SLUT_TXT;       
                     OVERLIN1.TEKST2 = 'MANDTALSOPLYSNINGER SLUT';      
                  END;                                                  
               WHEN ('U')                                               
                  DO;                                                   
                     ABENDTXT = '101 KØRES KUN FOR SLUT';               
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
         END;                                                           
                                                                        
         /********************************************************/     
         /*  CHECK OM FORGÆNGERE ER KØRT                         */     
         /********************************************************/     
         CALL CHECK_SEKVENS (BH552_PARM.FS_MRK); /* BH54997M */         
                                                                        
         /********************************************************/     
         /*  NU STARTER CHECK AF OMKØRSEL                        */     
         /********************************************************/     
         CALL CHECK_OM_OMKØRSEL;                                        
         IF DER_SKAL_KØRES_OM                                           
         THEN DO;                                                       
            PUT SKIP LIST ('Omkørsel af ' !! WS_PROGRAMNAVN);           
            CALL RYD_OP_FØR_OMKØRSEL;                                   
         END;                                                           
         ELSE DO;                                                       
            PUT SKIP LIST ('Normal kørsel af ' !! WS_PROGRAMNAVN);      
         END;                                                           
                                                                        
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL('START',BH552_PARM.FS_MRK);          
                                                                        
         CALL ZZ20390('*OPEN','BH55201Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
         OVERLIN1.ÅR   = GLSLUTÅR - 1;                                  
         OVERLIN1.DATO = UDDATO;                                        
         SIDELIN.CCA   = ZZIK1;                                         
         OVERLIN1.CCA  = ZZWS2;                                         
         OVERLIN2.CCA  = ZZWS3;                                         
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         READ FILE (BH655I) INTO (BH655_AR);                            
                                                                        
         DO WHILE (^EOF_BH655);                                         
            ANT_LÆS = ANT_LÆS + 1;                                      
            IF BH65599.DCPRN >= 9999999999                              
            THEN DO;                                                    
               EOF_BH655 = '1'B;                                        
            END;                                                        
            ELSE DO;                                                    
               /* check om der findes en række, og  */                  
               /* insert eller update efterfølgende */                  
               CALL INSERT_UPDATE_MANDTALSOPL;                          
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_COMM = ANT_COMM + 1;                                 
               IF ANT_COMM > 9999                                       
               THEN DO;                                                 
                  EXEC SQL COMMIT;                                      
                  Put skip list ('Commit efter ' !! ANT_COMM !!         
                                 ' opdateringer.  Ialt ' !! ANT_SKR !!  
                                 ' opdateringer');                      
                  ANT_COMM = 0;                                         
               END;                                                     
               READ FILE (BH655I) INTO (BH655_AR);                      
            END;                                                        
         END;                                                           
                                                                        
         IF ANT_COMM > 0                                                
         THEN DO;                                                       
            EXEC SQL COMMIT;                                            
            Put skip list ('Commit efter ' !! ANT_COMM !!               
                           ' opdateringer.  Ialt ' !! ANT_SKR !!        
                           ' opdateringer');                            
            ANT_COMM = 0;                                               
         END;                                                           
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* CHECK OM RÆKKE FINDES OG INSERT/UPDATE herefter            RUTINE */
 /*********************************************************************/
 INSERT_UPDATE_MANDTALSOPL: PROC;                                       
                                                                        
         DCLBQ76000T = '';                                              
         DCLBQ76000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ76000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ76000T.DCPRN          = BH655.DCPRN;                      
                                                                        
         EXEC SQL                                                       
            SELECT TIL_EVS_AAR,DCPRN,PROGRAMNAVN,DB2FUNKTION            
                  ,AFVIKLINGS_ID                                        
            INTO   :DCLBQ76000T.TIL_EVS_AAR,                            
                   :DCLBQ76000T.DCPRN,                                  
                   :DCLBQ76000T.PROGRAMNAVN,                            
                   :DCLBQ76000T.DB2FUNKTION,                            
                   :DCLBQ76000T.AFVIKLINGS_ID                           
            FROM BQ76000T                                               
            WHERE TIL_EVS_AAR   = :DCLBQ76000T.TIL_EVS_AAR              
            AND   DCPRN         = :DCLBQ76000T.DCPRN                    
            AND   AFVIKLINGS_ID = :DCLBQ76000T.AFVIKLINGS_ID;           
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               CALL UPDATE_MANDTALSOPL;                                 
            END;                                                        
            WHEN(100) DO;                                               
               CALL INSERT_MANDTALSOPL;                                 
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 SELECT BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END INSERT_UPDATE_MANDTALSOPL;                                         
 /*********************************************************************/
 /* INSERT række på EVS UDTRÆK                                 RUTINE */
 /*********************************************************************/
 INSERT_MANDTALSOPL: PROC;                                              
                                                                        
         DCLBQ76000T = '';                                              
         DCLBQ76000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ76000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ76000T.DCPRN          = BH655.DCPRN;                      
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.DB2FUNKTION    = 'I';                              
         DCLBQ76000T.CCIVS          =   BH655.CCIVS;                    
         DCLBQ76000T.CPENS          =   BH655.CPENS;                    
         DCLBQ76000T.CRGN           =   BH655.CRGN;                     
         DCLBQ76000T.DSORP          =   BH655.DSORP;                    
         DCLBQ76000T.CPART          =   BH655.CPART;                    
         DCLBQ76000T.CFRÅR          =   BH655.CFRÅR;                    
         DCLBQ76000T.CFRÅROPR       =   BH655.CFRÅROPR;                 
         DCLBQ76000T.DRGNÅRFRA      =   BH655.DRGNÅRFRA;                
         DCLBQ76000T.DRGNÅRTIL      =   BH655.DRGNÅRTIL;                
         DCLBQ76000T.BPENSIND       =   BH655.BPENSIND;                 
         DCLBQ76000T.BPENSGR        =   BH655.BPENSGR;                  
         DCLBQ76000T.CSTATUS        =   BH655.CSTATUS;                  
         DCLBQ76000T.CDØDÆGTF       =   BH655.CDØDÆGTF;                 
         DCLBQ76000T.CDUBLET        =   BH655.CDUBLET;                  
         DCLBQ76000T.CÆGTF_OK       =   BH655.CÆGTF_OK;                 
         DCLBQ76000T.CFØRFORS       =   BH655.CFØRFORS;                 
         DCLBQ76000T.CFØRCOR        =   BH655.CFØRCOR;                  
         DCLBQ76000T.CFØRPENS       =   BH655.CFØRPENS;                 
         DCLBQ76000T.COVF_DHE       =   BH655.COVF_DHE;                 
         DCLBQ76000T.FØROPL_DCIÆN_GL =   BH655.FØROPL.DCIÆN_GL;         
         DCLBQ76000T.FØROPL_CCIVS_GL =   BH655.FØROPL.CCIVS_GL;         
         DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  =                          
                                    BH655.HIST_OPL.DHENVN(2015);        
         DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK   =                          
                                    BH655.HIST_OPL.CSBSK(2015);         
         DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT =                          
                                    BH655.HIST_OPL.CFØREFT(2015);       
         DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM =                          
                                    BH655.HIST_OPL.CSKPLOM(2015);       
         DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN   =                          
                                    BH655.HIST_OPL.DCIÆN(2015);         
         DCLBQ76000T.HIST_OPD_DETTE_DHENVN   =                          
                                    BH655.HIST_OPL.DHENVN(2016);        
         DCLBQ76000T.HIST_OPD_DETTE_CSBSK    =                          
                                    BH655.HIST_OPL.CSBSK(2016);         
         DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  =                          
                                    BH655.HIST_OPL.CFØREFT(2016);       
         DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  =                          
                                    BH655.HIST_OPL.CSKPLOM(2016);       
         DCLBQ76000T.HIST_OPD_DETTE_DCIÆN    =                          
                                    BH655.HIST_OPL.DCIÆN(2016);         
         DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  =                          
                                    BH655.HIST_OPL.DHENVN(2017);        
         DCLBQ76000T.HIST_OPD_NAESTE_CSBSK   =                          
                                    BH655.HIST_OPL.CSBSK(2017);         
         DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT =                          
                                    BH655.HIST_OPL.CFØREFT(2017);       
         DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM =                          
                                    BH655.HIST_OPL.CSKPLOM(2017);       
         DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN   =                          
                                    BH655.HIST_OPL.DCIÆN(2017);         
                                                                        
         EXEC SQL                                                       
            INSERT INTO BQ76000T                                        
            (                                                           
               TIL_EVS_AAR,                                             
               AFVIKLINGS_ID,                                           
               DCPRN,                                                   
               PROGRAMNAVN,                                             
               DB2FUNKTION,                                             
               CCIVS,                                                   
               CPENS,                                                   
               CRGN,                                                    
               DSORP,                                                   
               CPART,                                                   
               CFRÅR,                                                   
               CFRÅROPR,                                                
               DRGNÅRFRA,                                               
               DRGNÅRTIL,                                               
               BPENSIND,                                                
               BPENSGR,                                                 
               CSTATUS,                                                 
               CDØDÆGTF,                                                
               CDUBLET,                                                 
               CÆGTF_OK,                                                
               CFØRFORS,                                                
               CFØRCOR,                                                 
               CFØRPENS,                                                
               COVF_DHE,                                                
               FØROPL_DCIÆN_GL,                                         
               FØROPL_CCIVS_GL,                                         
               HIST_OPD_SIDSTE_DHENVN,                                  
               HIST_OPD_SIDSTE_CSBSK,                                   
               HIST_OPD_SIDSTE_CFØREFT,                                 
               HIST_OPD_SIDSTE_CSKPLOM,                                 
               HIST_OPD_SIDSTE_DCIÆN,                                   
               HIST_OPD_DETTE_DHENVN,                                   
               HIST_OPD_DETTE_CSBSK,                                    
               HIST_OPD_DETTE_CFØREFT,                                  
               HIST_OPD_DETTE_CSKPLOM,                                  
               HIST_OPD_DETTE_DCIÆN,                                    
               HIST_OPD_NAESTE_DHENVN,                                  
               HIST_OPD_NAESTE_CSBSK,                                   
               HIST_OPD_NAESTE_CFØREFT,                                 
               HIST_OPD_NAESTE_CSKPLOM,                                 
               HIST_OPD_NAESTE_DCIÆN                                    
            )                                                           
            values                                                      
            (                                                           
               :DCLBQ76000T.TIL_EVS_AAR,                                
               :DCLBQ76000T.AFVIKLINGS_ID,                              
               :DCLBQ76000T.DCPRN,                                      
               :DCLBQ76000T.PROGRAMNAVN,                                
               :DCLBQ76000T.DB2FUNKTION,                                
               :DCLBQ76000T.CCIVS,                                      
               :DCLBQ76000T.CPENS,                                      
               :DCLBQ76000T.CRGN,                                       
               :DCLBQ76000T.DSORP,                                      
               :DCLBQ76000T.CPART,                                      
               :DCLBQ76000T.CFRÅR,                                      
               :DCLBQ76000T.CFRÅROPR,                                   
               :DCLBQ76000T.DRGNÅRFRA,                                  
               :DCLBQ76000T.DRGNÅRTIL,                                  
               :DCLBQ76000T.BPENSIND,                                   
               :DCLBQ76000T.BPENSGR,                                    
               :DCLBQ76000T.CSTATUS,                                    
               :DCLBQ76000T.CDØDÆGTF,                                   
               :DCLBQ76000T.CDUBLET,                                    
               :DCLBQ76000T.CÆGTF_OK,                                   
               :DCLBQ76000T.CFØRFORS,                                   
               :DCLBQ76000T.CFØRCOR,                                    
               :DCLBQ76000T.CFØRPENS,                                   
               :DCLBQ76000T.COVF_DHE,                                   
               :DCLBQ76000T.FØROPL_DCIÆN_GL,                            
               :DCLBQ76000T.FØROPL_CCIVS_GL,                            
               :DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN,                     
               :DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK,                      
               :DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT,                    
               :DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM,                    
               :DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN,                      
               :DCLBQ76000T.HIST_OPD_DETTE_DHENVN,                      
               :DCLBQ76000T.HIST_OPD_DETTE_CSBSK,                       
               :DCLBQ76000T.HIST_OPD_DETTE_CFØREFT,                     
               :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM,                     
               :DCLBQ76000T.HIST_OPD_DETTE_DCIÆN,                       
               :DCLBQ76000T.HIST_OPD_NAESTE_DHENVN,                     
               :DCLBQ76000T.HIST_OPD_NAESTE_CSBSK,                      
               :DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT,                    
               :DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM,                    
               :DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN                       
            );                                                          
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_INS = ANT_INS + 1;                                   
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 INSERT BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END INSERT_MANDTALSOPL;                                                
 /*********************************************************************/
 /* UPDATE række på MT OPLYSNINGER                             RUTINE */
 /*********************************************************************/
 UPDATE_MANDTALSOPL: PROC;                                              
                                                                        
         DCLBQ76000T = '';                                              
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.DB2FUNKTION    = 'U';                              
         DCLBQ76000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ76000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ76000T.DCPRN          = BH655.DCPRN;                      
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.CCIVS          =   BH655.CCIVS;                    
         DCLBQ76000T.CPENS          =   BH655.CPENS;                    
         DCLBQ76000T.CRGN           =   BH655.CRGN;                     
         DCLBQ76000T.DSORP          =   BH655.DSORP;                    
         DCLBQ76000T.CPART          =   BH655.CPART;                    
         DCLBQ76000T.CFRÅR          =   BH655.CFRÅR;                    
         DCLBQ76000T.CFRÅROPR       =   BH655.CFRÅROPR;                 
         DCLBQ76000T.DRGNÅRFRA      =   BH655.DRGNÅRFRA;                
         DCLBQ76000T.DRGNÅRTIL      =   BH655.DRGNÅRTIL;                
         DCLBQ76000T.BPENSIND       =   BH655.BPENSIND;                 
         DCLBQ76000T.BPENSGR        =   BH655.BPENSGR;                  
         DCLBQ76000T.CSTATUS        =   BH655.CSTATUS;                  
         DCLBQ76000T.CDØDÆGTF       =   BH655.CDØDÆGTF;                 
         DCLBQ76000T.CDUBLET        =   BH655.CDUBLET;                  
         DCLBQ76000T.CÆGTF_OK       =   BH655.CÆGTF_OK;                 
         DCLBQ76000T.CFØRFORS       =   BH655.CFØRFORS;                 
         DCLBQ76000T.CFØRCOR        =   BH655.CFØRCOR;                  
         DCLBQ76000T.CFØRPENS       =   BH655.CFØRPENS;                 
         DCLBQ76000T.COVF_DHE       =   BH655.COVF_DHE;                 
         DCLBQ76000T.FØROPL_DCIÆN_GL =   BH655.FØROPL.DCIÆN_GL;         
         DCLBQ76000T.FØROPL_CCIVS_GL =   BH655.FØROPL.CCIVS_GL;         
         DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  =                          
                                    BH655.HIST_OPL.DHENVN(2015);        
         DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK   =                          
                                    BH655.HIST_OPL.CSBSK(2015);         
         DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT =                          
                                    BH655.HIST_OPL.CFØREFT(2015);       
         DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM =                          
                                    BH655.HIST_OPL.CSKPLOM(2015);       
         DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN   =                          
                                    BH655.HIST_OPL.DCIÆN(2015);         
         DCLBQ76000T.HIST_OPD_DETTE_DHENVN   =                          
                                    BH655.HIST_OPL.DHENVN(2016);        
         DCLBQ76000T.HIST_OPD_DETTE_CSBSK    =                          
                                    BH655.HIST_OPL.CSBSK(2016);         
         DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  =                          
                                    BH655.HIST_OPL.CFØREFT(2016);       
         DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  =                          
                                    BH655.HIST_OPL.CSKPLOM(2016);       
         DCLBQ76000T.HIST_OPD_DETTE_DCIÆN    =                          
                                    BH655.HIST_OPL.DCIÆN(2016);         
         DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  =                          
                                    BH655.HIST_OPL.DHENVN(2017);        
         DCLBQ76000T.HIST_OPD_NAESTE_CSBSK   =                          
                                    BH655.HIST_OPL.CSBSK(2017);         
         DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT =                          
                                    BH655.HIST_OPL.CFØREFT(2017);       
         DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM =                          
                                    BH655.HIST_OPL.CSKPLOM(2017);       
         DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN   =                          
                                    BH655.HIST_OPL.DCIÆN(2017);         
                                                                        
         /* PUT SKIP DATA (DCLBQ76000T); */                             
                                                                        
         EXEC SQL                                                       
            UPDATE BQ76000T                                             
            SET                                                         
             TIL_EVS_AAR             = :DCLBQ76000T.TIL_EVS_AAR,        
             AFVIKLINGS_ID           = :DCLBQ76000T.AFVIKLINGS_ID,      
             DCPRN                   = :DCLBQ76000T.DCPRN,              
             PROGRAMNAVN             = :DCLBQ76000T.PROGRAMNAVN,        
             DB2FUNKTION             = :DCLBQ76000T.DB2FUNKTION,        
             CCIVS                   = :DCLBQ76000T.CCIVS,              
             CPENS                   = :DCLBQ76000T.CPENS,              
             CRGN                    = :DCLBQ76000T.CRGN,               
             DSORP                   = :DCLBQ76000T.DSORP,              
             CPART                   = :DCLBQ76000T.CPART,              
             CFRÅR                   = :DCLBQ76000T.CFRÅR,              
             CFRÅROPR                = :DCLBQ76000T.CFRÅROPR,           
             DRGNÅRFRA               = :DCLBQ76000T.DRGNÅRFRA,          
             DRGNÅRTIL               = :DCLBQ76000T.DRGNÅRTIL,          
             BPENSIND                = :DCLBQ76000T.BPENSIND,           
             BPENSGR                 = :DCLBQ76000T.BPENSGR,            
             CSTATUS                 = :DCLBQ76000T.CSTATUS,            
             CDØDÆGTF                = :DCLBQ76000T.CDØDÆGTF,           
             CDUBLET                 = :DCLBQ76000T.CDUBLET,            
             CÆGTF_OK                = :DCLBQ76000T.CÆGTF_OK,           
             CFØRFORS                = :DCLBQ76000T.CFØRFORS,           
             CFØRCOR                 = :DCLBQ76000T.CFØRCOR,            
             CFØRPENS                = :DCLBQ76000T.CFØRPENS,           
             COVF_DHE                = :DCLBQ76000T.COVF_DHE,           
             FØROPL_DCIÆN_GL         = :DCLBQ76000T.FØROPL_DCIÆN_GL,    
             FØROPL_CCIVS_GL         = :DCLBQ76000T.FØROPL_CCIVS_GL,    
             HIST_OPD_SIDSTE_DHENVN  =                                  
                              :DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN,      
             HIST_OPD_SIDSTE_CSBSK   =                                  
                              :DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK,       
             HIST_OPD_SIDSTE_CFØREFT =                                  
                              :DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT,     
             HIST_OPD_SIDSTE_CSKPLOM =                                  
                              :DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM,     
             HIST_OPD_SIDSTE_DCIÆN   =                                  
                              :DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN,       
             HIST_OPD_DETTE_DHENVN   =                                  
                              :DCLBQ76000T.HIST_OPD_DETTE_DHENVN,       
             HIST_OPD_DETTE_CSBSK    =                                  
                              :DCLBQ76000T.HIST_OPD_DETTE_CSBSK,        
             HIST_OPD_DETTE_CFØREFT  =                                  
                              :DCLBQ76000T.HIST_OPD_DETTE_CFØREFT,      
             HIST_OPD_DETTE_CSKPLOM  =                                  
                              :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM,      
             HIST_OPD_DETTE_DCIÆN    =                                  
                              :DCLBQ76000T.HIST_OPD_DETTE_DCIÆN,        
             HIST_OPD_NAESTE_DHENVN  =                                  
                             :DCLBQ76000T.HIST_OPD_NAESTE_DHENVN,       
             HIST_OPD_NAESTE_CSBSK   =                                  
                             :DCLBQ76000T.HIST_OPD_NAESTE_CSBSK,        
             HIST_OPD_NAESTE_CFØREFT =                                  
                             :DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT,      
             HIST_OPD_NAESTE_CSKPLOM =                                  
                             :DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM,      
             HIST_OPD_NAESTE_DCIÆN   =                                  
                             :DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN         
                                                                        
            WHERE TIL_EVS_AAR   = :DCLBQ76000T.TIL_EVS_AAR              
            AND   AFVIKLINGS_ID = :DCLBQ76000T.AFVIKLINGS_ID            
            AND   DCPRN         = :DCLBQ76000T.DCPRN;                   
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_UPD = ANT_UPD + 1;                                   
            END;                                                        
            OTHERWISE DO;                                               
               PUT SKIP LIST ('DCLBQ76000T: ' !! DCLBQ76000T);          
               ABENDTXT = '101 UPDATE BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END UPDATE_MANDTALSOPL;                                                
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /*********************************************************************/
 /*      UDSKRIV KØRSELSKONTROLLISTE                                  */
 /*********************************************************************/
 KONTROLLISTE:                                                          
 PROC;                                                                  
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
                                                                        
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA   = ZZWS1;                                         
         DETLIN1.TEKST =                                                
         'ANTAL LÆSTE MANDTALSOPLYSNINGER PÅ B.H65500D';                
         DETLIN1.ANTAL = ANT_LÆS;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
         DETLIN1.TEKST =                                                
         'ANTAL SKREVNE MANDTALSOPLYSNINGER PÅ BQ76000T';               
         DETLIN1.ANTAL = ANT_SKR;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
         DETLIN1.TEKST =                                                
         '   HERAF NYE RÆKKER (INSERT)       ';                         
         DETLIN1.ANTAL = ANT_INS;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
         DETLIN1.TEKST =                                                
         '   HERAF OPDATEREDE RÆKKER (UPDATE)';                         
         DETLIN1.ANTAL = ANT_UPD;                                       
         CALL ZZ20300(DETLIN1,'01');                                    
                                                                        
 END KONTROLLISTE;                                                      
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL KONTROLLISTE;                                             
         CLOSE FILE (BH552I);                                           
         CLOSE FILE (BH655I);                                           
         CALL ZZ20300(' ','99');                                        
                                                                        
         CALL OPDATER_KØRSELSTABEL('SLUT',BH552_PARM.FS_MRK);           
                                                                        
 END AFSLUT;                                                            
 %INCLUDE BH54997M;     /* ER FORGÆNGERE KØRT. STOP HVIS IKKE */        
 %INCLUDE BH54998M; /* OPDATER KØRSELSTABEL */                          
 END BH55200;                                                           
