 BH20100: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS FORSKUD/SLUT                                       *
 * PROGRAMNAVN: BH20100.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    PROGRAMMET UDTRÆKKER ALLE AKTIVE OG VALIDE EJENDOMME   *
 *              FRA SIDSTE EVS FORSKUD                                 *
 * PGMFORLØB:   1. ÅBEN EVS UDTRÆKSFIL.                                *
 *              2. DECLARE PERSONEJENDOMSOPL.                          *
 *              3. OPEN PERSONEJENDOMSOPL.                             *
 *              4. LÆS/FETCH RÆKKE PÅ PERSONTABEL.                     *
 *              5. BEHANDL DATA TIL FILSTRUKTUR.                       *
 *              6. SKRIV RÆKKE PÅ EVS FIL.                             *
 *              7. LUK PERSONEJENDOMSOPL.                              *
 *              8. LUK EVS UDTRÆKSFIL.                                 *
 *              9. SKRIV KONTROLLISTE.                                 *
 * INDDATA:     BN00500T - EVS EJENDOMSTABEL.                          *
 *              BN00600T - EVS PERSONTABEL.                            *
 * UDDATA:      BQ77000T EVS UDTRÆKS TABEL                             *
 *              BH20101Y - KONTROLLISTE.                               *
 * KONSTRUKTØR: THOMAS FLINDT         THF, PUS/T&S BRØNDBY 16.07.2001. *
 ***********************************************************************
 * ÆNDRINGSLOG: HANS E KJELDSEN       HKS, PUS/T&S BRØNDBY 01.11.2001. *
 ***********************************************************************
 *              OLUF MØRK.            OMO, PUS/T&S BRØNDBY 20.06.2002. *
 *              ÅRSRULNING.                                            *
 ***********************************************************************
 *              ESBEN BRODERSEN       ESB, PUS/T&S BRØNDBY 30.07.2002. *
 *              TILRETTET TIL FORSKUD  2003                            *
 ***********************************************************************
 *              ESBEN BRODERSEN       ESB, LSU/T&S BRØNDBY 14.11.2002. *
 *              TILRETTET TIL EVS-SLUT 2002                            *
 ***********************************************************************
 *              ESBEN BRODERSEN       ESB, LSU/T&S BALLERUP 30.07.2003.*
 *              TILRETTET TIL FORSKUD  2004                            *
 ***********************************************************************
 *              BO SCHMIDT            BOB, LSU/T&S BALLERUP 09.06.2004.*
 *              TILRETTET TIL FORSKUD  2006                            *
 ***********************************************************************
 * FORSKUD06    SUSANNE KROGH VILLUMSEN  SKV   T&S BALLERUP 25.05.2005.*
 *              TILRETTET TIL FORSKUD  2006                            *
 ********************************************************************** 
 * *SLUT05*     SUSANNE KROGH VILLUMSEN SKV,  T&S BALLERUP 07.11.2005. *
 *             -PROGRAMMET ER TILRETTET TIL SLUT 2005                  *
 *              KONVERTERING AF ÆRØ KOMMUNE.  KMNR 443 OG 492  TIL 443 *
 ********************************************************************** 
 * FORSKUD07    BO SCHMIDT               BOB   T&S BALLERUP 11.05.2006.*
 *              TILRETTET TIL FORSKUD  2007                            *
 ********************************************************************** 
 * FORSKUD08    BO SCHMIDT               BOB   T&S BALLERUP 23.05.2007.*
 *              TILRETTET TIL FORSKUD  2008                            *
 ********************************************************************** 
 * FORSKUD09    BO SCHMIDT               BOB   T&S BALLERUP 24.04.2008.*
 *              TILRETTET TIL FORSKUD  2009                            *
 ********************************************************************** 
 * FORSKUD10    GERD HOLM-PEDERSEN       GEH   PKF/PKA      07.04.2009.*
 *              TILRETTET TIL FORSKUD  2010                            *
 *              NYE FELTER, BBERGRL OG BBER2FAM         KRAVNR.#06-02  *
 *              NYT FELT    CEKSEMP.                    KRAVNR.#09-04  *
 ********************************************************************** 
 * FORSKUD11    GERD HOLM-PEDERSEN       GEH   PKF/PKA      28.05.2010.*
 *              TILRETTET TIL FORSKUD  2011                            *
 ********************************************************************** 
 * FORSKUD12    GERD HOLM-PEDERSEN       GEH   PR           16.05.2011.*
 *              TILRETTET TIL FORSKUD  2012                            *
 ********************************************************************** 
 * FORSKUD13    ESBEN BRODERSEN          ESB   PR           15.05.2012.*
 *              TILRETTET TIL FORSKUD  2013                            *
 *              DEFECT #521 BUDLSKC FELT 910 HENTES FRA TABEL BN00600T *
 ********************************************************************** 
 * FORSKUD14    ESBEN BRODERSEN          ESB   PR           21.05.2013.*
 *              TILRETTET TIL FORSKUD  2014                            *
 ********************************************************************** 
 * FORSKUD15    JØRGEN SAUGMANN          QQS   PR           27.06.2014.*
 *              TILRETTET TIL FORSKUD  2015                            *
 ***********************************************************************
 * FORSKUD16    JENS HOLGER KJÆR         JNK                08.06.2015.*
 *              ÅRSRULLET TIL FORSKUD  2016                            *
 ***********************************************************************
 * SLUT15       ESBEN BRODERSEN        Z8QEB                09.03.2015 *
 *              INDFØRT ÅRTALS/DATO INCLUDE BH65300M  #01              *
 ***********************************************************************
 * FORSKUD17    ESBEN BRODERSEN          QEB   PR           08.06.2016.*
 *              TILRETTET TIL FORSKUD  2017                            *
 *              KS30-01 justeret behandling af CSLET                   *
 *              RETTELSE DEN 19.09.2016 CSLET MED I FETCH #01          *
 * OPRETTET SOM KOPI AF BH30100 TIL DB2 OMLÆGNING AF BEREGNINGS BÅND   *
 * FORSKUD18    ESBEN BRODERSEN          QEB   PR           06.06.2017.*
 *              TILRETTET TIL FORSKUD  2018                            *
 **********************************************************************/
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KMD A/S 2017');            
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE BN00500T;        /* EVS EJENDOMSTABELLEN */   
         EXEC SQL INCLUDE BN00600T;        /* EVS PERSONTABELLEN   */   
         EXEC SQL INCLUDE BN03300T;        /* LANDEKODE TABELLEN   */   
                                                                        
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
 /**********************************************************************
 * DECLARE AF ABEND RUTINE                                             *
 **********************************************************************/
                                                                        
 DCL     ZS30101        ENTRY;                                          
 DCL     ZS67000        ENTRY;                                          
 DCL     ZS61900        ENTRY;                        /* KST/SSI INFO */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
                                                                        
 DCL     HJ_DCPRN       CHAR (10);                                      
 DCL     HJ_DCPRN_PIC   PIC  '(10)9' BASED(ADDR(HJ_DCPRN));             
 DCL     HJ_EKOMNR      CHAR (03);                                      
 DCL     HJ_EEJDNR      CHAR (06);                                      
 DCL     EKOMEEJD_NR    CHAR (09);                                      
 DCL     OK             CHAR (01)        INIT('J');                     
 DCL     FEJLTEKST      CHAR (20)        INIT(' ');                     
 DCL     GEM_EEJDNR     BIN FIXED (31) INIT(0);                         
 DCL     GEM_DCPRN      FIXED (11) INIT(0);                             
 DCL     SW_FDAGEJ_NUL  BIT(01)    INIT('0'B);                          
 DCL     FETCH_SQLKODE  FIXED BIN(15)    INIT(0);                       
                                                                        
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH20100'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
                                                                        
 DCL     ANT_INS        BIN FIXED (31) INIT(0);                         
 DCL     ANT_COMM       BIN FIXED (31) INIT(0);                         
 DCL     ANT_UPDATE     BIN FIXED (31) INIT(0);                         
                                                                        
 DCL     DT             CHAR (6);                                       
 DCL     1 DAT          BASED(ADDR(DT)),                                
           2 ÅR         PIC   '99',                                     
           2 MD         PIC   '99',                                     
           2 DAG        PIC   '99';                                     
                                                                        
 DCL     HJ_DATOEN      PIC '(8)9';                                     
 DCL     1 HJ_DATO      BASED(ADDR(HJ_DATOEN)),                         
           2 AAR        PIC  '9999',                                    
           2 MD         PIC  '99',                                      
           2 DG         PIC  '99';                                      
                                                                        
 DCL     1 BH65300M,                             /*#01*/                
           %INCLUDE BH65300M;                    /* DATO OG ÅR MACRO */ 
                                                                        
 DCL     WS_FORSKUD_SLUT_TXT            CHAR(16) INIT (' ');            
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
 DCL     WS_GLSLUTÅR                    BIN FIXED (15);                 
 DCL     WS_PROGRAMNAVN                 CHAR(8)  INIT ('BH20100');      
 DCL     WS_DB2FUNKTION                 CHAR(1);                        
 DCL     JA                             BIT(1)   INIT('1'B);            
 DCL     NEJ                            BIT(1)   INIT('0'B);            
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     SYSPRINT FILE STREAM PRINT;                                    
                                                                        
 /*********************************************************************/
 /* DECLARE STRUKTURER                                                */
 /*********************************************************************/
                                                                        
 DCL     1 UDTRÆK_FORS,                                                 
           %INCLUDE BH30100N;;                                          
                                                                        
 DCL     1 INDK_PERS,                                                   
           2 BNYMAN_I       BIN FIXED (15);                             
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     (ADDR,DATE,VERIFY,NULL,MOD,SUBSTR,PLIDUMP) BUILTIN;            
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANTLÆS_PERSON   BIN FIXED (31) INIT(0);/* LÆSTE PERSONTABEL  */
 DCL     ANTSKRIV_PERSON BIN FIXED (31) INIT(0);/* SKREVET UDTRÆKSFIL */
 DCL     ANTSKRIV_ØVR    BIN FIXED (31) INIT(0);/* SKREVET EXCL UDLAND*/
 DCL     ANTSKRIV_UDL    BIN FIXED (31) INIT(0);/* SKREVET KUN  UDLAND*/
 DCL     ANTCEJBEVS_9    BIN FIXED (31) INIT(0);/* CEJBEVS=9(SLETTET) */
 DCL     ANTCSLET_1      BIN FIXED (31) INIT(0);/* CSLET=1(SLETTET)   */
 DCL     ANTEJENDOM_0    BIN FIXED (31) INIT(0);/* EEJDNR =0          */
 DCL     ANTEJENDOM      BIN FIXED (31) INIT(0);/* HJÆLPE FELT        */
 DCL     SQLKODE         PIC '9999';                                    
 DCL     TV_SUMMERET      BIN FIXED (31) INIT(0);/* ANTAL SUMMERET    */
 DCL     TV_IKKE_SUMMERET BIN FIXED (31) INIT(0);/*ANTAL IKKE SUMMERET*/
 DCL     TV_STOR_FDAGIALT BIN FIXED (31) INIT(0);/*ANTAL FDAGIALT>360 */
                                                                        
 DCL     TFLAG            BIT(1)         INIT('0'B);                    
                                                                        
 /*********************************************************************/
 /* PARM KORT                                                         */
 /*********************************************************************/
  DCL     EOF_PARM         BIT (1) INIT ('0'B);                         
                                                                        
  DCL     PARMKORT         FILE RECORD INPUT;                           
                                                                        
  DCL     PARM_AR          CHAR  (80)  INIT (' ');                      
  DCL     PARM_MEDTAGET    BIT (1)       INIT ('0'B);                   
  DCL     PARM_FEJL        BIT (1)       INIT ('0'B);                   
                                                                        
  DCL     1 PARMLINIE  BASED (ADDR (PARM_AR) ),                         
            2 PARMSTART    CHAR      (02),                              
            2 PROGNAVN     CHAR      (07),                              
            2 KOMNR1       CHAR      (03),                              
            2 KOMNR2       CHAR      (03),                              
            2 KOMNR3       CHAR      (03),                              
            2 REST         CHAR      (62);                              
                                                                        
  DCL     PARMKOMNR1     BIN FIXED (15);                                
  DCL     PARMKOMNR2     BIN FIXED (15);                                
  DCL     PARMKOMNR3     BIN FIXED (15);                                
                                                                        
 /*********************************************************************/
 /* PARM FIL(IKKE SAMME FIL SOM PARMKORT)                             */
 /*********************************************************************/
  DCL     EOF_PARMFIL     BIT (1) INIT ('0'B);                          
  DCL     BH20100P        FILE RECORD INPUT;                            
                                                                        
  DCL     1 AFVIKLING_PARM,                                             
           %INCLUDE BH54900N;                                           
                                                                        
         ON ENDFILE (BH20100P)                                          
         BEGIN;                                                         
            EOF_PARMFIL = JA;                                           
         END;                                                           
                                                                        
 /*********************************************************************/
 /* PRINTLINIER TIL SPOOL                                             */
 /*********************************************************************/
                                                                        
 DCL     LINIE           CHAR (133);                                    
 DCL     1 LIN           BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 FIL1        CHAR (3),                                      
           2 TEKST       CHAR (56),                                     
           2 ANT         PIC  '---------9',                             
           2 FIL2        CHAR (63);                                     
 DCL     1 LIN2          BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 FIL1        CHAR (21),                                     
           2 TEKST       CHAR (111);                                    
         %INCLUDE ZZ20301M;                                             
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SBHO','MODUL BH20100');                 
            END;                                                        
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
         PERSONEJENDOMSOPL = '';                                        
         EJENDOMSOPL = '';                                              
         UDTRÆK_FORS = '';                                              
         UDTRÆK_FORS.BFORSKAT_SW = -1;                                  
         DT = DATE;                                                     
                                                                        
         CALL ZZ20390('*OPEN','BH20101Y');       /* ÅBEN KONTROLLISTE */
                                                                        
         CALL ZS61900;                              /* KST/SSI INFO   */
                                                                        
         CALL OPSTART_INIT;                        /*Parmkort*/         
                                                                        
         OPEN FILE (BH20100P) TITLE ('BH20100P');                       
                                                                        
                                                                        
                                                                        
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
         READ FILE (BH20100P) INTO (AFVIKLING_PARM);                    
                                                                        
         IF EOF_PARMFIL = NEJ                                           
         THEN DO;                                                       
            IF AFVIKLING_PARM.FS_MRK = 'F'                              
            THEN DO;                                                    
               WS_FORSKUD_SLUT_TXT = AFVIKLING_PARM.FORSKUD_TXT;        
               WS_TIL_EVS_AAR = BH65300M.FORSKÅR;                       
            END;                                                        
            ELSE DO;                                                    
               WS_FORSKUD_SLUT_TXT = AFVIKLING_PARM.SLUT_TXT;           
               WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                        
            END;                                                        
         END;                                                           
         ELSE DO;                                                       
             PUT SKIP LIST ('BH20100P PARMFIL MANGLER ');               
             ABENDTXT = '101 PARMFIL MANGLER';                          
             CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);             
         END;                                                           
                                                                        
         /********************************************************/     
         /*  CHECK OM FORGÆNGERE ER KØRT                         */     
         /********************************************************/     
         CALL CHECK_SEKVENS (AFVIKLING_PARM.FS_MRK); /* BH54997M */     
                                                                        
         /********************************************************/     
         /*  NU STARTER CHECK AF OMKØRSEL                        */     
         /********************************************************/     
         CALL CHECK_OM_OMKØRSEL; /* kode ligger i macro BH54999M */     
         IF DER_SKAL_KØRES_OM                                           
         THEN DO;                                                       
            PUT SKIP LIST ('Omkørsel af ' !! WS_PROGRAMNAVN);           
            CALL RYD_OP_FØR_OMKØRSEL;                                   
         END;                                                           
         ELSE DO;                                                       
            PUT SKIP LIST ('Normal kørsel af ' !! WS_PROGRAMNAVN);      
         END;                                                           
                                                                        
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL('START',AFVIKLING_PARM.FS_MRK);      
                 /* BH54998M */                                         
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         CALL DECLARE_PERSONEJENDOMSOPL;                                
         CALL OPEN_PERSONEJENDOMSOPL;                                   
         CALL FETCH_PERSONEJENDOMSOPL;                                  
                                                                        
         SELECT (FETCH_SQLKODE);  /*GEMT SQLCODE FRA FETCH_PERSONEJ. */ 
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               GEM_EEJDNR = PERSONEJENDOMSOPL.EEJDNR;                   
               GEM_DCPRN  = PERSONEJENDOMSOPL.PERSONNUMMER;             
               DO WHILE (FETCH_SQLKODE = 0);                            
                  CALL BEHANDL_OG_SKRIV;                                
                  CALL FETCH_PERSONEJENDOMSOPL;                         
               END;                                                     
             END;                                                       
                                                                        
           WHEN (100)                                                   
               PUT SKIP LIST ('INGEN RÆKKER LÆST');                     
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'FETCH PERSON_CURSOR ';                     
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF PERSONTABEL BN00600T                RUTINE */
 /*********************************************************************/
 OPEN_PERSONEJENDOMSOPL: PROC;                                          
                                                                        
         EXEC SQL OPEN PERSON_CURSOR;                                   
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN PERSON_CURSOR';                         
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_PERSONEJENDOMSOPL;                                            
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF PERSONTABEL BN00600T               RUTINE */
 /*********************************************************************/
 CLOSE_PERSONEJENDOMSOPL: PROC;                                         
                                                                        
         EXEC SQL CLOSE PERSON_CURSOR;                                  
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE PERSON_CURSOR';                        
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_PERSONEJENDOMSOPL;                                           
 /*********************************************************************/
 /* BEHANDL OG SKRIV EVS OPLYSNINGER                           RUTINE */
 /*********************************************************************/
 BEHANDL_OG_SKRIV: PROC;                                                
                                                                        
         IF PERSONEJENDOMSOPL.EKOMNR ^= 999       /*FORSKUD09*/         
          & PERSONEJENDOMSOPL.CEJBEVS = '9'                             
         THEN                                                           
            DO;                                                         
               ANTCEJBEVS_9 = ANTCEJBEVS_9 + 1;                         
               RETURN;                                                  
            END;                                                        
                                                                        
         IF PERSONEJENDOMSOPL.EEJDNR = 0                                
         THEN                                                           
            DO;                                                         
               ANTEJENDOM_0 = ANTEJENDOM_0 + 1;                         
               RETURN;                                                  
            END;                                                        
                                                                        
         /* Ændret behandling i forbindelse med Forskud 2017     */     
         /* Der trækkes nu ud på CSLET = 1 men kun til optælling */     
         /* KS30-01                                              */     
         IF PERSONEJENDOMSOPL.CSLET = '1'                               
         THEN                                                           
            DO;                                                         
               ANTCSLET_1 = ANTCSLET_1 + 1;                             
               RETURN;                                                  
            END;                                                        
                                                                        
         IF GEM_EEJDNR ^= PERSONEJENDOMSOPL.EEJDNR                      
          ! GEM_DCPRN  ^= PERSONEJENDOMSOPL.PERSONNUMMER                
         THEN                                                           
           DO;                                                          
             ANTSKRIV_PERSON = ANTSKRIV_PERSON + 1;                     
                                                                        
             IF ANTEJENDOM = 1                                          
             THEN                                                       
                UDTRÆK_FORS.CEVSSUM = ' ';                              
                                                                        
             IF SW_FDAGEJ_NUL = '1'B  & UDTRÆK_FORS.CEVSSUM = '1'       
             THEN                                                       
                UDTRÆK_FORS.CEVSSUM = '2'; /* TIL PERIODE OPDELING    */
                                           /* ESB OG AAR EVS SLUT 2002*/
                                                                        
             IF UDTRÆK_FORS.EKOMNR ^= 999                               
             THEN                                                       
                DO;                                                     
                   ANTSKRIV_ØVR = ANTSKRIV_ØVR + 1;                     
                   CALL SKRIV_TIL_BQ77000T;                             
                END;                                                    
             ELSE                                                       
                DO;                                                     
                   ANTSKRIV_UDL = ANTSKRIV_UDL + 1;                     
                   CALL SKRIV_TIL_BQ77000T;                             
                END;                                                    
                                                                        
             /* SKRIV TIL TABEL*/                                       
             CALL SKRIV_TIL_BQ77000T;                                   
                                                                        
             GEM_EEJDNR = PERSONEJENDOMSOPL.EEJDNR;                     
             GEM_DCPRN  = PERSONEJENDOMSOPL.PERSONNUMMER;               
             IF FDAGIALT > 360 THEN                                     
               TV_STOR_FDAGIALT = TV_STOR_FDAGIALT + 1;                 
             SW_FDAGEJ_NUL = '0'B;                                      
             UDTRÆK_FORS = '';                                          
             UDTRÆK_FORS.BFORSKAT_SW = -1;                              
             ANTEJENDOM = 0;                                            
           END;                                                         
                                                                        
         CALL OVERFØRDATA;                                              
                                                                        
 END BEHANDL_OG_SKRIV;                                                  
 /*********************************************************************/
 /* OVERFØRDATA                                                RUTINE */
 /*********************************************************************/
 OVERFØRDATA: PROC;                                                     
                                                                        
         HJ_DATOEN = PERSONEJENDOMSOPL.DOVTG;                           
                                                                        
         IF HJ_DATOEN = 0                                               
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            DO;                                                         
              HJ_DATO.MD = 01;                                          
              HJ_DATO.DG = 01;                                          
            END;                                                        
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            HJ_DATO.DG = 01;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            HJ_DATO.DG = 31;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            HJ_DATO.DG = 30;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            HJ_DATO.DG = 29;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            HJ_DATO.DG = 28;                                            
                                                                        
         PERSONEJENDOMSOPL.DOVTG = HJ_DATOEN;                           
                                                                        
                                                                        
         HJ_DATOEN = PERSONEJENDOMSOPL.DAFSTAA;                         
                                                                        
         IF HJ_DATOEN = 0                                               
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            DO;                                                         
              HJ_DATO.MD = 12;                                          
              HJ_DATO.DG = 31;                                          
            END;                                                        
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            HJ_DATO.DG = 01;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            HJ_DATO.DG = 31;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            HJ_DATO.DG = 30;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            HJ_DATO.DG = 29;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            HJ_DATO.DG = 28;                                            
                                                                        
         PERSONEJENDOMSOPL.DAFSTAA = HJ_DATOEN;                         
                                                                        
                                                                        
         HJ_DATOEN = PERSONEJENDOMSOPL.DATO0107;                        
                                                                        
         IF HJ_DATOEN = 0                                               
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            DO;                                                         
              HJ_DATO.MD = 01;                                          
              HJ_DATO.DG = 01;                                          
            END;                                                        
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            HJ_DATO.DG = 01;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            HJ_DATO.DG = 31;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            HJ_DATO.DG = 30;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            HJ_DATO.DG = 29;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            HJ_DATO.DG = 28;                                            
                                                                        
         PERSONEJENDOMSOPL.DATO0107 = HJ_DATOEN;                        
                                                                        
                                                                        
         HJ_DATOEN = PERSONEJENDOMSOPL.DINDFLYT;                        
                                                                        
         IF HJ_DATOEN = 0                                               
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            DO;                                                         
              HJ_DATO.MD = 01;                                          
              HJ_DATO.DG = 01;                                          
            END;                                                        
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            HJ_DATO.DG = 01;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            HJ_DATO.DG = 31;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            HJ_DATO.DG = 30;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            HJ_DATO.DG = 29;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            HJ_DATO.DG = 28;                                            
                                                                        
         PERSONEJENDOMSOPL.DINDFLYT = HJ_DATOEN;                        
                                                                        
                                                                        
         HJ_DATOEN = PERSONEJENDOMSOPL.DFRAFLYT;                        
                                                                        
         IF HJ_DATOEN = 0                                               
         THEN;                                                          
         ELSE                                                           
         IF HJ_DATO.MD < 01                                             
          ! HJ_DATO.MD > 12                                             
         THEN                                                           
            DO;                                                         
              HJ_DATO.MD = 12;                                          
              HJ_DATO.DG = 31;                                          
            END;                                                        
         ELSE                                                           
         IF HJ_DATO.DG < 01                                             
         THEN                                                           
            HJ_DATO.DG = 01;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 31                                             
          & (HJ_DATO.MD = 01 !                                          
             HJ_DATO.MD = 03 !                                          
             HJ_DATO.MD = 05 !                                          
             HJ_DATO.MD = 07 !                                          
             HJ_DATO.MD = 08 !                                          
             HJ_DATO.MD = 10 !                                          
             HJ_DATO.MD = 12)                                           
         THEN                                                           
            HJ_DATO.DG = 31;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 30                                             
          & (HJ_DATO.MD = 04 !                                          
             HJ_DATO.MD = 06 !                                          
             HJ_DATO.MD = 09 !                                          
             HJ_DATO.MD = 11)                                           
         THEN                                                           
            HJ_DATO.DG = 30;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 29                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) = 0                                      
         THEN                                                           
            HJ_DATO.DG = 29;                                            
         ELSE                                                           
         IF HJ_DATO.DG > 28                                             
          & HJ_DATO.MD = 02                                             
          & MOD(HJ_DATO.AAR,4) > 0                                      
         THEN                                                           
            HJ_DATO.DG = 28;                                            
                                                                        
         PERSONEJENDOMSOPL.DFRAFLYT = HJ_DATOEN;                        
                                                                        
         ANTEJENDOM = ANTEJENDOM + 1;                                   
         UDTRÆK_FORS.DCPRN         = PERSONEJENDOMSOPL.PERSONNUMMER;    
         UDTRÆK_FORS.EKOMNR        = PERSONEJENDOMSOPL.EKOMNR;          
         UDTRÆK_FORS.EEJDNR        = PERSONEJENDOMSOPL.EEJDNR;          
         UDTRÆK_FORS.EJDBELIG      = EJENDOMSOPL.EJDBELIG;              
         UDTRÆK_FORS.BBERGRL       = PERSONEJENDOMSOPL.BBERGRL;         
         UDTRÆK_FORS.BBER2FAM      = PERSONEJENDOMSOPL.BBER2FAM;        
                                                                        
         IF PERSONEJENDOMSOPL.EKOMNR = 999                              
         THEN                                                           
            UDTRÆK_FORS.CLANDEKODE    = EJENDOMSOPL.LANDEKODE;          
         ELSE                                                           
            UDTRÆK_FORS.CLANDEKODE    = '';                             
                                                                        
         UDTRÆK_FORS.CFRATYPE      = '4';                               
         IF PERSONEJENDOMSOPL.DAFSTAA > 0                               
         THEN                                                           
            UDTRÆK_FORS.DSORTDAT1  = PERSONEJENDOMSOPL.DAFSTAA;         
         ELSE                                                           
            UDTRÆK_FORS.DSORTDAT1  = 99991231;                          
         UDTRÆK_FORS.DSORTDAT2     = PERSONEJENDOMSOPL.DOVTG;           
         UDTRÆK_FORS.ELBNR         = PERSONEJENDOMSOPL.ELBNR;           
         UDTRÆK_FORS.DFRAGLD       = PERSONEJENDOMSOPL.DFRAGLD;         
         UDTRÆK_FORS.DTILGLD       = PERSONEJENDOMSOPL.DTILGLD;         
         UDTRÆK_FORS.CEVSBENY      = PERSONEJENDOMSOPL.CEVSBENY;        
         UDTRÆK_FORS.CEJBEVS       = PERSONEJENDOMSOPL.CEJBEVS;         
         UDTRÆK_FORS.COPR_CEJBEVS  = PERSONEJENDOMSOPL.COPR_CEJBEVS;    
         UDTRÆK_FORS.CEJDTYPE      = PERSONEJENDOMSOPL.CEJDTYPE;        
         UDTRÆK_FORS.CFRED         = PERSONEJENDOMSOPL.CFRED;           
         UDTRÆK_FORS.CNEDSL1       = PERSONEJENDOMSOPL.CNEDSL1;         
         UDTRÆK_FORS.DATO0107      = PERSONEJENDOMSOPL.DATO0107;        
         UDTRÆK_FORS.DOVTG         = PERSONEJENDOMSOPL.DOVTG;           
         IF ANTEJENDOM = 1                                              
         THEN                                                           
            UDTRÆK_FORS.DOVTG_GL   = PERSONEJENDOMSOPL.DOVTG;           
         UDTRÆK_FORS.DAFSTAA       = PERSONEJENDOMSOPL.DAFSTAA;         
         UDTRÆK_FORS.DINDFLYT      = PERSONEJENDOMSOPL.DINDFLYT;        
         UDTRÆK_FORS.DFRAFLYT      = PERSONEJENDOMSOPL.DFRAFLYT;        
         UDTRÆK_FORS.GPCTEJER      = PERSONEJENDOMSOPL.GPCTEJER;        
         UDTRÆK_FORS.FDAGUDLE      = PERSONEJENDOMSOPL.FDAGUDLE;        
         UDTRÆK_FORS.GPCTUDLE      = PERSONEJENDOMSOPL.GPCTUDLE;        
         UDTRÆK_FORS.FDAGERHV      = PERSONEJENDOMSOPL.FDAGERHV;        
         UDTRÆK_FORS.GPCTERHV      = PERSONEJENDOMSOPL.GPCTERHV;        
         UDTRÆK_FORS.BPROM1        = PERSONEJENDOMSOPL.BPROM1;          
         UDTRÆK_FORS.BUDLSKC   = PERSONEJENDOMSOPL.BUDLSKC; /*DEF #521*/
                                                                        
         IF PERSONEJENDOMSOPL.CEJBEVS = '0' !                           
            PERSONEJENDOMSOPL.CEJBEVS = '4' !                           
            PERSONEJENDOMSOPL.CEJBEVS = '5'                             
         THEN                                                           
            DO;                                                         
               UDTRÆK_FORS.BBRUTTO_SW = 0;                              
               UDTRÆK_FORS.BBRUTTO    = PERSONEJENDOMSOPL.BBRUTTO;      
            END;                                                        
         ELSE                                                           
            DO;                                                         
               UDTRÆK_FORS.BBRUTTO_SW = -1;                             
               UDTRÆK_FORS.BBRUTTO    = 0;                              
            END;                                                        
                                                                        
         UDTRÆK_FORS.CENKE      = PERSONEJENDOMSOPL.CENKE;              
         UDTRÆK_FORS.FDAGEJ     = PERSONEJENDOMSOPL.FDAGEJ;/* ESB */    
                                                                        
         UDTRÆK_FORS.CEKSEMP    = PERSONEJENDOMSOPL.CEKSEMP;  /*#09-04*/
         UDTRÆK_FORS.COPR_EKSEMP =                                      
                               PERSONEJENDOMSOPL.COPR_EKSEMP; /*#09-04*/
                                                                        
         IF INDK_PERS.BNYMAN_I = 0                                      
         THEN                                                           
            DO;                                                         
               UDTRÆK_FORS.BNYMAN_SW = 0;                               
               UDTRÆK_FORS.BNYMAN = PERSONEJENDOMSOPL.BNYMAN;           
            END;                                                        
         ELSE                                                           
            DO;                                                         
               UDTRÆK_FORS.BNYMAN_SW = -1;                              
               UDTRÆK_FORS.BNYMAN = 0;                                  
            END;                                                        
                                                                        
         IF PERSONEJENDOMSOPL.CEJBEVS = '0' !                           
            PERSONEJENDOMSOPL.CEJBEVS = '4' !                           
            PERSONEJENDOMSOPL.CEJBEVS = '5'                             
         THEN                                                           
            DO;                                                         
               UDTRÆK_FORS.B100_SW = 0;                                 
               UDTRÆK_FORS.B100 = PERSONEJENDOMSOPL.B100;               
            END;                                                        
         ELSE                                                           
            DO;                                                         
               UDTRÆK_FORS.B100_SW = -1;                                
               UDTRÆK_FORS.B100 = 0;                                    
            END;                                                        
                                                                        
         IF PERSONEJENDOMSOPL.BEJERAN > 0      &                        
            (PERSONEJENDOMSOPL.CEJBEVS = '0'   !                        
             PERSONEJENDOMSOPL.CEJBEVS = '4'   !                        
             PERSONEJENDOMSOPL.CEJBEVS = '5')  &                        
            (PERSONEJENDOMSOPL.GPCTEJER > 0    &                        
             PERSONEJENDOMSOPL.GPCTEJER < 10000)                        
         THEN                                                           
            DO;                                                         
               UDTRÆK_FORS.BEJERAN_SW = 0;                              
               UDTRÆK_FORS.BEJERAN = PERSONEJENDOMSOPL.BEJERAN;         
            END;                                                        
         ELSE                                                           
            DO;                                                         
               UDTRÆK_FORS.BEJERAN_SW = -1;                             
               UDTRÆK_FORS.BEJERAN = 0;                                 
            END;                                                        
                                                                        
         SELECT;                                                        
         WHEN (BNYMAN_SW = 0                      &                     
               PERSONEJENDOMSOPL.CEJBEVS  ^= '9'  & /*BEHOLD SOM INFO */
               PERSONEJENDOMSOPL.CEVSBENY  = '0'  &                     
               (PERSONEJENDOMSOPL.CEJBEVS  = 'A'  !                     
                PERSONEJENDOMSOPL.CEJBEVS  = '6'))                      
            DO;                                                         
               UDTRÆK_FORS.BFORSKAT = UDTRÆK_FORS.BFORSKAT +            
                                      UDTRÆK_FORS.BNYMAN;               
               UDTRÆK_FORS.BFORSKAT_SW = 0;                             
               UDTRÆK_FORS.CEVSSUM = '1';                               
               UDTRÆK_FORS.FDAGIALT = FDAGIALT + UDTRÆK_FORS.FDAGEJ;    
               IF UDTRÆK_FORS.FDAGEJ = 0                                
               THEN                                                     
                  SW_FDAGEJ_NUL = '1'B;                                 
               TV_SUMMERET = TV_SUMMERET + 1;                           
            END;                                                        
         WHEN (BEJERAN_SW = 0                     &                     
               PERSONEJENDOMSOPL.CEVSBENY  = '0'  &                     
               PERSONEJENDOMSOPL.CEJBEVS  ^= '9') /*BEHOLDES SOM INFO*/ 
            DO;                                                         
               UDTRÆK_FORS.BFORSKAT = UDTRÆK_FORS.BFORSKAT +            
                                         + PERSONEJENDOMSOPL.BEJERAN;   
               UDTRÆK_FORS.BFORSKAT_SW = 0;                             
               UDTRÆK_FORS.CEVSSUM = '1';                               
               UDTRÆK_FORS.FDAGIALT = FDAGIALT + UDTRÆK_FORS.FDAGEJ;    
               IF UDTRÆK_FORS.FDAGEJ = 0                                
               THEN                                                     
                  SW_FDAGEJ_NUL = '1'B;                                 
               TV_SUMMERET = TV_SUMMERET + 1;                           
            END;                                                        
         WHEN (B100_SW = 0                         &                    
               PERSONEJENDOMSOPL.CEVSBENY  = '0'   &                    
               PERSONEJENDOMSOPL.CEJBEVS  ^= '9') /*BEHOLDES SOM INFO*/ 
            DO;                                                         
               UDTRÆK_FORS.BFORSKAT = UDTRÆK_FORS.BFORSKAT +            
                                         + PERSONEJENDOMSOPL.B100;      
               UDTRÆK_FORS.BFORSKAT_SW = 0;                             
               UDTRÆK_FORS.CEVSSUM = '1';                               
               UDTRÆK_FORS.FDAGIALT = FDAGIALT + UDTRÆK_FORS.FDAGEJ;    
               IF UDTRÆK_FORS.FDAGEJ = 0                                
               THEN                                                     
                  SW_FDAGEJ_NUL = '1'B;                                 
               TV_SUMMERET = TV_SUMMERET + 1;                           
            END;                                                        
         OTHERWISE                                                      
            TV_IKKE_SUMMERET = TV_IKKE_SUMMERET + 1;                    
         END; /*SELECT*/                                                
                                                                        
                                                                        
 END OVERFØRDATA;                                                       
 /*********************************************************************/
 OPSTART_INIT: PROC;                                                    
                                                                        
   DCL     HJ_KOMNR     PIC '(03)9';                                    
                                                                        
   /* PARMKORT ER EVT. MEDTAGET I KØRSLEN */                            
   ON  ENDFILE (PARMKORT)                                               
   BEGIN;                                                               
      EOF_PARM  = '1'B;                                                 
      GO TO INIT_SLUT;                                                  
   END;                                                                 
                                                                        
   PARMLINIE = '';                                                      
                                                                        
   READ FILE (PARMKORT) INTO  (PARM_AR);                                
                                                                        
   IF PARMLINIE.PROGNAVN ^= 'BH20100'                                   
   THEN                                                                 
     PARM_FEJL = '1'B;                                                  
                                                                        
    IF VERIFY (PARMLINIE.KOMNR1,'0123456789')  >  0                     
    THEN                                                                
      DO;                                                               
        PARM_FEJL = '1'B;                                               
      END;                                                              
                                                                        
    /*Første kommunenummer skal være udfyldt når der er parmkort*/      
    IF PARMLINIE.KOMNR1  <  '100' !                                     
       PARMLINIE.KOMNR1  >  '999'                                       
    THEN                                                                
      DO;                                                               
        PARM_FEJL = '1'B;                                               
      END;                                                              
                                                                        
    IF PARM_FEJL                                                        
    THEN                                                                
       DO;                                                              
         PUT SKIP LIST ('FEJL I PARMKORT: ',PARM_AR);                   
         ABENDTXT = '101 FEJL I PARMKORT';                              
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
       END;                                                             
    ELSE                                                                
       DO;                                                              
         PARM_MEDTAGET  = '1'B;                                         
         PUT SKIP LIST('PARMKORT MEDTAGET: ' !!                         
                PARMLINIE.PROGNAVN  !! PARMLINIE.KOMNR1 !!              
                PARMLINIE.KOMNR2 !! PARMLINIE.KOMNR3);                  
       END;                                                             
                                                                        
   INIT_SLUT:                                                           
                                                                        
   IF PARMLINIE.KOMNR1 = ''                                             
   THEN                                                                 
     DO;                                                                
       PARMKOMNR1 = 0;                                                  
       PARMKOMNR2 = 0;                                                  
       PARMKOMNR3 = 0;                                                  
     END;                                                               
   ELSE                                                                 
     DO;                                                                
       HJ_KOMNR  = PARMLINIE.KOMNR1;                                    
       PARMKOMNR1 = HJ_KOMNR;                                           
       IF PARMLINIE.KOMNR2 > '000'                                      
       THEN                                                             
         DO;                                                            
           HJ_KOMNR  = PARMLINIE.KOMNR2;                                
           PARMKOMNR2 = HJ_KOMNR;                                       
         END;                                                           
                                                                        
       IF PARMLINIE.KOMNR3 > '000'                                      
       THEN                                                             
         DO;                                                            
           HJ_KOMNR  = PARMLINIE.KOMNR3;                                
           PARMKOMNR3 = HJ_KOMNR;                                       
         END;                                                           
                                                                        
       PUT SKIP LIST('PARMLINIE.KOMNR1 =',PARMKOMNR1);                  
       PUT SKIP LIST('PARMLINIE.KOMNR2 =',PARMKOMNR2);                  
       PUT SKIP LIST('PARMLINIE.KOMNR3 =',PARMKOMNR3);                  
     END;                                                               
                                                                        
                                                                        
  END OPSTART_INIT;                                                     
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
         SQLKODE = SQLCA.SQLCODE;                                       
         CALL CLOSE_PERSONEJENDOMSOPL;                                  
         CALL ZS67000(SQLCA);                                           
                                                                        
         ABENDTXT  = '250 ' !! FEJLTEKST !! SQLKODE;                    
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CALL CLOSE_PERSONEJENDOMSOPL;                                  
         CALL OPDATER_KØRSELSTABEL('SLUT',AFVIKLING_PARM.FS_MRK);       
                                                                        
                                                                        
                                                                        
         LINIE = ZZWS3 !! ' KONTROL- & AFSTEMNINGSTOTAL FOR'            
                       !! ' UDTRÆK FRA EVS FORSKUD '                    
         /*#01*/       !! BH65300M.INDKÅR1                              
                       !! ' DATO: '                                     
                       !! DAT.DAG !! '.' !! DAT.MD !! '.' !! DAT.ÅR;    
                                                                        
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE = ZZWS3 !! ' PROGRAMID: BH20100 ';                       
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'01');                                      
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL LÆSTE FRA PERSONTABELLEN . . . . . . . .';  
         LIN.ANT   = ANTLÆS_PERSON;                                     
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL EJ SKREVET MED CEJBEVS LIG 9 . . . . . .';  
         LIN.ANT   = ANTCEJBEVS_9;                                      
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL EJ SKREVET MED CSLET LIG 1 . . . . . . .';  
         LIN.ANT   = ANTCSLET_1;                                        
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL EJ SKREVET MED EEJDNR LIG 0. . . . . . .';  
         LIN.ANT   = ANTEJENDOM_0;                                      
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL SKREVNE IALT . . . . . . . . . . . . . .';  
         LIN.ANT   = ANTSKRIV_PERSON;                                   
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = '      HERAF DANSKE EJENDOMME . . . . . . . . .';  
         LIN.ANT   = ANTSKRIV_ØVR;                                      
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = '      HERAF UDENLANDSKE EJENDOMME. . . . . . .';  
         LIN.ANT   = ANTSKRIV_UDL;                                      
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL HVOR DER ER SUMMERET SKAT. . . . . . . .';  
         LIN.ANT   = TV_SUMMERET;                                       
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL HVOR DER IKKE ER SUMMERET SKAT . . . . .';  
         LIN.ANT   = TV_IKKE_SUMMERET;                                  
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         LIN.TEKST = 'ANTAL MED FDAGIALT STØRRE END 360 DAGE . . . .';  
         LIN.ANT   = TV_STOR_FDAGIALT;                                  
         CALL ZZ20300(LINIE,'01');                                      
                                                                        
         CALL ZZ20300(' ','99');                      /* LUK KMDSPOOL */
                                                                        
 END AFSLUT;                                                            
 /*********************************************************************/
 /* SKRIV TIL TABEL BQ77000 FORSØG PÅ SKRIVE MODUL                    */
 /* DATA SKRIVES FRA STRUKTUR BH200100N SOM ER KOPI AF BH300100N      */
 /*********************************************************************/
 SKRIV_TIL_BQ77000T: PROC;                                              
                                                                        
    DCL RÆKKE_FINDES         BIT (1) INIT ('0'B);                       
                                                                        
    RÆKKE_FINDES = NEJ;                                                 
                                                                        
    /*NULSTIL STRUKTUR HUSK SWITCH NULSTILLING*/                        
    CALL NULSTIL_BQ77000T;                                              
                                                                        
    /*OPSÆT SØGE FELTER*/                                               
    DCLBQ77000T.TIL_EVS_AAR   = WS_TIL_EVS_AAR;                         
    DCLBQ77000T.AFVIKLINGS_ID = WS_FORSKUD_SLUT_TXT;                    
    DCLBQ77000T.DCPRN         = UDTRÆK_FORS.DCPRN;                      
    DCLBQ77000T.EKOMNR        = UDTRÆK_FORS.EKOMNR;                     
    DCLBQ77000T.EEJDNR        = UDTRÆK_FORS.EEJDNR;                     
    DCLBQ77000T.EGENNR        = 1;                                      
                                                                        
                                                                        
  /*  EXEC SQL                                                          
     SELECT T1.TIL_EVS_AAR,                                             
            T1.DCPRN,                                                   
            T1.EKOMNR,                                                  
            T1.EEJDNR,                                                  
            T1.EGENNR                                                   
                                                                        
      INTO :DCLBQ77000T.TIL_EVS_AAR,                                    
           :DCLBQ77000T.DCPRN,                                          
           :DCLBQ77000T.EKOMNR,                                         
           :DCLBQ77000T.EEJDNR,                                         
           :DCLBQ77000T.EGENNR                                          
                                                                        
     FROM BQ77000T T1                                                   
                                                                        
     WHERE T1.TIL_EVS_AAR   = :DCLBQ77000T.TIL_EVS_AAR                  
       AND T1.AFVIKLINGS_ID = :DCLBQ77000T.WS_FORSKUD_SLUT_TXT          
       AND T1.DCPRN         = :DCLBQ77000T.DCPRN                        
       AND T1.EKOMNR        = :DCLBQ77000T.EKOMNR                       
       AND T1.EEJDNR        = :DCLBQ77000T.EEJDNR                       
       AND T1.EGENNR        = :DCLBQ77000T.EGENNR;*/                    
 /*********************************************************************/
 /* LÆS AKTUELLE OPLYSNINGER FRA BQ77000T                             */
 /* DER ER ANVENDT EN CURSOR SELV OM DER KUN FORVENTES EN RÆKKE       */
 /*********************************************************************/
                                                                        
    CALL OPEN_EVS_UDTRÆK_CUR;                                           
    CALL FETCH_BQ77000T_UDTRÆK_PERSON_CUR;                              
                                                                        
    SELECT (SQLCA.SQLCODE);                                             
      WHEN (0)                                                          
        DO;                                                             
          /* PUT SKIP LIST('RÆKKE LÆST');*/                             
          RÆKKE_FINDES = JA;                                            
        END;                                                            
      WHEN (100)                                                        
        DO;                                                             
          /* PUT SKIP LIST('RÆKKE IKKE FUNDET');*/                      
          RÆKKE_FINDES = NEJ;                                           
        END;                                                            
      OTHERWISE                                                         
        DO;                                                             
          PUT SKIP LIST('TIL_EVS_AAR  = ',DCLBQ77000T.TIL_EVS_AAR);     
          PUT SKIP LIST('AFVIKLINGS_ID = ',DCLBQ77000T.AFVIKLINGS_ID);  
          PUT SKIP LIST('DCPRN         = ',DCLBQ77000T.DCPRN);          
          PUT SKIP LIST('EKOMNR       = ',DCLBQ77000T.EKOMNR);          
          PUT SKIP LIST('EEJDNR       = ',DCLBQ77000T.EEJDNR);          
          FEJLTEKST  =  'BH20100 ** 262  SELECT FRA BQ77000T';          
          PUT SKIP LIST('BH20100 SQLKODE =',SQLCA.SQLCODE);             
          CALL SQL_FEJL;                                                
       END;                                                             
                                                                        
    END; /* SELECT*/                                                    
                                                                        
    CALL CLOSE_EVS_UDTRÆK_CUR;                                          
                                                                        
    IF RÆKKE_FINDES                                                     
    THEN                                                                
      DO;                                                               
        CALL FLYT_FORSKUD_FELTER;                                       
        CALL UPDATE_FELTER_BQ77000T;                                    
      END;                                                              
    ELSE                                                                
      DO;                                                               
                                                                        
        CALL FLYT_FORSKUD_FELTER;                                       
        CALL INSERT_BQ77000T;                                           
      END;                                                              
                                                                        
                                                                        
 INSERT_BQ77000T:PROC;                                                  
                                                                        
    WS_DB2FUNKTION = 'I';                                               
    CALL INSERT_FELTER_BQ77000T;                                        
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
      WHEN(0)                                                           
        DO;                                                             
          ANT_INS = ANT_INS + 1;                                        
          ANT_COMM = ANT_COMM + 1;                                      
        END;                                                            
      OTHERWISE                                                         
        DO;                                                             
          ABENDTXT = '101 UPDATE BQ77000T ';                            
          CALL SQL_FEJL;                                                
        END;                                                            
    END;                                                                
                                                                        
    IF ANT_COMM > 9999                                                  
    THEN                                                                
      DO;                                                               
        EXEC SQL COMMIT;                                                
        Put skip list ('Commit efter ' !! ANT_COMM !!                   
                         ' opdateringer.  Ialt ' !! ANT_INS !!          
                           ' opdateringer af døde');                    
        ANT_COMM = 0;                                                   
      END;                                                              
                                                                        
 END INSERT_BQ77000T;                                                   
 /*********************************************************************/
 UPDATE_FELTER_BQ77000T: PROC;                                          
                                                                        
    WS_DB2FUNKTION = 'U';                                               
    CALL UPDATE_ALLE_FELTER_BQ77000T;                                   
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
      WHEN(0)                                                           
        DO;                                                             
          ANT_INS = ANT_INS + 1;                                        
          ANT_COMM = ANT_COMM + 1;                                      
        END;                                                            
      OTHERWISE                                                         
        DO;                                                             
          ABENDTXT = '101 UPDATE BQ77000T ';                            
          CALL SQL_FEJL;                                                
        END;                                                            
    END;                                                                
                                                                        
    IF ANT_COMM > 9999                                                  
    THEN                                                                
      DO;                                                               
        EXEC SQL COMMIT;                                                
        Put skip list ('Commit efter ' !! ANT_COMM !!                   
                         ' opdateringer.  Ialt ' !! ANT_INS !!          
                           ' opdateringer af døde');                    
        ANT_COMM = 0;                                                   
      END;                                                              
                                                                        
 END UPDATE_FELTER_BQ77000T;                                            
 /*********************************************************************/
 FLYT_FORSKUD_FELTER: PROC;                                             
                                                                        
      DCLBQ77000T.TIL_EVS_AAR   = WS_TIL_EVS_AAR;                       
      DCLBQ77000T.AFVIKLINGS_ID = WS_FORSKUD_SLUT_TXT;                  
      DCLBQ77000T.DCPRN         = UDTRÆK_FORS.DCPRN;                    
      DCLBQ77000T.EKOMNR        = UDTRÆK_FORS.EKOMNR;                   
      DCLBQ77000T.EEJDNR        = UDTRÆK_FORS.EEJDNR;                   
      DCLBQ77000T.PROGRAMNAVN   = WS_PROGRAMNAVN;                       
      DCLBQ77000T.DB2FUNKTION   = WS_DB2FUNKTION;                       
      DCLBQ77000T.EGENNR = 1;                                           
      DCLBQ77000T.CITYP   = 0;  /*opsætters senere*/                    
      DCLBQ77000T.CUDLAND = ''; /*opsættes senere*/                     
      DCLBQ77000T.CSBSK   = '';  /*opsættes senere*/                    
                                                                        
   /* FLYT FELTER FRA EVS FORSKUD BH20100*/                             
      DCLBQ77000T.EVSFEJ_DCPRN     = UDTRÆK_FORS.DCPRN;                 
      DCLBQ77000T.EVSFEJ_EKOMNR    = UDTRÆK_FORS.EKOMNR;                
      DCLBQ77000T.EVSFEJ_EEJDNR    = UDTRÆK_FORS.EEJDNR;                
      DCLBQ77000T.EVSFEJ_CFRATYPE  = UDTRÆK_FORS.CFRATYPE;              
      DCLBQ77000T.EVSFEJ_DSORTDAT1 = UDTRÆK_FORS.DSORTDAT1;             
      DCLBQ77000T.EVSFEJ_DSORTDAT2 = UDTRÆK_FORS.DSORTDAT2;             
      DCLBQ77000T.EVSFEJ_ELBNR     = UDTRÆK_FORS.ELBNR;                 
      DCLBQ77000T.EVSFEJ_DFRAGLD   = UDTRÆK_FORS.DFRAGLD;               
      DCLBQ77000T.EVSFEJ_DTILGLD   = UDTRÆK_FORS.DTILGLD;               
      DCLBQ77000T.EVSFEJ_CEVSBENY  = UDTRÆK_FORS.CEVSBENY;              
      DCLBQ77000T.EVSFEJ_CEJBEVS   = UDTRÆK_FORS.CEJBEVS;               
      DCLBQ77000T.EVSFEJ_COPR_CEJBEVS = UDTRÆK_FORS.COPR_CEJBEVS;       
      DCLBQ77000T.EVSFEJ_CEJDTYPE  = UDTRÆK_FORS.CEJDTYPE;              
      DCLBQ77000T.EVSFEJ_CFRED     = UDTRÆK_FORS.CFRED;                 
      DCLBQ77000T.EVSFEJ_CNEDSL1   = UDTRÆK_FORS.CNEDSL1;               
      DCLBQ77000T.EVSFEJ_DATO0107  = UDTRÆK_FORS.DATO0107;              
      DCLBQ77000T.EVSFEJ_DOVTG    = UDTRÆK_FORS.DOVTG;                  
      DCLBQ77000T.EVSFEJ_DOVTG_GL = UDTRÆK_FORS.DOVTG_GL;               
      DCLBQ77000T.EVSFEJ_DAFSTAA  = UDTRÆK_FORS.DAFSTAA;                
      DCLBQ77000T.EVSFEJ_DINDFLYT = UDTRÆK_FORS.DINDFLYT;               
      DCLBQ77000T.EVSFEJ_DFRAFLYT = UDTRÆK_FORS.DFRAFLYT;               
      DCLBQ77000T.EVSFEJ_FDAGEJ   = UDTRÆK_FORS.FDAGEJ;                 
      DCLBQ77000T.EVSFEJ_GPCTEJER = UDTRÆK_FORS.GPCTEJER;               
      DCLBQ77000T.EVSFEJ_FDAGUDLE = UDTRÆK_FORS.FDAGUDLE;               
      DCLBQ77000T.EVSFEJ_GPCTUDLE = UDTRÆK_FORS.GPCTUDLE;               
      DCLBQ77000T.EVSFEJ_FDAGERHV = UDTRÆK_FORS.FDAGERHV;               
      DCLBQ77000T.EVSFEJ_GPCTERHV = UDTRÆK_FORS.GPCTERHV;               
      DCLBQ77000T.EVSFEJ_BPROM1   = UDTRÆK_FORS.BPROM1;                 
      DCLBQ77000T.EVSFEJ_B100     = UDTRÆK_FORS.B100;                   
      DCLBQ77000T.EVSFEJ_B100_SW  = UDTRÆK_FORS.B100_SW;                
      DCLBQ77000T.EVSFEJ_BBRUTTO  = UDTRÆK_FORS.BBRUTTO;                
      DCLBQ77000T.EVSFEJ_BBRUTTO_SW  = UDTRÆK_FORS.BBRUTTO_SW;          
      DCLBQ77000T.EVSFEJ_BEJERAN     = UDTRÆK_FORS.BEJERAN;             
      DCLBQ77000T.EVSFEJ_BEJERAN_SW  = UDTRÆK_FORS.BEJERAN_SW;          
      DCLBQ77000T.EVSFEJ_BNYMAN      = UDTRÆK_FORS.BNYMAN;              
      DCLBQ77000T.EVSFEJ_BNYMAN_SW   = UDTRÆK_FORS.BNYMAN_SW;           
      DCLBQ77000T.EVSFEJ_BFORSKAT    = UDTRÆK_FORS.BFORSKAT;            
      DCLBQ77000T.EVSFEJ_BFORSKAT_SW = UDTRÆK_FORS.BFORSKAT_SW;         
      DCLBQ77000T.EVSFEJ_FDAGIALT    = UDTRÆK_FORS.FDAGIALT;            
      DCLBQ77000T.EVSFEJ_CEVSSUM     = UDTRÆK_FORS.CEVSSUM;             
      DCLBQ77000T.EVSFEJ_CENKE       = UDTRÆK_FORS.CENKE;               
      DCLBQ77000T.EVSFEJ_EJDBELIG    = UDTRÆK_FORS.EJDBELIG;            
      DCLBQ77000T.EVSFEJ_CLANDEKODE  = UDTRÆK_FORS.CLANDEKODE;          
      DCLBQ77000T.EVSFEJ_BBERGRL     = UDTRÆK_FORS.BBERGRL;             
      DCLBQ77000T.EVSFEJ_BBER2FAM    = UDTRÆK_FORS.BBER2FAM;            
      DCLBQ77000T.EVSFEJ_CEKSEMP     = UDTRÆK_FORS.CEKSEMP;             
      DCLBQ77000T.EVSFEJ_COPR_EKSEMP = UDTRÆK_FORS.COPR_EKSEMP;         
      DCLBQ77000T.EVSFEJ_BUDLSKC     = UDTRÆK_FORS.BUDLSKC;             
                                                                        
 END FLYT_FORSKUD_FELTER;                                               
                                                                        
 END SKRIV_TIL_BQ77000T;                                                
                                                                        
 /*********************************************************************/
 /* OPDATER KØRSELSTABEL  (Include ?)                          RUTINE */
 /*********************************************************************/
 /*********************************************************************/
 /* HER STARTER APPLIKATIONENS EGNE INCLUDES                          */
 /*********************************************************************/
                                                                        
 %INCLUDE BH54997M;             /* PROGRAM AFHÆNGIGHEDER              */
 %INCLUDE BH54998M;             /* HÅNDTERING AF KØRSEL TABEL         */
 %INCLUDE BH54999M;             /* HÅNDTERING AF OMKØRSEL             */
                                                                        
 %INCLUDE BH20021M;             /* NULSTIL BQ77000T */                  
 %INCLUDE BH20022M;             /* INSERT BQ77000T */                   
 %INCLUDE BH20023M;             /* FETCH  BQ77000T */                   
 %INCLUDE BH20024M;             /* UPDATE BQ77000T */                   
                                                                        
                                                                        
 %INCLUDE BH20100M;             /* DECLARE OG FETCH SQL STATEMENTS.   */
 %INCLUDE ZM90051M;             /* KONV BIN15 TIL CHAR                */
 %INCLUDE BS34307M;             /* KONV BF31 TIL CHAR6                */
 %INCLUDE ZM90013M;             /* OMSÆT DATO TIL/FRA DB2-DATOFORMAT  */
                                                                        
 /*********************************************************************/
 OPEN_EVS_UDTRÆK_CUR: PROC;                                             
                                                                        
    EXEC SQL OPEN BQ77000T_UDTRÆK_PERSON_CUR;                           
                                                                        
    IF SQLCA.SQLCODE ^= 0                                               
    THEN                                                                
      DO;                                                               
        FEJLTEKST = 'OPEN EVS_UDTRÆK_CUR';                              
        FEJLTEKST  = 'BH20100 ** 253 ' !! FEJLTEKST;                    
        CALL SQL_FEJL;                                                  
     END;                                                               
                                                                        
                                                                        
                                                                        
 END OPEN_EVS_UDTRÆK_CUR;                                               
 /*********************************************************************/
 CLOSE_EVS_UDTRÆK_CUR: PROC;                                            
                                                                        
    EXEC SQL CLOSE BQ77000T_UDTRÆK_PERSON_CUR;                          
                                                                        
    IF SQLCA.SQLCODE ^= 0                                               
    THEN                                                                
      DO;                                                               
        FEJLTEKST = 'CLOSE EVS_UDTRÆK_CUR';                             
        FEJLTEKST  = 'BH20100 ** 253 ' !! FEJLTEKST;                    
        CALL SQL_FEJL;                                                  
     END;                                                               
                                                                        
 END CLOSE_EVS_UDTRÆK_CUR;                                              
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /*********************************************************************/
 END BH20100;                                                           
