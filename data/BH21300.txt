  PROCESS OPT(TIME);                                                    
 BH21300: /* CHECK OM ÆGTEFÆLLEOPRETTELSE I SLUT ER EJER JVF. ESR */    
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /********************************************************************/ 
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA I/S 2001');       
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : AT UNDERSØGE OM PERSONER INDBERETTET TIL EVS SLUT SOM ÆG- * 
 *          TEFÆLLEOPRETTELSER (CÆGTOPR=1) FINDES SOM EJERE PÅ ESR-   * 
 *          UDTRÆK TIL EJENDOMSVÆRDISKATTEBEREGNING TIL FORSKUD.      * 
 *          HVIS DETTE ER TILFÆLDET ÆNDRES CÆGTOPR FRA 1 TIL 9 AF     * 
 *          HENSYN TIL KORREKT BEHANDLING AF PERSONEN OG DENNES ÆGTE- * 
 *          FÆLLE.                                                    * 
 *                                                                    * 
 * INPUT  : B.H20020D  UDTRÆK FRA EVS SLUT 2000.                      * 
 *          C.N57041D  UDTRÆK FRA ESR - SORTERET                      * 
 *                                                                    * 
 * OUTPUT : B.H21300D  UDTRÆK BEHANDLET JVF. FORMÅL                   * 
 *          BH21301Y   KØRSELSKONTROLLISTE                            * 
 *                                                                    * 
 * PROGRAMMØR: AAGE RASMUSSEN   LSU T&S EVS            AUG 2001       * 
 * RETTET:                                                            * 
 *                                                                    * 
 *********************************************************************/ 
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     CN570I  FILE RECORD INPUT;     /* ESR UDTRÆK */                
 DCL     BH2002I FILE RECORD INPUT;     /* EVS SLUT UDTRÆK */           
 DCL     BH213O  FILE RECORD OUTPUT;    /* BEHANDLET EVS SLUT UDTRÆK */ 
 DCL     SYSPRINT FILE OUTPUT;                                          
 /********************************************************************* 
 *       DECLARE AF UDTRÆK FRA ESR                                    * 
 *********************************************************************/ 
 DCL     1 CN570,                                                       
           %INCLUDE CN57000N;                                           
 DCL     1 CN570_ID1,                                                   
           2 DCPRCIR     FIXED     (11),                                
           2 EKOMNR      FIXED     (3),                                 
           2 EEJDNR      FIXED     (7);                                 
 DCL     CN570_ID        CHAR      (12)   BASED(ADDR(CN570_ID1));       
 /********************************************************************* 
 *       DECLARE AF EVS UDTRÆK                                        * 
 *********************************************************************/ 
 DCL     1 BH200,                                                       
           %INCLUDE BH20000N;;                                          
 DCL     1 BH200_ID1,                                                   
           2 DCPRN       FIXED     (11),                                
           2 EKOMNR      FIXED     (3),                                 
           2 EEJDNR      FIXED     (7);                                 
 DCL     BH200_ID        CHAR      (12)   BASED(ADDR(BH200_ID1));       
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
 DCL     1 TV,                        /* TÆLLEVÆRKER TIL TOTALLISTEN */ 
           2 LÆS_CN570   FIXED DEC (7),                                 
           2 LÆS_BH200   FIXED DEC (7),                                 
           2 SKREVET     FIXED DEC (7),                                 
           2 FUNDET      FIXED DEC (7);                                 
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     EOF_CN570       BIT       (1);                                 
 DCL     EOF_BH200       BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BH21300L'),                                        
           2 F1          CHAR      (21)      INIT      (' '),           
           2 TEKST2      CHAR      (52)      INIT      (                
           'CHECK OM ÆGTEFÆLLEOPRETTELSE I SLUT ER EJER JVF. ESR'),     
           2 F2          CHAR      (21)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'Z.ZZZ.ZZ9',                         
           2 F2          CHAR      (63)      INIT      ((63)' ');       
         % INCLUDE ZZ20301M;                                            
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
         EOF_CN570 = NEJ;                                               
         EOF_BH200 = NEJ;                                               
         ON ERROR CALL PLIDUMP ('SNHOB');                               
         OPEN FILE (CN570I)   TITLE ('CN57041I');                       
         OPEN FILE (BH2002I)  TITLE ('BH20020I');                       
         OPEN FILE (BH213O)   TITLE ('BH21300O');                       
         ON ENDFILE (CN570I)                                            
         BEGIN;                                                         
            EOF_CN570 = JA;                                             
            CN570_ID1.DCPRCIR = 99999999999;                            
            CN570_ID1.EKOMNR  = 999;                                    
            CN570_ID1.EEJDNR  = 9999999;                                
         END;                                                           
         ON ENDFILE (BH2002I)                                           
         BEGIN;                                                         
            EOF_CN570 = JA;                                             
            EOF_BH200 = JA;                                             
            BH200_ID1.DCPRN  = 99999999999;                             
            BH200_ID1.EKOMNR = 999;                                     
            BH200_ID1.EEJDNR = 9999999;                                 
         END;                                                           
         CALL ZZ20390 ('*OPEN','BH21301Y');                             
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS2;                                        
         OVERLIN2.CCA   = ZZWS3;                                        
         TV = '';                                                       
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_CN570;                                                
         CALL LÆS_BH200;                                                
                                                                        
         DO WHILE (EOF_CN570 = NEJ ! EOF_BH200 = NEJ);                  
            SELECT;                                                     
               WHEN (BH200_ID > CN570_ID !                              
                     CN570.DOVTG > 20021231 !                           
                     CN570.DAFGDAT > 0 & CN570.DAFSTÅ = 0)              
                  CALL LÆS_CN570;                                       
               WHEN (BH200_ID < CN570_ID)                               
                  DO;                                                   
                     CALL SKRIV_BH213;                                  
                     CALL LÆS_BH200;                                    
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     TV.FUNDET = TV.FUNDET + 1;                         
                     BH200.CÆGTOPR = '9';                               
                     CALL SKRIV_BH213;                                  
                     CALL LÆS_BH200;                                    
                  END;                                                  
            END;                                                        
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS EVS UDTRÆK                                               * 
 *********************************************************************/ 
 LÆS_BH200:                                                             
 PROC;                                                                  
                                                                        
         READ FILE (BH2002I) INTO (BH200);                              
                                                                        
         IF EOF_BH200 = NEJ                                             
         THEN                                                           
            DO;                                                         
               BH200_ID1.DCPRN = BH200.DCPRN;                           
               BH200_ID1.EKOMNR = BH200.EKOMNR;                         
               BH200_ID1.EEJDNR = BH200.EEJDNR;                         
               TV.LÆS_BH200 = TV.LÆS_BH200 + 1;                         
            END;                                                        
                                                                        
 END LÆS_BH200;                                                         
 /********************************************************************* 
 *       LÆS UDTRÆK FRA ESR                                           * 
 *********************************************************************/ 
 LÆS_CN570:                                                             
 PROC;                                                                  
                                                                        
         READ FILE (CN570I) INTO (CN570);                               
                                                                        
         IF EOF_CN570 = NEJ                                             
         THEN                                                           
            DO;                                                         
               CN570_ID1.DCPRCIR = CN570.DCPRCIR;                       
               CN570_ID1.EKOMNR  = CN570.EKOMNR;                        
               CN570_ID1.EEJDNR  = CN570.EEJDNR;                        
               TV.LÆS_CN570 = TV.LÆS_CN570 + 1;                         
            END;                                                        
                                                                        
 END LÆS_CN570;                                                         
 /********************************************************************* 
 *       SKRIV EVS UDTRÆK                                             * 
 *********************************************************************/ 
 SKRIV_BH213:                                                           
 PROC;                                                                  
                                                                        
         WRITE FILE (BH213O) FROM (BH200);                              
                                                                        
         TV.SKREVET = TV.SKREVET + 1;                                   
                                                                        
 END SKRIV_BH213;                                                       
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
         PROC;                                                          
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_CN570;                                  
         DETLIN1.TEKST = 'LÆSTE PÅ UDTRÆK FRA ESR            C.N57041D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_BH200;                                  
         DETLIN1.TEKST = 'LÆSTE ÆGTEFÆLLEOPRETTELSER         B.H20020D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.FUNDET;                                     
         DETLIN1.TEKST = 'HERAF FUNDET SOM EJER PÅ ESR-UDTRÆK         ';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.SKREVET;                                    
         DETLIN1.TEKST = 'SKREVNE ÆGTEFÆLLEOPRETTELSER       B.H21300D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
  END TOTALLISTE;                                                       
 /*********************************************************************/
 /*      CLOSE AF FILER OG SPOOL                                      */
 /*********************************************************************/
 AFSLUT:                                                                
         PROC;                                                          
                                                                        
         CALL TOTALLISTE;                                               
                                                                        
         CLOSE FILE (BH2002I),                                          
               FILE (CN570I),                                           
               FILE (BH213O);                                           
                                                                        
         CALL ZZ20300((133)' ','99');                                   
                                                                        
 END AFSLUT;                                                            
                                                                        
 END  BH21300;                                                          
