 BH34100: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS SLUT 2001                                          *
 * PROGRAMNAVN: BH34100.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    PROGRAMMET UDTRÆKKER ALLE AKTIVE OG VALIDE EJENDOMME   *
 *              FRA EVS SLUT    2000                                   *
 * PGMFORLØB:   1. ÅBEN EVS UDTRÆKSFIL.                                *
 *              2. DECLARE EJENDOMSOPL.                                *
 *              3. OPEN EJENDOMSOPL.                                   *
 *              4. LÆS/FETCH RÆKKE PÅ EJENDOMTABEL.                    *
 *              5. BEHANDL DATA TIL FILSTRUKTUR.                       *
 *              6. SKRIV RECORD PÅ UDTRÆKSFIL.                         *
 *              7. LUK EJENDOMSOPL.                                    *
 *              8. LUK EVS UDTRÆKSFIL.                                 *
 *              9. SKRIV KONTROLLISTE.                                 *
 * INDDATA:     BQ00100T - EVS EJENDOMSTABEL.                          *
 * UDDATA:      BH34100O - UDTRÆK FRA EVS EJENDOMSTABEL SLUT 2000      *
 *              BH34189Y - KONTROLLISTE.                               *
 * KONSTRUKTØR: HANS E KJELDSEN       HKS, LSU/T&S BRØNDBY 04.12.2001. *
 * ÆNDRINGSLOG:                                                        *
 *                                                                     *
 **********************************************************************/
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KMD A/S 2001');            
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
         EXEC SQL INCLUDE BQ00100T;        /* EVS EJENDOMSTABELLEN */   
         EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */
                                                                        
 /**********************************************************************
 * DECLARE AF ABEND RUTINE                                             *
 **********************************************************************/
                                                                        
 DCL     ZS30101        ENTRY;                                          
 DCL     ZS67000        ENTRY;                                          
 DCL     ZS61900        ENTRY;                        /* KST/SSI INFO */
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
                                                                        
 DCL     FEJLTEKST      CHAR (20)        INIT(' ');                     
 DCL     ABENDMEDD      CHAR (56)        INIT(' ');                     
                                                                        
 DCL     DT             CHAR (6);                                       
 DCL     1 DAT          BASED(ADDR(DT)),                                
         2 ÅR           PIC   '99',                                     
         2 MD           PIC   '99',                                     
         2 DAG          PIC   '99';                                     
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
                                                                        
 DCL     SYSPRINT FILE STREAM PRINT;                                    
 DCL     BH3410O FILE OUTPUT RECORD; /* EVS UDTRÆK LOADGRUNDLAG EJEND*/ 
                                                                        
 /*********************************************************************/
 /* DECLARE STRUKTURER                                                */
 /*********************************************************************/
                                                                        
 DCL     1 UDTRÆK_EJENDOM,                                              
         %INCLUDE BH34110N;;                                            
                                                                        
 DCL     1 INDK_EJENDOM,                                                
         %INCLUDE BH34106N;                                             
                                                                        
 DCL     1 EJENDOM,                                                     
         %INCLUDE BQ00100N;;                                            
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
                                                                        
 DCL     (ADDR,DATE,VERIFY,NULL,MOD,SUBSTR,PLIDUMP) BUILTIN;            
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANTLÆS          BIN FIXED (31) INIT(0);/* LÆSTE PERSONTABEL  */
 DCL     ANTSKRIV        BIN FIXED (31) INIT(0);/* SKREVET UDTRÆKSFIL */
 DCL     SQLKODE         PIC '9999' INIT(0);                            
                                                                        
 /*********************************************************************/
 /* PRINTLINIER TIL SPOOL                                             */
 /*********************************************************************/
                                                                        
 DCL     LINIE           CHAR (133) INIT(' ');                          
 DCL     1 LIN           BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 FIL1        CHAR (3),                                      
           2 TEKST       CHAR (56),                                     
           2 ANT         PIC  '---------9',                             
           2 FIL2        CHAR (63);                                     
 DCL     1 LIN2          BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 FIL1        CHAR (21),                                     
           2 TEKST       CHAR (111);                                    
         %INCLUDE ZZ20301M;                                             
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SBHO','MODUL BH34100');                 
            END;                                                        
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
         SQLCA = '';                                                    
         EJENDOM = '';                                                  
         UDTRÆK_EJENDOM = '';                                           
         INDK_EJENDOM = '';                                             
         DT = DATE;                                                     
                                                                        
         OPEN FILE (BH3410O) TITLE ('BH34100O');                        
                                                                        
         CALL ZZ20390('*OPEN','BH34189Y');       /* ÅBEN KONTROLLISTE */
                                                                        
                                                                        
         CALL ZS61900;                              /* KST/SSI INFO   */
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
         CALL DECLARE_EJENDOMSOPL;                                      
         CALL OPEN_EJENDOMSOPL;                                         
         CALL FETCH_EJENDOMSOPL;                                        
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
               DO WHILE (SQLCA.SQLCODE = 0);                            
                  UDTRÆK_EJENDOM = '';                                  
                  CALL FLYT_TIL_LOAD;                                   
                  WRITE FILE (BH3410O) FROM (UDTRÆK_EJENDOM);           
                  ANTSKRIV = ANTSKRIV + 1;                              
                  EJENDOM = '';                                         
                  CALL FETCH_EJENDOMSOPL;                               
               END;                                                     
                                                                        
             END;                                                       
                                                                        
           WHEN (100)                                                   
               PUT SKIP LIST ('INGEN RÆKKER LÆST');                     
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               FEJLTEKST  = 'FETCH EJENDOM_CURSOR';                     
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF EJENDOMSTABEL BQ00100T              RUTINE */
 /*********************************************************************/
 OPEN_EJENDOMSOPL: PROC;                                                
                                                                        
         EXEC SQL OPEN EJENDOM_CURSOR;                                  
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN EJENDOM_CURSOR';                        
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_EJENDOMSOPL;                                                  
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF EJENDOMSTABEL BQ00100T             RUTINE */
 /*********************************************************************/
 CLOSE_EJENDOMSOPL: PROC;                                               
                                                                        
         EXEC SQL CLOSE EJENDOM_CURSOR;                                 
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE EJENDOM_CURSOR';                       
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_EJENDOMSOPL;                                                 
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
         SQLKODE = SQLCA.SQLCODE;                                       
         CLOSE FILE (BH3410O);                                          
         CALL CLOSE_EJENDOMSOPL;                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         ABENDMEDD = 'BH34100 ** 250 ' !! FEJLTEKST !! SQLKODE;         
                                                                        
         CALL ZS30101 (5, ABENDMEDD, 2);                                
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
         CLOSE FILE (BH3410O);                                          
         CALL CLOSE_EJENDOMSOPL;                                        
                                                                        
         LINIE = ZZWS3 !! ' KONTROL- & AFSTEMNINGSTOTAL FOR'            
                       !! ' UDTRÆK FRA EJENDOMSTABEL 2001 ' !! 'DATO: ' 
                       !!   DAT.DAG !! '.' !! DAT.MD !! '.' !! DAT.ÅR;  
                                                                        
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LINIE = ZZWS3 !! ' PROGRAMID: BH34100 ';                       
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'89');                                      
         LINIE = ZZWS2;                                                 
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         LIN.TEKST = 'ANTAL LÆSTE FRA EJENDOMSTABELLEN . . . . . . .';  
         LIN.ANT   = ANTLÆS;                                            
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
                                                                        
         LIN.TEKST = 'ANTAL SKREVNE IALT . . . . . . . . . . . . . .';  
         LIN.ANT   = ANTSKRIV;                                          
         CALL ZZ20300(LINIE,'89');                                      
                                                                        
         CALL ZZ20300(' ','99');                      /* LUK KMDSPOOL */
                                                                        
 END AFSLUT;                                                            
 /*********************************************************************/
 /* HER STARTER APPLIKATIONENS EGNE INCLUDES                          */
 /*********************************************************************/
                                                                        
 %INCLUDE BH34100M;             /* DECLARE OG FETCH SQL STATEMENTS.   */
 %INCLUDE BH34110M;             /* FLYT TIL LOADGRUNDLAG              */
 %INCLUDE ZM90051M;             /* KONV BIN15 TIL CHAR                */
 %INCLUDE BS34307M;             /* KONV BF31 TIL CHAR6                */
                                                                        
 END BH34100;                                                           
