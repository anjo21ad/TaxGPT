  PROCESS OPT(TIME);                                                    
 BE30225:  PROCEDURE OPTIONS (MAIN) REORDER;                            
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : AT SKAFFE NUVÆRENDE ELLER TIDLIGERE ÆGTEFÆLLES PERSONNUM- * 
 *          MER TIL EVT. DUBLERING AF UDTRÆK.                         * 
 *                                                                    * 
 * INPUT  : B.E30100D  UDTRÆK FRA EVS FORSKUD.                        * 
 *          B.E65501D  MINI MT-FIL TIL EVS FORSKUD (OPRETTELSE).      * 
 *                                                                    * 
 * OUTPUT : B.E30200D  EVS UDTRÆK EFTER EVT. DUBLERING MED ÆGTEFÆLLE  * 
 *                     PERSONNUMMER.                                  * 
 *          BE30201Y   KØRSELSKONTROLLISTE                            * 
 *                                                                    * 
 * PROGRAMMØR: OLUF MØRK        LSU T&S EVS            JUL 2002       * 
 ********************************************************************** 
 * RETTET:     BO SCHMIDT       BOB, LSU/T&S BALLERUP 09.06.2004.     * 
 *             TILRETTET TIL FORSKUD  2005                            * 
 * RETTET      ESBEN BRODERSEN          SEP    2018                   * 
 *             TIL SLUT 2018 EJENDOMME KAN NU VÆRE OPDELT MED         * 
 *             EENHEDLBNR SOM VIL VÆRE UDFYLDT FOR 2 FAMILIE BOLIG    * 
 * Forskud2021 Per Brunk                               Marts 2020     * 
 * Forskud2022 Per Brunk - Ny struktur BE30100N        Januar 2021    * 
 * SLUT 2021   Z6SEP (kopi af BH30000)                 Marts 2021     * 
 *             BH65300N rettet til BH65322N og BH65300M rettet til    * 
 *             BH55300M                                               * 
 * Forskud2022 Per Brunk - Ny struktur BH30100N        August 2021    * 
 * Forskud2025 Tina Carstens, TIC                  BF17 15.05.2023    * 
 *********************************************************************/ 
                                                                        
   DCL COPYRIGHT   CHAR   (30) STATIC  INIT ('COPYRIGHT KMD A/S 2004'); 
                                                                        
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
                                                                        
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
                                                                        
 DCL     BE655I FILE RECORD INPUT;     /* MINI MT-FIL */                
 DCL     BE301I FILE RECORD INPUT;  /* EVS FORSKUD UDTRÆK */            
 DCL     BE302O FILE RECORD OUTPUT; /* BEHANDLET EVS FORSKUD UDTRÆK */  
                                                                        
 DCL     SYSPRINT FILE OUTPUT;                                          
                                                                        
 /********************************************************************* 
 *       DECLARE AF MINI MT-FIL TIL EVS FORSKUD                       * 
 *********************************************************************/ 
                                                                        
 DCL     BE655_AR CHAR (200) VAR;                                       
 DCL     1 BE655 BASED(ADDR(BE655_AR)),                                 
           3 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BE65325N;;   /* RUL */                              
                                                                        
 /********************************************************************* 
 *       DECLARE AF EVS UDTRÆK INPUT                                  * 
 *********************************************************************/ 
                                                                        
 DCL     1 BE301,                                                       
           %INCLUDE BE30100N;;                                          
                                                                        
 /********************************************************************* 
 *       DECLARE AF EVS UDTRÆK OUTPUT                                 * 
 *********************************************************************/ 
                                                                        
 DCL     1 BE302,                                                       
           %INCLUDE BE30200N;;                                          
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. TÆLLEVÆRKER                          * 
 *********************************************************************/ 
                                                                        
 DCL     1 TV,                        /* TÆLLEVÆRKER TIL TOTALLISTEN */ 
           2 LÆS_BE655   FIXED DEC (7),                                 
           2 LÆS_BE301   FIXED DEC (7),                                 
           2 FUNDET      FIXED DEC (7),                                 
           2 FDHENVN     FIXED DEC (7),                                 
           2 SKREVET     FIXED DEC (7);                                 
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
                                                                        
 DCL   1 BE55600M,                                                      
         %INCLUDE BE55600M; /* OPSÆT AKTUELT INDKOMSTÅR M.V. */         
                                                                        
 DCL     EOF_BE655       BIT       (1);                                 
 DCL     EOF_BE301       BIT       (1);                                 
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
                                                                        
 DCL     CPRPIC          PIC       '(10)9';                             
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
                                                                        
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
                                                                        
 DCL    1 SIDELIN,                                                      
          2 CCA          CHAR      (01),                                
          2 FILLER       CHAR      (132)     INIT      (' ');           
 DCL     1 OVERLIN1,                                                    
           2 CCA         CHAR      (01),                                
           2 TEKST1      CHAR      (17)      INIT      (                
           'PROGRAM: BE30225L'),                                        
           2 F1          CHAR      (21)      INIT      (' '),           
           2 TEKST2      CHAR      (52)      INIT      (                
           'SKAF ÆGTEFÆLLE (DHENVN) TIL EVS FORSKUD UDTRÆK'),           
           2 F2          CHAR      (21)      INIT      (' '),           
           2 TEKST3      CHAR      (11)      INIT      (                
           'UDSKREVET:'),                                               
           2 DATO        CHAR      (10);                                
 DCL     1 OVERLIN2,                                                    
           2 CCA         CHAR      (01),                                
           2 F1          CHAR      (46)      INIT      (' '),           
           2 TEKST1      CHAR      (86)      INIT                       
           ('          KØRSELSKONTROLLISTE');                           
 DCL     1 DETLIN1,                                                     
           2 CCA         CHAR      (01),                                
           2 TEKST       CHAR      (60),                                
           2 ANTAL       PIC       'Z.ZZZ.ZZ9',                         
           2 F2          CHAR      (63)      INIT      ((63)' ');       
         % INCLUDE ZZ20301M;                                            
                                                                        
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         EOF_BE655 = NEJ;                                               
         EOF_BE301 = NEJ;                                               
                                                                        
         ON ERROR CALL PLIDUMP ('SNHOB');                               
                                                                        
         OPEN FILE (BE655I) TITLE ('BE65501I');                         
         OPEN FILE (BE301I) TITLE ('BE30100I');                         
         OPEN FILE (BE302O) TITLE ('BE30200O');                         
                                                                        
         ON ENDFILE (BE655I)                                            
         BEGIN;                                                         
            EOF_BE655 = JA;                                             
         END;                                                           
                                                                        
         ON ENDFILE (BE301I)                                            
         BEGIN;                                                         
            EOF_BE655 = JA;                                             
            EOF_BE301 = JA;                                             
         END;                                                           
                                                                        
         CALL ZZ20390 ('*OPEN','BE30201Y');                             
         CALL ZS38100(DATO1);                                           
                                                                        
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         OVERLIN1.DATO  = UDDATO;                                       
         SIDELIN.CCA    = ZZIK1;                                        
         OVERLIN1.CCA   = ZZWS2;                                        
         OVERLIN2.CCA   = ZZWS3;                                        
         TV = '';                                                       
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_BE655;                                                
         CALL LÆS_BE301;                                                
                                                                        
         DO WHILE (EOF_BE655 = NEJ ! EOF_BE301 = NEJ);                  
            SELECT;                                                     
               WHEN (BE301.DCPRN > BE655.DCPRN & EOF_BE655 = NEJ)       
                  CALL LÆS_BE655;                                       
               WHEN (BE301.DCPRN < BE655.DCPRN & EOF_BE301 = NEJ)       
                  DO;                                                   
                     BE302.COMPLA    = ' ';                             
                     BE302.DOMPLACPR = ' ';                             
                     BE302.DOMPLAÅR  = 0;                               
                     CALL SKRIV_SINGLE;                                 
                     CALL LÆS_BE301;                                    
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     TV.FUNDET = TV.FUNDET + 1;                         
                     IF (BE655.HIST_OPL(SLUTÅR).DHENVN > 0 !            
                         BE655.HIST_OPL(GLSLUTÅR).DHENVN > 0) &         
                         BE655.CSTATUS ^= '2'      /* IKKE OMPLACERET */
                     THEN                                               
                        CALL SKRIV_DUBLET;                              
                     IF BE655.CSTATUS = '2' &      /* OMPLACERET */     
                        BE655.HIST_OPL(SLUTÅR).DHENVN > 0               
                     THEN                                               
                        DO;                                             
                           BE302.COMPLA = '1';                          
                           CPRPIC = BE655.HIST_OPL(SLUTÅR).DHENVN;      
                           BE302.DOMPLACPR = CPRPIC;                    
                           BE302.DOMPLAÅR  = SLUTÅR;                    
                        END;                                            
                     CALL SKRIV_SINGLE;                                 
                     CALL LÆS_BE301;                                    
                  END;                                                  
            END;                                                        
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS EVS UDTRÆK                                               * 
 *********************************************************************/ 
 LÆS_BE301:                                                             
 PROC;                                                                  
                                                                        
         READ FILE (BE301I) INTO (BE301);                               
                                                                        
         IF EOF_BE301 = NEJ                                             
         THEN                                                           
            TV.LÆS_BE301 = TV.LÆS_BE301 + 1;                            
                                                                        
 END LÆS_BE301;                                                         
 /********************************************************************* 
 *       LÆS MINI MT-FIL                                              * 
 *********************************************************************/ 
 LÆS_BE655:                                                             
 PROC;                                                                  
                                                                        
         READ FILE (BE655I) INTO (BE655_AR);                            
                                                                        
         IF EOF_BE655 = NEJ & BE655.DCPRN < 9999999999                  
         THEN                                                           
            TV.LÆS_BE655 = TV.LÆS_BE655 + 1;                            
                                                                        
 END LÆS_BE655;                                                         
 /********************************************************************* 
 *       SKRIV EVS UDTRÆK                                             * 
 *********************************************************************/ 
 SKRIV_SINGLE:                                                          
 PROC;                                                                  
                                                                        
         BE302.EVS_FORSKUD = BE301, BY NAME;                            
                                                                        
         BE302.SORTCPR  = BE301.DCPRN;                                  
         BE302.SORTKOM  = BE301.EKOMNR;                                 
         BE302.SORTEJD  = BE301.EEJDNR;                                 
         BE302.SORTEENHEDLBNR = BE301.EENHEDLBNR;                       
         BE302.CFRATYPE  = '4'; /* FRA EVS FORSKUD */                   
                                                                        
         WRITE FILE (BE302O) FROM (BE302);                              
                                                                        
         TV.SKREVET = TV.SKREVET + 1;                                   
                                                                        
 END SKRIV_SINGLE;                                                      
 /********************************************************************* 
 *       SKRIV EVS UDTRÆK                                             * 
 *********************************************************************/ 
 SKRIV_DUBLET:                                                          
 PROC;                                                                  
                                                                        
         BE302.EVS_FORSKUD = BE301, BY NAME;                            
                                                                        
         IF BE655.HIST_OPL(SLUTÅR).DHENVN > 0                           
         THEN                                                           
            BE302.SORTCPR = BE655.HIST_OPL(SLUTÅR).DHENVN;              
         ELSE                                                           
            BE302.SORTCPR = BE655.HIST_OPL(GLSLUTÅR).DHENVN;            
                                                                        
         BE302.SORTKOM   = BE301.EKOMNR;                                
         BE302.SORTEJD   = BE301.EEJDNR;                                
         BE302.SORTEENHEDLBNR = BE301.EENHEDLBNR;                       
         BE302.CFRATYPE  = '3'; /* DUBLET FRA EVS FORSKUD */            
         BE302.COMPLA    = ' ';                                         
         BE302.DOMPLACPR = ' ';                                         
                                                                        
         WRITE FILE (BE302O) FROM (BE302);                              
                                                                        
         TV.SKREVET = TV.SKREVET + 1;                                   
         TV.FDHENVN = TV.FDHENVN + 1;                                   
                                                                        
 END SKRIV_DUBLET;                                                      
 /********************************************************************* 
 *                       TOTALER UDSKRIVES.                           * 
 *********************************************************************/ 
 TOTALLISTE:                                                            
         PROC;                                                          
                                                                        
         CALL ZZ20300(SIDELIN,'01');                                    
         CALL ZZ20300(OVERLIN1,'01');                                   
         CALL ZZ20300(OVERLIN2,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_BE655;                                  
         DETLIN1.TEKST = 'LÆSTE PÅ MINI MT-FIL TIL FORSKUD   B.E65501D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.LÆS_BE301;                                  
         DETLIN1.TEKST = 'LÆSTE PÅ EVS FORSKUD UDTRÆK        B.E30100D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.FUNDET;                                     
         DETLIN1.TEKST = 'HERAF EJER FUNDET PÅ MINI MT-FIL            ';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.FDHENVN;                                    
         DETLIN1.TEKST = 'HERAF ÆGTEFÆLLE FUNDET PÅ MINI MT-FIL';       
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
         DETLIN1.CCA = ZZWS2;                                           
         DETLIN1.ANTAL = TV.SKREVET;                                    
         DETLIN1.TEKST = 'SKREVNE INDIVIDER INCL. DUBLETTER  B.E30200D';
         CALL ZZ20300 (DETLIN1,'01');                                   
                                                                        
  END TOTALLISTE;                                                       
 /*********************************************************************/
 /*      CLOSE AF FILER OG SPOOL                                      */
 /*********************************************************************/
 AFSLUT:                                                                
         PROC;                                                          
                                                                        
         CALL TOTALLISTE;                                               
                                                                        
         CLOSE FILE (BE301I),                                           
               FILE (BE655I),                                           
               FILE (BE302O);                                           
                                                                        
         CALL ZZ20300((133)' ','99');                                   
                                                                        
 END AFSLUT;                                                            
                                                                        
 END  BE30225;                                                          
