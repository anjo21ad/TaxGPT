  PROCESS OPT(TIME);                                                    
 BH66600: /* OPSÆT 1/7-98-DATO P.G.A. NYT BEREGNINGSBÅND */             
         PROC OPTIONS (MAIN) REORDER;                                   
         DCL COPYRIGHT CHAR (30) STATIC                                 
         INIT ('COPYRIGHT KOMMUNEDATA I/S 2001');                       
                                                                        
 /*********************************************************************/
 /* OBS.: (ÅRS)TILRETNING OMFATTER 'NORMALT' KUN 'AKTIVERING' AF DEN  */
 /*       RIGTIGE STRUKTUR FOR INPUT B.H90400D JVF. AKTUEL KØRSEL     */
 /*       SAMT 'RULNING' AF ÅRSTAL I PROGRAMMET (DE AKTUELLE STEDER   */
 /*       ER MARKERET 'HUSK ÅRSRUL' SOM KOMMENTAR). RULNING AF ÅRSTAL */
 /*       FORETAGES  K U N  NÅR KØRSEL=EVS FORSKUD.                   */
 /*********************************************************************/
                                                                        
 /*********************************************************************/
 /*      FORMÅL       OPSÆT STATUS FOR 1/7-1998 EJERSKAB PR. INDIVID  */
 /*                   A.H.T. BEREGNING AF EJENDOMSVÆRDISKAT. SENERE   */
 /*                   OVERFØRES DENNE STATUS VED TILKØB/FRASALG OG    */
 /*                   'ENKE EFTER'-SITUATIONER SAMT MELLEM NUVÆRENDE  */
 /*                   ELLER FRASKILTE PERSONER. DER DANNES ET DATASÆT */
 /*                   MED SAMTLIGE INDIVIDER MED ET VALIDT PERSONNUM- */
 /*                   MER, DER DANNES DOG 2 INDIVIDER FOR PERSONER    */
 /*                   MED HENVISNINGSNUMMER: 1 MED SORTCPR LIG AKTUEL */
 /*                   PERSONNR. (DCPRCIR) OG 1 MED SORTCPR LIG NUVÆ-  */
 /*                   RENDE ELLER FRASKILTE ÆGTEFÆLLES PERSONNR.      */
 /*                   (DHENVN).                                       */
 /*                                                                   */
 /*      INDDATA      B.H90400D BEREGNINGSBÅND FRA AKTUEL KØRSEL      */
 /*                             (EVS SLUT ELLER EVS FORSKUD)          */
 /*                                                                   */
 /*      UDDATA       B.H66600D ALLE INDIVIDER MED VALIDT PERSONNR.   */
 /*                   B.H66601Y KØRSELSKONTROLLISTE                   */
 /*                                                                   */
 /*      PROGRAMMØR   AAGE RASMUSSEN          PUS T&S     JULI 2000   */
 /*                                                                   */
 /*      RETTET       AAGE RASMUSSEN          PUS T&S     NOV  2000   */
 /*      RETTET       AAGE RASMUSSEN          LSU T&S     AUG  2001   */
 /*********************************************************************/
                                                                        
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /*********************************************************************/
 /*      FILE-DECLARE                                                 */
 /*********************************************************************/
 DCL     BH904I          FILE RECORD INPUT;                             
 DCL     BH666O          FILE RECORD OUTPUT;                            
 /*********************************************************************/
 /*      STRUCTUR-DECLARE INPUT                                       */
 /*********************************************************************/
 DCL     BH904_AR CHAR (4000) VAR;                                      
 DCL     1 BH904 BASED(ADDR(BH904_AR)),                                 
           2 LÆNGDE BIN FIXED (15),                                     
           /* HUSK RETTELSE AF STRUKTUR */                              
           %INCLUDE BH90100N;;        /* HVIS KØRSEL=EVS FORSKUD */     
       /*  %INCLUDE BH90000N;;  */    /* HVIS KØRSEL=EVS SLUT */        
 /*********************************************************************/
 /*      STRUCTUR-DECLARE OUTPUT                                      */
 /*********************************************************************/
 DCL     1 BH666,                                                       
           %INCLUDE BH66600N;                                           
 DCL     1 BH66699,                                                     
           %INCLUDE BH66699N;                                           
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL     1 LIN1,                                                        
          2 CTL          CHAR      (1),                                 
          2 TX1          CHAR      (37)      INIT                       
            ('PROGRAM: BH66600L'),                                      
          2 TX2          CHAR      (69)      INIT                       
            ('SKAF 1/7-98-STATUS M.V. JVF. ESR-OPLYSNINGER'),           
          2 TX3          CHAR      (14)      INIT                       
            ('UDSKREVET DEN '),                                         
          2 DATO         CHAR      (10),                                
          2 REST         CHAR      (02)      INIT      (' ');           
 DCL     1 LIN2,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (54)      INIT      ('  '),          
          2 TX1          CHAR      (20)      INIT                       
                         ('KØRSELSKONTROLLISTE'),                       
          2 REST         CHAR      (58)      INIT      (' ');           
 DCL     1 LIN3,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (2)       INIT      (' '),           
          2 TEKST        CHAR      (52),                                
          2 ANT          PIC       'ZZZ.ZZZ.ZZZ.ZZZ.ZZZ',               
          2 REST         CHAR      (59)      INIT      (' ');           
 DCL     1 LIN_BLANK,                                                   
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (132)     INIT      (' ');           
         %INCLUDE ZZ20301M;                                             
 /*********************************************************************/
 /*      DECLARE AF TÆLLEVÆRKER                                       */
 /*********************************************************************/
 DCL     TV_LÆS          FIXED     (7)       INIT      (0);             
 DCL     TV_LÆS_ESR      FIXED     (7)       INIT      (0);             
 DCL     TV_LÆS_EVS      FIXED     (7)       INIT      (0);             
 DCL     TV_KOM          FIXED     (7)       INIT      (0);             
 DCL     TV_ØVR          FIXED     (7)       INIT      (0);             
 DCL     TV_NED50        FIXED     (7)       INIT      (0);             
 DCL     TV_SKRIV        FIXED     (7)       INIT      (0);             
 DCL     TV_DUBLET       FIXED     (7)       INIT      (0);             
 /*********************************************************************/
 /*      DECLARE AF BUILTIN                                           */
 /*********************************************************************/
 DCL     ADDR            BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 /*********************************************************************/
 /*      ENTRY-DECLARE                                                */
 /*********************************************************************/
 DCL     ZS61900         ENTRY OPTIONS (INTER ASM);   /* SSI-DATO     */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      DECLARE AF DIVERSE FELTER                                    */
 /*********************************************************************/
 DCL     I               BIN FIXED (15);                                
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2                              BASED(ADDR(DATO1)),       
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF             PIC       '9'       INIT (0);                  
 /*********************************************************************/
 /*      HOUSE-KEEPING                                                */
 /*********************************************************************/
         ON ERROR CALL PLIDUMP('SNHOB');                                
         CALL ZS61900;                 /*   UDSKRIVNING AF SSI-DATO   */
         LIN_BLANK.CTL = ZZIK1;                                         
         LIN1.CTL = ZZWS2;                                              
         LIN2.CTL = ZZWS3;                                              
         LIN3.CTL = ZZWS2;                                              
         OPEN FILE (BH904I) TITLE ('BH90400I');                         
         OPEN FILE (BH666O) TITLE ('BH66600O');                         
         CALL ZZ20390 ('*OPEN','BH66601Y');                             
         ON ENDFILE (BH904I)                                            
         BEGIN;                                                         
            EOF = 1;                                                    
         END;                                                           
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         LIN1.DATO = UDDATO;                                            
 /*********************************************************************/
 /*      PROCES                                                       */
 /*********************************************************************/
                                                                        
         READ FILE (BH904I) INTO (BH904_AR);                            
                                                                        
         DO WHILE (EOF = 0 & BH904.SORT_CPR < 99999999999);             
            TV_LÆS = TV_LÆS + 1;                                        
            IF BH904.ESR.EKOMNR > 0 &           /* KUN EJERE JVF. ESR */
               BH904.CINVPNR = '0'              /* KUN VALIDE CPRNR   */
            THEN                                /* SKAL BEHANDLES     */
               DO;                                                      
                  CALL BEHANDL_ESR_EJD;                                 
                  CALL OPSÆT_SORT_KRIT;                                 
               END;                                                     
            ELSE                                                        
               TV_ØVR = TV_ØVR + 1;    /* SE-NR./LØBENR./EVS TILGANGE */
            READ FILE (BH904I) INTO (BH904_AR);                         
         END;                                                           
                                                                        
 /*********************************************************************/
 /*    AFSLUT PROGRAM                                                 */
 /*********************************************************************/
                                                                        
         CALL DAN_OPT_INDV;                                             
                                                                        
         CALL SKRIV_TOTALER;                                            
                                                                        
         CALL ZZ20300(LIN_BLANK,'99');                                  
                                                                        
         CLOSE FILE (BH904I),                                           
               FILE (BH666O);                                           
                                                                        
 /*********************************************************************/
 /*    OPSÆT STATUS VEDR. 1/7-98 EJERSKAB FOR EJENDOMME FRA ESR       */
 /*********************************************************************/
 BEHANDL_ESR_EJD:                                                       
 PROC;                                                                  
                                                                        
         TV_LÆS_ESR = TV_LÆS_ESR + 1;                                   
                                                                        
         BH666 = '';                                                    
                                                                        
         BH666.EKOMNR = BH904.ESR.EKOMNR;                               
         BH666.EEJDNR = BH904.ESR.EEJDNR;                               
         BH666.SORTCPR = BH904.ESR.DCPRCIR;                             
         BH666.DCPRCIR = BH904.ESR.DCPRCIR;                             
         BH666.EJER_NU.DOVTG = BH904.ESR.DOVTG;                         
         BH666.EJER_NU.DAFSTÅ = BH904.ESR.DAFSTÅ;                       
         BH666.EJER_NU.DSLUTS = BH904.ESR.DSLUTS;                       
         BH666.EJER_NU.DSKØDE = BH904.ESR.DSKØDE;                       
         BH666.EJER_NU.CEJEV = BH904.ESR.CEJEV;                         
         BH666.EJER_NU.DVURDÅR = BH904.ESR.DVURDÅR;                     
         BH666.EJER_NU.CBENYT = BH904.ESR.CBENYT;                       
         BH666.EJER_NU.GL_BEJDV = BH904.ESR.GL_BEJDV;                   
         BH666.EJER_NU.BBROPFØRT = BH904.ESR.BBROPFØRT;                 
         BH666.EJER_NU.DATO0107 = 0;                                    
         BH666.EJER_NU.CNEDSL1 = '00';                                  
         BH666.EJER_NU.CNEDSL1GL = '00';                                
                                                                        
         IF BH666.EJER_NU.DAFSTÅ > 0                                    
         THEN                                                           
            BH666.EJER_NU.DEJETTIL = BH666.EJER_NU.DAFSTÅ;              
         ELSE                                                           
            BH666.EJER_NU.DEJETTIL = 99991231;                          
                                                                        
         BH666.CÆGTEJET = 0;                                            
                                                                        
         /* 'GAMLE' INDIVIDER SKAL BEVARES MAX. 2 ÅR.  */               
         /* D.V.S. DE DROPPES, HVIS DER IKKE FINDES EN */               
         /* MAKKER (ÆGTEFÆLLE,EFTERLEVENDE ELLER PER-  */               
         /* SONEN SELV) I FORBINDELSE MED OVERFØRSLEN  */               
         /* MELLEM ÆGTEFÆLLER M.V.                     */               
                                                                        
         BH666.EJER_NU.DANNETÅR = 2001;                /* HUSK ÅRSRUL */
         BH666.SORTÅR = 2001;                          /* HUSK ÅRSRUL */
                                                                        
         BH666.EJER_NU.CPRNR = BH666.DCPRCIR;                           
         BH666.EJER_NU.DKØRT = UDDATO;                                  
         BH666.EJER_NU.CCIVS = BH904.MT.CCIVS;                          
         BH666.EJER_NU.DCIÆN =                                          
         BH904.MT.HIST_OPL(2001).DCIÆN;                /* HUSK ÅRSRUL */
                                                                        
         BH666.EJER_NU.CNEDSL1GL = BH666.EJER_NU.CNEDSL1;               
                                                                        
         BH666.DHENVN =                                                 
         BH904.MT.HIST_OPL(2001).DHENVN;               /* HUSK ÅRSRUL */
                                                                        
         IF (BH666.EJER_NU.DCIÆN >= 20000901 &         /* HUSK ÅRSRUL */
             BH666.EJER_NU.DCIÆN <= 20011231) &        /* HUSK ÅRSRUL */
            BH666.EJER_NU.DATO0107 <= BH666.EJER_NU.DCIÆN               
         THEN                                                           
            DO;                                                         
               IF BH904.MT.HIST_OPL(2001).DHENVN = 0 & /* HUSK ÅRSRUL */
                  BH904.MT.HIST_OPL(2000).DHENVN > 0   /* HUSK ÅRSRUL */
               THEN                                                     
                  BH666.DHENVN =                                        
                  BH904.MT.HIST_OPL(2000).DHENVN;      /* HUSK ÅRSRUL */
               /* EJENDOMMEN VAR OGSÅ EJET AF PERSONEN FØR ELLER PÅ */  
               /* DEN SENESTE CIVILSTANDSÆNDRINGSDATO               */  
               BH666.CÆGTEJET = 1;                                      
            END;                                                        
                                                                        
         SELECT;                                                        
           WHEN (BH666.EJER_NU.CBENYT = '09' !                          
                 BH666.EJER_NU.CBENYT = '17' !                          
                 BH666.EJER_NU.CBENYT = '70' !                          
                 BH666.EJER_NU.CBENYT = '71')                           
             DO;                                                        
                BH666.EJER_NU.CNEDSL1 = '50';                           
             END;                                                       
           WHEN (BH666.EJER_NU.CBENYT = '  ' &                          
                 BH666.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH666.EJER_NU.CNEDSL1 = '50';                           
             END;                                                       
           WHEN (BH666.EJER_NU.DVURDÅR = '2002' &      /* HUSK ÅRSRUL */
                 BH666.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH666.EJER_NU.CNEDSL1 = '50';                           
             END;                                                       
           OTHERWISE                                                    
             CALL OPSÆT_DATO_0107;                                      
         END;                                                           
                                                                        
 END BEHANDL_ESR_EJD;                                                   
 /*********************************************************************/
 /*    OPSÆT DATO_0107 P.G.A. SLUTSEDDEL-/OVERTAGELSES- ELLER         */
 /*    SKØDEDATO SAMT OPSÆT KODE FOR EVT. 2 PROMILLE NEDSLAG I EJEN-  */
 /*    DOMSVÆRDISKATTEN                                               */
 /*********************************************************************/
 OPSÆT_DATO_0107:                                                       
 PROC;                                                                  
                                                                        
         SELECT;                                                        
           WHEN (BH666.EJER_NU.DSLUTS > 19980701)                       
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DSLUTS;         
                 BH666.EJER_NU.CNEDSL1 = '30';                          
              END;                                                      
           WHEN (BH666.EJER_NU.DSLUTS > 0 &                             
                 BH666.EJER_NU.DSLUTS <= 19980701)                      
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DSLUTS;         
                 BH666.EJER_NU.CNEDSL1 = '10';                          
              END;                                                      
           WHEN (BH666.EJER_NU.DOVTG > 19980701)                        
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DOVTG;          
                 BH666.EJER_NU.CNEDSL1 = '31';                          
              END;                                                      
           WHEN (BH666.EJER_NU.DOVTG > 0 &                              
                 BH666.EJER_NU.DOVTG <= 19980701)                       
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DOVTG;          
                 BH666.EJER_NU.CNEDSL1 = '11';                          
              END;                                                      
           WHEN (BH666.EJER_NU.DSKØDE > 19980701)                       
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DSKØDE;         
                 BH666.EJER_NU.CNEDSL1 = '32';                          
              END;                                                      
           WHEN (BH666.EJER_NU.DSKØDE > 0 &                             
                 BH666.EJER_NU.DSKØDE <= 19980701)                      
              DO;                                                       
                 BH666.EJER_NU.DATO0107 = BH666.EJER_NU.DSKØDE;         
                 BH666.EJER_NU.CNEDSL1 = '12';                          
              END;                                                      
           OTHERWISE                                                    
              BH666.EJER_NU.CNEDSL1 = '13';                             
         END;                                                           
                                                                        
 END OPSÆT_DATO_0107;                                                   
 /*********************************************************************/
 /*    OPSÆT TYPE OG DATO TIL SORTERING AF OUTPUT-DATASÆT SÅ EVENTUEL */
 /*    OVERFØRSEL AF 'BEDSTE' DATO0107 M.V. KAN FORETAGES             */
 /*    VED TILKØB/FRASALG/TILBAGEKØB/ENKE EFTER SAMT EVT. MELLEM      */
 /*    ÆGTEFÆLLER.                                                    */
 /*********************************************************************/
 OPSÆT_SORT_KRIT:                                                       
 PROC;                                                                  
                                                                        
         BH666.SORTDATO = BH666.EJER_NU.DATO0107;                       
                                                                        
         SELECT;                                                        
           WHEN (BH666.EJER_NU.DAFSTÅ > 0)                              
              DO;                                                       
                 BH666.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           WHEN (BH666.EJER_NU.CCIVS = 'D')                             
              DO;                                                       
                 BH666.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                 BH666.SORTTYPE = 6;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
         END;                                                           
                                                                        
 END OPSÆT_SORT_KRIT;                                                   
 /*********************************************************************/
 /*    SKRIV DATASÆT                                                  */
 /*********************************************************************/
 SKRIV_DATASÆT:                                                         
 PROC;                                                                  
                                                                        
         /* FØRST SKRIVES AKTUEL PERSON */                              
         WRITE FILE (BH666O) FROM (BH666);                              
         TV_SKRIV = TV_SKRIV + 1;                                       
                                                                        
         /* SÅ SKRIVES EVT. ÆGTEFÆLLE SOM DUBLET */                     
         IF BH666.DHENVN > 0 &                                          
           (BH666.SORTTYPE = 4  !        /* DØDE OG/ELLER SÆLGERE   */  
            BH666.SORTTYPE = 6)          /* IKKE SÆLGERE ELLER DØDE */  
         THEN                                                           
            DO;                                                         
               BH666.SORTTYPE = 3;                       /*DUBLET AF? */
               BH666.SORTCPR = BH666.DHENVN;                            
               WRITE FILE (BH666O) FROM (BH666);                        
               TV_DUBLET = TV_DUBLET + 1;                               
               TV_SKRIV = TV_SKRIV + 1;                                 
            END;                                                        
                                                                        
 END SKRIV_DATASÆT;                                                     
                                                                        
 /*********************************************************************/
 /*      DER DANNES ET SLUTINDIVID TIL BRUG FOR MASKINEL AFSTEMNING   */
 /*********************************************************************/
 DAN_OPT_INDV:                                                          
 PROC;                                                                  
                                                                        
         BH66699.EKOMNR   = 999;                                        
         BH66699.EEJDNR   = 9999999;                                    
         BH66699.SORTCPR  = 99999999999;                                
         BH66699.SORTÅR   = 99999;                                      
         BH66699.SORTDATO = 999999999;                                  
         BH66699.SORTTYPE = 999;                                        
         BH66699.DCPRCIR  = 99999999999;                                
         BH66699.DHENVN   = 99999999999;                                
         BH66699.ANT_INDV = TV_SKRIV;                                   
                                                                        
         WRITE FILE (BH666O) FROM (BH66699);                            
                                                                        
 END DAN_OPT_INDV;                                                      
 /*********************************************************************/
 /*          UDSKRIVNING AF TOTALLISTE                                */
 /*********************************************************************/
 SKRIV_TOTALER:                                                         
 PROC;                                                                  
                                                                        
         CALL ZZ20300(LIN_BLANK,'01');                                  
         CALL ZZ20300(LIN1,'01');                                       
         CALL ZZ20300(LIN2,'01');                                       
         LIN3.TEKST ='ANTAL LÆSTE INDIVIDER PÅ BH90400D BEREGNINGSBÅND';
         LIN3.ANT = TV_LÆS;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.TEKST ='      HERAF VALIDE PERSONNUMRE FRA ESR';          
         LIN3.ANT = TV_LÆS_ESR;                                         
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
         IF TV_KOM > 0                                                  
         THEN                                                           
            DO;                                                         
               LIN3.TEKST = 'ANTAL OVERLÆSTE KOMMUNEHEADERE';           
               LIN3.ANT = TV_KOM;                                       
               CALL ZZ20300(LIN3,'01');                                 
            END;                                                        
                                                                        
         LIN3.TEKST = 'ANTAL OVERLÆSTE EJ VALIDE CPRNR';                
         LIN3.ANT = TV_ØVR;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = 'ANTAL SKREVNE INDIVIDER                        ';
         LIN3.ANT = TV_SKRIV;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = '      HERAF DUBLETTER                          ';
         LIN3.ANT = TV_DUBLET;                                          
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
 END SKRIV_TOTALER;                                                     
                                                                        
                                                                        
 END BH66600;                                                           
