 BH38100: PROCEDURE OPTIONS (MAIN);                                     
 /**********************************************************************
 * PROJEKT:     EVS SLUT 2013                                         **
 * PROGRAMNAVN: BH38100.                                               *
 * PROGRAMTYPE: BATCH.                                                 *
 * FUNKTION:    FELT 756 ER FEJLAGTIGT SAT OP                          *
 *              DETTE PROGRAM RETTER DET FEJLAGTIGE                    *
 *              SAMTIDIGT KAN EFTERFØLGENDE ÅRS 758 SÆTTES OP MED      *
 *              NYE VÆRDI                                              *
 * INDDATA:     BQ30000T/BQ31000T - EVS PERSONTABEL.                   *
 *              BQ40000T/BQ41000T - EVS RESULTATTABEL.                 *
 * UDDATA:      BQ30000T/BQ31000T - EVS PERSONTABEL.                   *
 *              BH35001Y          - KONTROLLISTE.                      *
 * KONSTRUKTØR: JØRGEN SAUGMANN  SAU,         PKF BALLERUP 13.11.2014. *
 **********************************************************************/
                                                                        
 DEFAULT RANGE (*) STATIC; /* LAGERTYPE AHT. KALD AF EKSTERNE MODULER */
                                                                        
 DCL     COPYRIGHT      CHAR (30) INIT ('(C) KMD A/S 2006');            
                                                                        
 /*********************************************************************/
 /* DECLARE AF DB2                                                    */
 /*********************************************************************/
                                                                        
 EXEC SQL INCLUDE SQLCA;        /* SQL KOMMUNIKATIONSAREAL            */
 EXEC SQL INCLUDE BQ31000T;     /* EVS SLUT EJERSKABSFELTTABEL        */
 EXEC SQL INCLUDE BG41100T;     /* LININGS SYSTEM                     */
 DCL  AARSTAL                FIXED BIN(15)    INIT(0);                  
 DCL 1 BQ31000N,                                                        
 %INCLUDE BQ31000N;;                                                    
 DCL 1 BQ31000X,                                                        
 %INCLUDE BQ31000N;;                                                    
                                                                        
 DCL  HJ_DINDKAAR  BIN FIXED(15)      INIT(0);                          
 DCL  HJ_EKOMNR    BIN FIXED(15)      INIT(0);                          
 DCL  HJ_EEJDNR    BIN FIXED(31)      INIT(0);                          
 DCL  HJ_DCPRN     DEC FIXED(11,0)    INIT(0);                          
 DCL  HJ_ELBNR     BIN FIXED(15)      INIT(0);                          
 DCL  HJ_EGENNR    BIN FIXED(15)      INIT(0);                          
 DCL  HJ_INDHOLD_C CHAR(254)          INIT('');                         
 /*Alle eksisterende feltkode = 86 rækker                       findes*/
 EXEC SQL DECLARE CUR4 CURSOR FOR                                       
                                                                        
 select distinct a.dindkaar, a.dcprn , a.ekomnr, a.eejdnr, a.elbnr,     
                 a.egennr, a.INDHOLD_C                                  
   from  bq31000t a                                                     
   where a.dindkaar = :AARSTAL                                          
     and a.feltkode  = 86                                               
     and a.egennr    =                                                  
     (                                                                  
      select max(a1.egennr)                                             
        from  bq30000t a1                                               
        where a1.dindkaar = a.dindkaar                                  
          and a1.dcprn    = a.dcprn                                     
          and a1.ekomnr   = a.ekomnr                                    
          and a1.eejdnr   = a.eejdnr                                    
          and a1.elbnr    = a.elbnr                                     
     )                                                                  
 with ur;                                                               
                                                                        
 /**********************************************************************
 * DECLARE AF ABEND RUTINE                                             *
 **********************************************************************/
                                                                        
 DCL ZS30101        ENTRY;                                              
 DCL ZS67000        ENTRY;                                              
 DCL ZS61900        ENTRY;                        /* KST/SSI INFO */    
                                                                        
 /*********************************************************************/
 /* DECLARE AF DIVERSE                                                */
 /*********************************************************************/
 DCL JA                 BIT(1)           INIT('1'B);                    
 DCL NEJ                BIT(1)           INIT('0'B);                    
 DCL CUR_EOF            BIT(1)           INIT('0'B);                    
 DCL FORTSÆT            BIT(1)           INIT('1'B);                    
 DCL PULS_COUNT         FIXED DEC(11,0)  INIT(0);                       
 DCL PARM_EOF           BIT(1)           INIT('0'B);                    
 DCL OPDAT_SW           BIT(1)           INIT('0'B);                    
 DCL KONTROL_SW         BIT(1)           INIT('0'B);                    
                                                                        
 DCL FEJLTEKST          CHAR (20)        INIT(' ');                     
 DCL ABENDMEDD          CHAR (56)        INIT(' ');                     
                                                                        
 DCL DINDKAAR_UD        PIC '(4)9'       INIT(0);                       
 DCL EKOMNR_UD          PIC 'ZZZ9'       INIT(0);                       
 DCL EEJDNR_UD          PIC 'ZZZZZZ9'    INIT(0);                       
 DCL DCPRN_UD           PIC '(10)9'      INIT(0);                       
 DCL ELBNR_UD           PIC 'ZZ9'        INIT(0);                       
 DCL EGENNR_UD          PIC 'Z9'         INIT(0);                       
 DCL TALLER             FIXED BIN(15,0)  INIT(0);                       
 DCL HJ_KODE            CHAR(1)          INIT('0');                     
 DCL PRDATO1            FIXED (9)        INIT(20131231);                
 DCL HJ_CPR             PIC  '(10)9'     INIT(0);                       
 DCL PUTSKIP            BIT(1)           INIT('0'B);                    
 DCL ANT_SPEC           FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_PLOM_P         FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_EJ_PLOM_P      FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_INGEN_PLOM     FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_PLOM_Æ         FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_EJ_PLOM_Æ      FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_LØNCOR         FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_EJ_LØNCOR      FIXED DEC(11,0)  INIT(0);                       
 DCL ANTEJOPDAT         FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_EJ_2014        FIXED DEC(11,0)  INIT(0);                       
 DCL LØNCOR_FLAG        BIT(1)           INIT('0'B);                    
 DCL EGO_FLAG           BIT(1)           INIT('0'B);                    
 DCL ÆGT_FLAG           BIT(1)           INIT('0'B);                    
 DCL PLOM_FLAG          BIT(1)           INIT('0'B);                    
 DCL EGO_PLOM           CHAR(1)          INIT(' ');                     
 DCL LØNCOR             CHAR(1)          INIT(' ');                     
 DCL EGO_DCPRN          FIXED DEC(15,2)  INIT(0);                       
 DCL EGO_HENVISNR       FIXED DEC(15,2)  INIT(0);                       
 DCL EGO_CIVSTANDKODE   CHAR(1)          INIT(' ');                     
 DCL ÆGT_PLOM           CHAR(1)          INIT(' ');                     
 DCL ÆGT_HENVISNR       FIXED DEC(15,2)  INIT(0);                       
 DCL ÆGT_CIVSTANDKODE   CHAR(1)          INIT(' ');                     
 DCL HJ_PLOM            CHAR(1)          INIT(' ');                     
 DCL HJ_HENVISNR        FIXED DEC(15,2)  INIT(0);                       
 DCL HJ_CIVSTANDKODE    CHAR(1)          INIT(' ');                     
 DCL ANT_FRASORT        FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_LØNKOR_FEJL    FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_ENKE_U_ÆGTEF   FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_KODE_0         FIXED DEC(11,0)  INIT(0);                       
 DCL SKAL_OPDATERES     BIT(1)           INIT('0'B);                    
 DCL SKAL_OPRETTES      BIT(1)           INIT('0'B);                    
 DCL ANT_LÆS_2013_756   FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_LÆS_2013_758   FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_756_758_ENS    FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_OPRETTET_2014  FIXED DEC(11,0)  INIT(0);                       
 DCL ANT_OPDATERET_2014 FIXED DEC(11,0)  INIT(0);                       
 DCL GO_756             BIT(1)           INIT('0'B);                    
 DCL GO_758             BIT(1)           INIT('0'B);                    
 DCL PGM_FUNK           CHAR(1)          INIT(' ');                     
                                                                        
 /*********************************************************************/
 /*      DECLARE AF PARAMETER                                         */
 /*********************************************************************/
 DCL     IPARM    FILE  RECORD  INPUT;                                  
 DCL     1 PARMI,                                                       
          2 KØRSW    CHAR(1),         /* Blank = uden opdtering       */
                                      /* X     = med opdatering       */
          2 ÅRSTAL   PIC '9999',                                        
          2 FUNK     CHAR(1),         /* A = 756 del                  */
                                      /* B = 758 del                  */
                                      /* X = Begge dele               */
          2 PENSDATO CHAR(8),                                           
          2 FILLER   CHAR(66);                                          
                                                                        
 /*********************************************************************/
 /* DECLARE DATASÆT                                                   */
 /*********************************************************************/
 DCL     SYSPRINT FILE STREAM PRINT;                                    
                                                                        
 /*********************************************************************/
 /* DECLARE AF BUILTIN                                                */
 /*********************************************************************/
 DCL     (ADDR,DATETIME,VERIFY,NULL,MOD,SUBSTR,PLIDUMP,DEC,             
          PROCNAME,DECIMAL) BUILTIN;                                    
                                                                        
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
 DCL   ANTLÆS            BIN FIXED (31) INIT(0);/* LÆSTE RÆKKER       */
 DCL   ANTOPDAT          BIN FIXED (31) INIT(0);/* OPDATEREDE RÆKKER  */
 DCL   ANTINSERT         BIN FIXED (31) INIT(0);/* INSERTEDE RÆKKER   */
 /*********************************************************************/
 /* PRINTLINIER TIL SPOOL                                             */
 /*********************************************************************/
 DCL     LINIE           CHAR (133);                                    
 DCL     1 LIN1          BASED(ADDR(LINIE)),                            
           2 CC          CHAR (1),                                      
           2 TEKST       CHAR (56),                                     
           2 ANT         PIC  '---------9',                             
           2 FIL1        CHAR (66);                                     
 DCL     1 LIN2          BASED(ADDR(LINIE)),                            
           2 CC          CHAR(1),                                       
           2 CPRNR       CHAR(10),                                      
           2 FIL1        CHAR(5),                                       
           2 KOMNR       CHAR(4),                                       
           2 FIL2        CHAR(5),                                       
           2 EEJDNR      CHAR(7),                                       
           2 FIL3        CHAR(5),                                       
           2 ELBNR       CHAR(3),                                       
           2 FIL4        CHAR(5),                                       
           2 EGNENNR     CHAR(3),                                       
           2 FIL5        CHAR(5),                                       
           2 GL_KODE     CHAR(1),                                       
           2 FIL6        CHAR(5),                                       
           2 NY_KODE     CHAR(1),                                       
           2 FIL7        CHAR(5),                                       
           2 TEXT        CHAR(68);                                      
                                                                        
 %INCLUDE ZZ20301M;                          /* PRINT STYREKARAKTERER */
                                                                        
 /*********************************************************************/
 /* ON - CONDITIONS                                                   */
 /*********************************************************************/
    ON ENDFILE (IPARM)                                                  
       PARM_EOF = '1'B;                                                 
    ON ERROR                                                            
       BEGIN;                                                           
          ON ERROR SYSTEM;                                              
          PUT SKIP LIST ('PROGRAMFEJL');                                
          CALL PLIDUMP  ('SBHO','MODUL BH38100');                       
       END;                                                             
                                                                        
 /*********************************************************************/
 /* HOUSEKEEPING                                                      */
 /*********************************************************************/
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('***** START BH38100 *****');         
    CALL SKAF_PARM();                                                   
    CALL ZZ20390('*OPEN','BH38101Y');       /* ÅBEN KONTROLLISTE */     
    LINIE = ZZWS3 !! ' KONTROL- & AFSTEMNINGSTOTAL FOR'                 
                  !! ' OPDATERING AF BQ31000T    ' !! 'DATO: '          
                  !!   DATETIME('YYYY-MM-DD');                          
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = ZZWS3 !! ' PROGRAMID: BH38100 ';                            
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = ZZWS2;                                                      
    CALL ZS61900;                              /* KST/SSI INFO   */     
                                                                        
 /*********************************************************************/
 /* PROCES                                                            */
 /*********************************************************************/
                                                                        
    IF GO_756 THEN DO;                                                  
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = ' '!!PARMI.ÅRSTAL!!' OPDATERINGER';                      
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = '';                                                      
       CALL OPEN_CURSOR();                                              
       CALL FETCH_CURSOR();                                             
       DO WHILE(FORTSÆT & ^CUR_EOF);                                    
          ANT_LÆS_2013_756 = ANT_LÆS_2013_756 + 1;                      
          CALL DAN_KODE();                                              
          IF FORTSÆT THEN                                               
             CALL KONTROLLER_KODE();                                    
          ELSE                                                          
             PUT SKIP LIST('FEJL OPSTÅET I DAN_KODE, STOPPER');         
          IF FORTSÆT THEN                                               
             CALL FETCH_CURSOR();                                       
          ELSE                                                          
             PUT SKIP LIST('FEJL OPSTÅET I KONTROLLER_KODE, STOPPER');  
       END;                                                             
       CALL CLOSE_CURSOR;                                               
       IF OPDAT_SW THEN                                                 
          EXEC SQL COMMIT;                                              
       CALL ZZ20300(LINIE,'01');                                        
       CALL ZZ20300(LINIE,'01');                                        
    END;                                                                
                                                                        
    IF GO_758 THEN DO;                                                  
       ANT_FRASORT = 0;                                                 
       PULS_COUNT = 0;                                                  
       LINIE      = '';                                                 
       LINIE      = ' '!!PARMI.ÅRSTAL + 1!!' OPDATERINGER';             
       CALL ZZ20300(LINIE,'01');                                        
       ANT_LÆS_2013_756 = 0;                                            
       BQ31000N         = '';                                           
       BQ31000X         = '';                                           
       CALL OPEN_CURSOR();                                              
       CALL FETCH_CURSOR();                                             
       CUR_EOF = NEJ;                                                   
       DO WHILE(FORTSÆT & ^CUR_EOF);                                    
          ANT_LÆS_2013_758 = ANT_LÆS_2013_758 + 1;                      
          CALL CHECK_756_MOD_758();                                     
          IF SKAL_OPDATERES & OPDAT_SW THEN                             
             CALL OPDAT_2014_758();                                     
          IF SKAL_OPRETTES  & OPDAT_SW THEN                             
             CALL OPRET_2014_758();                                     
          IF FORTSÆT THEN                                               
             CALL FETCH_CURSOR();                                       
       END;                                                             
    END;                                                                
                                                                        
    CALL AFSLUT();                                                      
    IF PUTSKIP THEN PUT SKIP LIST('***** SLUT  BH38100 *****');         
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR                                                RUTINE */
 /*********************************************************************/
 OPEN_CURSOR: PROC;                                                     
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL OPEN CUR4;                                                 
    IF SQLCA.SQLCODE ^= 0 THEN                                          
       CALL SQL_FEJL('001');                                            
                                                                        
 END OPEN_CURSOR;                                                       
                                                                        
 /*********************************************************************/
 /* FETCH CURSOR                                               RUTINE */
 /*********************************************************************/
 FETCH_CURSOR: PROC;                                                    
 DCL  OK_RK           BIT(1)           INIT('0'B);                      
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    OK_RK = NEJ;                                                        
    DO WHILE(FORTSÆT & ^OK_RK & ^CUR_EOF);                              
       EXEC SQL FETCH CUR4                                              
                 INTO :BQ31000N.dindkaar                                
                     ,:BQ31000N.dcprn                                   
                     ,:BQ31000N.ekomnr                                  
                     ,:BQ31000N.eejdnr                                  
                     ,:BQ31000N.elbnr                                   
                     ,:BQ31000N.egennr                                  
                     ,:BQ31000N.INDHOLD_C                               
       ;                                                                
       SELECT(SQLCA.SQLCODE);                                           
           WHEN(0) DO;                                                  
              IF PULS_COUNT > 9999 THEN DO;                             
                 PUT SKIP LIST('PULS: LÆST = '!!ANTLÆS!!                
                               '    OPDATERET = '!!ANTOPDAT);           
                 PULS_COUNT = 1;                                        
              END;                                                      
              ELSE                                                      
                 PULS_COUNT = PULS_COUNT + 1;                           
              IF DINDKAAR_UD = BQ31000N.dindkaar                        
               & EKOMNR_UD   = BQ31000N.ekomnr                          
               & EEJDNR_UD   = BQ31000N.eejdnr                          
               & DCPRN_UD    = BQ31000N.dcprn                           
               & ELBNR_UD    = BQ31000N.elbnr THEN DO;                  
                 OK_RK = NEJ;                                           
              END;                                                      
              ELSE DO;                                                  
                 DINDKAAR_UD  = BQ31000N.dindkaar;                      
                 EKOMNR_UD    = BQ31000N.ekomnr;                        
                 EEJDNR_UD    = BQ31000N.eejdnr;                        
                 DCPRN_UD     = BQ31000N.dcprn;                         
                 ELBNR_UD     = BQ31000N.elbnr;                         
                 EGENNR_UD    = BQ31000N.egennr;                        
                 HJ_DINDKAAR  = BQ31000N.dindkaar;                      
                 HJ_EKOMNR    = BQ31000N.ekomnr;                        
                 HJ_EEJDNR    = BQ31000N.eejdnr;                        
                 HJ_DCPRN     = BQ31000N.dcprn;                         
                 EGO_DCPRN    = BQ31000N.dcprn;                         
                 HJ_ELBNR     = BQ31000N.elbnr;                         
                 HJ_EGENNR    = BQ31000N.egennr;                        
                 HJ_INDHOLD_C = BQ31000N.indhold_c;                     
                 OK_RK        = JA;                                     
              END;                                                      
 /*           IF BQ31000N.EKOMNR = 999 THEN                             
                 OK_RK = JA;                                            
              ELSE                                                      
                 OK_RK = NEJ;                                         */
                                                                        
              IF OK_RK THEN                                             
                 ANTLÆS           = ANTLÆS + 1;                         
              ELSE                                                      
                 ANT_FRASORT = ANT_FRASORT + 1;                         
           END;                                                         
           WHEN(100) DO;                                                
              IF PUTSKIP THEN PUT SKIP LIST('IKKE FLERE DATA');         
              CUR_EOF = JA;                                             
           END;                                                         
           OTHERWISE                                                    
              CALL SQL_FEJL('002');                                     
       END;                                                             
    END;                                                                
                                                                        
 END FETCH_CURSOR;                                                      
                                                                        
 /*********************************************************************/
 /*      DAN KODE                                                     */
 /*********************************************************************/
 DAN_KODE: PROC;                                                        
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    IF PUTSKIP THEN DO;                                                 
       PUT SKIP LIST('DCPRN  = '!!BQ31000N.DCPRN);                      
       PUT SKIP LIST('EKOMNR = '!!BQ31000N.EKOMNR!!                     
                     '  EEJDNR = '!!BQ31000N.EEJDNR!!                   
                     '  ELBNR = '!!BQ31000N.ELBNR!!                     
                     '  EGENNR = '!!BQ31000N.EGENNR);                   
    END;                                                                
    HJ_KODE          = '1';                                             
    EGO_CIVSTANDKODE = '';                                              
    EGO_HENVISNR     = 0;                                               
    EGO_PLOM         = '0';                                             
    ÆGT_CIVSTANDKODE = '';                                              
    ÆGT_HENVISNR     = 0;                                               
    ÆGT_PLOM         = '0';                                             
    LØNCOR           = '0';                                             
    LØNCOR_FLAG      = NEJ;                                             
                                                                        
    CALL SKAF_EVS_VÆRDIER_EGO();                                        
    IF ^EGO_FLAG THEN DO;                                               
       CALL SELECT_BG41100T();                                          
       IF EGO_CIVSTANDKODE = ' ' THEN                                   
          EGO_CIVSTANDKODE = DCLBG41100T.CIVSTKOD;                      
       IF VERIFY(DCLBG41100T.SAMPNR,'0123456789') = 0                   
        & EGO_HENVISNR     = 0 THEN                                     
          EGO_HENVISNR     = DECIMAL(DCLBG41100T.SAMPNR,10,0);          
       IF EGO_PLOM         = ' ' THEN                                   
          EGO_PLOM         = DCLBG41100T.OMFAGSKPLKOD;                  
    END;                                                                
    CALL SELECT_LØNCOR();                                               
                                                                        
 /* CHECK PENSIONIST EGO                                              */
    HJ_CPR = HJ_DCPRN;                                                  
    IF (PERSON_ALDER_OK(PRDATO1,HJ_CPR,'1')                             
       ! PERSON_ALDER_OK(PRDATO1,HJ_CPR,'4'))                           
    THEN DO;                                                            
       HJ_KODE = '3';                                                   
       IF EGO_PLOM = '1'                                                
        ! EGO_PLOM = '3'                                                
        ! EGO_PLOM = '8' THEN DO;                                       
          IF BQ31000N.EKOMNR < 999 THEN                                 
             HJ_KODE = '4';                                             
       END;                                                             
    END;                                                                
    IF PUTSKIP THEN PUT SKIP LIST('EFTER CHECK PENSIONIST EGO  '!!      
                                  HJ_KODE);                             
                                                                        
 /* CHECK LØNCOR KODE                                                 */
    IF HJ_KODE = '1'                                                    
     & LØNCOR_FLAG THEN DO;                                             
       IF LØNCOR = '1'                                                  
        ! LØNCOR = '2'                                                  
        ! LØNCOR = '3'                                                  
        ! LØNCOR = '4' THEN                                             
          HJ_KODE = '2';                                                
    END;                                                                
    IF PUTSKIP THEN PUT SKIP LIST('EFTER CHECK LØNCOR  '!!              
                                  HJ_KODE);                             
                                                                        
 /* CHECK EVT. PENSIONIST ÆGTEFÆLLE                                   */
    IF (HJ_KODE = '1' ! HJ_KODE = '2' ! HJ_KODE = '3') THEN DO;         
        IF EGO_HENVISNR > 0 THEN DO;                                    
          HJ_CPR = EGO_HENVISNR;                                        
          IF PERSON_ALDER_OK(PRDATO1,HJ_CPR,'1')                        
           ! PERSON_ALDER_OK(PRDATO1,HJ_CPR,'4') THEN DO;               
             HJ_DCPRN         = EGO_HENVISNR;                           
             ÆGT_FLAG         = NEJ;                                    
             CALL SKAF_EVS_VÆRDIER_ÆGT();                               
             IF ^ÆGT_FLAG THEN DO;                                      
                CALL SELECT_BG41100T;                                   
                IF ÆGT_CIVSTANDKODE = ' ' THEN                          
                   ÆGT_CIVSTANDKODE = DCLBG41100T.CIVSTKOD;             
                IF VERIFY(DCLBG41100T.SAMPNR,'0123456789') = 0          
                 & ÆGT_HENVISNR     = 0 THEN                            
                   ÆGT_HENVISNR     = DECIMAL(DCLBG41100T.SAMPNR,10,0); 
                IF ÆGT_PLOM         = ' ' THEN                          
                   ÆGT_PLOM         = DCLBG41100T.OMFAGSKPLKOD;         
             END;                                                       
             IF VERIFY(EGO_CIVSTANDKODE,'GPED') = 0                     
              & VERIFY(ÆGT_CIVSTANDKODE,'GPED') = 0                     
              & ÆGT_HENVISNR = EGO_DCPRN                                
             THEN DO;                                                   
                HJ_KODE = '3';                                          
                IF PLOM_FLAG THEN DO;                                   
                   IF (EGO_PLOM = '1'                                   
                     ! EGO_PLOM = '3'                                   
                     ! EGO_PLOM = '8')                                  
                    & (ÆGT_PLOM = '1'                                   
                     ! ÆGT_PLOM = '3'                                   
                     ! ÆGT_PLOM = '8') THEN DO;                         
                      IF BQ31000N.EKOMNR < 999 THEN                     
                         HJ_KODE = '4';                                 
                   END;                                                 
                END;                                                    
             END;                                                       
          END;                                                          
       END;                                                             
    END;                                                                
    IF PUTSKIP THEN PUT SKIP LIST('EFTER CHECK PENSIONIST ÆGT  '!!      
                                  HJ_KODE);                             
                                                                        
 END DAN_KODE;                                                          
                                                                        
 /*********************************************************************/
 /*      KONTROLLER_KODE                                              */
 /*********************************************************************/
 KONTROLLER_KODE: PROC;                                                 
                                                                        
    IF PUTSKIP THEN DO;                                                 
       PUT SKIP LIST('*** '!!PROCNAME!!' ***');                         
 /*    PUT SKIP LIST('DINDKAAR = '!!BQ31000N.DINDKAAR);                 
       PUT SKIP LIST('EKOMNR   = '!!BQ31000N.EKOMNR);                   
       PUT SKIP LIST('EEJDNR   = '!!BQ31000N.EEJDNR);                   
       PUT SKIP LIST('DCPRN    = '!!BQ31000N.DCPRN);                    
       PUT SKIP LIST('ELBNR    = '!!BQ31000N.ELBNR);                  */
    END;                                                                
    IF PUTSKIP THEN PUT SKIP LIST('LÆST KODE = '!!BQ31000N.INDHOLD_C);  
    IF VERIFY(HJ_KODE,'1234') = 0 THEN DO;                              
       IF HJ_INDHOLD_C ^= HJ_KODE THEN DO;                              
          IF (HJ_KODE < '3'                                             
           &  HJ_INDHOLD_C = 2                                          
           & ^LØNCOR_FLAG) THEN DO;                                     
              CALL SKRIV_KONTROL('1','EJ OPDATERET, MANGLER LØNCOR FOR' 
                                 !!' CHECK AF KODE');                   
              IF PUTSKIP THEN                                           
                 PUT SKIP LIST('EJ OPDATERET   HJ_INDHOLD_C = '!!       
                               HJ_INDHOLD_C!!'  LØNCOR_FLAG = '!!       
                              LØNCOR_FLAG);                             
              ANT_LØNKOR_FEJL = ANT_LØNKOR_FEJL + 1;                    
          END;                                                          
          ELSE DO;                                                      
             IF (EGO_CIVSTANDKODE = 'E' & EGO_HENVISNR = 0)             
             THEN DO;                                                   
                IF PUTSKIP THEN                                         
                   PUT SKIP LIST('               CIVSTANDKODE = '!!     
                                 EGO_CIVSTANDKODE!!'   SAMPNR = '!!     
                                 EGO_HENVISNR);                         
                CALL SKRIV_KONTROL('1','EJ OPDATERET. HAR KODE '!!      
                                   EGO_CIVSTANDKODE!!                   
                                   ' MEN MANGLER ÆGTEFÆLLE CPRNR');     
                ANT_ENKE_U_ÆGTEF = ANT_ENKE_U_ÆGTEF + 1;                
             END;                                                       
             ELSE DO;                                                   
                IF HJ_INDHOLD_C = '4'                                   
                 & EGO_PLOM = '0'                                       
                 & ÆGT_PLOM = '0'  THEN DO;                             
                   CALL SKRIV_KONTROL('1','EJ OPDATERET. MANGLER '!!    
                                      'PLOM FOR KONTROL AF 3/4');       
                   ANT_INGEN_PLOM = ANT_INGEN_PLOM + 1;                 
                END;                                                    
                ELSE DO;                                                
                   CALL SKRIV_KONTROL('1','OPDATERET '!!PARMI.ÅRSTAL);  
                   ANTOPDAT = ANTOPDAT + 1;                             
                   IF OPDAT_SW THEN                                     
                      CALL OPDATER_RÆKKE();                             
                END;                                                    
             END;                                                       
          END;                                                          
       END;                                                             
       ELSE                                                             
          ANTEJOPDAT = ANTEJOPDAT + 1;                                  
    END;                                                                
    ELSE DO;                                                            
       CALL SKRIV_KONTROL('1','EJ OPDATERET. KODE IKKE 1/2/3/4. KODE = '
                          !!HJ_KODE);                                   
       ANT_KODE_0 = ANT_KODE_0 + 1;                                     
    END;                                                                
                                                                        
 END KONTROLLER_KODE;                                                   
                                                                        
 /*********************************************************************/
 /* BEHANDL                                                    RUTINE */
 /*********************************************************************/
 OPDATER_RÆKKE: PROC;                                                   
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL                                                            
       UPDATE   BQ31000T A                                              
          SET   INDHOLD_C = :HJ_KODE                                    
          WHERE A.DINDKAAR  = :BQ31000N.DINDKAAR                        
            AND A.EKOMNR    = :BQ31000N.EKOMNR                          
            AND A.EEJDNR    = :BQ31000N.EEJDNR                          
            AND A.DCPRN     = :BQ31000N.DCPRN                           
            AND A.ELBNR     = :BQ31000N.ELBNR                           
            AND A.FELTKODE  = 86                                        
            AND A.EGENNR    = :BQ31000N.EGENNR                          
    ;                                                                   
                                                                        
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0);                                                         
       OTHERWISE                                                        
          CALL SQL_FEJL('003');                                         
    END;                                                                
                                                                        
 END OPDATER_RÆKKE;                                                     
                                                                        
 /*********************************************************************/
 /*      SKRIV KONTROL                                                */
 /*********************************************************************/
 SKRIV_KONTROL: PROC(SK_TYPE,SK_TEXT);                                  
 DCL SK_TYPE         CHAR(1);                                           
 DCL SK_TEXT         CHAR(65);                                          
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    LINIE        = ZZWS2;                                               
    LIN2.CPRNR   = DCPRN_UD;                                            
    LIN2.KOMNR   = EKOMNR_UD;                                           
    LIN2.EEJDNR  = EEJDNR_UD;                                           
    LIN2.ELBNR   = ELBNR_UD;                                            
    IF SK_TYPE = '1' THEN DO;                                           
       LIN2.GL_KODE = HJ_INDHOLD_C;                                     
       LIN2.NY_KODE = HJ_KODE;                                          
    END;                                                                
    ELSE DO;                                                            
       LIN2.GL_KODE = BQ31000X.INDHOLD_C;                               
       LIN2.NY_KODE = BQ31000N.INDHOLD_C;                               
    END;                                                                
    LIN2.TEXT    = SK_TEXT;                                             
    CALL ZZ20300(LINIE,'01');                                           
    LINIE        = ' ';                                                 
                                                                        
 END SKRIV_KONTROL;                                                     
                                                                        
 /*********************************************************************/
 /*      SELECT PÅ BQ31000T - CIVSTAN(80) - DHENVN(100) - PLOM(87)    */
 /*********************************************************************/
 SKAF_EVS_VÆRDIER_EGO: PROC;                                            
 DCL SEV_COUNTER         FIXED BIN(15,0)  INIT(0);                      
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    SEV_COUNTER = 0;                                                    
                                                                        
 /* SELECT CIVISTAND                                                  */
    EXEC SQL                                                            
      select a.INDHOLD_C                                                
        into :BQ31000N.INDHOLD_C                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.ekomnr   = :HJ_EKOMNR                                   
          and a.eejdnr   = :HJ_EEJDNR                                   
          and a.dcprn    = :HJ_DCPRN                                    
          and a.elbnr    = :HJ_ELBNR                                    
          and a.feltkode = 80                                           
          and a.egennr    =                                             
                (                                                       
                 select max(a1.egennr)                                  
                   from  bq30000t a1                                    
                   where a1.dindkaar = a.dindkaar                       
                     and a1.dcprn    = a.dcprn                          
                     and a1.ekomnr   = a.ekomnr                         
                     and a1.eejdnr   = a.eejdnr                         
                     and a1.elbnr    = a.elbnr                          
                )                                                       
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          EGO_CIVSTANDKODE = SUBSTR(BQ31000N.INDHOLD_C,1,1);            
          SEV_COUNTER     = SEV_COUNTER + 1;                            
       END;                                                             
       WHEN(100) DO;                                                    
          EGO_CIVSTANDKODE = ' ';                                       
       END;                                                             
       OTHERWISE CALL SQL_FEJL('105');                                  
    END;                                                                
                                                                        
 /* SELECT DHENVN                                                     */
    EXEC SQL                                                            
      select a.INDHOLD_D                                                
        into :BQ31000N.INDHOLD_D                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.ekomnr   = :HJ_EKOMNR                                   
          and a.eejdnr   = :HJ_EEJDNR                                   
          and a.dcprn    = :HJ_DCPRN                                    
          and a.elbnr    = :HJ_ELBNR                                    
          and a.feltkode = 100                                          
          and a.egennr    =                                             
                (                                                       
                 select max(a1.egennr)                                  
                   from  bq30000t a1                                    
                   where a1.dindkaar = a.dindkaar                       
                     and a1.dcprn    = a.dcprn                          
                     and a1.ekomnr   = a.ekomnr                         
                     and a1.eejdnr   = a.eejdnr                         
                     and a1.elbnr    = a.elbnr                          
                )                                                       
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          EGO_HENVISNR = BQ31000N.INDHOLD_D;                            
          SEV_COUNTER = SEV_COUNTER + 1;                                
       END;                                                             
       WHEN(100) DO;                                                    
          EGO_HENVISNR = 0;                                             
       END;                                                             
       OTHERWISE CALL SQL_FEJL('106');                                  
    END;                                                                
                                                                        
 /* SELECT PLOM                                                       */
    EXEC SQL                                                            
      select a.INDHOLD_C                                                
        into :BQ31000N.INDHOLD_C                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.ekomnr   = :HJ_EKOMNR                                   
          and a.eejdnr   = :HJ_EEJDNR                                   
          and a.dcprn    = :HJ_DCPRN                                    
          and a.elbnr    = :HJ_ELBNR                                    
          and a.feltkode = 87                                           
          and a.egennr    =                                             
                (                                                       
                 select max(a1.egennr)                                  
                   from  bq30000t a1                                    
                   where a1.dindkaar = a.dindkaar                       
                     and a1.dcprn    = a.dcprn                          
                     and a1.ekomnr   = a.ekomnr                         
                     and a1.eejdnr   = a.eejdnr                         
                     and a1.elbnr    = a.elbnr                          
                )                                                       
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          EGO_PLOM       = SUBSTR(BQ31000N.INDHOLD_C,1,1);              
          ANT_PLOM_P    = ANT_PLOM_P + 1;                               
          PLOM_FLAG     = JA;                                           
          SEV_COUNTER   = SEV_COUNTER + 1;                              
       END;                                                             
       WHEN(100) DO;                                                    
          EGO_PLOM       = '0';                                         
          ANT_EJ_PLOM_P = ANT_EJ_PLOM_P + 1;                            
          PLOM_FLAG     = NEJ;                                          
       END;                                                             
       OTHERWISE CALL SQL_FEJL('107');                                  
    END;                                                                
                                                                        
    IF SEV_COUNTER < 3 THEN                                             
       EGO_FLAG = NEJ;                                                  
    ELSE                                                                
       EGO_FLAG = JA;                                                   
                                                                        
 END SKAF_EVS_VÆRDIER_EGO;                                              
                                                                        
 /*********************************************************************/
 /*      SELECT PÅ BQ31000T - CIVSTAN(80) - DHENVN(100) - PLOM(87)    */
 /*********************************************************************/
 SKAF_EVS_VÆRDIER_ÆGT: PROC;                                            
 DCL SEV_ART             chaR(1);                                       
 DCL SEV_COUNTER         FIXED BIN(15,0)  INIT(0);                      
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    SEV_COUNTER = 0;                                                    
                                                                        
 /* SELECT CIVISTAND                                                  */
    EXEC SQL                                                            
      select a.INDHOLD_C                                                
        into :BQ31000N.INDHOLD_C                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.dcprn    = :HJ_DCPRN                                    
          and a.feltkode = 80                                           
        FETCH FIRST ROW ONLY                                            
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          ÆGT_CIVSTANDKODE = SUBSTR(BQ31000N.INDHOLD_C,1,1);            
          SEV_COUNTER     = SEV_COUNTER + 1;                            
       END;                                                             
       WHEN(100) DO;                                                    
          ÆGT_CIVSTANDKODE = ' ';                                       
       END;                                                             
       OTHERWISE CALL SQL_FEJL('105');                                  
    END;                                                                
                                                                        
 /* SELECT DHENVN                                                     */
    EXEC SQL                                                            
      select a.INDHOLD_D                                                
        into :BQ31000N.INDHOLD_D                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.dcprn    = :HJ_DCPRN                                    
          and a.feltkode = 100                                          
        FETCH FIRST ROW ONLY                                            
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          ÆGT_HENVISNR = BQ31000N.INDHOLD_D;                            
          SEV_COUNTER = SEV_COUNTER + 1;                                
       END;                                                             
       WHEN(100) DO;                                                    
          ÆGT_HENVISNR = 0;                                             
       END;                                                             
       OTHERWISE CALL SQL_FEJL('106');                                  
    END;                                                                
                                                                        
 /* SELECT PLOM                                                       */
    EXEC SQL                                                            
      select a.INDHOLD_C                                                
        into :BQ31000N.INDHOLD_C                                        
        from  bq31000t a                                                
        where a.dindkaar = :HJ_DINDKAAR                                 
          and a.dcprn    = :HJ_DCPRN                                    
          and a.feltkode = 87                                           
        FETCH FIRST ROW ONLY                                            
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          ÆGT_PLOM       = SUBSTR(BQ31000N.INDHOLD_C,1,1);              
          ANT_PLOM_P    = ANT_PLOM_P + 1;                               
          PLOM_FLAG     = JA;                                           
          SEV_COUNTER   = SEV_COUNTER + 1;                              
       END;                                                             
       WHEN(100) DO;                                                    
          ÆGT_PLOM       = '0';                                         
          ANT_EJ_PLOM_P = ANT_EJ_PLOM_P + 1;                            
          PLOM_FLAG     = NEJ;                                          
       END;                                                             
       OTHERWISE CALL SQL_FEJL('107');                                  
    END;                                                                
                                                                        
    IF SEV_COUNTER < 3 THEN                                             
       ÆGT_FLAG = NEJ;                                                  
    ELSE                                                                
       ÆGT_FLAG = JA;                                                   
                                                                        
 END SKAF_EVS_VÆRDIER_ÆGT;                                              
                                                                        
                                                                        
 /*********************************************************************/
 /*      SELECT PÅ BG41100T                                           */
 /*********************************************************************/
 SELECT_BG41100T: PROC;                                                 
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL                                                            
       SELECT OMFAGSKPLKOD,SAMPNR,CIVSTKOD                              
         into :DCLBG41100T.OMFAGSKPLKOD                                 
             ,:DCLBG41100T.SAMPNR                                       
             ,:DCLBG41100T.CIVSTKOD                                     
         from  BG41100T a                                               
         where a.PNR     = :HJ_DCPRN                                    
           and a.DINDKÅR = :HJ_DINDKAAR                                 
           and a.DUMMYID =                                              
                 (                                                      
                  SELECT MAX(A1.DUMMYID)                                
                    FROM BG41100T A1                                    
                    WHERE A1.PNR = A.PNR                                
                      AND A1.DINDKÅR = A.DINDKÅR                        
                 )                                                      
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          PLOM_FLAG  = JA;                                              
          ANT_PLOM_P = ANT_PLOM_P + 1;                                  
       END;                                                             
       WHEN(100) DO;                                                    
          PLOM_FLAG = NEJ;                                              
       END;                                                             
       OTHERWISE CALL SQL_FEJL('004');                                  
    END;                                                                
                                                                        
 END SELECT_BG41100T;                                                   
                                                                        
                                                                        
                                                                        
 /*********************************************************************/
 /*      SELECT PÅ BQ31000T - LØNCOR                                  */
 /*********************************************************************/
 SELECT_LØNCOR: PROC;                                                   
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL                                                            
       select a.INDHOLD_C                                               
          into :BQ31000N.INDHOLD_C                                      
          from  bq31000t a                                              
          where a.dindkaar = :HJ_DINDKAAR                               
            and a.ekomnr   = :HJ_EKOMNR                                 
            and a.eejdnr   = :HJ_EEJDNR                                 
            and a.dcprn    = :HJ_DCPRN                                  
            and a.elbnr    = :HJ_ELBNR                                  
            and a.feltkode = 73                                         
            and a.egennr    =                                           
                (                                                       
                 select max(a1.egennr)                                  
                    from  bq30000t a1                                   
                    where a1.dindkaar = a.dindkaar                      
                      and a1.dcprn    = a.dcprn                         
                      and a1.ekomnr   = a.ekomnr                        
                      and a1.eejdnr   = a.eejdnr                        
                      and a1.elbnr    = a.elbnr                         
                )                                                       
    ;                                                                   
    SELECT(SQLCA.SQLCODE);                                              
       WHEN(0) DO;                                                      
          LØNCOR      = BQ31000N.INDHOLD_C;                             
          LØNCOR_FLAG = JA;                                             
       END;                                                             
       WHEN(100) DO;                                                    
          LØNCOR_FLAG   = NEJ;                                          
          ANT_EJ_LØNCOR = ANT_EJ_LØNCOR +1 ;                            
       END;                                                             
       OTHERWISE CALL SQL_FEJL('006');                                  
    END;                                                                
                                                                        
 END SELECT_LØNCOR;                                                     
                                                                        
 /*********************************************************************/
 /*      SKAF PARM                                                    */
 /*********************************************************************/
 SKAF_PARM: PROC;                                                       
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    OPEN FILE(IPARM) TITLE('BH38100I');                                 
    READ FILE(IPARM) INTO(PARMI);                                       
    IF ^PARM_EOF THEN DO;                                               
       IF PARMI.KØRSW ^= ' ' THEN                                       
          OPDAT_SW = JA;                                                
       ELSE                                                             
          OPDAT_SW = NEJ;                                               
       IF VERIFY(PARMI.ÅRSTAL,'0123456789') = 0 THEN                    
          AARSTAL = PARMI.ÅRSTAL;                                       
       ELSE DO;                                                         
          PUT SKIP LIST('DEFAULT ÅR SAT OP');                           
          AARSTAL = 2013;                                               
       END;                                                             
       IF VERIFY(PARMI.FUNK,'ABX') = 0 THEN DO;                         
          SELECT(PARMI.FUNK);                                           
             WHEN('A') GO_756 = JA;                                     
             WHEN('B') GO_758 = JA;                                     
             WHEN('X') DO;                                              
                GO_756 = JA;                                            
                GO_758 = JA;                                            
             END;                                                       
             OTHERWISE;                                                 
          END;                                                          
       END;                                                             
       ELSE DO;                                                         
          PUT SKIP LIST('DEFAULT OPDATERING OG PROGRAM FUNKTION OPSAT');
          OPDAT_SW = NEJ;                                               
          PGM_FUNK = 'B';                                               
       END;                                                             
       IF VERIFY(PARMI.PENSDATO,'0123456789') = 0 THEN                  
          PRDATO1 = DEC(PARMI.PENSDATO,8,0);                            
    END;                                                                
    ELSE DO;                                                            
       PUT SKIP LIST('DEFAULT OPDATERING, ÅRSTAL OG PROGRAM FUNKTION '!!
                     'OPSAT');                                          
       OPDAT_SW = NEJ;                                                  
       AARSTAL   = PARMI.ÅRSTAL;                                        
       GO_756   = JA;                                                   
       GO_758   = JA;                                                   
    END;                                                                
                                                                        
    PUT SKIP LIST('Der er eksekveret med årstal:             '!!        
                   AARSTAL);                                            
    PUT SKIP LIST('Der er kørt med følgende pensionist dato: '!!        
                   PRDATO1);                                            
    IF GO_756 THEN                                                      
       PUT SKIP LIST('Behandling af 756 kode udføres');                 
    IF GO_758 THEN                                                      
       PUT SKIP LIST('Behandling af 758 kode udføres');                 
    IF OPDAT_SW THEN                                                    
       PUT SKIP LIST('Der sker opdatering af BQ31000T');                
    ELSE                                                                
       PUT SKIP LIST('Ingen opdatering af BQ31000T');                   
                                                                        
 END SKAF_PARM;                                                         
                                                                        
 /*********************************************************************/
 /* CHECK 2013 756 MOD 2014 758                                       */
 /*********************************************************************/
 CHECK_756_MOD_758: PROC;                                               
                                                                        
    IF PUTSKIP THEN DO;                                                 
       PUT SKIP LIST('*** '!!PROCNAME!!' ***');                         
       PUT SKIP LIST('2013');                                           
       PUT SKIP LIST('DINDKAAR = '!!BQ31000N.DINDKAAR);                 
       PUT SKIP LIST('EKOMNR   = '!!BQ31000N.EKOMNR);                   
       PUT SKIP LIST('EEJDNR   = '!!BQ31000N.EEJDNR);                   
       PUT SKIP LIST('DCPRN    = '!!BQ31000N.DCPRN);                    
       PUT SKIP LIST('ELBNR    = '!!BQ31000N.ELBNR);                    
       PUT SKIP LIST('FELTKODE = '!!BQ31000N.FELTKODE);                 
       PUT SKIP LIST('INDHOLD  = '!!BQ31000N.INDHOLD_C);                
    END;                                                                
    SKAL_OPDATERES = NEJ;                                               
    SKAL_OPRETTES  = NEJ;                                               
    IF CHECK_EXIST THEN DO;                                             
       BQ31000X = '';                                                   
       EXEC SQL                                                         
          select distinct a.dindkaar,a.dcprn,a.ekomnr,a.eejdnr,a.elbnr, 
                          a.egennr,a.feltkode,a.INDHOLD_C               
             INTO :BQ31000X.dindkaar                                    
                 ,:BQ31000X.dcprn                                       
                 ,:BQ31000X.ekomnr                                      
                 ,:BQ31000X.eejdnr                                      
                 ,:BQ31000X.elbnr                                       
                 ,:BQ31000X.egennr                                      
                 ,:BQ31000X.feltkode                                    
                 ,:BQ31000X.INDHOLD_C                                   
            from bq31000t a                                             
            where a.dindkaar = (:BQ31000N.DINDKAAR + 1)                 
              and a.ekomnr   = :BQ31000N.EKOMNR                         
              and a.eejdnr   = :BQ31000N.EEJDNR                         
              and a.dcprn    = :BQ31000N.DCPRN                          
              and a.elbnr    = :BQ31000N.ELBNR                          
              and a.feltkode = 85                                       
              and a.egennr    =                                         
                    (                                                   
                     select max(a1.egennr)                              
                        from bq30000t a1                                
                        where a1.dindkaar = a.dindkaar                  
                          and a1.dcprn    = a.dcprn                     
                          and a1.ekomnr   = a.ekomnr                    
                          and a1.eejdnr   = a.eejdnr                    
                          and a1.elbnr    = a.elbnr                     
                    )                                                   
       ;                                                                
       SELECT(SQLCA.SQLCODE);                                           
          WHEN(0)   DO;                                                 
             IF PUTSKIP THEN DO;                                        
                PUT SKIP LIST('2013');                                  
                PUT SKIP LIST('DINDKAAR = '!!BQ31000X.DINDKAAR);        
                PUT SKIP LIST('EKOMNR   = '!!BQ31000X.EKOMNR);          
                PUT SKIP LIST('EEJDNR   = '!!BQ31000X.EEJDNR);          
                PUT SKIP LIST('DCPRN    = '!!BQ31000X.DCPRN);           
                PUT SKIP LIST('ELBNR    = '!!BQ31000X.ELBNR);           
                PUT SKIP LIST('FELTKODE = '!!BQ31000X.FELTKODE);        
                PUT SKIP LIST('INDHOLD  = '!!BQ31000X.INDHOLD_C);       
             END;                                                       
             IF BQ31000N.INDHOLD_C ^= BQ31000X.INDHOLD_C THEN DO;       
                CALL SKRIV_KONTROL('2','OPDATERET 2014');               
                ANT_OPDATERET_2014 = ANT_OPDATERET_2014 + 1;            
                SKAL_OPDATERES     = JA;                                
             END;                                                       
             ELSE                                                       
                ANT_756_758_ENS = ANT_756_758_ENS + 1;                  
          END;                                                          
          WHEN(100) DO;                                                 
             CALL SKRIV_KONTROL('2','OPRETTET I 2014');                 
             ANT_OPRETTET_2014 = ANT_OPRETTET_2014 + 1;                 
             SKAL_OPRETTES     = JA;                                    
          END;                                                          
          OTHERWISE                                                     
             CALL SQL_FEJL('007');                                      
       END;                                                             
    END;                                                                
                                                                        
 CHECK_EXIST: PROC RETURNS(BIT(1));                                     
 DCL RTC           BIT(1)        INIT('0');                             
                                                                        
     EXEC SQL                                                           
       select distinct a.dindkaar,a.dcprn                               
          INTO :BQ31000X.dindkaar                                       
              ,:BQ31000X.dcprn                                          
            from bq31000t a                                             
            where a.dindkaar = (:BQ31000N.DINDKAAR + 1)                 
              and a.ekomnr   = :BQ31000N.EKOMNR                         
              and a.eejdnr   = :BQ31000N.EEJDNR                         
              and a.dcprn    = :BQ31000N.DCPRN                          
              and a.elbnr    = :BQ31000N.ELBNR                          
              and a.feltkode = 85                                       
              and a.egennr    =                                         
                    (                                                   
                     select max(a1.egennr)                              
                        from bq30000t a1                                
                        where a1.dindkaar = a.dindkaar                  
                          and a1.dcprn    = a.dcprn                     
                          and a1.ekomnr   = a.ekomnr                    
                          and a1.eejdnr   = a.eejdnr                    
                          and a1.elbnr    = a.elbnr                     
                    )                                                   
       ;                                                                
       SELECT(SQLCA.SQLCODE);                                           
          WHEN(0)   DO;                                                 
             IF PUTSKIP THEN DO;                                        
                PUT SKIP LIST('2013');                                  
                PUT SKIP LIST('DINDKAAR = '!!BQ31000X.DINDKAAR);        
                PUT SKIP LIST('DCPRN    = '!!BQ31000X.DCPRN);           
             END;                                                       
             RTC = JA;                                                  
          END;                                                          
          WHEN(100) DO;                                                 
             ANT_EJ_2014 = ANT_EJ_2014 + 1;                             
             RTC = NEJ;                                                 
          END;                                                          
          OTHERWISE                                                     
             CALL SQL_FEJL('010');                                      
       END;                                                             
       RETURN(RTC);                                                     
                                                                        
 END CHECK_EXIST;                                                       
                                                                        
 END CHECK_756_MOD_758;                                                 
                                                                        
 /*********************************************************************/
 /* OPDATER BQ31000T 2014 758                                  RUTINE */
 /*********************************************************************/
 OPDAT_2014_758: PROC;                                                  
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL                                                            
       UPDATE   BQ31000T A                                              
          SET   INDHOLD_C = :BQ31000N.INDHOLD_C                         
          WHERE A.DINDKAAR  = :BQ31000X.DINDKAAR                        
            AND A.EKOMNR    = :BQ31000X.EKOMNR                          
            AND A.EEJDNR    = :BQ31000X.EEJDNR                          
            AND A.DCPRN     = :BQ31000X.DCPRN                           
            AND A.ELBNR     = :BQ31000X.ELBNR                           
            AND A.EGENNR    = :BQ31000X.EGENNR                          
            AND A.FELTKODE  = :BQ31000X.FELTKODE                        
    ;                                                                   
                                                                        
    IF SQLCA.SQLCODE ^= 0 THEN                                          
       CALL SQL_FEJL('008');                                            
                                                                        
 END OPDAT_2014_758;                                                    
                                                                        
 /*********************************************************************/
 /* OPRET BQ31000T 2014 758                                    RUTINE */
 /*********************************************************************/
 OPRET_2014_758: PROC;                                                  
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL                                                            
       INSERT INTO BQ31000T                                             
          VALUES(:BQ31000X.DINDKAAR                                     
                ,:BQ31000X.EKOMNR                                       
                ,:BQ31000X.EEJDNR                                       
                ,:BQ31000X.DCPRN                                        
                ,:BQ31000X.ELBNR                                        
                ,:BQ31000X.EGENNR                                       
                ,85                                                     
                ,3                                                      
                ,:BQ31000N.INDHOLD_C                                    
                ,0)                                                     
    ;                                                                   
                                                                        
    IF SQLCA.SQLCODE ^= 0 THEN                                          
       CALL SQL_FEJL('008');                                            
                                                                        
 END OPRET_2014_758;                                                    
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC(SF_SEQNR);                                              
 DCL SF_SEQNR            CHAR(3);                                       
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    FORTSÆT = NEJ;                                                      
    PUT SKIP LIST('SQL_FEJL I SQL-STATEMENT: '!!SF_SEQNR);              
    PUT SKIP LIST('SQLCA',SQLCA);                                       
    CALL ZS67000(SQLCA);                                                
    ABENDMEDD =  FEJLTEKST;                                             
    CALL ZS30101 (5, ABENDMEDD, 2);                                     
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* LUK FILER, CURSOR OG UDSKRIV AFSTEMNINGS- OG KONTROLLISTE  RUTINE */
 /*********************************************************************/
 AFSLUT: PROC;                                                          
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    CALL CLOSE_CURSOR;                                                  
    IF GO_756 THEN DO;                                                  
       LINIE = '';                                                      
       LINIE = ZZWS2;                                                   
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = ZZWS2!!'GENOPRETNING AF 756';                            
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = ZZWS2;                                                   
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL LÆSTE ...................................';  
       LIN1.ANT   = ANT_LÆS_2013_756;                                   
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL UDEN LØNCOR .............................';  
       LIN1.ANT   = ANT_LØNKOR_FEJL;                                    
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL UDEN PLOM ...............................';  
       LIN1.ANT   = ANT_INGEN_PLOM;                                     
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL ENKER UDEN ÆGTEFÆLLE ....................';  
       LIN1.ANT   = ANT_ENKE_U_ÆGTEF;                                   
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL MED ENS 756 .............................';  
       LIN1.ANT   = ANTEJOPDAT;                                         
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL OPDATEREDE 2013 .........................';  
       LIN1.ANT   = ANTOPDAT;                                           
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL FRASORTERET .............................';  
       LIN1.ANT   = ANT_FRASORT;                                        
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL HVOR KODE IKKE ER 1/2/3/4 ...............';  
       LIN1.ANT   = ANT_KODE_0;                                         
       CALL ZZ20300(LINIE,'01');                                        
    END;                                                                
    IF GO_758 THEN DO;                                                  
       LINIE = '';                                                      
       LINIE = ZZWS2;                                                   
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = ZZWS2!!'GENOPRETNING AF 758';                            
       CALL ZZ20300(LINIE,'01');                                        
       LINIE = ZZWS2;                                                   
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL LÆST 2013 756 ...........................';  
       LIN1.ANT   = ANT_LÆS_2013_758;                                   
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL EJ I 2014 ...............................';  
       LIN1.ANT   = ANT_EJ_2014;                                        
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL oprettet 2014 ...........................';  
       LIN1.ANT   = ANT_OPRETTET_2014;                                  
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL 756/758 ENS .............................';  
       LIN1.ANT   = ANT_756_758_ENS;                                    
       CALL ZZ20300(LINIE,'01');                                        
       LIN1.TEKST = 'ANTAL OPDATEREDE 2014 .........................';  
       LIN1.ANT   = ANT_OPDATERET_2014;                                 
       CALL ZZ20300(LINIE,'01');                                        
    END;                                                                
    LINIE = '';                                                         
    LINIE = ZZWS2;                                                      
    CALL ZZ20300(LINIE,'01');                                           
    LINIE = '';                                                         
    LINIE = ZZWS2;                                                      
    CALL ZZ20300(LINIE,'01');                                           
    LIN1.TEKST = 'ANTAL LÆST ....................................';     
    LIN1.ANT   = ANTLÆS;                                                
    CALL ZZ20300(LINIE,'01');                                           
    CALL ZZ20300(' ','99');                      /* LUK KMDSPOOL */     
                                                                        
 END AFSLUT;                                                            
                                                                        
 /*********************************************************************/
 /* CLOSE CURSOR                                               RUTINE */
 /*********************************************************************/
 CLOSE_CURSOR: PROC;                                                    
                                                                        
    IF PUTSKIP THEN PUT SKIP LIST('*** '!!PROCNAME!!' ***');            
    EXEC SQL CLOSE CUR4;                                                
                                                                        
 END CLOSE_CURSOR;                                                      
                                                                        
 %INCLUDE BH65500M;     /* UNDERSØG/BEREGN EN PERSON'S ALDER         */ 
                                                                        
 END BH38100;                                                           
