 PROCESS OPT(TIME);                                                     
 BH71500:   /* NYT ESR DATASÆT FRA GL ESR DATASÆT */                    
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /********************************************************************/ 
  DCL COPYRIGHT   CHAR (30) STATIC    INIT ('COPYRIGHT KMD A/S 2019');  
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : HJÆLPE PROGRAM TIL AT OMSÆTTE FRA GL ESR BH3180XN         * 
 *          STRUKTUR TIL NY ESR STRUKTUR BH31800N TIL BRUG            * 
 *          FOR SAMMENLIGNING                                         * 
 *                                                                    * 
 * INPUT  : C.N570X0D  UDTRÆK FRA ESR (X=1 HVIS SLUT,X=4 HVIS FORSKUD)* 
 * OUTPUT : C.N570X0D  UDTRÆK FRA ESR (X=1 HVIS SLUT,X=4 HVIS FORSKUD)* 
 *                                                                    * 
 * PROGRAMMØR: Esben Brodersen                         APR  2019      * 
 * TIL FORSKUD 2020 PROGRAMMET KUN TIL PILOT                          * 
 * TILRETTET TIL SLUT 2019                                            * 
 * TILRETTET TIL SLUT 2020                             PBR 23-10-2020 * 
 *********************************************************************/ 
 /*       DEFAULT RANGE (*) STATIC UNALIGNED CONN;                      
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
 DCL     BH715I  FILE RECORD INPUT;           /* ESR UDTRÆK NY STRUK */ 
 DCL     BH715O  FILE RECORD OUTPUT;          /* ESR UDTRÆK GL STRUK */ 
 /********************************************************************* 
 *       DECLARE AF ESR UDTRÆK INPUT                                  * 
 *********************************************************************/ 
 DCL     BH715_IND        CHAR (2000) VAR;                              
 DCL     BH715_UD         CHAR (2000) VAR;                              
                                                                        
                                                                        
 DCL     1 BH715IND         BASED     (ADDR(BH715_IND)),                
           4 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH71500N;                                           
                                                                        
 DCL     1 BH715UD         BASED     (ADDR(BH715_UD)),                  
           4 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH31800N;                                           
                                                                        
 DCL     HJ_LÆNGDE  BIN FIXED (15) INIT(0);                             
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     EOF_BH715I       BIT       (1);                                
 DCL     JA              BIT       (1)     INIT ('1'B);                 
 DCL     NEJ             BIT       (1)     INIT ('0'B);                 
 DCL     TV_SKR          BIN FIXED(31)     INIT(0);                     
 DCL     TV_LÆS          BIN FIXED(31)     INIT(0);                     
                                                                        
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     MOD             BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     LENGTH          BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS61900         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
 /********************************************************************* 
 *       HOUSEKEEPING                                                 * 
 *********************************************************************/ 
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
         EOF_BH715I = NEJ;                                              
                                                                        
         ON ERROR CALL PLIDUMP ('SNHOB');                               
         OPEN FILE (BH715I)  TITLE ('BH71500I');                        
         OPEN FILE (BH715O)  TITLE ('BH71500O');                        
                                                                        
         ON ENDFILE (BH715I)                                            
         BEGIN;                                                         
            EOF_BH715I = JA;                                            
         END;                                                           
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
         CALL LÆS_BH715I;                                               
                                                                        
         DO WHILE (EOF_BH715I = NEJ);                                   
           CALL BEHANDL;                                                
           CALL LÆS_BH715I;                                             
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /********************************************************************* 
 *       LÆS ESR UDTRÆK                                               * 
 *********************************************************************/ 
 LÆS_BH715I: PROC;                                                      
                                                                        
        BH715IND = '';                                                  
                                                                        
        READ FILE (BH715I) INTO (BH715_IND);                            
                                                                        
        IF EOF_BH715I = NEJ                                             
        THEN                                                            
          TV_LÆS = TV_LÆS + 1;                                          
                                                                        
 END LÆS_BH715I;                                                        
 /********************************************************************* 
 *       BEHANDL EJERE                                                * 
 *********************************************************************/ 
 BEHANDL: PROC;                                                         
                                                                        
        BH715UD = '';                                                   
                                                                        
                                                                        
        IF BH715IND.DCPRCIR < 9999999999                                
        THEN                                                            
          DO;                                                           
            BH715UD = BH715IND, BY NAME;                                
            BH715UD.STRAKS_EVS = 'N'; /* Nyt felt Forskud 2020 */       
            /* Nu til slut 2020*/                                       
            IF BH715UD.VURDOPLNY.DVURDÅR = '2019'                       
            THEN                                                        
              DO;                                                       
                BH715UD.VURDOPLNY.DVURDÅR = '2020';                     
              END;                                                      
                                                                        
            IF BH715UD.VURDOPLGL.DVURDÅR = '2018'                       
            THEN                                                        
              DO;                                                       
                BH715UD.VURDOPLGL.DVURDÅR = '2019';                     
              END;                                                      
                                                                        
            IF BH715UD.DOVTG >= 20190101 &                              
               BH715UD.DOVTG <= 20191231                                
            THEN                                                        
              DO;                                                       
                BH715UD.DOVTG = BH715UD.DOVTG + 10000;                  
              END;                                                      
                                                                        
            IF BH715UD.DAFSTÅ >= 20190101 &                             
               BH715UD.DAFSTÅ <= 20191231                               
            THEN                                                        
              DO;                                                       
                BH715UD.DAFSTÅ = BH715UD.DAFSTÅ + 10000;                
              END;                                                      
                                                                        
            IF BH715UD.DAFGDAT >= 20190101 &                            
               BH715UD.DAFGDAT <= 20191231                              
            THEN                                                        
              DO;                                                       
                BH715UD.DAFGDAT = BH715UD.DAFGDAT + 10000;              
              END;                                                      
                                                                        
            BH715UD.LÆNGDE = 913; /*Længde BH31800N*/                   
            WRITE FILE (BH715O) FROM (BH715_UD);                        
            TV_SKR = TV_SKR + 1;                                        
          END;                                                          
        ELSE                                                            
          DO;                                                           
            BH715UD = BH715IND, BY NAME;                                
            BH715UD.LÆNGDE = 924; /*Længde BH31800N*/                   
            PUT SKIP LIST('TOTAL INDIVID');                             
            WRITE FILE (BH715O) FROM (BH715_UD);                        
            TV_SKR = TV_SKR + 1;                                        
          END;                                                          
                                                                        
                                                                        
                                                                        
 END BEHANDL;                                                           
 /*********************************************************************/
 /*      CLOSE AF FILER OG SPOOL                                      */
 /*********************************************************************/
 AFSLUT:PROC;                                                           
                                                                        
         PUT SKIP LIST('*********************************');            
         PUT SKIP LIST('ANTAL LÆST    =',TV_LÆS);                       
         PUT SKIP LIST('ANTAL SKREVET =',TV_SKR);                       
         PUT SKIP LIST('*********************************');            
                                                                        
         CLOSE FILE (BH715I);                                           
         CLOSE FILE (BH715O);                                           
                                                                        
                                                                        
 END AFSLUT;                                                            
 /*********************************************************************/
 END BH71500;                                                           
