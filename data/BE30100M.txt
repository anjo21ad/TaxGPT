 /**********************************************************************
 * PROJEKT:     EVS FORSKUD/SLUT                                       *
 * PROGRAMNAVN: BE30100M                                               *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK NYESTE BENYTTEDE LØBENR. PR. EJENDOM PR.    *
 *              PERSON FRA EVS FORSKUD                                 *
 * PROGRAMMØR:  Tina Carstens (TIC), FORSKUD 2025     BF17 02.06.2023. *
 * PROGRAMMØR:  JXT/MBS, FORSKUD 2025 US1641246 ÆA53  BF17 17.01.2024. *
 * Forskud 2025 PBR,  Defekt 2416                          21.05.2024. *
 *              Hvis landekode = FR ændres landekode til F1 eller F2   *
 * SLUT 2024    Jan Erik Jensen (Z6XJY)                    28.10.2024  *
 *              #1888922 Konvertering af udenlandske ejendomsnumre:    *
 *              Fjernet check for SQL fejl efter SQL DECLARE CURSOR    *
 **********************************************************************/
 /*********************************************************************/
 /*      DECLARE CURSOR HENT BS01700T - Ejerforhold             RUTINE*/
 /*********************************************************************/
 DECLARE_BS01700T_EJERFORHOLD: PROC;                                    
                                                                        
         EXEC SQL DECLARE BS017_EJERFH_CUR CURSOR WITH HOLD FOR         
                                                                        
         SELECT BS017.DINDKAAR                                          
               ,BS017.PERSONNUMMER                                      
               ,BS017.EKOMNR                                            
               ,BS017.EEJDNR                                            
               ,BS017.EENHEDLBNR                                        
               ,BS017.EPLBNR                                            
               ,BS017.DFRAGLD                                           
               ,BS017.DTILGLD                                           
               ,BS017.CEVSBENY                                          
               ,BS017.CEJBEVS                                           
               ,BS017.DOVTG                                             
               ,BS017.DAFSTAA                                           
               ,BS017.COPR_CEJBEVS                                      
               ,BS017.CEJDTYPE                                          
               ,BS017.GPCTEJER                                          
               ,BS017.BBERGRL                                           
               ,BS017.BPROM1                                            
               ,BS017.CNEDSL1                                           
               ,BS017.BUDLSKC                                           
               ,BS017.DATO0107                                          
               ,BS017.FDAGEJ                                            
               ,BS017.FDAGUDLE                                          
               ,BS017.GPCTUDLE                                          
               ,BS017.FDAGERHV                                          
               ,BS017.GPCTERHV                                          
               ,BS017.BBRUTTO                                           
               ,BS017.B100                                              
               ,BS017.BEJERAN                                           
               ,BS017.BBER2FAM                                          
               ,BS017.CFRED                                             
               ,BS017.BNYMAN                                            
               ,BS017.CENKE                                             
               ,BS017.DINDFLYT                                          
               ,BS017.DFRAFLYT                                          
               ,BS017.CSLET                                             
               ,BS017.CEKSEMP                                           
               ,BS017.COPR_EKSEMP                                       
               ,BS017.VURMARK_AKT                                       
               ,BS017.VURMARK                                           
               ,BS017.CRTEKORNS                                         
               ,BS017.COPR_CRTEKORNS                                    
               ,BS017.EJET20240101                                      
               ,BS017.RES_EVSEFTERRABAT                                 
               ,BS017.COPR_DOVTG                                        
               ,BS017.RABATEJERANDEL                                    
               ,BS017.COPR_RABATEJERANDEL                               
               ,BS017.CVUR_KAT                                          
               ,BS017.COPR_CVUR_KAT                                     
               ,BS017.RES_FAKTISKRABAT                                  
               ,BS015.EJDBELIG                                          
               ,BS015.EJD_VEJK                                          
               ,BS015.EJD_HUSNR                                         
               ,BS015.EJD_ETAGE                                         
               ,BS015.EJD_SDØR                                          
               ,BS015.ENHEDBELIG                                        
               ,BS015.ENHED_VEJK                                        
               ,BS015.ENHED_HUSNR                                       
               ,BS015.ENHED_ETAGE                                       
               ,BS015.ENHED_SDØR                                        
               ,BS015.LANDEKODE                                         
               ,BS015.VURMARK_AKT                                       
               ,BS015.VURMARK_OM                                        
               ,BS015.VURMARK                                           
               ,BS015.BFENR                                             
               ,BS015.VUREJENDOMID                                      
           FROM BS01700T BS017, BS01500T BS015                          
          WHERE  BS017.DINDKAAR    = :BE55600M.SLUTÅR   /*#01*/         
            AND  BS017.DINDKAAR    = BS015.DINDKAAR                     
            AND  BS017.EKOMNR      = BS015.EKOMNR                       
            AND (:PARMKOMNR1       = 0                                  
             OR (:PARMKOMNR1      <> 0 AND                              
                 BS017.EKOMNR     IN (:PARMKOMNR1, 999))                
             OR (:PARMKOMNR1      <> 0 AND :PARMKOMNR2 <> 0 AND         
                 BS017.EKOMNR     IN (:PARMKOMNR1,:PARMKOMNR2, 999))    
             OR (:PARMKOMNR1      <> 0 AND :PARMKOMNR2 <> 0 AND         
                 :PARMKOMNR3      <> 0 AND                              
                 BS017.EKOMNR     IN (:PARMKOMNR1,:PARMKOMNR2,          
                                      :PARMKOMNR3, 999)))               
            AND  BS017.EEJDNR      = BS015.EEJDNR                       
            AND  BS017.EENHEDLBNR  = BS015.EENHEDLBNR                   
            AND  BS017.DTILGLD IN (SELECT MAX(BS0171.DTILGLD)           
                                     FROM BS01700T BS0171               
                                    WHERE BS0171.PERSONNUMMER =         
                                                    BS017.PERSONNUMMER  
                                      AND BS0171.DINDKAAR     =         
                                                    BS017.DINDKAAR      
                                      AND BS0171.EKOMNR  = BS017.EKOMNR 
                                      AND BS0171.EEJDNR  = BS017.EEJDNR 
                                      AND BS0171.EENHEDLBNR   =         
                                                    BS017.EENHEDLBNR    
                                      AND BS0171.EPLBNR  = BS017.EPLBNR)
         ORDER BY BS017.PERSONNUMMER,                                   
                  BS017.EKOMNR,                                         
                  BS017.EEJDNR,                                         
                  BS017.EENHEDLBNR,                                     
                  BS017.EPLBNR;                                         
                                                                        
 END DECLARE_BS01700T_EJERFORHOLD;                                      
 /*********************************************************************/
 /* OPEN CURSOR til læs af BS01700T - Ejerforhold              RUTINE */
 /*********************************************************************/
 OPEN_BS01700T_EJERFORHOLD: PROC;                                       
                                                                        
         EXEC SQL OPEN BS017_EJERFH_CUR;                                
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN DO;                                                       
            FEJLTEKST = 'OPEN BS017_EJERFH_CUR';                        
            CALL SQL_FEJL;                                              
            END;                                                        
                                                                        
 END OPEN_BS01700T_EJERFORHOLD;                                         
 /*********************************************************************/
 /* CLOSE CURSOR til læs af BS01700T - Ejerforhold             RUTINE */
 /*********************************************************************/
 CLOSE_BS01700T_EJERFORHOLD: PROC;                                      
                                                                        
         EXEC SQL CLOSE BS017_EJERFH_CUR;                               
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN DO;                                                       
            FEJLTEKST = 'CLOSE BS017_EJERFH_CUR';                       
            CALL SQL_FEJL;                                              
            END;                                                        
                                                                        
 END CLOSE_BS01700T_EJERFORHOLD;                                        
 /*********************************************************************/
 /*      HENT BS001700T - Ejerforhold                                 */
 /*********************************************************************/
 FETCH_BS01700T_EJERFORHOLD: PROC;                                      
                                                                        
         BS017_BNYMAN_SW        = -1;                                   
         BS017_EVSEFTERRABAT_SW = -1;                                   
         BS017_RABATEJERANDEL_SW = -1;                                  
                                                                        
         EXEC SQL FETCH BS017_EJERFH_CUR                                
                                                                        
         INTO                                                           
              :DCLBS01700T.DINDKAAR                                     
             ,:DCLBS01700T.PERSONNUMMER                                 
             ,:DCLBS01700T.EKOMNR                                       
             ,:DCLBS01700T.EEJDNR                                       
             ,:DCLBS01700T.EENHEDLBNR                                   
             ,:DCLBS01700T.EPLBNR                                       
             ,:DCLBS01700T.DFRAGLD                                      
             ,:DCLBS01700T.DTILGLD                                      
             ,:DCLBS01700T.CEVSBENY                                     
             ,:DCLBS01700T.CEJBEVS                                      
             ,:DCLBS01700T.DOVTG                                        
             ,:DCLBS01700T.DAFSTAA                                      
             ,:DCLBS01700T.COPR_CEJBEVS                                 
             ,:DCLBS01700T.CEJDTYPE                                     
             ,:DCLBS01700T.GPCTEJER                                     
             ,:DCLBS01700T.BBERGRL                                      
             ,:DCLBS01700T.BPROM1                                       
             ,:DCLBS01700T.CNEDSL1                                      
             ,:DCLBS01700T.BUDLSKC                                      
             ,:DCLBS01700T.DATO0107                                     
             ,:DCLBS01700T.FDAGEJ                                       
             ,:DCLBS01700T.FDAGUDLE                                     
             ,:DCLBS01700T.GPCTUDLE                                     
             ,:DCLBS01700T.FDAGERHV                                     
             ,:DCLBS01700T.GPCTERHV                                     
             ,:DCLBS01700T.BBRUTTO                                      
             ,:DCLBS01700T.B100                                         
             ,:DCLBS01700T.BEJERAN                                      
             ,:DCLBS01700T.BBER2FAM                                     
             ,:DCLBS01700T.CFRED                                        
             ,:DCLBS01700T.BNYMAN:BS017_BNYMAN_SW                       
             ,:DCLBS01700T.CENKE                                        
             ,:DCLBS01700T.DINDFLYT                                     
             ,:DCLBS01700T.DFRAFLYT                                     
             ,:DCLBS01700T.CSLET                                        
             ,:DCLBS01700T.CEKSEMP                                      
             ,:DCLBS01700T.COPR_EKSEMP                                  
             ,:DCLBS01700T.VURMARK_AKT                                  
             ,:DCLBS01700T.VURMARK                                      
             ,:DCLBS01700T.CRTEKORNS                                    
             ,:DCLBS01700T.COPR_CRTEKORNS                               
             ,:DCLBS01700T.EJET20240101                                 
             ,:DCLBS01700T.RES_EVSEFTERRABAT:BS017_EVSEFTERRABAT_SW     
             ,:DCLBS01700T.COPR_DOVTG                                   
             ,:DCLBS01700T.RABATEJERANDEL :BS017_RABATEJERANDEL_SW      
             ,:DCLBS01700T.COPR_RABATEJERANDEL                          
             ,:DCLBS01700T.CVUR_KAT                                     
             ,:DCLBS01700T.COPR_CVUR_KAT                                
             ,:DCLBS01700T.RES_FAKTISKRABAT                             
               :BS017_RES_FAKTISKRABAT_SW                               
             ,:DCLBS01500T.EJDBELIG                                     
             ,:DCLBS01500T.EJD_VEJK                                     
             ,:DCLBS01500T.EJD_HUSNR                                    
             ,:DCLBS01500T.EJD_ETAGE                                    
             ,:DCLBS01500T.EJD_SDØR                                     
             ,:DCLBS01500T.ENHEDBELIG                                   
             ,:DCLBS01500T.ENHED_VEJK                                   
             ,:DCLBS01500T.ENHED_HUSNR                                  
             ,:DCLBS01500T.ENHED_ETAGE                                  
             ,:DCLBS01500T.ENHED_SDØR                                   
             ,:DCLBS01500T.LANDEKODE                                    
             ,:DCLBS01500T.VURMARK_AKT                                  
             ,:DCLBS01500T.VURMARK_OM                                   
             ,:DCLBS01500T.VURMARK                                      
             ,:DCLBS01500T.BFENR                                        
             ,:DCLBS01500T.VUREJENDOMID;                                
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0) DO;                                                 
              ANTLÆS_PERSON = ANTLÆS_PERSON + 1;                        
                                                                        
              IF DCLBS01700T.EKOMNR ^= 999                              
              THEN                                                      
                 ANTLÆS_PERSON_ØVR = ANTLÆS_PERSON_ØVR + 1;             
              IF DCLBS01700T.EKOMNR = 999                               
              THEN                                                      
                 ANTLÆS_PERSON_UDL = ANTLÆS_PERSON_UDL + 1;             
                                                                        
              //Defekt 2416 - start                                     
              IF DCLBS01700T.EKOMNR     = 999                           
               & DCLBS01500T.LANDEKODE  = 'FR'                          
              THEN DO;                                                  
                 IF DCLBS01700T.CEKSEMP = '1'                           
                 THEN                                                   
                    DCLBS01500T.LANDEKODE = 'F1';                       
                 IF DCLBS01700T.CEKSEMP = '2'                           
                 THEN                                                   
                    DCLBS01500T.LANDEKODE = 'F2';                       
                 END;                                                   
              //Defekt 2416 - slut                                      
                                                                        
              IF DCLBS01700T.EKOMNR     = 999                           
               & DCLBS01500T.LANDEKODE ^= ' '                           
               & DCLBS01500T.LANDEKODE ^= 'F1'  //Defekt 2416           
               & DCLBS01500T.LANDEKODE ^= 'F2'  //Defekt 2416           
              THEN                                                      
                 CALL CHECK_CEKSEMP;                                    
              END;                                                      
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE DO;                                                
              FEJLTEKST = 'FETCH BS017_EJERFH_CUR';                     
              CALL SQL_FEJL;                                            
              END;                                                      
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_BS01700T_EJERFORHOLD;                                        
 /*********************************************************************/
 CHECK_CEKSEMP: PROC;                                                   
                                                                        
         EXEC SQL                                                       
              SELECT LEMPELSESKODE                                      
              INTO   :BN03300T.LEMPELSESKODE                            
              FROM   BN03300T                                           
              WHERE  YEAR(STARTDATO) <= :BE55600M.SLUTÅR   /*#01*/      
               AND   YEAR(SLUTDATO)  >= :BE55600M.SLUTÅR   /*#01*/      
               AND   LANDEKODE        = :DCLBS01500T.LANDEKODE;         
                                                                        
          IF SQLCA.SQLCODE = 0                                          
          THEN                                                          
             DO;                                                        
               IF DCLBS01700T.CEKSEMP ^= BN03300T.LEMPELSESKODE         
               THEN                                                     
                  DCLBS01700T.CEKSEMP = BN03300T.LEMPELSESKODE;         
             END;                                                       
                                                                        
 END CHECK_CEKSEMP;                                                     
 /*********************************************************************/
 /*      HENT BS001800T - Basisrabat                                  */
 /*********************************************************************/
 SELECT_BS01800T_BASISRABAT: PROC;                                      
                                                                        
         DCLBS01800T                  = '';                             
         BS01800T_FUNDET              = '0'B;                           
         BS018_R24_EJERANDEL_SW       = -1;                             
                                                                        
         EXEC SQL SELECT  BS018.DFRAGLD                                 
                         ,BS018.DTILGLD                                 
                         ,BS018.R24_SIMPELBASISRABAT                    
                         ,BS018.R24_SIMPELBASISRABAT_NEG                
                         ,BS018.R24_BASISRABAT_REGUL                    
                         ,BS018.COPR_R24_BASISRABAT_REGUL               
                         ,BS018.R24_BASISRABAT                          
                         ,BS018.R24_EJERANDEL                           
                    INTO :DCLBS01800T.DFRAGLD                           
                        ,:DCLBS01800T.DTILGLD                           
                        ,:DCLBS01800T.R24_SIMPELBASISRABAT              
                        ,:DCLBS01800T.R24_SIMPELBASISRABAT_NEG          
                        ,:DCLBS01800T.R24_BASISRABAT_REGUL              
                        ,:DCLBS01800T.COPR_R24_BASISRABAT_REGUL         
                        ,:DCLBS01800T.R24_BASISRABAT                    
                        ,:DCLBS01800T.R24_EJERANDEL                     
                                         :BS018_R24_EJERANDEL_SW        
                    FROM BS01800T BS018                                 
                   WHERE BS018.PERSONNUMMER = :AKTUEL_PERSONNUMMER      
                     AND BS018.EKOMNR       = :AKTUEL_EKOMNR            
                     AND BS018.EEJDNR       = :AKTUEL_EEJDNR            
                     AND BS018.EENHEDLBNR   = :AKTUEL_EENHEDLBNR        
                     AND BS018.DTILGLD      = :DF_TILDATO;              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0)   BS01800T_FUNDET = '1'B;                           
           WHEN (100) BS01800T_FUNDET = '0'B;                           
           OTHERWISE DO;                                                
              FEJLTEKST = 'SELECT_BS01800T_BASISRABAT';                 
              CALL SQL_FEJL;                                            
              END;                                                      
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END SELECT_BS01800T_BASISRABAT;                                        
 /*********************************************************************/
 /*      HENT BS001900T - Rabatejerandel                              */
 /*********************************************************************/
 SELECT_BS01900T_RABATEJERANDEL: PROC;                                  
                                                                        
         DCLBS01900T             = '';                                  
         BS01900T_FUNDET         = '0'B;                                
         BS019_RABATEJERANDEL_SW = -1;                                  
                                                                        
         EXEC SQL SELECT  BS019.DFRAGLD                                 
                         ,BS019.DTILGLD                                 
                         ,BS019.RABATEJERANDEL                          
                         ,BS019.COPR_RABATEJERANDEL                     
                    INTO :DCLBS01900T.DFRAGLD                           
                        ,:DCLBS01900T.DTILGLD                           
                        ,:DCLBS01900T.RABATEJERANDEL                    
                                            :BS019_RABATEJERANDEL_SW    
                        ,:DCLBS01900T.COPR_RABATEJERANDEL               
                    FROM BS01900T BS019                                 
                   WHERE BS019.DINDKAAR     = :HJ_SLUTÅR_PL1            
                     AND BS019.PERSONNUMMER = :AKTUEL_PERSONNUMMER      
                     AND BS019.EKOMNR       = :AKTUEL_EKOMNR            
                     AND BS019.EEJDNR       = :AKTUEL_EEJDNR            
                     AND BS019.EENHEDLBNR   = :AKTUEL_EENHEDLBNR        
                     AND BS019.DTILGLD      = :DF_TILDATO;              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0)   BS01900T_FUNDET = '1'B;                           
           WHEN (100) BS01900T_FUNDET = '0'B;                           
           OTHERWISE DO;                                                
              FEJLTEKST = 'SELECT_BS01900T_RABATEJERANDEL';             
              CALL SQL_FEJL;                                            
              END;                                                      
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END SELECT_BS01900T_RABATEJERANDEL;                                    
