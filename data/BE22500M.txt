 /**********************************************************************
 * PROJEKT:     EVS SLUT ELLER FORSKUD                                 *
 * PROGRAMTYPE: MAKRO.                                                 *
 * FUNKTION:    SQL UDTRÆK ALLE EJENDOMME FRA EJENDOMSTABEL            *
 *              EVS SLUT 2018                                          *
 * PROGRAMMØR:  BO SCHMIDT                                 NOV 2008    *
 *            : DANNET P.G.A. BE07500M                                 *
 * ÆNDRINGER :  GERD HOLM-PEDERSEN                         OKT 2010    *
 *            : DANNET P.G.A. BE09500M                                 *
 * ÆNDRINGER :  GERD HOLM-PEDERSEN                         OKT 2011    *
 *            : DANNET P.G.A. BE10500M                                 *
 * ÆNDRINGER :  LARS KAAE HARRITSHØJ                       SEP 2012    *
 * ÆNDRINGER :  JØRGEN SAUGMANN, QQS                       OKT 2013    *
 * ÆNDRINGER :  JØRGEN SAUGMANN, QQS                       OKT 2014    *
 * ÆNDRINGER :  ESBEN BRODERSEN  QEB                       FEB 2016    *
 * ÅRSRULLET :  LENE MAJ JENSEN  QLE                       JUN 2016    *
 * ÅRSRULLET :  Esben Brodersen  QEB  RUL + BE16 -> BE17   JUN 2017    *
 * UDVIDDET MED EENHEDLBNR TIL SLUT 2018 OPRETTELSEN       SEP 2018    *
 * ÅRSRULLET :  Esben Brodersen  EBD  RUL + BE17 -> BE18   FEB 2020    *
 * ÅRSRULLET :  Esben Brodersen  EBD  RUL + BE18 -> BE19   NOV 2020    *
 * ÆNDRINGSLOG: ÅRSRULLET BE19 -> BE20       EDL           CKT 2020    *
 *                Mellemperioden                                       *
 **********************************************************************/
 /*********************************************************************/
 /* DECLARE CURSOR TIL LÆS AF EJENDOMSTABEL BE21000T                  */
 /*********************************************************************/
 DECLARE_CURSOR: PROC;                                                  
                                                                        
         EXEC SQL                                                       
         DECLARE EJENDOMS_CUR CURSOR FOR                                
                                                                        
         SELECT T1.DINDKAAR,                                            
                T1.EKOMNR,                                              
                T1.EEJDNR,                                              
                T1.EENHEDLBNR                                           
                                                                        
         FROM   BE20000T T1                                             
                                                                        
         WHERE  T1.DINDKAAR = 2022  /*RUL*/                             
                                                                        
         ORDER BY T1.DINDKAAR, T1.EKOMNR, T1.EEJDNR, T1.EENHEDLBNR      
         FOR READ ONLY;                                                 
                                                                        
         EXEC SQL                                                       
         DECLARE EJD_FEL_CUR CURSOR FOR                                 
                                                                        
         SELECT T1.INDHOLD_C,                                           
                T1.INDHOLD_D,                                           
                T1.FELTKODE                                             
                                                                        
         FROM   BE21000T T1                                             
                                                                        
         WHERE  T1.DINDKAAR = 2022  /*RUL*/                             
          AND   T1.EKOMNR     = :EVS_EJD.EKOMNR                         
          AND   T1.EEJDNR     = :EVS_EJD.EEJDNR                         
          AND   T1.EENHEDLBNR = :EVS_EJD.EENHEDLBNR                     
                                                                        
         FOR READ ONLY;                                                 
                                                                        
 END DECLARE_CURSOR;                                                    
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF TABEL BE20000T                      RUTINE */
 /*********************************************************************/
 OPEN_EJENDOMSOPL: PROC;                                                
                                                                        
         EXEC SQL OPEN EJENDOMS_CUR;                                    
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'OPEN EJENDOMS_CURSOR';                       
 /*RUL*/      FEJLTEKST  = 'BE22500 ** 253 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_EJENDOMSOPL;                                                  
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF EJENDOMSTABEL BE20000T                    */
 /*********************************************************************/
 FETCH_EJENDOMSOPL: PROC;                                               
                                                                        
         EXEC SQL FETCH EJENDOMS_CUR                                    
                                                                        
         INTO :EVS_EJD.DINDKAAR,                                        
              :EVS_EJD.EKOMNR,                                          
              :EVS_EJD.EEJDNR,                                          
              :EVS_EJD.EENHEDLBNR;                                      
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0)                                                     
               ANTLÆS_EJD = ANTLÆS_EJD + 1;                             
           WHEN (100);                                                  
           OTHERWISE                                                    
             DO;                                                        
   /*SLUT15*/  FEJLTEKST  =  'BE22500 ** 262  FETCH EJENDOMS_CURSOR';   
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
         FETCH_SQLKODE = SQLCA.SQLCODE;  /* GEMMES TIL SENERE BRUG */   
                                                                        
 END FETCH_EJENDOMSOPL;                                                 
 /*********************************************************************/
 /* SELECT EJENDOMSOPLYSN.                                            */
 /*********************************************************************/
 EJENDOMSOPL: PROC;                                                     
                                                                        
         EXEC SQL OPEN EJD_FEL_CUR;                                     
         CALL KONTROL('268',' OPEN EJD_FEL_CUR');                       
                                                                        
         EXEC SQL                                                       
                                                                        
           FETCH EJD_FEL_CUR                                            
                                                                        
           INTO :EVS_EJD_FELT.INDHOLD_C,                                
                :EVS_EJD_FELT.INDHOLD_D,                                
                :EVS_EJD_FELT.FELTKODE;                                 
                                                                        
         IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)                 
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'EJD_FEL_CUR';                                
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
         DO WHILE (SQLCA.SQLCODE = 0);                                  
                                                                        
           CALL FLYT_EJD_FEL;                                           
                                                                        
           EXEC SQL                                                     
                                                                        
             FETCH EJD_FEL_CUR                                          
                                                                        
             INTO :EVS_EJD_FELT.INDHOLD_C,                              
                  :EVS_EJD_FELT.INDHOLD_D,                              
                  :EVS_EJD_FELT.FELTKODE;                               
                                                                        
           IF (SQLCA.SQLCODE ^= 0 & SQLCA.SQLCODE ^= 100)               
           THEN                                                         
             DO;                                                        
               FEJLTEKST = 'EJD_FEL_CUR';                               
               CALL SQL_FEJL;                                           
             END;                                                       
         END;                                                           
                                                                        
         EXEC SQL CLOSE EJD_FEL_CUR;                                    
         CALL KONTROL('270',' CLOSE EJD_FEL_CUR');                      
                                                                        
 END EJENDOMSOPL;                                                       
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF TABEL BE20000T                     RUTINE */
 /*********************************************************************/
 CLOSE_EJENDOMSOPL: PROC;                                               
                                                                        
         EXEC SQL CLOSE EJENDOMS_CUR;                                   
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              FEJLTEKST = 'CLOSE EJENDOMS_CURSOR';                      
  /*RUL */    FEJLTEKST  = 'BE22500 ** 256 ' !! FEJLTEKST;              
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END CLOSE_EJENDOMSOPL;                                                 
 /***********************************************************/          
 KONTROL:PROC(TAL,TEKST);                                               
 DCL TAL   CHAR (3);                                                    
 DCL TEKST CHAR (80) VARYING;                                           
         SELECT (SQLCA.SQLCODE);                                        
           WHEN (0);                                                    
           OTHER                                                        
             DO;                                                        
  /*RUL*/      FEJLTEKST  = 'BE22500 ** '!!TAL!! TEKST;                 
               CALL SQL_FEJL;                                           
             END;                                                       
         END; /* SELECT*/                                               
 END KONTROL;                                                           
