  PROCESS OPT(TIME);                                                    
 BH66300: /* OPSÆT 1/7-98-DATO P.G.A. GL. BEREGNINGSBÅND */             
         PROC OPTIONS (MAIN) REORDER;                                   
         DCL COPYRIGHT CHAR (30) STATIC                                 
         INIT ('COPYRIGHT KOMMUNEDATA I/S 2000');                       
 /*********************************************************************/
 /*      FORMÅL       OPSÆT STATUS FOR 1/7-1998 EJERSKAB PR. INDIVID  */
 /*                   A.H.T. BEREGNING AF EJENDOMSVÆRDISKAT. SENERE   */
 /*                   OVERFØRES DENNE STATUS VED TILKØB/FRASALG OG    */
 /*                   'ENKE EFTER'-SITUATIONER SAMT MELLEM NUVÆRENDE  */
 /*                   ELLER FRASKILTE PERSONER. DER DANNES ET DATASÆT */
 /*                   MED SAMTLIGE INDIVIDER MED ET VALIDT PERSONNUM- */
 /*                   MER, DER DANNES DOG 2 INDIVIDER FOR PERSONER    */
 /*                   MED HENVISNINGSNUMMER: 1 MED SORTCPR LIG AKTUEL */
 /*                   PERSONNR. (DCPRCIR) OG 1 MED SORTCPR LIG NUVÆ-  */
 /*                   RENDE ELLER FRASKILTE ÆGTEFÆLLES PERSONNR.      */
 /*                   (DHENVN).                                       */
 /*                                                                   */
 /*      INDDATA      B.H61100D.PSA BEREGNINGSBÅND FRA ORD ESKEMA 1999*/
 /*                                                                   */
 /*      UDDATA       B.H66300D ALLE INDIVIDER MED VALIDT PERSONNUMMER*/
 /*                   B.H66301Y KØRSELSKONTROLLISTE                   */
 /*                                                                   */
 /*      PROGRAMMØR   AAGE RASMUSSEN          PUS T&S     JULI 1999   */
 /*                                                                   */
 /*      RETTET       AAGE RASMUSSEN          PUS T&S     JULI 2000   */
 /*      RETTET       AAGE RASMUSSEN          PUS T&S     NOV  2000   */
 /*********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /*********************************************************************/
 /*      FILE-DECLARE                                                 */
 /*********************************************************************/
 DCL     BH611I          FILE RECORD INPUT;                             
 DCL     BH663O          FILE RECORD OUTPUT;                            
 /*********************************************************************/
 /*      ENTRY-DECLARE                                                */
 /*********************************************************************/
 DCL     ZS61900         ENTRY OPTIONS (INTER ASM);   /* SSI-DATO     */
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*      STRUCTUR-DECLARE  INPUT/OUTPUT                               */
 /*********************************************************************/
 DCL     BH611_AR CHAR (4000) VAR;                                      
 DCL     1 BH611 BASED(ADDR(BH611_AR)),                                 
           2 LÆNGDE BIN FIXED (15),                                     
           %INCLUDE BH61199N;          /* HJÆLPESTRUK ORD ESKEMA 1999 */
 DCL     1 BH663,                                                       
           %INCLUDE BH66600N;                                           
 DCL     1 BH66399,                                                     
           %INCLUDE BH66699N;                                           
 /*********************************************************************/
 /*      DECLARE AF PRINTLINIER                                       */
 /*********************************************************************/
 DCL     1 LIN1,                                                        
          2 CTL          CHAR      (1),                                 
          2 TX1          CHAR      (37)      INIT                       
            ('PROGRAM: BH66300L'),                                      
          2 TX2          CHAR      (69)      INIT                       
            ('SKAF 1/7-98-STATUS M.V. FRA ORDINÆR ESKEMA 1999'),        
          2 TX3          CHAR      (14)      INIT                       
            ('UDSKREVET DEN '),                                         
          2 DATO         CHAR      (10),                                
          2 REST         CHAR      (02)      INIT      (' ');           
 DCL     1 LIN2,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (54)      INIT      ('  '),          
          2 TX1          CHAR      (20)      INIT                       
                         ('KØRSELSKONTROLLISTE'),                       
          2 REST         CHAR      (58)      INIT      (' ');           
 DCL     1 LIN3,                                                        
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (2)       INIT      (' '),           
          2 TEKST        CHAR      (52),                                
          2 ANT          PIC       'ZZZ.ZZZ.ZZZ.ZZZ.ZZZ',               
          2 REST         CHAR      (59)      INIT      (' ');           
 DCL     1 LIN_BLANK,                                                   
          2 CTL          CHAR      (1),                                 
          2 F1           CHAR      (132)     INIT      (' ');           
         %INCLUDE ZZ20301M;                                             
 /*********************************************************************/
 /*      DECLARE AF TÆLLEVÆRKER                                       */
 /*********************************************************************/
 DCL     TV_LÆS          FIXED     (7)       INIT      (0);             
 DCL     TV_KOM          FIXED     (7)       INIT      (0);             
 DCL     TV_ØVR          FIXED     (7)       INIT      (0);             
 DCL     TV_NED50        FIXED     (7)       INIT      (0);             
 DCL     TV_SKRIV        FIXED     (7)       INIT      (0);             
 DCL     TV_DUBLET       FIXED     (7)       INIT      (0);             
 /*********************************************************************/
 /*      DECLARE AF BUILTIN                                           */
 /*********************************************************************/
 DCL     ADDR            BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 /*********************************************************************/
 /*      DECLARE AF DIVERSE FELTER                                    */
 /*********************************************************************/
 DCL     I               BIN FIXED (15);                                
                                                                        
 DCL     UDDATO          CHAR      (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2                              BASED(ADDR(DATO1)),       
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     EOF             PIC       '9'       INIT (0);                  
 /*********************************************************************/
 /*      HOUSE-KEEPING                                                */
 /*********************************************************************/
         ON ERROR CALL PLIDUMP('SNHOB');                                
         CALL ZS61900;                 /*   UDSKRIVNING AF SSI-DATO   */
         LIN_BLANK.CTL = ZZIK1;                                         
         LIN1.CTL = ZZWS2;                                              
         LIN2.CTL = ZZWS3;                                              
         LIN3.CTL = ZZWS2;                                              
         OPEN FILE (BH611I) TITLE ('BH61100I');                         
         OPEN FILE (BH663O) TITLE ('BH66300O');                         
         CALL ZZ20390 ('*OPEN','BH66301Y');                             
         ON ENDFILE (BH611I)                                            
         BEGIN;                                                         
            EOF = 1;                                                    
         END;                                                           
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !!                        
                  '-' !! DATO2.ÅR;                                      
         LIN1.DATO = UDDATO;                                            
 /*********************************************************************/
 /*      PROCES                                                       */
 /*********************************************************************/
                                                                        
         READ FILE (BH611I) INTO (BH611_AR);                            
                                                                        
         DO WHILE (EOF = 0 & BH611.SORT_KOMNR < 999);                   
            TV_LÆS = TV_LÆS + 1;                                        
            IF BH611.CINVPNR = '0'   /* KUN VALIDE CPRNR */             
            THEN                     /* SKAL BEHANDLES   */             
               CALL BEHANDL;                                            
            ELSE                                                        
               TV_ØVR = TV_ØVR + 1;  /* SE-NR./LØBENR.   */             
            READ FILE (BH611I) INTO (BH611_AR);                         
         END;                                                           
                                                                        
 /*********************************************************************/
 /*    AFSLUT PROGRAM                                                 */
 /*********************************************************************/
                                                                        
         CALL DAN_OPT_INDV;                                             
                                                                        
         CALL SKRIV_TOTALER;                                            
                                                                        
         CALL ZZ20300(LIN_BLANK,'99');                                  
                                                                        
         CLOSE FILE (BH611I),                                           
               FILE (BH663O);                                           
                                                                        
 /*********************************************************************/
 /*    OPSÆT STATUS VEDR. 1/7-98 EJERSKAB                             */
 /*********************************************************************/
 BEHANDL:                                                               
 PROC;                                                                  
                                                                        
         BH663.EKOMNR = BH611.EKOMNR;                                   
         BH663.EEJDNR = BH611.EEJDNR;                                   
         BH663.SORTCPR = BH611.DCPRCIR;                                 
         BH663.DCPRCIR = BH611.DCPRCIR;                                 
                                                                        
         BH663.CÆGTEJET = 0;                                            
         BH663.EJER_NU = '';                                            
                                                                        
         BH663.EJER_NU.DANNETÅR = 1999;                                 
         BH663.SORTÅR = 1999;                                           
         /* 'GAMLE' INDIVIDER SKAL BEVARES MAX. 3 ÅR.  */               
         /* D.V.S. DE DROPPES, HVIS DER IKKE FINDES EN */               
         /* MAKKER (ÆGTEFÆLLE,EFTERLEVENDE ELLER PER-  */               
         /* SONEN SELV) I FORBINDELSE MED OVERFØRSLEN  */               
         /* MELLEM ÆGTEFÆLLER M.V.                     */               
                                                                        
         BH663.EJER_NU.CPRNR = BH611.DCPRCIR;                           
         BH663.EJER_NU.DKØRT = UDDATO;                                  
         BH663.EJER_NU.DATO0107 = 0;                                    
         IF BH611.DAFSTÅ > 0                                            
         THEN                                                           
            BH663.EJER_NU.DEJETTIL = BH611.DAFSTÅ;                      
         ELSE                                                           
            BH663.EJER_NU.DEJETTIL = 99991231;                          
         BH663.EJER_NU.CNEDSL1 = 0;                                     
         BH663.EJER_NU.CNEDSL1GL = 0;                                   
         BH663.EJER_NU.CCIVS = BH611.MT.CCIVS;                          
         BH663.EJER_NU.DCIÆN = BH611.MT.HIST_OPL(1999).DCIÆN;           
         BH663.EJER_NU.DOVTG = BH611.DOVTG;                             
         BH663.EJER_NU.DAFSTÅ = BH611.DAFSTÅ;                           
         BH663.EJER_NU.DSLUTS = BH611.DSLUTS;                           
         BH663.EJER_NU.DSKØDE = BH611.DSKØDE;                           
         BH663.EJER_NU.CEJEV = BH611.CEJEV;                             
         BH663.EJER_NU.DVURDÅR = BH611.DVURDÅR;                         
         BH663.EJER_NU.CBENYT = BH611.CBENYT;                           
         BH663.EJER_NU.GL_BEJDV = BH611.GL_BEJDV;                       
         BH663.EJER_NU.BBROPFØRT = BH611.BBROPFØRT;                     
                                                                        
         SELECT;                                                        
           WHEN (BH663.EJER_NU.CBENYT = '09' !                          
                 BH663.EJER_NU.CBENYT = '17' !                          
                 BH663.EJER_NU.CBENYT = '70' !                          
                 BH663.EJER_NU.CBENYT = '71')                           
             DO;                                                        
                BH663.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           WHEN (BH663.EJER_NU.CBENYT = '  ' &                          
                 BH663.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH663.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           WHEN (BH663.EJER_NU.DVURDÅR = '2000' &                       
                 BH663.EJER_NU.GL_BEJDV = 0)                            
             DO;                                                        
                BH663.EJER_NU.CNEDSL1 = 50;                             
             END;                                                       
           OTHERWISE                                                    
             CALL OPSÆT_DATO_0107;                                      
         END;                                                           
                                                                        
         BH663.EJER_NU.CNEDSL1GL = BH663.EJER_NU.CNEDSL1;               
                                                                        
         BH663.DHENVN =                                                 
         BH611.MT.HIST_OPL(1999).DHENVN;                                
                                                                        
         IF (BH663.EJER_NU.DCIÆN >= 19980901 &                          
             BH663.EJER_NU.DCIÆN <= 19991231) &                         
            BH663.EJER_NU.DATO0107 <= BH663.EJER_NU.DCIÆN               
         THEN                                                           
            DO;                                                         
               IF BH611.MT.HIST_OPL(1999).DHENVN = 0 &                  
                  BH611.MT.HIST_OPL(1998).DHENVN > 0                    
               THEN                                                     
                  BH663.DHENVN =                                        
                  BH611.MT.HIST_OPL(1998).DHENVN;                       
               /* EJENDOMMEN VAR OGSÅ EJET AF PERSONEN FØR ELLER PÅ */  
               /* DEN SENESTE CIVILSTANDSÆNDRINGSDATO               */  
               BH663.CÆGTEJET = 1;                                      
            END;                                                        
                                                                        
         BH663.EJER_FØR = '';                                           
                                                                        
         CALL OPSÆT_SORT_KRIT;                                          
                                                                        
 /*********************************************************************/
 /*    OPSÆT DATO_0107 P.G.A. SLUTSEDDEL-/OVERTAGELSES- ELLER         */
 /*    SKØDEDATO SAMT OPSÆT KODE FOR EVT. 2 PROMILLE NEDSLAG I EJEN-  */
 /*    DOMSVÆRDISKATTEN                                               */
 /*********************************************************************/
 OPSÆT_DATO_0107:                                                       
 PROC;                                                                  
                                                                        
         SELECT;                                                        
           WHEN (BH663.EJER_NU.DSLUTS > 19980701)                       
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DSLUTS;         
                 BH663.EJER_NU.CNEDSL1 = 30;                            
              END;                                                      
           WHEN (BH663.EJER_NU.DSLUTS > 0 &                             
                 BH663.EJER_NU.DSLUTS <= 19980701)                      
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DSLUTS;         
                 BH663.EJER_NU.CNEDSL1 = 10;                            
              END;                                                      
           WHEN (BH663.EJER_NU.DOVTG > 19980701)                        
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DOVTG;          
                 BH663.EJER_NU.CNEDSL1 = 31;                            
              END;                                                      
           WHEN (BH663.EJER_NU.DOVTG > 0 &                              
                 BH663.EJER_NU.DOVTG <= 19980701)                       
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DOVTG;          
                 BH663.EJER_NU.CNEDSL1 = 11;                            
              END;                                                      
           WHEN (BH663.EJER_NU.DSKØDE > 19980701)                       
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DSKØDE;         
                 BH663.EJER_NU.CNEDSL1 = 32;                            
              END;                                                      
           WHEN (BH663.EJER_NU.DSKØDE > 0 &                             
                 BH663.EJER_NU.DSKØDE <= 19980701)                      
              DO;                                                       
                 BH663.EJER_NU.DATO0107 = BH663.EJER_NU.DSKØDE;         
                 BH663.EJER_NU.CNEDSL1 = 12;                            
              END;                                                      
           OTHERWISE                                                    
              BH663.EJER_NU.CNEDSL1 = 13;                               
         END;                                                           
                                                                        
 END OPSÆT_DATO_0107;                                                   
 /*********************************************************************/
 /*    OPSÆT TYPE OG DATO TIL SORTERING AF OUTPUT-DATASÆT SÅ EVENTUEL */
 /*    OVERFØRSEL AF 'BEDSTE' DATO0107 M.V. KAN FORETAGES             */
 /*    VED TILKØB/FRASALG/TILBAGEKØB/ENKE EFTER SAMT EVT. MELLEM      */
 /*    ÆGTEFÆLLER.                                                    */
 /*********************************************************************/
 OPSÆT_SORT_KRIT:                                                       
 PROC;                                                                  
                                                                        
         BH663.SORTDATO = BH663.EJER_NU.DATO0107;                       
                                                                        
         SELECT;                                                        
           WHEN (BH663.EJER_NU.DAFSTÅ > 0)                              
              DO;                                                       
                 BH663.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           WHEN (BH663.EJER_NU.CCIVS = 'D')                             
              DO;                                                       
                 BH663.SORTTYPE = 4;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
           OTHERWISE                                                    
              DO;                                                       
                 BH663.SORTTYPE = 6;                                    
                 CALL SKRIV_DATASÆT;                                    
              END;                                                      
         END;                                                           
                                                                        
 END OPSÆT_SORT_KRIT;                                                   
 /*********************************************************************/
 /*    SKRIV DATASÆT                                                  */
 /*********************************************************************/
 SKRIV_DATASÆT:                                                         
 PROC;                                                                  
                                                                        
         /* FØRST SKRIVES AKTUEL PERSON */                              
         WRITE FILE (BH663O) FROM (BH663);                              
         TV_SKRIV = TV_SKRIV + 1;                                       
                                                                        
         /* SÅ SKRIVES EVT. ÆGTEFÆLLE SOM DUBLET */                     
         IF BH663.DHENVN > 0 &                                          
           (BH663.SORTTYPE = 4  !        /* DØDE OG/ELLER SÆLGERE   */  
            BH663.SORTTYPE = 6)          /* IKKE SÆLGERE ELLER DØDE */  
         THEN                                                           
            DO;                                                         
               BH663.SORTTYPE = 3;                       /*DUBLET AF? */
               BH663.SORTCPR = BH663.DHENVN;                            
               WRITE FILE (BH663O) FROM (BH663);                        
               TV_DUBLET = TV_DUBLET + 1;                               
               TV_SKRIV = TV_SKRIV + 1;                                 
            END;                                                        
                                                                        
 END SKRIV_DATASÆT;                                                     
                                                                        
 END BEHANDL;                                                           
 /*********************************************************************/
 /*      DER DANNES ET SLUTINDIVID TIL BRUG FOR MASKINEL AFSTEMNING   */
 /*********************************************************************/
 DAN_OPT_INDV:                                                          
 PROC;                                                                  
                                                                        
         BH66399.EKOMNR   = 999;                                        
         BH66399.EEJDNR   = 9999999;                                    
         BH66399.SORTCPR  = 99999999999;                                
         BH66399.SORTÅR   = 99999;                                      
         BH66399.SORTDATO = 999999999;                                  
         BH66399.SORTTYPE = 999;                                        
         BH66399.DCPRCIR  = 99999999999;                                
         BH66399.DHENVN   = 99999999999;                                
         BH66399.ANT_INDV = TV_SKRIV;                                   
         WRITE FILE (BH663O) FROM (BH66399);                            
                                                                        
 END DAN_OPT_INDV;                                                      
 /*********************************************************************/
 /*          UDSKRIVNING AF TOTALLISTE                                */
 /*********************************************************************/
 SKRIV_TOTALER:                                                         
 PROC;                                                                  
                                                                        
         CALL ZZ20300(LIN_BLANK,'01');                                  
         CALL ZZ20300(LIN1,'01');                                       
         CALL ZZ20300(LIN2,'01');                                       
         LIN3.TEKST ='ANTAL LÆSTE INDIVIDER PÅ BH61100D BEREGNINGSBÅND';
         LIN3.ANT = TV_LÆS;                                             
         CALL ZZ20300(LIN3,'01');                                       
         IF TV_KOM > 0                                                  
         THEN                                                           
            DO;                                                         
               LIN3.TEKST = 'ANTAL OVERLÆSTE KOMMUNEHEADERE';           
               LIN3.ANT = TV_KOM;                                       
               CALL ZZ20300(LIN3,'01');                                 
            END;                                                        
         LIN3.TEKST = 'ANTAL OVERLÆSTE EJ VALIDE CPRNR';                
         LIN3.ANT = TV_ØVR;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.TEKST = 'ANTAL OVERLÆSTE CNEDSL1=50     ';                
         LIN3.ANT = TV_NED50;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = 'ANTAL SKREVNE INDIVIDER                        ';
         LIN3.ANT = TV_SKRIV;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = '      HERAF DUBLETTER                          ';
         LIN3.ANT = TV_DUBLET;                                          
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
 END SKRIV_TOTALER;                                                     
                                                                        
                                                                        
 END BH66300;                                                           
