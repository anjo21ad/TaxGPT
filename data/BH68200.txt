  PROCESS OPT(TIME);                                                    
 BH68200: /** SKAF MANGLENDE HENVISNINGSNUMMER **/                      
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 DCL COPYRIGHT CHAR (30) STATIC INIT ('COPYRIGHT KMD A/S 2018');        
 /**********************************************************************
 * FORMÅL:                                                             *
 * SKAF MANGLENDE HENVISNINGSNUMRE M.V. FRA ÆGTEFÆLLE/PARTNER FOR      *
 * PERSONER I MINI MT-FIL FRA FORSKUD VIA SAMKØRING AF NØGLE INDEHOL-  *
 * DENDE PERSONER MED HENVISNINGSNUMMER I MINI MT-FIL FRA FORSKUD MED  *
 * PERSONER UDEN HENVISNINGSNUMMER.                                    *
 *                                                                     *
 * PROGRAMMERET AF  AAGE RASMUSSEN, PUS SKAT DEC. 1999                 *
 * ÅRSTILRETTET AF  AAGE RASMUSSEN, PUS SKAT JUNI 2000                 *
 * ÅRSTILRETTET AF  OLUF MØRK,      LSU T&S  JUNI 2002                 *
 *                                                                     *
 * OBS.: ÅRSRULNING OMFATTER 'NORMALT' KUN KOMPILERING P.G.A. EVT.     *
 *       STRUKTURÆNDRINGER.                                            *
 * FORSKUD23   Per Brunk  Årsrul                         08.06.2022    *
 **********************************************************************/
         DEFAULT RANGE(*) STATIC UNALIGNED CONN;                        
                                                                        
 /*********************************************************************/
 /*      DECLARE AF FILER                                             */
 /*********************************************************************/
                                                                        
 DCL     BH6801I         FILE RECORD INPUT;  /* NØGLE MED DHENVN      */
 DCL     BH6802I         FILE RECORD INPUT;  /* INDV. TIL EVT. REP.   */
 DCL     BH682O          FILE RECORD OUTPUT; /* INDV. EFTER EVT. REP. */
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
                                                                        
 /*********************************************************************/
 /*      DECLARE AF INPUT                                             */
 /*********************************************************************/
                                                                        
 DCL     1 BH6801,                                                      
           %INCLUDE BH68000N;                                           
                                                                        
 DCL     1 BH6802,                                                      
           %INCLUDE BH68001N;                                           
                                                                        
 /*********************************************************************/
 /*      DECLARE AF DIVERSE                                           */
 /*********************************************************************/
                                                                        
 DCL     TV_LÆS          FIXED     (7) INIT (0);                        
 DCL     TV_SKRIV        FIXED     (7) INIT (0);                        
 DCL     TV_NØGLE        FIXED     (7) INIT (0);                        
 DCL     TV_FUNDET       FIXED     (7) INIT (0);                        
 DCL     TV_FØR          FIXED     (7) INIT (0);                        
 DCL     TV_LIG          FIXED     (7) INIT (0);                        
 DCL     TV_EFTER        FIXED     (7) INIT (0);                        
 DCL     TV_REPD         FIXED     (7) INIT (0);                        
 DCL     TV_REPE         FIXED     (7) INIT (0);                        
 DCL     TV_REPF         FIXED     (7) INIT (0);                        
 DCL     TV_REPG         FIXED     (7) INIT (0);                        
 DCL     TV_REPL         FIXED     (7) INIT (0);                        
 DCL     TV_REPO         FIXED     (7) INIT (0);                        
 DCL     TV_REPP         FIXED     (7) INIT (0);                        
 DCL     TV_REPU         FIXED     (7) INIT (0);                        
 DCL     TV_REPØ         FIXED     (7) INIT (0);                        
 DCL     EOF_BH6801      BIT       (1);                                 
 DCL     EOF_BH6802      BIT       (1);                                 
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2                              BASED(ADDR(DATO1)),       
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     JA              BIT       (1) INIT ('1'B);                     
 DCL     NEJ             BIT       (1) INIT ('0'B);                     
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF PRINTLINIER                                       */
 /*                                                                   */
 /*********************************************************************/
 DCL   1 LIN1,                                                          
        2 CTL      CHAR (1),                                            
        2 TX1      CHAR (47)      INIT ('PROGRAM: BH68200L'),           
        2 TX2      CHAR (59)      INIT                                  
                   ('PÅSÆT EVT. MANGLENDE HENVISNINGSNUMMER    '),      
        2 TX3      CHAR (14)      INIT ('UDSKREVET DEN '),              
        2 DATO     CHAR (10),                                           
        2 REST     CHAR (02)      INIT (' ');                           
 DCL   1 LIN2,                                                          
        2 CTL      CHAR (1),                                            
        2 F1       CHAR (54)      INIT ('  '),                          
        2 TX1      CHAR (20)      INIT ('KØRSELSKONTROLLISTE'),         
        2 REST     CHAR (58)      INIT (' ');                           
 DCL   1 LIN3,                                                          
        2 CTL      CHAR (1),                                            
        2 TEKST    CHAR (54),                                           
        2 ANT      PIC  'Z.ZZZ.ZZZ',                                    
        2 REST     CHAR (69)      INIT (' ');                           
 DCL   1 LIN_BLANK,                                                     
        2 CTL      CHAR (1),                                            
        2 F1       CHAR (132)     INIT (' ');                           
       %INCLUDE ZZ20301M;                                               
 /*********************************************************************/
 /*      HOUSEKEEPING                                                 */
 /*********************************************************************/
                                                                        
         ON ERROR CALL PLIDUMP('SNHOB');                                
         CALL ZS61900;                     /* UDSKRIVNING AF KST-DATO */
                                                                        
         OPEN FILE (BH6801I) TITLE ('BH68011I'),                        
              FILE (BH6802I) TITLE ('BH68020I'),                        
              FILE (BH682O)  TITLE ('BH68200O');                        
                                                                        
         EOF_BH6801 = NEJ;                                              
                                                                        
         ON ENDFILE (BH6801I)                                           
            BEGIN;                                                      
               BH6801.DHENVN = 99999999999;                             
               EOF_BH6801 = JA;                                         
            END;                                                        
                                                                        
         EOF_BH6802 = NEJ;                                              
                                                                        
         ON ENDFILE (BH6802I)                                           
            BEGIN;                                                      
               BH6802.DCPRN = 99999999999;                              
               EOF_BH6802 = JA;                                         
            END;                                                        
                                                                        
         LIN_BLANK.CTL = ZZIK1;                                         
         LIN1.CTL = ZZWS2;                                              
         LIN2.CTL = ZZWS3;                                              
         LIN3.CTL = ZZWS2;                                              
         CALL ZZ20390 ('*OPEN','BH68201Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
         LIN1.DATO = UDDATO;                                            
                                                                        
 /*********************************************************************/
 /*      HOVEDSTYRING                                                 */
 /*********************************************************************/
                                                                        
         CALL LÆS_BH6801;                                               
         CALL LÆS_BH6802;                                               
                                                                        
         DO WHILE ( EOF_BH6801 = NEJ ! EOF_BH6802 = NEJ );              
                                                                        
            DO WHILE ( EOF_BH6801 = NEJ &                               
                       BH6801.DHENVN < BH6802.DCPRN );                  
               CALL LÆS_BH6801;                                         
            END;                                                        
                                                                        
            DO WHILE ( EOF_BH6802 = NEJ &                               
                       BH6801.DHENVN > BH6802.DCPRN );                  
               WRITE FILE (BH682O) FROM (BH6802);                       
               TV_SKRIV = TV_SKRIV + 1;                                 
               CALL LÆS_BH6802;                                         
            END;                                                        
                                                                        
            DO WHILE ( EOF_BH6801 = NEJ & EOF_BH6802 = NEJ &            
                       BH6801.DHENVN = BH6802.DCPRN );                  
               CALL BEHANDL;                                            
               CALL LÆS_BH6801;                                         
               CALL LÆS_BH6802;                                         
            END;                                                        
                                                                        
         END;                                                           
                                                                        
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
                                                                        
         CALL SKRIV_TOTALER;                                            
         CALL ZZ20300(LIN_BLANK,'99');                                  
                                                                        
         CLOSE FILE (BH6801I),                                          
               FILE (BH6802I),                                          
               FILE (BH682O);                                           
                                                                        
 /*********************************************************************/
 /*      LÆS PÅ B.H68011D                                             */
 /*********************************************************************/
 LÆS_BH6801:                                                            
         PROC;                                                          
                                                                        
         READ FILE (BH6801I) INTO (BH6801);                             
         IF EOF_BH6801 = NEJ                                            
         THEN                                                           
            TV_NØGLE = TV_NØGLE + 1;                                    
                                                                        
 END LÆS_BH6801;                                                        
                                                                        
 /*********************************************************************/
 /*      LÆS PÅ B.H68020D                                             */
 /*********************************************************************/
 LÆS_BH6802:                                                            
         PROC;                                                          
                                                                        
         READ FILE (BH6802I) INTO (BH6802);                             
         IF EOF_BH6802 = NEJ                                            
         THEN                                                           
            TV_LÆS = TV_LÆS + 1;                                        
                                                                        
 END LÆS_BH6802;                                                        
                                                                        
 /*********************************************************************/
 /*      PÅFØR EVT. MANGLENDE HENVISNINGSNUMMER                       */
 /*********************************************************************/
 BEHANDL:                                                               
         PROC;                                                          
                                                                        
         TV_FUNDET = TV_FUNDET + 1;                                     
                                                                        
         IF BH6802.DCIÆN = BH6801.DCIÆN                                 
         THEN                                                           
            TV_LIG = TV_LIG + 1;                                        
         ELSE                                                           
            IF BH6802.DCIÆN < BH6801.DCIÆN                              
            THEN                                                        
               TV_FØR = TV_FØR + 1;                                     
            ELSE                                                        
               TV_EFTER = TV_EFTER + 1;                                 
                                                                        
         SELECT ( BH6802.CCIVS );                                       
           WHEN ( 'D' )                                                 
              TV_REPD = TV_REPD + 1;                                    
           WHEN ( 'E' )                                                 
              TV_REPE = TV_REPE + 1;                                    
           WHEN ( 'F' )                                                 
              TV_REPF = TV_REPF + 1;                                    
           WHEN ( 'G' )                                                 
              TV_REPG = TV_REPG + 1;                                    
           WHEN ( 'L' )                                                 
              TV_REPL = TV_REPL + 1;                                    
           WHEN ( 'O' )                                                 
              TV_REPO = TV_REPO + 1;                                    
           WHEN ( 'P' )                                                 
              TV_REPP = TV_REPP + 1;                                    
           WHEN ( 'U' )                                                 
              TV_REPU = TV_REPU + 1;                                    
           OTHERWISE                                                    
              TV_REPØ = TV_REPØ + 1;                                    
         END;                                                           
                                                                        
         BH6802.COVF_DHE = '1';                                         
         BH6802.DHENVN = BH6801.DCPRN;                                  
                                                                        
         IF BH6801.DCIÆN >= BH6802.DCIÆN &                              
           (BH6801.CCIVS = 'G' ! BH6801.CCIVS = 'P')                    
         THEN                                                           
            DO;                                                         
  /* CIVILSTANDSÆNDRINGSDATO OG CIVILSTAND TAGES OGSÅ FRA 'NØGLEN'      
     HVIS HENVISNINGSNUMMER TAGES FRA EN GIFT PERSON HVIS               
     CIVILSTANDSÆNDRINGSDATO ER >=                                   */ 
               BH6802.FØROPL.CCIVS_GL = BH6802.CCIVS;                   
               BH6802.FØROPL.DCIÆN_GL = BH6802.DCIÆN;                   
               BH6802.CCIVS = BH6801.CCIVS;                             
               BH6802.DCIÆN = BH6801.DCIÆN;                             
            END;                                                        
                                                                        
         WRITE FILE (BH682O) FROM (BH6802);                             
         TV_SKRIV = TV_SKRIV + 1;                                       
                                                                        
 END BEHANDL;                                                           
 /*********************************************************************/
 /*          UDSKRIVNING AF TOTALLISTE                                */
 /*********************************************************************/
 SKRIV_TOTALER:                                                         
 PROC;                                                                  
         CALL ZZ20300(LIN_BLANK,'01');                                  
         CALL ZZ20300(LIN1,'01');                                       
         CALL ZZ20300(LIN2,'01');                                       
         LIN3.TEKST = 'ANTAL LÆSTE INDIVIDER PÅ B.H68011D             ';
         LIN3.ANT = TV_NØGLE;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS3;                                              
         LIN3.TEKST = 'ANTAL LÆSTE INDIVIDER PÅ B.H68020D             ';
         LIN3.ANT = TV_LÆS;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = 'ANTAL OVERFØRTE HENVISNINGSNUMRE';               
         LIN3.ANT = TV_FUNDET;                                          
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED SAMME CIVILSTANDSÆNDRINGSDATO '; 
         LIN3.ANT = TV_LIG;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED HØJERE CIVILSTANDSÆNDRINGSDATO ';
         LIN3.ANT = TV_EFTER;                                           
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS2;                                              
         LIN3.TEKST = '      HERAF MED LAVERE CIVILSTANDSÆNDRINGSDATO ';
         LIN3.ANT = TV_FØR;                                             
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG D';               
         LIN3.ANT = TV_REPD;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG E';               
         LIN3.ANT = TV_REPE;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG F';               
         LIN3.ANT = TV_REPF;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG G';               
         LIN3.ANT = TV_REPG;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG L';               
         LIN3.ANT = TV_REPL;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG O';               
         LIN3.ANT = TV_REPO;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG P';               
         LIN3.ANT = TV_REPP;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG U';               
         LIN3.ANT = TV_REPU;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.CTL = ZZWS1;                                              
         LIN3.TEKST = '      HERAF MED CIVILSTAND LIG ØVRIGE';          
         LIN3.ANT = TV_REPØ;                                            
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
 END SKRIV_TOTALER;                                                     
                                                                        
                                                                        
 END  BH68200;                                                          
