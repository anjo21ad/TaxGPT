 PROCESS OPT(TIME);                                                     
 BH84700:/* Opsætning af advis 5193                                   */
         PROCEDURE OPTIONS (MAIN) REORDER;                              
 /*********************************************************************/
         DCL COPYRIGHT   CHAR      (30) STATIC                          
                         INIT ('COPYRIGHT KOMMUNEDATA A/S 2023');       
 /********************************************************************* 
 *                                                                    * 
 * FORMÅL : Hvis et erstatningspersonnummer/ er registreret med afstå-* 
 *          elsesdato i indkomståret, skal der, på de øvrige personer * 
 *          registreret med kildekode på den pågældende ejendom,      * 
 *          opsættes et advis 5193 - Salg af ejendom registreret med  * 
 *          fiktivt CPR                                               * 
 *                                                                    * 
 *          Opsætning af advis 5193 - Salg af ejendom registreret med * 
 *          fiktivt CPR på personer med ejendom i EVS der er opsat med* 
 *          kildekode, og ejendommen samtidig i ESR er registeret med * 
 *          afståelsesdato i indkomståret og ejendommen er helt eller * 
 *          delvist ejet af et erstatningspersonnummer i ESR.         * 
 *                                                                    * 
 *          Dette skal gælde alle kildekoder, på nær: kildekode, minus* 
 *          Blank - og  kildekode 3, 4 og 6                           * 
 ********************************************************************** 
 *                                                                    * 
 * INPUT  : BQ78000T                                                  * 
 *                                                                    * 
 * OUTPUT : BQ78000T                                                  * 
 *                                                                    * 
 ********************************************************************** 
 *                                                                    * 
 * NYT PROGRAM : Per Brunk, PBR                           24-05-2023  * 
 *                                                                    * 
 ********************************************************************** 
 *                                                                    * 
 * RETTELSESLOG:                                                      * 
 * Navn:                Init:                             Dato:       * 
 * xxxxxxxxxxxxxx       xxx                               99.99.9999  * 
 **********************************************************************/
         DEFAULT RANGE (*) STATIC UNALIGNED CONN;                       
 /********************************************************************* 
 *                       DECLARE AF REGISTRE                          * 
 *********************************************************************/ 
                                                                        
 DCL     SYSPRINT EXTERNAL FILE PRINT;                                  
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. FÆLLESMACROER                        * 
 *********************************************************************/ 
 DCL     1 BH55600M,                                                    
           %INCLUDE BH55600M;                                           
                                                                        
 /*********************************************************************/
 /*     DECLARE AF DB2-variabler                                      */
 /*********************************************************************/
  EXEC SQL INCLUDE SQLCA;                                               
  EXEC SQL INCLUDE BQ78000T;  /* EVS_RESULTAT (FORSKUD)        */       
                                                                        
 DCL    SQLKODE         FIXED     (5);                                  
 DCL    SQLCODE_CH      CHAR      (5);                                  
 DCL    SQLCODE_PIC     PIC       'SSSS9' DEF SQLCODE_CH;               
                                                                        
 /***************************************************************       
 /*      DECLARE AF ABEND-RUTINE                                        
 /**************************************************************/       
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH84700'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
 /*********************************************************************/
 /*      DECLARE TIL LISTE PRINT                                      */
 /*********************************************************************/
         % INCLUDE ZZ20301M;                                            
                                                                        
 DCL    1 LINIE,                                                        
          2 CCA          CHAR      (01),                                
          2 INDHOLD      CHAR      (132)     INIT      (' ');           
                                                                        
 DCL    HJ_PIC9          PIC       '(8)Z9';                             
 DCL    UDDATO          CHAR       (10);                                
                                                                        
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2         DEF DATO1,                                     
           2 ÅR          CHAR      (4),                                 
           2 F1          CHAR      (1),                                 
           2 MD          CHAR      (2),                                 
           2 F2          CHAR      (1),                                 
           2 DG          CHAR      (2);                                 
                                                                        
 /********************************************************************* 
 *               DECLARE AF DIV. HJÆLPEFELTER                         * 
 *********************************************************************/ 
 DCL     WS_FORSKUD_SLUT_TXT    CHAR(16) INIT (' ');                    
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
                                                                        
 DCL     WS_ÅR0101                      FIXED     (09);                 
 DCL     WS_ÅR1231                      FIXED     (09);                 
                                                                        
 DCL     WS_PROGRAMNAVN         CHAR(8)  INIT ('BH84700');              
                                                                        
 DCL     ANTAL_LÆST    BIN FIXED (31)    INIT(0);                       
 DCL     ANT_UPD       BIN FIXED (31)    INIT(0);                       
 DCL     ANT_EJ_UPD    BIN FIXED (31)    INIT(0);                       
                                                                        
 DCL     JA                  BIT       (1)     INIT ('1'B);             
 DCL     NEJ                 BIT       (1)     INIT ('0'B);             
 /********************************************************************* 
 *       DECLARE AF ENTRY OG BUILTIN                                  * 
 *********************************************************************/ 
 DCL     PLIDUMP         BUILTIN;                                       
 DCL     SUBSTR          BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /*TIMESTAMP    */ 
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
 DCL     PLIXOPT         CHAR      (40)      VAR STATIC                 
         EXTERNAL INIT ('NOTEST(ALL,,;)');                              
                                                                        
 /*********************************************************************/
 /* Declare af CURSORS                                                */
 /*********************************************************************/
                                                                        
         /* finder alle cprnr med erstatningspnr og afståelsesdato    */
                                                                        
         EXEC SQL DECLARE FIKTIVCURS CURSOR WITH HOLD FOR               
                                                                        
         SELECT   TIL_EVS_AAR,                                          
                  AFVIKLINGS_ID,                                        
                  DATA_ID,                                              
                  DCPRN,                                                
                  EKOMNR,                                               
                  EEJDNR,                                               
                  EENHEDLBNR,                                           
                  EGENNR                                                
                                                                        
          FROM BQ78000T                                                 
          WHERE TIL_EVS_AAR   = :WS_TIL_EVS_AAR                         
          AND   AFVIKLINGS_ID = :WS_FORSKUD_SLUT_TXT                    
          AND   DATA_ID       = :BH55600M.DATA_ID                       
          AND   DCPRN         > 3112999999                              
          AND   DCPRN         < 9112999999                              
          AND   TILEVS_DAFSTAA >= :WS_ÅR0101                            
          AND   TILEVS_DAFSTAA <= :WS_ÅR1231                            
          ORDER BY EKOMNR, EEJDNR, EENHEDLBNR;                          
                                                                        
 /********************************************************************* 
 *       ON CONDITIONS                                                * 
 *********************************************************************/ 
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH84700L');             
            END;                                                        
                                                                        
         CALL ZS61900;                          /* UDSKRIVNING AF SSI */
                                                                        
         CALL ZZ20390 ('*OPEN','BH84701Y');                             
                                                                        
         CALL ZS38100(DATO1);                 /* Skaf timestamp */      
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
                                                                        
 /********************************************************************* 
 *       HOVEDSTYRING                                                 * 
 *********************************************************************/ 
                                                                        
            SELECT (BH55600M.AFVIKLINGS_ID);                            
               WHEN ('OPRET_EVS_FORSK')                                 
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.FORSKÅR;            
                     WS_ÅR0101           = BH55600M.FORSKÅR0101;        
                     WS_ÅR1231           = BH55600M.FORSKÅR1231;        
                  END;                                                  
               WHEN ('OPRET_EVS_SLUT ')                                 
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.SLUTÅR;             
                     WS_ÅR0101           = BH55600M.ÅR0101;             
                     WS_ÅR1231           = BH55600M.ÅR1231;             
                  END;                                                  
               WHEN ('SUPPL_EVS_SLUT')                                  
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH55600M.AFVIKLINGS_ID;      
                     WS_TIL_EVS_AAR      = BH55600M.SLUTÅR;             
                     WS_ÅR0101           = BH55600M.ÅR0101;             
                     WS_ÅR1231           = BH55600M.ÅR1231;             
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = 'Afviklings_id skal være '           !! 
                                'OPRET_EVS_FORSK, OPRET_EVS_SLUT ' !!   
                                'eller SUPPL_EVS_SLUT';                 
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
                                                                        
            PUT SKIP LIST ('Normal kørsel af ' !! WS_PROGRAMNAVN);      
            PUT SKIP LIST ('Afviklings-id:   ' !! WS_FORSKUD_SLUT_TXT); 
            PUT SKIP LIST ('TIL_EVS_AAR:     ' !! WS_TIL_EVS_AAR);      
            PUT SKIP LIST ('Periode start:   ' !! WS_ÅR0101);           
            PUT SKIP LIST ('Periode slut:    ' !! WS_ÅR1231);           
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL ('START');                           
                                                                        
         CALL OPEN_FIKTIVCURS;                                          
         CALL FETCH_FIKTIVCURS;                                         
                                                                        
         DO WHILE (SQLCA.SQLCODE = 0);                                  
            CALL UPDATE_RESULT;                                         
            CALL FETCH_FIKTIVCURS;                                      
            END;                                                        
                                                                        
         CALL CLOSE_FIKTIVCURS;                                         
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /* OPEN CURSOR TIL LÆS AF personer med erstatningspnr         RUTINE */
 /*********************************************************************/
 OPEN_FIKTIVCURS: PROC;                                                 
                                                                        
         EXEC SQL OPEN FIKTIVCURS;                                      
                                                                        
         IF SQLCA.SQLCODE ^= 0                                          
         THEN                                                           
            DO;                                                         
              ABENDTXT = '101 OPEN FIKTIVCURS';                         
              CALL SQL_FEJL;                                            
            END;                                                        
                                                                        
 END OPEN_FIKTIVCURS;                                                   
 /*********************************************************************/
 /* FETCH CURSOR TIL LÆS AF personer med erstatningspnr        RUTINE */
 /*********************************************************************/
 FETCH_FIKTIVCURS: PROC;                                                
                                                                        
         EXEC SQL FETCH FIKTIVCURS                                      
                                                                        
         INTO  :DCLBQ78000T.TIL_EVS_AAR,                                
               :DCLBQ78000T.AFVIKLINGS_ID,                              
               :DCLBQ78000T.DATA_ID,                                    
               :DCLBQ78000T.DCPRN,                                      
               :DCLBQ78000T.EKOMNR,                                     
               :DCLBQ78000T.EEJDNR,                                     
               :DCLBQ78000T.EENHEDLBNR,                                 
               :DCLBQ78000T.EGENNR                                      
         ;                                                              
                                                                        
         SELECT (SQLCA.SQLCODE);                                        
                                                                        
           WHEN (0)                                                     
             DO;                                                        
                ANTAL_LÆST = ANTAL_LÆST + 1;                            
             END;                                                       
                                                                        
           WHEN (100);                                                  
                                                                        
           OTHERWISE                                                    
             DO;                                                        
               ABENDTXT = '101 FETCH FIKTIVCURS';                       
               CALL SQL_FEJL;                                           
             END;                                                       
                                                                        
         END; /* SELECT*/                                               
                                                                        
 END FETCH_FIKTIVCURS;                                                  
 /*********************************************************************/
 /* CLOSE CURSOR TIL LÆS AF personer med erstatningspnr        RUTINE */
 /*********************************************************************/
 CLOSE_FIKTIVCURS: PROC;                                                
                                                                        
         EXEC SQL CLOSE FIKTIVCURS;                                     
                                                                        
 END CLOSE_FIKTIVCURS;                                                  
 /*********************************************************************/
 /* UPDATE Fejlnr på andre ejerforhold  (5193)                 RUTINE */
 /*********************************************************************/
 UPDATE_RESULT: PROC;                                                   
                                                                        
         DCLBQ78000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ78000T.DB2FUNKTION    = 'U';                              
                                                                        
         EXEC SQL                                                       
            UPDATE BQ78000T                                             
            SET                                                         
             PROGRAMNAVN          = :WS_PROGRAMNAVN,                    
             DB2FUNKTION          = 'U',                                
             FEJLNR               = 5193,                               
             TILEVS_CEJBEVS       = '2'                                 
                                                                        
            WHERE TIL_EVS_AAR   = :WS_TIL_EVS_AAR                       
            AND   AFVIKLINGS_ID = :WS_FORSKUD_SLUT_TXT                  
            AND   DATA_ID       = :BH55600M.DATA_ID                     
            AND   DCPRN        <> :DCLBQ78000T.DCPRN                    
            AND   EKOMNR        = :DCLBQ78000T.EKOMNR                   
            AND   EEJDNR        = :DCLBQ78000T.EEJDNR                   
            AND   EENHEDLBNR    = :DCLBQ78000T.EENHEDLBNR               
            AND   EGENNR        = :DCLBQ78000T.EGENNR                   
            AND   TILEVS_CDATAFRA in ('1','2','5');                     
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_UPD = ANT_UPD + 1;                                   
            END;                                                        
            WHEN(100) DO;                                               
               ANT_EJ_UPD = ANT_EJ_UPD + 1;                             
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 UPDATE RESULT';                          
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END UPDATE_RESULT;                                                     
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
 AFSLUT:PROC;                                                           
                                                                        
      /*sideskift*/                                                     
      LINIE.CCA     = ZZIK1;                                            
      LINIE.INDHOLD = '';                                               
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      /*overskrift*/                                                    
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'KØRSELS TOTALER FOR BH84700 AFVIKLET DEN ' !!    
                      UDDATO;                                           
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      /*mellemrum*/                                                     
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = '';                                               
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANTAL_LÆST;                                       
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL LÆSTE RECORDS BQ78000T: ' !!               
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANT_UPD;                                          
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL OPDATERET EJENDOMME BQ78000T: ' !!         
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      HJ_PIC9       = ANT_EJ_UPD;                                       
      LINIE.CCA     = ZZWS1;                                            
      LINIE.INDHOLD = 'ANTAL EJ OPDATERET EJENDOMME BQ78000T: ' !!      
                      HJ_PIC9;                                          
      CALL ZZ20300(LINIE,'01');                                         
                                                                        
      CALL ZZ20300(' ','99'); /*luk print datasæt*/                     
                                                                        
      CALL OPDATER_KØRSELSTABEL ('SLUT');                               
                                                                        
 END AFSLUT;                                                            
 /* %INCLUDE BH54997M; */     /* ER FORGÆNGERE KØRT. STOP HVIS IKKE */  
 %INCLUDE BH54998M;     /* OPDATER KØRSELSTABEL */                      
 END  BH84700;                                                          
