  PROCESS OPT(TIME);                                                    
 BH58000:PROCEDURE OPTIONS (MAIN) REORDER;                              
 DCL COPYRIGHT CHAR (30) STATIC INIT ('COPYRIGHT KMD 2017');            
 /**********************************************************************
 * FORMÅL:                                                             *
 * SKRIV BR*4250D FORSKUDS MANTALS DATA TIL TABEL BQ76000T             *
 **********************************************************************/
 /*********************************************************************/
 /* RETTELSESLOG:                                                     */
 /*                                                                   */
 /* ÆNDRINGSLOG: Lene Maj Jensen       QLE                10.01.2017  */
 /*              Omlægning af MT udtræk til DB2                       */
 /*                                                                   */
 /*********************************************************************/
                                                                        
 DEFAULT RANGE(*) STATIC UNALIGNED CONN;                                
                                                                        
 /*********************************************************************/
 /*      DECLARE AF FILER                                             */
 /*********************************************************************/
                                                                        
 DCL     BRX42I          FILE RECORD INPUT;  /* MT-FIL FRA FORSKUD    */
 DCL     BH580I FILE RECORD INPUT;     /* Parameter Forskud-Slut */     
                                                                        
 EXEC SQL INCLUDE SQLCA;           /* SQL KOMMUNIKATIONSAREAL */        
                                                                        
 /*********************************************************************/
 /*      DECLARE AF INPUT                                             */
 /*********************************************************************/
 DCL     1 BH580_PARM,                                                  
           %INCLUDE BH54900N;                                           
 /*********************************************************************/
 /*      DECLARE AF UDTRÆK FRA FORSKUD INDTÆGTSREGISTER               */
 /*********************************************************************/
 DCL     BRX42_AR        CHAR      (100) VAR;                           
                                                                        
 /*FORSKUDS MANDTALS FIL*/                                              
 DCL     1 BH68001       BASED(ADDR(BRX42_AR)),                         
           3 LÆNGDE      BIN FIXED (15),                                
           %INCLUDE BH68001N;                                           
                                                                        
 /*********************************************************************/
 /*      DECLARE AF DIVERSE                                           */
 /*********************************************************************/
 DCL     WS_FORSKUD_SLUT_TXT            CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_TIL_EVS_AAR                 BIN FIXED (15);                 
 DCL     WS_GLSLUTÅR                    BIN FIXED (15);                 
                                                                        
 DCL     WS_TIL_EVS_AAR_GL              BIN FIXED (15);                 
 DCL     WS_SLUT_AFVIKLINGS_ID          CHAR(16) INIT (' ');            
                                                                        
 DCL     WS_PROGRAMNAVN                 CHAR(8)  INIT ('BH58000');      
                                                                        
 DCL     1 BH65300M,                                                    
           %INCLUDE BH65300M;                                           
                                                                        
 DCL     EOF_BRX42       BIT       (1);                                 
 DCL     EOF_BH580       BIT       (1);                                 
 DCL     JA              BIT       (1) INIT ('1'B);                     
 DCL     NEJ             BIT       (1) INIT ('0'B);                     
 DCL     TV642_LÆS       FIXED     (7) INIT (0);                        
 DCL     TV642_FMED      FIXED     (7) INIT (0);                        
 DCL     TV642_FUDEN     FIXED     (7) INIT (0);                        
                                                                        
 DCL     UDDATO          CHAR      (10);                                
 DCL     DATO1           CHAR      (26);                                
                                                                        
 DCL     1 DATO2                              BASED(ADDR(DATO1)),       
           2 ÅR          CHAR      (04),                                
           2 F1          CHAR      (01),                                
           2 MD          CHAR      (02),                                
           2 F2          CHAR      (01),                                
           2 DG          CHAR      (02);                                
                                                                        
 DCL     STG             BUILTIN;                                       
 DCL     ADDR            BUILTIN;                                       
 DCL     PLIDUMP         BUILTIN;                                       
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF ABEND STRUKTUR m.v.                               */
 /*                                                                   */
 /*********************************************************************/
 DCL     ABENDKODE     FIXED       (2) INIT(5);                         
 DCL     1 ABENDMEDD,                                                   
          2 ABENDMODUL CHAR      (7) INIT ('BH58000'),                  
          2 ABENDFILL1 CHAR      (1) INIT (' '),                        
          2 ABENDMEDNR CHAR      (2) INIT ('**'),                       
          2 ABENDFILL2 CHAR      (1) INIT (' '),                        
          2 ABENDTXT   CHAR      (45);                                  
                                                                        
 DCL     ABENDRTKODE   FIXED     (1) INIT (2);                          
 /*********************************************************************/
 /* DECLARE AF TÆLLERE                                                */
 /*********************************************************************/
                                                                        
 DCL     ANT_SKR  BIN FIXED (31) INIT(0);  /* ANTAL SKREVET PÅ UDTRÆK */
 DCL     ANT_INS  BIN FIXED (31) INIT(0);  /* heraf insert            */
 DCL     ANT_UPD  BIN FIXED (31) INIT(0);  /* heraf updates           */
 DCL     ANT_COMM BIN FIXED (31) INIT(0);  /* commit tæller           */
 /*********************************************************************/
 /*      DECLARE AF ENTRIES                                           */
 /*********************************************************************/
 DCL     ZS61900         ENTRY;                                         
 DCL     ZS38100         ENTRY OPTIONS (INTER ASM);   /* TIMESTAMP    */
 DCL     ZS30101         ENTRY;                                         
 DCL     ZS67000         ENTRY;                                         
 /*********************************************************************/
 /*                                                                   */
 /*      DECLARE AF PRINTLINIER                                       */
 /*                                                                   */
 /*********************************************************************/
 DCL     1 LIN1,                                                        
          2 CTL         CHAR     (1),                                   
          2 TX1         CHAR     (17)    INIT  ('PROGRAM: BH58000L'),   
          2 F1          CHAR     (26)    INIT  ((26)' '),               
          2 TX2         CHAR     (37)    INIT                           
                        ('SKAF EVT. MANGLENDE HENVISNINGSNUMMER'),      
          2 F2          CHAR     (26)    INIT  ((26)' '),               
          2 TX3         CHAR     (14)    INIT  ('UDSKREVET DEN '),      
          2 DATO        CHAR     (10),                                  
          2 REST        CHAR     (02)    INIT  ('  ');                  
 DCL     1 LIN2,                                                        
          2 CTL         CHAR     (1),                                   
          2 F1          CHAR     (54)    INIT  (' '),                   
          2 TX1         CHAR     (20)    INIT  ('KØRSELSKONTROLLISTE'), 
          2 REST        CHAR     (58)    INIT  (' ');                   
 DCL     1 LIN3,                                                        
          2 CTL         CHAR     (1),                                   
          2 TEKST       CHAR     (54),                                  
          2 ANT         PIC      'Z.ZZZ.ZZZ',                           
          2 REST        CHAR     (69)    INIT  (' ');                   
 DCL     1 LIN_BLANK,                                                   
          2 CTL         CHAR     (1),                                   
          2 F1          CHAR     (132)   INIT  (' ');                   
         %INCLUDE ZZ20301M;                                             
                                                                        
 /*********************************************************************/
 /* M A C R O E R der SKAL ligge før koden grundet declare af cursors */
 /*********************************************************************/
 %INCLUDE BH54999M; /* CHECK OM OMKØRSEL, OG UDFØR EVT OPRYDNING */     
                                                                        
 /*********************************************************************/
 /*      HOUSEKEEPING                                                 */
 /*********************************************************************/
         PUT SKIP LIST ('START ' !! WS_PROGRAMNAVN);                    
                                                                        
         ON ERROR CALL PLIDUMP('SNHOB');                                
         CALL ZS61900;                     /* UDSKRIVNING AF KST-DATO */
                                                                        
         OPEN FILE (BRX42I)  TITLE ('BRX4250I');                        
                                                                        
         EOF_BRX42 = NEJ;                                               
                                                                        
         ON ENDFILE (BRX42I)                                            
            BEGIN;                                                      
               EOF_BRX42 = JA;                                          
            END;                                                        
                                                                        
         ON ERROR                                                       
            BEGIN;                                                      
                ON ERROR SYSTEM;                                        
                PUT SKIP LIST ('PROGRAMFEJL');                          
                CALL PLIDUMP  ('SNHOB','PROGRAM BH58000L');             
            END;                                                        
                                                                        
         EOF_BH580 = NEJ;                                               
         OPEN FILE (BH580I) TITLE ('BH58000P');                         
                                                                        
         ON ENDFILE (BH580I)                                            
         BEGIN;                                                         
            EOF_BH580 = JA;                                             
         END;                                                           
                                                                        
         LIN_BLANK.CTL = ZZIK1;                                         
         LIN1.CTL = ZZWS2;                                              
         LIN2.CTL = ZZWS3;                                              
         LIN3.CTL = ZZWS2;                                              
         CALL ZZ20390 ('*OPEN','BH58001Y');                             
                                                                        
         CALL ZS38100(DATO1);                                           
         UDDATO = DATO2.DG !! '/' !! DATO2.MD !! '-' !! DATO2.ÅR;       
         LIN1.DATO = UDDATO;                                            
                                                                        
 /*********************************************************************/
 /*      HOVEDSTYRING                                                 */
 /*********************************************************************/
         READ FILE (BH580I) INTO (BH580_PARM);                          
                                                                        
         IF EOF_BH580 = NEJ                                             
         THEN DO;                                                       
            SELECT (BH580_PARM.FS_MRK);                                 
               WHEN ('F')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH580_PARM.FORSKUD_TXT;      
                     WS_TIL_EVS_AAR = BH65300M.FORSKÅR;                 
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH580_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('S')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH580_PARM.SLUT_TXT;         
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH580_PARM.SLUT_TXT;       
                  END;                                                  
               WHEN ('U')                                               
                  DO;                                                   
                     WS_FORSKUD_SLUT_TXT = BH580_PARM.SUPPL_TXT;        
                     WS_TIL_EVS_AAR = BH65300M.SLUTÅR;                  
                     /* N.B.  til_evs_aar_GL Tages ALTID fra SLUT */    
                     WS_TIL_EVS_AAR_GL = BH65300M.SLUTÅR - 1;           
                     /* afviklings-id til læs gammelt år altid SLUT */  
                     WS_SLUT_AFVIKLINGS_ID = BH580_PARM.SLUT_TXT;       
                  END;                                                  
               OTHERWISE                                                
                  DO;                                                   
                     ABENDTXT = '101 PARAMETERFEJL';                    
                     CALL PROGRAM_FEJL;                                 
                  END;                                                  
            END; /* select */                                           
                                                                        
         END;                                                           
                                                                        
         /********************************************************/     
         /*  CHECK OM FORGÆNGERE ER KØRT                         */     
         /********************************************************/     
         CALL CHECK_SEKVENS (BH580_PARM.FS_MRK); /* BH54997M */         
                                                                        
         /********************************************************/     
         /*  NU STARTER CHECK AF OMKØRSEL                        */     
         /********************************************************/     
         CALL CHECK_OM_OMKØRSEL; /* kode ligger i macro BH54999M */     
         IF DER_SKAL_KØRES_OM                                           
         THEN DO;                                                       
            PUT SKIP LIST ('Omkørsel af ' !! WS_PROGRAMNAVN);           
            CALL RYD_OP_FØR_OMKØRSEL;                                   
         END;                                                           
         ELSE DO;                                                       
            PUT SKIP LIST ('Normal kørsel af ' !! WS_PROGRAMNAVN);      
         END;                                                           
                                                                        
                                                                        
         /********************************************************/     
         /*  NU STARTER NORMALT FLOW                             */     
         /********************************************************/     
         CALL OPDATER_KØRSELSTABEL ('START',BH580_PARM.FS_MRK);         
                                                                        
         CALL LÆS_BRX42;                                                
                                                                        
         DO WHILE (EOF_BRX42 = NEJ);                                    
            CALL BEHANDL_BRX42;                                         
            CALL LÆS_BRX42;                                             
         END;                                                           
                                                                        
         CALL AFSLUT;                                                   
                                                                        
 /*********************************************************************/
 /*      LÆS PÅ FORSKUDS MANDTAL FIL                                  */
 /*********************************************************************/
 LÆS_BRX42:PROC;                                                        
                                                                        
         READ FILE (BRX42I) INTO (BRX42_AR);                            
                                                                        
 END LÆS_BRX42;                                                         
 /*********************************************************************/
 /*      OPSPLIT B.R34250D                                            */
 /*********************************************************************/
 BEHANDL_BRX42:PROC;                                                    
                                                                        
         IF BH68001.DCPRN >= 9999999999 /* SLUT-INDIVID */              
         THEN                                                           
            DO;                                                         
               RETURN;                                                  
            END;                                                        
                                                                        
         TV642_LÆS          = TV642_LÆS + 1;                            
                                                                        
         BH68001.COVF_DHE   = '0';                                      
         BH68001.FØROPL     = '';                                       
                                                                        
         /* skriv række på mandtals-tabellen BQ76000T */                
         CALL INSERT_UPDATE_MANDTAL;                                    
                                                                        
         /* check om der skal committes */                              
         ANT_COMM = ANT_COMM + 1;                                       
                                                                        
         IF ANT_COMM > 10000                                            
         THEN DO;                                                       
            CALL COMMIT_BQ76;                                           
            ANT_COMM = 0;                                               
         END;                                                           
                                                                        
   /*FLYTTES TIL LÆSNING I BH65300L !! med DB2 istedet for fil */       
   /*      IF BH68001.DHENVN = 0 !                                      
            BH68001.CSTATUS = '2'  OMPLACEREDE SKAL IKKE REPARERES      
         THEN                                                           
            DO;                                                         
               WRITE FILE (BH6802O) FROM (BRX42_AR);                    
               TV642_FUDEN = TV642_FUDEN + 1;                           
               RETURN;                                                  
            END; */                                                     
                                                                        
         /* BH680.DHENVN   = BH68001.DHENVN;                            
         BH680.DCIÆN    = BH68001.DCIÆN;                                
         BH680.DCPRN    = BH68001.DCPRN;                                
         BH680.CCIVS    = BH68001.CCIVS; */                             
                                                                        
                                                                        
                                                                        
 END BEHANDL_BRX42;                                                     
 /*********************************************************************/
 /* LÆS MANDTALSOPL, CHECK OM række findes                     RUTINE */
 /*********************************************************************/
 INSERT_UPDATE_MANDTAL: PROC;                                           
         DCLBQ76000T = '';                                              
         DCLBQ76000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ76000T.DCPRN          = BH68001.DCPRN;                    
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.DB2FUNKTION    = 'I';                              
         DCLBQ76000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
                                                                        
         EXEC SQL                                                       
            SELECT                                                      
               TIL_EVS_AAR  ,                                           
               AFVIKLINGS_ID   ,                                        
               DCPRN   ,                                                
               PROGRAMNAVN ,                                            
               DB2FUNKTION ,                                            
               CCIVS   ,                                                
               CPENS   ,                                                
               CRGN    ,                                                
               DSORP   ,                                                
               CPART   ,                                                
               CFRÅR   ,                                                
               CFRÅROPR    ,                                            
               DRGNÅRFRA   ,                                            
               DRGNÅRTIL   ,                                            
               BPENSIND    ,                                            
               BPENSGR ,                                                
               CSTATUS ,                                                
               CDØDÆGTF    ,                                            
               CDUBLET ,                                                
               CÆGTF_OK    ,                                            
               CFØRFORS    ,                                            
               CFØRCOR ,                                                
               CFØRPENS    ,                                            
               COVF_DHE    ,                                            
               FØROPL_DCIÆN_GL ,                                        
               FØROPL_CCIVS_GL ,                                        
               HIST_OPD_SIDSTE_DHENVN  ,                                
               HIST_OPD_SIDSTE_CSBSK   ,                                
               HIST_OPD_SIDSTE_CFØREFT ,                                
               HIST_OPD_SIDSTE_CSKPLOM ,                                
               HIST_OPD_SIDSTE_DCIÆN   ,                                
               HIST_OPD_DETTE_DHENVN   ,                                
               HIST_OPD_DETTE_CSBSK    ,                                
               HIST_OPD_DETTE_CFØREFT  ,                                
               HIST_OPD_DETTE_CSKPLOM  ,                                
               HIST_OPD_DETTE_DCIÆN    ,                                
               HIST_OPD_NAESTE_DHENVN  ,                                
               HIST_OPD_NAESTE_CSBSK   ,                                
               HIST_OPD_NAESTE_CFØREFT ,                                
               HIST_OPD_NAESTE_CSKPLOM ,                                
               HIST_OPD_NAESTE_DCIÆN                                    
                                                                        
            INTO                                                        
               :DCLBQ76000T.TIL_EVS_AAR ,                               
               :DCLBQ76000T.AFVIKLINGS_ID   ,                           
               :DCLBQ76000T.DCPRN   ,                                   
               :DCLBQ76000T.PROGRAMNAVN ,                               
               :DCLBQ76000T.DB2FUNKTION ,                               
               :DCLBQ76000T.CCIVS   ,                                   
               :DCLBQ76000T.CPENS   ,                                   
               :DCLBQ76000T.CRGN    ,                                   
               :DCLBQ76000T.DSORP   ,                                   
               :DCLBQ76000T.CPART   ,                                   
               :DCLBQ76000T.CFRÅR   ,                                   
               :DCLBQ76000T.CFRÅROPR    ,                               
               :DCLBQ76000T.DRGNÅRFRA   ,                               
               :DCLBQ76000T.DRGNÅRTIL   ,                               
               :DCLBQ76000T.BPENSIND    ,                               
               :DCLBQ76000T.BPENSGR ,                                   
               :DCLBQ76000T.CSTATUS ,                                   
               :DCLBQ76000T.CDØDÆGTF    ,                               
               :DCLBQ76000T.CDUBLET ,                                   
               :DCLBQ76000T.CÆGTF_OK    ,                               
               :DCLBQ76000T.CFØRFORS    ,                               
               :DCLBQ76000T.CFØRCOR ,                                   
               :DCLBQ76000T.CFØRPENS    ,                               
               :DCLBQ76000T.COVF_DHE    ,                               
               :DCLBQ76000T.FØROPL_DCIÆN_GL ,                           
               :DCLBQ76000T.FØROPL_CCIVS_GL ,                           
               :DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  ,                   
               :DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK   ,                   
               :DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT ,                   
               :DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM ,                   
               :DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN   ,                   
               :DCLBQ76000T.HIST_OPD_DETTE_DHENVN   ,                   
               :DCLBQ76000T.HIST_OPD_DETTE_CSBSK    ,                   
               :DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  ,                   
               :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  ,                   
               :DCLBQ76000T.HIST_OPD_DETTE_DCIÆN    ,                   
               :DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  ,                   
               :DCLBQ76000T.HIST_OPD_NAESTE_CSBSK   ,                   
               :DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT ,                   
               :DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM ,                   
               :DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN                       
                                                                        
            FROM BQ76000T                                               
            WHERE TIL_EVS_AAR   = :DCLBQ76000T.TIL_EVS_AAR              
            AND   DCPRN         = :DCLBQ76000T.DCPRN                    
            AND   AFVIKLINGS_ID = :DCLBQ76000T.AFVIKLINGS_ID;           
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               CALL UPDATE_EVS_MANDTAL;                                 
            END;                                                        
            WHEN(100) DO;                                               
               CALL INSERT_EVS_MANDTAL;                                 
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 SELECT BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
 END INSERT_UPDATE_MANDTAL;                                             
                                                                        
 /*********************************************************************/
 /* BEHANDL OG SKRIV EVS OPLYSNINGER                           RUTINE */
 /*********************************************************************/
 INSERT_EVS_MANDTAL: PROC;                                              
                                                                        
         DCLBQ76000T = '';                                              
         DCLBQ76000T.TIL_EVS_AAR    = WS_TIL_EVS_AAR;                   
         DCLBQ76000T.DCPRN          = BH68001.DCPRN;                    
         DCLBQ76000T.AFVIKLINGS_ID  = WS_FORSKUD_SLUT_TXT;              
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.DB2FUNKTION    = 'I';                              
         /* her udfyldes alle felter jeg kan skaffe */                  
         DCLBQ76000T.CCIVS = BH68001.CCIVS;                             
         /*DCLBQ76000T.CPENS = BH68001. ikke med    ; */                
         DCLBQ76000T.CRGN  = BH68001.CRGN    ;                          
         DCLBQ76000T.DSORP = BH68001.DSORP   ;                          
         DCLBQ76000T.CPART = BH68001.CPART   ;                          
         /* DCLBQ76000T.CFRÅR = BH68001. ikke med    ;                  
         DCLBQ76000T.CFRÅROPR  = BH68001. ikke med    ;                 
         DCLBQ76000T.DRGNÅRFRA = BH68001. ikke med    ;                 
         DCLBQ76000T.DRGNÅRTIL = BH68001. ikke med    ; */              
         DCLBQ76000T.BPENSIND  = BH68001. BPENSIND    ;                 
         DCLBQ76000T.BPENSGR = BH68001.BPENSGR ;                        
         DCLBQ76000T.CSTATUS = BH68001.CSTATUS ;                        
         /* DCLBQ76000T.CDØDÆGTF  = BH68001. ikke med    ;              
         DCLBQ76000T.CDUBLET = BH68001. ikke med    ;                   
         DCLBQ76000T.CÆGTF_OK  = BH68001. ikke med    ;                 
         DCLBQ76000T.CFØRFORS  = BH68001. ikke med    ;                 
         DCLBQ76000T.CFØRCOR = BH68001. ikke med    ;                   
         DCLBQ76000T.CFØRPENS  = BH68001. ikke med    ; */              
         DCLBQ76000T.COVF_DHE  = BH68001.COVF_DHE    ;                  
         DCLBQ76000T.FØROPL_DCIÆN_GL = BH68001.FØROPL.DCIÆN_GL;         
         DCLBQ76000T.FØROPL_CCIVS_GL = BH68001.FØROPL.CCIVS_GL;         
         /* dhenv m.v. lægges i HIST_OPL_DETTE      */                  
         /* DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  = BH68001.DHENVN;       
         DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN = BH68001.DCIÆN; */          
         DCLBQ76000T.HIST_OPD_DETTE_DHENVN = BH68001.DHENVN;            
         DCLBQ76000T.HIST_OPD_DETTE_CSBSK  = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_DETTE_DCIÆN  = BH68001.DCIÆN;             
         /* DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  = BH68001.DHENVN;       
         DCLBQ76000T.HIST_OPD_NAESTE_CSBSK = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN = BH68001.DCIÆN; */          
                                                                        
                                                                        
         EXEC SQL                                                       
            INSERT INTO BQ76000T                                        
            (  TIL_EVS_AAR  ,                                           
               AFVIKLINGS_ID   ,                                        
               DCPRN   ,                                                
               PROGRAMNAVN ,                                            
               DB2FUNKTION ,                                            
               CCIVS   ,                                                
               CPENS   ,                                                
               CRGN    ,                                                
               DSORP   ,                                                
               CPART   ,                                                
               CFRÅR   ,                                                
               CFRÅROPR    ,                                            
               DRGNÅRFRA   ,                                            
               DRGNÅRTIL   ,                                            
               BPENSIND    ,                                            
               BPENSGR ,                                                
               CSTATUS ,                                                
               CDØDÆGTF    ,                                            
               CDUBLET ,                                                
               CÆGTF_OK    ,                                            
               CFØRFORS    ,                                            
               CFØRCOR ,                                                
               CFØRPENS    ,                                            
               COVF_DHE    ,                                            
               FØROPL_DCIÆN_GL ,                                        
               FØROPL_CCIVS_GL ,                                        
               HIST_OPD_SIDSTE_DHENVN  ,                                
               HIST_OPD_SIDSTE_CSBSK   ,                                
               HIST_OPD_SIDSTE_CFØREFT ,                                
               HIST_OPD_SIDSTE_CSKPLOM ,                                
               HIST_OPD_SIDSTE_DCIÆN   ,                                
               HIST_OPD_DETTE_DHENVN   ,                                
               HIST_OPD_DETTE_CSBSK    ,                                
               HIST_OPD_DETTE_CFØREFT  ,                                
               HIST_OPD_DETTE_CSKPLOM  ,                                
               HIST_OPD_DETTE_DCIÆN    ,                                
               HIST_OPD_NAESTE_DHENVN  ,                                
               HIST_OPD_NAESTE_CSBSK   ,                                
               HIST_OPD_NAESTE_CFØREFT ,                                
               HIST_OPD_NAESTE_CSKPLOM ,                                
               HIST_OPD_NAESTE_DCIÆN                                    
            )                                                           
            values                                                      
            (                                                           
             :DCLBQ76000T.TIL_EVS_AAR ,                                 
             :DCLBQ76000T.AFVIKLINGS_ID   ,                             
             :DCLBQ76000T.DCPRN   ,                                     
             :DCLBQ76000T.PROGRAMNAVN ,                                 
             :DCLBQ76000T.DB2FUNKTION ,                                 
             :DCLBQ76000T.CCIVS   ,                                     
             :DCLBQ76000T.CPENS   ,                                     
             :DCLBQ76000T.CRGN    ,                                     
             :DCLBQ76000T.DSORP   ,                                     
             :DCLBQ76000T.CPART   ,                                     
             :DCLBQ76000T.CFRÅR   ,                                     
             :DCLBQ76000T.CFRÅROPR    ,                                 
             :DCLBQ76000T.DRGNÅRFRA   ,                                 
             :DCLBQ76000T.DRGNÅRTIL   ,                                 
             :DCLBQ76000T.BPENSIND    ,                                 
             :DCLBQ76000T.BPENSGR ,                                     
             :DCLBQ76000T.CSTATUS ,                                     
             :DCLBQ76000T.CDØDÆGTF    ,                                 
             :DCLBQ76000T.CDUBLET ,                                     
             :DCLBQ76000T.CÆGTF_OK    ,                                 
             :DCLBQ76000T.CFØRFORS    ,                                 
             :DCLBQ76000T.CFØRCOR ,                                     
             :DCLBQ76000T.CFØRPENS    ,                                 
             :DCLBQ76000T.COVF_DHE    ,                                 
             :DCLBQ76000T.FØROPL_DCIÆN_GL ,                             
             :DCLBQ76000T.FØROPL_CCIVS_GL ,                             
             :DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  ,                     
             :DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK   ,                     
             :DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT ,                     
             :DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM ,                     
             :DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN   ,                     
             :DCLBQ76000T.HIST_OPD_DETTE_DHENVN   ,                     
             :DCLBQ76000T.HIST_OPD_DETTE_CSBSK    ,                     
             :DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  ,                     
             :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  ,                     
             :DCLBQ76000T.HIST_OPD_DETTE_DCIÆN    ,                     
             :DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  ,                     
             :DCLBQ76000T.HIST_OPD_NAESTE_CSBSK   ,                     
             :DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT ,                     
             :DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM ,                     
             :DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN                         
                                                                        
            );                                                          
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_INS = ANT_INS + 1;                                   
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 INSERT BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END INSERT_EVS_MANDTAL;                                                
 /*********************************************************************/
 /* UPDATE række på MANDTALS-tabel                             RUTINE */
 /*********************************************************************/
 UPDATE_EVS_MANDTAL: PROC;                                              
                                                                        
         DCLBQ76000T.PROGRAMNAVN    = WS_PROGRAMNAVN;                   
         DCLBQ76000T.DB2FUNKTION    = 'U';                              
         /* her udfyldes alle ændrede felter */                         
         DCLBQ76000T.CCIVS = BH68001.CCIVS;                             
         /*DCLBQ76000T.CPENS = BH68001. ikke med    ; */                
         DCLBQ76000T.CRGN  = BH68001.CRGN    ;                          
         DCLBQ76000T.DSORP = BH68001.DSORP   ;                          
         DCLBQ76000T.CPART = BH68001.CPART   ;                          
         /* DCLBQ76000T.CFRÅR = BH68001. ikke med    ;                  
         DCLBQ76000T.CFRÅROPR  = BH68001. ikke med    ;                 
         DCLBQ76000T.DRGNÅRFRA = BH68001. ikke med    ;                 
         DCLBQ76000T.DRGNÅRTIL = BH68001. ikke med    ; */              
         DCLBQ76000T.BPENSIND  = BH68001. BPENSIND    ;                 
         DCLBQ76000T.BPENSGR = BH68001.BPENSGR ;                        
         DCLBQ76000T.CSTATUS = BH68001.CSTATUS ;                        
         /* DCLBQ76000T.CDØDÆGTF  = BH68001. ikke med    ;              
         DCLBQ76000T.CDUBLET = BH68001. ikke med    ;                   
         DCLBQ76000T.CÆGTF_OK  = BH68001. ikke med    ;                 
         DCLBQ76000T.CFØRFORS  = BH68001. ikke med    ;                 
         DCLBQ76000T.CFØRCOR = BH68001. ikke med    ;                   
         DCLBQ76000T.CFØRPENS  = BH68001. ikke med    ; */              
         DCLBQ76000T.COVF_DHE  = BH68001.COVF_DHE    ;                  
         DCLBQ76000T.FØROPL_DCIÆN_GL = BH68001.FØROPL.DCIÆN_GL;         
         DCLBQ76000T.FØROPL_CCIVS_GL = BH68001.FØROPL.CCIVS_GL;         
         /* HUSK her skal koden fra 653 ind, så jeg kan se hvor data    
            skal lægges hen NB NB NB  sidste, dette, naeste */          
         DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  = BH68001.DHENVN;          
         DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN = BH68001.DCIÆN;             
         DCLBQ76000T.HIST_OPD_DETTE_DHENVN = BH68001.DHENVN;            
         DCLBQ76000T.HIST_OPD_DETTE_CSBSK  = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_DETTE_DCIÆN  = BH68001.DCIÆN;             
         DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  = BH68001.DHENVN;          
         DCLBQ76000T.HIST_OPD_NAESTE_CSBSK = BH68001.CSBSK;             
         DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT = BH68001.CFØREFT;         
         DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM = BH68001.CSKPLOM;         
         DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN = BH68001.DCIÆN;             
                                                                        
                                                                        
                                                                        
                                                                        
         EXEC SQL                                                       
            UPDATE BQ76000T                                             
            SET TIL_EVS_AAR = :DCLBQ76000T.TIL_EVS_AAR ,                
                AFVIKLINGS_ID = :DCLBQ76000T.AFVIKLINGS_ID   ,          
                DCPRN = :DCLBQ76000T.DCPRN   ,                          
                PROGRAMNAVN = :DCLBQ76000T.PROGRAMNAVN ,                
                DB2FUNKTION = :DCLBQ76000T.DB2FUNKTION ,                
                CCIVS = :DCLBQ76000T.CCIVS   ,                          
                CPENS = :DCLBQ76000T.CPENS   ,                          
                CRGN  = :DCLBQ76000T.CRGN    ,                          
                DSORP = :DCLBQ76000T.DSORP   ,                          
                CPART = :DCLBQ76000T.CPART   ,                          
                CFRÅR = :DCLBQ76000T.CFRÅR   ,                          
                CFRÅROPR  = :DCLBQ76000T.CFRÅROPR    ,                  
                DRGNÅRFRA = :DCLBQ76000T.DRGNÅRFRA   ,                  
                DRGNÅRTIL = :DCLBQ76000T.DRGNÅRTIL   ,                  
                BPENSIND  = :DCLBQ76000T.BPENSIND    ,                  
                BPENSGR = :DCLBQ76000T.BPENSGR ,                        
                CSTATUS = :DCLBQ76000T.CSTATUS ,                        
                CDØDÆGTF  = :DCLBQ76000T.CDØDÆGTF    ,                  
                CDUBLET = :DCLBQ76000T.CDUBLET ,                        
                CÆGTF_OK  = :DCLBQ76000T.CÆGTF_OK    ,                  
                CFØRFORS  = :DCLBQ76000T.CFØRFORS    ,                  
                CFØRCOR = :DCLBQ76000T.CFØRCOR ,                        
                CFØRPENS  = :DCLBQ76000T.CFØRPENS    ,                  
                COVF_DHE  = :DCLBQ76000T.COVF_DHE    ,                  
                FØROPL_DCIÆN_GL = :DCLBQ76000T.FØROPL_DCIÆN_GL ,        
                FØROPL_CCIVS_GL = :DCLBQ76000T.FØROPL_CCIVS_GL ,        
                HIST_OPD_SIDSTE_DHENVN =                                
                            :DCLBQ76000T.HIST_OPD_SIDSTE_DHENVN  ,      
                HIST_OPD_SIDSTE_CSBSK =                                 
                            :DCLBQ76000T.HIST_OPD_SIDSTE_CSBSK   ,      
                HIST_OPD_SIDSTE_CFØREFT =                               
                            :DCLBQ76000T.HIST_OPD_SIDSTE_CFØREFT ,      
                HIST_OPD_SIDSTE_CSKPLOM =                               
                            :DCLBQ76000T.HIST_OPD_SIDSTE_CSKPLOM ,      
                HIST_OPD_SIDSTE_DCIÆN =                                 
                            :DCLBQ76000T.HIST_OPD_SIDSTE_DCIÆN   ,      
                HIST_OPD_DETTE_DHENVN =                                 
                            :DCLBQ76000T.HIST_OPD_DETTE_DHENVN   ,      
                HIST_OPD_DETTE_CSBSK  =                                 
                            :DCLBQ76000T.HIST_OPD_DETTE_CSBSK    ,      
                HIST_OPD_DETTE_CFØREFT =                                
                            :DCLBQ76000T.HIST_OPD_DETTE_CFØREFT  ,      
                HIST_OPD_DETTE_CSKPLOM =                                
                            :DCLBQ76000T.HIST_OPD_DETTE_CSKPLOM  ,      
                HIST_OPD_DETTE_DCIÆN  =                                 
                            :DCLBQ76000T.HIST_OPD_DETTE_DCIÆN    ,      
                HIST_OPD_NAESTE_DHENVN =                                
                            :DCLBQ76000T.HIST_OPD_NAESTE_DHENVN  ,      
                HIST_OPD_NAESTE_CSBSK =                                 
                            :DCLBQ76000T.HIST_OPD_NAESTE_CSBSK   ,      
                HIST_OPD_NAESTE_CFØREFT =                               
                            :DCLBQ76000T.HIST_OPD_NAESTE_CFØREFT ,      
                HIST_OPD_NAESTE_CSKPLOM =                               
                            :DCLBQ76000T.HIST_OPD_NAESTE_CSKPLOM ,      
                HIST_OPD_NAESTE_DCIÆN =                                 
                            :DCLBQ76000T.HIST_OPD_NAESTE_DCIÆN          
                                                                        
            WHERE TIL_EVS_AAR   = :DCLBQ76000T.TIL_EVS_AAR              
            AND   DCPRN         = :DCLBQ76000T.DCPRN                    
            AND   AFVIKLINGS_ID = :DCLBQ76000T.AFVIKLINGS_ID;           
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               ANT_SKR = ANT_SKR + 1;                                   
               ANT_UPD = ANT_UPD + 1;                                   
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 UPDATE BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
                                                                        
 END UPDATE_EVS_MANDTAL;                                                
                                                                        
 /*********************************************************************/
 /* Commit                                                     RUTINE */
 /*********************************************************************/
 COMMIT_BQ76: PROC;                                                     
                                                                        
         EXEC SQL COMMIT;                                               
                                                                        
         SELECT(SQLCA.SQLCODE);                                         
            WHEN(0) DO;                                                 
               PUT SKIP LIST ('Commit efter ' !!                        
                               TV642_LÆS !! ' læs og ' !!               
                               ANT_COMM !! ' insert/updates');          
            END;                                                        
            OTHERWISE DO;                                               
               ABENDTXT = '101 COMMIT BQ76000T';                        
               CALL SQL_FEJL;                                           
            END;                                                        
         END;                                                           
 END COMMIT_BQ76;                                                       
                                                                        
 /*********************************************************************/
 /* HER UDSKRIVES SQL FEJL                                     RUTINE */
 /*********************************************************************/
 SQL_FEJL: PROC;                                                        
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED SQLCODE: ' !! SQLCA.SQLCODE);  
         PUT SKIP LIST ('*****************************************');   
                                                                        
         CALL ZS67000(SQLCA);                                           
                                                                        
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END SQL_FEJL;                                                          
 /*********************************************************************/
 /* HER UDSKRIVES ØVRIGE FEJL                                  RUTINE */
 /*********************************************************************/
 PROGRAM_FEJL: PROC;                                                    
                                                                        
         PUT SKIP LIST ('*****************************************');   
         PUT SKIP LIST ('DER ABENDES MED PROGRAMFEJL');                 
         PUT SKIP LIST ('ABENDTXT:                ' !! ABENDTXT);       
         PUT SKIP LIST ('*****************************************');   
         CALL ZS30101(ABENDKODE,ABENDMEDD,ABENDRTKODE);                 
                                                                        
 END PROGRAM_FEJL;                                                      
 /*********************************************************************/
 /*          UDSKRIVNING AF TOTALLISTE                                */
 /*********************************************************************/
 SKRIV_TOTALER:                                                         
 PROC;                                                                  
                                                                        
         CALL ZZ20300(LIN1,'01');                                       
         CALL ZZ20300(LIN2,'01');                                       
         LIN3.TEKST = 'ANTAL LÆSTE INDIVIDER PÅ B.RX4250D             ';
         LIN3.ANT = TV642_LÆS;                                          
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.TEKST = 'ANTAL SKREVNE INDIVIDER PÅ BQ76000T ';           
         LIN3.ANT = ANT_SKR;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.TEKST = '     HERAF INSERTS (NYE) ';                      
         LIN3.ANT = ANT_INS;                                            
         CALL ZZ20300(LIN3,'01');                                       
         LIN3.TEKST = '     HERAF UPDATES (Opdateringer) ';             
         LIN3.ANT = ANT_UPD;                                            
         CALL ZZ20300(LIN3,'01');                                       
                                                                        
 END SKRIV_TOTALER;                                                     
 AFSLUT: PROC;                                                          
 /********************************************************************* 
 *       AFSLUT PROGRAM                                               * 
 *********************************************************************/ 
                                                                        
         /* LAV ET SIDSTE COMMIT */                                     
         CALL COMMIT_BQ76;                                              
                                                                        
         CLOSE FILE (BRX42I);                                           
         CLOSE FILE (BH580I);                                           
                                                                        
         CALL SKRIV_TOTALER;                                            
         CALL ZZ20300(LIN_BLANK,'99');                                  
                                                                        
         CALL OPDATER_KØRSELSTABEL ('SLUT',BH580_PARM.FS_MRK);          
 END AFSLUT;                                                            
                                                                        
 %INCLUDE BH54997M;     /* ER FORGÆNGERE KØRT. STOP HVIS IKKE */        
 %INCLUDE BH54998M; /* OPDATER KØRSELSTABEL */                          
 END  BH58000;                                                          
